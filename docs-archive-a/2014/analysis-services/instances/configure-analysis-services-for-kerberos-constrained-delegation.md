---
title: 設定 Kerberos 限制委派的 Analysis Services |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: analysis-services
ms.topic: conceptual
ms.assetid: 6d751477-6bf1-48b4-8833-5a631bbe7650
author: minewiskan
ms.author: owend
ms.openlocfilehash: 03b852acb4868cd384ef34948c6aff70541638a0
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87699025"
---
# <a name="configure-analysis-services-for-kerberos-constrained-delegation"></a><span data-ttu-id="f8f1d-102">設定 Analysis Services 進行 Kerberos 限制委派</span><span class="sxs-lookup"><span data-stu-id="f8f1d-102">Configure Analysis Services for Kerberos constrained delegation</span></span>
  <span data-ttu-id="f8f1d-103">將 Analysis Services 設定為 Kerberos 驗證時，若能獲致下列其中一項或兩項結果，對您來說可能最有用處：讓 Analysis Services 在查詢資料時模擬使用者識別，或是由 Analysis Services 將使用者識別委派給下層服務。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-103">When configuring Analysis Services for Kerberos authentication, you are most likely interested in achieving one or both of the following outcomes: having Analysis Services impersonate a user identity when querying data; or having Analysis Services delegate a user identity to a down-level service.</span></span> <span data-ttu-id="f8f1d-104">每一種情況的組態需求略有不同。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-104">Each scenario calls for slightly different configuration requirements.</span></span> <span data-ttu-id="f8f1d-105">這兩種情況都需要驗證以確保組態設定正確。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-105">Both scenarios require verification to ensure configuration was done properly.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="f8f1d-106">**[!INCLUDE[msCoName](../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** 是一種診斷工具，可幫助排除 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]發生的 Kerberos 相關連接問題。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-106">**[!INCLUDE[msCoName](../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** is a diagnostic tool that helps troubleshoot Kerberos related connectivity issues with [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="f8f1d-107">如需詳細資訊，請參閱 [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-107">For more information, see [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).</span></span>  
  
 <span data-ttu-id="f8f1d-108">本主題包含下列幾節：</span><span class="sxs-lookup"><span data-stu-id="f8f1d-108">This topic contains the following sections:</span></span>  
  
-   [<span data-ttu-id="f8f1d-109">允許 Analysis Services 模擬使用者識別</span><span class="sxs-lookup"><span data-stu-id="f8f1d-109">Allow Analysis Services to impersonate a user identity</span></span>](#bkmk_impersonate)  
  
-   [<span data-ttu-id="f8f1d-110">設定 Analysis Services 進行受信任委派</span><span class="sxs-lookup"><span data-stu-id="f8f1d-110">Configure Analysis Services for trusted delegation</span></span>](#bkmk_delegate)  
  
-   [<span data-ttu-id="f8f1d-111">測試模擬或委派的身分識別</span><span class="sxs-lookup"><span data-stu-id="f8f1d-111">Test for impersonated or delegated identity</span></span>](#bkmk_test)  
  
> [!NOTE]  
>  <span data-ttu-id="f8f1d-112">如果與 Analysis Services 的連接是單一躍點，或者您的方案使用 SharePoint Secure Store Service 或 Reporting Services 提供的預存認證，便不需要委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-112">Delegation is not required if the connection to Analysis Services is a single hop, or your solution uses stored credentials provided by SharePoint Secure Store Service or Reporting Services.</span></span> <span data-ttu-id="f8f1d-113">若所有的連接都是從 Excel 到 Analysis Services 資料庫的直接連接，或是以預存認證為基礎，您就可以使用 Kerberos (或 NTLM)，無須設定限制委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-113">If all connections are direct connections from Excel to an Analysis Services database, or based on stored credentials, you can use Kerberos (or NTLM) without having to configure constrained delegation.</span></span>  
>   
>  <span data-ttu-id="f8f1d-114">如果使用者識別必須流經多部電腦連線 (稱為「雙躍點」 ) ，就需要 Kerberos 限制委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-114">Kerberos constrained delegation is required if the user identity has to flow over multiple computer connections (known as "double-hop").</span></span> <span data-ttu-id="f8f1d-115">若情況是 Analysis Services 資料存取權視使用者識別而定且連接要求來自委派的服務，請使用下一節的檢查清單以確保 Analysis Services 能夠模擬原始呼叫端。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-115">When Analysis Services data access is contingent upon user identity, and the connection request is from a delegating service, use the checklist in the next section to ensure that Analysis Services is able to impersonate the original caller.</span></span> <span data-ttu-id="f8f1d-116">如需有關 Analysis Services 驗證流程的詳細資訊，請參閱 [Microsoft BI 驗證及識別授權](https://go.microsoft.com/fwlink/?LinkID=286576)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-116">For more information about Analysis Services authentication flows, see [Microsoft BI Authentication and Identity Delegation](https://go.microsoft.com/fwlink/?LinkID=286576).</span></span>  
>   
>  <span data-ttu-id="f8f1d-117">為了安全起見，Microsoft 始終建議使用限制委派，而不要使用非限制委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-117">As a security best practice, Microsoft always recommends constrained delegation over unconstrained delegation.</span></span> <span data-ttu-id="f8f1d-118">非限制委派是主要的安全性風險，因其可允許服務識別在「任一」 \*\* 下游電腦、服務或應用程式上模擬其他使用者 (而不只是透過限制委派明確定義的那些服務)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-118">Unconstrained delegation is a major security risk because it allows the service identity to impersonate another user on *any* downstream computer, service, or application (as opposed to just those services explicitly defined via constrained delegation).</span></span>  
  
##  <a name="allow-analysis-services-to-impersonate-a-user-identity"></a><a name="bkmk_impersonate"></a><span data-ttu-id="f8f1d-119">允許 Analysis Services 模擬使用者身分識別</span><span class="sxs-lookup"><span data-stu-id="f8f1d-119">Allow Analysis Services to impersonate a user identity</span></span>  
 <span data-ttu-id="f8f1d-120">若要允許上層服務 (如 Reporting Services、IIS 或 SharePoint) 模擬 Analysis Services 的使用者身分識別，您必須為這些服務設定 Kerberos 限制委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-120">To allow up-level services such as Reporting Services, IIS, or SharePoint to impersonate a user identity on Analysis Services, you must configure Kerberos constrained delegation for those services.</span></span> <span data-ttu-id="f8f1d-121">在此情況下，Analysis Services 會使用委派服務提供的身分識別來模擬目前的使用者，根據該使用者身分識別的角色成員資格傳回結果。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-121">In this scenario, Analysis Services impersonates the current user using the identity provided by the delegating service, returning results based on role membership of that user identity.</span></span>  
  
|<span data-ttu-id="f8f1d-122">Task</span><span class="sxs-lookup"><span data-stu-id="f8f1d-122">Task</span></span>|<span data-ttu-id="f8f1d-123">描述</span><span class="sxs-lookup"><span data-stu-id="f8f1d-123">Description</span></span>|  
|----------|-----------------|  
|<span data-ttu-id="f8f1d-124">步驟 1：確認帳戶適合於委派</span><span class="sxs-lookup"><span data-stu-id="f8f1d-124">Step 1: Verify that accounts are suitable for delegation</span></span>|<span data-ttu-id="f8f1d-125">確認用以執行服務的帳戶在 Active Directory 中具有正確的屬性。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-125">Ensure that the accounts used to run the services have the correct properties in Active Directory.</span></span> <span data-ttu-id="f8f1d-126">服務帳戶在 Active Directory 中不得標示為機密帳戶，或是明確地從委派狀況排除。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-126">Service accounts in Active Directory must not be marked as sensitive accounts, or specifically excluded from delegation scenarios.</span></span> <span data-ttu-id="f8f1d-127">如需詳細資訊，請參閱 [了解使用者帳戶](https://go.microsoft.com/fwlink/?LinkId=235818)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-127">For more information, see [Understanding User Accounts](https://go.microsoft.com/fwlink/?LinkId=235818).</span></span><br /><br /> <span data-ttu-id="f8f1d-128">\*\* \* \* 重要 \* 事項 \* \*\*一般來說，所有帳戶和伺服器都必須屬於相同的 Active Directory 網域或相同樹系中的受信任網域。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-128">**\*\* Important \*\*** Generally, all accounts and servers must belong to the same Active Directory domain or to trusted domains in the same forest.</span></span> <span data-ttu-id="f8f1d-129">不過，由於 Windows Server 2012 支援跨網域界限委派，若網域功能層級是 Windows Server 2012，您就可以設定跨網域界限的 Kerberos 限制委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-129">However, because Windows Server 2012 supports delegation across domain boundaries, you can configure Kerberos constrained delegation across a domain boundary if the domain functional level is Windows Server 2012.</span></span> <span data-ttu-id="f8f1d-130">另一種替代方式則是設定 Analysis Services 進行 HTTP 存取並對用戶端連接使用 IIS 驗證方法。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-130">Another alternative is to configure Analysis Services for HTTP access and use IIS authentication methods on the client connection.</span></span> <span data-ttu-id="f8f1d-131">如需詳細資訊，請參閱 [設定 Internet Information Services &#40;IIS&#41; 8.0 上 Analysis Services 的 HTTP 存取](configure-http-access-to-analysis-services-on-iis-8-0.md)(Microsoft BI 驗證及識別委派)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-131">For more information, see [Configure HTTP Access to Analysis Services on Internet Information Services &#40;IIS&#41; 8.0](configure-http-access-to-analysis-services-on-iis-8-0.md).</span></span>|  
|<span data-ttu-id="f8f1d-132">步驟 2：註冊 SPN</span><span class="sxs-lookup"><span data-stu-id="f8f1d-132">Step 2: Register the SPN</span></span>|<span data-ttu-id="f8f1d-133">設定限制委派之前，您必須為 Analysis Services 執行個體註冊服務主要名稱 (SPN)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-133">Before setting up constrained delegation, you must register a Service Principle Name (SPN) for the Analysis Services instance.</span></span> <span data-ttu-id="f8f1d-134">在您為中介層服務設定 Kerberos 限制委派時，將需要 Analysis Services SPN。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-134">You will need the Analysis Services SPN when configuring Kerberos constrained delegation for middle tier services.</span></span> <span data-ttu-id="f8f1d-135">如需相關指示，請參閱＜ [SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md) ＞。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-135">See [SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md) for instructions.</span></span><br /><br /> <span data-ttu-id="f8f1d-136">服務主要名稱 (SPN) 係指定某項服務在設定為 Kerberos 驗證之網域中的唯一識別。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-136">A Service Principle Name (SPN) specifies the unique identity of a service in a domain configured for Kerberos authentication.</span></span> <span data-ttu-id="f8f1d-137">使用整合式安全性的用戶端連接通常會在 SSPI 驗證期間要求 SPN。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-137">Client connections using integrated security often request an SPN as part of SSPI authentication.</span></span> <span data-ttu-id="f8f1d-138">如果用戶端出示的 SPN 與 Active Directory 中的 SPN 註冊相符，此要求便會轉送至 Active Directory 網域控制站 (DC)，並由 KDC 授與票證。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-138">The request is forwarded to an Active Directory Domain Controller (DC), with the KDC granting a ticket if the SPN presented by the client has a matching SPN registration in Active Directory.</span></span>|  
|<span data-ttu-id="f8f1d-139">步驟 3：設定限制委派</span><span class="sxs-lookup"><span data-stu-id="f8f1d-139">Step 3: Configure constrained delegation</span></span>|<span data-ttu-id="f8f1d-140">驗證要使用的帳戶以及註冊該等帳戶的 SPN 之後，下一個步驟是設定上層服務如 IIS、Reporting Services 或 SharePoint Web 服務進行限制委派，將 Analysis Services SPN 指定為允許委派的特定服務。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-140">After validating the accounts you want to use and registering SPNs for those accounts, your next step is to configure up-level services, such as IIS, Reporting Services, or SharePoint web services for constrained delegation, specifying the Analysis Services SPN as the specific service for which delegation is allowed.</span></span><br /><br /> <span data-ttu-id="f8f1d-141">在 SharePoint 中執行的服務 (例如 Excel Services 或 SharePoint 模式的 Reporting Services) 通常裝載了取用 Analysis Services 多維度或表格式資料的活頁簿和報表。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-141">Services that run in SharePoint, such as Excel Services or Reporting Services in SharePoint mode, often host workbooks and reports that consume Analysis Services multidimensional or tabular data.</span></span> <span data-ttu-id="f8f1d-142">為這些服務設定限制委派既是常見的組態工作，也是支援從 Excel Services 進行資料重新整理的必備要件。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-142">Configuring constrained delegation for these services is a common configuration task, and necessary for supporting data refresh from Excel Services.</span></span> <span data-ttu-id="f8f1d-143">下列連結提供有關 SharePoint 服務以及可能向 Analysis Services 資料提出下游資料連接要求之其他服務的指示：</span><span class="sxs-lookup"><span data-stu-id="f8f1d-143">The following links provide instructions for SharePoint services, as well as other services likely to present a downstream data connection request for Analysis Services data:</span></span><br /><br /> <span data-ttu-id="f8f1d-144">[Excel Services 的身分識別委派 (SharePoint Server 2010)](https://go.microsoft.com/fwlink/?LinkId=299826) 或 [How to configure Excel Services in SharePoint Server 2010 for Kerberos authentication](https://support.microsoft.com/kb/2466519)</span><span class="sxs-lookup"><span data-stu-id="f8f1d-144">[Identity delegation for Excel Services (SharePoint Server 2010)](https://go.microsoft.com/fwlink/?LinkId=299826) or [How to configure Excel Services in SharePoint Server 2010 for Kerberos authentication](https://support.microsoft.com/kb/2466519)</span></span><br /><br /> [<span data-ttu-id="f8f1d-145">PerformancePoint Services 的身分識別委派 (SharePoint Server 2010)</span><span class="sxs-lookup"><span data-stu-id="f8f1d-145">Identity delegation for PerformancePoint Services (SharePoint Server 2010)</span></span>](https://go.microsoft.com/fwlink/?LinkId=299827)<br /><br /> [<span data-ttu-id="f8f1d-146">SQL Server Reporting Services 的身分識別委派 (SharePoint Server 2010)</span><span class="sxs-lookup"><span data-stu-id="f8f1d-146">Identity delegation for SQL Server Reporting Services (SharePoint Server 2010)</span></span>](https://go.microsoft.com/fwlink/?LinkId=299828)<br /><br /> <span data-ttu-id="f8f1d-147">如需 IIS 7.0 方面的資訊，請參閱 [Configure Windows Authentication (IIS 7.0)](https://technet.microsoft.com/library/cc754628\(v=ws.10\).aspx) (設定 Windows 驗證 (IIS 7.0)) 或 [How to configure SQL Server 2008 Analysis Services and SQL Server 2005 Analysis Services to use Kerberos authentication](https://support.microsoft.com/kb/917409)(如何設定 SQL Server 2008 Analysis Services 和 SQL Server 2005 Analysis Services 使用 Kerberos 驗證)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-147">For IIS 7.0 see [Configure Windows Authentication (IIS 7.0)](https://technet.microsoft.com/library/cc754628\(v=ws.10\).aspx) or [How to configure SQL Server 2008 Analysis Services and SQL Server 2005 Analysis Services to use Kerberos authentication](https://support.microsoft.com/kb/917409).</span></span>|  
|<span data-ttu-id="f8f1d-148">步驟 4：測試連接</span><span class="sxs-lookup"><span data-stu-id="f8f1d-148">Step 4: Test connections</span></span>|<span data-ttu-id="f8f1d-149">進行測試時，請以不同的身分識別從遠端電腦連接，並且使用與商務使用者所用相同的應用程式查詢 Analysis Services。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-149">When testing, connect from remote computers, under different identities, and query Analysis Services using the same applications as business users.</span></span> <span data-ttu-id="f8f1d-150">您可以使用 SQL Server Profiler 監視連接。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-150">You can use SQL Server Profiler to monitor the connection.</span></span> <span data-ttu-id="f8f1d-151">您應該會看到提出要求的使用者識別。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-151">You should see the user identity on the request.</span></span> <span data-ttu-id="f8f1d-152">如需詳細資訊，請參閱本節中的 [測試模擬或委派的身分識別](#bkmk_test) 。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-152">For more information, see [Test for impersonated or delegated identity](#bkmk_test) in this section.</span></span>|  
  
##  <a name="configure-analysis-services-for-trusted-delegation"></a><a name="bkmk_delegate"></a><span data-ttu-id="f8f1d-153">設定受信任委派的 Analysis Services</span><span class="sxs-lookup"><span data-stu-id="f8f1d-153">Configure Analysis Services for trusted delegation</span></span>  
 <span data-ttu-id="f8f1d-154">設定 Analysis Services 進行 Kerberos 限制委派讓本服務得以模擬下層服務如關聯式資料庫引擎的用戶端識別，從而能夠有如用戶端直接連接般地查詢資料。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-154">Configuring Analysis Services for Kerberos constrained delegation allows the service to impersonate a client identity on a down-level service, such as the relational database engine, so that data can be queried as if the client was connected directly.</span></span>  
  
 <span data-ttu-id="f8f1d-155">Analysis Services 的委派狀況乃限制為設定 `DirectQuery` 模式的表格式模型。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-155">Delegation scenarios for Analysis Services are limited to tabular models configured for `DirectQuery` mode.</span></span> <span data-ttu-id="f8f1d-156">唯有在此狀況下 Analysis Services 才能將委派的認證傳遞給其他服務。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-156">This is the only scenario in which Analysis Services can pass delegated credentials to another service.</span></span> <span data-ttu-id="f8f1d-157">在其他所有案例 (如上一節提及的 SharePoint 案例) 中，Analysis Services 位於委派鏈結的接收端。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-157">In all other scenarios, such as SharePoint scenarios mentioned in the previous section, Analysis Services is on the receiving end of the delegation chain.</span></span> <span data-ttu-id="f8f1d-158">如需 DirectQuery 的詳細資訊，請參閱 [DirectQuery 模式 &#40;SSAS 表格式&#41;](../tabular-models/directquery-mode-ssas-tabular.md)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-158">For more information about DirectQuery, see [DirectQuery Mode &#40;SSAS Tabular&#41;](../tabular-models/directquery-mode-ssas-tabular.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f8f1d-159">經常造成誤解的是，ROLAP 儲存、處理作業或遠端資料分割的存取會因不明原因而有限制委派的需求。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-159">A common misconception is that ROLAP storage, processing operations, or access to remote partitions somehow introduce requirements for constrained delegation.</span></span> <span data-ttu-id="f8f1d-160">事實並非如此。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-160">This is not the case.</span></span> <span data-ttu-id="f8f1d-161">這些作業全部是由服務帳戶 (亦稱為處理帳戶) 自行直接執行。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-161">All of these operations are executed directly by the service account (also referred to as the processing account), on its own behalf.</span></span> <span data-ttu-id="f8f1d-162">如果 Analysis Services 中的這些作業的權限會直接授與服務帳戶 (例如關聯式資料庫上的 granting db_datareader 權限，讓服務可以處理資料)，這些作業就不需要委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-162">Delegation is not required for these operations in Analysis Services, given that permissions for such operations are granted directly to the service account (for example, granting db_datareader permissions on the relational database so that the service can process data).</span></span> <span data-ttu-id="f8f1d-163">如需伺服器作業和權限的詳細資訊，請參閱[設定服務帳戶 &#40;Analysis Services&#41;](configure-service-accounts-analysis-services.md)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-163">For more information about server operations and permissions, see [Configure Service Accounts &#40;Analysis Services&#41;](configure-service-accounts-analysis-services.md).</span></span>  
  
 <span data-ttu-id="f8f1d-164">本節說明如何設定 Analysis Services 進行受信任委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-164">This section explains how to set up Analysis Services for trusted delegation.</span></span> <span data-ttu-id="f8f1d-165">完成此工作後，Analysis Services 可將委派的認證傳送給 SQL Server，以支援表格式解決方案中使用的 DirectQuery 模式。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-165">After you complete this task, Analysis Services will be able to pass delegated credentials to SQL Server, in support of DirectQuery mode used in Tabular solutions.</span></span>  
  
 <span data-ttu-id="f8f1d-166">在開始之前：</span><span class="sxs-lookup"><span data-stu-id="f8f1d-166">Before you start:</span></span>  
  
-   <span data-ttu-id="f8f1d-167">確認 Analysis Services 已啟動。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-167">Verify that Analysis Services is started.</span></span>  
  
-   <span data-ttu-id="f8f1d-168">確認您為 Analysis Services 註冊的 SPN 有效。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-168">Verify the SPN registered for Analysis Services is valid.</span></span> <span data-ttu-id="f8f1d-169">如需指示，請參閱＜ [SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md)＞。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-169">For instructions, see [SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md)</span></span>  
  
 <span data-ttu-id="f8f1d-170">當上述兩項必要條件都符合時，繼續進行以下步驟。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-170">When both prerequisites are satisfied, continue with the following steps.</span></span> <span data-ttu-id="f8f1d-171">請注意，您必須是網域管理員才能設定限制委派。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-171">Note that you must be a domain administrator to set up constrained delegation.</span></span>  
  
1.  <span data-ttu-id="f8f1d-172">在 [Active Directory 使用者及電腦] 中，找出執行 Analysis Services 所使用的服務帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-172">In Active Directory Users and Computers, find the service account under which Analysis Services runs.</span></span> <span data-ttu-id="f8f1d-173">以滑鼠右鍵按一下該服務帳戶並選擇 **[內容]**。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-173">Right-click the service account and choose **Properties**.</span></span>  
  
     <span data-ttu-id="f8f1d-174">為方便說明，下列螢幕擷取畫面分別使用 OlapSvc 和 SQLSvc 代表 Analysis Services 和 SQL Server。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-174">For illustrative purposes, the following screenshots use OlapSvc and SQLSvc to represent Analysis Services and SQL Server, respectively.</span></span>  
  
     <span data-ttu-id="f8f1d-175">OlapSvc 是設定為對 SQLSvc 進行限制委派的帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-175">OlapSvc is the account that will be configured for constrained delegation to SQLSvc.</span></span> <span data-ttu-id="f8f1d-176">當您完成這項工作後，OlapSvc 即有權透過服務票證將委派的認證傳遞給 SQLSvc，以在要求資料時模擬原始呼叫端。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-176">When you complete this task, OlapSvc will have permission to pass delegated credentials on a service ticket to SQLSvc, impersonating the original caller when requesting data.</span></span>  
  
2.  <span data-ttu-id="f8f1d-177">在 [委派] 索引標籤上，選取 **[信任這個使用者，但只委派指定的服務]**，接著選取 **[只使用 Kerberos]**。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-177">On the Delegation tab, select **Trust this user for delegation to specified services only**, followed by **Use Kerberos only**.</span></span> <span data-ttu-id="f8f1d-178">按一下 **[新增]** 以指定允許由 Analysis Services 委派認證的服務。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-178">Click **Add** to specify which service Analysis Services is permitted to delegate credentials.</span></span>  
  
     <span data-ttu-id="f8f1d-179">只有當服務 (Analysis Services) 已獲指派使用者帳戶 (OlapSvc) 而且該服務已註冊 SPN 時，才會出現 [委派] 索引標籤。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-179">Delegation tab appears only when the user account (OlapSvc) is assigned to a service (Analysis Services), and the service has an SPN registered for it.</span></span> <span data-ttu-id="f8f1d-180">SPN 註冊需要該服務為執行中。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-180">SPN registration requires that the service is running.</span></span>  
  
     <span data-ttu-id="f8f1d-181">![SSAS_Kerberos_1_AccountProperties](../media/ssas-kerberos-1-accountproperties.gif "SSAS_Kerberos_1_AccountProperties")</span><span class="sxs-lookup"><span data-stu-id="f8f1d-181">![SSAS_Kerberos_1_AccountProperties](../media/ssas-kerberos-1-accountproperties.gif "SSAS_Kerberos_1_AccountProperties")</span></span>  
  
3.  <span data-ttu-id="f8f1d-182">在 [新增服務] 頁面上，按一下 **[使用者或電腦]**。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-182">On the Add Services page, click **Users or Computers**.</span></span>  
  
     <span data-ttu-id="f8f1d-183">![SSAS_Kerberos_2_](../media/ssas-kerberos-2.gif "SSAS_Kerberos_2_")</span><span class="sxs-lookup"><span data-stu-id="f8f1d-183">![SSAS_Kerberos_2_](../media/ssas-kerberos-2.gif "SSAS_Kerberos_2_")</span></span>  
  
4.  <span data-ttu-id="f8f1d-184">在 [選取使用者或電腦] 頁面上，輸入用來執行 SQL Server 執行個體以提供資料給 Analysis Services 表格式模型資料庫的帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-184">On the Select Users or Computer page, enter the account used to run the SQL Server instance providing data to Analysis Services tabular model databases.</span></span> <span data-ttu-id="f8f1d-185">按一下 **[確定]** 接受該服務帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-185">Click **OK** to accept the service account.</span></span>  
  
     <span data-ttu-id="f8f1d-186">如果您無法選取所需帳戶，請確認 SQL Server 正在執行且其帳戶已註冊 SPN。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-186">If you cannot select the account you want, verify that SQL Server is running and has an SPN registered for that account.</span></span> <span data-ttu-id="f8f1d-187">如需有關資料庫引擎 SPN 的詳細資訊，請參閱＜ [}註冊 Kerberos 連接的服務主體名稱](../../database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections.md)＞。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-187">For more information about SPNs for the database engine, see [Register a Service Principal Name for Kerberos Connections](../../database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections.md).</span></span>  
  
     <span data-ttu-id="f8f1d-188">![SSAS_Kerberos_3_SelectUsers](../media/ssas-kerberos-3-selectusers.gif "SSAS_Kerberos_3_SelectUsers")</span><span class="sxs-lookup"><span data-stu-id="f8f1d-188">![SSAS_Kerberos_3_SelectUsers](../media/ssas-kerberos-3-selectusers.gif "SSAS_Kerberos_3_SelectUsers")</span></span>  
  
5.  <span data-ttu-id="f8f1d-189">SQL Server 執行個體應該會隨即出現在 [新增服務] 中。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-189">The SQL Server instance should now appear in Add Services.</span></span> <span data-ttu-id="f8f1d-190">同樣使用該帳戶的各項服務也將出現在此清單內。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-190">Any service also using that account will also appear in the list.</span></span> <span data-ttu-id="f8f1d-191">請選擇您要使用的 SQL Server 執行個體。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-191">Choose the SQL Server instance you want to use.</span></span> <span data-ttu-id="f8f1d-192">按一下 **[確定]** 接受此執行個體。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-192">Click **OK** to accept the instance.</span></span>  
  
     <span data-ttu-id="f8f1d-193">![SSAS_Kerberos_4_](../media/ssas-kerberos-4.gif "SSAS_Kerberos_4_")</span><span class="sxs-lookup"><span data-stu-id="f8f1d-193">![SSAS_Kerberos_4_](../media/ssas-kerberos-4.gif "SSAS_Kerberos_4_")</span></span>  
  
6.  <span data-ttu-id="f8f1d-194">Analysis Services 服務帳戶的內容頁面現在看起來應該類似於以下螢幕擷取畫面。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-194">The properties page of the Analysis Services service account should now look similar to the following screenshot.</span></span> <span data-ttu-id="f8f1d-195">按一下 [確定]  以儲存變更。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-195">Click **OK** to save your changes.</span></span>  
  
     <span data-ttu-id="f8f1d-196">![SSAS_Kerberos_5_Finished](../media/ssas-kerberos-5-finished.gif "SSAS_Kerberos_5_Finished")</span><span class="sxs-lookup"><span data-stu-id="f8f1d-196">![SSAS_Kerberos_5_Finished](../media/ssas-kerberos-5-finished.gif "SSAS_Kerberos_5_Finished")</span></span>  
  
7.  <span data-ttu-id="f8f1d-197">以不同的身分識別，從遠端用戶端電腦連接並查詢表格式模型，測試委派是否成功。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-197">Test for successful delegation by connecting from a remote client computer, under a different identity, and query the tabular model.</span></span> <span data-ttu-id="f8f1d-198">您應該會在 SQL Server Profiler 中看到提出要求的使用者識別。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-198">You should see the user identity on the request in SQL Server Profiler.</span></span>  
  
##  <a name="test-for-impersonated-or-delegated-identity"></a><a name="bkmk_test"></a><span data-ttu-id="f8f1d-199">測試模擬或委派的身分識別</span><span class="sxs-lookup"><span data-stu-id="f8f1d-199">Test for impersonated or delegated identity</span></span>  
 <span data-ttu-id="f8f1d-200">使用 SQL Server Profiler 監視查詢資料的使用者其身分識別。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-200">Use SQL Server Profiler to monitor the identity of the user who is querying data.</span></span>  
  
1.  <span data-ttu-id="f8f1d-201">在 Analysis Services 執行個體上啟動 **SQL Server Profiler** ，然後啟動新的追蹤。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-201">Start **SQL Server Profiler** on the Analysis Services instance and then start a new trace.</span></span>  
  
2.  <span data-ttu-id="f8f1d-202">在 [事件選取範圍] 的 [安全性稽核] 區段，確認已核取 [`Audit Login`] 和 [`Audit Logout`]。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-202">In Events Selection, verify that `Audit Login` and `Audit Logout` are checked in the Security Audit section.</span></span>  
  
3.  <span data-ttu-id="f8f1d-203">從遠端用戶端電腦透過應用程式服務 (例如 SharePoint 或 Reporting Services) 連接到 Analysis Services。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-203">Connect to Analysis Services via an application service (such as SharePoint or Reporting Services) from a remote client computer.</span></span> <span data-ttu-id="f8f1d-204">「稽核登入」事件將會顯示連接到 Analysis Services 的使用者之身分識別。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-204">The Audit Login event will show the identity of the user connecting to Analysis Services.</span></span>  
  
 <span data-ttu-id="f8f1d-205">若要進行徹底測試，必須使用能夠擷取網路上的 Kerberos 要求與回應的網路監視工具。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-205">Thorough testing will require the use of network monitoring tools that can capture Kerberos requests and responses on the network.</span></span> <span data-ttu-id="f8f1d-206">這項工作會使用可篩選 Kerberos 的網路監視器公用程式 (netmon.exe)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-206">The Network Monitor utility (netmon.exe), filtered for Kerberos, can be used for this task.</span></span> <span data-ttu-id="f8f1d-207">如需使用 Netmon 3.4 和其他工具測試 Kerberos 驗證的詳細資訊，請參閱 [設定 Kerberos 驗證：核心組態 (SharePoint Server 2010)](https://technet.microsoft.com/library/gg502602\(v=office.14\).aspx)。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-207">For more information about using Netmon 3.4 and other tools for testing Kerberos authentication, see [Configuring Kerberos authentication: Core configuration (SharePoint Server 2010)](https://technet.microsoft.com/library/gg502602\(v=office.14\).aspx).</span></span>  
  
 <span data-ttu-id="f8f1d-208">此外，如需 Active Directory 物件內容對話方塊之 [委派] 索引標籤中每個選項的完整描述，請參閱 [Active Directory 中最易混淆的對話方塊](https://www.itprotoday.com/active-directory/most-confusing-dialog-box-active-directory) 。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-208">Additionally, see [The Most Confusing Dialog Box in Active Directory](https://www.itprotoday.com/active-directory/most-confusing-dialog-box-active-directory) for a thorough description of each option in the Delegation tab of the Active Directory object's property dialog box.</span></span> <span data-ttu-id="f8f1d-209">本文也說明如何使用 LDP 來測試和解譯測試結果。</span><span class="sxs-lookup"><span data-stu-id="f8f1d-209">This article also explains how to use LDP to test and interpret test results.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="f8f1d-210">另請參閱</span><span class="sxs-lookup"><span data-stu-id="f8f1d-210">See Also</span></span>  
 <span data-ttu-id="f8f1d-211">[Microsoft BI 驗證及身分識別委派](https://go.microsoft.com/fwlink/?LinkID=286576) </span><span class="sxs-lookup"><span data-stu-id="f8f1d-211">[Microsoft BI Authentication and Identity Delegation](https://go.microsoft.com/fwlink/?LinkID=286576) </span></span>  
 <span data-ttu-id="f8f1d-212">[使用 Kerberos 進行相互驗證](https://go.microsoft.com/fwlink/?LinkId=299283) </span><span class="sxs-lookup"><span data-stu-id="f8f1d-212">[Mutual Authentication Using Kerberos](https://go.microsoft.com/fwlink/?LinkId=299283) </span></span>  
 <span data-ttu-id="f8f1d-213">[連接到 Analysis Services](connect-to-analysis-services.md) </span><span class="sxs-lookup"><span data-stu-id="f8f1d-213">[Connect to Analysis Services](connect-to-analysis-services.md) </span></span>  
 <span data-ttu-id="f8f1d-214">[Analysis Services 實例的 SPN 註冊](spn-registration-for-an-analysis-services-instance.md) </span><span class="sxs-lookup"><span data-stu-id="f8f1d-214">[SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md) </span></span>  
 [<span data-ttu-id="f8f1d-215">連接字串屬性 &#40;Analysis Services&#41;</span><span class="sxs-lookup"><span data-stu-id="f8f1d-215">Connection String Properties &#40;Analysis Services&#41;</span></span>](connection-string-properties-analysis-services.md)  
  
  
