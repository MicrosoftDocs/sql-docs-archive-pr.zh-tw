---
title: Integration Services 封裝中的 MERGE | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
helpviewer_keywords:
- MERGE statement [SQL Server]
ms.assetid: 7e44a5c2-e6d6-4fe2-a079-4f95ccdb147b
author: chugugrace
ms.author: chugu
ms.openlocfilehash: cc6de738d44b91a9e2a4885978ba4a46dfede8cf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87594617"
---
# <a name="merge-in-integration-services-packages"></a><span data-ttu-id="3794e-102">MERGE in Integration Services Packages</span><span class="sxs-lookup"><span data-stu-id="3794e-102">MERGE in Integration Services Packages</span></span>
  <span data-ttu-id="3794e-103">目前版本 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)]之「執行 SQL」工作中的 SQL 陳述式可能會包含 MERGE 陳述式。</span><span class="sxs-lookup"><span data-stu-id="3794e-103">In the current release of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)], the SQL statement in an Execute SQL task can contain a MERGE statement.</span></span> <span data-ttu-id="3794e-104">這個 MERGE 陳述式可讓您在單一陳述式中完成多項 INSERT、UPDATE 及 DELETE 作業。</span><span class="sxs-lookup"><span data-stu-id="3794e-104">This MERGE statement enables you to accomplish multiple INSERT, UPDATE, and DELETE operations in a single statement.</span></span>  
  
 <span data-ttu-id="3794e-105">若要在封裝中使用 MERGE 陳述式，請遵循下列步驟進行：</span><span class="sxs-lookup"><span data-stu-id="3794e-105">To use the MERGE statement in a package, follow these steps:</span></span>  
  
-   <span data-ttu-id="3794e-106">建立資料流程工作，以便將來源資料載入、轉換並儲存至暫存或臨時資料表。</span><span class="sxs-lookup"><span data-stu-id="3794e-106">Create a Data Flow task that loads, transforms, and saves the source data to a temporary or staging table.</span></span>  
  
-   <span data-ttu-id="3794e-107">建立包含 MERGE 陳述式的執行 SQL 工作。</span><span class="sxs-lookup"><span data-stu-id="3794e-107">Create an Execute SQL task that contains the MERGE statement.</span></span>  
  
-   <span data-ttu-id="3794e-108">將資料流程工作連接至執行 SQL 工作，然後使用臨時資料表中的資料當做 MERGE 陳述式的輸入。</span><span class="sxs-lookup"><span data-stu-id="3794e-108">Connect the Data Flow task to the Execute SQL task, and use the data in the staging table as the input for the MERGE statement.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="3794e-109">一般而言，雖然 MERGE 陳述式在此狀況下需要臨時資料表，但是 MERGE 陳述式的效能通常會超過查閱轉換所執行之逐列查閱的效能。</span><span class="sxs-lookup"><span data-stu-id="3794e-109">Although a MERGE statement typically requires a staging table in this scenario, the performance of the MERGE statement usually exceeds that of the row-by-row lookup performed by the Lookup transformation.</span></span> <span data-ttu-id="3794e-110">此外，當大型查閱資料表要測試可供查閱轉換用於快取其參考資料表的記憶體時，MERGE 也很有用。</span><span class="sxs-lookup"><span data-stu-id="3794e-110">MERGE is also useful when the large size of a lookup table would test the memory that is available to the Lookup transformation for caching its reference table.</span></span>  
  
 <span data-ttu-id="3794e-111">本主題的其餘部分將討論 MERGE 陳述式的其他某些用途。</span><span class="sxs-lookup"><span data-stu-id="3794e-111">The remainder of this topic discusses some additional uses for the MERGE statement.</span></span>  
  
 <span data-ttu-id="3794e-112">如需支援使用 MERGE 陳述式的範例目的地元件，請參閱 CodePlex 社群範例： [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215)。</span><span class="sxs-lookup"><span data-stu-id="3794e-112">For a sample destination component that supports the use of the MERGE statement, see the CodePlex community sample, [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215).</span></span>  
  
## <a name="using-merge"></a><span data-ttu-id="3794e-113">使用 MERGE</span><span class="sxs-lookup"><span data-stu-id="3794e-113">Using MERGE</span></span>  
 <span data-ttu-id="3794e-114">一般而言，當您想要在資料表之間套用包含插入、更新和刪除的變更時，就可以使用 MERGE 陳述式。</span><span class="sxs-lookup"><span data-stu-id="3794e-114">Typically, you use the MERGE statement when you want to apply changes that include inserts, updates, and deletions from one table to another table.</span></span> <span data-ttu-id="3794e-115">在 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]之前，這項程序需要查閱轉換和多項 OLE DB 命令轉換。</span><span class="sxs-lookup"><span data-stu-id="3794e-115">Prior to [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], this process required both a Lookup transformation and multiple OLE DB Command transformations.</span></span> <span data-ttu-id="3794e-116">查閱轉換會執行逐列查閱，以便判斷每個資料列是新的或已變更。</span><span class="sxs-lookup"><span data-stu-id="3794e-116">The Lookup transformation performed a row-by-row lookup to determine whether each row was new or changed.</span></span> <span data-ttu-id="3794e-117">然後，OLE DB 命令轉換會執行必要的 INSERT、UPDATE 及 DELETE 作業。</span><span class="sxs-lookup"><span data-stu-id="3794e-117">The OLE DB Command transformations then performed the necessary INSERT, UPDATE, and DELETE operations.</span></span> <span data-ttu-id="3794e-118">從 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]開始，單一 MERGE 陳述式即可取代查閱轉換及對應的 OLE DB 命令轉換。</span><span class="sxs-lookup"><span data-stu-id="3794e-118">Beginning in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], a single MERGE statement can replace both the Lookup transformation and the corresponding OLE DB Command transformations.</span></span>  
  
### <a name="merge-with-incremental-loads"></a><span data-ttu-id="3794e-119">MERGE 搭配累加式載入</span><span class="sxs-lookup"><span data-stu-id="3794e-119">MERGE with Incremental Loads</span></span>  
 <span data-ttu-id="3794e-120">[!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] 新增的異動資料擷取功能可讓您更輕易地針對資料倉儲可靠地執行累加式載入。</span><span class="sxs-lookup"><span data-stu-id="3794e-120">The change data capture functionality that is new in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] makes it easier to perform incremental loads reliably to a data warehouse.</span></span> <span data-ttu-id="3794e-121">除了使用參數化 OLE DB 命令轉換來執行插入和更新作業以外，您也可以使用 MERGE 陳述式來結合這兩種作業。</span><span class="sxs-lookup"><span data-stu-id="3794e-121">As an alternative to using parameterized OLE DB Command transformations to perform the inserts and the updates, you can use the MERGE statement to combine both operations.</span></span>  
  
 <span data-ttu-id="3794e-122">如需詳細資訊，請參閱 [將變更套用到目的地](../change-data-capture/apply-the-changes-to-the-destination.md)。</span><span class="sxs-lookup"><span data-stu-id="3794e-122">For more information, see [Apply the Changes to the Destination](../change-data-capture/apply-the-changes-to-the-destination.md).</span></span>  
  
#### <a name="merge-in-other-scenarios"></a><span data-ttu-id="3794e-123">在其他狀況中的 MERGE</span><span class="sxs-lookup"><span data-stu-id="3794e-123">MERGE in Other Scenarios</span></span>  
 <span data-ttu-id="3794e-124">在下列狀況中，您可以在 [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] 封裝外部或內部使用 MERGE 陳述式。</span><span class="sxs-lookup"><span data-stu-id="3794e-124">In the following scenarios, you can use the MERGE statement either outside or inside an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package.</span></span> <span data-ttu-id="3794e-125">不過，您通常需要使用 [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] 封裝，從多個異質來源載入這項資料，然後結合並清除資料。</span><span class="sxs-lookup"><span data-stu-id="3794e-125">However, an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package is often required to load this data from multiple heterogeneous sources, and then to combine and cleanse the data.</span></span> <span data-ttu-id="3794e-126">因此，為了方便和簡化維護作業，您可能會考慮在封裝中使用 MERGE 陳述式。</span><span class="sxs-lookup"><span data-stu-id="3794e-126">Therefore, you might consider using the MERGE statement in a package for convenience and ease of maintenance.</span></span>  
  
##### <a name="track-buying-habits"></a><span data-ttu-id="3794e-127">追蹤購買習慣</span><span class="sxs-lookup"><span data-stu-id="3794e-127">Track Buying Habits</span></span>  
 <span data-ttu-id="3794e-128">資料倉儲中的 FactBuyingHabits 資料表會追蹤某位客戶上次購買給定產品的日期。</span><span class="sxs-lookup"><span data-stu-id="3794e-128">The FactBuyingHabits table in the data warehouse tracks the last date on which a customer bought a given product.</span></span> <span data-ttu-id="3794e-129">此資料表包含 ProductID、CustomerID 及 PurchaseDate 資料行。</span><span class="sxs-lookup"><span data-stu-id="3794e-129">The table consists of ProductID, CustomerID and PurchaseDate columns.</span></span> <span data-ttu-id="3794e-130">交易式資料庫每週都會產生一份 PurchaseRecords 資料表，其中包含當週的購買記錄。</span><span class="sxs-lookup"><span data-stu-id="3794e-130">Every week, the transactional database generates a PurchaseRecords table that includes the purchases made during that week.</span></span> <span data-ttu-id="3794e-131">我們的目標是要使用單一 MERGE 陳述式，將 PurchaseRecords 資料表中的資訊合併至 FactBuyingHabits 資料表中。</span><span class="sxs-lookup"><span data-stu-id="3794e-131">The objective is to use a single MERGE statement to merge the information in the PurchaseRecords table into the FactBuyingHabits table.</span></span> <span data-ttu-id="3794e-132">若為不存在的產品-客戶配對，MERGE 陳述式會插入新的資料列。</span><span class="sxs-lookup"><span data-stu-id="3794e-132">For product-customer pairs that do not exist, the MERGE statement inserts new rows.</span></span> <span data-ttu-id="3794e-133">若為存在的產品-客戶配對，MERGE 陳述式就會更新最近的購買日期。</span><span class="sxs-lookup"><span data-stu-id="3794e-133">For product-customer pairs that exist, the MERGE statement updates the most recent date-of-purchase.</span></span>  
  
###### <a name="track-price-history"></a><span data-ttu-id="3794e-134">追蹤價格記錄</span><span class="sxs-lookup"><span data-stu-id="3794e-134">Track Price History</span></span>  
 <span data-ttu-id="3794e-135">DimBook 資料表代表書店存貨的書籍清單並識別每本書的價格記錄。</span><span class="sxs-lookup"><span data-stu-id="3794e-135">The DimBook table represents the list of books in the inventory of a book seller and identifies the price history of each book.</span></span> <span data-ttu-id="3794e-136">此資料表具有下列資料行：ISBN、ProductID、Price、Shelf 和 IsCurrent。</span><span class="sxs-lookup"><span data-stu-id="3794e-136">This table has these columns: ISBN, ProductID, Price, Shelf, and IsCurrent.</span></span> <span data-ttu-id="3794e-137">此資料表也針對書籍的每個價格具有一個資料列。</span><span class="sxs-lookup"><span data-stu-id="3794e-137">This table also has one row for each price the book has had.</span></span> <span data-ttu-id="3794e-138">其中一個資料列包含目前的價格。</span><span class="sxs-lookup"><span data-stu-id="3794e-138">One of these rows contains the current price.</span></span> <span data-ttu-id="3794e-139">為了指出哪一個資料列包含目前的價格，該資料列之 IsCurrent 資料行的值會設定為 1。</span><span class="sxs-lookup"><span data-stu-id="3794e-139">To indicate which row contains the current price, the value of the IsCurrent column for that row is set to 1.</span></span>  
  
 <span data-ttu-id="3794e-140">資料庫每週都會產生一份 WeeklyChanges 資料表，其中包含該週的價格變更以及當週加入的新書。</span><span class="sxs-lookup"><span data-stu-id="3794e-140">Every week, the database generates a WeeklyChanges table that contains price changes for the week and new books that were added during the week.</span></span> <span data-ttu-id="3794e-141">透過使用單一 MERGE 陳述式，您就可以將 WeeklyChanges 資料表中的變更套用至 DimBook 資料表。</span><span class="sxs-lookup"><span data-stu-id="3794e-141">By using a single MERGE statement, you can apply the changes in the WeeklyChanges table to the DimBook table.</span></span> <span data-ttu-id="3794e-142">MERGE 陳述式會針對新加入的書籍插入新的資料列，然後針對價格已經變更之現有書籍的資料列，將 IsCurrent 資料行更新為 0。</span><span class="sxs-lookup"><span data-stu-id="3794e-142">The MERGE statement inserts new rows for newly-added books, and updates the IsCurrent column to 0 for rows of existing books whose prices have changed.</span></span> <span data-ttu-id="3794e-143">此外，MERGE 陳述式也會針對價格已經變更的書籍插入新的資料列，然後針對這些新的資料列，將 IsCurrent 資料行的值設定為 1。</span><span class="sxs-lookup"><span data-stu-id="3794e-143">The MERGE statement also inserts new rows for books whose prices have changed, and for these new rows, sets the value of the IsCurrent column to 1.</span></span>  
  
### <a name="merge-a-table-with-new-data-against-the-old-table"></a><span data-ttu-id="3794e-144">合併內含新資料的資料表與舊資料表</span><span class="sxs-lookup"><span data-stu-id="3794e-144">Merge a Table with New Data Against the Old Table</span></span>  
 <span data-ttu-id="3794e-145">資料庫會使用「開放式結構描述」來設定物件屬性的模型；亦即，資料表包含每個屬性的成對名稱及數值。</span><span class="sxs-lookup"><span data-stu-id="3794e-145">The database models the properties of an object by using an "open schema," that is, a table contains name-value pairs for each property.</span></span> <span data-ttu-id="3794e-146">Properties 資料表包含三個資料行：EntityID、PropertyID 和 Value。</span><span class="sxs-lookup"><span data-stu-id="3794e-146">The Properties table has three columns: EntityID, PropertyID, and Value.</span></span> <span data-ttu-id="3794e-147">NewProperties 資料表 (更新的資料表版本) 必須與 Properties 資料表同步處理。</span><span class="sxs-lookup"><span data-stu-id="3794e-147">A NewProperties table that is a newer version of the table has to be synchronized with the Properties table.</span></span> <span data-ttu-id="3794e-148">若要同步處理這兩份資料表，您可以使用單一 MERGE 陳述式來執行下列作業：</span><span class="sxs-lookup"><span data-stu-id="3794e-148">To synchronize these two tables, you can use a single MERGE statement to perform the following operations:</span></span>  
  
-   <span data-ttu-id="3794e-149">從 Properties 資料表中刪除屬性 (如果它們不存在 NewProperties 資料表中的話)。</span><span class="sxs-lookup"><span data-stu-id="3794e-149">Delete properties from the Properties table if they are absent from the NewProperties table.</span></span>  
  
-   <span data-ttu-id="3794e-150">使用在 NewProperties 資料表中找到的新值來更新 Properties 資料表中的屬性值。</span><span class="sxs-lookup"><span data-stu-id="3794e-150">Update values for properties that are in the Properties table with new values found in the NewProperties table.</span></span>  
  
-   <span data-ttu-id="3794e-151">針對位於 NewProperties 資料表但在 Properties 資料表中找不到的屬性，插入新的屬性。</span><span class="sxs-lookup"><span data-stu-id="3794e-151">Insert new properties for properties that are in the NewProperties table but are not found in the Properties table.</span></span>  
  
 <span data-ttu-id="3794e-152">這種方法在複寫狀況類似的狀況中很有用，因為其目標都是要在兩部同步處理的伺服器上保留兩份資料表中的資料。</span><span class="sxs-lookup"><span data-stu-id="3794e-152">This approach is useful in scenarios that resemble replication scenarios, where the objective is to keep data in two tables on two servers synchronized.</span></span>  
  
### <a name="track-inventory"></a><span data-ttu-id="3794e-153">追蹤存貨</span><span class="sxs-lookup"><span data-stu-id="3794e-153">Track Inventory</span></span>  
 <span data-ttu-id="3794e-154">Inventory 資料庫具有一份 ProductsInventory 資料表，其中包含 ProductID 和 StockOnHand 資料行。</span><span class="sxs-lookup"><span data-stu-id="3794e-154">The Inventory database has a ProductsInventory table that has ProductID and StockOnHand columns.</span></span> <span data-ttu-id="3794e-155">含有 ProductID、CustomerID 和 Quantity 資料行的 Shipments 資料表會追蹤客戶的產品出貨。</span><span class="sxs-lookup"><span data-stu-id="3794e-155">A Shipments table with ProductID, CustomerID, and Quantity columns tracks shipments of products to customers.</span></span> <span data-ttu-id="3794e-156">ProductInventory 資料表必須根據 Shipments 資料表中的資訊每日更新。</span><span class="sxs-lookup"><span data-stu-id="3794e-156">The ProductInventory table has to be updated daily based on information in the Shipments table.</span></span> <span data-ttu-id="3794e-157">單一 MERGE 陳述式可以根據出貨減少 ProductInventory 資料表中的存貨。</span><span class="sxs-lookup"><span data-stu-id="3794e-157">A single MERGE statement can reduce the inventory in the ProductInventory table based on the shipments made.</span></span> <span data-ttu-id="3794e-158">如果某項產品的存貨已經減少至 0，該 MERGE 陳述式也可以從 ProductInventory 資料表中刪除該項產品的資料列。</span><span class="sxs-lookup"><span data-stu-id="3794e-158">If the inventory for a product has been reduced to 0, that MERGE statement can also delete that product row from the ProductInventory table.</span></span>  
  
  
