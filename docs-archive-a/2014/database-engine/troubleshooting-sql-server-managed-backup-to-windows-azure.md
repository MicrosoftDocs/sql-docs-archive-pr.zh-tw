---
title: 針對 SQL Server 受控備份至 Azure 進行疑難排解 |Microsoft Docs
description: 本文說明您可以用來疑難排解 SQL Server Managed 備份至 Microsoft Azure 作業期間可能發生之錯誤的工作和工具。
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: a34d35b0-48eb-4ed1-9f19-ea14754650da
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: 9c7ed5dd25ed2b02445bfae5eb78ac03b2270552
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87701530"
---
# <a name="troubleshooting-sql-server-managed--backup-to-azure"></a><span data-ttu-id="e01e6-103">SQL Server Managed Backup 到 Azure 的疑難排解</span><span class="sxs-lookup"><span data-stu-id="e01e6-103">Troubleshooting SQL Server Managed  Backup to Azure</span></span>
  <span data-ttu-id="e01e6-104">本主題說明[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]作業期間，針對其中可能發生的錯誤所使用的工作和工具進行疑難排解。</span><span class="sxs-lookup"><span data-stu-id="e01e6-104">This topic describes the tasks and tools you can use to troubleshoot errors that may occur during [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] operations.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="e01e6-105">概觀</span><span class="sxs-lookup"><span data-stu-id="e01e6-105">Overview</span></span>  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="e01e6-106">內建有檢查和疑難排解程序，所以在許多情況中，內部失敗會由[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]程序自行處理。</span><span class="sxs-lookup"><span data-stu-id="e01e6-106">has built in checks and troubleshooting, so in many cases internal failures are taken care of by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] process itself.</span></span>  
  
 <span data-ttu-id="e01e6-107">其中一種情況的範例是刪除備份檔案，而導致記錄檔鏈中斷影響復原能力- [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 會識別記錄鏈中的中斷，並排程立即取得備份。</span><span class="sxs-lookup"><span data-stu-id="e01e6-107">Example of one such case is a deletion of a backup file resulting in a break of the log chain affecting recoverability - [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will identify the break in log chain and schedule a backup to be taken immediately.</span></span> <span data-ttu-id="e01e6-108">不過，建議您監視狀態及處理需要手動介入的所有錯誤。</span><span class="sxs-lookup"><span data-stu-id="e01e6-108">However we recommend that you monitor the status and address any errors that require manual intervention.</span></span>  
  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="e01e6-109">使用系統預存程序、系統檢視和擴充事件記錄事件和錯誤。</span><span class="sxs-lookup"><span data-stu-id="e01e6-109">logs events and errors using system stored procedures, system views and extended events.</span></span> <span data-ttu-id="e01e6-110">系統檢視和預存程序皆提供[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]組態資訊、備份排程備份的狀態，以及擴充事件所擷取到的錯誤。</span><span class="sxs-lookup"><span data-stu-id="e01e6-110">System views and stored procedures provide [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration information, status of backup scheduled backups, and also the errors captured by Extended Events.</span></span> [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="e01e6-111">會使用擴充事件擷取錯誤，供疑難排解之用。</span><span class="sxs-lookup"><span data-stu-id="e01e6-111">uses Extended Events to capture the errors to use for troubleshooting.</span></span> <span data-ttu-id="e01e6-112">刪除記錄事件之外，SQL Server Smart Admin 原則會提供電子郵件通知工作所使用的健康情況，以提供通知或錯誤與問題。</span><span class="sxs-lookup"><span data-stu-id="e01e6-112">In addition to logging events, SQL Server Smart Admin Policies provide a health status which is used by an email notification job to provide notification or errors and issues.</span></span> <span data-ttu-id="e01e6-113">如需詳細資訊，請參閱[監視 SQL Server 受控備份至 Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md)。</span><span class="sxs-lookup"><span data-stu-id="e01e6-113">For more information see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="e01e6-114">也會使用手動備份至 Azure 儲存體時所使用的相同記錄 (SQL Server 備份至 URL) 。</span><span class="sxs-lookup"><span data-stu-id="e01e6-114">also uses the same logging that is used when manually backing up to Azure storage (SQL Server Backup to URL).</span></span> <span data-ttu-id="e01e6-115">如需備份至 URL 相關問題的詳細資訊，請參閱[SQL Server 備份至 url 的最佳作法和疑難排解](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md)中的疑難排解一節。</span><span class="sxs-lookup"><span data-stu-id="e01e6-115">For more information on Backup to URL related issues, see the troubleshooting section in [SQL Server Backup to URL Best Practices and Troubleshooting](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md)</span></span>  
  
### <a name="general-troubleshooting-steps"></a><span data-ttu-id="e01e6-116">一般疑難排解步驟</span><span class="sxs-lookup"><span data-stu-id="e01e6-116">General Troubleshooting Steps</span></span>  
  
1.  <span data-ttu-id="e01e6-117">啟用電子郵件通知，開始接收錯誤和警告的電子郵件。</span><span class="sxs-lookup"><span data-stu-id="e01e6-117">Enable Email Notification to start to receive emails for error and warnings.</span></span>  
  
     <span data-ttu-id="e01e6-118">此外，您也可以定期執行 `smart_admin.fn_get_health_status`，藉以檢查彙總錯誤和計數。</span><span class="sxs-lookup"><span data-stu-id="e01e6-118">Alternatively, you can also periodically run `smart_admin.fn_get_health_status` to check the aggregated errors and counts.</span></span> <span data-ttu-id="e01e6-119">例如，`number_of_invalid_credential_errors` 是智慧型備份嘗試備份，但卻得到無效認證錯誤的次數。</span><span class="sxs-lookup"><span data-stu-id="e01e6-119">For example, `number_of_invalid_credential_errors` is the number of times smart backup attempted a backup but got invalid credential error.</span></span> <span data-ttu-id="e01e6-120">`Number_of_backup_loops` 和 `number_of_retention_loops` 不是錯誤；他們會指出備份執行緒與保留執行緒掃描資料庫清單的次數。</span><span class="sxs-lookup"><span data-stu-id="e01e6-120">`Number_of_backup_loops` and `number_of_retention_loops` are not errors; but they indicate the number of times backup thread and retention thread scanned the list of databases.</span></span> <span data-ttu-id="e01e6-121">一般而言，當 @begin_time 未提供和時，函式 @end_time 會顯示過去30分鐘內的資訊，因此，通常應該會看到這兩個數據行的非零值。</span><span class="sxs-lookup"><span data-stu-id="e01e6-121">Typically, when @begin_time and @end_time are not provided, the function is showing the information from last 30 minutes, then we should normally see non-zero values for these two columns.</span></span> <span data-ttu-id="e01e6-122">若出現零值，有可能是系統過載或甚至是系統無回應。</span><span class="sxs-lookup"><span data-stu-id="e01e6-122">If they are zero then it implies system overloaded or even system not responding.</span></span> <span data-ttu-id="e01e6-123">如需詳細資訊，請參閱本主題稍後的針對**系統問題進行疑難排解**一節。</span><span class="sxs-lookup"><span data-stu-id="e01e6-123">For more information, see **Troubleshooting System Issues** section later in this topic.</span></span>  
  
2.  <span data-ttu-id="e01e6-124">檢閱擴充事件記錄，了解錯誤和其他相關事件的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="e01e6-124">Review the Extended Event logs to learn more details on the errors and other associated events.</span></span>  
  
3.  <span data-ttu-id="e01e6-125">使用此記錄中的資訊解決問題。</span><span class="sxs-lookup"><span data-stu-id="e01e6-125">Use the information in the logs to resolve the issue.</span></span>  <span data-ttu-id="e01e6-126">當系統發生問題或錯誤時，可能必須重新啟動服務或 SQL Server Agent。</span><span class="sxs-lookup"><span data-stu-id="e01e6-126">In case of a system issue or error, you may need to restart the service or SQL Server Agent.</span></span>  
  
### <a name="common-causes-of-errors"></a><span data-ttu-id="e01e6-127">錯誤常見原因</span><span class="sxs-lookup"><span data-stu-id="e01e6-127">Common Causes of Errors</span></span>  
 <span data-ttu-id="e01e6-128">下列清單是導致失敗的常見原因：</span><span class="sxs-lookup"><span data-stu-id="e01e6-128">Following is the list of common causes resulting in failures:</span></span>  
  
1.  <span data-ttu-id="e01e6-129">**SQL 認證的變更：** 如果所使用的認證名稱已 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 變更，或已被刪除， [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 將無法進行備份。</span><span class="sxs-lookup"><span data-stu-id="e01e6-129">**Changes to SQL Credential:** If the name of the credential used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is changed or if it is deleted, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will not be able to take backups.</span></span> <span data-ttu-id="e01e6-130">此變更應套用到[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]組態設定。</span><span class="sxs-lookup"><span data-stu-id="e01e6-130">The change should be applied to [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration settings.</span></span>  
  
2.  <span data-ttu-id="e01e6-131">**儲存體存取金鑰值的變更：** 如果 Azure 帳戶的儲存體金鑰值已變更，但 SQL 認證並未以新值更新， [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 則在對儲存體進行驗證時將會失敗，而且無法備份設定為使用此帳戶的資料庫。</span><span class="sxs-lookup"><span data-stu-id="e01e6-131">**Changes to storage access key values:** If the storage key values are changed for the Azure account, but SQL Credential is not updated with the new values, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will fail when authenticating to the storage, and fails to backup databases configured to use this account.</span></span>  
  
3.  <span data-ttu-id="e01e6-132">**Azure 儲存體帳戶的變更：** 刪除或重新命名儲存體帳戶，而不需要對 SQL 認證進行對應的變更，將會導致 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 失敗，而且不會執行任何備份。</span><span class="sxs-lookup"><span data-stu-id="e01e6-132">**Changes to Azure Storage Account:** Deleting or renaming storage account without corresponding changes to the SQL Credential will cause [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to fail and no backups will be taken.</span></span> <span data-ttu-id="e01e6-133">如果您刪除儲存體帳戶，請務必為資料庫重新設定有效的儲存體帳戶資訊。</span><span class="sxs-lookup"><span data-stu-id="e01e6-133">If you delete a storage account, ensure that the databases are reconfigured with valid storage account information.</span></span> <span data-ttu-id="e01e6-134">如果儲存體帳戶已重新命名，或已變更金鑰值，請確定這些變更會反映在[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]使用的 SQL 認證上。</span><span class="sxs-lookup"><span data-stu-id="e01e6-134">If a storage account is renamed or the key values are changed, ensure that these changes are reflected in the SQL Credential used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span>  
  
4.  <span data-ttu-id="e01e6-135">**資料庫屬性的變更：** 變更復原模式或變更名稱可能導致備份失敗。</span><span class="sxs-lookup"><span data-stu-id="e01e6-135">**Changes to Database Properties:** Changes to recovery models or changing the name can cause backups to fail.</span></span>  
  
5.  <span data-ttu-id="e01e6-136">**復原模式的變更：** 如果資料庫的復原模式從完整或大量記錄變更為 simple，備份將會停止，並會略過資料庫 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="e01e6-136">**Changes to Recovery Model:** If the recovery model of the database is changed to simple from full or bulk-logged, backups will stop, and the databases will be skipped by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="e01e6-137">如需詳細資訊，請參閱[SQL Server 受管理的備份至 Azure：互通性與共存](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-interoperability-and-coexistence.md)</span><span class="sxs-lookup"><span data-stu-id="e01e6-137">For more information, see [SQL Server Managed Backup to Azure: Interoperability and Coexistence](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-interoperability-and-coexistence.md)</span></span>  
  
### <a name="most-common-error-messages-and-solutions"></a><span data-ttu-id="e01e6-138">最常見的錯誤訊息和解決方案</span><span class="sxs-lookup"><span data-stu-id="e01e6-138">Most Common Error Messages and Solutions</span></span>  
  
1.  <span data-ttu-id="e01e6-139">**啟用或設定時的錯誤 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ：**</span><span class="sxs-lookup"><span data-stu-id="e01e6-139">**Errors when enabling or configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]:**</span></span>  
  
     <span data-ttu-id="e01e6-140">錯誤：「無法存取儲存體 URL ...。請提供有效的 SQL 認證 ...」：您可能會看到此錯誤，以及參考 SQL 認證的其他類似錯誤。</span><span class="sxs-lookup"><span data-stu-id="e01e6-140">Error: " Failed to access the storage URL.... Provide a valid SQL Credential..." : You may see this and other similar errors referring to SQL Credentials.</span></span>  <span data-ttu-id="e01e6-141">在這種情況下，請檢查您提供的 SQL 認證名稱，以及儲存在 SQL 認證中的資訊-儲存體帳戶名稱和儲存體存取金鑰，並確保它們是最新且有效的。</span><span class="sxs-lookup"><span data-stu-id="e01e6-141">In such cases, review the name of the SQL Credential you provided, and also the information stored in the SQL Credential - the storage account name, and the storage access key and make sure that they are current and valid.</span></span>  
  
     <span data-ttu-id="e01e6-142">錯誤：「.。。無法設定資料庫 ...。因為它是系統資料庫」：如果您嘗試針對系統資料庫啟用，就會看到此錯誤 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="e01e6-142">Error: "... cannot configure the database....because it is a system database": You will see this error if you try to enable [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for a system database.</span></span>  [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="e01e6-143">不支援系統資料庫的備份。</span><span class="sxs-lookup"><span data-stu-id="e01e6-143">does not support backups for system databases.</span></span>  <span data-ttu-id="e01e6-144">若要設定系統資料庫的備份，請使用其他 SQL Server 備份技術 (例如維護計劃)。</span><span class="sxs-lookup"><span data-stu-id="e01e6-144">To configure backup for a system database use other SQL Server Backup technologies such as maintenance plans.</span></span>  
  
     <span data-ttu-id="e01e6-145">錯誤：「.。。提供保留期限 ...」：如果您在第一次設定這些值時未指定資料庫或實例的保留期限，您可能會看到關於保留期間的錯誤。</span><span class="sxs-lookup"><span data-stu-id="e01e6-145">Error:" ... Provide a retention period...." : You may see errors regarding the retention period if you either have not specified a retention period for the database or instance when you are configuring these values for the first time.</span></span> <span data-ttu-id="e01e6-146">如果您提供的值不是 1 到 30 之間的數字，也可能會看到錯誤。</span><span class="sxs-lookup"><span data-stu-id="e01e6-146">You may also see an error if you provide a value other than a number between 1 and 30.</span></span> <span data-ttu-id="e01e6-147">保留期限的允許值是 1 到 30 之間的數字。</span><span class="sxs-lookup"><span data-stu-id="e01e6-147">The allowed value for the retention period is a number between 1 and 30.</span></span>  
  
2.  <span data-ttu-id="e01e6-148">**電子郵件通知錯誤：**</span><span class="sxs-lookup"><span data-stu-id="e01e6-148">**Email Notification Errors:**</span></span>  
  
     <span data-ttu-id="e01e6-149">錯誤：「未啟用 Database Mail ...」-如果您啟用電子郵件通知，但未在實例上設定 Database Mail，就會看到此錯誤。</span><span class="sxs-lookup"><span data-stu-id="e01e6-149">Error: "Database Mail is not enabled..." - You will see this error if you enable e-mail notifications, but Database Mail is not configured on the instance.</span></span> <span data-ttu-id="e01e6-150">您必須在執行個體上設定 Database Mail，以接收[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]的健康情況通知。</span><span class="sxs-lookup"><span data-stu-id="e01e6-150">You must configure Database Mail on the instance to be able to receive notification of the health status of [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="e01e6-151">如需有關如何啟用 database mail 的詳細資訊，請參閱[設定 Database Mail](../relational-databases/database-mail/configure-database-mail.md)。</span><span class="sxs-lookup"><span data-stu-id="e01e6-151">For information about how to enable database mail, see [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span></span> <span data-ttu-id="e01e6-152">您也必須啟用 SQL Server Agent 以使用 Database Mail 進行通知。</span><span class="sxs-lookup"><span data-stu-id="e01e6-152">You must also enable SQL Server Agent to use Database Mail for notifications.</span></span> <span data-ttu-id="e01e6-153">如需詳細資訊，請參閱[開始之前](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md#BeforeYouBegin)。</span><span class="sxs-lookup"><span data-stu-id="e01e6-153">For more information, see [Before You Begin](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md#BeforeYouBegin).</span></span>  
  
     <span data-ttu-id="e01e6-154">下列清單列出和電子郵件通知相關的錯誤號碼：</span><span class="sxs-lookup"><span data-stu-id="e01e6-154">Following is a list of error numbers you might see that are associated with email notifications:</span></span>  
  
    -   <span data-ttu-id="e01e6-155">ErrorNumber：45209</span><span class="sxs-lookup"><span data-stu-id="e01e6-155">ErrorNumber: 45209</span></span>  
  
    -   <span data-ttu-id="e01e6-156">ErrorNumber：45210</span><span class="sxs-lookup"><span data-stu-id="e01e6-156">ErrorNumber: 45210</span></span>  
  
    -   <span data-ttu-id="e01e6-157">錯誤號碼：45211</span><span class="sxs-lookup"><span data-stu-id="e01e6-157">ErrorNumber: 45211</span></span>  
  
3.  <span data-ttu-id="e01e6-158">**連接錯誤：**</span><span class="sxs-lookup"><span data-stu-id="e01e6-158">**Connectivity Errors:**</span></span>  
  
    -   <span data-ttu-id="e01e6-159">**SQL 連線能力的相關錯誤：** 當連接到 SQL Server 實例時發生問題時，就會發生這些錯誤。</span><span class="sxs-lookup"><span data-stu-id="e01e6-159">**Errors Related to SQL Connectivity:** These errors happen when there are issues connecting to SQL Server instance.</span></span> <span data-ttu-id="e01e6-160">擴充的事件會透過管理通道公開這些錯誤類型。</span><span class="sxs-lookup"><span data-stu-id="e01e6-160">The extended events expose these type of errors through the admin channel.</span></span> <span data-ttu-id="e01e6-161">以下是您可能會看到與此種連接問題相關之錯誤的兩個擴充事件：</span><span class="sxs-lookup"><span data-stu-id="e01e6-161">Following are the two extended events that you might see for errors related to this type of connectivity issues:</span></span>  
  
         <span data-ttu-id="e01e6-162">FileRetentionAdminXEvent，且 event_type = SqlError。</span><span class="sxs-lookup"><span data-stu-id="e01e6-162">FileRetentionAdminXEvent with event_type = SqlError.</span></span> <span data-ttu-id="e01e6-163">如需有關此錯誤的詳細資料，請參閱該事件的 error_code、error_message 和 stack_trace。</span><span class="sxs-lookup"><span data-stu-id="e01e6-163">For details of this error, look at the error_code, error_message and stack_trace of that event.</span></span> <span data-ttu-id="e01e6-164">Error_code 是 SqlException 的錯誤號碼。</span><span class="sxs-lookup"><span data-stu-id="e01e6-164">The error_code is the SqlException's error number.</span></span>  
  
         <span data-ttu-id="e01e6-165">具有下列訊息/訊息前置詞的 SmartBackupAdminXevent：</span><span class="sxs-lookup"><span data-stu-id="e01e6-165">SmartBackupAdminXevent with the following messages/message prefixes:</span></span>  
  
         <span data-ttu-id="e01e6-166">*「為實例設定 SQL Server 受管理備份至 Azure 預設值時發生內部錯誤。錯誤可能是暫時性的。」*</span><span class="sxs-lookup"><span data-stu-id="e01e6-166">*"An internal error occurred while configuring SQL Server Managed Backup to Azure default settings for instance. Error might be transient."*</span></span>  
  
         <span data-ttu-id="e01e6-167">*「可能會遇到 SQL Server 的連線問題。正在略過目前反覆運算中的資料庫」。*</span><span class="sxs-lookup"><span data-stu-id="e01e6-167">*"Probably experiencing connectivity issues with SQL Server. Skipping database in the current iteration."*</span></span>  
  
         <span data-ttu-id="e01e6-168">*「查詢記錄使用量資訊失敗。失敗可能是暫時性的。正在略過目前反覆運算中的資料庫」。*</span><span class="sxs-lookup"><span data-stu-id="e01e6-168">*"Querying log usage info failed. The failure might be transient. Skipping database in the current iteration."*</span></span>  
  
         <span data-ttu-id="e01e6-169">*「載入 SSMBackup2WA 代理程式中繼資料時，發生 SQL 例外狀況。失敗可能是暫時性的。將會重試操作。」*</span><span class="sxs-lookup"><span data-stu-id="e01e6-169">*"SQL exception encountered while loading SSMBackup2WA agent metadata. The failure might be transient. Operation will be retried."*</span></span>  
  
         <span data-ttu-id="e01e6-170">*「SSMBackup2WA 發生 SQL 例外狀況 .。。"*</span><span class="sxs-lookup"><span data-stu-id="e01e6-170">*"SSMBackup2WA encountered SQL exception while ... "*</span></span>  
  
    -   <span data-ttu-id="e01e6-171">**連接至儲存體帳戶時發生錯誤：**</span><span class="sxs-lookup"><span data-stu-id="e01e6-171">**Errors Connecting to the storage account:**</span></span>  
  
         <span data-ttu-id="e01e6-172">FileRetentionAdminXEvent 中回報了儲存體例外狀況，且 event_type = XstoreError。</span><span class="sxs-lookup"><span data-stu-id="e01e6-172">Storage exceptions are reported in FileRetentionAdminXEvent with event_type = XstoreError.</span></span> <span data-ttu-id="e01e6-173">如需有關此錯誤的詳細資料，請參閱該事件的 error_message 和 stack_trace。</span><span class="sxs-lookup"><span data-stu-id="e01e6-173">For details of the error, look at the error_message and stack_trace of that event.</span></span>  
  
         <span data-ttu-id="e01e6-174">因為 SQL Server Managed Backup 會使用基礎的「備份至 URL」技術，所以與儲存體連接相關的錯誤適用於這兩項功能。</span><span class="sxs-lookup"><span data-stu-id="e01e6-174">Since SQL Server Managed Backup uses the underlying Backup to URL technology, the errors related to storage connectivity apply to both the features.</span></span> <span data-ttu-id="e01e6-175">如需疑難排解步驟的詳細資訊，請參閱[SQL Server 備份至 URL 的最佳作法和疑難排解](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md)一文中的**疑難排解一節**。</span><span class="sxs-lookup"><span data-stu-id="e01e6-175">For more information on troubleshooting steps, see **troubleshooting section** of the [SQL Server Backup to URL Best Practices and Troubleshooting](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md) article.</span></span>  
  
### <a name="troubleshooting-system-issues"></a><span data-ttu-id="e01e6-176">疑難排解系統問題</span><span class="sxs-lookup"><span data-stu-id="e01e6-176">Troubleshooting System Issues</span></span>  
 <span data-ttu-id="e01e6-177">下列案例指出系統 (SQL Server、SQL Server Agent) 發生問題的案例及其對[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]的影響：</span><span class="sxs-lookup"><span data-stu-id="e01e6-177">Following are some scenarios when there is an issue with the system (SQL Server, SQL Server Agent) and its effects on [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]:</span></span>  
  
-   <span data-ttu-id="e01e6-178">**當 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 執行時，Sqlservr.exe 停止回應或停止運作：** 如果 SQL Server 停止運作，sql 代理程式將會正常關閉， [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 並會停止，並將事件記錄在 SQL 代理程式中。 out file。</span><span class="sxs-lookup"><span data-stu-id="e01e6-178">**Sqlservr.exe stops responding or stops working when [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is running:** If SQL Server stops working, SQL Agent will gracefully shut down, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] also stops and the events are logged in SQL Agent.out file.</span></span>  
  
     <span data-ttu-id="e01e6-179">如果 SQL Server 停止回應，事件會記錄到管理通道。</span><span class="sxs-lookup"><span data-stu-id="e01e6-179">If SQL Server stops responding, events are logged in the admin channel.</span></span>  <span data-ttu-id="e01e6-180">以下是事件記錄檔的範例：</span><span class="sxs-lookup"><span data-stu-id="e01e6-180">An example of the event log:</span></span>  
  
     <span data-ttu-id="e01e6-181">*Sql 錯誤 (引擎沒有回應或取得 sqlException： SqlException：* </span><span class="sxs-lookup"><span data-stu-id="e01e6-181">*Sql Error (engine not responding or get sqlException: SqlException:* </span></span>  
     <span data-ttu-id="e01e6-182">*錯誤碼、訊息和 stacktrace 會顯示在管理通道 xevent 中，以及一些額外的資訊，例如：* </span><span class="sxs-lookup"><span data-stu-id="e01e6-182">*error code, message and stacktrace will be displayed in an admin channel xevent, together with some extra information, such as :* </span></span>  
    <span data-ttu-id="e01e6-183">*「可能會遇到 SQL Server 的連線問題。正在略過目前反覆運算中的資料庫」*</span><span class="sxs-lookup"><span data-stu-id="e01e6-183">*"Probably experiencing connectivity issues with SQL Server. Skipping database in the current iteration"*</span></span>  
  
-   <span data-ttu-id="e01e6-184">**當執行時，SQL 代理程式停止回應或停止運作 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ：**</span><span class="sxs-lookup"><span data-stu-id="e01e6-184">**SQL Agent stops responding or stops working when [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is running:**</span></span>  
  
     <span data-ttu-id="e01e6-185">如果 SQL Agent 停止運作，[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]也會停止，並將事件記錄到管理通道。</span><span class="sxs-lookup"><span data-stu-id="e01e6-185">If SQL Agent stops working, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] also stops and events are logged in the admin channel.</span></span> <span data-ttu-id="e01e6-186">這與 SQL Server 停止回應的案例類似。</span><span class="sxs-lookup"><span data-stu-id="e01e6-186">This is similar to the scenarios when SQL Server stops responding.</span></span>  
  
     <span data-ttu-id="e01e6-187">如果 SQL Agent 停止回應，[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]將無法繼續執行備份作業，事件也會記錄到管理通道。</span><span class="sxs-lookup"><span data-stu-id="e01e6-187">If SQL Agent stops responding, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will be unable to continue with backup operations, and events are logged in the admin channel.</span></span> <span data-ttu-id="e01e6-188">以下是事件記錄檔的範例：</span><span class="sxs-lookup"><span data-stu-id="e01e6-188">An example of the event log:</span></span>  
  
     <span data-ttu-id="e01e6-189">*作業停止回應：請參閱管理通道 xevents* </span><span class="sxs-lookup"><span data-stu-id="e01e6-189">*Job hangs: see admin channel xevents* </span></span>  
    <span data-ttu-id="e01e6-190">*「資料庫備份的 DBBackupInfoMsgMaxWaitTime +」小時內，未收到來自 SQL Server 的進度更新。  SSM 雲端備份將繼續等待。」*</span><span class="sxs-lookup"><span data-stu-id="e01e6-190">*"A progress update hasn't been received from SQL Server in more than " + Constants.DBBackupInfoMsgMaxWaitTime  + " hours for database backup.   SSM Cloud Backup will continue to wait."*</span></span>  
  
 <span data-ttu-id="e01e6-191">如果您已啟用電子郵件通知，您會收到一則通知，其中包含**備份迴圈的數目**和**保留迴圈的數目**。</span><span class="sxs-lookup"><span data-stu-id="e01e6-191">If you have enabled email notification, you will receive a notification which includes **Number of Backup Loops** and **Number of Retention Loops**.</span></span> <span data-ttu-id="e01e6-192">如果通知中這兩個資料行的傳回值有一個或兩者皆為零，可能表示系統無回應。</span><span class="sxs-lookup"><span data-stu-id="e01e6-192">If the value returned in the notification for one or both of these two columns is zero, it could be an indication that the system is not responding.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="e01e6-193">產生報表結果的內部處理序會假設引擎診斷記錄位於 SQL 代理程式錯誤記錄檔的相同位置，此位置預設位在與 SQL Server 執行個體的錯誤記錄檔相同的資料夾。</span><span class="sxs-lookup"><span data-stu-id="e01e6-193">The internal processes that generate the results for the report, assumes that the engine diagnostic logs are in the same location of SQL Agent error log, which by default is in the same folder as the error logs of the SQL Server instance.</span></span> <span data-ttu-id="e01e6-194">如果引擎診斷記錄移到非 SQL 代理程式錯誤記錄檔位置的其他位置，系統就會找不到智慧型備份診斷記錄，因此電子郵件通知中的報表可能會不正確。</span><span class="sxs-lookup"><span data-stu-id="e01e6-194">If the engine diagnostic logs are moved to a location other than SQL Agent error log location, the system is unable to find the smart backup diagnostic logs, and hence the report in the email notification may not be correct.</span></span> <span data-ttu-id="e01e6-195">例如，您可能會在所有報告的欄位中看到值為**0** ，包括備份迴圈的數目和保留迴圈的數目。</span><span class="sxs-lookup"><span data-stu-id="e01e6-195">For example, you might see a value of **0** in all the fields reported including the Number of Backup Loops and Number of Retention Loops.</span></span> <span data-ttu-id="e01e6-196">在診斷記錄移至不同位置的這個情況下，可能不表示系統不回應，而是系統找不到記錄。</span><span class="sxs-lookup"><span data-stu-id="e01e6-196">In this case where the diagnostic logs are moved to a different location, it may not mean that the system is not responding, but that the system is unable to find the logs.</span></span> <span data-ttu-id="e01e6-197">請先確定診斷記錄的位置和 SQL 代理程式錯誤記錄檔位於相同的位置。</span><span class="sxs-lookup"><span data-stu-id="e01e6-197">Ensure that the location of the diagnostic logs and SQL Agent error logs are at the same location first.</span></span> <span data-ttu-id="e01e6-198">若要確認診斷記錄的目前位置，您可以使用[sys.databases dm_os_server_diagnostics_log_configurations](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-server-diagnostics-log-configurations)。</span><span class="sxs-lookup"><span data-stu-id="e01e6-198">To verify the current location of the diagnostic logs, you can use [sys.dm_os_server_diagnostics_log_configurations](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-server-diagnostics-log-configurations).</span></span> <span data-ttu-id="e01e6-199">資料行會傳回 `path` 引擎診斷記錄的目前位置。</span><span class="sxs-lookup"><span data-stu-id="e01e6-199">The `path` column returns the current location of the engine diagnostic logs.</span></span>  <span data-ttu-id="e01e6-200">它應該位於與 SQL Agent 錯誤記錄檔相同的資料夾中。</span><span class="sxs-lookup"><span data-stu-id="e01e6-200">It should be in the same folder as the SQL Agent error logs.</span></span> <span data-ttu-id="e01e6-201">您可以使用 `dbo.sp_get_sqlagent_properties` 預存程序取得 SQL 代理程式錯誤記錄檔路徑。</span><span class="sxs-lookup"><span data-stu-id="e01e6-201">You can get SQL Agent error log path using the `dbo.sp_get_sqlagent_properties` stored procedure.</span></span>  
  
 <span data-ttu-id="e01e6-202">請查看擴充事件記錄中有關錯誤的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="e01e6-202">Check the extended event logs to see details of the errors.</span></span> <span data-ttu-id="e01e6-203">修正錯誤或重新啟動 SQL Server Agent，以更正狀態。</span><span class="sxs-lookup"><span data-stu-id="e01e6-203">fix the errors, or restart SQL Server Agent to correct the situation.</span></span>  
  
  
