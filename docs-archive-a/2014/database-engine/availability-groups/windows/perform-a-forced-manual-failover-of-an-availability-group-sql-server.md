---
title: 執行可用性群組的強制手動容錯移轉 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/14/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
f1_keywords:
- sql12.swb.availabilitygroup.forcefailover.f1
helpviewer_keywords:
- Availability Groups [SQL Server], failover
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 222288fe-ffc0-4567-b624-5d91485d70f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: f36908102a09eb1ef1f7a485898da715deb4253b
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87594699"
---
# <a name="perform-a-forced-manual-failover-of-an-availability-group-sql-server"></a><span data-ttu-id="c1577-102">執行可用性群組的強制手動容錯移轉 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c1577-102">Perform a Forced Manual Failover of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="c1577-103">本主題描述如何使用 [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]、[!INCLUDE[tsql](../../../includes/tsql-md.md)] 或 [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] 中的 PowerShell，在 AlwaysOn 可用性群組上執行強制容錯移轉 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="c1577-103">This topic describes how to perform a forced failover (with possible data loss) on an AlwaysOn availability group by using [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)], or PowerShell in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="c1577-104">強制容錯移轉是一種手動容錯移轉形式，嚴格限於 [已規劃的手動容錯移轉](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md) 不可行時用來進行災難復原。</span><span class="sxs-lookup"><span data-stu-id="c1577-104">A forced failover is a form of manual failover that is intended strictly for disaster recovery, when a [planned manual failover](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md) is not possible.</span></span> <span data-ttu-id="c1577-105">如果您強制容錯移轉至非同步的次要複本，有些資料可能會遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-105">If you force failover to an unsynchronized secondary replica, some data loss is possible.</span></span> <span data-ttu-id="c1577-106">因此，強烈建議您只有在主要複本不再執行、而且您願意承擔遺失資料的風險以還原可用性群組中對資料庫的存取時，才進行強制容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="c1577-106">Therefore, we strongly recommend that you force failover only if you must restore service to the availability group immediately and you are willing to risk losing data.</span></span>  
  
 <span data-ttu-id="c1577-107">強制容錯移轉之後，可用性群組進行容錯移轉的容錯移轉目標會變成新的主要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-107">After a forced failover, the failover target to which the availability group was failed over becomes the new primary replica.</span></span> <span data-ttu-id="c1577-108">剩餘次要複本中的次要資料庫會暫停，而且必須以手動方式繼續。</span><span class="sxs-lookup"><span data-stu-id="c1577-108">The secondary databases in the remaining secondary replicas are suspended and must be manually resumed.</span></span> <span data-ttu-id="c1577-109">當之前的主要複本變成可用複本時，會轉換為次要角色，造成之前的主要資料庫變成次要資料庫並轉換到 SUSPENDED 狀態。</span><span class="sxs-lookup"><span data-stu-id="c1577-109">When the former primary replica becomes available, it transitions to the secondary role, causing the former primary databases to become secondary databases and transition into the SUSPENDED state.</span></span> <span data-ttu-id="c1577-110">在繼續執行給定的次要資料庫之前，您或許可以從該資料庫復原遺失的資料。</span><span class="sxs-lookup"><span data-stu-id="c1577-110">Before you resume a given secondary database, you might be able to recover lost data from it.</span></span> <span data-ttu-id="c1577-111">不過須注意，只要有任何次要資料庫暫停，給定主要資料庫上的交易記錄截斷就會延遲。</span><span class="sxs-lookup"><span data-stu-id="c1577-111">However, notice that transaction log truncation is delayed on a given primary database while any of its secondary databases is suspended.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c1577-112">在次要資料庫恢復之前，將不會進行與主要資料庫的資料同步處理。</span><span class="sxs-lookup"><span data-stu-id="c1577-112">Data synchronization with the primary database will not occur until the secondary database is resumed.</span></span> <span data-ttu-id="c1577-113">如需繼續次要資料庫的資訊，請參閱本文稍後的[後續操作：強制容錯移轉後的重要工作](#FollowUp)。</span><span class="sxs-lookup"><span data-stu-id="c1577-113">For information about resuming a secondary database, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp) later in this article.</span></span>  
  
 <span data-ttu-id="c1577-114">在下列緊急情況中，必須執行強制容錯移轉：</span><span class="sxs-lookup"><span data-stu-id="c1577-114">Performing a forced failover is necessary in the following emergency situations:</span></span>  
  
-   <span data-ttu-id="c1577-115">在 WSFC 叢集上強制進行仲裁之後 (「強制仲裁」(Forced Quorum)  )，您需要強制容錯移轉每個可用性群組 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="c1577-115">After forcing quorum on the WSFC cluster (*forced quorum*), you need to force failover each availability group (with possible data loss).</span></span> <span data-ttu-id="c1577-116">強制容錯移轉是必要的，因為 WSFC 叢集值的實際狀態可能已遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-116">Forcing failover is required because the real state of the WSFC cluster values might have been lost.</span></span> <span data-ttu-id="c1577-117">不過，您能夠在強制仲裁之前，在裝載主要複本的伺服器執行個體上強制容錯移轉，或是在強制仲裁之前容錯移轉至同步處理的次要複本，則可以避免資料遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-117">However, you can avoid data loss, if are able to force failover on the server instance that was hosting the replica that was the primary replica before you forced quorum or to a secondary replica that was synchronized before you forced quorum.</span></span> <span data-ttu-id="c1577-118">如需詳細資訊，請參閱本主題稍後的 [避免在強制仲裁之後遺失資料的可能方式](#WaysToAvoidDataLoss)。</span><span class="sxs-lookup"><span data-stu-id="c1577-118">For more information, see [Potential Ways to Avoid Data Loss After Quorum is Forced](#WaysToAvoidDataLoss), later in this topic.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="c1577-119">如果仲裁透過自然而不是強制的方式重新取得，則可用性複本會進行一般復原。</span><span class="sxs-lookup"><span data-stu-id="c1577-119">If quorum is regained by natural means instead of being forced, the availability replicas will go through normal recovery.</span></span> <span data-ttu-id="c1577-120">如果在重新取得仲裁之後主要複本仍然無法使用，您可以執行規劃的手動容錯移轉至同步處理的次要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-120">If the primary replica is still unavailable after quorum is regained, you can perform a planned manual failover to a synchronized secondary replica.</span></span>  
  
     <span data-ttu-id="c1577-121">如需強制仲裁的資訊，請參閱 [透過強制仲裁執行 WSFC 災害復原 &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)中的 PowerShell，在 AlwaysOn 可用性群組上執行強制容錯移轉 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="c1577-121">For information about forcing quorum, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span> <span data-ttu-id="c1577-122">如需為何要在強制仲裁之後強制容錯移轉的相關資訊，請參閱[容錯移轉及容錯移轉模式 &#40;AlwaysOn 可用性群組&#41;](failover-and-failover-modes-always-on-availability-groups.md)。</span><span class="sxs-lookup"><span data-stu-id="c1577-122">For information about why forcing failover is required after forcing quorum, see [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
-   <span data-ttu-id="c1577-123">如果主要複本在 WSFC 叢集擁有狀況良好的仲裁時變成無法使用，您可以強制容錯移轉 (可能會遺失資料) 至其角色為 SECONDARY 或 RESOLVING 狀態的任何複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-123">If the primary replica becomes unavailable when the WSFC cluster has a healthy quorum, you can force failover (with possible data loss), to any replica whose role is in the SECONDARY or RESOLVING state.</span></span> <span data-ttu-id="c1577-124">如有可能的話，在主要複本已遺失時，強制容錯移轉至已同步處理的同步認可次要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-124">If possible, force failover to a synchronous-commit secondary replica that was synchronized when the primary replica was lost.</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="c1577-125">當 WSFC 叢集擁有狀況良好的仲裁時，如果您在已同步處理的次要複本上發出強制容錯移轉命令，則複本會實際執行規劃的手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="c1577-125">When the WSFC cluster has a healthy quorum, if you issue a force failover command on a synchronized secondary replica, the replica actually performs a planned manual failover.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c1577-126">如需強制容錯移轉之必要條件和建議的詳細資訊，以及使用強制容錯移轉從重大錯誤復原的範例案例，請參閱本主題稍後的[範例案例：使用強制容錯移轉從重大錯誤復原](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#ExampleRecoveryFromCatastrophy)。</span><span class="sxs-lookup"><span data-stu-id="c1577-126">For more information about the prerequisites and recommendations for forcing failover and for an example scenario that uses a forced failover to recover from a catastrophic failure, see [Example Scenario: Using a Forced Failover to Recover from a Catastrophic Failure](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#ExampleRecoveryFromCatastrophy), later in this topic.</span></span>  
  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> <span data-ttu-id="c1577-127">開始之前</span><span class="sxs-lookup"><span data-stu-id="c1577-127">Before You Begin</span></span>  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> <span data-ttu-id="c1577-128">限制事項</span><span class="sxs-lookup"><span data-stu-id="c1577-128">Limitations and Restrictions</span></span>  
  
-   <span data-ttu-id="c1577-129">唯一無法執行強制容錯移轉的情況，是 Windows Server 容錯移轉叢集 (WSFC) 缺少仲裁時。</span><span class="sxs-lookup"><span data-stu-id="c1577-129">The only time that you cannot perform a forced failover is when Windows Server Failover Clustering (WSFC) cluster lacks quorum.</span></span>  
  
-   <span data-ttu-id="c1577-130">在可用性群組的強制容錯移轉期間，可能會發生資料遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-130">Data loss is possible during the forced failover of an availability group.</span></span> <span data-ttu-id="c1577-131">此外，如果主要複本在您起始強制容錯移轉時正在執行，用戶端可能仍然會連接至先前的主要資料庫。</span><span class="sxs-lookup"><span data-stu-id="c1577-131">In addition, if the primary replica is running when you initiate a forced failover, clients might still be connected to former primary databases.</span></span> <span data-ttu-id="c1577-132">因此，我們強烈建議您只有在主要複本不再執行、而且您願意承擔遺失資料的風險以還原可用性群組中對資料庫的存取時，才進行強制容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="c1577-132">Therefore, we strongly recommend that you force failover only if the primary replica is no longer running and if you are willing to risk losing data in order to restore access to databases in the availability group.</span></span>  
  
-   <span data-ttu-id="c1577-133">當次要資料庫處於 REVERTING 或 INITIALIZING 狀態時，強制容錯移轉會導致資料庫無法當做主要資料庫啟動。</span><span class="sxs-lookup"><span data-stu-id="c1577-133">When a secondary database in the REVERTING or INITIALIZING state, forcing failover would cause the database to fail to start as a primary database.</span></span> <span data-ttu-id="c1577-134">如果資料庫處於 INTIAILIZGING 狀態，您需要從資料庫備份套用遺失的記錄檔記錄，或從頭完全還原資料庫。</span><span class="sxs-lookup"><span data-stu-id="c1577-134">If the database was in the INTIAILIZGING state the you will need to apply the missing log records from a database backup or fully restore the database from scratch.</span></span> <span data-ttu-id="c1577-135">如果資料庫處於 REVERTING 狀態，您就必須從備份完全還原資料庫。</span><span class="sxs-lookup"><span data-stu-id="c1577-135">If the database was in the REVERTING state you will need to fully restore the database from backups.</span></span>  
  
-   <span data-ttu-id="c1577-136">只要容錯移轉目標接受了命令，就會傳回容錯移轉命令。</span><span class="sxs-lookup"><span data-stu-id="c1577-136">A failover command returns as soon as the failover target has accepted the command.</span></span> <span data-ttu-id="c1577-137">不過，在可用性群組完成容錯移轉之後，會以非同步方式復原資料庫。</span><span class="sxs-lookup"><span data-stu-id="c1577-137">However, database recovery occurs asynchronously after the availability group has finished failing over.</span></span>  
  
-   <span data-ttu-id="c1577-138">容錯移轉時，不會保留可用性群組內跨資料庫的一致性。</span><span class="sxs-lookup"><span data-stu-id="c1577-138">Cross-database consistency across databases within the availability group is not maintained on failover.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="c1577-139">[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 不支援跨資料庫交易和分散式交易。</span><span class="sxs-lookup"><span data-stu-id="c1577-139">Cross-database transactions and distributed transactions are not supported by [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="c1577-140">如需詳細資訊，請參閱[資料庫鏡像或 AlwaysOn 可用性群組不支援跨資料庫交易 &#40;SQL Server&#41;](transactions-always-on-availability-and-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="c1577-140">For more information, see [Cross-Database Transactions Not Supported For Database Mirroring or AlwaysOn Availability Groups &#40;SQL Server&#41;](transactions-always-on-availability-and-database-mirroring.md).</span></span>  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a> <span data-ttu-id="c1577-141">必要條件</span><span class="sxs-lookup"><span data-stu-id="c1577-141">Prerequisites</span></span>  
  
-   <span data-ttu-id="c1577-142">WSFC 叢集具有仲裁。</span><span class="sxs-lookup"><span data-stu-id="c1577-142">The WSFC cluster has quorum.</span></span> <span data-ttu-id="c1577-143">如果叢集缺少仲裁，請參閱 [透過強制仲裁執行 WSFC 災害復原 &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)中的 PowerShell，在 AlwaysOn 可用性群組上執行強制容錯移轉 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="c1577-143">If the cluster lacks quorum, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span>  
  
-   <span data-ttu-id="c1577-144">您必須能夠連接到裝載複本的伺服器執行個體，而該複本的角色為 SECONDARY 或 RESOLVING 狀態。</span><span class="sxs-lookup"><span data-stu-id="c1577-144">You must be able to connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state.</span></span>  
  
###  <a name="recommendations"></a><a name="Recommendations"></a> <span data-ttu-id="c1577-145">建議</span><span class="sxs-lookup"><span data-stu-id="c1577-145">Recommendations</span></span>  
  
-   <span data-ttu-id="c1577-146">主要複本仍在執行時，不要強制容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="c1577-146">Do not force failover while the primary replica is still running.</span></span>  
  
-   <span data-ttu-id="c1577-147">可能的話，只強制容錯移轉至次要資料庫為 NOT SYNCHRONIZED、SYNCHRONIZED 或 SYNCHRONIZING 狀態的容錯移轉目標。</span><span class="sxs-lookup"><span data-stu-id="c1577-147">If possible, force failover only to a failover target whose secondary databases are either in the NOT SYNCHRONIZED, SYNCHRONIZED, or SYNCHRONIZING state.</span></span> <span data-ttu-id="c1577-148">如需有關次要資料庫處於 INTIAILIZGING 或 REVERTING 狀態時強制容錯移轉之含意的資訊，請參閱本主題前面的 [限制事項](#Restrictions)。</span><span class="sxs-lookup"><span data-stu-id="c1577-148">For information about the implications of forcing failover when a secondary database is in the INTIAILIZGING or REVERTING state, see [Limitations and Restrictions](#Restrictions), earlier in this topic.</span></span>  
  
-   <span data-ttu-id="c1577-149">相對於主要資料庫，通常在不同的非同步認可次要複本上的給定次要資料庫延遲應該類似。</span><span class="sxs-lookup"><span data-stu-id="c1577-149">Typically, the latency of a given secondary database, relative to the primary database, should be similar on different asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="c1577-150">不過，強制容錯移轉時，資料遺失會是一項重要考量。</span><span class="sxs-lookup"><span data-stu-id="c1577-150">However, when forcing failover, data loss can be a significant concern.</span></span> <span data-ttu-id="c1577-151">因此，請花點時間決定不同次要複本上資料庫副本的相對延遲。</span><span class="sxs-lookup"><span data-stu-id="c1577-151">Therefore, consider taking time to determine the relative latency of the copies of the databases on different secondary replicas.</span></span> <span data-ttu-id="c1577-152">若要決定哪一個指定次要資料庫副本的延遲最少，請比較它們的記錄檔結束 LSN。</span><span class="sxs-lookup"><span data-stu-id="c1577-152">To determine which copy of a given secondary database has the least latency, compare their end-of-log LSNs.</span></span> <span data-ttu-id="c1577-153">記錄檔結束 LSN 越高，表示延遲越少。</span><span class="sxs-lookup"><span data-stu-id="c1577-153">A higher the end-of-log LSN indicates less latency.</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="c1577-154">若要比較記錄檔結束 LSN，請輪流連接到每一個線上次要複本，並且查詢 [sys.dm_hadr_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) 中每個本機次要資料庫的 **end_of_log_lsn** 值。</span><span class="sxs-lookup"><span data-stu-id="c1577-154">To compare end-of-log LSNs, connect to each online secondary replica, in turn, and query [sys.dm_hadr_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) for the **end_of_log_lsn** value of each local secondary database.</span></span> <span data-ttu-id="c1577-155">然後，比較每個資料庫之不同副本的記錄檔結束 LSN。</span><span class="sxs-lookup"><span data-stu-id="c1577-155">Then, compare the end-of-log LSNs of the different copies of each database.</span></span> <span data-ttu-id="c1577-156">請注意，不同的資料庫在不同的次要複本上可能擁有最高的 LSN。</span><span class="sxs-lookup"><span data-stu-id="c1577-156">Note that different databases might have their highest LSNs on different secondary replicas.</span></span> <span data-ttu-id="c1577-157">在此情況下，最適合的容錯移轉目標取決於您在不同資料庫中之資料的相對重要性。</span><span class="sxs-lookup"><span data-stu-id="c1577-157">In this case, the most appropriate failover target depends on the relative importance that you place on the data in the different databases.</span></span> <span data-ttu-id="c1577-158">也就是說，在這些資料庫中，您想要將哪些資料遺失的可能性降到最低？</span><span class="sxs-lookup"><span data-stu-id="c1577-158">That is, for which of these databases would you most want to minimize possible data loss?</span></span>  
  
-   <span data-ttu-id="c1577-159">如果用戶端能夠連接到原始的主要複本，強制容錯移轉會產生核心分裂行為的某些風險。</span><span class="sxs-lookup"><span data-stu-id="c1577-159">If clients are able to connect to the original primary, a forced failover incurs some risk of split brain behavior.</span></span> <span data-ttu-id="c1577-160">在您強制容錯移轉之前，強烈建議您防止用戶端存取原始的主要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-160">Before you force failover, we strongly recommend that you prevent clients from accessing the original primary replica.</span></span> <span data-ttu-id="c1577-161">否則，在強制容錯移轉之後，原始的主要資料庫和目前的主要資料庫可能會各自獨立更新。</span><span class="sxs-lookup"><span data-stu-id="c1577-161">Otherwise, after failover is forced, the original primary databases and the current primary databases could be updated independently of the other.</span></span>  
  
###  <a name="potential-ways-to-avoid-data-loss-after-quorum-is-forced"></a><a name="WaysToAvoidDataLoss"></a> <span data-ttu-id="c1577-162">避免在強制仲裁之後遺失資料的可能方式</span><span class="sxs-lookup"><span data-stu-id="c1577-162">Potential Ways to Avoid Data Loss After Quorum is Forced</span></span>  
 <span data-ttu-id="c1577-163">在某些失敗情況下遺失仲裁之後，您可以避免遺失資料，如下所示：</span><span class="sxs-lookup"><span data-stu-id="c1577-163">Under some failure conditions after quorum is lost, you can avoid prevent data loss, as follows:</span></span>  
  
-   <span data-ttu-id="c1577-164">**如果原始主要複本上線**</span><span class="sxs-lookup"><span data-stu-id="c1577-164">**If the original primary replica comes online**</span></span>  
  
     <span data-ttu-id="c1577-165">如果仲裁遺失且強制 WSFC 仲裁還原裝載可用性群組主要複本的叢集節點，則您可以防止這個可用性群組的資料遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-165">If quorum is lost and forcing WSFC quorum restores the cluster node that hosts the primary replica of an availability group, you can prevent data loss for this availability group.</span></span> <span data-ttu-id="c1577-166">連接到主要複本並執行強制容錯移轉 (FAILOVER_ALLOW_DATA_LOSS)。</span><span class="sxs-lookup"><span data-stu-id="c1577-166">Connect to the primary replica and perform a forced failover (FAILOVER_ALLOW_DATA_LOSS).</span></span> <span data-ttu-id="c1577-167">這樣會讓主要複本重新上線。</span><span class="sxs-lookup"><span data-stu-id="c1577-167">This brings the primary replica back online.</span></span> <span data-ttu-id="c1577-168">由於您執行強制容錯移轉至原始主要複本，因此資料不會遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-168">Because you perform the forced failover to the original primary replica, there is no data loss.</span></span>  
  
-   <span data-ttu-id="c1577-169">**如果已同步處理的同步認可次要複本上線**</span><span class="sxs-lookup"><span data-stu-id="c1577-169">**If a synchronized synchronous-commit secondary replica comes online**</span></span>  
  
     <span data-ttu-id="c1577-170">如果仲裁遺失且強制 WSFC 仲裁還原裝載可用性群組之已同步處理次要複本的叢集節點，則您應該能夠防止這個可用性群組的資料遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-170">If quorum is lost and forcing WSFC quorum restores a cluster node that hosts a synchronized secondary replica for an availability group, you should be able to prevent data loss for this availability group.</span></span> <span data-ttu-id="c1577-171">如果還原的節點在遺失仲裁時為運作狀態，您可以藉由查詢 **sys.dm_hadr_database_replica_cluster_states** 動態管理檢視的 [is_failover_ready](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-cluster-states-transact-sql) 資料行，判斷給定資料庫上是否可能發生資料遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-171">If the restored node was up at the time that quorum was lost, you can determine whether data loss could occur on a given database by querying the **is_failover_ready** column of the [sys.dm_hadr_database_replica_cluster_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-cluster-states-transact-sql) dynamic management view.</span></span> <span data-ttu-id="c1577-172">例如，針對名為 `sql108w2k8r22`的伺服器執行個體，發出下列查詢：</span><span class="sxs-lookup"><span data-stu-id="c1577-172">For example, for a server instance named `sql108w2k8r22`, issue the following query:</span></span>  
  
    ```  
    SELECT * FROM sys.dm_hadr_database_replica_cluster_states  
       WHERE replica_id=(SELECT replica_id FROM sys.availability_replicas   
          WHERE replica_server_name ='sql108w2k8r22')  
    ```  
  
    > [!CAUTION]  
    >  <span data-ttu-id="c1577-173">如果還原的節點在遺失仲裁時並未運作，則 **is_failover_ready** 不一定會反映主要複本離線時叢集的實際狀態。</span><span class="sxs-lookup"><span data-stu-id="c1577-173">If the restored node was not up at the time quorum was lost, **is_failover_ready** may not reflect the cluster's actual state at the time the primary replica went offline.</span></span> <span data-ttu-id="c1577-174">因此， **is_failover_ready** 值只有在主機節點失敗時才有效。</span><span class="sxs-lookup"><span data-stu-id="c1577-174">Therefore, the **is_failover_ready** value is only good if the host node at the time of the failure.</span></span> <span data-ttu-id="c1577-175">如需詳細資訊，請參閱[容錯移轉及容錯移轉模式 &#40;AlwaysOn 可用性群組&#41;](failover-and-failover-modes-always-on-availability-groups.md) 中的＜為什麼需要在強制仲裁之後強制容錯移轉＞。</span><span class="sxs-lookup"><span data-stu-id="c1577-175">For more information, see "Why Forced Failover is Required After Forcing Quorum" in [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
     <span data-ttu-id="c1577-176">如果 **is_failover_ready** = 1，資料庫在叢集中會標示為已同步處理，並且準備好進行容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="c1577-176">If **is_failover_ready** = 1, the database is marked as synchronized in the cluster and is ready for a failover.</span></span> <span data-ttu-id="c1577-177">如果在給定次要複本的每個資料庫上 **is_failover_ready** = 1，您可以執行強制容錯移轉 (FORCE_FAILOVER_ALLOW_DATA_LOSS)，而且這個次要複本的資料不會遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-177">If **is_failover_ready** = 1 on every database on a given secondary replica, you can perform a forced failover (FORCE_FAILOVER_ALLOW_DATA_LOSS) without data loss on this secondary replica.</span></span> <span data-ttu-id="c1577-178">同步處理的次要複本會在主要角色中變成線上，也就是成為新的主要複本，而且所有資料都保持不變。</span><span class="sxs-lookup"><span data-stu-id="c1577-178">The synchronized secondary replica comes online in the primary role, that is, as the new primary replica, with all the data intact.</span></span>  
  
     <span data-ttu-id="c1577-179">如果 **is_failover_ready** = 0，資料庫在叢集中不會標示為已同步處理，並且「尚未」  準備好進行規劃的手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="c1577-179">If **is_failover_ready** = 0, the database is not marked as synchronized in the cluster and is *not* ready for a planned manual failover.</span></span> <span data-ttu-id="c1577-180">如果您強制容錯移轉至主控次要複本，則這個資料庫中的資料將會遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-180">If you force failover to the host secondary replica, data will be lost on this database.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="c1577-181">當您強制容錯移轉至次要複本時，遺失的資料量將取決於容錯移轉目標落後於主要複本的距離。</span><span class="sxs-lookup"><span data-stu-id="c1577-181">When you force failover to a secondary replica, the amount of data loss will depend on how far the failover target is lagging behind the primary replica.</span></span> <span data-ttu-id="c1577-182">不幸的是，當 WSFC 叢集缺少仲裁或已強制仲裁時，您就無法評估可能遺失的資料量。</span><span class="sxs-lookup"><span data-stu-id="c1577-182">Unfortunately, when the WSFC cluster lacks quorum or quorum has been forced, you cannot assess the amount of potential data loss.</span></span> <span data-ttu-id="c1577-183">不過請注意，一旦 WSFC 叢集重新取得狀況良好的仲裁，您就可以開始追蹤可能的資料遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-183">Note, however, that once the WSFC cluster regains a healthy quorum, you could begin to track potential data loss.</span></span> <span data-ttu-id="c1577-184">如需詳細資訊，請參閱[容錯移轉及容錯移轉模式 &#40;AlwaysOn 可用性群組&#41;](failover-and-failover-modes-always-on-availability-groups.md) 中的＜追蹤可能的資料遺失＞。</span><span class="sxs-lookup"><span data-stu-id="c1577-184">For more information, see "Tracking Potential Data Loss" in [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
###  <a name="security"></a><a name="Security"></a> <span data-ttu-id="c1577-185">Security</span><span class="sxs-lookup"><span data-stu-id="c1577-185">Security</span></span>  
  
####  <a name="permissions"></a><a name="Permissions"></a> <span data-ttu-id="c1577-186">權限</span><span class="sxs-lookup"><span data-stu-id="c1577-186">Permissions</span></span>  
 <span data-ttu-id="c1577-187">需要可用性群組的 ALTER AVAILABILITY GROUP 權限、CONTROL AVAILABILITY GROUP 權限、ALTER ANY AVAILABILITY GROUP 權限或 CONTROL SERVER 權限。</span><span class="sxs-lookup"><span data-stu-id="c1577-187">Requires ALTER AVAILABILITY GROUP permission on the availability group, CONTROL AVAILABILITY GROUP permission, ALTER ANY AVAILABILITY GROUP permission, or CONTROL SERVER permission.</span></span>  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> <span data-ttu-id="c1577-188">使用 SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="c1577-188">Using SQL Server Management Studio</span></span>  
 <span data-ttu-id="c1577-189">**若要強制容錯移轉 (可能會遺失資料)**</span><span class="sxs-lookup"><span data-stu-id="c1577-189">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="c1577-190">在 [物件總管] 中，連接到裝載需要容錯移轉之可用性群組中，其角色為 SECONDARY 或 RESOLVING 狀態之複本的伺服器執行個體，然後展開伺服器樹狀目錄。</span><span class="sxs-lookup"><span data-stu-id="c1577-190">In Object Explorer, connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over, and expand the server tree.</span></span>  
  
2.  <span data-ttu-id="c1577-191">依序展開 **[AlwaysOn 高可用性]** 節點和 **[可用性群組]** 節點。</span><span class="sxs-lookup"><span data-stu-id="c1577-191">Expand the **AlwaysOn High Availability** node and the **Availability Groups** node.</span></span>  
  
3.  <span data-ttu-id="c1577-192">以滑鼠右鍵按一下要容錯移轉的可用性群組，然後選取 [容錯移轉]  命令。</span><span class="sxs-lookup"><span data-stu-id="c1577-192">Right-click the availability group to be failed over, and select the **Failover** command.</span></span>  
  
4.  <span data-ttu-id="c1577-193">這會啟動「容錯移轉可用性群組精靈」。</span><span class="sxs-lookup"><span data-stu-id="c1577-193">This launches the Failover Availability Group Wizard.</span></span> <span data-ttu-id="c1577-194">如需詳細資訊，請參閱[使用容錯移轉可用性群組精靈 &#40;SQL Server Management Studio&#41;](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md)。</span><span class="sxs-lookup"><span data-stu-id="c1577-194">For more information, see [Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md).</span></span>  
  
5.  <span data-ttu-id="c1577-195">強制可用性群組容錯移轉之後，完成必要的後續追蹤步驟。</span><span class="sxs-lookup"><span data-stu-id="c1577-195">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="c1577-196">如需詳細資訊，請參閱本主題稍後的[後續操作：強制容錯移轉後的重要工作](#FollowUp)。</span><span class="sxs-lookup"><span data-stu-id="c1577-196">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> <span data-ttu-id="c1577-197">使用 Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="c1577-197">Using Transact-SQL</span></span>  
 <span data-ttu-id="c1577-198">**若要強制容錯移轉 (可能會遺失資料)**</span><span class="sxs-lookup"><span data-stu-id="c1577-198">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="c1577-199">連線到裝載複本的伺服器執行個體，而在需要容錯移轉的可用性群組中，複本的角色為 SECONDARY 或 RESOLVING 狀態。</span><span class="sxs-lookup"><span data-stu-id="c1577-199">Connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over.</span></span>  
  
2.  <span data-ttu-id="c1577-200">使用 [ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) 陳述式，如下所示：</span><span class="sxs-lookup"><span data-stu-id="c1577-200">Use the [ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) statement, as follows:</span></span>  
  
     <span data-ttu-id="c1577-201">ALTER AVAILABILITY GROUP *group_name* FORCE_FAILOVER_ALLOW_DATA_LOSS</span><span class="sxs-lookup"><span data-stu-id="c1577-201">ALTER AVAILABILITY GROUP *group_name* FORCE_FAILOVER_ALLOW_DATA_LOSS</span></span>  
  
     <span data-ttu-id="c1577-202">其中 <群組名稱>  是可用性群組的名稱。</span><span class="sxs-lookup"><span data-stu-id="c1577-202">where *group_name* is the name of the availability group.</span></span>  
  
     <span data-ttu-id="c1577-203">下列範例會將 `AccountsAG` 可用性群組強制容錯移轉到本機次要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-203">The following example forces the `AccountsAG` availability group to fail over to the local secondary replica.</span></span>  
  
    ```sql
    ALTER AVAILABILITY GROUP AccountsAG FORCE_FAILOVER_ALLOW_DATA_LOSS;  
    ```  
  
3.  <span data-ttu-id="c1577-204">強制可用性群組容錯移轉之後，完成必要的後續追蹤步驟。</span><span class="sxs-lookup"><span data-stu-id="c1577-204">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="c1577-205">如需詳細資訊，請參閱本主題稍後的[後續操作：強制容錯移轉後的重要工作](#FollowUp)。</span><span class="sxs-lookup"><span data-stu-id="c1577-205">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> <span data-ttu-id="c1577-206">使用 PowerShell</span><span class="sxs-lookup"><span data-stu-id="c1577-206">Using PowerShell</span></span>  
 <span data-ttu-id="c1577-207">**若要強制容錯移轉 (可能會遺失資料)**</span><span class="sxs-lookup"><span data-stu-id="c1577-207">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="c1577-208">將目錄 (`cd`) 變更為裝載複本的伺服器實例，其角色在需要故障切換之可用性群組中的「次要」或「已解決」狀態。</span><span class="sxs-lookup"><span data-stu-id="c1577-208">Change directory (`cd`) to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over.</span></span>  
  
2.  <span data-ttu-id="c1577-209">以下列其中一種形式，搭配 `Switch-SqlAvailabilityGroup` 參數使用 `AllowDataLoss` 指令程式：</span><span class="sxs-lookup"><span data-stu-id="c1577-209">Use the `Switch-SqlAvailabilityGroup` cmdlet with the `AllowDataLoss` parameter in one of the following forms:</span></span>  
  
    -   `-AllowDataLoss`  
  
         <span data-ttu-id="c1577-210">根據預設，`-AllowDataLoss` 參數會使 `Switch-SqlAvailabilityGroup` 提示您提醒自己強制容錯移轉可能會導致遺失未認可交易以及要求確認。</span><span class="sxs-lookup"><span data-stu-id="c1577-210">By default `-AllowDataLoss` parameter causes `Switch-SqlAvailabilityGroup` to prompt you to remind you that forcing failover might result in the loss of uncommitted transactions and to request confirmation.</span></span> <span data-ttu-id="c1577-211">若要繼續，請輸入 `Y`；若要取消操作，請輸入 `N`。</span><span class="sxs-lookup"><span data-stu-id="c1577-211">To continue, enter `Y`; to cancel the operation, enter `N`.</span></span>  
  
         <span data-ttu-id="c1577-212">以下範例會針對名稱為 `MyAg` 之伺服器執行個體上的次要複本，執行可用性群組 `SecondaryServer\InstanceName`的強制容錯移轉 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="c1577-212">The following example performs a forced failover (with possible data loss) of the availability group `MyAg` to the secondary replica on the server instance named `SecondaryServer\InstanceName`.</span></span> <span data-ttu-id="c1577-213">您將會收到確認此作業的提示。</span><span class="sxs-lookup"><span data-stu-id="c1577-213">You will be prompted to confirm this operation.</span></span>  
  
        ```powershell
        Switch-SqlAvailabilityGroup -Path SQLSERVER:\Sql\SecondaryServer\InstanceName\AvailabilityGroups\MyAg -AllowDataLoss  
        ```  
  
    -   <span data-ttu-id="c1577-214">**-AllowDataLoss-Force**</span><span class="sxs-lookup"><span data-stu-id="c1577-214">**-AllowDataLoss-Force**</span></span>  
  
         <span data-ttu-id="c1577-215">若要在不確認的情況下起始強制容錯移轉，請同時指定 `-AllowDataLoss` 和 `-Force` 參數。</span><span class="sxs-lookup"><span data-stu-id="c1577-215">To initiate a forced failover without confirmation, specify both the `-AllowDataLoss` and `-Force` parameters.</span></span> <span data-ttu-id="c1577-216">如果您要在指令碼中加入命令，並在沒有使用者介入的情況之下執行它，這相當實用。</span><span class="sxs-lookup"><span data-stu-id="c1577-216">This is useful if you want to include the command in a script and run it without user interaction.</span></span>  <span data-ttu-id="c1577-217">不過，使用 `-Force` 選項時請小心，因為強制容錯移轉可能會導致資料從參與可用性群組的資料庫中遺失。</span><span class="sxs-lookup"><span data-stu-id="c1577-217">However, use the `-Force` option with caution, because a forced failover might result in the loss of data from databases participating the availability group.</span></span>  
  
         <span data-ttu-id="c1577-218">以下範例會針對名稱為 `MyAg` 的伺服器執行個體，執行可用性群組 `SecondaryServer\InstanceName`的強制容錯移轉 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="c1577-218">The following example performs a forced failover (with possible data loss) of the availability group `MyAg` to the server instance named `SecondaryServer\InstanceName`.</span></span> <span data-ttu-id="c1577-219"> 選項會隱藏此作業的確認。</span><span class="sxs-lookup"><span data-stu-id="c1577-219">The `-Force` option suppresses confirmation of this operation.</span></span>  
  
        ```powershell
        Switch-SqlAvailabilityGroup -Path SQLSERVER:\Sql\SecondaryServer\InstanceName\AvailabilityGroups\MyAg -AllowDataLoss -Force  
        ```  
  
    > [!NOTE]  
    >  <span data-ttu-id="c1577-220">若要檢視指令程式的語法，請在 `Get-Help` PowerShell 環境中使用 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 指令程式。</span><span class="sxs-lookup"><span data-stu-id="c1577-220">To view the syntax of a cmdlet, use the `Get-Help` cmdlet in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell environment.</span></span> <span data-ttu-id="c1577-221">如需詳細資訊，請參閱 [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md)。</span><span class="sxs-lookup"><span data-stu-id="c1577-221">For more information, see [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span></span>  
  
3.  <span data-ttu-id="c1577-222">強制可用性群組容錯移轉之後，完成必要的後續追蹤步驟。</span><span class="sxs-lookup"><span data-stu-id="c1577-222">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="c1577-223">如需詳細資訊，請參閱本主題稍後的[後續操作：強制容錯移轉後的重要工作](#FollowUp)。</span><span class="sxs-lookup"><span data-stu-id="c1577-223">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
 <span data-ttu-id="c1577-224">**若要設定和使用 SQL Server PowerShell 提供者**</span><span class="sxs-lookup"><span data-stu-id="c1577-224">**To set up and use the SQL Server PowerShell provider**</span></span>  
  
-   [<span data-ttu-id="c1577-225">SQL Server PowerShell 提供者</span><span class="sxs-lookup"><span data-stu-id="c1577-225">SQL Server PowerShell Provider</span></span>](../../../powershell/sql-server-powershell-provider.md)  
  
##  <a name="follow-up-essential-tasks-after-a-forced-failover"></a><a name="FollowUp"></a> <span data-ttu-id="c1577-226">後續操作：強制容錯移轉後的重要工作</span><span class="sxs-lookup"><span data-stu-id="c1577-226">Follow Up: Essential Tasks After a Forced Failover</span></span>  
  
1.  <span data-ttu-id="c1577-227">強制容錯移轉之後，您容錯移轉的目標次要複本會變成新的主要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-227">After a forced failover, the secondary replica to which you failed over becomes the new primary replica.</span></span> <span data-ttu-id="c1577-228">不過，若要讓該可用性複本可供用戶端存取，您可能需要重新設定 WSFC 仲裁，或調整可用性群組的可用性模式組態，如下所示：</span><span class="sxs-lookup"><span data-stu-id="c1577-228">However, to make that availability replica accessible to clients, you might need to reconfigure the WSFC quorum or adjust the availability-mode configuration of the availability group, as follows:</span></span>  
  
    -   <span data-ttu-id="c1577-229">**如果您容錯移轉到 [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] 外部：** 調整 WSFC 節點的仲裁投票，以反映您的新可用性群組設定。</span><span class="sxs-lookup"><span data-stu-id="c1577-229">**If you failed over outside of the [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)]:**  Adjust the quorum votes of the WSFC nodes to reflect your new availability group configuration.</span></span> <span data-ttu-id="c1577-230">如果裝置目標次要複本的 WSFC 節點沒有 WSFC 仲裁投票，可能需要強制 WSFC 仲裁。</span><span class="sxs-lookup"><span data-stu-id="c1577-230">If the WSFC node that hosts the target secondary replica does not have a WSFC quorum vote, you might need to force WSFC quorum.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="c1577-231">只有在使用自動容錯移轉將兩個可用性複本 (包括先前的主要複本) 設定成同步認可模式時， [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] 才會存在。</span><span class="sxs-lookup"><span data-stu-id="c1577-231">An [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] exists only if two availability replicas (including the previous primary replica) are configured for synchronous-commit mode with automatic failover.</span></span>  
  
         <span data-ttu-id="c1577-232">**若要調整仲裁投票**</span><span class="sxs-lookup"><span data-stu-id="c1577-232">**To adjust quorum votes**</span></span>  
  
        -   [<span data-ttu-id="c1577-233">檢視叢集仲裁 NodeWeight 設定</span><span class="sxs-lookup"><span data-stu-id="c1577-233">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
        -   [<span data-ttu-id="c1577-234">設定叢集仲裁 NodeWeight 設定</span><span class="sxs-lookup"><span data-stu-id="c1577-234">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
        -   [<span data-ttu-id="c1577-235">在無仲裁情況下強制啟動 WSFC 叢集</span><span class="sxs-lookup"><span data-stu-id="c1577-235">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
    -   <span data-ttu-id="c1577-236">**如果您容錯移轉到 [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] 外部：** 建議您考慮針對新主要複本和剩餘的次要複本調整可用性模式與容錯移轉模式，以反映您需要的同步認可及自動容錯移轉設定。</span><span class="sxs-lookup"><span data-stu-id="c1577-236">**If you failed over outside of the [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)]:** We recommend that you consider adjusting the availability mode and failover mode on the new primary replica and on remaining secondary replicas to reflect your desired synchronous-commit and automatic failover configuration.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="c1577-237">只有在目前的主要複本設定成同步認可模式， [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] 才會存在。</span><span class="sxs-lookup"><span data-stu-id="c1577-237">A [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] exists only if the current primary replica is configured for synchronous-commit mode.</span></span>  
  
         <span data-ttu-id="c1577-238">**若要變更可用性模式與容錯移轉模式**</span><span class="sxs-lookup"><span data-stu-id="c1577-238">**To change the availability mode and failover mode**</span></span>  
  
        -   [<span data-ttu-id="c1577-239">變更可用性複本的可用性模式 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-239">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)  
  
        -   [<span data-ttu-id="c1577-240">變更可用性複本的容錯移轉模式 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-240">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
2.  <span data-ttu-id="c1577-241">強制容錯移轉之後，就會暫停所有次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="c1577-241">After a forced failover, all secondary databases are suspended.</span></span> <span data-ttu-id="c1577-242">這包括舊的主要資料庫，在舊的主要複本再次上線之後會發現它現在是次要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-242">This includes the former primary databases, after the former primary replica comes back online and discovers that it is now a secondary replica.</span></span> <span data-ttu-id="c1577-243">您必須以手動方式在每個次要複本上個別繼續每個暫停的資料庫。</span><span class="sxs-lookup"><span data-stu-id="c1577-243">You must manually resume each suspended database individually on each secondary replica.</span></span>  
  
     <span data-ttu-id="c1577-244">次要資料庫繼續時，會起始與對應主要資料庫的資料同步處理。</span><span class="sxs-lookup"><span data-stu-id="c1577-244">When a secondary database is resumed, it initiates data synchronization with the corresponding primary database.</span></span> <span data-ttu-id="c1577-245">次要資料庫會回復新的主要資料庫上從未認可過的任何記錄檔記錄。因此，如果您擔心容錯移轉後的主要資料庫可能會發生遺失資料，則應該嘗試在其中一個同步認可的次要資料庫上，對暫停的資料庫建立資料庫快照集。</span><span class="sxs-lookup"><span data-stu-id="c1577-245">The secondary database rolls back any log records that were never committed on the new primary database.Therefore, if you are concerned about possible data loss on the post-failover primary databases, you should attempt to create a database snapshot on the suspended databases on one of the synchronous-commit secondary databases.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="c1577-246">只要有任何次要資料庫暫停，主要資料庫上的交易記錄截斷就會延遲。</span><span class="sxs-lookup"><span data-stu-id="c1577-246">Transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="c1577-247">另外，只要任何本機資料庫持續暫停狀態，同步認可次要複本的同步健全狀態就無法轉換成 HEALTHY。</span><span class="sxs-lookup"><span data-stu-id="c1577-247">Also the synchronization health of a synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>  
  
     <span data-ttu-id="c1577-248">**若要建立資料庫快照集**</span><span class="sxs-lookup"><span data-stu-id="c1577-248">**To create a database snapshot**</span></span>  
  
    -   [<span data-ttu-id="c1577-249">建立資料庫快照集 &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-249">Create a Database Snapshot &#40;Transact-SQL&#41;</span></span>](../../../relational-databases/databases/create-a-database-snapshot-transact-sql.md)  
  
     <span data-ttu-id="c1577-250">**若要繼續可用性資料庫**</span><span class="sxs-lookup"><span data-stu-id="c1577-250">**To resume an availability database**</span></span>  
  
    -   [<span data-ttu-id="c1577-251">繼續可用性資料庫 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-251">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)  
  
    > [!CAUTION]  
    >  <span data-ttu-id="c1577-252">繼續所有次要資料庫之後，請等待下一個容錯移轉目標上的每個次要資料庫進入 SYNCHRONIZING 狀態，然後再嘗試容錯移轉群組。</span><span class="sxs-lookup"><span data-stu-id="c1577-252">After resuming all the secondary databases, before attempting to fail over the group again, wait for every secondary database on the next failover target to enter the SYNCHRONIZING state.</span></span> <span data-ttu-id="c1577-253">如果有任何資料庫還未 SYNCHRONIZING，該資料庫將無法跟主要資料庫一樣上線，而且重新建立資料庫的資料同步處理可能需要還原交易記錄、還原完整的資料庫備份，或容錯移轉回先前的主要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-253">If any database is not yet SYNCHRONIZING, that database will be prevented from coming online as a primary database, and re-establishing data synchronization for the database might require restoring transaction logs, restoring a full database backup, or failing over back to the previous primary replica.</span></span>  
  
3.  <span data-ttu-id="c1577-254">如果失敗的可用性複本無法返回可用性複本，或是太晚返回，讓您無法延遲新主要資料庫上的交易記錄截斷，請考慮從可用性群組移除失敗的複本，以避免記錄檔的磁碟空間用盡。</span><span class="sxs-lookup"><span data-stu-id="c1577-254">If an availability replica that failed will not be returning to the availability replica or will return too late for you to delay transaction log truncation on the new primary database, consider removing the failed replica from the availability group to avoid running out of disk space for your log files.</span></span>  
  
     <span data-ttu-id="c1577-255">**若要移除次要複本**</span><span class="sxs-lookup"><span data-stu-id="c1577-255">**To remove a secondary replica**</span></span>  
  
    -   [<span data-ttu-id="c1577-256">將次要複本從可用性群組移除 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-256">Remove a Secondary Replica from an Availability Group &#40;SQL Server&#41;</span></span>](remove-a-secondary-replica-from-an-availability-group-sql-server.md)  
  
4.  <span data-ttu-id="c1577-257">如果您在強制容錯移轉之後進行一個或多個額外的強制容錯移轉，請在此系列中每一個額外的強制容錯移轉之後執行記錄備份。</span><span class="sxs-lookup"><span data-stu-id="c1577-257">If you follow a forced failover with one or more additional forced failovers, perform a log backup after each additional forced failover in the series.</span></span> <span data-ttu-id="c1577-258">如需此作業原因的相關資訊，請參閱[容錯移轉及容錯移轉模式&#40;AlwaysOn 可用性群組&#41;](failover-and-failover-modes-always-on-availability-groups.md) 中＜強制手動容錯移轉 (可能會遺失資料)＞一節中的＜強制容錯移轉的風險＞。</span><span class="sxs-lookup"><span data-stu-id="c1577-258">For information about the reason for this, see "Risks of Forcing Failover" in the "Forced Manual Failover (with Possible Data Loss)" section of [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
     <span data-ttu-id="c1577-259">**若要執行記錄備份**</span><span class="sxs-lookup"><span data-stu-id="c1577-259">**To perform a log backup**</span></span>  
  
    -   [<span data-ttu-id="c1577-260">備份交易記錄 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-260">Back Up a Transaction Log &#40;SQL Server&#41;</span></span>](../../../relational-databases/backup-restore/back-up-a-transaction-log-sql-server.md)  
  
##  <a name="example-scenario-using-a-forced-failover-to-recover-from-a-catastrophic-failure"></a><a name="ExampleRecoveryFromCatastrophy"></a> <span data-ttu-id="c1577-261">範例案例：使用強制容錯移轉從重大錯誤復原</span><span class="sxs-lookup"><span data-stu-id="c1577-261">Example Scenario: Using a Forced Failover to Recover from a Catastrophic Failure</span></span>  
 <span data-ttu-id="c1577-262">如果主要複本失敗且沒有可用的已同步次要複本，則強制可用性群組進行容錯移轉可能會是適當的反應。</span><span class="sxs-lookup"><span data-stu-id="c1577-262">If the primary replica fails and no synchronized secondary replica is available, forcing the availability group to fail over might be an appropriate response.</span></span> <span data-ttu-id="c1577-263">強制容錯移轉是否恰當取決於：(1) 您是否預期主要複本離線的時間超過服務等級合約 (SLA) 容忍範圍，以及 (2) 您是否願意承擔資料可能遺失的風險，而讓主要資料庫盡快恢復可用。</span><span class="sxs-lookup"><span data-stu-id="c1577-263">The appropriateness of forcing a failover depends on: (1) whether you expect the primary replica to be offline for longer than your service level agreement (SLA) tolerates, and (2) whether you are willing to risk potential data loss in order to make primary databases available quickly.</span></span> <span data-ttu-id="c1577-264">如果您決定可用性群組需要強制容錯移轉，實際的強制容錯移轉只不過是多步驟程序中的一個步驟。</span><span class="sxs-lookup"><span data-stu-id="c1577-264">If you decide that an availability group requires a forced failover, the actual forced failover is but one step of a multi-step process.</span></span>  
  
 <span data-ttu-id="c1577-265">為了說明使用強制容錯移轉從重大錯誤復原所需的步驟，本主題會介紹一個可能的災害復原案例。</span><span class="sxs-lookup"><span data-stu-id="c1577-265">To illustrate the steps that are required to use a forced failover to recover from a catastrophic failure, this topic presents one possible disaster recovery scenario.</span></span> <span data-ttu-id="c1577-266">範例案例會考慮原始拓撲是由主控三個同步認可可用性複本 (包括主要複本) 的主要資料中心，以及主控兩個非同步認可次要複本的遠端資料中心所組成的可用性群組。</span><span class="sxs-lookup"><span data-stu-id="c1577-266">The example scenario considers an availability group whose original topology consists of a main data center that hosts three synchronous-commit availability replicas, including the primary replica, and a remote data center that hosts two asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="c1577-267">下圖說明此範例可用性群組的原始拓撲。</span><span class="sxs-lookup"><span data-stu-id="c1577-267">The following figure illustrates the original topology of this example availability group.</span></span> <span data-ttu-id="c1577-268">可用性群組是由多重子網路 WSFC 叢集所主控，其中三個節點位於主要資料中心 (**節點 01**、 **節點 02**和 **節點 03**)，兩個位於遠端資料中心 (**節點 04** 和 **節點 05**)。</span><span class="sxs-lookup"><span data-stu-id="c1577-268">The availability group is hosted by a multi-subnet WSFC cluster with three nodes in the main data center (**Node 01**, **Node 02**, and **Node 03**) and two nodes in a remote data center (**Node 04** and **Node 05**).</span></span>  
  
 <span data-ttu-id="c1577-269">![可用性群組的原始拓撲](../../media/aoag-failurerecovery-origtopology.gif "可用性群組的原始拓撲")</span><span class="sxs-lookup"><span data-stu-id="c1577-269">![Original topology of availability group](../../media/aoag-failurerecovery-origtopology.gif "Original topology of availability group")</span></span>  
  
 <span data-ttu-id="c1577-270">主要資料中心意外關閉。</span><span class="sxs-lookup"><span data-stu-id="c1577-270">The main data center shuts down unexpectedly.</span></span> <span data-ttu-id="c1577-271">其三個可用性複本離線，而且其資料庫變成不可用。</span><span class="sxs-lookup"><span data-stu-id="c1577-271">Its three availability replicas to go offline, and their databases become unavailable.</span></span> <span data-ttu-id="c1577-272">下圖說明此錯誤對可用性群組拓撲的影響。</span><span class="sxs-lookup"><span data-stu-id="c1577-272">The following figure illustrates the impact of this failure on the topology of the availability group.</span></span>  
  
 <span data-ttu-id="c1577-273">![主要資料中心失敗之後的拓撲](../../media/aoag-failurerecovery-catastrophy.gif "主要資料中心失敗之後的拓撲")</span><span class="sxs-lookup"><span data-stu-id="c1577-273">![Topology after failure of main data center](../../media/aoag-failurerecovery-catastrophy.gif "Topology after failure of main data center")</span></span>  
  
 <span data-ttu-id="c1577-274">資料庫管理員 (DBA) 判斷可能的最佳回應是強制可用性群組容錯移轉至其中一個遠端非同步認可次要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-274">The database administrator (DBA) determines that the best possible response is to force failover of the availability group to one of the remote, asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="c1577-275">此範例說明強制可用性群組容錯移轉至遠端複本，以及最後恢復可用性群組的原始拓撲所包含的一般步驟。</span><span class="sxs-lookup"><span data-stu-id="c1577-275">This example illustrates the typical steps involved when you force failover of the availability group to a remote replica and, eventually, return the availability group to its original topology.</span></span>  
  
  
###  <a name="responding-to-the-catastrophic-failure-of-the-main-data-center"></a><a name="FailureResponse"></a> <span data-ttu-id="c1577-276">Responding to the Catastrophic Failure of the Main Data Center</span><span class="sxs-lookup"><span data-stu-id="c1577-276">Responding to the Catastrophic Failure of the Main Data Center</span></span>  
 <span data-ttu-id="c1577-277">下圖說明為了回應主要資料中心的重大錯誤，在遠端資料中心執行的一系列動作。</span><span class="sxs-lookup"><span data-stu-id="c1577-277">The following figure illustrates the series of actions performed at the remote data center in response a catastrophic failure at the main data center.</span></span>  
  
 <span data-ttu-id="c1577-278">![回應主要資料中心失敗的步驟](../../media/aoag-failurerecovery-actions-part1.gif "回應主要資料中心失敗的步驟")</span><span class="sxs-lookup"><span data-stu-id="c1577-278">![Steps for responding to failure of main data cente](../../media/aoag-failurerecovery-actions-part1.gif "Steps for responding to failure of main data cente")</span></span>  
  
 <span data-ttu-id="c1577-279">此圖中的步驟會指出下列步驟：</span><span class="sxs-lookup"><span data-stu-id="c1577-279">The steps in this figure indicate the following steps:</span></span>  
  
|<span data-ttu-id="c1577-280">步驟</span><span class="sxs-lookup"><span data-stu-id="c1577-280">Step</span></span>|<span data-ttu-id="c1577-281">動作</span><span class="sxs-lookup"><span data-stu-id="c1577-281">Action</span></span>|<span data-ttu-id="c1577-282">連結</span><span class="sxs-lookup"><span data-stu-id="c1577-282">Links</span></span>|  
|----------|------------|-----------|  
|<span data-ttu-id="c1577-283">**1.**</span><span class="sxs-lookup"><span data-stu-id="c1577-283">**1.**</span></span>|<span data-ttu-id="c1577-284">DBA 或網路管理員確認 WSFC 叢集擁有狀況良好的仲裁。</span><span class="sxs-lookup"><span data-stu-id="c1577-284">The DBA or network administrator ensures that the WSFC cluster has a healthy quorum.</span></span> <span data-ttu-id="c1577-285">在此範例中，需要強制仲裁。</span><span class="sxs-lookup"><span data-stu-id="c1577-285">In this example, quorum needs to be forced.</span></span>|[<span data-ttu-id="c1577-286">WSFC 仲裁模式和投票組態 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-286">WSFC Quorum Modes and Voting Configuration &#40;SQL Server&#41;</span></span>](../../../sql-server/failover-clusters/windows/wsfc-quorum-modes-and-voting-configuration-sql-server.md)<br /><br /> [<span data-ttu-id="c1577-287">透過強制仲裁執行 WSFC 災害復原 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-287">WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;</span></span>](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)|  
|<span data-ttu-id="c1577-288">**2.**</span><span class="sxs-lookup"><span data-stu-id="c1577-288">**2.**</span></span>|<span data-ttu-id="c1577-289">DBA 連接到延遲最少的伺服器執行個體，(在 **節點 04**上)，並執行強制手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="c1577-289">The DBA connects to the server instance with the least latency (on **Node 04**) and performs a forced manual failover.</span></span> <span data-ttu-id="c1577-290">強制容錯移轉會將此次要複本轉換成主要角色，並且暫停其餘次要複本上的次要資料庫 (在 **節點 05**上)。</span><span class="sxs-lookup"><span data-stu-id="c1577-290">The forced failover transitions this secondary replica to the primary role and suspends the secondary databases on the remaining secondary replica (on **Node 05**).</span></span>|<span data-ttu-id="c1577-291">[sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) (查詢 **end_of_log_lsn** 資料行。</span><span class="sxs-lookup"><span data-stu-id="c1577-291">[sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) (Query the **end_of_log_lsn** column.</span></span> <span data-ttu-id="c1577-292">如需詳細資訊，請參閱本主題前面的 [建議](#Recommendations))。</span><span class="sxs-lookup"><span data-stu-id="c1577-292">For more information, see [Recommendations](#Recommendations), earlier in this topic.)</span></span>|  
|<span data-ttu-id="c1577-293">**3.**</span><span class="sxs-lookup"><span data-stu-id="c1577-293">**3.**</span></span>|<span data-ttu-id="c1577-294">DBA 手動繼續其餘次要複本上的每個次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="c1577-294">The DBA manually resumes each of the secondary databases on the remaining secondary replica.</span></span>|[<span data-ttu-id="c1577-295">繼續可用性資料庫 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-295">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)|  
  
###  <a name="returning-the-availability-group-to-its-original-topology"></a><a name="ReturnToOrigTopology"></a> <span data-ttu-id="c1577-296">讓可用性群組恢復其原始拓撲</span><span class="sxs-lookup"><span data-stu-id="c1577-296">Returning the Availability Group to its Original Topology</span></span>  
 <span data-ttu-id="c1577-297">下圖說明主要資料中心再次上線且 WSFC 節點重新建立與 WSFC 叢集的通訊之後，將可用性群組恢復為原始拓撲的一系列動作。</span><span class="sxs-lookup"><span data-stu-id="c1577-297">The following figure illustrates the series of actions that return the availability group to its original topology after the main data center comes back online and the WSFC nodes re-establish communication with the WSFC cluster.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c1577-298">如果已強制執行 WSFC 叢集仲裁，那麼如果下列兩項條件都存在時，離線節點可能會在重新啟動時形成新的仲裁：(a) 強制仲裁集中任何節點之間都沒有網路連線，且 (b) 重新啟動節點佔叢集節點的大多數。</span><span class="sxs-lookup"><span data-stu-id="c1577-298">If the WSFC cluster quorum has been forced, as the offline nodes restart they could form a new quorum if the following conditions both exist: (a) there is no network connectivity between any of the nodes in the forced-quorum set, and (b) the restarting nodes are the majority of the cluster nodes.</span></span> <span data-ttu-id="c1577-299">這樣會導致「核心分裂」的情況，這種情況下可用性群組會擁有兩個獨立的主要複本，每個資料中心各擁有一個。</span><span class="sxs-lookup"><span data-stu-id="c1577-299">This would result in a "split brain" condition in which the availability group would possess two independent primary replicas, one at each data center.</span></span> <span data-ttu-id="c1577-300">在強制仲裁建立少數仲裁集之前，請參閱 [透過強制仲裁執行 WSFC 災害復原 &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)中的 PowerShell，在 AlwaysOn 可用性群組上執行強制容錯移轉 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="c1577-300">Before forcing quorum to create a minority quorum set, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span>  
  
 <span data-ttu-id="c1577-301">![將群組傳回至其原始拓撲的步驟](../../media/aoag-failurerecovery-actions-part2.gif "將群組傳回至其原始拓撲的步驟")</span><span class="sxs-lookup"><span data-stu-id="c1577-301">![Steps to return the group to its original topology](../../media/aoag-failurerecovery-actions-part2.gif "Steps to return the group to its original topology")</span></span>  
  
 <span data-ttu-id="c1577-302">此圖中的步驟會指出下列步驟：</span><span class="sxs-lookup"><span data-stu-id="c1577-302">The steps in this figure indicate the following steps:</span></span>  
  
||<span data-ttu-id="c1577-303">步驟</span><span class="sxs-lookup"><span data-stu-id="c1577-303">Step</span></span>|<span data-ttu-id="c1577-304">連結</span><span class="sxs-lookup"><span data-stu-id="c1577-304">Links</span></span>|  
|-|----------|-----------|  
|<span data-ttu-id="c1577-305">**1.**</span><span class="sxs-lookup"><span data-stu-id="c1577-305">**1.**</span></span>|<span data-ttu-id="c1577-306">主要資料中心的節點再次上線，並且重新建立與 WSFC 叢集之間的通訊。</span><span class="sxs-lookup"><span data-stu-id="c1577-306">The nodes in the main data center come back online and re-establish communication with the WSFC cluster.</span></span> <span data-ttu-id="c1577-307">其可用性複本會做為含有暫停資料庫的次要複本重新上線，而 DBA 將需要盡快手動繼續每個資料庫。</span><span class="sxs-lookup"><span data-stu-id="c1577-307">Their availability replicas come online as secondary replicas with suspended databases, and the DBA will need to manually resume each of these databases soon.</span></span>|[<span data-ttu-id="c1577-308">繼續可用性資料庫 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-308">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)<br /><br /> <span data-ttu-id="c1577-309">提示：如果您擔心容錯移轉後的主要資料庫可能會遺失資料，就應該嘗試在其中一個同步認可的次要資料庫上，建立暫停資料庫的資料庫快照集。</span><span class="sxs-lookup"><span data-stu-id="c1577-309">Tip: If you are concerned about possible data loss on the post-failover primary databases, you should attempt to create a database snapshot on the suspended databases on one the synchronous-commit secondary database.</span></span> <span data-ttu-id="c1577-310">務必記得，只要有任何次要資料庫暫停，主要資料庫上的交易記錄截斷就會延遲。</span><span class="sxs-lookup"><span data-stu-id="c1577-310">Keep in mind that the transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="c1577-311">另外，只要任何本機資料庫持續暫停狀態，同步認可次要複本的同步健全狀態就無法轉換成 HEALTHY。</span><span class="sxs-lookup"><span data-stu-id="c1577-311">Also the synchronization health of the synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>|  
|<span data-ttu-id="c1577-312">**2.**</span><span class="sxs-lookup"><span data-stu-id="c1577-312">**2.**</span></span>|<span data-ttu-id="c1577-313">資料庫繼續之後，DBA 會暫時將新的主要複本變更為同步認可模式。</span><span class="sxs-lookup"><span data-stu-id="c1577-313">Once the databases are resumed, the DBA changes the new primary replica to synchronous-commit mode temporarily.</span></span> <span data-ttu-id="c1577-314">這包含兩個步驟：</span><span class="sxs-lookup"><span data-stu-id="c1577-314">This involves two steps:</span></span><br /><br /> <span data-ttu-id="c1577-315">1) 將一個離線可用性複本變更為非同步認可模式。</span><span class="sxs-lookup"><span data-stu-id="c1577-315">1) Change one offline availability replica to asynchronous-commit mode.</span></span> <br /><span data-ttu-id="c1577-316">2) 將新的主要複本變更為同步認可的模式。</span><span class="sxs-lookup"><span data-stu-id="c1577-316">2) Change the new primary replica to synchronous-commit mode.</span></span><br /><span data-ttu-id="c1577-317">注意:此步驟可讓繼續的同步認可次要資料庫變成 SYNCHRONIZED。</span><span class="sxs-lookup"><span data-stu-id="c1577-317">Note: This step enables resumed synchronous-commit secondary databases to become SYNCHRONIZED.</span></span>|[<span data-ttu-id="c1577-318">變更可用性複本的可用性模式 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-318">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)|  
|<span data-ttu-id="c1577-319">**3.**</span><span class="sxs-lookup"><span data-stu-id="c1577-319">**3.**</span></span>|<span data-ttu-id="c1577-320">一旦 **節點 03** (原始主要複本) 上的同步認可次要複本進入 HEALTHY 同步狀態，DBA 就會對該複本執行規劃的手動容錯移轉，使其再次成為主要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-320">Once the synchronous-commit secondary replica on **Node 03** (the original primary replica) enters the HEALTHY synchronization state, the DBA performs a planned manual failover to that replica, to make it the primary replica again.</span></span> <span data-ttu-id="c1577-321">**節點 04** 上的複本會恢復為次要複本。</span><span class="sxs-lookup"><span data-stu-id="c1577-321">The replica on **Node 04** returns to being a secondary replica.</span></span>|[<span data-ttu-id="c1577-322">sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-322">sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql)<br /><br /> [<span data-ttu-id="c1577-323">使用 AlwaysOn 原則來查看可用性群組的健全狀況 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-323">Use AlwaysOn Policies to View the Health of an Availability Group &#40;SQL Server&#41;</span></span>](use-always-on-policies-to-view-the-health-of-an-availability-group-sql-server.md)<br /><br /> [<span data-ttu-id="c1577-324">執行可用性群組的已規劃手動容錯移轉 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-324">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)|  
|<span data-ttu-id="c1577-325">**4.**</span><span class="sxs-lookup"><span data-stu-id="c1577-325">**4.**</span></span>|<span data-ttu-id="c1577-326">DBA 連接到新的主要複本，並且：</span><span class="sxs-lookup"><span data-stu-id="c1577-326">The DBA connects to the new primary replica and:</span></span><br /><br /> <span data-ttu-id="c1577-327">1) 將舊的主要複本 (位於遠端中心) 變更回非同步認可模式。</span><span class="sxs-lookup"><span data-stu-id="c1577-327">1) Changes the former primary replica (in the remote center) back to asynchronous-commit mode.</span></span><br /><span data-ttu-id="c1577-328">2) 將主要資料中心中的非同步認可次要複本變更回同步認可模式。</span><span class="sxs-lookup"><span data-stu-id="c1577-328">2) Changes the asynchronous-commit secondary replica in the main data center back to synchronous-commit mode.</span></span>|[<span data-ttu-id="c1577-329">變更可用性複本的可用性模式 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-329">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)|  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="c1577-330">相關工作</span><span class="sxs-lookup"><span data-stu-id="c1577-330">Related Tasks</span></span>  
 <span data-ttu-id="c1577-331">**若要調整仲裁投票**</span><span class="sxs-lookup"><span data-stu-id="c1577-331">**To adjust quorum votes**</span></span>  
  
-   [<span data-ttu-id="c1577-332">檢視叢集仲裁 NodeWeight 設定</span><span class="sxs-lookup"><span data-stu-id="c1577-332">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="c1577-333">設定叢集仲裁 NodeWeight 設定</span><span class="sxs-lookup"><span data-stu-id="c1577-333">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="c1577-334">在無仲裁情況下強制啟動 WSFC 叢集</span><span class="sxs-lookup"><span data-stu-id="c1577-334">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
 <span data-ttu-id="c1577-335">**已規劃的手動容錯移轉：**</span><span class="sxs-lookup"><span data-stu-id="c1577-335">**Planned manual failover:**</span></span>  
  
-   [<span data-ttu-id="c1577-336">執行可用性群組的已規劃手動容錯移轉 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-336">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)  
  
-   [<span data-ttu-id="c1577-337">使用容錯移轉可用性群組精靈 &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-337">Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;</span></span>](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md)  
  
 <span data-ttu-id="c1577-338">**若要疑難排解：**</span><span class="sxs-lookup"><span data-stu-id="c1577-338">**To troubleshoot:**</span></span>  
  
-   [<span data-ttu-id="c1577-339">針對 AlwaysOn 可用性群組 Configuration &#40;SQL Server&#41;進行疑難排解</span><span class="sxs-lookup"><span data-stu-id="c1577-339">Troubleshoot AlwaysOn Availability Groups Configuration &#40;SQL Server&#41;</span></span>](troubleshoot-always-on-availability-groups-configuration-sql-server.md) 
  
-   [<span data-ttu-id="c1577-340">針對失敗的新增檔案作業進行疑難排解 &#40;AlwaysOn 可用性群組&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-340">Troubleshoot a Failed Add-File Operation &#40;AlwaysOn Availability Groups&#41;</span></span>](troubleshoot-a-failed-add-file-operation-always-on-availability-groups.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="c1577-341">相關內容</span><span class="sxs-lookup"><span data-stu-id="c1577-341">Related Content</span></span>  
  
-   <span data-ttu-id="c1577-342">**部落格：**</span><span class="sxs-lookup"><span data-stu-id="c1577-342">**Blogs:**</span></span>  
  
     [<span data-ttu-id="c1577-343">SQL Server AlwaysOn 團隊部落格：官方 SQL Server AlwaysOn 團隊部落格</span><span class="sxs-lookup"><span data-stu-id="c1577-343">SQL Server AlwaysOn Team Blogs: The official SQL Server AlwaysOn Team Blog</span></span>](https://blogs.msdn.com/b/sqlalwayson/)  
  
     [<span data-ttu-id="c1577-344">CSS SQL Server 工程師部落格</span><span class="sxs-lookup"><span data-stu-id="c1577-344">CSS SQL Server Engineers Blogs</span></span>](https://blogs.msdn.com/b/psssql/)  
  
-   <span data-ttu-id="c1577-345">**白皮書：**</span><span class="sxs-lookup"><span data-stu-id="c1577-345">**Whitepapers:**</span></span>  
  
     [<span data-ttu-id="c1577-346">Microsoft SQL Server AlwaysOn 高可用性和災害復原方案指南</span><span class="sxs-lookup"><span data-stu-id="c1577-346">Microsoft SQL Server AlwaysOn Solutions Guide for High Availability and Disaster Recovery</span></span>](https://go.microsoft.com/fwlink/?LinkId=227600)  
  
     [<span data-ttu-id="c1577-347">Microsoft 的 SQL Server 2012 白皮書</span><span class="sxs-lookup"><span data-stu-id="c1577-347">Microsoft White Papers for SQL Server 2012</span></span>](https://msdn.microsoft.com/library/hh403491.aspx)  
  
     [<span data-ttu-id="c1577-348">SQL Server 客戶諮詢團隊白皮書</span><span class="sxs-lookup"><span data-stu-id="c1577-348">SQL Server Customer Advisory Team Whitepapers</span></span>](http://sqlcat.com/)  
  
## <a name="see-also"></a><span data-ttu-id="c1577-349">另請參閱</span><span class="sxs-lookup"><span data-stu-id="c1577-349">See Also</span></span>  
 <span data-ttu-id="c1577-350">[AlwaysOn 可用性群組 &#40;SQL Server 的總覽&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c1577-350">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="c1577-351">[可用性模式 &#40;AlwaysOn 可用性群組&#41;](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="c1577-351">[Availability Modes &#40;AlwaysOn Availability Groups&#41;](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="c1577-352">[容錯移轉和容錯移轉模式 &#40;AlwaysOn 可用性群組&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="c1577-352">[Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="c1577-353">[關於可用性複本的用戶端連線存取 &#40;SQL Server&#41;](about-client-connection-access-to-availability-replicas-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c1577-353">[About Client Connection Access to Availability Replicas &#40;SQL Server&#41;](about-client-connection-access-to-availability-replicas-sql-server.md) </span></span>  
 <span data-ttu-id="c1577-354">[監視可用性群組 &#40;SQL Server&#41;](monitoring-of-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c1577-354">[Monitoring of Availability Groups &#40;SQL Server&#41;](monitoring-of-availability-groups-sql-server.md) </span></span>  
 [<span data-ttu-id="c1577-355">SQL Server 的 Windows Server 容錯移轉叢集 &#40;WSFC&#41;</span><span class="sxs-lookup"><span data-stu-id="c1577-355">Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server</span></span>](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md)  
  
  
