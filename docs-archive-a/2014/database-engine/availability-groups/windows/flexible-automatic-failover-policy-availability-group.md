---
title: 可用性群組自動容錯移轉的彈性容錯移轉原則 (SQL Server) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], flexible failover policy
- Availability Groups [SQL Server], failover
- flexible failover policy
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 8c504c7f-5c1d-4124-b697-f735ef0084f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: cd4dd62d8b30e2041415e0b9be5682ce4b01d1f6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87595276"
---
# <a name="flexible-failover-policy-for-automatic-failover-of-an-availability-group-sql-server"></a><span data-ttu-id="9427e-102">可用性群組自動容錯移轉的彈性容錯移轉原則 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="9427e-102">Flexible Failover Policy for Automatic Failover of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="9427e-103">彈性容錯移轉原則可讓您更精確地控制造成可用性群組之[自動容錯移轉](failover-and-failover-modes-always-on-availability-groups.md)的狀況。</span><span class="sxs-lookup"><span data-stu-id="9427e-103">A flexible failover policy provides granular control over the conditions that cause [automatic failover](failover-and-failover-modes-always-on-availability-groups.md) for an availability group.</span></span> <span data-ttu-id="9427e-104">透過變更觸發自動容錯移轉的失敗狀況和健全狀況檢查的頻率，您可以提高或降低自動容錯移轉的可能性，以便支援高可用性的 SLA。</span><span class="sxs-lookup"><span data-stu-id="9427e-104">By changing the failure conditions that trigger an automatic failover and the frequency of health checks, you can increase or decrease the likelihood of an automatic failover to support your SLA for high availability.</span></span>  
  
 <span data-ttu-id="9427e-105">可用性群組的彈性容錯移轉原則是由其失敗狀況層級和健全狀況檢查逾時臨界值所定義。</span><span class="sxs-lookup"><span data-stu-id="9427e-105">The flexible failover policy of an availability group is defined by its failure-condition level and health-check timeout threshold.</span></span> <span data-ttu-id="9427e-106">一旦偵測到可用性群組超過其失敗狀況層級或健全狀況檢查逾時臨界值時，可用性群組的資源 DLL 就會回應至 Windows Server 容錯移轉叢集 (WSFC) 叢集。</span><span class="sxs-lookup"><span data-stu-id="9427e-106">On detecting that an availability group has exceeded its failure condition level or its health-check timeout threshold, the availability group's resource DLL responds back to the Windows Server Failover Clustering (WSFC) cluster.</span></span> <span data-ttu-id="9427e-107">然後，WSFC 叢集就會起始自動容錯移轉至次要複本。</span><span class="sxs-lookup"><span data-stu-id="9427e-107">The WSFC cluster then initiates an automatic failover to the secondary replica.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="9427e-108">如果可用性群組超過其 WSFC 失敗臨界值，WSFC 叢集將不會嘗試進行可用性群組的自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="9427e-108">If an availability group exceeds its WSFC failure threshold, the WSFC cluster will not attempt an automatic failover for the availability group.</span></span> <span data-ttu-id="9427e-109">此外，可用性群組的 WSFC 資源群組會維持失敗狀態，直到叢集管理員手動讓失敗的資源群組上線，或者資料庫管理員執行可用性群組的手動容錯移轉為止。</span><span class="sxs-lookup"><span data-stu-id="9427e-109">Furthermore, the WSFC resource group of the availability group remains in a failed state until either the cluster administrator manually brings the failed resource group online or the database administrator performs a manual failover of the availability group.</span></span> <span data-ttu-id="9427e-110">*「WSFC 失敗臨界值」* (WSFC Failure Threshold) 定義為可用性群組在給定的時間週期內支援的失敗次數上限。</span><span class="sxs-lookup"><span data-stu-id="9427e-110">The *WSFC failure threshold* is defined as the maximum number of failures supported for the availability group during a given time period.</span></span> <span data-ttu-id="9427e-111">預設的時間週期為六小時，而且在這段時間內失敗次數上限的預設值為 *n*-1，其中 *n* 是 WSFC 節點的數目。</span><span class="sxs-lookup"><span data-stu-id="9427e-111">The default time period is six hours, and the default value for the maximum number of failures during this period is *n*-1, where *n* is the number of WSFC nodes.</span></span> <span data-ttu-id="9427e-112">若要變更給定可用性群組得失敗臨界值，請使用 WSFC 容錯移轉管理員主控台。</span><span class="sxs-lookup"><span data-stu-id="9427e-112">To change the failure-threshold values for a given availability group, use the WSFC Failover Manager Console.</span></span>  
  
  
  
##  <a name="health-check-timeout-threshold"></a><a name="HCtimeout"></a> <span data-ttu-id="9427e-113">健全狀況檢查逾時臨界值</span><span class="sxs-lookup"><span data-stu-id="9427e-113">Health-Check Timeout Threshold</span></span>  
 <span data-ttu-id="9427e-114">可用性群組的 WSFC 資源 DLL 會在裝載主要複本的 SQL Server 執行個體上呼叫 [sp_server_diagnostics](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) 預存程序，藉以執行主要複本的「健全狀況檢查」\*\*。</span><span class="sxs-lookup"><span data-stu-id="9427e-114">WSFC resource DLL of the availability group performs a *health check* of the primary replica by calling the [sp_server_diagnostics](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) stored procedure on the instance of SQL Server that hosts the primary replica.</span></span> <span data-ttu-id="9427e-115">**sp_server_diagnostics** 會以等於可用性群組之健全狀況檢查逾時臨界值 1/3 的間隔傳回結果。</span><span class="sxs-lookup"><span data-stu-id="9427e-115">**sp_server_diagnostics** returns results at an interval that equals 1/3 of the health-check timeout threshold for the availability group.</span></span> <span data-ttu-id="9427e-116">預設的健全狀況檢查逾時臨界值為 30 秒，因此 **sp_server_diagnostics** 會以 10 秒的間隔傳回結果。</span><span class="sxs-lookup"><span data-stu-id="9427e-116">The default health-check timeout threshold is 30 seconds, which causes **sp_server_diagnostics** to return at a 10-second interval.</span></span> <span data-ttu-id="9427e-117">如果 **sp_server_diagnostics** 變慢或未傳回資訊，資源 DLL 會先等候健全狀況檢查逾時臨界值的完整間隔，然後再判斷主要複本是否沒有回應。</span><span class="sxs-lookup"><span data-stu-id="9427e-117">If **sp_server_diagnostics** is slow or is not returning information, the resource DLL will wait for the full interval of the health-check timeout threshold before determining that the primary replica is unresponsive.</span></span> <span data-ttu-id="9427e-118">如果主要複本沒有回應，就會起始自動容錯移轉 (如果目前支援的話)。</span><span class="sxs-lookup"><span data-stu-id="9427e-118">If the primary replica is unresponsive, an automatic failover is initiated, if currently supported.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="9427e-119">**sp_server_diagnostics** 不會在資料庫層級執行健全狀況檢查。</span><span class="sxs-lookup"><span data-stu-id="9427e-119">**sp_server_diagnostics** does not perform health checks at the database level.</span></span>  
  
##  <a name="failure-condition-level"></a><a name="FClevel"></a> <span data-ttu-id="9427e-120">失敗狀況層級</span><span class="sxs-lookup"><span data-stu-id="9427e-120">Failure-Condition Level</span></span>  
 <span data-ttu-id="9427e-121">**sp_server_diagnostics** 所傳回的診斷資料和健全狀況資訊是否保證自動容錯移轉主要取決於可用性群組的失敗狀況層級。</span><span class="sxs-lookup"><span data-stu-id="9427e-121">Whether the diagnostic data and health information returned by **sp_server_diagnostics** warrants an automatic failover depends on the failure-condition level of the availability group.</span></span> <span data-ttu-id="9427e-122">「失敗狀況層級」\*\* 會指定觸發自動容錯移轉的失敗狀況。</span><span class="sxs-lookup"><span data-stu-id="9427e-122">The *failure-condition level* specifies what failure conditions trigger an automatic failover.</span></span> <span data-ttu-id="9427e-123">失敗狀況層級共有五層，範圍從最低限制 (第一層級) 到最高限制 (第五層級)。</span><span class="sxs-lookup"><span data-stu-id="9427e-123">There are five failure-condition levels, which range from the least restrictive (level one) to the most restrictive (level five).</span></span> <span data-ttu-id="9427e-124">給定的層級包含較低限制的層級。</span><span class="sxs-lookup"><span data-stu-id="9427e-124">A given level encompasses the less restrictive levels.</span></span> <span data-ttu-id="9427e-125">因此，最嚴格的層級 (五) 包括了四個較低限制的狀況，依此類推。</span><span class="sxs-lookup"><span data-stu-id="9427e-125">Thus, the strictest level, five, includes the four less restrictive conditions, and so forth.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="9427e-126">任何失敗狀況層級不會偵測到損毀的資料庫和可疑的資料庫。</span><span class="sxs-lookup"><span data-stu-id="9427e-126">Damaged databases and suspect databases are not detected by any failure-condition level.</span></span> <span data-ttu-id="9427e-127">因此，損毀或可疑的資料庫 (不論是因為硬體故障、資料損毀或其他問題) 都絕對不會觸發自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="9427e-127">Therefore, a database that is damaged or suspect (whether due to a hardware failure, data corruption, or other issue) never triggers an automatic failover.</span></span>  
  
 <span data-ttu-id="9427e-128">下表描述對應至每個層級的失敗狀況。</span><span class="sxs-lookup"><span data-stu-id="9427e-128">The following table describes the failure-conditions that corresponds to each level.</span></span>  
  
|<span data-ttu-id="9427e-129">層級</span><span class="sxs-lookup"><span data-stu-id="9427e-129">Level</span></span>|<span data-ttu-id="9427e-130">失敗狀況</span><span class="sxs-lookup"><span data-stu-id="9427e-130">Failure Condition</span></span>|[!INCLUDE[tsql](../../../includes/tsql-md.md)] <span data-ttu-id="9427e-131">值</span><span class="sxs-lookup"><span data-stu-id="9427e-131">Value</span></span>|<span data-ttu-id="9427e-132">PowerShell 值</span><span class="sxs-lookup"><span data-stu-id="9427e-132">PowerShell Value</span></span>|  
|-----------|-----------------------|------------------------------|----------------------|  
|<span data-ttu-id="9427e-133">一個</span><span class="sxs-lookup"><span data-stu-id="9427e-133">One</span></span>|<span data-ttu-id="9427e-134">伺服器關閉時。</span><span class="sxs-lookup"><span data-stu-id="9427e-134">On server down.</span></span> <span data-ttu-id="9427e-135">這是最低限制層級。</span><span class="sxs-lookup"><span data-stu-id="9427e-135">This is the least restrictive level.</span></span> <span data-ttu-id="9427e-136">指定在發生下列任何狀況時起始自動容錯移轉：</span><span class="sxs-lookup"><span data-stu-id="9427e-136">Specifies that an automatic failover is initiated when any of the following occurs:</span></span><br /><br /> <span data-ttu-id="9427e-137">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 服務關閉。</span><span class="sxs-lookup"><span data-stu-id="9427e-137">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service is down.</span></span><br /><br /> <span data-ttu-id="9427e-138">由於未從伺服器執行個體收到 ACK，所以用於連接到 WSFC 叢集的可用性群組租用已到期。</span><span class="sxs-lookup"><span data-stu-id="9427e-138">The lease of the availability group for connecting to the WSFC cluster expires because no ACK is received from the server instance.</span></span> <span data-ttu-id="9427e-139">如需詳細資訊，請參閱 [How It Works: SQL Server AlwaysOn Lease Timeout](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx) (運作方式：SQL Server AlwaysOn 租用逾時)。</span><span class="sxs-lookup"><span data-stu-id="9427e-139">For more information, see [How It Works: SQL Server AlwaysOn Lease Timeout](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx).</span></span>|<span data-ttu-id="9427e-140">1</span><span class="sxs-lookup"><span data-stu-id="9427e-140">1</span></span>|`OnServerDown`|  
|<span data-ttu-id="9427e-141">兩個</span><span class="sxs-lookup"><span data-stu-id="9427e-141">Two</span></span>|<span data-ttu-id="9427e-142">伺服器沒有回應時。</span><span class="sxs-lookup"><span data-stu-id="9427e-142">On server unresponsive.</span></span> <span data-ttu-id="9427e-143">指定在發生下列任何狀況時起始自動容錯移轉：</span><span class="sxs-lookup"><span data-stu-id="9427e-143">Specifies that an automatic failover is initiated when any of the following occurs:</span></span><br /><br /> <span data-ttu-id="9427e-144">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 的執行個體未連接到叢集，而且已超出使用者指定之可用性群組的健全狀況檢查逾時臨界值。</span><span class="sxs-lookup"><span data-stu-id="9427e-144">The instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] does not connect to cluster, and the user-specified health check timeout threshold of the availability group is exceeded.</span></span><br /><br /> <span data-ttu-id="9427e-145">可用性複本處於失敗狀態。</span><span class="sxs-lookup"><span data-stu-id="9427e-145">The availability replica is in failed state.</span></span>|<span data-ttu-id="9427e-146">2</span><span class="sxs-lookup"><span data-stu-id="9427e-146">2</span></span>|`OnServerUnresponsive`|  
|<span data-ttu-id="9427e-147">三</span><span class="sxs-lookup"><span data-stu-id="9427e-147">Three</span></span>|<span data-ttu-id="9427e-148">發生嚴重伺服器錯誤時。</span><span class="sxs-lookup"><span data-stu-id="9427e-148">On critical server error.</span></span> <span data-ttu-id="9427e-149">指定在發生嚴重 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 內部錯誤時起始自動容錯移轉，例如執行緒同步鎖定遭到遺棄、嚴重的寫入存取違規或是傾印過多。</span><span class="sxs-lookup"><span data-stu-id="9427e-149">Specifies that an automatic failover is initiated on critical [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal errors, such as orphaned spinlocks, serious write-access violations, or too much dumping.</span></span> <span data-ttu-id="9427e-150">這是預設層級。</span><span class="sxs-lookup"><span data-stu-id="9427e-150">This is the default level.</span></span>|<span data-ttu-id="9427e-151">3</span><span class="sxs-lookup"><span data-stu-id="9427e-151">3</span></span>|`OnCriticalServerError`|  
|<span data-ttu-id="9427e-152">四</span><span class="sxs-lookup"><span data-stu-id="9427e-152">Four</span></span>|<span data-ttu-id="9427e-153">發生一般伺服器錯誤時。</span><span class="sxs-lookup"><span data-stu-id="9427e-153">On moderate server error.</span></span> <span data-ttu-id="9427e-154">指定在發生一般 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 內部錯誤時起始自動容錯移轉，例如 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 內部資源集區持續發生記憶體不足的狀況。</span><span class="sxs-lookup"><span data-stu-id="9427e-154">Specifies that an automatic failover is initiated on moderate [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal errors, such as a persistent out-of-memory condition in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal resource pool.</span></span>|<span data-ttu-id="9427e-155">4</span><span class="sxs-lookup"><span data-stu-id="9427e-155">4</span></span>|`OnModerateServerError`|  
|<span data-ttu-id="9427e-156">五</span><span class="sxs-lookup"><span data-stu-id="9427e-156">Five</span></span>|<span data-ttu-id="9427e-157">發生任何限定的失敗狀況時。</span><span class="sxs-lookup"><span data-stu-id="9427e-157">On any qualified failure conditions.</span></span> <span data-ttu-id="9427e-158">這是最高限制層級。</span><span class="sxs-lookup"><span data-stu-id="9427e-158">This is the most restrictive level.</span></span> <span data-ttu-id="9427e-159">指定在發生任何限定的失敗狀況時起始自動容錯移轉，這些狀況包括：</span><span class="sxs-lookup"><span data-stu-id="9427e-159">Specifies that an automatic failover is initiated on any qualified failure conditions, including:</span></span><br /><br /> <span data-ttu-id="9427e-160">SQL 引擎工作者執行緒已耗盡。</span><span class="sxs-lookup"><span data-stu-id="9427e-160">Exhaustion of SQL Engine worker-threads.</span></span><br /><br /> <span data-ttu-id="9427e-161">偵測到無法解決的死結。</span><span class="sxs-lookup"><span data-stu-id="9427e-161">Detection of an unsolvable deadlock.</span></span>|<span data-ttu-id="9427e-162">5</span><span class="sxs-lookup"><span data-stu-id="9427e-162">5</span></span>|`OnAnyQualifiedFailureConditions`|  
  
> [!NOTE]  
>  <span data-ttu-id="9427e-163">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 執行個體對用戶端要求缺少回應與可用性群組無關。</span><span class="sxs-lookup"><span data-stu-id="9427e-163">Lack of response by an instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] to client requests is irrelevant to availability groups.</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="9427e-164">相關工作</span><span class="sxs-lookup"><span data-stu-id="9427e-164">Related Tasks</span></span>  
 <span data-ttu-id="9427e-165">**若要設定自動容錯移轉**</span><span class="sxs-lookup"><span data-stu-id="9427e-165">**To configure automatic failover**</span></span>  
  
-   <span data-ttu-id="9427e-166">[變更可用性複本的可用性模式 &#40;SQL Server&#41;](change-the-availability-mode-of-an-availability-replica-sql-server.md) (自動容錯移轉需要同步認可的可用性模式)</span><span class="sxs-lookup"><span data-stu-id="9427e-166">[Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;](change-the-availability-mode-of-an-availability-replica-sql-server.md) (automatic failover requires synchronous-commit availability mode)</span></span>  
  
-   [<span data-ttu-id="9427e-167">變更可用性複本的容錯移轉模式 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="9427e-167">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
-   [<span data-ttu-id="9427e-168">設定彈性容錯移轉原則以控制自動容錯移轉的條件 (AlwaysOn 可用性群組)</span><span class="sxs-lookup"><span data-stu-id="9427e-168">Configure the Flexible Failover Policy to Control Conditions for Automatic Failover (AlwaysOn Availability Groups)</span></span>](configure-flexible-automatic-failover-policy.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="9427e-169">相關內容</span><span class="sxs-lookup"><span data-stu-id="9427e-169">Related Content</span></span>  
  
-   [<span data-ttu-id="9427e-170">運作方式：SQL Server AlwaysOn 租用逾時</span><span class="sxs-lookup"><span data-stu-id="9427e-170">How It Works: SQL Server AlwaysOn Lease Timeout</span></span>](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx)  
  
## <a name="see-also"></a><span data-ttu-id="9427e-171">另請參閱</span><span class="sxs-lookup"><span data-stu-id="9427e-171">See Also</span></span>  
 <span data-ttu-id="9427e-172">[AlwaysOn 可用性群組 &#40;SQL Server 的總覽&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="9427e-172">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="9427e-173">[可用性模式 (AlwaysOn 可用性群組) ](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="9427e-173">[Availability Modes (AlwaysOn Availability Groups)](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="9427e-174">[容錯移轉和容錯移轉模式 &#40;AlwaysOn 可用性群組&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="9427e-174">[Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="9427e-175">[SQL Server 的 Windows Server 容錯移轉叢集 &#40;WSFC&#41;](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="9427e-175">[Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span></span>  
 <span data-ttu-id="9427e-176">[容錯移轉叢集執行個體的容錯移轉原則](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span><span class="sxs-lookup"><span data-stu-id="9427e-176">[Failover Policy for Failover Cluster Instances](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span></span>  
 [<span data-ttu-id="9427e-177">sp_server_diagnostics &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="9427e-177">sp_server_diagnostics &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql)  
  
  
