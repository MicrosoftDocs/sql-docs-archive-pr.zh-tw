---
title: 複寫、變更追蹤、變更資料捕獲，以及 AlwaysOn 可用性群組 (SQL Server) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- change tracking [SQL Server], AlwaysOn Availability Groups
- change data capture [SQL Server], AlwaysOn Availability Groups
- Availability Groups [SQL Server], interoperability
- replication [SQL Server], AlwaysOn Availability Groups
ms.assetid: e17a9ca9-dd96-4f84-a85d-60f590da96ad
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e8ea6257cb906177b9eb224d718eecf54fb94119
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87593596"
---
# <a name="replication-change-tracking-change-data-capture-and-alwayson-availability-groups-sql-server"></a><span data-ttu-id="adf95-102">複寫、變更追蹤、變更資料擷取和 AlwaysOn 可用性群組 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="adf95-102">Replication, Change Tracking, Change Data Capture, and AlwaysOn Availability Groups (SQL Server)</span></span>
  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="adf95-103">[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]支援複寫、異動資料擷取 (CDC) 和變更追蹤 (CT)。</span><span class="sxs-lookup"><span data-stu-id="adf95-103">Replication, change data capture (CDC), and change tracking (CT) are supported on [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] <span data-ttu-id="adf95-104">有助於提供高可用性以及其他資料庫復原功能。</span><span class="sxs-lookup"><span data-stu-id="adf95-104">helps provide high availability and additional database recovery capabilities.</span></span>  
  
 
  
##  <a name="overview-of-replication-on-alwayson-availability-groups"></a><a name="Overview"></a><span data-ttu-id="adf95-105">AlwaysOn 可用性群組上的複寫總覽</span><span class="sxs-lookup"><span data-stu-id="adf95-105">Overview of Replication on AlwaysOn Availability Groups</span></span>  
  
###  <a name="publisher-redirection"></a><a name="PublisherRedirect"></a> <span data-ttu-id="adf95-106">發行者重新導向</span><span class="sxs-lookup"><span data-stu-id="adf95-106">Publisher Redirection</span></span>  
 <span data-ttu-id="adf95-107">當發行的資料庫能夠感知 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]時，提供發行資料庫之代理程式存取權的散發者就會使用 redirected_publishers 項目來設定。</span><span class="sxs-lookup"><span data-stu-id="adf95-107">When a published database is aware of [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], the distributor that provides agent access to the publishing database is configured with redirected_publishers entries.</span></span> <span data-ttu-id="adf95-108">這些項目會重新導向原本設定的發行者/資料庫配對，並利用可用性群組接聽程式名稱來連接到發行者和發行資料庫。</span><span class="sxs-lookup"><span data-stu-id="adf95-108">These entries redirect the originally configured publisher/database pair, making use of an availability group listener name to connect to the publisher and publishing database.</span></span> <span data-ttu-id="adf95-109">透過可用性群組接聽程式名稱所建立的連接將會在容錯移轉時失敗。</span><span class="sxs-lookup"><span data-stu-id="adf95-109">Established connections through the availability group listener name will fail on failover.</span></span> <span data-ttu-id="adf95-110">在容錯移轉之後，當複寫代理程式重新啟動時，連接將自動重新導向至新的主要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-110">When the replication agent restarts after failover, the connection will automatically be redirected to the new primary.</span></span>  
  
 <span data-ttu-id="adf95-111">在 AlwaysOn 可用性群組中，次要資料庫不能是發行者。</span><span class="sxs-lookup"><span data-stu-id="adf95-111">In an AlwaysOn availability group a secondary database cannot be a publisher.</span></span> <span data-ttu-id="adf95-112">當複寫與 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]結合時，不支援重新發行。</span><span class="sxs-lookup"><span data-stu-id="adf95-112">Republishing is not supported when replication is combined with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span>  
  
 <span data-ttu-id="adf95-113">如果發行的資料庫是可用性群組的成員，而且發行者已重新導向，它就必須重新導向至與可用性群組相關聯的可用性群組接聽程式名稱。</span><span class="sxs-lookup"><span data-stu-id="adf95-113">If a published database is a member of an availability group and the publisher is redirected, it must be redirected to an availability group listener name associated with the availability group.</span></span> <span data-ttu-id="adf95-114">它可能不會重新導向至明確節點。</span><span class="sxs-lookup"><span data-stu-id="adf95-114">It may not be redirected to an explicit node.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="adf95-115">在容錯移轉到次要複本之後，複寫監視器就無法調整 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 發行執行個體的名稱，而且會繼續在原始主要 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]執行個體名稱之下顯示複寫資訊。</span><span class="sxs-lookup"><span data-stu-id="adf95-115">After failover to a secondary replica, Replication Monitor is unable to adjust the name of the publishing instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and will continue to display replication information under the name of the original primary instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="adf95-116">在容錯移轉之後，便無法使用複寫監視器輸入追蹤 Token，但是可以在複寫監視器中看到在新的發行者端使用 [!INCLUDE[tsql](../../../includes/tsql-md.md)]輸入的追蹤 Token。</span><span class="sxs-lookup"><span data-stu-id="adf95-116">After failover, a tracer token cannot be entered by using the Replication Monitor, however a tracer token entered on the new publisher by using [!INCLUDE[tsql](../../../includes/tsql-md.md)], is visible in Replication Monitor.</span></span>  
  
###  <a name="general-changes-to-replication-agents-to-support-alwayson-availability-groups"></a><a name="Changes"></a><span data-ttu-id="adf95-117">複寫代理程式的一般變更，以支援 AlwaysOn 可用性群組</span><span class="sxs-lookup"><span data-stu-id="adf95-117">General Changes to Replication Agents to Support AlwaysOn Availability Groups</span></span>  
 <span data-ttu-id="adf95-118">三個複寫代理程式已修改成支援 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="adf95-118">Three replication agents were modified to support [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="adf95-119">記錄讀取器、快照集和合併代理程式已修改成查詢重新導向發行者的散發資料庫，並且使用傳回的可用性群組接聽程式名稱來連接到資料庫發行者 (如果已宣告重新導向發行者的話)。</span><span class="sxs-lookup"><span data-stu-id="adf95-119">The Log Reader, Snapshot, and Merge agents were modified to query the distribution database for the redirected publisher and to use the returned availability group listener name, if a redirected publisher was declared, to connect to the database publisher.</span></span>  
  
 <span data-ttu-id="adf95-120">根據預設，當代理程式查詢散發者以判斷原始發行者是否已重新導向時，會驗證重新導向目前目標的適用性，然後才將重新導向的主機傳回至代理程式。</span><span class="sxs-lookup"><span data-stu-id="adf95-120">By default, when the agents query the distributor to determine whether the original publisher has been redirected, the suitability of the current target or redirection will be verified prior to returning the redirected host to the agent.</span></span> <span data-ttu-id="adf95-121">這是建議的行為。</span><span class="sxs-lookup"><span data-stu-id="adf95-121">This is recommended behavior.</span></span> <span data-ttu-id="adf95-122">不過，如果代理程式啟動太頻繁，與驗證預存程序相關的負擔成本可能太高。</span><span class="sxs-lookup"><span data-stu-id="adf95-122">However, if agent start up occurs very frequently the overhead associated with the validation stored procedure may be deemed too costly.</span></span> <span data-ttu-id="adf95-123">新命令列參數 *BypassPublisherValidation*已加入至記錄讀取器、快照集和合併代理程式。</span><span class="sxs-lookup"><span data-stu-id="adf95-123">A new command line switch, *BypassPublisherValidation*, has been added to the Logreader, Snapshot, and Merge agents.</span></span> <span data-ttu-id="adf95-124">使用此參數時，重新導向的主機會立即傳回至代理程式，而略過驗證預存程序的執行。</span><span class="sxs-lookup"><span data-stu-id="adf95-124">When the switch is used, the redirected publisher is returned immediately to the agent and execution of the validation stored procedure is bypassed.</span></span>  
  
 <span data-ttu-id="adf95-125">從驗證預存程序傳回的失敗會記錄在代理程式記錄檔中。</span><span class="sxs-lookup"><span data-stu-id="adf95-125">Failures returned from the validation stored procedure are logged in the agent history logs.</span></span> <span data-ttu-id="adf95-126">嚴重性大於或等於 16 的這些錯誤會導致代理程式終止。</span><span class="sxs-lookup"><span data-stu-id="adf95-126">Those errors with severity greater than or equal to 16 will cause the agents to terminate.</span></span> <span data-ttu-id="adf95-127">某些重試功能已內建到代理程式，以處理在容錯移轉至新主要複本時預期的已發行資料庫中斷連接。</span><span class="sxs-lookup"><span data-stu-id="adf95-127">Some retry capabilities have been built in to the agents to handle the expected disconnect from a published database when it fails over to a new primary.</span></span>  
  
#### <a name="log-reader-agent-modifications"></a><span data-ttu-id="adf95-128">記錄讀取器代理程式修改</span><span class="sxs-lookup"><span data-stu-id="adf95-128">Log Reader Agent Modifications</span></span>  
 <span data-ttu-id="adf95-129">記錄讀取器代理程式有下列變更。</span><span class="sxs-lookup"><span data-stu-id="adf95-129">The Logreader Agent has the following changes.</span></span>  
  
-   <span data-ttu-id="adf95-130">**複寫的資料庫一致性**</span><span class="sxs-lookup"><span data-stu-id="adf95-130">**Replicated Database Consistency**</span></span>  
  
     <span data-ttu-id="adf95-131">當發行的資料庫是 AlwaysOn 可用性群組的成員時，記錄讀取器預設不會處理所有可用性群組次要複本上尚未強行寫入的記錄檔記錄。</span><span class="sxs-lookup"><span data-stu-id="adf95-131">When a published database is a member of an AlwaysOn availability group, by default the log reader will not process log records that have not already been hardened at all availability group secondary replicas.</span></span> <span data-ttu-id="adf95-132">這樣可確保容錯移轉時，所有複寫至訂閱者的資料列也會存在新的主要複本上。</span><span class="sxs-lookup"><span data-stu-id="adf95-132">This insures that on failover, all rows replicated to a subscriber also are present at the new primary.</span></span>  
  
     <span data-ttu-id="adf95-133">當發行者只有兩個 AlwaysOn 可用性複本 (一個主要和一個次要) 且發生容錯移轉時，原始的主要複本會保持離線，因為在所有次要資料庫恢復連線或發生錯誤的次要複本從可用性群組中移除之前，Logreader 不會向前移動。</span><span class="sxs-lookup"><span data-stu-id="adf95-133">When the publisher has only two AlwaysOn availability replicas (one primary and one secondary) and a failover happens, the original primary replica remains down because the logreader does not move forward until all secondary databases are brought back online or until the failing secondary replicas are removed from the availability group.</span></span> <span data-ttu-id="adf95-134">現在針對次要資料庫執行的 Logreader 將不會繼續前進，因為 AlwaysOn 無法強行對任何次要資料庫進行任何變更。</span><span class="sxs-lookup"><span data-stu-id="adf95-134">The logreader, now running against the secondary database, will not proceed forward since AlwaysOn cannot harden any changes to any secondary database.</span></span> <span data-ttu-id="adf95-135">若要讓 Logreader 繼續前進並且仍然擁有災害復原的能力，請使用 ALTER AVAILABITY GROUP <group_name> REMOVE REPLICA 從可用性群組中移除原始主要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-135">To allow the logreader to proceed further and still have disaster recovery capacity, remove the original primary replica from the availability group using ALTER AVAILABITY GROUP <group_name> REMOVE REPLICA.</span></span> <span data-ttu-id="adf95-136">然後將新的次要複本加入至可用性群組。</span><span class="sxs-lookup"><span data-stu-id="adf95-136">Then add a new secondary replica to the availability group.</span></span>  
  
-   <span data-ttu-id="adf95-137">**追蹤旗標 1448**</span><span class="sxs-lookup"><span data-stu-id="adf95-137">**Trace flag 1448**</span></span>  
  
     <span data-ttu-id="adf95-138">追蹤旗標 1448 可讓複寫記錄讀取器向前移動，即使非同步次要複本尚未認可收到變更也一樣。</span><span class="sxs-lookup"><span data-stu-id="adf95-138">Trace flag 1448 enables the replication log reader to move forward even if the asynchronous secondary replicas have not acknowledged the reception of a change.</span></span> <span data-ttu-id="adf95-139">即使這個追蹤旗標已啟用，記錄讀取器一定會等候同步次要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-139">Even with this trace flag enabled,, the log reader always waits for the synchronous secondary replicas.</span></span> <span data-ttu-id="adf95-140">記錄讀取器不會超過同步次要複本的最小認可。</span><span class="sxs-lookup"><span data-stu-id="adf95-140">The log reader will not go beyond the min ack of the synchronous secondary replicas.</span></span> <span data-ttu-id="adf95-141">這個追蹤旗標會套用至 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]執行個體，而不只套用至可用性群組、可用性資料庫或記錄讀取器執行個體。</span><span class="sxs-lookup"><span data-stu-id="adf95-141">This trace flag applies to the instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], not just to an availability group, an availability database, or a log reader instance.</span></span> <span data-ttu-id="adf95-142">這個追蹤旗標會立即生效，不必重新啟動。</span><span class="sxs-lookup"><span data-stu-id="adf95-142">This trace flag takes effect immediately without a restart.</span></span> <span data-ttu-id="adf95-143">您可以事先或在非同步次要複本失敗時啟動它。</span><span class="sxs-lookup"><span data-stu-id="adf95-143">It can be activated ahead of time or when an asynchronous secondary replica fails.</span></span>  
  
###  <a name="stored-procedures-supporting-alwayson"></a><a name="StoredProcs"></a><span data-ttu-id="adf95-144">支援 AlwaysOn 的預存程式</span><span class="sxs-lookup"><span data-stu-id="adf95-144">Stored Procedures Supporting AlwaysOn</span></span>  
  
-   <span data-ttu-id="adf95-145">**sp_redirect_publisher**</span><span class="sxs-lookup"><span data-stu-id="adf95-145">**sp_redirect_publisher**</span></span>  
  
     <span data-ttu-id="adf95-146">預存程序 **sp_redirect_publisher** 可用來指定現有發行者/資料庫配對的重新導向發行者。</span><span class="sxs-lookup"><span data-stu-id="adf95-146">The stored procedure **sp_redirect_publisher** is used to specify a redirected publisher for an existing publisher/database pair.</span></span> <span data-ttu-id="adf95-147">如果發行者資料庫屬於可用性群組，重新導向發行者就是可用性群組接聽程式名稱。</span><span class="sxs-lookup"><span data-stu-id="adf95-147">If the publisher database belongs to an availability group, the redirected publisher is the availability group listener name.</span></span>  
  
-   <span data-ttu-id="adf95-148">**sp_get_redirected_publisher**</span><span class="sxs-lookup"><span data-stu-id="adf95-148">**sp_get_redirected_publisher**</span></span>  
  
     <span data-ttu-id="adf95-149">預存程序 **sp_get_redirected_publisher** 可由複寫代理程式用來查詢散發者，以便判斷發行者/資料庫配對是否具有定義的重新導向發行者。</span><span class="sxs-lookup"><span data-stu-id="adf95-149">The stored procedure **sp_get_redirected_publisher** is used by replication agents to query a distributor to determine whether a publisher/database pair has a defined redirected publisher.</span></span> <span data-ttu-id="adf95-150">此預存程序有兩種目的。</span><span class="sxs-lookup"><span data-stu-id="adf95-150">This stored procedure serves two purposes.</span></span> <span data-ttu-id="adf95-151">首先，它可讓代理程式判斷原始發行者是否已經重新導向。</span><span class="sxs-lookup"><span data-stu-id="adf95-151">First, it allows the agent to determine whether the original publisher has been redirected.</span></span> <span data-ttu-id="adf95-152">其次，它也可以在散發者端起始驗證預存程序 (**sp_validate_redirected_publisher**)，以便驗證重新導向的目標節點是否適合作為具名資料庫的發行者。</span><span class="sxs-lookup"><span data-stu-id="adf95-152">Second, it may also initiate a validation stored procedure run at the distributor (**sp_validate_redirected_publisher**) that verifies the suitability of the target node of the redirection to serve as a publisher for the named database.</span></span>  
  
     <span data-ttu-id="adf95-153">若要執行此預存程序，呼叫端必須是 **系統管理員** 伺服器角色的成員、散發資料庫的 **db_owner** 資料庫角色，或是與發行者資料庫相關聯之定義發行集的 **發行集存取清單** 的成員。</span><span class="sxs-lookup"><span data-stu-id="adf95-153">To execute this stored procedure the caller must either be a member of the **sysadmin** server role, the **db_owner** database role for the distribution database, or a member of a **Publication Access List** for a defined publication associated with the publisher database.</span></span>  
  
-   <span data-ttu-id="adf95-154">**sp_validate_redirected_publisher**</span><span class="sxs-lookup"><span data-stu-id="adf95-154">**sp_validate_redirected_publisher**</span></span>  
  
     <span data-ttu-id="adf95-155">此預存程序會嘗試驗證目前的發行者是否能夠裝載發行的資料庫。</span><span class="sxs-lookup"><span data-stu-id="adf95-155">This stored procedure attempts to validate that the current publisher is capable of hosting the published database.</span></span> <span data-ttu-id="adf95-156">您可以隨時呼叫此預存程序，以便確認發行之資料庫的目前主機是否能夠支援複寫。</span><span class="sxs-lookup"><span data-stu-id="adf95-156">It can be called at any time to verify that the current host for the published database is capable of supporting replication.</span></span>  
  
-   <span data-ttu-id="adf95-157">**sp_validate_replicate_hosts_as_publishers**</span><span class="sxs-lookup"><span data-stu-id="adf95-157">**sp_validate_replicate_hosts_as_publishers**</span></span>  
  
     <span data-ttu-id="adf95-158">雖然讓代理程式確保目前主要複本能夠當做發行者資料庫的複寫發行者運作已經很有用，不過還是需要一項更全面的驗證功能，才能確立 AlwaysOn 可用性資料庫上整個複寫拓撲的有效性。</span><span class="sxs-lookup"><span data-stu-id="adf95-158">While it is useful for the agents to insure that the current primary can function as the replication publisher for a publisher database, a more general validation capability is needed to establish the validity of an entire replication topology on an AlwaysOn availability database.</span></span> <span data-ttu-id="adf95-159">預存程序 **sp_validate_replica_hosts_as_publishers** 就是為了滿足這項需求所設計。</span><span class="sxs-lookup"><span data-stu-id="adf95-159">The stored procedure **sp_validate_replica_hosts_as_publishers** is designed to fill this need.</span></span>  
  
     <span data-ttu-id="adf95-160">此預存程序一律以手動方式執行。</span><span class="sxs-lookup"><span data-stu-id="adf95-160">This stored procedure is always run manually.</span></span> <span data-ttu-id="adf95-161">呼叫端必須是散發者端的系統管理員 ( **sysadmin** )、散發資料庫的 **dbowner** 或是發行者資料庫中發行集之 **發行集存取清單** 的成員。</span><span class="sxs-lookup"><span data-stu-id="adf95-161">The caller must either be **sysadmin** at the distributor, **dbowner** of the distribution database, or a member of the **Publication Access List** of a publication of the publisher database.</span></span> <span data-ttu-id="adf95-162">此外，對於所有可用性複本主機而言，呼叫端的登入必須是有效的登入，而且擁有與發行者資料庫相關聯之可用性資料庫的選取權限。</span><span class="sxs-lookup"><span data-stu-id="adf95-162">In addition, the login of the caller must be a valid login for all of the availability replica hosts, and have select privileges on the availability database associated with the publisher database.</span></span>  
  
###  <a name="change-data-capture"></a><a name="CDC"></a> <span data-ttu-id="adf95-163">異動資料擷取</span><span class="sxs-lookup"><span data-stu-id="adf95-163">Change Data Capture</span></span>  
 <span data-ttu-id="adf95-164">啟用異動資料擷取 (CDC) 的資料庫能夠運用 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] ，以便確保資料庫在發生失敗時維持可用狀態，而且資料庫資料表的變更會繼續受到監視並且儲放在 CDC 變更資料表中。</span><span class="sxs-lookup"><span data-stu-id="adf95-164">Databases enabled for change data capture (CDC) are able to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] in order to insure not only that the database remains available in the event of failure, but that changes to the database tables continue to be monitored and deposited in the CDC change tables.</span></span> <span data-ttu-id="adf95-165">設定 CDC 和 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 的順序並不重要。</span><span class="sxs-lookup"><span data-stu-id="adf95-165">The order in which CDC and [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] are configured is not important.</span></span> <span data-ttu-id="adf95-166">啟用 CDC 的資料庫可以加入至 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]，而且可以啟用本身為 AlwaysOn 可用性群組成員之資料庫的 CDC。</span><span class="sxs-lookup"><span data-stu-id="adf95-166">CDC enabled databases can be added to [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], and databases that are members of an AlwaysOn availability group can be enabled for CDC.</span></span> <span data-ttu-id="adf95-167">不過，在這兩種情況下，CDC 組態一律在目前或預期的主要複本上執行。</span><span class="sxs-lookup"><span data-stu-id="adf95-167">In both cases, however, CDC configuration is always performed on the current or intended primary replica.</span></span> <span data-ttu-id="adf95-168">CDC 會使用記錄讀取器代理程式，而且其限制與本主題稍早的＜ **記錄讀取器代理程式修改** ＞一節中所述的限制相同。</span><span class="sxs-lookup"><span data-stu-id="adf95-168">CDC uses the log reader agent and has the same limitations as described in the **Log Reader Agent Modifications** section earlier in this topic.</span></span>  
  
-   <span data-ttu-id="adf95-169">**在有異動資料擷取但沒有複寫的情況下，收集變更**</span><span class="sxs-lookup"><span data-stu-id="adf95-169">**Harvesting Changes for Change Data Capture Without Replication**</span></span>  
  
     <span data-ttu-id="adf95-170">如果資料庫啟用了 CDC，但是沒有啟用複寫，用來從記錄中收集變更並將變更儲放在 CDC 變更資料表中的擷取處理序就會在 CDC 主機上當做它自己的 SQL 代理程式作業執行。</span><span class="sxs-lookup"><span data-stu-id="adf95-170">If CDC is enabled for a database, but replication is not, the capture process used to harvest changes from the log and deposit them in CDC change tables runs at the CDC host as its own SQL Agent job.</span></span>  
  
     <span data-ttu-id="adf95-171">若要在容錯移轉之後繼續收集變更，您必須在新的主要複本上執行預存程序 **sp_cdc_add_job** ，以便建立本機擷取作業。</span><span class="sxs-lookup"><span data-stu-id="adf95-171">In order to resume the harvesting of changes after failover, the stored procedure **sp_cdc_add_job** must be run at the new primary to create the local capture job.</span></span>  
  
     <span data-ttu-id="adf95-172">下列範例會建立擷取作業。</span><span class="sxs-lookup"><span data-stu-id="adf95-172">The following example creates the capture job.</span></span>  
  
    ```  
    EXEC sys.sp_cdc_add_job @job_type = 'capture';  
    ```  
  
-   <span data-ttu-id="adf95-173">**在有異動資料擷取且有複寫的情況下，收集變更**</span><span class="sxs-lookup"><span data-stu-id="adf95-173">**Harvesting Changes for Change Data Capture With Replication**</span></span>  
  
     <span data-ttu-id="adf95-174">如果同時啟用了資料庫的 CDC 和複寫，記錄讀取器就會處理 CDC 變更資料表的母體擴展。</span><span class="sxs-lookup"><span data-stu-id="adf95-174">If both CDC and replication are enabled for a database, the log reader handles the population of the CDC change tables.</span></span> <span data-ttu-id="adf95-175">在此情況中，複寫用來運用 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 的技術將可確保系統在容錯移轉之後繼續從記錄中收集變更並儲放在 CDC 變更資料表中。</span><span class="sxs-lookup"><span data-stu-id="adf95-175">In this case, the techniques used by replication to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] will insure that changes continue to be harvested from the log and deposited in CDC change tables after failover.</span></span> <span data-ttu-id="adf95-176">在此組態中，不需要為 CDC 執行其他動作，以確保變更資料表會擴展。</span><span class="sxs-lookup"><span data-stu-id="adf95-176">Nothing additional needs to be done for CDC in this configuration to insure that the change tables are populated.</span></span>  
  
-   <span data-ttu-id="adf95-177">**異動資料擷取清除**</span><span class="sxs-lookup"><span data-stu-id="adf95-177">**Change Data Capture Cleanup**</span></span>  
  
     <span data-ttu-id="adf95-178">為了確保新的主要資料庫會進行適當的清除，一定要建立本機清除作業。</span><span class="sxs-lookup"><span data-stu-id="adf95-178">To insure that appropriate cleanup occurs at the new primary database, a local cleanup job should always be created.</span></span> <span data-ttu-id="adf95-179">下列範例會建立清除作業。</span><span class="sxs-lookup"><span data-stu-id="adf95-179">The following example creates the cleanup job.</span></span>  
  
    ```  
    EXEC sys.sp_cdc_add_job @job_type = 'cleanup';  
    ```  
  
    > [!NOTE]  
    >  <span data-ttu-id="adf95-180">您應該在容錯移轉前於所有可能的容錯移轉目標上建立這些作業，並且將它們標示為停用，直到主機上的可用性複本變成新的主要複本為止。</span><span class="sxs-lookup"><span data-stu-id="adf95-180">You should create the jobs at all of the possible failover targets before failover, and mark them as disabled until the availability replica at a host becomes the new primary replica.</span></span> <span data-ttu-id="adf95-181">當本機資料庫變成次要資料庫時，在舊主要資料庫上執行的 CDC 作業也應該停用。</span><span class="sxs-lookup"><span data-stu-id="adf95-181">The CDC jobs running at the old primary database should be also disabled when the local database becomes a secondary database.</span></span> <span data-ttu-id="adf95-182">若要停用和啟用作業，請使用 *@enabled* [Sp_update_job &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-update-job-transact-sql)的選項。</span><span class="sxs-lookup"><span data-stu-id="adf95-182">To disable and enable jobs, use the *@enabled* option of [sp_update_job &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-update-job-transact-sql).</span></span> <span data-ttu-id="adf95-183">如需有關建立 CDC 作業的詳細資訊，請參閱 [sys.sp_cdc_add_job &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql)支援複寫、異動資料擷取 (CDC) 和變更追蹤 (CT)。</span><span class="sxs-lookup"><span data-stu-id="adf95-183">For more information about creating CDC jobs, see [sys.sp_cdc_add_job &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql).</span></span>  
  
-   <span data-ttu-id="adf95-184">**將 CDC 角色加入至 AlwaysOn 主要資料庫複本**</span><span class="sxs-lookup"><span data-stu-id="adf95-184">**Adding CDC Roles to an AlwaysOn Primary Database Replica**</span></span>  
  
     <span data-ttu-id="adf95-185">當資料表啟用 CDC 時，有可能將資料庫角色與擷取執行個體建立關聯。</span><span class="sxs-lookup"><span data-stu-id="adf95-185">When a table is enabled for CDC, it is possible to associate a database role with the capture instance.</span></span> <span data-ttu-id="adf95-186">如果指定了角色，希望使用 CDC 資料表值函式來存取資料表變更的使用者必須不只有追蹤資料表資料行的選取存取權，也必須是具名角色的成員。</span><span class="sxs-lookup"><span data-stu-id="adf95-186">If a role is specified, the user wishing to use the CDC table-valued functions to access changes for the table must not only have select access to the tracked table columns, but must also be a member of the named role.</span></span> <span data-ttu-id="adf95-187">如果指定的角色尚未存在，則會建立角色。</span><span class="sxs-lookup"><span data-stu-id="adf95-187">If the specified role does not already exist, the role will be created.</span></span> <span data-ttu-id="adf95-188">當資料庫角色自動加入至 AlwaysOn 主要資料庫時，這些角色也會傳播至可用性群組的次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="adf95-188">When database roles are automatically added to an AlwaysOn primary database, the roles are also propagated to the secondary databases of the availability group.</span></span>  
  
-   <span data-ttu-id="adf95-189">**存取 CDC 變更資料的用戶端應用程式和 AlwaysOn**</span><span class="sxs-lookup"><span data-stu-id="adf95-189">**Client Applications Accessing CDC Change Data and Always On**</span></span>  
  
     <span data-ttu-id="adf95-190">使用資料表值函式 (TVF) 或連結的伺服器存取變更資料表資料的用戶端應用程式，也需要在容錯移轉後找出適當 CDC 主機的功能。</span><span class="sxs-lookup"><span data-stu-id="adf95-190">Client applications that use the table-valued functions (TVFs) or linked servers to access change table data also need the ability to locate an appropriate CDC host after failover.</span></span> <span data-ttu-id="adf95-191">可用性群組接聽程式名稱是 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 所提供的機制，這項機制會以透明的方式允許連接以不同主機為新目標。</span><span class="sxs-lookup"><span data-stu-id="adf95-191">The availability group listener name is the mechanism provided by [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] to transparently allow a connection to be retargeted to a different host.</span></span> <span data-ttu-id="adf95-192">一旦可用性群組接聽程式名稱與可用性群組產生關聯之後，它就可用於 TCP 連接字串中。</span><span class="sxs-lookup"><span data-stu-id="adf95-192">Once an availability group listener name is associated with an availability group, it is available to be used in TCP connection strings.</span></span> <span data-ttu-id="adf95-193">透過可用性群組接聽程式名稱支援兩個不同的連接案例。</span><span class="sxs-lookup"><span data-stu-id="adf95-193">Two different connection scenarios are supported through the availability group listener name.</span></span>  
  
    -   <span data-ttu-id="adf95-194">一個確保連接要求一律導向至目前的主要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-194">One insures that connection requests are always directed to the current primary replica.</span></span>  
  
    -   <span data-ttu-id="adf95-195">一個確保連接要求會導向至唯讀的次要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-195">One insures that connection requests are directed to a read-only secondary replica.</span></span>  
  
     <span data-ttu-id="adf95-196">如果用來找出唯讀的次要複本，還必須為可用性群組定義唯讀的路由清單。</span><span class="sxs-lookup"><span data-stu-id="adf95-196">If used to locate a read-only secondary replica, a read-only routing list must also be defined for the availability group.</span></span> <span data-ttu-id="adf95-197">如需可讀取次要複本之路由存取的詳細資訊，請參閱本節稍後的 [若要將可用性複本設定為唯讀路由](../../listeners-client-connectivity-application-failover.md#ConfigureARsForROR)。</span><span class="sxs-lookup"><span data-stu-id="adf95-197">For more information about routing access to readable secondaries, see [To Configure Availability Replicas for Read-Only Routing](../../listeners-client-connectivity-application-failover.md#ConfigureARsForROR).</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="adf95-198">建立可用性群組接聽程式名稱以及用戶端應用程式用它來存取可用性群組資料庫複本時，都會發生一些相關聯的傳播延遲。</span><span class="sxs-lookup"><span data-stu-id="adf95-198">There is some propagation delay associated with the creation of an availability group listener name and its use by client applications to access an availability group database replica.</span></span>  
  
     <span data-ttu-id="adf95-199">請使用下列查詢來判斷是否已針對裝載 CDC 資料庫的可用性群組定義了可用性群組接聽程式名稱。</span><span class="sxs-lookup"><span data-stu-id="adf95-199">Use the following query to determine whether an availability group listener name has been defined for the availability group hosting a CDC database.</span></span> <span data-ttu-id="adf95-200">如果已建立可用性群組接聽程式名稱，查詢會傳回它。</span><span class="sxs-lookup"><span data-stu-id="adf95-200">The query will return the availability group listener name if one has been created.</span></span>  
  
    ```  
    SELECT dns_name   
    FROM sys.availability_group_listeners AS l  
    INNER JOIN sys.availability_databases_cluster AS d  
        ON l.group_id = d.group_id  
    WHERE d.database_name = N'MyCDCDB';  
    ```  
  
-   <span data-ttu-id="adf95-201">**將查詢負載重新導向至可讀取次要複本**</span><span class="sxs-lookup"><span data-stu-id="adf95-201">**Redirecting the Query Load to a Readable Secondary Replica**</span></span>  
  
     <span data-ttu-id="adf95-202">雖然在許多情況下用戶端應用程式一定會要連接到目前的主要複本，但這不是利用 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]的唯一方法。</span><span class="sxs-lookup"><span data-stu-id="adf95-202">While in many cases a client application will always want to connect to the current primary replica that is not the only way to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="adf95-203">如果可用性群組設定為支援可讀取的次要複本，則也可以從次要節點收集變更資料。</span><span class="sxs-lookup"><span data-stu-id="adf95-203">If an availability group is configured to support readable secondary replicas, change data can also be gathered from secondary nodes.</span></span>  
  
     <span data-ttu-id="adf95-204">已設定可用性群組時，與 SECONDARY_ROLE 關聯的 ALLOW_CONNECTIONS 屬性會用來指定支援的次要存取類型。</span><span class="sxs-lookup"><span data-stu-id="adf95-204">When an availability group is configured, the ALLOW_CONNECTIONS attribute associated with the SECONDARY_ROLE is used to specify the type of secondary access supported.</span></span> <span data-ttu-id="adf95-205">如果設定為 ALL，則會允許次要的所有連接，但只有需要唯讀存取的連接會成功。</span><span class="sxs-lookup"><span data-stu-id="adf95-205">If configured as ALL, all connections to the secondary will be allowed, but only those requiring read only access will succeed.</span></span> <span data-ttu-id="adf95-206">如果設定為 READ_ONLY，則需要在建立次要資料庫的連接時指定唯讀意圖，連接才會成功。</span><span class="sxs-lookup"><span data-stu-id="adf95-206">If configured as READ_ONLY, it is necessary to specify read only intent when making the connection to the secondary database in order for the connection to succeed.</span></span> <span data-ttu-id="adf95-207">如需詳細資訊，請參閱 [設定可用性複本上的唯讀存取 &#40;SQL Server&#41;](configure-read-only-access-on-an-availability-replica-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adf95-207">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
     <span data-ttu-id="adf95-208">您可以使用下列查詢，以判斷是否需要唯讀意圖以連接到可讀取次要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-208">The following query can be used to determine whether read-only intent is needed to connect to a readable secondary replica.</span></span>  
  
    ```  
    SELECT g.name AS AG, replica_server_name, secondary_role_allow_connections_desc  
    FROM sys.availability_replicas AS r  
    JOIN sys.availability_groups AS g  
        ON r.group_id = g.group_id  
    WHERE g.name = N'MY_AG_NAME;  
    ```  
  
     <span data-ttu-id="adf95-209">可用性群組接聽程式名稱或明確節點名稱都可用於找出次要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-209">Either the availability group listener name or the explicit node name can be used to locate the secondary replica.</span></span> <span data-ttu-id="adf95-210">如果使用可用性群組接聽程式名稱，則存取會導向至任何合適的次要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-210">If the availability group listener name is used, access will be directed to any suitable secondary replica.</span></span>  
  
     <span data-ttu-id="adf95-211">當 `sp_addlinkedserver` 用來建立連結的伺服器以存取次要複本時， *@datasrc* 參數會用於可用性群組接聽程式名稱或明確伺服器名稱，而 *@provstr* 參數則是用來指定唯讀意圖。</span><span class="sxs-lookup"><span data-stu-id="adf95-211">When `sp_addlinkedserver` is used to create a linked server to access the secondary, the *@datasrc* parameter is used for the availability group listener name or the explicit server name, and the *@provstr* parameter is used to specify read-only intent.</span></span>  
  
    ```  
    EXEC sp_addlinkedserver   
    @server = N'linked_svr',   
    @srvproduct=N'SqlServer',  
    @provider=N'SQLNCLI11',   
    @datasrc=N'AG_Listener_Name',   
    @provstr=N'ApplicationIntent=ReadOnly',   
    @catalog=N'MY_DB_NAME';  
    ```  
  
-   <span data-ttu-id="adf95-212">**CDC 變更資料的用戶端存取和網域登入**</span><span class="sxs-lookup"><span data-stu-id="adf95-212">**Client Access to CDC Change Data and Domain Logins**</span></span>  
  
     <span data-ttu-id="adf95-213">一般而言，若要讓用戶端存取位於 AlwaysOn 可用性群組之成員資料庫的變更資料，您應該使用網域登入。</span><span class="sxs-lookup"><span data-stu-id="adf95-213">In general, you should use domain logins for client access to change data residing in databases that are members of AlwaysOn availability groups.</span></span> <span data-ttu-id="adf95-214">為確保在容錯移轉後持續存取變更資料，網域使用者需要所有支援可用性群組複本之主機的存取權限。</span><span class="sxs-lookup"><span data-stu-id="adf95-214">To insure continued access to change data after failover, the domain user will need access privileges on all of the hosts supporting availability group replicas.</span></span> <span data-ttu-id="adf95-215">如果將資料庫使用者加入至主要複本的資料庫，而此使用者已與網域登入相關聯，則此資料庫使用者會傳播至次要資料庫並繼續與指定的網域登入相關聯。</span><span class="sxs-lookup"><span data-stu-id="adf95-215">If a database user is added to a database in a primary replica, and the user is associated with a domain login, the database user is propagated to secondary databases and continues to be associated with the specified domain login.</span></span> <span data-ttu-id="adf95-216">如果新資料庫使用者與 SQL Server 驗證登入相關聯，則次要資料庫的使用者會傳播但沒有登入。</span><span class="sxs-lookup"><span data-stu-id="adf95-216">If the new database user is associated with a SQL Server authentication login, the user at the secondary databases will be propagated without a login.</span></span> <span data-ttu-id="adf95-217">雖然相關 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 驗證登入可用來存取原本定義資料庫使用者所在之主要資料庫的變更資料，但該節點是唯一可存取的節點。</span><span class="sxs-lookup"><span data-stu-id="adf95-217">While the associated [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] authentication login could be used to access change data at the primary where the database user was originally defined, that node is the only one where access would be possible.</span></span> <span data-ttu-id="adf95-218">此 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 驗證登入無法存取任何次要資料庫的資料，也無法存取資料庫使用者定義所在之原始資料庫以外的任何新主要資料庫的資料。</span><span class="sxs-lookup"><span data-stu-id="adf95-218">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] authentication login would not be able to access data from any secondary database, nor from any new primary databases other than the original database where the database user was defined.</span></span>  
  
###  <a name="change-tracking"></a><a name="CT"></a> <span data-ttu-id="adf95-219">變更追蹤</span><span class="sxs-lookup"><span data-stu-id="adf95-219">Change Tracking</span></span>  
 <span data-ttu-id="adf95-220">啟用變更追蹤 (CT) 的資料庫可以屬於 AlwaysOn 可用性群組的一部分。</span><span class="sxs-lookup"><span data-stu-id="adf95-220">A database enabled for change tracking (CT) can be part of an AlwaysOn availability group.</span></span> <span data-ttu-id="adf95-221">不需要任何其他設定。</span><span class="sxs-lookup"><span data-stu-id="adf95-221">No additional configuration is needed.</span></span> <span data-ttu-id="adf95-222">使用 CDC 資料表值函式 (TVF) 存取變更資料表資料的變更追蹤用戶端應用程式，需要在容錯移轉後找出主要複本的功能。</span><span class="sxs-lookup"><span data-stu-id="adf95-222">Change tracking client applications that use the CDC table-valued functions (TVFs) to access change data will need the ability to locate the primary replica after failover.</span></span> <span data-ttu-id="adf95-223">如果用戶端應用程式透過可用性群組接聽程式名稱進行連接，連接要求一律會適當導向至目前的主要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-223">If the client application connects through the availability group listener name, connection requests will always be appropriately directed to the current primary replica.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="adf95-224">變更追蹤資料必須一律從主要複本取得。</span><span class="sxs-lookup"><span data-stu-id="adf95-224">Change tracking data must always be obtained from the primary replica.</span></span> <span data-ttu-id="adf95-225">嘗試存取次要複本的變更資料會導致下列錯誤：</span><span class="sxs-lookup"><span data-stu-id="adf95-225">An attempt to access change data from a secondary replica will result in the following error:</span></span>  
>   
>  <span data-ttu-id="adf95-226">訊息 22117，層級 16，狀態 1，行 1</span><span class="sxs-lookup"><span data-stu-id="adf95-226">Msg 22117, Level 16, State 1, Line1</span></span>  
>   
>  <span data-ttu-id="adf95-227">次要複本的成員資料庫 (即次要資料庫) 不支援變更追蹤。</span><span class="sxs-lookup"><span data-stu-id="adf95-227">For databases that are members of a secondary replica (that is, for secondary databases), change tracking is not supported.</span></span> <span data-ttu-id="adf95-228">請在主要複本的資料庫上執行變更追蹤查詢。</span><span class="sxs-lookup"><span data-stu-id="adf95-228">Run change tracking queries on the databases in the primary replica.</span></span>  
  
##  <a name="prerequisites-restrictions-and-considerations-for-using-replication"></a><a name="Prereqs"></a> <span data-ttu-id="adf95-229">使用複寫的必要條件、限制和考量</span><span class="sxs-lookup"><span data-stu-id="adf95-229">Prerequisites, Restrictions, and Considerations for Using Replication</span></span>  
 <span data-ttu-id="adf95-230">本節描述使用 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]來部署複寫的考量，包括必要條件、限制和建議。</span><span class="sxs-lookup"><span data-stu-id="adf95-230">This section describes considerations for deploying replication with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], including prerequisites, restrictions, and recommendations.</span></span>  
  
### <a name="prerequisites"></a><span data-ttu-id="adf95-231">必要條件</span><span class="sxs-lookup"><span data-stu-id="adf95-231">Prerequisites</span></span>  
  
-   <span data-ttu-id="adf95-232">當使用異動複寫，而且發行集資料庫是在可用性群組時，發行者和散發者都必須至少執行 [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="adf95-232">When using transactional replication and the publishing database is in an availability group both the publisher and the distributor must run at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span> <span data-ttu-id="adf95-233">訂閱者可以使用較低層級的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="adf95-233">The subscriber can be using a lower level of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="adf95-234">當使用合併式複寫，而且發行集資料庫是在可用性群組時：</span><span class="sxs-lookup"><span data-stu-id="adf95-234">When using merge replication and the publishing database is in an availability group:</span></span>  
  
    -   <span data-ttu-id="adf95-235">發送訂閱：發行者和散發者都必須至少執行 [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="adf95-235">Push subscription: Both the publisher and the distributor must run at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span>  
  
    -   <span data-ttu-id="adf95-236">提取訂閱：發行者、散發者和訂閱者資料庫都必須至少是 [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="adf95-236">Pull subscription: The publisher, distributor, and subscriber databases must be on at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span> <span data-ttu-id="adf95-237">這是因為訂閱者的合併代理程式必須知道可用性群組如何容錯移轉到次要複本。</span><span class="sxs-lookup"><span data-stu-id="adf95-237">This is because the merge agent on the subscriber must understand how an availability group can fail over to its secondary.</span></span>  
  
-   <span data-ttu-id="adf95-238">不支援將散發資料庫放置到可用性群組上。</span><span class="sxs-lookup"><span data-stu-id="adf95-238">Placing the distribution database on an availability group is not supported.</span></span>  
  
-   <span data-ttu-id="adf95-239">發行者執行個體必須滿足參與 AlwaysOn 可用性群組所需的所有必要條件。</span><span class="sxs-lookup"><span data-stu-id="adf95-239">The Publisher instances satisfy all the prerequisites required to participate in an AlwaysOn availability group.</span></span> <span data-ttu-id="adf95-240">如需詳細資訊[，請參閱 AlwaysOn 可用性群組 &#40;SQL Server&#41;的必要條件、限制和建議](prereqs-restrictions-recommendations-always-on-availability.md)。</span><span class="sxs-lookup"><span data-stu-id="adf95-240">For more information see [Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md).</span></span>  
  
### <a name="restrictions"></a><span data-ttu-id="adf95-241">限制</span><span class="sxs-lookup"><span data-stu-id="adf95-241">Restrictions</span></span>  
 <span data-ttu-id="adf95-242">[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]所支援的複寫組合：</span><span class="sxs-lookup"><span data-stu-id="adf95-242">Supported combinations of replication on [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]:</span></span>  
  
|||||  
|-|-|-|-|  
||<span data-ttu-id="adf95-243">**發行者**</span><span class="sxs-lookup"><span data-stu-id="adf95-243">**Publisher**</span></span>|<span data-ttu-id="adf95-244">**Distributor**散發者<sup>3</sup></span><span class="sxs-lookup"><span data-stu-id="adf95-244">**Distributor** <sup>3</sup></span></span>|<span data-ttu-id="adf95-245">**訂閱者**</span><span class="sxs-lookup"><span data-stu-id="adf95-245">**Subscriber**</span></span>|  
|<span data-ttu-id="adf95-246">**異動**</span><span class="sxs-lookup"><span data-stu-id="adf95-246">**Transactional**</span></span>|<span data-ttu-id="adf95-247">是<sup>1</sup></span><span class="sxs-lookup"><span data-stu-id="adf95-247">Yes<sup>1</sup></span></span>|<span data-ttu-id="adf95-248">否</span><span class="sxs-lookup"><span data-stu-id="adf95-248">No</span></span>|<span data-ttu-id="adf95-249">是<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="adf95-249">Yes<sup>2</sup></span></span>|  
|<span data-ttu-id="adf95-250">**P2P**</span><span class="sxs-lookup"><span data-stu-id="adf95-250">**P2P**</span></span>|<span data-ttu-id="adf95-251">否</span><span class="sxs-lookup"><span data-stu-id="adf95-251">No</span></span>|<span data-ttu-id="adf95-252">否</span><span class="sxs-lookup"><span data-stu-id="adf95-252">No</span></span>|<span data-ttu-id="adf95-253">否</span><span class="sxs-lookup"><span data-stu-id="adf95-253">No</span></span>|  
|<span data-ttu-id="adf95-254">**合併式**</span><span class="sxs-lookup"><span data-stu-id="adf95-254">**Merge**</span></span>|<span data-ttu-id="adf95-255">是</span><span class="sxs-lookup"><span data-stu-id="adf95-255">Yes</span></span>|<span data-ttu-id="adf95-256">否</span><span class="sxs-lookup"><span data-stu-id="adf95-256">No</span></span>|<span data-ttu-id="adf95-257">是<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="adf95-257">Yes<sup>2</sup></span></span>|  
|<span data-ttu-id="adf95-258">**快照式**</span><span class="sxs-lookup"><span data-stu-id="adf95-258">**Snapshot**</span></span>|<span data-ttu-id="adf95-259">是</span><span class="sxs-lookup"><span data-stu-id="adf95-259">Yes</span></span>|<span data-ttu-id="adf95-260">否</span><span class="sxs-lookup"><span data-stu-id="adf95-260">No</span></span>|<span data-ttu-id="adf95-261">是<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="adf95-261">Yes<sup>2</sup></span></span>|  
  
 <span data-ttu-id="adf95-262"><sup>1</sup>不包含雙向和相互異動複寫的支援。</span><span class="sxs-lookup"><span data-stu-id="adf95-262"><sup>1</sup> Does not include support for bi-directional and reciprocal transactional replication.</span></span>  
  
 <span data-ttu-id="adf95-263"><sup>2</sup>容錯移轉至複本資料庫是手動程式。</span><span class="sxs-lookup"><span data-stu-id="adf95-263"><sup>2</sup> Failover to the replica database is a manual procedure.</span></span> <span data-ttu-id="adf95-264">沒有提供自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="adf95-264">Automatic failover is not provided.</span></span>  
  
 <span data-ttu-id="adf95-265"><sup>3</sup>散發者資料庫不支援搭配 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 或資料庫鏡像使用。</span><span class="sxs-lookup"><span data-stu-id="adf95-265"><sup>3</sup> The Distributor database is not supported for use with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] or database mirroring.</span></span>  
  
### <a name="considerations"></a><span data-ttu-id="adf95-266">考量</span><span class="sxs-lookup"><span data-stu-id="adf95-266">Considerations</span></span>  
  
-   <span data-ttu-id="adf95-267">散發資料庫不支援搭配 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 或資料庫鏡像使用。</span><span class="sxs-lookup"><span data-stu-id="adf95-267">The distribution database is not supported for use with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] or database mirroring.</span></span> <span data-ttu-id="adf95-268">複寫組態會結合至設定散發者所在的 SQL Server 執行個體。因此，無法鏡像或複寫散發資料庫。</span><span class="sxs-lookup"><span data-stu-id="adf95-268">Replication configuration is coupled to the SQL Server instance where the Distributor is configured; therefore the distribution database cannot be mirrored or replicated.</span></span> <span data-ttu-id="adf95-269">若要針對散發者提供高可用性，請使用 SQL Server 容錯移轉叢集。</span><span class="sxs-lookup"><span data-stu-id="adf95-269">To provide high availability for the Distributor, use a SQL Server failover cluster.</span></span> <span data-ttu-id="adf95-270">如需詳細資訊，請參閱 [AlwaysOn 容錯移轉叢集執行個體 (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adf95-270">For more information, see [AlwaysOn Failover Cluster Instances (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md).</span></span>  
  
-   <span data-ttu-id="adf95-271">雖然支援訂閱者容錯移轉至次要資料庫，不過這是相當複雜的手動程序。</span><span class="sxs-lookup"><span data-stu-id="adf95-271">Subscriber failover to a secondary database, while supported, is a relatively complex manual procedure.</span></span> <span data-ttu-id="adf95-272">此程序基本上與用來容錯移轉鏡像訂閱者資料庫的方法完全相同。</span><span class="sxs-lookup"><span data-stu-id="adf95-272">The procedure is essentially identical to the method used to fail over a mirrored subscriber database.</span></span> <span data-ttu-id="adf95-273">訂閱者必須執行 [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)] 或更新版本，才能參與可用性群組。</span><span class="sxs-lookup"><span data-stu-id="adf95-273">Subscribers must be running [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)] or later to participate in an availability group.</span></span>  
  
-   <span data-ttu-id="adf95-274">存在於資料庫之外的中繼資料和物件不會傳播到次要複本，包括登入、作業、連結的伺服器。</span><span class="sxs-lookup"><span data-stu-id="adf95-274">Metadata and objects that exist outside the database are not propagated to the secondary replicas, including logins, jobs, linked servers.</span></span> <span data-ttu-id="adf95-275">如果您需要在容錯移轉後使用新主要資料庫上的中繼資料和物件，則必須手動加以複製。</span><span class="sxs-lookup"><span data-stu-id="adf95-275">If you require the metadata and objects at the new primary database after failover, you must copy them manually.</span></span> <span data-ttu-id="adf95-276">如需詳細資訊，請參閱 [管理可用性群組之資料庫的登入及工作 &#40;SQL Server&#41;](../../logins-and-jobs-for-availability-group-databases.md)(Failover) 的程序中通常可以互換。</span><span class="sxs-lookup"><span data-stu-id="adf95-276">For more information, see [Management of Logins and Jobs for the Databases of an Availability Group &#40;SQL Server&#41;](../../logins-and-jobs-for-availability-group-databases.md).</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="adf95-277">相關工作</span><span class="sxs-lookup"><span data-stu-id="adf95-277">Related Tasks</span></span>  
 <span data-ttu-id="adf95-278">**複寫**</span><span class="sxs-lookup"><span data-stu-id="adf95-278">**Replication**</span></span>  
  
-   [<span data-ttu-id="adf95-279">設定 AlwaysOn 可用性群組的複寫 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="adf95-279">Configure Replication for AlwaysOn Availability Groups (SQL Server)</span></span>](always-on-availability-groups-sql-server.md)  
  
-   [<span data-ttu-id="adf95-280">維護 AlwaysOn 發行集資料庫 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="adf95-280">Maintaining an AlwaysOn Publication Database &#40;SQL Server&#41;</span></span>](maintaining-an-always-on-publication-database-sql-server.md)  
  
-   [<span data-ttu-id="adf95-281">複寫管理常見問題集</span><span class="sxs-lookup"><span data-stu-id="adf95-281">Replication Administration FAQ</span></span>](../../../relational-databases/replication/administration/frequently-asked-questions-for-replication-administrators.md)  
  
 <span data-ttu-id="adf95-282">**變更資料擷取**</span><span class="sxs-lookup"><span data-stu-id="adf95-282">**Change data capture**</span></span>  
  
-   [<span data-ttu-id="adf95-283">啟用和停用異動資料擷取 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="adf95-283">Enable and Disable Change Data Capture &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server.md)  
  
-   [<span data-ttu-id="adf95-284">管理和監視異動資料擷取 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="adf95-284">Administer and Monitor Change Data Capture &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/administer-and-monitor-change-data-capture-sql-server.md)  
  
-   [<span data-ttu-id="adf95-285">使用異動資料 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="adf95-285">Work with Change Data &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/work-with-change-data-sql-server.md)  
  
 <span data-ttu-id="adf95-286">**Change tracking**</span><span class="sxs-lookup"><span data-stu-id="adf95-286">**Change tracking**</span></span>  
  
-   [<span data-ttu-id="adf95-287">啟用和停用變更追蹤 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="adf95-287">Enable and Disable Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/enable-and-disable-change-tracking-sql-server.md)  
  
-   [<span data-ttu-id="adf95-288">管理變更追蹤 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="adf95-288">Manage Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/manage-change-tracking-sql-server.md)  
  
-   [<span data-ttu-id="adf95-289">使用變更追蹤 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="adf95-289">Work with Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/work-with-change-tracking-sql-server.md)  
  
## <a name="see-also"></a><span data-ttu-id="adf95-290">另請參閱</span><span class="sxs-lookup"><span data-stu-id="adf95-290">See Also</span></span>  
 <span data-ttu-id="adf95-291">[複寫訂閱者及 AlwaysOn 可用性群組 &#40;SQL Server&#41;](replication-subscribers-and-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="adf95-291">[Replication Subscribers and AlwaysOn Availability Groups &#40;SQL Server&#41;](replication-subscribers-and-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="adf95-292">[AlwaysOn 可用性群組 &#40;SQL Server 的必要條件、限制和建議&#41;](prereqs-restrictions-recommendations-always-on-availability.md) </span><span class="sxs-lookup"><span data-stu-id="adf95-292">[Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md) </span></span>  
 <span data-ttu-id="adf95-293">[AlwaysOn 可用性群組 &#40;SQL Server 的總覽&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="adf95-293">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="adf95-294">[AlwaysOn 可用性群組：互通性 (SQL Server) ](always-on-availability-groups-interoperability-sql-server.md) [AlwaysOn 容錯移轉叢集實例 (](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md) SQL Server)  </span><span class="sxs-lookup"><span data-stu-id="adf95-294">[AlwaysOn Availability Groups: Interoperability (SQL Server)](always-on-availability-groups-interoperability-sql-server.md) [AlwaysOn Failover Cluster Instances (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md) </span></span>  
 <span data-ttu-id="adf95-295">[關於異動資料擷取 &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="adf95-295">[About Change Data Capture &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="adf95-296">[關於變更追蹤 &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-tracking-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="adf95-296">[About Change Tracking &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-tracking-sql-server.md) </span></span>  
 <span data-ttu-id="adf95-297">[SQL Server 複寫](../../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="adf95-297">[SQL Server Replication](../../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="adf95-298">[追蹤資料變更 &#40;SQL Server&#41;](../../../relational-databases/track-changes/track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="adf95-298">[Track Data Changes &#40;SQL Server&#41;](../../../relational-databases/track-changes/track-data-changes-sql-server.md) </span></span>  
 [<span data-ttu-id="adf95-299">sys.sp_cdc_add_job &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="adf95-299">sys.sp_cdc_add_job &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql)  
  
  
