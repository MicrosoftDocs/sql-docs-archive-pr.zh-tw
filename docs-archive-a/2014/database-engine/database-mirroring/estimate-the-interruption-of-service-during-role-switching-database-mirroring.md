---
title: 預估角色切換 (資料庫鏡像) 期間的服務中斷 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- parallel redo [SQL Server]
- role switching [SQL Server]
- database mirroring [SQL Server], queues
- failover [SQL Server], database mirroring
- redo [database mirroring]
- database mirroring [SQL Server], failover
ms.assetid: 586a6f25-672b-491b-bc2f-deab2ccda6e2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 283c0dfad8d9f91693ab92ed415b4368dd3f0396
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87592205"
---
# <a name="estimate-the-interruption-of-service-during-role-switching-database-mirroring"></a><span data-ttu-id="fd9ea-102">預估角色切換期間的服務中斷時間 (資料庫鏡像)</span><span class="sxs-lookup"><span data-stu-id="fd9ea-102">Estimate the Interruption of Service During Role Switching (Database Mirroring)</span></span>
  <span data-ttu-id="fd9ea-103">在角色切換期間，資料庫鏡像無法服務的時間量視角色切換類型和角色切換原因而定。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-103">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and the cause of the role switch.</span></span>

-   <span data-ttu-id="fd9ea-104">對於自動容錯移轉，有兩個因素構成服務中斷時間：鏡像伺服器辨識主體伺服器執行個體失敗所需的時間，即錯誤偵測，加上資料庫容錯移轉所需的時間，即容錯移轉時間。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-104">For automatic failover, two factors contribute to the time service is interrupted: the time required for the mirror server to recognize that the principal server instance has failed, that is error detection, plus the time required to fail over the database, that is failover time.</span></span>

-   <span data-ttu-id="fd9ea-105">對於強制服務作業，雖然發生失敗，失敗的偵測和回應視人員回應而定。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-105">For a forced-service operation, though a failure has occurred, detecting and responding to the failure depends on human responsiveness.</span></span> <span data-ttu-id="fd9ea-106">不過，預估可能的服務中斷，僅限於預估發出強制服務命令之後鏡像伺服器切換角色的時間。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-106">However, estimating the potential interruption of service is limited to estimating the time for the mirror server to switch roles after the forced service command is issued.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="fd9ea-107">若要減少偵測特定狀況 (例如某些類型的錯誤) 所需的時間，您可以定義那些狀況的警示。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-107">To reduce the time required to detect specific conditions such as some types of errors, you can define alerts for those conditions.</span></span>

-   <span data-ttu-id="fd9ea-108">若為手動容錯移轉，則只有發出容錯移轉命令之後資料庫容錯移轉所需的時間。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-108">For a manual failover, only the time required to fail over the database after the failover command is issued.</span></span>

## <a name="error-detection"></a><span data-ttu-id="fd9ea-109">錯誤偵測</span><span class="sxs-lookup"><span data-stu-id="fd9ea-109">Error detection</span></span>
 <span data-ttu-id="fd9ea-110">系統注意到錯誤時間取決於錯誤的類型；例如，網路錯誤幾乎會立即注意到，而注意到伺服器沒有回應則需要 10 秒 (預設逾時)。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-110">The time for the system to notice an error depends on the type of error; for example, a network error is noticed almost instantly, while noticing a server that is not responding takes 10 seconds (with the default timeout).</span></span>

 <span data-ttu-id="fd9ea-111">如需在具有自動容錯移轉的高安全性模式下進行資料庫鏡像工作階段以及逾時偵測期間，可能導致失敗之錯誤的資訊，請參閱 [資料庫鏡像期間可能發生的失敗](possible-failures-during-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-111">For information on errors that can cause a failure during a database mirroring session and timeout detection in high-safety mode with automatic failover, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)).</span></span>

## <a name="failover-time"></a><span data-ttu-id="fd9ea-112">容錯移轉時間</span><span class="sxs-lookup"><span data-stu-id="fd9ea-112">Failover time</span></span>
 <span data-ttu-id="fd9ea-113">容錯移轉時間主要包含：先前的鏡像伺服器向前復原其重做佇列中剩餘之所有記錄檔所需的時間，加上其他很短的時間 (如需鏡像伺服器如何處理記錄檔記錄的詳細資訊，請參閱＜[資料庫鏡像 &#40;SQL Server&#41;](database-mirroring-sql-server.md))。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-113">Failover time consists mainly of the time that the former mirror server requires to roll forward any log remaining in its redo queue, plus a short additional time (for more information about how the mirror server processes log records, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span> <span data-ttu-id="fd9ea-114">如需預估容錯移轉時間的詳細資訊，請參閱此主題稍後的「預估容錯移轉重做速率」。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-114">For information on estimating failover time, see Estimating Your Failover Redo Rate, later in this topic.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="fd9ea-115">如果在交易期間建立了索引或資料表之後又變更，而發生容錯移轉，容錯移轉的時間會比平常更久。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-115">If failover occurs during a transaction in which an index or table is created and then changed, failover might take longer than usual.</span></span>  <span data-ttu-id="fd9ea-116">例如，在下列一系列作業期間發生容錯移轉，會增加容錯移轉時間：BEGIN TRANSACTION、在資料表上 CREATE INDEX 和 SELECT INTO 資料表。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-116">For example, failing over during the following series of operations might increase failover time:  BEGIN TRANSACTION, CREATE INDEX on a table, and SELECT INTO the table.</span></span> <span data-ttu-id="fd9ea-117">在這種交易期間，仍有增加容錯移轉時間的可能性，直到以 COMMIT TRANSACTION 或 ROLLBACK TRANSACTION 陳述式完成它為止。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-117">The possibility of increased failover time during such a transaction remains until it is completed with either a COMMIT TRANSACTION or ROLLBACK TRANSACTION statement.</span></span>

### <a name="the-redo-queue"></a><span data-ttu-id="fd9ea-118">重做佇列</span><span class="sxs-lookup"><span data-stu-id="fd9ea-118">The Redo Queue</span></span>
 <span data-ttu-id="fd9ea-119">向前恢復資料庫涉及套用目前在鏡像伺服器上重做佇列中的記錄。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-119">Rolling forward the database involves applying whatever log records are currently in the redo queue on the mirror server.</span></span> <span data-ttu-id="fd9ea-120">「重做佇列」\*\* 包含已寫入鏡像伺服器上的磁碟，但尚未在鏡像資料庫上向前復原的記錄檔記錄。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-120">The *redo queue* consists of the log records that have been written to disk on the mirror server but not yet rolled forward on the mirror database.</span></span>

 <span data-ttu-id="fd9ea-121">資料庫的容錯移轉時間取決於鏡像伺服器向前恢復重做佇列中記錄的速度，而這主要又是由系統硬體與目前工作負載所決定。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-121">Failover time for the database depends on how fast the mirror server can roll forward the log in the redo queue, which, in turn, is determined primarily by the system hardware and the current work load.</span></span> <span data-ttu-id="fd9ea-122">主體資料庫有可能會變得很忙碌，使主體伺服器以比向前恢復記錄檔更快的速度，將記錄檔轉送到鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-122">Potentially, a principal database can become so busy that the principal server ships log to the mirror server much faster than it can roll the log forward.</span></span> <span data-ttu-id="fd9ea-123">在此情況下，當鏡像伺服器向前恢復重做佇列中的記錄時，容錯移轉可能花費很多時間。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-123">In this situation, failover might take significant time while the mirror server rolls forward the log in the redo queue.</span></span> <span data-ttu-id="fd9ea-124">若要了解重做佇列的目前大小，請使用資料庫鏡像效能物件中的 **Redo Queue** 計數器。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-124">To learn the current size of the redo queue, use the **Redo Queue** counter in the database mirroring performance object.</span></span> <span data-ttu-id="fd9ea-125">如需詳細資訊，請參閱 [SQL Server 的 Database Mirroring 物件](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md)。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-125">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

### <a name="estimating-the-failover-redo-rate"></a><span data-ttu-id="fd9ea-126">預估容錯移轉重做速率</span><span class="sxs-lookup"><span data-stu-id="fd9ea-126">Estimating the Failover Redo Rate</span></span>
 <span data-ttu-id="fd9ea-127">您可利用生產資料庫的測試複本，測量向前復原記錄檔記錄所需的時間量 (「重做速率」\*\*)。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-127">You can measure the amount of time required to roll forward log records-the *redo rate*-by using a test copy of the production database.</span></span>

 <span data-ttu-id="fd9ea-128">預估容錯移轉期間之向前恢復時間的方法，取決於重做階段期間鏡像伺服器所使用的執行緒數目。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-128">The method for estimating roll forward time during failover depends on the number of threads the mirror server uses during the redo phase.</span></span> <span data-ttu-id="fd9ea-129">執行緒的數目取決下列：</span><span class="sxs-lookup"><span data-stu-id="fd9ea-129">The number of threads depends on the following:</span></span>

-   <span data-ttu-id="fd9ea-130">在 [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)]中，鏡像伺服器永遠會使用單一執行緒來向前復原資料庫。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], the mirror server always uses a single thread to roll forward the database.</span></span>

-   <span data-ttu-id="fd9ea-131">在 [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)] 中，少於五個 CPU 之電腦上的鏡像伺服器也只會使用單一執行緒。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], mirror servers on computers with fewer than five CPUs also use only a single thread.</span></span> <span data-ttu-id="fd9ea-132">如果有五個以上的 CPU，鏡像伺服器會在容錯移轉期間，將其向前復原作業散發到多個執行緒 (也稱為「平行重做」\*\*)。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-132">With five or more CPUs, a mirror server distributes its roll forward operations among multiple threads during a failover (this is known as *parallel redo*).</span></span> <span data-ttu-id="fd9ea-133">平行重做已完成最佳化，針對每四個 CPU 使用一個執行緒。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-133">Parallel redo is optimized to use one thread for every four CPUs.</span></span>

#### <a name="estimating-the-single-threaded-redo-rate"></a><span data-ttu-id="fd9ea-134">預估單一執行緒的重做速率</span><span class="sxs-lookup"><span data-stu-id="fd9ea-134">Estimating the Single-Threaded Redo Rate</span></span>
 <span data-ttu-id="fd9ea-135">對於單一執行緒重做，在容錯移轉期間向前恢復鏡像資料庫所花費的時間，大約與記錄備份還原要向前恢復相同數量的記錄相同。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-135">For single-threaded redo, roll forward of the mirror database during failover takes approximately the same amount of time as a restore of a log backup takes to roll forward the same amount of log.</span></span> <span data-ttu-id="fd9ea-136">若要預估容錯移轉時間，請在您要執行鏡像的環境中建立測試資料庫。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-136">To estimate failover time, create a test database in the environment under which you intend to run mirroring.</span></span> <span data-ttu-id="fd9ea-137">然後，從實際資料庫中取得記錄備份。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-137">Then take a log backup from the production database.</span></span> <span data-ttu-id="fd9ea-138">若要計算該記錄備份的重做速率，請計時您在測試資料庫上還原記錄備份 WITH NORECOVERY 的時間長度。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-138">To measure the redo rate for that log backup, time how long it takes you to restore the log backup WITH NORECOVERY onto the test database.</span></span>

 <span data-ttu-id="fd9ea-139">一旦您得知鏡像伺服器的重做速率，即可依重做速率在鏡像伺服器上分隔要重做的目前記錄檔數量 (如 **Redo Queue** 效能計數器所測量)，以預估在給定的時間點上容錯移轉資料庫的時間。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-139">Once you know the redo rate of your mirror server, you can estimate the time to fail over the database at a given point in time by dividing the amount of current log to be redone on the mirror (as measured by the **Redo Queue** performance counter) by the redo rate.</span></span> <span data-ttu-id="fd9ea-140">在正常狀況下，如果鏡像伺服器能跟上主體伺服器的負載， **Redo Queue** 會極小或接近零，而容錯移轉只會花費數秒。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-140">Under normal conditions, if the mirror server can keep up with the load from the principal, the **Redo Queue** is small or close to zero, and a failover only takes a few seconds.</span></span>

#### <a name="estimating-the-parallel-redo-rate"></a><span data-ttu-id="fd9ea-141">預估平行重做速率</span><span class="sxs-lookup"><span data-stu-id="fd9ea-141">Estimating the Parallel Redo Rate</span></span>
 <span data-ttu-id="fd9ea-142">在 [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)]中，平行重做已完成最佳化，針對每四個 CPU 使用一個執行緒。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], parallel redo is optimized to use one thread for every four CPUs.</span></span> <span data-ttu-id="fd9ea-143">若要預估平行重做的向前恢復時間，存取執行中測試系統比存取測試資料庫更加精確。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-143">To estimate roll forward time for parallel redo, it is more accurate to access a running test system than a test database.</span></span> <span data-ttu-id="fd9ea-144">在鏡像伺服器上監視重做佇列時，請增加主體伺服器上的負載。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-144">While monitoring the redo queue on the mirror server, increase the load on the principal server.</span></span> <span data-ttu-id="fd9ea-145">在正常作業中，重做佇列會接近零。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-145">In normal operation, the redo queue is close to zero.</span></span> <span data-ttu-id="fd9ea-146">請增加主體伺服器上的負載，直到 Redo Queue 開始持續成長為止；然後系統會在其重做速率的上限，而 **Redo Bytes/sec** 效能計數器此時代表重做速率的上限。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-146">Increase the load on the principal server until the Redo Queue starts to grow continuously; the system is then at its maximum redo rate, and the **Redo Bytes/sec** performance counter at this point represents the maximum redo rate.</span></span> <span data-ttu-id="fd9ea-147">如需詳細資訊，請參閱 [SQL Server 的 Database Mirroring 物件](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md)。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-147">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

## <a name="estimating-interruption-of-service-during-automatic-failover"></a><span data-ttu-id="fd9ea-148">預估自動容錯移轉期間的服務中斷時間</span><span class="sxs-lookup"><span data-stu-id="fd9ea-148">Estimating Interruption of Service During Automatic Failover</span></span>
 <span data-ttu-id="fd9ea-149">下圖說明錯誤偵測與容錯移轉時間，如何構成在 **Partner_B**上完成自動容錯移轉所需的全部時間。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-149">The following figure illustrates how error detection and failover time contribute to the overall time required for an automatic failover to complete on **Partner_B**.</span></span> <span data-ttu-id="fd9ea-150">容錯移轉需要時間以向前恢復資料庫 (重做階段)，再加上少許時間，才能使資料庫上線。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-150">Failover requires time to roll forward the database (the redo phase) plus a small amount of time to bring the database online.</span></span> <span data-ttu-id="fd9ea-151">恢復階段會在新的主體資料庫上線後發生，並在容錯移轉之後繼續作業，其中涉及回復所有未認可的交易。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-151">The undo phase, which involves rolling back any uncommitted transactions, occurs after the new principal database goes online and continues after fail over.</span></span> <span data-ttu-id="fd9ea-152">恢復階段期間可使用資料庫。</span><span class="sxs-lookup"><span data-stu-id="fd9ea-152">The database is available during the undo phase.</span></span>

 <span data-ttu-id="fd9ea-153">![錯誤偵測和容錯移轉時間](../media/dbm-failovauto-time.gif "錯誤偵測和容錯移轉時間")</span><span class="sxs-lookup"><span data-stu-id="fd9ea-153">![Error detection and failover time](../media/dbm-failovauto-time.gif "Error detection and failover time")</span></span>

## <a name="see-also"></a><span data-ttu-id="fd9ea-154">另請參閱</span><span class="sxs-lookup"><span data-stu-id="fd9ea-154">See Also</span></span>
 <span data-ttu-id="fd9ea-155">資料庫[鏡像作業模式](database-mirroring-operating-modes.md)[在資料庫鏡像會話期間切換角色 &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [監視資料庫鏡像 &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="fd9ea-155">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span></span>


