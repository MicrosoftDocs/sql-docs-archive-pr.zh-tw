---
title: 將用戶端連接至資料庫鏡像工作階段 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- partners [SQL Server], connecting clients to
- database mirroring [SQL Server], connecting clients to
- client connections [SQL Server], database mirroring
- connections [SQL Server], database mirroring
ms.assetid: 0d5d2742-2614-43de-9ab9-864addb6299b
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 16faa8d02a22fba3e4cfa4cbe0bd6558fc140fdd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87593578"
---
# <a name="connect-clients-to-a-database-mirroring-session-sql-server"></a><span data-ttu-id="6cc86-102">將用戶端連接至資料庫鏡像工作階段 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="6cc86-102">Connect Clients to a Database Mirroring Session (SQL Server)</span></span>
  <span data-ttu-id="6cc86-103">若要連接至資料庫鏡像工作階段，用戶端可以使用 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client 或 .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="6cc86-103">To connect to a database mirroring session, a client can use either [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client or .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="6cc86-104">針對 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 資料庫設定之後，這兩個資料存取提供者就會完全支援資料庫鏡像。</span><span class="sxs-lookup"><span data-stu-id="6cc86-104">When configured for a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database, these data access providers both fully support database mirroring.</span></span> <span data-ttu-id="6cc86-105">如需使用鏡像資料庫之程式設計考量的詳細資訊，請參閱＜ [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md)＞。</span><span class="sxs-lookup"><span data-stu-id="6cc86-105">For information about programming considerations for using a mirrored database, see [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md).</span></span> <span data-ttu-id="6cc86-106">此外，目前的主體伺服器執行個體必須可以使用，而且必須在此伺服器執行個體上建立用戶端的登入。</span><span class="sxs-lookup"><span data-stu-id="6cc86-106">In addition, the current principal server instance must be available and the login of the client must have been created on the server instance.</span></span> <span data-ttu-id="6cc86-107">如需詳細資訊，請參閱[孤立的使用者疑難排解 &#40;SQL Server&#41;](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-107">For more information, see [Troubleshoot Orphaned Users &#40;SQL Server&#41;](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md).</span></span> <span data-ttu-id="6cc86-108">資料庫鏡像工作階段的用戶端連接不會涉及見證伺服器執行個體 (如果此執行個體存在的話)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-108">Client connections to a database mirroring session do not involve the witness server instance, if one exists.</span></span>  
  
 ##  <a name="making-the-initial-connection-to-a-database-mirroring-session"></a><a name="InitialConnection"></a> <span data-ttu-id="6cc86-109">建立資料庫鏡像工作階段的初始連接</span><span class="sxs-lookup"><span data-stu-id="6cc86-109">Making the Initial Connection to a Database Mirroring Session</span></span>  
 <span data-ttu-id="6cc86-110">為了建立鏡像資料庫的初始連接，用戶端必須提供連接字串，以便至少提供伺服器執行個體的名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-110">For the initial connection to a mirrored database, a client must supply a connection string that minimally supplies the name of a server instance.</span></span> <span data-ttu-id="6cc86-111">這個必要的伺服器名稱應該可識別目前的主體伺服器執行個體，而此名稱就稱為 *「初始夥伴名稱」* 。</span><span class="sxs-lookup"><span data-stu-id="6cc86-111">This required server name should identify the current principal server instance and is known as the *initial partner name*.</span></span>  
  
 <span data-ttu-id="6cc86-112">此外，如果在第一次連接嘗試期間初始夥伴無法使用，連接字串也可以提供另一個伺服器執行個體的名稱 (應該可識別目前的鏡像伺服器執行個體) 以便使用。</span><span class="sxs-lookup"><span data-stu-id="6cc86-112">Optionally, the connection string can also supply the name of another server instance, which should identify the current mirror server instance, for use if the initial partner is unavailable during the first connection attempt.</span></span> <span data-ttu-id="6cc86-113">第二個名稱就稱為 *「容錯移轉夥伴名稱」* 。</span><span class="sxs-lookup"><span data-stu-id="6cc86-113">The second name is known as the *failover partner name*.</span></span>  
  
 <span data-ttu-id="6cc86-114">連接字串還必須提供資料庫名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-114">The connection string must also supply a database name.</span></span> <span data-ttu-id="6cc86-115">這是讓資料存取提供者進行容錯移轉嘗試必要的名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-115">This is necessary to enable failover attempts by the data access provider.</span></span>  
  
 <span data-ttu-id="6cc86-116">接收到連接字串時，資料存取提供者就會將初始夥伴名稱和容錯移轉夥伴名稱 (如果有提供的話) 儲存在用戶端的動態記憶體快取中 (若為 Managed 程式碼，此快取的範圍是應用程式定義域)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-116">On receiving a connection string, the data access provider stores the initial partner name and the failover partner name, if supplied, in a cache in the client's volatile memory (for managed code, the cache is scoped to the application domain).</span></span> <span data-ttu-id="6cc86-117">快取之後，資料存取提供者就不會再更新該初始夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-117">Once cached, the initial partner name is never updated by the data access provider.</span></span> <span data-ttu-id="6cc86-118">當用戶端提供容錯移轉夥伴名稱時，資料存取提供者也會暫時儲存此容錯移轉夥伴名稱，以便在提供者無法使用初始夥伴名稱連接時使用。</span><span class="sxs-lookup"><span data-stu-id="6cc86-118">When the client supplies the failover partner name, the data access provider also stores this failover partner name temporarily in case the provider cannot connect using the initial partner name.</span></span>  
  
 <span data-ttu-id="6cc86-119">資料庫鏡像工作階段無法防止用戶端特有的伺服器存取問題發生，例如用戶端電腦無法與網路進行通訊。</span><span class="sxs-lookup"><span data-stu-id="6cc86-119">A database mirroring session does not protect against server-access problems that are specific to clients, such as when a client computer is having a problems communicating with the network.</span></span> <span data-ttu-id="6cc86-120">鏡像資料庫的連接嘗試可能也會由於各種與資料存取提供者不相關的原因而失敗。例如，連接嘗試可能會因為主體伺服器執行個體非使用中 (當資料庫正在容錯移轉時發生) 或網路錯誤而失敗。</span><span class="sxs-lookup"><span data-stu-id="6cc86-120">A connection attempt to a mirrored database can also fail for a variety of reasons that are unrelated to the data-access provider; for example, a connection attempt can fail because the principal server instance is inactive, as occurs when the database is failing over, or because of a network error.</span></span>  
  
 <span data-ttu-id="6cc86-121">嘗試連接時，資料存取提供者會使用初始夥伴名稱開始。</span><span class="sxs-lookup"><span data-stu-id="6cc86-121">When attempting to connect, the data access provider begins by using the initial partner name.</span></span> <span data-ttu-id="6cc86-122">如果指定的伺服器執行個體可以使用，而且它是目前的主體伺服器執行個體，則連接嘗試通常會成功。</span><span class="sxs-lookup"><span data-stu-id="6cc86-122">If the specified server instance is available and is the current principal server instance, the connection attempt typically succeeds.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-123">如果鏡像工作階段已暫停，用戶端通常會連接至主體伺服器並下載夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-123">If the mirroring session is paused, the client typically connects to the principal server and the downloads the partner name.</span></span> <span data-ttu-id="6cc86-124">不過，在繼續進行鏡像以前，用戶端無法使用資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cc86-124">However, the database is unavailable to the client until mirroring resumes.</span></span>  
  
 <span data-ttu-id="6cc86-125">如果該嘗試沒有用，資料存取提供者就會嘗試容錯移轉夥伴名稱 (如果可用的話)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-125">If that attempt does not work, the data access provider tries the failover partner name, if available.</span></span> <span data-ttu-id="6cc86-126">如果任何一個夥伴名稱可正確識別目前的主體伺服器，資料存取提供者通常就可以順利開啟初始連接。</span><span class="sxs-lookup"><span data-stu-id="6cc86-126">If either partner name correctly identifies the current principal server, the data access provider normally succeeds in opening the initial connection.</span></span> <span data-ttu-id="6cc86-127">完成此連接後，資料存取提供者會下載目前鏡像伺服器的伺服器執行個體名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-127">On completing this connection, the data access provider downloads the server instance name of the current mirror server.</span></span> <span data-ttu-id="6cc86-128">這個名稱會當做容錯移轉夥伴名稱儲存在快取中，並覆寫用戶端提供的容錯移轉夥伴名稱 (如果有的話)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-128">This name is stored in the cache as the failover partner name, overwriting the client-supplied failover partner name, if any.</span></span> <span data-ttu-id="6cc86-129">之後，.NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 就不會更新容錯移轉夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-129">Thereafter, the .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] does not update the failover partner name.</span></span> <span data-ttu-id="6cc86-130">相較之下，每當後續連接或連接重設傳回不同的夥伴名稱時， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client 就會更新快取。</span><span class="sxs-lookup"><span data-stu-id="6cc86-130">In contrast, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client updates the cache whenever a subsequent connection or connection reset returns a different partner name.</span></span>  
  
 <span data-ttu-id="6cc86-131">下圖說明用戶端連接到名為 **Db_1**之鏡像資料庫的初始夥伴 **Partner_A**。</span><span class="sxs-lookup"><span data-stu-id="6cc86-131">The following figure illustrates a client connection to the initial partner, **Partner_A**, for a mirrored database named **Db_1**.</span></span> <span data-ttu-id="6cc86-132">此圖將顯示用戶端提供的初始夥伴名稱可正確識別目前主體伺服器 **Partner_A**。</span><span class="sxs-lookup"><span data-stu-id="6cc86-132">This figure shows a case in which the initial partner name supplied by the client correctly identifies the current principal server, **Partner_A**.</span></span> <span data-ttu-id="6cc86-133">初始連線嘗試成功，而且資料存取提供者將鏡像伺服器的名稱 (目前是 **Partner_B**) 當作容錯移轉夥伴名稱儲存在本機快取中。</span><span class="sxs-lookup"><span data-stu-id="6cc86-133">The initial connection attempt succeeds, and the data access provider stores the name of the mirror server (currently **Partner_B**) as the failover partner name in the local cache.</span></span> <span data-ttu-id="6cc86-134">最後，用戶端連接到 **Db_1** 資料庫的主體複本。</span><span class="sxs-lookup"><span data-stu-id="6cc86-134">Finally, the client connects to the principal copy of the **Db_1** database.</span></span>  
  
 <span data-ttu-id="6cc86-135">![初始夥伴為主體時的用戶端連線](../media/dbm-initial-connection.gif "初始夥伴為主體時的用戶端連線")</span><span class="sxs-lookup"><span data-stu-id="6cc86-135">![Client connection if initial partner is principal](../media/dbm-initial-connection.gif "Client connection if initial partner is principal")</span></span>  
  
 <span data-ttu-id="6cc86-136">例如，初始連接嘗試可能會由於網路錯誤或非使用中的伺服器執行個體而失敗。</span><span class="sxs-lookup"><span data-stu-id="6cc86-136">The initial connection attempt may fail, for example, because of a network error or an inactive server instance.</span></span> <span data-ttu-id="6cc86-137">由於初始夥伴無法使用，資料存取提供者若嘗試連接到容錯移轉夥伴，則用戶端必須在連接字串中提供容錯移轉夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-137">Because the initial partner is unavailable, for the data access provider to attempt to connect to the failover partner, the client must have supplied the failover partner name in the connection string.</span></span>  
  
 <span data-ttu-id="6cc86-138">在該情況下，如果容錯移轉夥伴名稱無法使用，原始的連接嘗試就會繼續進行，直到網路連接逾時或傳回錯誤為止 (只適用於非鏡像資料庫)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-138">In that case, if the failover partner name is unavailable, the original connection attempt continues until the network connection timeout or an error is returned (just as for a non-mirrored database).</span></span>  
  
 <span data-ttu-id="6cc86-139">如果連接字串中已提供容錯移轉夥伴名稱，資料存取提供者的行為就會根據用戶端的網路通訊協定和作業系統而定，如下所示：</span><span class="sxs-lookup"><span data-stu-id="6cc86-139">When the failover partner name is supplied in the connection string, the behavior of the data access provider depends on the network protocol and operating system of the client, as follows:</span></span>  
  
-   <span data-ttu-id="6cc86-140">若為 TCP/IP，連接嘗試就會由資料庫鏡像專用的連接重試演算法進行管制。</span><span class="sxs-lookup"><span data-stu-id="6cc86-140">For TCP/IP, the connection attempts are regulated by a connection retry algorithm that is specific to database mirroring.</span></span> <span data-ttu-id="6cc86-141">「連線重試演算法」會判斷指定連線嘗試中針對開啟連線所分配的最大時間 (「重試時間」)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-141">The *connection retry algorithm* determines the maximum time (the *retry time*) allotted for opening a connection in a given connection attempt.</span></span>  
  
-   <span data-ttu-id="6cc86-142">若為其他網路通訊協定</span><span class="sxs-lookup"><span data-stu-id="6cc86-142">For other network protocols</span></span>  
  
     <span data-ttu-id="6cc86-143">如果發生錯誤或初始夥伴無法使用，初始連接嘗試就會等候直到資料存取提供者的網路連接逾時期限到期，或者登入逾時期限到期為止。</span><span class="sxs-lookup"><span data-stu-id="6cc86-143">If an error occurs or if the initial partner is unavailable, the initial connection attempt waits until the network connection timeout period expires or the login timeout period expires on the data access provider.</span></span> <span data-ttu-id="6cc86-144">一般而言，這項等候是按照 20 至 30 秒的順序進行。</span><span class="sxs-lookup"><span data-stu-id="6cc86-144">Typically, this wait is on the order of 20 to 30 seconds.</span></span> <span data-ttu-id="6cc86-145">之後，如果資料存取提供者尚未逾時，它就會嘗試連接至容錯移轉夥伴。</span><span class="sxs-lookup"><span data-stu-id="6cc86-145">Thereafter, if the data access provider has not timed out, it attempts to connect to the failover partner.</span></span> <span data-ttu-id="6cc86-146">如果連接逾時期限在連接成功之前到期，或容錯移轉夥伴無法使用，連接嘗試就會失敗。</span><span class="sxs-lookup"><span data-stu-id="6cc86-146">If the connection timeout period expires before the connection succeeds or the failover partner is unavailable, the connection attempt fails.</span></span> <span data-ttu-id="6cc86-147">如果容錯移轉夥伴可在登入逾時期限內，而且它目前是主體伺服器，則連接嘗試通常會成功。</span><span class="sxs-lookup"><span data-stu-id="6cc86-147">If failover partner is available within the login timeout period and is now the principal server, the connection attempt normally succeeds.</span></span>  

  
### <a name="connection-strings-for-a-mirrored-database"></a><span data-ttu-id="6cc86-148">鏡像資料庫的連接字串</span><span class="sxs-lookup"><span data-stu-id="6cc86-148">Connection Strings for a Mirrored Database</span></span>  
 <span data-ttu-id="6cc86-149">用戶端提供的連接字串，包含資料存取提供者用來連接資料庫的資訊。</span><span class="sxs-lookup"><span data-stu-id="6cc86-149">The connection string supplied by the client contains information that the data access provider uses to connect to the database.</span></span> <span data-ttu-id="6cc86-150">本章節將討論使用 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC 驅動程式連接來連接至鏡像資料庫時，特別相關的關鍵字。</span><span class="sxs-lookup"><span data-stu-id="6cc86-150">This section discusses the keywords that are specifically relevant for connecting to a mirrored database using a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC Driver Connection.</span></span>  
  
#### <a name="network-attribute"></a><span data-ttu-id="6cc86-151">Network 屬性</span><span class="sxs-lookup"><span data-stu-id="6cc86-151">Network Attribute</span></span>  
 <span data-ttu-id="6cc86-152">連接字串應該包含 **Network** 屬性，以便指定網路通訊協定。</span><span class="sxs-lookup"><span data-stu-id="6cc86-152">The connection string should contain the **Network** attribute to specify the network protocol.</span></span> <span data-ttu-id="6cc86-153">這項屬性可確保在連接至不同的夥伴時，會持續使用指定的網路通訊協定。</span><span class="sxs-lookup"><span data-stu-id="6cc86-153">This ensures that the specified network protocol persists between connections to different partners.</span></span> <span data-ttu-id="6cc86-154">連接至鏡像資料庫的最佳通訊協定是 TCP/IP。</span><span class="sxs-lookup"><span data-stu-id="6cc86-154">The best protocol for connecting to a mirrored database is TCP/IP.</span></span> <span data-ttu-id="6cc86-155">為了確保用戶端會針對夥伴的每個連接要求 TCP/IP，連接字串提供了下列屬性：</span><span class="sxs-lookup"><span data-stu-id="6cc86-155">To ensure that the client requests TCP/IP for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbmssocn;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6cc86-156">我們建議將 TCP/IP 保持在用戶端通訊協定清單的頂端。</span><span class="sxs-lookup"><span data-stu-id="6cc86-156">We recommend keeping TCP/IP at the top of a client's protocol list.</span></span> <span data-ttu-id="6cc86-157">不過，如果連接字串指定了 **Network** 屬性，這就會覆寫清單順序。</span><span class="sxs-lookup"><span data-stu-id="6cc86-157">However, if the connection string specifies the **Network** attribute, this overrides the list order.</span></span>  
  
 <span data-ttu-id="6cc86-158">此外，為了確保用戶端會針對夥伴的每個連接要求具名管道，連接字串提供了下列屬性：</span><span class="sxs-lookup"><span data-stu-id="6cc86-158">Alternatively, to ensure that the client requests named pipes for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbnmpntw;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6cc86-159">由於具名管道不會使用 TCP/IP 重試演算法，所以在許多情況下，具名管道連接嘗試可能會在連接至鏡像資料庫之前逾時。</span><span class="sxs-lookup"><span data-stu-id="6cc86-159">Because named pipes does not use the TCP/IP retry algorithm, in many cases, a named pipes connection attempt may time out before connecting to a mirrored database.</span></span>  
  
#### <a name="server-attribute"></a><span data-ttu-id="6cc86-160">Server 屬性</span><span class="sxs-lookup"><span data-stu-id="6cc86-160">Server Attribute</span></span>  
 <span data-ttu-id="6cc86-161">連接字串必須包含 `Server` 屬性，以便提供初始夥伴名稱 (應該可識別目前的主體伺服器執行個體)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-161">The connection string must contain a `Server` attribute that supplies the initial partner name, which should identify the current principal server instance.</span></span>  
  
 <span data-ttu-id="6cc86-162">識別伺服器執行個體最簡單的方式就是指定名稱： *<伺服器名稱>* [ **\\** <SQL Server 執行個體名稱>]。</span><span class="sxs-lookup"><span data-stu-id="6cc86-162">The simplest way to identify the server instance is by specifying its name , *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span> <span data-ttu-id="6cc86-163">例如：</span><span class="sxs-lookup"><span data-stu-id="6cc86-163">For example:</span></span>  
  
 `Server=Partner_A;`  
  
 <span data-ttu-id="6cc86-164">或</span><span class="sxs-lookup"><span data-stu-id="6cc86-164">or</span></span>  
  
 `Server=Partner_A\Instance_2;`  
  
 <span data-ttu-id="6cc86-165">不過，使用伺服器名稱時，用戶端必須執行 DNS 查閱來取得伺服器的 IP 位址，並執行 SQL Server Browser 查詢來取得夥伴所在之伺服器的通訊埠編號。</span><span class="sxs-lookup"><span data-stu-id="6cc86-165">However, when the system name is used, the client must perform a DNS lookup to obtain the IP address of the server and a SQL Server Browser query to obtain the port number of the server on which the partner resides.</span></span> <span data-ttu-id="6cc86-166">您可以透過在 `Server` 屬性中指定夥伴的 IP 位址和通訊埠編號 (而非指定伺服器名稱)，略過這些查閱和查詢。</span><span class="sxs-lookup"><span data-stu-id="6cc86-166">Those lookups and queries can be bypassed by specifying the IP address and port number of the partner in the `Server` attribute, rather than specifying the server name.</span></span> <span data-ttu-id="6cc86-167">這項建議是為了在連接至該夥伴時將外部延遲的可能性降至最低。</span><span class="sxs-lookup"><span data-stu-id="6cc86-167">This is recommended to minimize the possibility of external delays while connecting to that partner.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-168">如果連接字串指定了具名執行個體的名稱而非通訊埠，SQL Server Browser 查詢就是必要項目。</span><span class="sxs-lookup"><span data-stu-id="6cc86-168">A SQL Server Browser query is necessary if the connection string specifies the named instance name and not the port.</span></span>  
  
 <span data-ttu-id="6cc86-169">若要指定 IP 位址和埠， `Server` 屬性會採用下列格式 `Server=` ： *<ip_address>* `,` *\<port>* ，例如。。</span><span class="sxs-lookup"><span data-stu-id="6cc86-169">To specify the IP address and port, the `Server` attribute takes the following form, `Server=`*<ip_address>*`,`*\<port>*, for example:</span></span>  
  
```  
Server=123.34.45.56,4724;   
```  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-170">此 IP 位址可以是 IP 第 4 版 (IPv4) 或 IP 第 6 版 (IPv6)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-170">The IP address can be IP Version 4 (IPv4) or IP Version 6 (IPv6).</span></span>  
  
#### <a name="database-attribute"></a><span data-ttu-id="6cc86-171">Database 屬性</span><span class="sxs-lookup"><span data-stu-id="6cc86-171">Database Attribute</span></span>  
 <span data-ttu-id="6cc86-172">此外，連接字串必須指定 `Database` 屬性，以便提供鏡像資料庫的名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-172">In addition, the connection string must specify the `Database` attribute to supply the name of the mirrored database.</span></span> <span data-ttu-id="6cc86-173">如果用戶端嘗試連接的資料庫無法使用，就會產生例外狀況。</span><span class="sxs-lookup"><span data-stu-id="6cc86-173">If the database is unavailable when the client attempts to connect, an exception is raised.</span></span>  
  
 <span data-ttu-id="6cc86-174">例如，為了明確連接到主體伺服器 Partner_A 的 **AdventureWorks** 資料庫，用戶端使用了下列連接字串：</span><span class="sxs-lookup"><span data-stu-id="6cc86-174">For example, to expressly connect to the **AdventureWorks** database on the principal server Partner_A, a client uses the following connection string:</span></span>  
  
 `" Server=Partner_A; Database=AdventureWorks "`  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-175">此字串省略了驗證資訊。</span><span class="sxs-lookup"><span data-stu-id="6cc86-175">This string omits authentication information.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6cc86-176">將通訊協定前置詞與 `Server` 屬性結合 (`Server=tcp:` *\<servername>*) 與**Network**屬性不相容，而且在兩個位置指定通訊協定可能會導致錯誤。</span><span class="sxs-lookup"><span data-stu-id="6cc86-176">Bundling the protocol prefix with the `Server` attribute (`Server=tcp:`*\<servername>*) is incompatible with the **Network** attribute, and specifying the protocol in both places will likely result in an error.</span></span> <span data-ttu-id="6cc86-177">因此，我們建議連接字串使用**Network**屬性來指定通訊協定，並且只在 `Server` 屬性 () 中指定伺服器名稱 `"Network=dbmssocn; Server=` *\<servername>* `"` 。</span><span class="sxs-lookup"><span data-stu-id="6cc86-177">Therefore, we recommend that a connection string specify the protocol using the **Network** attribute and specify only the server name in the `Server` attribute (`"Network=dbmssocn; Server=`*\<servername>*`"`).</span></span>  
  
#### <a name="failover-partner-attribute"></a><span data-ttu-id="6cc86-178">Failover Partner 屬性</span><span class="sxs-lookup"><span data-stu-id="6cc86-178">Failover Partner Attribute</span></span>  
 <span data-ttu-id="6cc86-179">除了初始夥伴名稱以外，用戶端也可以指定容錯移轉夥伴名稱 (應該可識別目前的鏡像伺服器執行個體)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-179">In addition to the initial partner name, the client can also specify failover partner name, which should identify the current mirror server instance.</span></span> <span data-ttu-id="6cc86-180">容錯移轉夥伴是由 Failover Partner 屬性的其中一個關鍵字指定的。</span><span class="sxs-lookup"><span data-stu-id="6cc86-180">The failover partner is specified by one of the keywords for the failover partner attribute.</span></span> <span data-ttu-id="6cc86-181">這個屬性的關鍵字會因您所使用的 API 而不同。</span><span class="sxs-lookup"><span data-stu-id="6cc86-181">The keyword for this attribute depends on the API that you are using.</span></span> <span data-ttu-id="6cc86-182">下表將列出這些關鍵字：</span><span class="sxs-lookup"><span data-stu-id="6cc86-182">The following table lists these keywords:</span></span>  
  
|<span data-ttu-id="6cc86-183">API</span><span class="sxs-lookup"><span data-stu-id="6cc86-183">API</span></span>|<span data-ttu-id="6cc86-184">Failover Partner 屬性的關鍵字</span><span class="sxs-lookup"><span data-stu-id="6cc86-184">Keyword for failover partner attribute</span></span>|  
|---------|--------------------------------------------|  
|<span data-ttu-id="6cc86-185">OLE DB 提供者</span><span class="sxs-lookup"><span data-stu-id="6cc86-185">OLE DB Provider</span></span>|`FailoverPartner`|  
|<span data-ttu-id="6cc86-186">ODBC 驅動程式</span><span class="sxs-lookup"><span data-stu-id="6cc86-186">ODBC Driver</span></span>|`Failover_Partner`|  
|<span data-ttu-id="6cc86-187">ActiveX Data Objects (ADO)</span><span class="sxs-lookup"><span data-stu-id="6cc86-187">ActiveX Data Objects (ADO)</span></span>|`Failover Partner`|  
  
 <span data-ttu-id="6cc86-188">識別伺服器執行個體最簡單的方式就是指定其系統名稱：<伺服器名稱>[ **\\** <SQL Server 執行個體名稱>]。</span><span class="sxs-lookup"><span data-stu-id="6cc86-188">The simplest way to identify the server instance is by its system name, *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span>  
  
 <span data-ttu-id="6cc86-189">此外，您可以在 `Failover Partner` 屬性中提供 IP 位址和通訊埠編號。</span><span class="sxs-lookup"><span data-stu-id="6cc86-189">Alternatively, the IP address and port number can be supplied in the `Failover Partner` attribute.</span></span> <span data-ttu-id="6cc86-190">如果第一次連接至資料庫時，初始連接嘗試失敗，連接至容錯移轉夥伴的嘗試將不再仰賴 DNS 和 SQL Server Browser。</span><span class="sxs-lookup"><span data-stu-id="6cc86-190">If the initial connection attempt fails during the first connection to the database, the attempt to connect to the failover partner will be freed from relying on DNS and SQL Server Browser.</span></span> <span data-ttu-id="6cc86-191">建立連接後，就會以容錯移轉夥伴名稱覆寫容錯移轉夥伴名稱，因此當容錯移轉發生時，重新導向的連接就會需要 DNS 和 SQL Server Browser。</span><span class="sxs-lookup"><span data-stu-id="6cc86-191">Once a connection is established, the failover partner name will be overwritten with the failover partner name, so if a failover occurs, the redirected connections will require DNS and SQL Server Browser.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-192">只有提供初始夥伴名稱時，除了重新連接的相關動作或程式碼以外，應用程式開發人員不需要採取任何動作或寫入任何程式碼。</span><span class="sxs-lookup"><span data-stu-id="6cc86-192">When only the initial partner name is provided, application developers do not need to take any action or write any code except about how to reconnect.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-193">Managed 程式碼應用程式開發人員要在 `ConnectionString` 物件的 `SqlConnection` 中提供容錯移轉夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-193">Managed code application developers supply the failover partner name in the `ConnectionString` of the `SqlConnection` object.</span></span> <span data-ttu-id="6cc86-194">如需使用此連接字串的詳細資訊，請參閱 ADO.NET 文件中的＜.NET Framework Data Provider 對於 SQL Server 的資料庫鏡像支援＞，其是 [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK 的一部份。</span><span class="sxs-lookup"><span data-stu-id="6cc86-194">For information on using this connection string, see "Database Mirroring Support in the .NET Framework Data Provider for SQL Server" in the ADO.NET documentation, which is part of the [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK.</span></span>  
  
#### <a name="example-connection-string"></a><span data-ttu-id="6cc86-195">連接字串範例</span><span class="sxs-lookup"><span data-stu-id="6cc86-195">Example Connection String</span></span>  
 <span data-ttu-id="6cc86-196">例如，為了使用 TCP/IP 明確連接到 Partner_A 或 Partner_B 的 **AdventureWorks** 資料庫，使用 ODBC 驅動程式的用戶端應用程式可能會提供下列連接字串：</span><span class="sxs-lookup"><span data-stu-id="6cc86-196">For example, to explicitly connect using TCP/IP to the **AdventureWorks** database on either Partner_A or Partner_B, a client application that uses the ODBC Driver could supply the following connection string:</span></span>  
  
```  
"Server=Partner_A; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
 <span data-ttu-id="6cc86-197">或者，用戶端可能會使用 IP 位址和通訊埠編號來識別初始夥伴 Partner_A。例如，如果 IP 位址是 250.65.43.21 而通訊埠編號是 4734，連接字串就會是：</span><span class="sxs-lookup"><span data-stu-id="6cc86-197">Alternatively, the client could use the IP address and port number to identify the initial partner, Partner_A; for example, if the IP address is 250.65.43.21 and the port number is 4734, the connection string would be:</span></span>  
  
```  
"Server=250.65.43.21,4734; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
##  <a name="connection-retry-algorithm-for-tcpip-connections"></a><a name="RetryAlgorithm"></a> <span data-ttu-id="6cc86-198">連接重試演算法 (TCP/IP 連接)</span><span class="sxs-lookup"><span data-stu-id="6cc86-198">Connection Retry Algorithm (for TCP/IP Connections)</span></span>  
 <span data-ttu-id="6cc86-199">就 TCP/IP 連接而言，當兩個夥伴名稱都位於快取中時，資料存取提供者就會遵守連接重試演算法。</span><span class="sxs-lookup"><span data-stu-id="6cc86-199">For a TCP/IP connection, when both partner names are in the cache, the data access provider adheres to a connection retry algorithm.</span></span> <span data-ttu-id="6cc86-200">這在建立工作階段的初始連接以及失去已建立連接之後重新連接的情況都適用。</span><span class="sxs-lookup"><span data-stu-id="6cc86-200">This is true both for making the initial connection to the session and for reconnecting after losing an established connection.</span></span> <span data-ttu-id="6cc86-201">一旦開啟連接後，完成預先登入和登入步驟就會需要額外時間。</span><span class="sxs-lookup"><span data-stu-id="6cc86-201">Once a connection has been opened, completing the pre-login and login steps takes additional time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-202">開啟連接所用的時間可能會由於外部因素而超過重試時間，這些因素包括 DNS 查閱速度很慢、網域控制站/Kerberos 金鑰發佈中心 (KDC) 速度很慢、連絡 SQL Server Browser 所用的時間以及網路壅塞等。</span><span class="sxs-lookup"><span data-stu-id="6cc86-202">The time spent in opening a connection can exceed the retry time because of external factors, such as slow DNS lookups, slow domain controller/Kerberos Key Distribution Center (KDC), time spent contacting SQL Server Browser, network congestion, and so forth.</span></span> <span data-ttu-id="6cc86-203">這些外部因素可能會讓用戶端無法連接至鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cc86-203">Such external factors can prevent a client from connecting to a mirrored database.</span></span> <span data-ttu-id="6cc86-204">此外，外部因素也會導致開啟連接所用的時間比分配的重試時間要長。</span><span class="sxs-lookup"><span data-stu-id="6cc86-204">Also, external factors can cause a connection to take longer to open than the allotted retry time.</span></span> <span data-ttu-id="6cc86-205">如需有關針對初始夥伴的連接嘗試略過 DNS 和 SQL Server Browser 的詳細資訊，請參閱本主題稍早的 [建立資料庫鏡像工作階段的初始連接](#InitialConnection)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-205">For information on bypassing DNS and SQL Server Browser for connection attempt to the initial partner, see [Making the Initial Connection to a Database Mirroring Session](#InitialConnection), earlier in this topic.</span></span>  
  
 <span data-ttu-id="6cc86-206">如果連接嘗試失敗或在成功之前重試時間過期，資料存取提供者就會嘗試其他夥伴。</span><span class="sxs-lookup"><span data-stu-id="6cc86-206">If a connection attempt fails or the retry time expires before it succeeds, the data access provider tries the other partner.</span></span> <span data-ttu-id="6cc86-207">如果在此時間點以前未開啟連接，提供者就會輪流嘗試初始和容錯移轉夥伴名稱，直到開啟連接或登入期限逾時為止。預設登入逾時期限是 15 秒。</span><span class="sxs-lookup"><span data-stu-id="6cc86-207">If a connection is not opened by this point, the provider alternately tries the initial and failover partner names, until a connection is opened or the login period times out. The default login time-out period is 15 seconds.</span></span> <span data-ttu-id="6cc86-208">我們建議登入逾時期限至少應該設定為 5 秒。</span><span class="sxs-lookup"><span data-stu-id="6cc86-208">We recommend that the login time-out period be at least 5 seconds.</span></span> <span data-ttu-id="6cc86-209">指定更小的逾時期限可能會讓所有連接嘗試無法成功。</span><span class="sxs-lookup"><span data-stu-id="6cc86-209">Specifying a smaller time-out period might prevent any of the connection attempts from succeeding.</span></span>  
  
 <span data-ttu-id="6cc86-210">重試時間是登入期限的百分比。</span><span class="sxs-lookup"><span data-stu-id="6cc86-210">The retry time is a percentage of the login period.</span></span> <span data-ttu-id="6cc86-211">連接嘗試的重試時間在每個後續的重試回合都會更長。</span><span class="sxs-lookup"><span data-stu-id="6cc86-211">The retry time for a connection attempt is larger in each successive round.</span></span> <span data-ttu-id="6cc86-212">在第一個重試回合中，兩次嘗試的重試時間都是總登入期限的百分之 8。</span><span class="sxs-lookup"><span data-stu-id="6cc86-212">In the first round, the retry time for each of the two attempts is 8 percent of the total login period.</span></span> <span data-ttu-id="6cc86-213">在每個後續的重試回合中，重試演算法會以相同的時間量，增加最大重試時間。</span><span class="sxs-lookup"><span data-stu-id="6cc86-213">In each successive round, the retry algorithm increases the maximum retry time by the same amount.</span></span> <span data-ttu-id="6cc86-214">因此，前八個連接嘗試的重試時間如下：</span><span class="sxs-lookup"><span data-stu-id="6cc86-214">Thus, the retry times for the first eight connection attempts is as follows:</span></span>  
  
 <span data-ttu-id="6cc86-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span><span class="sxs-lookup"><span data-stu-id="6cc86-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span></span>  
  
 <span data-ttu-id="6cc86-216">重試時間是使用下列公式計算的：</span><span class="sxs-lookup"><span data-stu-id="6cc86-216">The retry time is calculated using the following formula:</span></span>  
  
 <span data-ttu-id="6cc86-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;** _LoginTimeout_ **)**</span><span class="sxs-lookup"><span data-stu-id="6cc86-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;**_LoginTimeout_**)**</span></span>  
  
 <span data-ttu-id="6cc86-218">其中 *PreviousRetryTime* 最初是 0。</span><span class="sxs-lookup"><span data-stu-id="6cc86-218">Where *PreviousRetryTime* is initially 0.</span></span>  
  
 <span data-ttu-id="6cc86-219">例如，如果使用預設登入逾時期限 15 秒，*LoginTimeout* *= 15*。</span><span class="sxs-lookup"><span data-stu-id="6cc86-219">For example, if using the default login time-out period of 15 seconds, *LoginTimeout* *= 15*.</span></span> <span data-ttu-id="6cc86-220">在此情況下，前三個重試回合中分配的重試時間如下：</span><span class="sxs-lookup"><span data-stu-id="6cc86-220">In this case, the retry times allotted in the first three rounds are as follows:</span></span>  
  
|<span data-ttu-id="6cc86-221">Round</span><span class="sxs-lookup"><span data-stu-id="6cc86-221">Round</span></span>|<span data-ttu-id="6cc86-222">*RetryTime* 計算</span><span class="sxs-lookup"><span data-stu-id="6cc86-222">*RetryTime* calculation</span></span>|<span data-ttu-id="6cc86-223">每次嘗試的重試時間</span><span class="sxs-lookup"><span data-stu-id="6cc86-223">Retry time per attempt</span></span>|  
|-----------|-----------------------------|----------------------------|  
|<span data-ttu-id="6cc86-224">1</span><span class="sxs-lookup"><span data-stu-id="6cc86-224">1</span></span>|<span data-ttu-id="6cc86-225">0 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="6cc86-225">0 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="6cc86-226">1.2 秒</span><span class="sxs-lookup"><span data-stu-id="6cc86-226">1.2 seconds</span></span>|  
|<span data-ttu-id="6cc86-227">2</span><span class="sxs-lookup"><span data-stu-id="6cc86-227">2</span></span>|<span data-ttu-id="6cc86-228">1.2 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="6cc86-228">1.2 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="6cc86-229">2.4 秒</span><span class="sxs-lookup"><span data-stu-id="6cc86-229">2.4 seconds</span></span>|  
|<span data-ttu-id="6cc86-230">3</span><span class="sxs-lookup"><span data-stu-id="6cc86-230">3</span></span>|<span data-ttu-id="6cc86-231">2.4 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="6cc86-231">2.4 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="6cc86-232">3.6 秒</span><span class="sxs-lookup"><span data-stu-id="6cc86-232">3.6 seconds</span></span>|  
|<span data-ttu-id="6cc86-233">4</span><span class="sxs-lookup"><span data-stu-id="6cc86-233">4</span></span>|<span data-ttu-id="6cc86-234">3.6 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="6cc86-234">3.6 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="6cc86-235">4.8 秒</span><span class="sxs-lookup"><span data-stu-id="6cc86-235">4.8 seconds</span></span>|   
  
 <span data-ttu-id="6cc86-236">下圖將說明後續連接嘗試的這些重試時間，而且每次嘗試都逾時。</span><span class="sxs-lookup"><span data-stu-id="6cc86-236">The following figure illustrates these retry times for successive connection attempts, each of which times out.</span></span>  
  
 <span data-ttu-id="6cc86-237">![15 秒登入逾時的最大重試延遲](../media/dbm-retry-algorithm.gif "15 秒登入逾時的最大重試延遲")</span><span class="sxs-lookup"><span data-stu-id="6cc86-237">![Maximum retry delays for 15 second login timeout](../media/dbm-retry-algorithm.gif "Maximum retry delays for 15 second login timeout")</span></span>  
  
 <span data-ttu-id="6cc86-238">就預設的登入逾時期限而言，分配給連接嘗試之前三個重試回合的最大時間是 14.4 秒。</span><span class="sxs-lookup"><span data-stu-id="6cc86-238">For the default login time-out period, the maximum time allotted to the first three rounds of connection attempts is 14.4 seconds.</span></span> <span data-ttu-id="6cc86-239">如果每次嘗試都使用所有分配的時間，在登入期限逾時之前，只會剩餘 0.6 秒的時間。在該情況下，第四個重試回合會縮短，僅允許使用初始夥伴名稱來進行最後一次快速連接嘗試。</span><span class="sxs-lookup"><span data-stu-id="6cc86-239">If every attempt were to use all of its allotted time, only 0.6 seconds of time would remain before the login period times out. In that case, the fourth round would be curtailed, allowing only a final quick attempt to connect using the initial partner name.</span></span> <span data-ttu-id="6cc86-240">不過，在少於分配之重試時間的情況下，連接嘗試可能會失敗，尤其是後面的重試回合。</span><span class="sxs-lookup"><span data-stu-id="6cc86-240">However, a connection attempt may fail in less than its allotted retry time, particularly in later rounds.</span></span> <span data-ttu-id="6cc86-241">例如，收到網路錯誤可能會導致嘗試在重試時間過期之前結束。</span><span class="sxs-lookup"><span data-stu-id="6cc86-241">For example, receiving a network error can cause an attempt to end before the retry time expires.</span></span> <span data-ttu-id="6cc86-242">如果之前的嘗試由於網路錯誤而失敗，就會有額外的時間可供第四個重試回合使用，甚至供其他重試回合使用。</span><span class="sxs-lookup"><span data-stu-id="6cc86-242">If earlier attempts fail due to a network error, additional time would be available for the fourth round and, perhaps, additional rounds.</span></span>  
  
 <span data-ttu-id="6cc86-243">另一個導致嘗試失敗的原因是非使用中的伺服器執行個體，而這會在伺服器執行個體正在進行資料庫的容錯移轉時發生。</span><span class="sxs-lookup"><span data-stu-id="6cc86-243">Another cause of a failed attempt is an inactive server instance, as occurs when a server instance is engaged in failing over its database.</span></span> <span data-ttu-id="6cc86-244">在此情況下，會加上重試延遲，以防止用戶端進行快速且連續的連接嘗試而導致夥伴超過負載。</span><span class="sxs-lookup"><span data-stu-id="6cc86-244">In this case, a retry delay is imposed to prevent clients from overloading the partners with a rapid succession of connection attempts.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-245">當兩個夥伴名稱都可以使用時，如果登入逾時期限是無限的，用戶端就會無限期地嘗試重新連接至伺服器 (在初始夥伴名稱和容錯移轉夥伴名稱之間輪流)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-245">When both partner names are available, if the login time-out period is infinite, the client attempts to reconnect to the servers indefinitely, alternating between the initial partner name and the failover partner name.</span></span>  
<span data-ttu-id="6cc86-246">)</span><span class="sxs-lookup"><span data-stu-id="6cc86-246">)</span></span>  
  
### <a name="retry-delays-during-failover"></a><span data-ttu-id="6cc86-247">在容錯移轉期間的重試延遲</span><span class="sxs-lookup"><span data-stu-id="6cc86-247">Retry Delays During Failover</span></span>  
 <span data-ttu-id="6cc86-248">如果用戶端嘗試連接至正在容錯移轉的夥伴，此夥伴就會立即回應，表示它目前非使用中。</span><span class="sxs-lookup"><span data-stu-id="6cc86-248">If a client attempts to connect to a partner that is failing over, the partner immediately responds that it is inactive.</span></span> <span data-ttu-id="6cc86-249">在此情況下，每個連接嘗試的重試回合都會比分配的重試時間要短。</span><span class="sxs-lookup"><span data-stu-id="6cc86-249">In this case, each round of connection attempts are much briefer than the allotted retry time.</span></span> <span data-ttu-id="6cc86-250">這表示連接嘗試的許多重試回合可以在登入期限逾時之前進行。為了避免在容錯移轉期間因快速且連續的連接嘗試而導致夥伴超過負載，資料存取提供者會在每個重試循環後面加入一個短暫的重試延遲。</span><span class="sxs-lookup"><span data-stu-id="6cc86-250">This means that many rounds of connection attempts could happen before the login period times out. To avoid overloading the partners with a rapid series of connection attempts during a failover, the data access provider adds a brief retry delay after each retry cycle.</span></span> <span data-ttu-id="6cc86-251">指定重試延遲的長度是由重試延遲演算法決定的。</span><span class="sxs-lookup"><span data-stu-id="6cc86-251">The length of a given retry delay is determined by the retry-delay algorithm.</span></span> <span data-ttu-id="6cc86-252">在第一個重試回合之後，延遲是 100 毫秒。</span><span class="sxs-lookup"><span data-stu-id="6cc86-252">After the first round, the delay is 100 milliseconds.</span></span> <span data-ttu-id="6cc86-253">在後面三個回合之後，重試延遲便加倍至 200、400 和 800。</span><span class="sxs-lookup"><span data-stu-id="6cc86-253">After each of the next three rounds, the retry delay doubles-to 200, 400, and 800.</span></span> <span data-ttu-id="6cc86-254">在所有後續的重試回合中，重試延遲是 1 秒，直到連接嘗試成功或逾時為止。</span><span class="sxs-lookup"><span data-stu-id="6cc86-254">For all later rounds, the retry delay is 1 second until the connection attempt succeeds or times out.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-255">如果伺服器執行個體停止，連接要求就會立即失敗。</span><span class="sxs-lookup"><span data-stu-id="6cc86-255">If the server instance is stopped, then the connection request fails immediately.</span></span>  
  
 <span data-ttu-id="6cc86-256">下圖將說明在手動容錯移轉時，重試延遲如何影響連接嘗試，其中夥伴會切換角色。</span><span class="sxs-lookup"><span data-stu-id="6cc86-256">The following figure illustrates how the retry delay affects connection attempts during a manual failover, in which the partners switch their roles.</span></span> <span data-ttu-id="6cc86-257">登入逾時期限是 15 秒。</span><span class="sxs-lookup"><span data-stu-id="6cc86-257">The login time-out period is 15 seconds.</span></span>  
  
 <span data-ttu-id="6cc86-258">![重試延遲演算法](../media/dbm-retry-delay-algorithm.gif "重試延遲演算法")</span><span class="sxs-lookup"><span data-stu-id="6cc86-258">![Retry-delay algorithm](../media/dbm-retry-delay-algorithm.gif "Retry-delay algorithm")</span></span>  
  
##  <a name="reconnecting-to-a-database-mirroring-session"></a><a name="Reconnecting"></a> <span data-ttu-id="6cc86-259">重新連接至資料庫鏡像工作階段</span><span class="sxs-lookup"><span data-stu-id="6cc86-259">Reconnecting to a Database Mirroring Session</span></span>  
 <span data-ttu-id="6cc86-260">如果資料庫鏡像工作階段的已建立連接由於任何原因而失敗 (例如，由於資料庫鏡像容錯移轉)，而且應用程式嘗試重新連接至初始伺服器時，資料存取提供者就可以使用儲存在用戶端快取中的容錯移轉夥伴名稱，嘗試重新連接。</span><span class="sxs-lookup"><span data-stu-id="6cc86-260">If an established connection to a database mirroring session fails for any reason, for example, due to a database mirroring failover, and the application attempts to reconnect to the initial server, the data access provider can attempt to reconnect using the failover partner name stored in the client's cache.</span></span> <span data-ttu-id="6cc86-261">不過，重新連接不會自動進行。</span><span class="sxs-lookup"><span data-stu-id="6cc86-261">Reconnecting is not automatic, however.</span></span> <span data-ttu-id="6cc86-262">應用程式必須注意這項錯誤。</span><span class="sxs-lookup"><span data-stu-id="6cc86-262">The application must become aware of the error.</span></span> <span data-ttu-id="6cc86-263">然後，應用程式必須關閉失敗的連接，並使用相同的連接字串屬性來開啟新連接。</span><span class="sxs-lookup"><span data-stu-id="6cc86-263">Then, the application needs to close the failed connection and open a new connection using the same connection string attributes.</span></span> <span data-ttu-id="6cc86-264">此時，資料存取提供者會將連接重新導向至容錯移轉夥伴。</span><span class="sxs-lookup"><span data-stu-id="6cc86-264">At this point, the data access provider redirects the connection to the failover partner.</span></span> <span data-ttu-id="6cc86-265">如果以這個名稱識別的伺服器執行個體目前是主體伺服器，連接嘗試通常會成功。</span><span class="sxs-lookup"><span data-stu-id="6cc86-265">If the server instance identified by this name is currently the principal server, the connection attempt usually succeeds.</span></span> <span data-ttu-id="6cc86-266">如果交易已認可或已回復並不明確，應用程式必須檢查交易的狀態，方法就與重新連接至獨立的伺服器執行個體一樣。</span><span class="sxs-lookup"><span data-stu-id="6cc86-266">If it is unclear whether a transaction was committed or rolled back, the application must check on the state of the transaction, in the same way as when reconnecting to a stand-alone server instance.</span></span>  
  
 <span data-ttu-id="6cc86-267">重新連接很類似連接字串提供容錯移轉夥伴名稱的初始連接。</span><span class="sxs-lookup"><span data-stu-id="6cc86-267">Reconnecting resembles an initial connection for which the connection string supplied a failover partner name.</span></span> <span data-ttu-id="6cc86-268">如果第一個連接嘗試失敗，連接嘗試就會在初始夥伴名稱和容錯移轉夥伴名稱之間輪流，直到用戶端連接至主體伺服器或者資料存取提供者逾時為止。</span><span class="sxs-lookup"><span data-stu-id="6cc86-268">If the first connection attempt fails, connection attempts alternate back and forth between the initial partner name and failover partner name until either the client connects to the  principal server or the data access provider times out.</span></span>  
  
> [!NOTE]  
>  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="6cc86-269">Native Client 會驗證是否連接至主體伺服器執行個體，但不會驗證此執行個體是否為連接字串之初始夥伴名稱中指定的伺服器執行個體夥伴。</span><span class="sxs-lookup"><span data-stu-id="6cc86-269">Native Client verifies that it connects to a principal server instance but not whether this instance is the partner of server instance specified in the initial partner name of the connection string.</span></span>  
  
 <span data-ttu-id="6cc86-270">如果連接使用 TCP/IP，連接重試演算法就會決定每個重試回合中分配給連接嘗試的時間量。</span><span class="sxs-lookup"><span data-stu-id="6cc86-270">If the connections use TCP/IP, the connection retry algorithm determines the amount of time allotted to the connection attempts in each round.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6cc86-271">如果用戶端與資料庫中斷連接，資料存取提供者就不會嘗試重新連接。</span><span class="sxs-lookup"><span data-stu-id="6cc86-271">If the client gets disconnected from the database, the data access provider does not attempt to reconnect.</span></span> <span data-ttu-id="6cc86-272">用戶端必須發出新的連接要求。</span><span class="sxs-lookup"><span data-stu-id="6cc86-272">The client must issue a new connection request.</span></span> <span data-ttu-id="6cc86-273">此外，如果應用程式在失去連接時關閉，它將失去快取的夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-273">Also, if an application shuts down on losing the connection, it will lose the cached partner names.</span></span> <span data-ttu-id="6cc86-274">如果因為主體伺服器無法使用而失去連接，則應用程式可以重新連接到鏡像伺服器的唯一方式，就是在其連接字串中提供容錯移轉夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-274">If the connection was lost because the principal server became unavailable, the only way that the application can reconnect to the mirror server is by supplying the failover partner name in its connection string.</span></span>  
  
  
### <a name="impact-of-redirection-on-a-client-application"></a><span data-ttu-id="6cc86-275">重新導向對用戶端應用程式的影響</span><span class="sxs-lookup"><span data-stu-id="6cc86-275">Impact of Redirection on a Client Application</span></span>  
 <span data-ttu-id="6cc86-276">在容錯移轉之後，資料存取提供者會將連接重新導向至目前的主體伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="6cc86-276">After a failover, the data access provider redirects the connection to the current principal server instance.</span></span> <span data-ttu-id="6cc86-277">不過，重新導向對用戶端而言是透明的。</span><span class="sxs-lookup"><span data-stu-id="6cc86-277">However, the redirection is transparent to clients.</span></span> <span data-ttu-id="6cc86-278">對於用戶端而言，重新導向的連接會呈現為初始夥伴名稱所識別之伺服器執行個體的連接。</span><span class="sxs-lookup"><span data-stu-id="6cc86-278">To a client, a redirected connection appears to be a connection to the server instance identified by the initial partner name.</span></span> <span data-ttu-id="6cc86-279">當初始夥伴目前是鏡像伺服器時，用戶端似乎可以連接至鏡像伺服器並更新鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cc86-279">When the initial partner is currently the mirror server, the client can appear to be connected to the mirror server and updating the mirror database.</span></span> <span data-ttu-id="6cc86-280">不過，用戶端實際上已經重新導向至容錯移轉夥伴 (目前的主體資料庫)，而且用戶端正在更新的是新主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cc86-280">Actually, however, the client has been redirected to the failover partner, which is the current principal database, and the client is updating the new principal database.</span></span>  
  
 <span data-ttu-id="6cc86-281">重新導向至容錯移轉夥伴後，使用 [!INCLUDE[tsql](../../includes/tsql-md.md)] USE 陳述式來使用不同的資料庫時，用戶端可能會遇到非預期的結果。</span><span class="sxs-lookup"><span data-stu-id="6cc86-281">After being redirected to the failover partner, a client can experience unexpected results when using a [!INCLUDE[tsql](../../includes/tsql-md.md)] USE statement to use a different database.</span></span> <span data-ttu-id="6cc86-282">如果目前的主體伺服器執行個體 (容錯移轉夥伴) 與原始的主體伺服器 (初始夥伴) 具有不同的資料庫集，就可能會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="6cc86-282">This can happen if the current principal server instance (the failover partner) has a different set of databases than the original principal server (the initial partner).</span></span>  
  
##  <a name="the-impact-of-a-stale-failover-partner-name"></a><a name="StalePartnerName"></a> <span data-ttu-id="6cc86-283">過時容錯移轉夥伴名稱的影響</span><span class="sxs-lookup"><span data-stu-id="6cc86-283">The Impact of a Stale Failover Partner Name</span></span>  
 <span data-ttu-id="6cc86-284">資料庫管理員可隨時變更容錯移轉夥伴。</span><span class="sxs-lookup"><span data-stu-id="6cc86-284">The database administrator can change the failover partner at any time.</span></span> <span data-ttu-id="6cc86-285">因此，用戶端提供的容錯移轉夥伴名稱可能會過期或「過時」。</span><span class="sxs-lookup"><span data-stu-id="6cc86-285">Therefore, a client-supplied failover partner name might be out of date, or *stale*.</span></span> <span data-ttu-id="6cc86-286">例如，考慮由另一個伺服器執行個體 Partner_C 取代的容錯移轉夥伴 Partner_B。</span><span class="sxs-lookup"><span data-stu-id="6cc86-286">For example, consider a failover partner named Partner_B that is replaced by another server instance, Partner_C.</span></span> <span data-ttu-id="6cc86-287">若用戶端接著提供 Partner_B 做為容錯移轉夥伴名稱，該名稱就會過時。</span><span class="sxs-lookup"><span data-stu-id="6cc86-287">Now, if a client supplies Partner_B as the failover partner name, that name is stale.</span></span> <span data-ttu-id="6cc86-288">當用戶端提供過時的容錯移轉夥伴名稱時，資料存取提供者的行為跟用戶端未提供容錯移轉夥伴名稱時一樣。</span><span class="sxs-lookup"><span data-stu-id="6cc86-288">When the client-supplied failover partner name is stale, the behavior of the data access provider equates to the case in which a failover partner name is not supplied by the client.</span></span>  
  
 <span data-ttu-id="6cc86-289">例如，假設用戶端使用同一個連接字串連續進行四次連接嘗試。</span><span class="sxs-lookup"><span data-stu-id="6cc86-289">For example, consider situation in which a client uses one connection string for a series of four connection attempts.</span></span> <span data-ttu-id="6cc86-290">在連接字串中，初始夥伴名稱是 Partner_A，而容錯移轉夥伴名稱是 Partner_B：</span><span class="sxs-lookup"><span data-stu-id="6cc86-290">In the connection string, the initial partner name is Partner_A, and the failover partner name is Partner_B:</span></span>  
  
```  
"Server=Partner_A; Failover Partner=Partner_B; Database=AdventureWorks"  
```  
  
 <span data-ttu-id="6cc86-291">下表顯示四個夥伴組態，並指出對於每一個組態來說，此連接字串第一次是否可連接用戶端。</span><span class="sxs-lookup"><span data-stu-id="6cc86-291">The following table shows four partner configurations and indicates for each whether this connection string works for connecting the client for the first time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6cc86-292">應用程式可以追蹤組態變更，並據以變更其連接字串。</span><span class="sxs-lookup"><span data-stu-id="6cc86-292">An application can track configuration changes and change its connection string accordingly.</span></span> <span data-ttu-id="6cc86-293">雖然這會需要額外程式碼，不過可減輕管理負擔。</span><span class="sxs-lookup"><span data-stu-id="6cc86-293">This requires extra code but reduces the administrative burden.</span></span>  
  
|<span data-ttu-id="6cc86-294">組態</span><span class="sxs-lookup"><span data-stu-id="6cc86-294">Configuration</span></span>|<span data-ttu-id="6cc86-295">主體伺服器</span><span class="sxs-lookup"><span data-stu-id="6cc86-295">Principal server</span></span>|<span data-ttu-id="6cc86-296">鏡像伺服器</span><span class="sxs-lookup"><span data-stu-id="6cc86-296">Mirror server</span></span>|<span data-ttu-id="6cc86-297">嘗試指定 Partner_A 和 Partner_B 來連接的行為</span><span class="sxs-lookup"><span data-stu-id="6cc86-297">Behavior when attempting to connect specifying Partner_A and Partner_B</span></span>|  
|-------------------|----------------------|-------------------|------------------------------------------------------------------------------|  
|<span data-ttu-id="6cc86-298">原始的鏡像組態。</span><span class="sxs-lookup"><span data-stu-id="6cc86-298">Original mirroring configuration.</span></span>|<span data-ttu-id="6cc86-299">Db_1</span><span class="sxs-lookup"><span data-stu-id="6cc86-299">Partner_A</span></span>|<span data-ttu-id="6cc86-300">Partner_B</span><span class="sxs-lookup"><span data-stu-id="6cc86-300">Partner_B</span></span>|<span data-ttu-id="6cc86-301">已快取 Partner_A 作為初始夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-301">Partner_A is cached as the initial partner name.</span></span> <span data-ttu-id="6cc86-302">用戶端成功連接到 Partner_A。</span><span class="sxs-lookup"><span data-stu-id="6cc86-302">The client succeeds in connecting to Partner_A.</span></span> <span data-ttu-id="6cc86-303">用戶端下載鏡像伺服器名稱 Partner_B 並放入快取中，略過用戶端提供的容錯移轉夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-303">The client downloads the name of mirror server, Partner_B, and caches it, ignoring the client-supplied failover partner name.</span></span>|  
|<span data-ttu-id="6cc86-304">Partner_A 遇到硬體失敗，而且發生容錯移轉 (中斷用戶端連接)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-304">Partner_A experiences a hardware failure, and failover occurs (disconnecting clients).</span></span>|<span data-ttu-id="6cc86-305">Partner_B</span><span class="sxs-lookup"><span data-stu-id="6cc86-305">Partner_B</span></span>|<span data-ttu-id="6cc86-306">無</span><span class="sxs-lookup"><span data-stu-id="6cc86-306">none</span></span>|<span data-ttu-id="6cc86-307">仍然將 Partner_A 快取為初始夥伴名稱，但用戶端提供的容錯移轉夥伴名稱 Partner_B，允許用戶端連接到目前的主體伺服器。</span><span class="sxs-lookup"><span data-stu-id="6cc86-307">The Partner_A is still cached as the initial partner name, but the client-supplied failover partner name, Partner_B, permits the client to connect to the current principal server.</span></span>|  
|<span data-ttu-id="6cc86-308">資料庫管理員停止鏡像功能 (中斷用戶端連接)，以 Partner_C 取代 Partner_A 後，重新啟動鏡像功能。</span><span class="sxs-lookup"><span data-stu-id="6cc86-308">The database administrator stops mirroring (disconnecting clients), replaces Partner_A with Partner_C, and restarts mirroring.</span></span>|<span data-ttu-id="6cc86-309">Partner_B</span><span class="sxs-lookup"><span data-stu-id="6cc86-309">Partner_B</span></span>|<span data-ttu-id="6cc86-310">Partner_C</span><span class="sxs-lookup"><span data-stu-id="6cc86-310">Partner_C</span></span>|<span data-ttu-id="6cc86-311">用戶端嘗試連接到 Partner_A 但失敗；接著用戶端嘗試連接 Partner_B (目前的主體伺服器)，結果成功。</span><span class="sxs-lookup"><span data-stu-id="6cc86-311">The client attempts to connect to Partner_A and fails; then the client tries Partner_B (the current principal server) and succeeds.</span></span> <span data-ttu-id="6cc86-312">資料存取提供者下載目前的鏡像伺服器名稱 Partner_C，並快取為目前的容錯移轉夥伴名稱。</span><span class="sxs-lookup"><span data-stu-id="6cc86-312">The data access provider downloads the name of the current mirror server, Partner_C, and caches it as the current failover partner name.</span></span>|  
|<span data-ttu-id="6cc86-313">手動將服務容錯移轉至 Partner_C (中斷用戶端連接)。</span><span class="sxs-lookup"><span data-stu-id="6cc86-313">Service is manually failed over to Partner_C (disconnecting clients).</span></span>|<span data-ttu-id="6cc86-314">Partner_C</span><span class="sxs-lookup"><span data-stu-id="6cc86-314">Partner_C</span></span>|<span data-ttu-id="6cc86-315">Partner_B</span><span class="sxs-lookup"><span data-stu-id="6cc86-315">Partner_B</span></span>|<span data-ttu-id="6cc86-316">用戶端一開始嘗試連接到 Partner_A，然後嘗試連接到 Partner_B。</span><span class="sxs-lookup"><span data-stu-id="6cc86-316">Client attempts to connect to Partner_A initially, and then to Partner_B.</span></span> <span data-ttu-id="6cc86-317">兩個名稱都會失敗，最後連接要求會逾時並失敗。</span><span class="sxs-lookup"><span data-stu-id="6cc86-317">Both names fail, and eventually the connection request times out and fails.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="6cc86-318">另請參閱</span><span class="sxs-lookup"><span data-stu-id="6cc86-318">See Also</span></span>  
 <span data-ttu-id="6cc86-319">[資料庫鏡像 &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6cc86-319">[Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="6cc86-320">資料庫鏡像期間可能發生的失敗</span><span class="sxs-lookup"><span data-stu-id="6cc86-320">Possible Failures During Database Mirroring</span></span>](possible-failures-during-database-mirroring.md)  
  
  
