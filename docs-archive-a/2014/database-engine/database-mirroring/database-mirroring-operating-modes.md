---
title: 資料庫鏡像作業模式 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- database mirroring [SQL Server], operating modes
ms.assetid: f8a579c2-55d7-4278-8088-f1da1de5b2e6
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: c944b402b8b1ba9b78036d667ec728ccaf561a91
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87592225"
---
# <a name="database-mirroring-operating-modes"></a><span data-ttu-id="2c316-102">資料庫鏡像作業模式</span><span class="sxs-lookup"><span data-stu-id="2c316-102">Database Mirroring Operating Modes</span></span>
  <span data-ttu-id="2c316-103">本主題描述資料庫鏡像工作階段的同步與非同步作業模式。</span><span class="sxs-lookup"><span data-stu-id="2c316-103">This topic describes the synchronous and asynchronous operating modes for database mirroring sessions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2c316-104">如需資料庫鏡像的簡介，請參閱 [資料庫鏡像 &#40;SQL Server&#41;](database-mirroring-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-104">For an introduction to database mirroring, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md).</span></span>  
  
 
  
##  <a name="terms-and-definitions"></a><a name="TermsAndDefinitions"></a> <span data-ttu-id="2c316-105">詞彙和定義</span><span class="sxs-lookup"><span data-stu-id="2c316-105">Terms and Definitions</span></span>  
 <span data-ttu-id="2c316-106">本節介紹幾個詞彙，它們是本主題的核心。</span><span class="sxs-lookup"><span data-stu-id="2c316-106">This section introduces a few terms that are central to this topic.</span></span>  
  
 <span data-ttu-id="2c316-107">高效能模式</span><span class="sxs-lookup"><span data-stu-id="2c316-107">High-performance mode</span></span>  
 <span data-ttu-id="2c316-108">資料庫鏡像工作階段會以非同步方式作業，而且僅使用主體伺服器和鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="2c316-108">The database mirroring session operates asynchronously and uses only the principal server and mirror server.</span></span> <span data-ttu-id="2c316-109">唯一的角色切換形式是強制的服務 (可能造成資料遺失)。</span><span class="sxs-lookup"><span data-stu-id="2c316-109">The only form of role switching is forced service (with possible data loss).</span></span>  
  
 <span data-ttu-id="2c316-110">高安全性模式</span><span class="sxs-lookup"><span data-stu-id="2c316-110">High-safety mode</span></span>  
 <span data-ttu-id="2c316-111">資料庫鏡像工作階段會以同步方式作業，並選擇性地使用見證以及主體伺服器和鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="2c316-111">The database mirroring session operates synchronously and, optionally, uses a witness, as well as the principal server and mirror server.</span></span>  
  
 <span data-ttu-id="2c316-112">交易安全性</span><span class="sxs-lookup"><span data-stu-id="2c316-112">Transaction safety</span></span>  
 <span data-ttu-id="2c316-113">鏡像特有的資料庫屬性，用來決定資料庫鏡像工作階段是以同步或非同步方式作業。</span><span class="sxs-lookup"><span data-stu-id="2c316-113">A mirroring-specific database property that determines whether a database mirroring session operates synchronously or asynchronously.</span></span> <span data-ttu-id="2c316-114">有兩個安全性層級：FULL 和 OFF。</span><span class="sxs-lookup"><span data-stu-id="2c316-114">There are two safety levels: FULL and OFF.</span></span>  
  
 <span data-ttu-id="2c316-115">見證</span><span class="sxs-lookup"><span data-stu-id="2c316-115">Witness</span></span>  
 <span data-ttu-id="2c316-116">只能搭配高安全性模式使用的一種 SQL Server 選擇性執行個體，可讓鏡像伺服器辨別是否要起始自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2c316-116">For use only with high-safety mode, an optional instance of SQL Server that enables the mirror server to recognize whether to initiate an automatic failover.</span></span> <span data-ttu-id="2c316-117">與兩個容錯移轉夥伴不同的是，見證並不是為資料庫服務。</span><span class="sxs-lookup"><span data-stu-id="2c316-117">Unlike the two failover partners, the witness does not serve the database.</span></span> <span data-ttu-id="2c316-118">支援自動容錯移轉是見證的唯一角色。</span><span class="sxs-lookup"><span data-stu-id="2c316-118">Supporting automatic failover is the only role of the witness.</span></span>  
  
##  <a name="asynchronous-database-mirroring-high-performance-mode"></a><a name="VisualElement"></a> <span data-ttu-id="2c316-119">非同步資料庫鏡像 (高效能模式) </span><span class="sxs-lookup"><span data-stu-id="2c316-119">Asynchronous Database Mirroring (High-Performance Mode)</span></span>  
 <span data-ttu-id="2c316-120">本節描述非同步資料庫鏡像如何運作、適合使用高效能模式的時機，以及主體伺服器失敗時如何回應。</span><span class="sxs-lookup"><span data-stu-id="2c316-120">This section describes how asynchronous database mirroring works, when it is appropriate to use high-performance mode, and how to respond if the principal server fails.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2c316-121">[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 的大部分版本僅支援同步資料庫鏡像 (「僅限 Safety Full」)。</span><span class="sxs-lookup"><span data-stu-id="2c316-121">Most editions of [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] support only synchronous database mirroring ("Safety Full Only").</span></span> <span data-ttu-id="2c316-122">如需完整支援資料庫鏡像之版本的詳細資訊，請參閱 [SQL Server 2014 版本所支援的功能](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md)中的「高可用性 (AlwaysOn) 」。</span><span class="sxs-lookup"><span data-stu-id="2c316-122">For information about editions that fully support database mirroring, see "High Availability (AlwaysOn)" in [Features Supported by the Editions of SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md).</span></span>  
  
 <span data-ttu-id="2c316-123">當交易安全性設為 OFF 時，資料庫鏡像工作階段就會以非同步的方式運作。</span><span class="sxs-lookup"><span data-stu-id="2c316-123">When transaction safety is set to OFF, the database mirroring session operates asynchronously.</span></span> <span data-ttu-id="2c316-124">非同步作業只支援一種作業模式：高效能模式。</span><span class="sxs-lookup"><span data-stu-id="2c316-124">Asynchronous operation supports only one operating mode-high-performance mode.</span></span> <span data-ttu-id="2c316-125">這種模式可提高效能，但代價是會降低高可用性。</span><span class="sxs-lookup"><span data-stu-id="2c316-125">This mode enhances performance at the expense of high availability.</span></span> <span data-ttu-id="2c316-126">高效能模式僅需使用主體伺服器與鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="2c316-126">High-performance mode uses just the principal server and the mirror server.</span></span> <span data-ttu-id="2c316-127">而鏡像伺服器方面的問題絕不會影響到主體伺服器。</span><span class="sxs-lookup"><span data-stu-id="2c316-127">Problems on the mirror server never impact the principal server.</span></span> <span data-ttu-id="2c316-128">如果主體伺服器失效，鏡像資料庫會標示為 DISCONNECTED，但仍可當做暖待命資料庫使用。</span><span class="sxs-lookup"><span data-stu-id="2c316-128">On the loss of the principal server, the mirror database is marked DISCONNECTED but is available as a warm standby.</span></span>  
  
 <span data-ttu-id="2c316-129">高效能模式僅支援一種角色切換形式：強制服務 (有遺失資料的可能)，此服務會使用鏡像伺服器做為暖待命伺服器。</span><span class="sxs-lookup"><span data-stu-id="2c316-129">High-performance mode, supports only one form of role switching: forced service (with possible data loss), which uses the mirror server as a warm standby server.</span></span> <span data-ttu-id="2c316-130">強制服務是對主體伺服器失敗的其中一項可能回應。</span><span class="sxs-lookup"><span data-stu-id="2c316-130">Forced service is one of the possible responses to the failure of the principal server.</span></span> <span data-ttu-id="2c316-131">由於資料有可能會遺失，因此在將服務強制切換到鏡像之前，您應先考慮其他替代方式。</span><span class="sxs-lookup"><span data-stu-id="2c316-131">Because data loss is possible, you should consider other alternatives before forcing service to the mirror.</span></span> <span data-ttu-id="2c316-132">如需詳細資訊，請參閱本主題稍後的 [回應主體的失敗](#WhenPrincipalFails)。</span><span class="sxs-lookup"><span data-stu-id="2c316-132">For more information, see [Responding to Failure of the Principal](#WhenPrincipalFails), later in this topic.</span></span>  
  
 <span data-ttu-id="2c316-133">下圖顯示使用高效能模式之工作階段的組態。</span><span class="sxs-lookup"><span data-stu-id="2c316-133">The following figure shows the configuration of a session using high-performance mode.</span></span>  
  
 <span data-ttu-id="2c316-134">![工作階段的僅限夥伴組態](../media/dbm-high-performance-mode.gif "工作階段的僅限夥伴組態")</span><span class="sxs-lookup"><span data-stu-id="2c316-134">![Partner-only configuration of a session](../media/dbm-high-performance-mode.gif "Partner-only configuration of a session")</span></span>  
  
 <span data-ttu-id="2c316-135">在高效能模式中，當主體伺服器傳送交易記錄檔到鏡像伺服器時，主體伺服器會立即傳送確認給用戶端，而不需等候鏡像伺服器的收條。</span><span class="sxs-lookup"><span data-stu-id="2c316-135">In high-performance mode, as soon as the principal server sends the log for a transaction to the mirror server, the principal server sends a confirmation to the client, without waiting for an acknowledgement from the mirror server.</span></span> <span data-ttu-id="2c316-136">交易認可，不需等候鏡像伺服器將記錄寫入磁碟中。</span><span class="sxs-lookup"><span data-stu-id="2c316-136">Transactions commit without waiting for the mirror server to write the log to disk.</span></span> <span data-ttu-id="2c316-137">非同步作業可讓主體伺服器在執行時，可以將交易延遲降到最低。</span><span class="sxs-lookup"><span data-stu-id="2c316-137">Asynchronous operation permits the principal server to run with minimum transaction latency.</span></span>  
  
 <span data-ttu-id="2c316-138">鏡像伺服器會盡量跟上主體伺服器所傳送的記錄。</span><span class="sxs-lookup"><span data-stu-id="2c316-138">The mirror server attempts to keep up with the log records sent by the principal server.</span></span> <span data-ttu-id="2c316-139">但鏡像資料庫的進度可能會落後於主體資料庫，不過資料庫之間的差距通常很小。</span><span class="sxs-lookup"><span data-stu-id="2c316-139">But the mirror database might lag somewhat behind the principal database, though typically the gap between the databases is small.</span></span> <span data-ttu-id="2c316-140">但是，若主體伺服器的工作負載很大，或鏡像伺服器的系統超載時，此差距就會變大。</span><span class="sxs-lookup"><span data-stu-id="2c316-140">However, the gap can become substantial if the principal server is under a heavy work load or the system of the mirror server is over loaded.</span></span>  
  
 
  
###  <a name="when-is-high-performance-mode-appropriate"></a><a name="WhenUseHighPerf"></a> <span data-ttu-id="2c316-141">高效能模式的適當使用時機</span><span class="sxs-lookup"><span data-stu-id="2c316-141">When Is High-Performance Mode Appropriate?</span></span>  
 <span data-ttu-id="2c316-142">在主體伺服器與鏡像伺服器的距離相隔很遠，以及您不希望有小失誤影響主體伺服器的災害復原狀況中，高效能模式會非常實用。</span><span class="sxs-lookup"><span data-stu-id="2c316-142">High-performance mode can be useful in a disaster-recovery scenario in which the principal and mirror servers are separated by a significant distance and where you do not want small errors to impact the principal server.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2c316-143">記錄傳送可以是資料庫鏡像的補強方式，以及非同步資料庫鏡像的理想替代方式。</span><span class="sxs-lookup"><span data-stu-id="2c316-143">Log shipping can be a supplement to database mirroring and is a favorable alternative to asynchronous database mirroring.</span></span> <span data-ttu-id="2c316-144">如需記錄傳送優點的資訊，請參閱[高可用性解決方案 &#40;SQL Server&#41;](../../sql-server/failover-clusters/high-availability-solutions-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-144">For information about the advantages of log shipping, see [High Availability Solutions &#40;SQL Server&#41;](../../sql-server/failover-clusters/high-availability-solutions-sql-server.md).</span></span> <span data-ttu-id="2c316-145">如需一起使用記錄傳送與資料庫鏡像的資訊，請參閱[資料庫鏡像和記錄傳送 &#40;SQL Server&#41;](database-mirroring-and-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-145">For information on using log shipping with database mirroring, see [Database Mirroring and Log Shipping &#40;SQL Server&#41;](database-mirroring-and-log-shipping-sql-server.md).</span></span>  
  
###  <a name="the-impact-of-a-witness-on-high-performance-mode"></a><a name="WitnessImpactOnHighPerf"></a> <span data-ttu-id="2c316-146">見證對高效能模式的影響</span><span class="sxs-lookup"><span data-stu-id="2c316-146">The Impact of a Witness on High-Performance Mode</span></span>  
 <span data-ttu-id="2c316-147">如果您使用 Transact-SQL 來設定高效能模式，每當 SAFETY 屬性設為 OFF 時，我們由衷建議您也將 WITNESS 屬性設為 OFF。</span><span class="sxs-lookup"><span data-stu-id="2c316-147">If you use Transact-SQL to configure high-performance mode, whenever the SAFETY property is set to OFF, we strongly recommend that the WITNESS property also be set to OFF.</span></span> <span data-ttu-id="2c316-148">見證可與高效能模式並存，但見證沒有什麼好處，只會帶來風險。</span><span class="sxs-lookup"><span data-stu-id="2c316-148">A witness can coexist with high-performance mode, but the witness provides no benefit and introduces risk.</span></span>  
  
 <span data-ttu-id="2c316-149">其中一個夥伴效能降低，如果見證與工作階段中斷連接，資料庫會變成無法使用。</span><span class="sxs-lookup"><span data-stu-id="2c316-149">If the witness is disconnected from the session when either partner goes down, the database becomes unavailable.</span></span> <span data-ttu-id="2c316-150">這是因為即使高效能模式不需要見證，但若設定了見證，則工作階段需要由兩個以上的伺服器執行個體所組成的仲裁。</span><span class="sxs-lookup"><span data-stu-id="2c316-150">This is because, even though high-performance mode does not require a witness, if one is set, the session requires a quorum consisting of two or more server instances.</span></span> <span data-ttu-id="2c316-151">如果工作階段失去仲裁，它就無法服務資料庫。</span><span class="sxs-lookup"><span data-stu-id="2c316-151">If the session losses quorum, it cannot serve the database.</span></span>  
  
 <span data-ttu-id="2c316-152">當見證設定於高效能模式工作階段時，強制仲裁意味著：</span><span class="sxs-lookup"><span data-stu-id="2c316-152">When a witness is set in a high-performance mode session, the enforcement of quorum means that:</span></span>  
  
-   <span data-ttu-id="2c316-153">如果失去鏡像伺服器，則主體伺服器必須連接到見證。</span><span class="sxs-lookup"><span data-stu-id="2c316-153">If the mirror server is lost, the principal server must be connected to the witness.</span></span> <span data-ttu-id="2c316-154">否則，主體伺服器會將其資料庫離線，直到見證或鏡像伺服器重新加入工作階段。</span><span class="sxs-lookup"><span data-stu-id="2c316-154">Otherwise, the principal server takes its database offline until either the witness or mirror server rejoins the session.</span></span>  
  
-   <span data-ttu-id="2c316-155">若失去主體伺服器，則要強制將服務轉到鏡像伺服器，需要鏡像伺服器連接到見證。</span><span class="sxs-lookup"><span data-stu-id="2c316-155">If the principal server is lost, forcing service to the mirror server requires that the mirror server be connected to the witness.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2c316-156">如需仲裁類型的資訊，請參閱[仲裁：見證如何影響資料庫可用性 &#40;資料庫鏡像&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-156">For information about the types of quorums, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
###  <a name="responding-to-failure-of-the-principal"></a><a name="WhenPrincipalFails"></a> <span data-ttu-id="2c316-157">回應主體的失敗</span><span class="sxs-lookup"><span data-stu-id="2c316-157">Responding to Failure of the Principal</span></span>  
 <span data-ttu-id="2c316-158">當主體失敗時，資料庫擁有者有下列幾項選擇：</span><span class="sxs-lookup"><span data-stu-id="2c316-158">When the principal fails, the database owner has several choices, as follows:</span></span>  
  
-   <span data-ttu-id="2c316-159">在主體能夠再度使用之前，將資料庫保持在無法使用的狀態。</span><span class="sxs-lookup"><span data-stu-id="2c316-159">Leave the database unavailable until the principal becomes available again.</span></span>  
  
     <span data-ttu-id="2c316-160">若主體資料庫與其交易記錄檔仍完整，則選擇此作法可保留所有已認可的交易，但會犧牲可用性。</span><span class="sxs-lookup"><span data-stu-id="2c316-160">If the principal database and its transaction log are intact, this choice preserves all of the committed transactions at the expense of availability.</span></span>  
  
-   <span data-ttu-id="2c316-161">停止資料庫鏡像工作階段，改以手動更新資料庫，然後開始新的資料庫鏡像工作階段。</span><span class="sxs-lookup"><span data-stu-id="2c316-161">Stop the database mirroring session, manually update the database, and then begin a new database mirroring session.</span></span>  
  
     <span data-ttu-id="2c316-162">若主體資料庫已失效，但主體伺服器仍在執行中，請立即嘗試備份主體資料庫上的記錄結尾。</span><span class="sxs-lookup"><span data-stu-id="2c316-162">If the principal database is lost but the principal server is still running, immediately attempt to back up the tail of the log on the principal database.</span></span> <span data-ttu-id="2c316-163">若順利完成結尾記錄備份，則移除鏡像可能會是最好的替代方式。</span><span class="sxs-lookup"><span data-stu-id="2c316-163">If the tail-log backup succeeds, removing mirroring may be your best alternative.</span></span> <span data-ttu-id="2c316-164">在移除鏡像後，您就可以將記錄還原到保存所有資料的先前鏡像資料庫中。</span><span class="sxs-lookup"><span data-stu-id="2c316-164">After removing mirroring, you can restore the log onto the former mirror database, which preserves all of the data.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="2c316-165">若結尾記錄備份失敗，而且您無法等候主體伺服器復原，請考慮進行強制服務，其優點是可以保持工作階段狀態。</span><span class="sxs-lookup"><span data-stu-id="2c316-165">If the tail-log backup failed and you cannot wait for the principal server to recover, consider forcing service, which has the advantage of maintaining the session state.</span></span>  
  
-   <span data-ttu-id="2c316-166">在鏡像伺服器上強制服務 (可能會有資料遺失)。</span><span class="sxs-lookup"><span data-stu-id="2c316-166">Force service (with possible data loss) on the mirror server.</span></span>  
  
     <span data-ttu-id="2c316-167">強制服務主要是一種損毀復原方法，應該謹慎使用。</span><span class="sxs-lookup"><span data-stu-id="2c316-167">Forced service is strictly a disaster recovery method and should be used sparingly.</span></span> <span data-ttu-id="2c316-168">只有在主體伺服器已關機、工作階段非同步 (交易安全性設為 OFF) 以及工作階段沒有任何見證 (WITNESS 屬性設為 OFF) 或見證連接到鏡像伺服器 (亦即有仲裁) 時，才能執行強制服務。</span><span class="sxs-lookup"><span data-stu-id="2c316-168">Forcing service is possible only if the principal server is down, the session is asynchronous (transaction safety is set to OFF), and either the session does not have any witness (the WITNESS property is set to OFF) or the witness is connected to the mirror server (that is, they have quorum).</span></span>  
  
     <span data-ttu-id="2c316-169">若執行強制服務，會讓鏡像伺服器擔任主體的角色，並將其資料庫副本提供給用戶端使用。</span><span class="sxs-lookup"><span data-stu-id="2c316-169">Forcing service causes the mirror server to assume the role of principal and serve its copy of the database for clients.</span></span> <span data-ttu-id="2c316-170">在強制服務時，凡是尚未由主體傳送到鏡像伺服器的交易記錄檔，都會遺失。</span><span class="sxs-lookup"><span data-stu-id="2c316-170">When service is forced, whatever transaction logs the principal has not yet sent to the mirror server are lost.</span></span> <span data-ttu-id="2c316-171">因此，執行強制服務的時機，應限定在可以接受資料遺失所造成的損失以及必須立即可使用資料庫的情況下。</span><span class="sxs-lookup"><span data-stu-id="2c316-171">Therefore, you should limit forced service to situations where possible data loss is acceptable and immediate database availability is critical.</span></span> <span data-ttu-id="2c316-172">如需強制服務運作方式及其最佳做法的資訊，請參閱[資料庫鏡像工作階段期間的角色切換 &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-172">For information on how forced service works and on best practices for using it, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
##  <a name="synchronous-database-mirroring-high-safety-mode"></a><a name="Sync"></a> <span data-ttu-id="2c316-173">同步資料庫鏡像 (高安全性模式)</span><span class="sxs-lookup"><span data-stu-id="2c316-173">Synchronous Database Mirroring (High-Safety Mode)</span></span>  
 <span data-ttu-id="2c316-174">本節描述同步資料庫鏡像如何運作，包括替代的高安全性模式 (含自動容錯移轉以及不含自動容錯移轉)，並包含有關自動容錯移轉中之見證角色的資訊。</span><span class="sxs-lookup"><span data-stu-id="2c316-174">This section describes how synchronous database mirroring works, including the alternative high-safety modes (with automatic failover and without automatic failover), and contains information about the role of the witness in automatic failover.</span></span>  
  
 <span data-ttu-id="2c316-175">如果交易安全性設為 FULL，在初始同步化階段之後，資料庫鏡像工作階段就會在高安全性模式下執行而且會以同步方式運作。</span><span class="sxs-lookup"><span data-stu-id="2c316-175">When transaction safety is set to FULL, the database mirroring session runs in high-safety mode and operates synchronously after an initial synchronizing phase.</span></span> <span data-ttu-id="2c316-176">本節將詳細說明設定同步作業的資料庫鏡像工作階段。</span><span class="sxs-lookup"><span data-stu-id="2c316-176">This section describes the details of database mirroring sessions that are configured for synchronous operation.</span></span>  
  
 <span data-ttu-id="2c316-177">若要達到工作階段的同步作業，鏡像伺服器必須將鏡像資料庫與主體資料庫進行同步處理。</span><span class="sxs-lookup"><span data-stu-id="2c316-177">To achieve synchronous operation for a session, the mirror server must synchronize the mirror database with the principal database.</span></span> <span data-ttu-id="2c316-178">工作階段開始時，主體伺服器就會開始將其使用中的記錄傳送至鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="2c316-178">When the session begins, the principal server begins sending its active log to the mirror server.</span></span> <span data-ttu-id="2c316-179">鏡像伺服器會儘快將所有內送記錄都寫入磁碟中。</span><span class="sxs-lookup"><span data-stu-id="2c316-179">The mirror server writes all of the incoming log records to disk as quickly as possible.</span></span> <span data-ttu-id="2c316-180">一旦所有收到的記錄都寫入磁碟之後，資料庫便已完成同步處理。</span><span class="sxs-lookup"><span data-stu-id="2c316-180">As soon as all of the received log records have been written to disk, the databases are synchronized.</span></span> <span data-ttu-id="2c316-181">只要夥伴保持通訊，資料庫就會持續同步處理。</span><span class="sxs-lookup"><span data-stu-id="2c316-181">As long as the partners remain in communication, the databases remain synchronized.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2c316-182">若要在資料庫鏡像工作階段中監視狀態變更，請使用 **資料庫鏡像狀態變更** 事件類別。</span><span class="sxs-lookup"><span data-stu-id="2c316-182">To monitor state changes in a database mirroring session, use the **Database Mirroring State Change** event class.</span></span> <span data-ttu-id="2c316-183">如需詳細資訊，請參閱 [Database Mirroring State Change Event Class](../../relational-databases/event-classes/database-mirroring-state-change-event-class.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-183">For more information, see [Database Mirroring State Change Event Class](../../relational-databases/event-classes/database-mirroring-state-change-event-class.md).</span></span>  
  
 <span data-ttu-id="2c316-184">在同步處理完成之後，主體資料庫上認可的每項交易，也都會在鏡像伺服器上認可，以確保資料的安全。</span><span class="sxs-lookup"><span data-stu-id="2c316-184">After synchronization finishes, every transaction committed on the principal database is also committed on the mirror server, guaranteeing protection of the data.</span></span> <span data-ttu-id="2c316-185">達成同步處理的做法是：直到主體伺服器收到鏡像伺服器傳來的訊息，表示已將交易記錄儲存至磁碟後，才去認可主體資料庫上的交易。</span><span class="sxs-lookup"><span data-stu-id="2c316-185">This is achieved by waiting to commit a transaction on the principal database, until the principal server receives a message from the mirror server stating that it has hardened the transaction's log to disk.</span></span> <span data-ttu-id="2c316-186">請注意，等候此訊息會增加交易的延遲時間。</span><span class="sxs-lookup"><span data-stu-id="2c316-186">Note the wait for this message increases the latency of the transaction.</span></span>  
  
 <span data-ttu-id="2c316-187">同步處理所需的時間，主要取決於：工作階段開始時，鏡像資料庫的進度落後主體資料庫多遠 (依據一開始從主體伺服器收到的記錄筆數來計算)；主體資料庫的工作負載；以及鏡像系統的速度。</span><span class="sxs-lookup"><span data-stu-id="2c316-187">The time required for synchronization depends essentially on how far the mirror database was behind the principal database at the start of the session (measured by the number of log records initially received from the principal server), the work load on the principal database, and the speed of the mirror system.</span></span> <span data-ttu-id="2c316-188">同步處理工作階段之後，必須在鏡像資料庫上重做的強化記錄，仍會留在重做佇列中。</span><span class="sxs-lookup"><span data-stu-id="2c316-188">After a session is synchronized, the hardened log that has yet to be redone on the mirror database remains in the redo queue.</span></span>  
  
 <span data-ttu-id="2c316-189">鏡像資料庫一旦完成同步處理，該資料庫兩個複本的狀態都會變成 SYNCHRONIZED。</span><span class="sxs-lookup"><span data-stu-id="2c316-189">As soon as the mirror database becomes synchronized, the state of both the copies of the database changes to SYNCHRONIZED.</span></span>  
  
 <span data-ttu-id="2c316-190">維持同步作業的做法如下：</span><span class="sxs-lookup"><span data-stu-id="2c316-190">Synchronous operation is maintained in the following manner:</span></span>  
  
1.  <span data-ttu-id="2c316-191">從用戶端收到交易時，主體伺服器會將交易的記錄寫入交易記錄。</span><span class="sxs-lookup"><span data-stu-id="2c316-191">On receiving a transaction from a client, the principal server writes the log for the transaction to the transaction log.</span></span>  
  
2.  <span data-ttu-id="2c316-192">主體伺服器會將交易寫入資料庫，同時也會傳送記錄至鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="2c316-192">The principal server writes the transaction to the database and, concurrently, sends the log record to the mirror server.</span></span> <span data-ttu-id="2c316-193">主體伺服器會等候鏡像伺服器發出收條，收到後才會向用戶端確認下列其中一項：交易認可或回復。</span><span class="sxs-lookup"><span data-stu-id="2c316-193">The principal server waits for an acknowledgement from the mirror server before confirming either of the following to the client: a transaction commit or a rollback.</span></span>  
  
3.  <span data-ttu-id="2c316-194">鏡像伺服器會將記錄儲存至磁碟，並回傳收條給主體伺服器。</span><span class="sxs-lookup"><span data-stu-id="2c316-194">The mirror server hardens the log to disk and returns an acknowledgement to the principal server.</span></span>  
  
4.  <span data-ttu-id="2c316-195">主體伺服器收到鏡像伺服器的收條時，就會傳送確認訊息給用戶端。</span><span class="sxs-lookup"><span data-stu-id="2c316-195">On receiving the acknowledgement from the mirror server, the principal server sends a confirmation message to the client.</span></span>  
  
 <span data-ttu-id="2c316-196">高安全性模式會藉由要求兩地的資料同步化來保護資料。</span><span class="sxs-lookup"><span data-stu-id="2c316-196">High-safety mode protects your data by requiring the data to be synchronized between two places.</span></span> <span data-ttu-id="2c316-197">所有經過認可的交易，都一定會寫入鏡像伺服器的磁碟上。</span><span class="sxs-lookup"><span data-stu-id="2c316-197">All the committed transactions are guaranteed to be written to disk on the mirror server.</span></span>  
  

  
###  <a name="high-safety-mode-without-automatic-failover"></a><a name="HighSafetyWithOutAutoFailover"></a> <span data-ttu-id="2c316-198">不具有自動容錯移轉的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="2c316-198">High-Safety Mode Without Automatic Failover</span></span>  
 <span data-ttu-id="2c316-199">下圖將顯示不含自動容錯移轉之高安全性模式的組態。</span><span class="sxs-lookup"><span data-stu-id="2c316-199">The following figure shows the configuration of high-safety mode without automatic failover.</span></span> <span data-ttu-id="2c316-200">這個組態僅包含兩個夥伴。</span><span class="sxs-lookup"><span data-stu-id="2c316-200">The configuration consists of only the two partners.</span></span>  
  
 <span data-ttu-id="2c316-201">![在沒有見證情況下通訊的夥伴](../media/dbm-high-protection-mode.gif "在沒有見證情況下通訊的夥伴")</span><span class="sxs-lookup"><span data-stu-id="2c316-201">![Partners communicating without a witness](../media/dbm-high-protection-mode.gif "Partners communicating without a witness")</span></span>  
  
 <span data-ttu-id="2c316-202">當夥伴已連接而且資料庫已經同步處理後，就會支援手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2c316-202">When the partners are connected and the database is already synchronized, manual failover is supported.</span></span> <span data-ttu-id="2c316-203">如果鏡像伺服器執行個體效能降低，主體伺服器執行個體不受影響，並且公開執行 (亦即沒有鏡像資料)。</span><span class="sxs-lookup"><span data-stu-id="2c316-203">If the mirror server instance goes down, the principal server instance is unaffected and runs exposed (that is without mirroring the data).</span></span> <span data-ttu-id="2c316-204">如果遺失主體伺服器，就會暫停鏡像，不過可以將服務強制轉到鏡像伺服器 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="2c316-204">If the principal server is lost, the mirror is suspended, but service can be forced to the mirror server (with possible data loss).</span></span> <span data-ttu-id="2c316-205">如需詳細資訊，請參閱 [資料庫鏡像工作階段期間的角色切換 &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md)版本都可使用見證伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="2c316-205">For more information, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
###  <a name="high-safety-mode-with-automatic-failover"></a><a name="HighSafetyWithAutoFailover"></a> <span data-ttu-id="2c316-206">具有自動容錯移轉的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="2c316-206">High-Safety Mode with Automatic Failover</span></span>  
 <span data-ttu-id="2c316-207">自動容錯移轉可確保某一台伺服器喪失之後，仍能繼續服務資料庫，藉以提供高度的可用性。</span><span class="sxs-lookup"><span data-stu-id="2c316-207">Automatic failover provides high availability by ensuring that the database is still served after the loss of one server.</span></span> <span data-ttu-id="2c316-208">自動容錯移轉會要求工作階段包含第三個伺服器執行個體 ( *「見證」* )，而且此執行個體最好是位於第三部電腦上。</span><span class="sxs-lookup"><span data-stu-id="2c316-208">Automatic failover requires that the session possess a third server instance, the *witness*, which ideally resides on a third computer.</span></span> <span data-ttu-id="2c316-209">下圖將顯示支援自動容錯移轉之高安全性模式工作階段的組態。</span><span class="sxs-lookup"><span data-stu-id="2c316-209">The following figure shows the configuration of a high-safety mode session that supports automatic failover.</span></span>  
  
 <span data-ttu-id="2c316-210">![工作階段的見證和兩個夥伴](../media/dbm-high-availability-mode.gif "工作階段的見證和兩個夥伴")</span><span class="sxs-lookup"><span data-stu-id="2c316-210">![The witness and two partners of a session](../media/dbm-high-availability-mode.gif "The witness and two partners of a session")</span></span>  
  
 <span data-ttu-id="2c316-211">與兩位夥伴不同的是，見證並不是為資料庫服務。</span><span class="sxs-lookup"><span data-stu-id="2c316-211">Unlike the two partners, the witness does not serve the database.</span></span> <span data-ttu-id="2c316-212">見證只是藉由確認主體伺服器是否已啟動而且可以正常運作，來支援自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2c316-212">The witness simply supports automatic failover by verifying whether the principal server is up and functioning.</span></span> <span data-ttu-id="2c316-213">只有當鏡像和見證與主體伺服器中斷連接後仍然保持相互連接時，鏡像伺服器才會開始進行自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2c316-213">The mirror server initiates automatic failover only if the mirror and the witness remain connected to each other after both have been disconnected from the principal server.</span></span>  
  
 <span data-ttu-id="2c316-214">當見證設定完成後，工作階段就會要求「仲裁」(它是至少兩個伺服器執行個體之間的關聯性，以便讓資料庫可供使用)。</span><span class="sxs-lookup"><span data-stu-id="2c316-214">When a witness is set, the session requires *quorum*-a relationship between at least two server instances that allows the database to be made available.</span></span> <span data-ttu-id="2c316-215">如需詳細資訊，請參閱[資料庫鏡像見證](database-mirroring-witness.md)和[仲裁：見證如何影響資料庫可用性 &#40;資料庫鏡像&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-215">For more information, see [Database Mirroring Witness](database-mirroring-witness.md) and [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
 <span data-ttu-id="2c316-216">自動容錯移轉必須符合下列條件：</span><span class="sxs-lookup"><span data-stu-id="2c316-216">Automatic failover requires the following conditions:</span></span>  
  
-   <span data-ttu-id="2c316-217">資料庫已同步處理。</span><span class="sxs-lookup"><span data-stu-id="2c316-217">The database is already synchronized.</span></span>  
  
-   <span data-ttu-id="2c316-218">當所有三個伺服器執行個體都已連接，而且見證和鏡像伺服器維持連接狀態時，發生故障。</span><span class="sxs-lookup"><span data-stu-id="2c316-218">The failure occurs while all three server instances are connected, and the witness and mirror server remain connected.</span></span>  
  
 <span data-ttu-id="2c316-219">夥伴的遺失將具有下列結果：</span><span class="sxs-lookup"><span data-stu-id="2c316-219">The loss of a partner has the following effect:</span></span>  
  
-   <span data-ttu-id="2c316-220">如果主體伺服器在上述條件下變得無法使用，就會進行自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2c316-220">If the principal server becomes unavailable under the above conditions, automatic failover occurs.</span></span> <span data-ttu-id="2c316-221">鏡像伺服器會切換成主體的角色，並提供其資料庫來作為主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="2c316-221">The mirror server switches to the role of principal, and it offers its database as the principal database.</span></span>  
  
-   <span data-ttu-id="2c316-222">如果主體伺服器在未達到這些條件時無法使用，強制服務 (可能發生資料遺失) 是可行的。</span><span class="sxs-lookup"><span data-stu-id="2c316-222">If the principal server becomes unavailable when those conditions are not met, forcing service (with possible data loss) might be possible.</span></span> <span data-ttu-id="2c316-223">如需詳細資訊，請參閱 [資料庫鏡像工作階段期間的角色切換 &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md)版本都可使用見證伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="2c316-223">For more information, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
-   <span data-ttu-id="2c316-224">如果只有鏡像伺服器變得無法使用，主體及見證會繼續運作。</span><span class="sxs-lookup"><span data-stu-id="2c316-224">If the only mirror server becomes unavailable, the principal and witness continue.</span></span>  
  
 <span data-ttu-id="2c316-225">如果工作階段失去見證，仲裁就會需要這兩個夥伴。</span><span class="sxs-lookup"><span data-stu-id="2c316-225">If the session loses its witness, quorum requires both partners.</span></span> <span data-ttu-id="2c316-226">如果任一個夥伴失去仲裁，這兩個夥伴都會失去仲裁，因此資料庫將變成無法使用，直到重新建立仲裁。</span><span class="sxs-lookup"><span data-stu-id="2c316-226">If either partner loses quorum, both partners lose quorum, and the database becomes unavailable until quorum is re-established.</span></span> <span data-ttu-id="2c316-227">此仲裁需求可確保在沒有見證的情況下，資料庫絕不會 *「公開」* (亦即，在沒有鏡像的情況下) 執行。</span><span class="sxs-lookup"><span data-stu-id="2c316-227">This quorum requirement makes sure that in the absence of a witness the database never runs *exposed*, that is without being mirrored.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2c316-228">若要讓見證中斷連接維持一段較長的時間，我們建議您從工作階段中移除見證，直到它可用為止。</span><span class="sxs-lookup"><span data-stu-id="2c316-228">If you expect the witness to remain disconnected for a significant amount of time, we recommend that you remove the witness from the session until it becomes available.</span></span>  
  
##  <a name="transact-sql-settings-and-database-mirroring-operating-modes"></a><a name="TsqlSettingsAndOpModes"></a> <span data-ttu-id="2c316-229">Transact-SQL 設定和資料庫鏡像作業模式</span><span class="sxs-lookup"><span data-stu-id="2c316-229">Transact-SQL Settings and Database Mirroring Operating Modes</span></span>  
 <span data-ttu-id="2c316-230">本節描述與 ALTER DATABASE 設定和鏡像資料庫與見證狀態相關的資料庫鏡像工作階段 (如果有的話)。</span><span class="sxs-lookup"><span data-stu-id="2c316-230">This section describes a database mirroring session in terms of the ALTER DATABASE settings and states of the mirrored database and witness, if any.</span></span> <span data-ttu-id="2c316-231">本節適用於主要或專以 [!INCLUDE[tsql](../../includes/tsql-md.md)] (而非 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]) 管理資料庫鏡像的使用者。</span><span class="sxs-lookup"><span data-stu-id="2c316-231">The section is aimed at users who manage database mirroring primarily or exclusively using [!INCLUDE[tsql](../../includes/tsql-md.md)], rather than using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="2c316-232">做為使用 [!INCLUDE[tsql](../../includes/tsql-md.md)]的替代方法，您可以使用 **[資料庫屬性]** 對話方塊的 **[鏡像]** 頁面，在物件總管中控制工作階段的作業模式。</span><span class="sxs-lookup"><span data-stu-id="2c316-232">As an alternative to using [!INCLUDE[tsql](../../includes/tsql-md.md)], you can control the operating mode of a session in Object Explorer using the **Mirroring** page of the **Database Properties** dialog box.</span></span> <span data-ttu-id="2c316-233">如需詳細資訊，請參閱本主題稍後的 [使用 Windows 驗證建立資料庫鏡像工作階段 &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-233">For more information, see [Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md).</span></span>  
  

  
###  <a name="how-transaction-safety-and-witness-state-affect-the-operating-mode"></a><a name="TxnSafetyAndWitness"></a> <span data-ttu-id="2c316-234">交易安全性和見證狀態影響作業模式的方式</span><span class="sxs-lookup"><span data-stu-id="2c316-234">How Transaction Safety and Witness State Affect the Operating Mode</span></span>  
 <span data-ttu-id="2c316-235">工作階段的作業模式是由交易安全性設定和見證狀態的組合所決定。</span><span class="sxs-lookup"><span data-stu-id="2c316-235">The operating mode of a session is determined by the combination of its transaction safety setting and the state of the witness.</span></span> <span data-ttu-id="2c316-236">資料庫擁有者可隨時變更交易安全性層級，且可加入或移除見證。</span><span class="sxs-lookup"><span data-stu-id="2c316-236">At any time, the database owner can change the transaction safety level, and can add or remove the witness.</span></span>  
  

  
####  <a name="transaction-safety"></a><a name="TxnSafety"></a> <span data-ttu-id="2c316-237">Transaction Safety</span><span class="sxs-lookup"><span data-stu-id="2c316-237">Transaction Safety</span></span>  
 <span data-ttu-id="2c316-238">交易安全性是鏡像特有的資料庫屬性，用來決定資料庫鏡像工作階段是以同步或非同步方式作業。</span><span class="sxs-lookup"><span data-stu-id="2c316-238">Transaction safety is a mirroring-specific database property that determines whether a database mirroring session operates synchronously or asynchronously.</span></span> <span data-ttu-id="2c316-239">有兩個安全性層級：FULL 和 OFF。</span><span class="sxs-lookup"><span data-stu-id="2c316-239">There are two safety levels: FULL and OFF.</span></span>  
  
-   <span data-ttu-id="2c316-240">SAFETY FULL</span><span class="sxs-lookup"><span data-stu-id="2c316-240">SAFETY FULL</span></span>  
  
     <span data-ttu-id="2c316-241">完整交易安全性會使工作階段在高效能模式中以同步方式運作。</span><span class="sxs-lookup"><span data-stu-id="2c316-241">Full transaction safety causes the session to operate synchronously in high-safety mode.</span></span> <span data-ttu-id="2c316-242">如果見證存在的話，工作階段就會支援自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2c316-242">If a witness is present, a session supports automatic failover.</span></span>  
  
     <span data-ttu-id="2c316-243">當您使用 ALTER DATABASE 陳述式建立工作階段時，工作階段一開始會將 SAFETY 屬性設定為 FULL；這表示工作階段會以高安全性模式開始。</span><span class="sxs-lookup"><span data-stu-id="2c316-243">When you establish a session using ALTER DATABASE statements, the session begins with the SAFETY property set to FULL; that is, the session begins in high-safety mode.</span></span> <span data-ttu-id="2c316-244">在工作階段開始後，您就可以加入見證。</span><span class="sxs-lookup"><span data-stu-id="2c316-244">After the session begins, you can add a witness.</span></span>  
  
     <span data-ttu-id="2c316-245">如需詳細資訊，請參閱本主題稍早的 [同步資料庫鏡像 (高安全性模式)](#Sync)。</span><span class="sxs-lookup"><span data-stu-id="2c316-245">For more information, see [Synchronous Database Mirroring (High-Safety Mode)](#Sync), earlier in this topic.</span></span>  
  
-   <span data-ttu-id="2c316-246">SAFETY OFF</span><span class="sxs-lookup"><span data-stu-id="2c316-246">SAFETY OFF</span></span>  
  
     <span data-ttu-id="2c316-247">關閉交易安全性會使工作階段在高效能模式中以非同步方式運作。</span><span class="sxs-lookup"><span data-stu-id="2c316-247">Turning off transaction safety causes the session to operate asynchronously, in high-performance mode.</span></span> <span data-ttu-id="2c316-248">如果將 SAFETY 屬性設定為 OFF，則 WITNESS 屬性也應該設定為 OFF (預設值)。</span><span class="sxs-lookup"><span data-stu-id="2c316-248">If the SAFETY property is set to OFF, the WITNESS property should also be set to OFF (the default).</span></span> <span data-ttu-id="2c316-249">如需見證在高效能模式中之影響的資訊，請參閱本主題稍後的 [見證的狀態](#WitnessState)。</span><span class="sxs-lookup"><span data-stu-id="2c316-249">For information about the impact of the witness in high-performance mode, see [The State of the Witness](#WitnessState), later in this topic.</span></span> <span data-ttu-id="2c316-250">如需關閉交易安全性執行的詳細資訊，請參閱本主題稍早的 [非同步資料庫鏡像 (高效能模式)](#VisualElement)。</span><span class="sxs-lookup"><span data-stu-id="2c316-250">For more information about running with transaction safety turned off, see [Asynchronous Database Mirroring (High-Performance Mode)](#VisualElement), earlier in this topic.</span></span>  
  
 <span data-ttu-id="2c316-251">資料庫的交易安全性設定會記錄在每個夥伴之 **mirroring_safety_level** 和 **mirroring_safety_level_desc** 資料行的 **sys.database_mirroring** 目錄檢視中。</span><span class="sxs-lookup"><span data-stu-id="2c316-251">The transaction safety setting of the database is recorded on each partner in the **sys.database_mirroring** catalog view in the **mirroring_safety_level** and **mirroring_safety_level_desc** columns.</span></span> <span data-ttu-id="2c316-252">如需詳細資訊，請參閱 [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="2c316-252">For more information, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
 <span data-ttu-id="2c316-253">資料庫擁有者可以隨時變更交易安全性層級。</span><span class="sxs-lookup"><span data-stu-id="2c316-253">The database owner can change the transaction safety level at any time.</span></span>  
  
####  <a name="the-state-of-the-witness"></a><a name="WitnessState"></a> <span data-ttu-id="2c316-254">見證的狀態</span><span class="sxs-lookup"><span data-stu-id="2c316-254">The State of the Witness</span></span>  
 <span data-ttu-id="2c316-255">如果已設定見證，則需要仲裁，因此見證狀態永遠都很重要。</span><span class="sxs-lookup"><span data-stu-id="2c316-255">If a witness has been set, quorum is required, so the state of the witness is always significant.</span></span>  
  
 <span data-ttu-id="2c316-256">如果存在，則見證的狀態會是下列兩種狀態之一：</span><span class="sxs-lookup"><span data-stu-id="2c316-256">If it exists, the witness has one of two states:</span></span>  
  
-   <span data-ttu-id="2c316-257">見證連接到夥伴時，與該夥伴相關的見證會處於 CONNECTED 狀態，且具有該夥伴的仲裁。</span><span class="sxs-lookup"><span data-stu-id="2c316-257">When the witness is connected to a partner, the witness is in the CONNECTED state relative to that partner and has quorum with that partner.</span></span> <span data-ttu-id="2c316-258">在此情況下，即使其中一個夥伴無法使用，也可使用資料庫。</span><span class="sxs-lookup"><span data-stu-id="2c316-258">In this case, the database can be made available, even if one of the partners is unavailable.</span></span>  
  
-   <span data-ttu-id="2c316-259">見證存在但未連接到夥伴時，與該夥伴相關的見證會處於 UNKOWN 或 DISCONNECTED 狀態。</span><span class="sxs-lookup"><span data-stu-id="2c316-259">When the witness exists but is not connected to a partner, the witness is in the UNKOWN or DISCONNECTED state relative to that partner.</span></span> <span data-ttu-id="2c316-260">在此情況下，見證會缺少該夥伴的仲裁，而如果夥伴未彼此連接，資料庫會變成無法使用。</span><span class="sxs-lookup"><span data-stu-id="2c316-260">In this case, the witness lacks quorum with that partner, and if the partners are not connected to each other, the database becomes unavailable.</span></span>  
  
 <span data-ttu-id="2c316-261">如需仲裁的資訊，請參閱[仲裁：見證如何影響資料庫可用性 &#40;資料庫鏡像&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-261">For information about quorum, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
 <span data-ttu-id="2c316-262">伺服器執行個體上每個見證的狀態，都會記錄在 **mirroring_witness_state** 和 **mirroring_witness_state_desc** 資料行的 **sys.database_mirroring** 目錄檢視中。</span><span class="sxs-lookup"><span data-stu-id="2c316-262">The state of each witness on a server instance is recorded in the **sys.database_mirroring** catalog view in the **mirroring_witness_state** and **mirroring_witness_state_desc** columns.</span></span> <span data-ttu-id="2c316-263">如需詳細資訊，請參閱 [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="2c316-263">For more information, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
 <span data-ttu-id="2c316-264">下表概述根據交易安全性設定和見證狀態而定的工作階段作業模式。</span><span class="sxs-lookup"><span data-stu-id="2c316-264">The following table summarizes how the operating mode of a session depends upon its transaction safety setting and on state of the witness.</span></span>  
  
|<span data-ttu-id="2c316-265">作業模式</span><span class="sxs-lookup"><span data-stu-id="2c316-265">Operating mode</span></span>|<span data-ttu-id="2c316-266">交易安全性</span><span class="sxs-lookup"><span data-stu-id="2c316-266">Transaction safety</span></span>|<span data-ttu-id="2c316-267">見證狀態</span><span class="sxs-lookup"><span data-stu-id="2c316-267">Witness state</span></span>|  
|--------------------|------------------------|-------------------|  
|<span data-ttu-id="2c316-268">高效能模式</span><span class="sxs-lookup"><span data-stu-id="2c316-268">High-performance mode</span></span>|<span data-ttu-id="2c316-269">OFF</span><span class="sxs-lookup"><span data-stu-id="2c316-269">OFF</span></span>|<span data-ttu-id="2c316-270">Null (沒有見證) <sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="2c316-270">NULL (no witness)<sup>2</sup></span></span>|  
|<span data-ttu-id="2c316-271">不具有自動容錯移轉的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="2c316-271">High-safety mode without automatic failover</span></span>|<span data-ttu-id="2c316-272">FULL</span><span class="sxs-lookup"><span data-stu-id="2c316-272">FULL</span></span>|<span data-ttu-id="2c316-273">NULL (無見證)</span><span class="sxs-lookup"><span data-stu-id="2c316-273">NULL (no witness)</span></span>|  
|<span data-ttu-id="2c316-274">具有自動容錯移轉的高安全性模式<sup>1</sup></span><span class="sxs-lookup"><span data-stu-id="2c316-274">High-safety mode with automatic failover<sup>1</sup></span></span>|<span data-ttu-id="2c316-275">FULL</span><span class="sxs-lookup"><span data-stu-id="2c316-275">FULL</span></span>|<span data-ttu-id="2c316-276">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="2c316-276">CONNECTED</span></span>|  
  
 <span data-ttu-id="2c316-277"><sup>1</sup> 如果見證中斷連接，我們建議您先將見證設定為關閉，直到見證伺服器實例可用為止。</span><span class="sxs-lookup"><span data-stu-id="2c316-277"><sup>1</sup> If the witness becomes disconnected, we recommend that you set WITNESS OFF until the witness server instance becomes available.</span></span>  
  
 <span data-ttu-id="2c316-278"><sup>2</sup> 如果見證存在於高效能模式中，則見證不會參與會話。</span><span class="sxs-lookup"><span data-stu-id="2c316-278"><sup>2</sup> If a witness is present in high-performance mode, the witness does not participate in the session.</span></span> <span data-ttu-id="2c316-279">不過，若要讓資料庫可供使用，必須至少有兩個伺服器執行個體保持連接。</span><span class="sxs-lookup"><span data-stu-id="2c316-279">However, to make the database available, at least two of the server instances must remain connected.</span></span> <span data-ttu-id="2c316-280">因此，建議您讓 WITNESS 屬性在高效能模式工作階段中保持設定為 OFF。</span><span class="sxs-lookup"><span data-stu-id="2c316-280">Therefore, we recommend keeping the WITNESS property set to OFF in high-performance mode sessions.</span></span> <span data-ttu-id="2c316-281">如需詳細資訊，請參閱[仲裁：見證如何影響資料庫可用性 &#40;資料庫鏡像&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="2c316-281">For more information, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
###  <a name="viewing-the-safety-setting-and-state-of-the-witness"></a><a name="ViewWitness"></a> <span data-ttu-id="2c316-282">檢視安全性設定和見證狀態</span><span class="sxs-lookup"><span data-stu-id="2c316-282">Viewing the Safety Setting and State of the Witness</span></span>  
 <span data-ttu-id="2c316-283">若要檢視資料庫的安全性設定和見證狀態，請使用 **sys.database_mirroring** 目錄檢視。</span><span class="sxs-lookup"><span data-stu-id="2c316-283">To view the safety setting and the state of the witness for a database, use the **sys.database_mirroring** catalog view.</span></span> <span data-ttu-id="2c316-284">相關的資料行如下：</span><span class="sxs-lookup"><span data-stu-id="2c316-284">The relevant columns are as follows:</span></span>  
  
|<span data-ttu-id="2c316-285">因數</span><span class="sxs-lookup"><span data-stu-id="2c316-285">Factor</span></span>|<span data-ttu-id="2c316-286">資料行</span><span class="sxs-lookup"><span data-stu-id="2c316-286">Columns</span></span>|<span data-ttu-id="2c316-287">描述</span><span class="sxs-lookup"><span data-stu-id="2c316-287">Description</span></span>|  
|------------|-------------|-----------------|  
|<span data-ttu-id="2c316-288">交易安全性</span><span class="sxs-lookup"><span data-stu-id="2c316-288">Transaction safety</span></span>|<span data-ttu-id="2c316-289">**mirroring_safety_level** 或 **mirroring_safety_level_desc**</span><span class="sxs-lookup"><span data-stu-id="2c316-289">**mirroring_safety_level** or **mirroring_safety_level_desc**</span></span>|<span data-ttu-id="2c316-290">在鏡像資料庫上更新的交易安全性設定，其中一個為：</span><span class="sxs-lookup"><span data-stu-id="2c316-290">Transaction safety setting for updates on the mirror database, one of:</span></span><br /><br /> <span data-ttu-id="2c316-291">UNKNOWN</span><span class="sxs-lookup"><span data-stu-id="2c316-291">UNKNOWN</span></span><br /><br /> <span data-ttu-id="2c316-292">OFF</span><span class="sxs-lookup"><span data-stu-id="2c316-292">OFF</span></span><br /><br /> <span data-ttu-id="2c316-293">FULL</span><span class="sxs-lookup"><span data-stu-id="2c316-293">FULL</span></span><br /><br /> <span data-ttu-id="2c316-294">NULL= 資料庫不在線上。</span><span class="sxs-lookup"><span data-stu-id="2c316-294">NULL= database is not online.</span></span>|  
|<span data-ttu-id="2c316-295">見證存在嗎？</span><span class="sxs-lookup"><span data-stu-id="2c316-295">Does a witness exist?</span></span>|<span data-ttu-id="2c316-296">**mirroring_witness_name**</span><span class="sxs-lookup"><span data-stu-id="2c316-296">**mirroring_witness_name**</span></span>|<span data-ttu-id="2c316-297">資料庫鏡像見證的伺服器名稱或 NULL，表示沒有見證。</span><span class="sxs-lookup"><span data-stu-id="2c316-297">Server name of the database mirroring witness or NULL, indicating that no witness exists.</span></span>|  
|<span data-ttu-id="2c316-298">見證狀態</span><span class="sxs-lookup"><span data-stu-id="2c316-298">Witness state</span></span>|<span data-ttu-id="2c316-299">**mirroring_witness_state** 或 **mirroring_witness_state_desc**</span><span class="sxs-lookup"><span data-stu-id="2c316-299">**mirroring_witness_state** or **mirroring_witness_state_desc**</span></span>|<span data-ttu-id="2c316-300">給定夥伴之資料庫中的見證狀態：</span><span class="sxs-lookup"><span data-stu-id="2c316-300">State of the witness in the database on a given partner:</span></span><br /><br /> <span data-ttu-id="2c316-301">UNKNOWN</span><span class="sxs-lookup"><span data-stu-id="2c316-301">UNKNOWN</span></span><br /><br /> <span data-ttu-id="2c316-302">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="2c316-302">CONNECTED</span></span><br /><br /> <span data-ttu-id="2c316-303">DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="2c316-303">DISCONNECTED</span></span><br /><br /> <span data-ttu-id="2c316-304">NULL = 沒有見證或資料庫不在線上。</span><span class="sxs-lookup"><span data-stu-id="2c316-304">NULL = no witness exists or the database is not online.</span></span>|  
  
 <span data-ttu-id="2c316-305">例如，在主體或鏡像伺服器上輸入：</span><span class="sxs-lookup"><span data-stu-id="2c316-305">For example, on either the principal or mirror server, enter:</span></span>  
  
```  
SELECT mirroring_safety_level_desc, mirroring_witness_name, mirroring_witness_state_desc FROM sys.database_mirroring  
```  
  
 <span data-ttu-id="2c316-306">如需此目錄檢視的詳細資訊，請參閱 [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="2c316-306">For more information about this catalog view, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
###  <a name="factors-affecting-behavior-on-loss-of-the-principal-server"></a><a name="FactorsOnLossOfPrincipal"></a> <span data-ttu-id="2c316-307">影響失去主體伺服器時之行為的因素</span><span class="sxs-lookup"><span data-stu-id="2c316-307">Factors Affecting Behavior on Loss of the Principal Server</span></span>  
 <span data-ttu-id="2c316-308">下表概述失去主體伺服器時，交易安全性設定、資料庫狀態和見證狀態對於鏡像工作階段行為的聯合影響。</span><span class="sxs-lookup"><span data-stu-id="2c316-308">The following table summarizes the combined effect of the transaction safety setting, the state of the database, and the state of the witness on the behavior of a mirroring session on the loss of the principal server.</span></span>  
  
|<span data-ttu-id="2c316-309">交易安全性</span><span class="sxs-lookup"><span data-stu-id="2c316-309">Transaction safety</span></span>|<span data-ttu-id="2c316-310">鏡像資料庫的鏡像狀態</span><span class="sxs-lookup"><span data-stu-id="2c316-310">Mirroring state of mirror database</span></span>|<span data-ttu-id="2c316-311">見證狀態</span><span class="sxs-lookup"><span data-stu-id="2c316-311">Witness state</span></span>|<span data-ttu-id="2c316-312">遺失主體時的行為</span><span class="sxs-lookup"><span data-stu-id="2c316-312">Behavior when principal is lost</span></span>|  
|------------------------|----------------------------------------|-------------------|-------------------------------------|  
|<span data-ttu-id="2c316-313">FULL</span><span class="sxs-lookup"><span data-stu-id="2c316-313">FULL</span></span>|<span data-ttu-id="2c316-314">SYNCHRONIZED</span><span class="sxs-lookup"><span data-stu-id="2c316-314">SYNCHRONIZED</span></span>|<span data-ttu-id="2c316-315">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="2c316-315">CONNECTED</span></span>|<span data-ttu-id="2c316-316">自動容錯移轉發生。</span><span class="sxs-lookup"><span data-stu-id="2c316-316">Automatic failover occurs.</span></span>|  
|<span data-ttu-id="2c316-317">FULL</span><span class="sxs-lookup"><span data-stu-id="2c316-317">FULL</span></span>|<span data-ttu-id="2c316-318">SYNCHRONIZED</span><span class="sxs-lookup"><span data-stu-id="2c316-318">SYNCHRONIZED</span></span>|<span data-ttu-id="2c316-319">DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="2c316-319">DISCONNECTED</span></span>|<span data-ttu-id="2c316-320">停止鏡像伺服器；無法進行容錯移轉且無法使用資料庫。</span><span class="sxs-lookup"><span data-stu-id="2c316-320">Mirror server stops; failover is not possible, and the database cannot be made available.</span></span>|  
|<span data-ttu-id="2c316-321">OFF</span><span class="sxs-lookup"><span data-stu-id="2c316-321">OFF</span></span>|<span data-ttu-id="2c316-322">SUSPENDED 或 DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="2c316-322">SUSPENDED or DISCONNECTED</span></span>|<span data-ttu-id="2c316-323">NULL (無見證)</span><span class="sxs-lookup"><span data-stu-id="2c316-323">NULL (no witness)</span></span>|<span data-ttu-id="2c316-324">服務可強制到鏡像伺服器 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="2c316-324">Service can be forced to the mirror server (with possible data loss).</span></span>|  
|<span data-ttu-id="2c316-325">FULL</span><span class="sxs-lookup"><span data-stu-id="2c316-325">FULL</span></span>|<span data-ttu-id="2c316-326">SYNCHRONIZING 或 SUSPENDED</span><span class="sxs-lookup"><span data-stu-id="2c316-326">SYNCHRONIZING or SUSPENDED</span></span>|<span data-ttu-id="2c316-327">NULL (無見證)</span><span class="sxs-lookup"><span data-stu-id="2c316-327">NULL (no witness)</span></span>|<span data-ttu-id="2c316-328">服務可強制到鏡像伺服器 (可能會遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="2c316-328">Service can be forced to the mirror server (with possible data loss).</span></span>|  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="2c316-329">相關工作</span><span class="sxs-lookup"><span data-stu-id="2c316-329">Related Tasks</span></span>  
  
-   [<span data-ttu-id="2c316-330">新增或取代資料庫鏡像見證 &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="2c316-330">Add or Replace a Database Mirroring Witness &#40;SQL Server Management Studio&#41;</span></span>](../database-mirroring/add-or-replace-a-database-mirroring-witness-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="2c316-331">使用 Windows 驗證建立資料庫鏡像工作階段 &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="2c316-331">Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;</span></span>](establish-database-mirroring-session-windows-authentication.md)  
  
-   [<span data-ttu-id="2c316-332">使用 Windows 驗證新增資料庫鏡像見證 &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="2c316-332">Add a Database Mirroring Witness Using Windows Authentication &#40;Transact-SQL&#41;</span></span>](add-a-database-mirroring-witness-using-windows-authentication-transact-sql.md)  
  
-   [<span data-ttu-id="2c316-333">從資料庫鏡像工作階段移除見證 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="2c316-333">Remove the Witness from a Database Mirroring Session &#40;SQL Server&#41;</span></span>](remove-the-witness-from-a-database-mirroring-session-sql-server.md)  
  
-   [<span data-ttu-id="2c316-334">在資料庫鏡像工作階段中變更交易安全性 &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="2c316-334">Change Transaction Safety in a Database Mirroring Session &#40;Transact-SQL&#41;</span></span>](change-transaction-safety-in-a-database-mirroring-session-transact-sql.md)  
  
## <a name="see-also"></a><span data-ttu-id="2c316-335">另請參閱</span><span class="sxs-lookup"><span data-stu-id="2c316-335">See Also</span></span>  
 <span data-ttu-id="2c316-336">[監視資料庫鏡像 &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="2c316-336">[Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="2c316-337">資料庫鏡像見證</span><span class="sxs-lookup"><span data-stu-id="2c316-337">Database Mirroring Witness</span></span>](database-mirroring-witness.md)  
