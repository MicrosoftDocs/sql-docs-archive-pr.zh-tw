---
title: 資料庫鏡像工作階段期間的角色切換 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- role switching [SQL Server]
- mirroring partners [SQL Server]
- failover [SQL Server]
- failover partners [SQL Server]
- database mirroring [SQL Server], partners
- partners in database mirroring sessions [SQL Server]
- failover [SQL Server], database mirroring
- database mirroring [SQL Server], failover
ms.assetid: a782d60d-0373-4386-bd77-9ec192553700
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 5e16adbad2106d623279edf9d443eae3755c7be5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87701791"
---
# <a name="role-switching-during-a-database-mirroring-session-sql-server"></a><span data-ttu-id="55185-102">資料庫鏡像工作階段期間的角色切換 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="55185-102">Role Switching During a Database Mirroring Session (SQL Server)</span></span>
  <span data-ttu-id="55185-103">在資料庫鏡像工作階段的內容中，主體與鏡像角色通常可以用一種稱為 *「角色切換」* 的程序交換。</span><span class="sxs-lookup"><span data-stu-id="55185-103">Within the context of a database mirroring session, the principal and mirror roles are typically interchangeable in a process known as *role switching*.</span></span> <span data-ttu-id="55185-104">在角色切換中，鏡像伺服器將充當主體伺服器的「容錯移轉夥伴」、接替主體角色、復原其資料庫副本，並使其上線以作為新的主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-104">In role switching, the mirror server acts as the *failover partner* for the principal server, taking over the principal role, recovering its copy of the database and bringing it online as the new principal database.</span></span> <span data-ttu-id="55185-105">先前的主體伺服器可用時，會擔任鏡像角色，而其資料庫即成為新的鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-105">The former principal server, when available, assumes the mirror role, and its database becomes the new mirror database.</span></span> <span data-ttu-id="55185-106">原則上，這些角色可以來回切換，以回應多項失敗或達成管理目的。</span><span class="sxs-lookup"><span data-stu-id="55185-106">Potentially, the roles can switch back and forth either in response to multiple failures or for administrative purposes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="55185-107">本主題假設您已熟悉資料庫鏡像作業模式。</span><span class="sxs-lookup"><span data-stu-id="55185-107">This topic assumes that you are familiar with the database mirroring operating modes.</span></span> <span data-ttu-id="55185-108">如需詳細資訊，請參閱 [Database Mirroring Operating Modes](database-mirroring-operating-modes.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-108">For more information, see [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span></span>  
  
 <span data-ttu-id="55185-109">下圖顯示鏡像夥伴 **Partner_A** 和 **Partner_B**，在一連串的自動或手動容錯移轉期間，切換主體和鏡像角色。</span><span class="sxs-lookup"><span data-stu-id="55185-109">The following illustration shows mirroring partners, **Partner_A** and **Partner_B**, switching the principal and mirror roles over a series of automatic or manual failovers.</span></span>  
  
 <span data-ttu-id="55185-110">![切換兩次角色的夥伴](../media/dbm-roleswitching.gif "切換兩次角色的夥伴")</span><span class="sxs-lookup"><span data-stu-id="55185-110">![Partners switching twice between roles](../media/dbm-roleswitching.gif "Partners switching twice between roles")</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="55185-111">在角色切換之後，您必須在新的主體伺服器上重新建立並執行原先主體資料庫上執行的作業。</span><span class="sxs-lookup"><span data-stu-id="55185-111">After a role switch, jobs that ran on the former principal database must be recreated on the new principal server to run there.</span></span> <span data-ttu-id="55185-112">如需詳細資訊，請參閱[角色切換後針對登入和作業進行管理 &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-112">For more information, see [Management of Logins and Jobs After Role Switching &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md).</span></span>  
  
 <span data-ttu-id="55185-113">角色切換類型共有三種：自動容錯移轉、手動容錯移轉和強制服務 (可能遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="55185-113">Three types of role switching exist: automatic failover, manual failover, and forced service (with possible data loss).</span></span> <span data-ttu-id="55185-114">至於支援哪一種形式，需視工作階段的作業模式而定。</span><span class="sxs-lookup"><span data-stu-id="55185-114">Support for each form depends on the operating mode of the session.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="55185-115">如果您不熟悉這些作業模式，請參閱 [資料庫鏡像作業模式](database-mirroring-operating-modes.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-115">If you are unfamiliar with these operating modes, see [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span></span>  
  
-   <span data-ttu-id="55185-116">**手動容錯移轉**</span><span class="sxs-lookup"><span data-stu-id="55185-116">**Manual failover**</span></span>  
  
     <span data-ttu-id="55185-117">高安全性模式支援手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-117">High-safety mode supports manual failover.</span></span> <span data-ttu-id="55185-118">只要資料庫完成同步處理，資料庫擁有者即可起始手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-118">Whenever the database is synchronized, the database owner can initiate a manual failover.</span></span>  
  
     <span data-ttu-id="55185-119">手動容錯移轉是為管理用途而設計，</span><span class="sxs-lookup"><span data-stu-id="55185-119">Manual failover is provided for administrative purposes.</span></span> <span data-ttu-id="55185-120">如需詳細資訊，請參閱本主題稍後的 [手動容錯移轉](#ManualFailover)。</span><span class="sxs-lookup"><span data-stu-id="55185-120">For more information, see [Manual Failover](#ManualFailover), later in this topic.</span></span>  
  
-   <span data-ttu-id="55185-121">**Automatic failover**</span><span class="sxs-lookup"><span data-stu-id="55185-121">**Automatic failover**</span></span>  
  
     <span data-ttu-id="55185-122">如果見證存在的話，高安全性模式就支援自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-122">In the presence of a witness, high-safety mode supports automatic failover.</span></span> <span data-ttu-id="55185-123">當見證和鏡像伺服器仍然彼此連接而且資料庫已經同步處理時，自動容錯移轉只會在主體伺服器失效時進行。</span><span class="sxs-lookup"><span data-stu-id="55185-123">Automatic failover occurs only on the loss of the principal server when the witness and mirror server are still connected to each other and the database is already synchronized.</span></span> <span data-ttu-id="55185-124">如需詳細資訊，請參閱本主題稍後的 [自動容錯移轉](#AutomaticFailover)。</span><span class="sxs-lookup"><span data-stu-id="55185-124">For more information, see [Automatic Failover](#AutomaticFailover), later in this topic.</span></span>  
  
-   <span data-ttu-id="55185-125">**強制服務 (可能遺失資料)**</span><span class="sxs-lookup"><span data-stu-id="55185-125">**Forced service (with possible data loss)**</span></span>  
  
     <span data-ttu-id="55185-126">高安全性模式 (如果沒有設定見證的話) 和高效能模式下都支援強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-126">Forcing service is supported in high-safety mode when no witness is set and in high-performance mode.</span></span> <span data-ttu-id="55185-127">主體伺服器失效後，資料庫擁有者可對鏡像伺服器執行強制服務 (可能遺失資料)，以讓資料庫成為可用狀態。</span><span class="sxs-lookup"><span data-stu-id="55185-127">On the loss of the principal server, the database owner can make the database available by forcing service to the mirror server (with possible data loss).</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="55185-128">在高效能模式下，我們建議將 WITNESS 屬性設定為 OFF。</span><span class="sxs-lookup"><span data-stu-id="55185-128">We recommend that the WITNESS property be set to OFF in high-performance mode.</span></span> <span data-ttu-id="55185-129">否則，若要將資料庫帶上線，鏡像伺服器必須連接到見證。</span><span class="sxs-lookup"><span data-stu-id="55185-129">Otherwise, to bring the database online, the mirror server must connected to the witness.</span></span>  
  
     <span data-ttu-id="55185-130">如需詳細資訊，請參閱本主題稍後的 [強制服務 (可能遺失資料)](#ForcedService)。</span><span class="sxs-lookup"><span data-stu-id="55185-130">For more information, see [Forced Service (with Possible Data Loss)](#ForcedService), later in this topic.</span></span>  
  
 <span data-ttu-id="55185-131">下表將摘要列出每種作業模式下支援的容錯移轉形式。</span><span class="sxs-lookup"><span data-stu-id="55185-131">The following table summarizes which forms of failover are supported under each of the operating modes.</span></span>  
  
||<span data-ttu-id="55185-132">高效能</span><span class="sxs-lookup"><span data-stu-id="55185-132">High performance</span></span>|<span data-ttu-id="55185-133">不含見證的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="55185-133">High-safety mode without a witness</span></span>|<span data-ttu-id="55185-134">含有見證的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="55185-134">High-safety mode with a witness</span></span>|  
|-|----------------------|-----------------------------------------|--------------------------------------|  
|<span data-ttu-id="55185-135">自動容錯移轉</span><span class="sxs-lookup"><span data-stu-id="55185-135">Automatic failover</span></span>|<span data-ttu-id="55185-136">否</span><span class="sxs-lookup"><span data-stu-id="55185-136">No</span></span>|<span data-ttu-id="55185-137">否</span><span class="sxs-lookup"><span data-stu-id="55185-137">No</span></span>|<span data-ttu-id="55185-138">是</span><span class="sxs-lookup"><span data-stu-id="55185-138">Yes</span></span>|  
|<span data-ttu-id="55185-139">手動容錯移轉</span><span class="sxs-lookup"><span data-stu-id="55185-139">Manual failover</span></span>|<span data-ttu-id="55185-140">否</span><span class="sxs-lookup"><span data-stu-id="55185-140">No</span></span>|<span data-ttu-id="55185-141">是</span><span class="sxs-lookup"><span data-stu-id="55185-141">Yes</span></span>|<span data-ttu-id="55185-142">是</span><span class="sxs-lookup"><span data-stu-id="55185-142">Yes</span></span>|  
|<span data-ttu-id="55185-143">強制服務</span><span class="sxs-lookup"><span data-stu-id="55185-143">Forced service</span></span>|<span data-ttu-id="55185-144">是</span><span class="sxs-lookup"><span data-stu-id="55185-144">Yes</span></span>|<span data-ttu-id="55185-145">是</span><span class="sxs-lookup"><span data-stu-id="55185-145">Yes</span></span>|<span data-ttu-id="55185-146">否</span><span class="sxs-lookup"><span data-stu-id="55185-146">No</span></span>|  
  
 <span data-ttu-id="55185-147">角色切換之後，兩部夥伴伺服器上都必須有特定的中繼資料，以確保所有的資料庫使用者都能存取新的主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-147">After a role switch, certain metadata must exist on both partners to ensure that all of the database users can access the new principal database.</span></span> <span data-ttu-id="55185-148">此外，您還必須在新的主體伺服器上建立備份作業，以確保該資料庫能夠繼續進行定期備份。</span><span class="sxs-lookup"><span data-stu-id="55185-148">In addition, backup jobs must be created on the new principal server, to ensure that the database continues to be backed up on its regular schedule.</span></span> <span data-ttu-id="55185-149">如需詳細資訊，請參閱[角色切換後針對登入和作業進行管理 &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-149">For more information, see [Management of Logins and Jobs After Role Switching &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md).</span></span>  
  
 <span data-ttu-id="55185-150">在角色切換期間，資料庫鏡像無法服務的時間量將依角色切換的類型及其原因而定。</span><span class="sxs-lookup"><span data-stu-id="55185-150">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and on the cause.</span></span> <span data-ttu-id="55185-151">如需詳細資訊，請參閱 [預估角色切換期間的服務中斷時間 &#40;資料庫鏡像&#41;](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md)的程序交換。</span><span class="sxs-lookup"><span data-stu-id="55185-151">For more information, see [Estimate the Interruption of Service During Role Switching &#40;Database Mirroring&#41;](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md).</span></span>  
  
##  <a name="manual-failover"></a><a name="ManualFailover"></a> <span data-ttu-id="55185-152">Manual Failover</span><span class="sxs-lookup"><span data-stu-id="55185-152">Manual Failover</span></span>  
 <span data-ttu-id="55185-153">手動容錯移轉會中斷用戶端與資料庫之間的連接，並將夥伴的角色反轉過來。</span><span class="sxs-lookup"><span data-stu-id="55185-153">Manual failover disconnects the clients from the database and reverses the roles of the partners.</span></span> <span data-ttu-id="55185-154">只有高安全性模式支援手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-154">Only high-safety mode supports manual failover.</span></span>  
  
  
###  <a name="maintaining-availability-during-upgrades"></a><a name="AvailabilityDuringUpgrades"></a> <span data-ttu-id="55185-155">維護升級期間的可用性</span><span class="sxs-lookup"><span data-stu-id="55185-155">Maintaining Availability During Upgrades</span></span>  
 <span data-ttu-id="55185-156">資料庫管理員可以使用手動容錯移轉來升級硬體或軟體，而不必犧牲可用性。</span><span class="sxs-lookup"><span data-stu-id="55185-156">The database administrator can use manual failover for upgrading hardware or software without sacrificing availability.</span></span> <span data-ttu-id="55185-157">若要使用資料庫鏡像進行軟體升級，鏡像伺服器及/或系統必須已經升級。</span><span class="sxs-lookup"><span data-stu-id="55185-157">To use database mirroring for software upgrades, the mirror server and/or system must have already received the upgrades.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="55185-158">資料庫鏡像應該可進行輪流升級，但因為不知道未來是否會有所變更，所以無法保證一定可以進行這類升級。</span><span class="sxs-lookup"><span data-stu-id="55185-158">Database mirroring should be able to do a rolling upgrade, but this is not guaranteed, because future changes are unknown.</span></span> <span data-ttu-id="55185-159">如需詳細資訊，請參閱 [Minimize Downtime for Mirrored Databases When Upgrading Server Instances](upgrading-mirrored-instances.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-159">For more information, see [Minimize Downtime for Mirrored Databases When Upgrading Server Instances](upgrading-mirrored-instances.md).</span></span>  
  
 <span data-ttu-id="55185-160">下圖說明在升級資料庫伺服器執行個體的同時，使用手動容錯移轉來維護資料庫可用性的範例。</span><span class="sxs-lookup"><span data-stu-id="55185-160">The following figure illustrates an instance of using manual failover to maintain database availability while you upgrade a database server instance.</span></span> <span data-ttu-id="55185-161">升級完成時，系統管理員可以選擇性地容錯移轉回原始的伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="55185-161">When the upgrade is completed, an administrator may optionally fail over back to the original server instance.</span></span> <span data-ttu-id="55185-162">如果系統管理員想要停止鏡像工作階段，轉而使用別處的鏡像伺服器，這個方法便很有用。</span><span class="sxs-lookup"><span data-stu-id="55185-162">This is useful when the administrator wants to stop the mirroring session and use the mirror server elsewhere.</span></span> <span data-ttu-id="55185-163">使用這個方法，更新一連串的資料庫伺服器執行個體時，就可以重複使用單一的伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="55185-163">In this way, a single server instance can be used repeatedly when updating a series of database server instances.</span></span>  
  
 <span data-ttu-id="55185-164">![規劃的手動容錯移轉](../media/dbm-failovmanuplanned.gif "已規劃的手動容錯移轉")</span><span class="sxs-lookup"><span data-stu-id="55185-164">![Planned manual failover](../media/dbm-failovmanuplanned.gif "Planned manual failover")</span></span>  
  
###  <a name="conditions-required-for-a-manual-failover"></a><a name="ConditionsForManualFo"></a> <span data-ttu-id="55185-165">手動容錯移轉所需的條件</span><span class="sxs-lookup"><span data-stu-id="55185-165">Conditions Required for a Manual Failover</span></span>  
 <span data-ttu-id="55185-166">手動容錯移轉需要將交易安全性設定為 FULL (即為高安全性模式)。</span><span class="sxs-lookup"><span data-stu-id="55185-166">Manual failover requires transaction safety to be set to FULL (that is, high-safety mode).</span></span> <span data-ttu-id="55185-167">當夥伴已連接而且資料庫已經同步處理後，就會支援手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-167">When the partners are connected and the database is already synchronized, manual failover is supported.</span></span>  
  
###  <a name="how-manual-failover-works"></a><a name="HowManualFoWorks"></a> <span data-ttu-id="55185-168">手動容錯移轉如何運作</span><span class="sxs-lookup"><span data-stu-id="55185-168">How Manual Failover Works</span></span>  
 <span data-ttu-id="55185-169">手動容錯移轉會起始下列動作順序：</span><span class="sxs-lookup"><span data-stu-id="55185-169">Manual failover initiates the following sequence of actions:</span></span>  
  
1.  <span data-ttu-id="55185-170">主體伺服器會中斷用戶端與主體資料庫的連接、將記錄結尾傳送至鏡像伺服器，並在準備切換到鏡像角色時，將鏡像狀態設定為 SYNCHRONIZING。</span><span class="sxs-lookup"><span data-stu-id="55185-170">The principal server disconnects clients from the principal database, sends the tail of the log to the mirror server, and, in preparation for switching to the mirror role, sets the mirroring state to SYNCHRONIZING.</span></span>  
  
2.  <span data-ttu-id="55185-171">鏡像伺服器會將從主體伺服器接收到最後一筆記錄的記錄序號 (LSN) 記錄下來，做為容錯移轉 LSN。</span><span class="sxs-lookup"><span data-stu-id="55185-171">The mirror server records the log sequence number (LSN) of the last log record received from the principal as the failover LSN.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="55185-172">若要檢視此 LSN，請從 [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql) 選取 **mirroring_failover_lsn** 資料行。</span><span class="sxs-lookup"><span data-stu-id="55185-172">To view this LSN, select the **mirroring_failover_lsn** column from [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
3.  <span data-ttu-id="55185-173">如果在重做佇列中有任何記錄正在等待，則鏡像伺服器會完成鏡像資料庫的向前復原。</span><span class="sxs-lookup"><span data-stu-id="55185-173">If any log is waiting in the redo queue, the mirror server finishes rolling forward the mirror database.</span></span> <span data-ttu-id="55185-174">所需時間取決於系統的速度、最近的工作負載，以及重做佇列中的記錄量。</span><span class="sxs-lookup"><span data-stu-id="55185-174">The amount of time required depends on the speed of the system, the recent workload, and the amount of log in the redo queue.</span></span> <span data-ttu-id="55185-175">針對同步處理作業模式，容錯移轉時間可以藉由限制重做佇列的大小來調節。</span><span class="sxs-lookup"><span data-stu-id="55185-175">For a synchronous operating mode, the failover time can be regulated by limiting the size of the redo queue.</span></span> <span data-ttu-id="55185-176">但是，這可能會造成主體伺服器變慢，以便鏡像伺服器能夠跟上。</span><span class="sxs-lookup"><span data-stu-id="55185-176">However, this can cause the principal server to slow down to allow the mirror server to keep up.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="55185-177">若要了解重做佇列的目前大小，請使用資料庫鏡像效能物件中的 **Redo Queue** 效能計數器 (如需詳細資訊，請參閱[監視資料庫鏡像 &#40;SQL Server&#41;](database-mirroring-sql-server.md))。</span><span class="sxs-lookup"><span data-stu-id="55185-177">To learn the current size of the redo queue, use the **Redo Queue** performance counter in the database mirroring performance object (for more information, see [Monitoring Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span>  
  
4.  <span data-ttu-id="55185-178">鏡像伺服器會變成新的主體伺服器，而舊的主體伺服器則會變成新的鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="55185-178">The mirror server becomes the new principal server, and the former principal server becomes the new mirror server.</span></span>  
  
5.  <span data-ttu-id="55185-179">新的主體伺服器會回復至任何未認可的交易，並使它自己的資料庫副本變成線上狀態以做為主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-179">The new principal server rolls back any uncommitted transactions and brings its copy of the database online as the principal database.</span></span>  
  
6.  <span data-ttu-id="55185-180">舊的主體伺服器會接受鏡像角色，而舊的主體資料庫則變成鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-180">The former principal takes on the mirror role, and the former principal database becomes the mirror database.</span></span> <span data-ttu-id="55185-181">新的鏡像伺服器將會以新的主體資料庫快速地重新同步處理新的鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="55185-181">The new mirror server quickly resynchronizes the new mirror database with the new principal database.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="55185-182">新鏡像伺服器重新同步處理資料庫後，就可以再次容錯移轉，但是方向會相反。</span><span class="sxs-lookup"><span data-stu-id="55185-182">As soon as the new mirror server has resynchronized the databases, failover is again possible, but in the reverse direction.</span></span>  
  
 <span data-ttu-id="55185-183">容錯移轉之後，用戶端必須重新連接到目前的主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-183">After failover, clients must reconnect to the current principal database.</span></span> <span data-ttu-id="55185-184">如需詳細資訊，請參閱本主題稍後的 [將用戶端連接至資料庫鏡像工作階段 &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-184">For more information, see [Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md).</span></span>  
  
 <span data-ttu-id="55185-185">**若要初始化手動容錯移轉**</span><span class="sxs-lookup"><span data-stu-id="55185-185">**To initiate manual failover**</span></span>  
  
-   [<span data-ttu-id="55185-186">手動容錯移轉資料庫鏡像工作階段 &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="55185-186">Manually Fail Over a Database Mirroring Session &#40;SQL Server Management Studio&#41;</span></span>](manually-fail-over-a-database-mirroring-session-sql-server-management-studio.md)  
  
-   <span data-ttu-id="55185-187">[手動容錯移轉資料庫鏡像工作階段 &#40;Transact-SQL&#41;](manually-fail-over-a-database-mirroring-session-transact-sql.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-187">[Manually Fail Over a Database Mirroring Session &#40;Transact-SQL&#41;](manually-fail-over-a-database-mirroring-session-transact-sql.md).</span></span>  
  
##  <a name="automatic-failover"></a><a name="AutomaticFailover"></a> <span data-ttu-id="55185-188">Automatic Failover</span><span class="sxs-lookup"><span data-stu-id="55185-188">Automatic Failover</span></span>  
 <span data-ttu-id="55185-189">只有在高安全性模式下搭配見證執行的資料庫鏡像工作階段才支援自動容錯移轉 (「具有自動容錯移轉的高安全性模式」)。</span><span class="sxs-lookup"><span data-stu-id="55185-189">Automatic failover is supported only in database mirroring sessions running with a witness in high-safety mode (*high-safety mode with automatic failover*).</span></span> <span data-ttu-id="55185-190">在具有自動容錯移轉的高安全性模式下，一旦資料庫同步處理後，如果主體資料庫無法使用，就會進行自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-190">In high-safety mode with automatic failover, once the database is synchronized, if the principal database becomes unavailable, an automatic failover occurs.</span></span> <span data-ttu-id="55185-191">自動容錯移轉會使鏡像伺服器接替主體伺服器的角色，使其資料庫副本連接成為主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-191">An automatic failover causes the mirror server to take over the role of principal server and bring its copy of the database online as the principal database.</span></span> <span data-ttu-id="55185-192">同步處理資料庫的需求可避免容錯移轉期間發生資料遺失的狀況，因為主體資料庫上認可的每一筆交易也會在鏡像資料庫上認可。</span><span class="sxs-lookup"><span data-stu-id="55185-192">Requiring that the database be synchronized prevents data loss during failover, because every transaction committed on the principal database is also committed on the mirror database.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="55185-193">為了讓自動容錯移轉能夠提高可靠性，鏡像與主體資料庫必須位於不同的電腦上。</span><span class="sxs-lookup"><span data-stu-id="55185-193">For automatic failover to improve reliability, the mirror and principal databases must reside on different computers.</span></span>  
  
  
  
###  <a name="conditions-required-for-an-automatic-failover"></a><a name="ConditionsForAutoFo"></a> <span data-ttu-id="55185-194">自動容錯移轉所需的條件</span><span class="sxs-lookup"><span data-stu-id="55185-194">Conditions Required for an Automatic Failover</span></span>  
 <span data-ttu-id="55185-195">自動容錯移轉必須符合下列條件：</span><span class="sxs-lookup"><span data-stu-id="55185-195">Automatic failover requires the following conditions:</span></span>  
  
-   <span data-ttu-id="55185-196">資料庫鏡像工作階段必須在高安全性模式下執行而且必須擁有見證。</span><span class="sxs-lookup"><span data-stu-id="55185-196">The database mirroring session must be running in high-safety mode and must possess a witness.</span></span> <span data-ttu-id="55185-197">如需詳細資訊，請參閱 [Database Mirroring Operating Modes](database-mirroring-operating-modes.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-197">For more information, see [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span></span>  
  
-   <span data-ttu-id="55185-198">鏡像資料庫必須已經完成同步處理。</span><span class="sxs-lookup"><span data-stu-id="55185-198">The mirror database must already be synchronized.</span></span> <span data-ttu-id="55185-199">如此可確保所有傳送到鏡像伺服器的記錄都已寫入磁碟中。</span><span class="sxs-lookup"><span data-stu-id="55185-199">This guarantees that all of the log sent to the mirror server has been written to disk.</span></span>  
  
-   <span data-ttu-id="55185-200">主體伺服器已經中斷與資料庫鏡像組態其他元件的通訊，但鏡像與見證仍保有仲裁。</span><span class="sxs-lookup"><span data-stu-id="55185-200">The principal server has lost communication with the rest of the database mirroring configuration, while the mirror and witness retain quorum.</span></span> <span data-ttu-id="55185-201">不過，如果所有的伺服器執行個體都失去通訊，而見證與鏡像伺服器稍後重新取得通訊，則不會發生自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-201">If all server instances lose communication, however, and the witness and the mirror server later regain communication, automatic failover does not occur.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="55185-202">如需詳細資訊，請參閱[仲裁：見證如何影響資料庫可用性 &#40;資料庫鏡像&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-202">For more information, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
-   <span data-ttu-id="55185-203">鏡像伺服器已偵測到主體伺服器的遺失。</span><span class="sxs-lookup"><span data-stu-id="55185-203">The mirror server has detected the loss of the principal server.</span></span>  
  
     <span data-ttu-id="55185-204">鏡像伺服器偵測主體伺服器錯誤的方式需視其為硬性或軟性錯誤而定。</span><span class="sxs-lookup"><span data-stu-id="55185-204">How the mirror server detects a failure of the principal server depends on whether it is a hard or soft failure.</span></span> <span data-ttu-id="55185-205">如需詳細資訊，請參閱 [資料庫鏡像期間可能發生的失敗](possible-failures-during-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-205">For more information, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md).</span></span>  
  
###  <a name="how-automatic-failover-works"></a><a name="HowAutoFoWorks"></a> <span data-ttu-id="55185-206">自動容錯移轉如何運作</span><span class="sxs-lookup"><span data-stu-id="55185-206">How Automatic Failover Works</span></span>  
 <span data-ttu-id="55185-207">在前述條件下，自動容錯移轉會起始下列動作順序：</span><span class="sxs-lookup"><span data-stu-id="55185-207">Under the preceding conditions, automatic failover initiates the following sequence of actions:</span></span>  
  
1.  <span data-ttu-id="55185-208">如果主體伺服器仍在執行，就會將主體資料庫的狀態變更為 DISCONNECTED，並中斷主體資料庫中所有用戶端的連接。</span><span class="sxs-lookup"><span data-stu-id="55185-208">If the principal server is still running, it changes the state of the principal database to DISCONNECTED and disconnects all clients from the principal database.</span></span>  
  
2.  <span data-ttu-id="55185-209">見證伺服器與鏡像伺服器會將主體伺服器登錄為無法使用。</span><span class="sxs-lookup"><span data-stu-id="55185-209">The witness and mirror servers register that the principal server is unavailable.</span></span>  
  
3.  <span data-ttu-id="55185-210">如果在重做佇列中有任何記錄正在等待，則鏡像伺服器會完成鏡像資料庫的向前復原。</span><span class="sxs-lookup"><span data-stu-id="55185-210">If any log is waiting in the redo queue, the mirror server finishes rolling forward the mirror database.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="55185-211">套用記錄所需時間量視系統的速度、最近的工作負載，以及重做佇列中的記錄量而定。</span><span class="sxs-lookup"><span data-stu-id="55185-211">The amount of time required to apply the log depends on the speed of the system, the recent work load, and the amount of log in the redo queue.</span></span>  
  
4.  <span data-ttu-id="55185-212">先前的鏡像資料庫會連線成為新的主體資料庫，而復原作業會儘快回復所有未認可的交易來加以清除。</span><span class="sxs-lookup"><span data-stu-id="55185-212">The former mirror database moves online as the new principal database, and recovery cleans up all uncommitted transactions by rolling them back as quickly as possible.</span></span> <span data-ttu-id="55185-213">鎖定會隔離這些交易。</span><span class="sxs-lookup"><span data-stu-id="55185-213">Locks isolate those transactions.</span></span>  
  
5.  <span data-ttu-id="55185-214">當先前的主體伺服器重新加入工作階段，它會認定其容錯移轉夥伴此時已擁有主體角色。</span><span class="sxs-lookup"><span data-stu-id="55185-214">When the former principal server rejoins the session, it recognizes that its failover partner now owns the principal role.</span></span> <span data-ttu-id="55185-215">先前的主體伺服器會接替鏡像的角色，並使其資料庫成為鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-215">The former principal server takes on the role of mirror, making its database the mirror database.</span></span> <span data-ttu-id="55185-216">新的鏡像伺服器會儘快將新的鏡像資料庫與主體資料庫進行同步處理。</span><span class="sxs-lookup"><span data-stu-id="55185-216">The new mirror server synchronizes the new mirror database with the principal database as quickly as possible.</span></span> <span data-ttu-id="55185-217">新鏡像伺服器重新同步處理資料庫後，就可以再次容錯移轉，但是方向會相反。</span><span class="sxs-lookup"><span data-stu-id="55185-217">As soon as the new mirror server has resynchronized the databases, failover is again possible, but in the reverse direction.</span></span>  
  
 <span data-ttu-id="55185-218">下圖顯示自動容錯移轉的單一執行個體。</span><span class="sxs-lookup"><span data-stu-id="55185-218">The following illustration shows a single instance of automatic failover.</span></span>  
  
 <span data-ttu-id="55185-219">![Automatic failover](../media/dbm-failovauto1round.gif "自動容錯移轉")</span><span class="sxs-lookup"><span data-stu-id="55185-219">![Automatic failover](../media/dbm-failovauto1round.gif "Automatic failover")</span></span>  
  
 <span data-ttu-id="55185-220">一開始，三部伺服器都已連接 (也就是工作階段具有完整的仲裁)。</span><span class="sxs-lookup"><span data-stu-id="55185-220">Initially, all three servers are connected (the session has full quorum).</span></span> <span data-ttu-id="55185-221">**Partner_A** 是主體伺服器， **Partner_B** 是鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="55185-221">**Partner_A** is the principal server and **Partner_B** is the mirror server.</span></span> <span data-ttu-id="55185-222">**Partner_A** (或 **Partner_A**上的主體資料庫) 變得無法使用。</span><span class="sxs-lookup"><span data-stu-id="55185-222">**Partner_A** (or the principal database on **Partner_A**) becomes unavailable.</span></span> <span data-ttu-id="55185-223">見證與 **Partner_B** 兩者皆認定主體已無法使用，且工作階段會重新取得仲裁。</span><span class="sxs-lookup"><span data-stu-id="55185-223">The witness and **Partner_B** both recognize that the principal is no longer available the session retains quorum.</span></span> <span data-ttu-id="55185-224">**Partner_B** 會成為主體伺服器，並使其資料庫副本成為新的主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-224">**Partner_B** becomes the principal server and makes its copy of the database available as the new principal database.</span></span> <span data-ttu-id="55185-225">最後， **Partner_A** 重新連接到工作階段，並發現 **Partner_B** 此時已擁有主體角色。</span><span class="sxs-lookup"><span data-stu-id="55185-225">Eventually, **Partner_A** reconnects to the session and discovers that **Partner_B** now owns the principal role.</span></span> <span data-ttu-id="55185-226">**Partner_A** 會接替鏡像角色。</span><span class="sxs-lookup"><span data-stu-id="55185-226">**Partner_A** then takes on the mirror role.</span></span>  
  
 <span data-ttu-id="55185-227">容錯移轉之後，用戶端必須重新連接到目前的主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-227">After failover, clients must reconnect to the current principal database.</span></span> <span data-ttu-id="55185-228">如需詳細資訊，請參閱本主題稍後的 [將用戶端連接至資料庫鏡像工作階段 &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-228">For more information, see [Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="55185-229">在容錯移轉發生時，凡是已利用 [!INCLUDE[msCoName](../../includes/msconame-md.md)] 分散式交易協調器準備好但尚未認可的交易，都會在資料庫完成容錯移轉後被視為已中止。</span><span class="sxs-lookup"><span data-stu-id="55185-229">Transactions that have been prepared using the [!INCLUDE[msCoName](../../includes/msconame-md.md)] Distributed Transaction Coordinator but are still not committed when a failover occurs, are considered aborted after the database has failed over.</span></span>  
  
###  <a name="to-disable-automatic-failover-sql-server-management-studio"></a><a name="DisableAutoSSMS"></a> <span data-ttu-id="55185-230">若要停用自動容錯移轉 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="55185-230">To Disable Automatic Failover (SQL Server Management Studio)</span></span>  
 <span data-ttu-id="55185-231">開啟 [資料庫屬性] 的 [鏡像] 頁面，並選取下列其中一項來變更作業模式：</span><span class="sxs-lookup"><span data-stu-id="55185-231">Open the **Database PropertiesMirroring** page, and change the operating mode by selecting one of the following options:</span></span>  
  
-   <span data-ttu-id="55185-232">**不具有自動容錯移轉的高安全性 (同步)**</span><span class="sxs-lookup"><span data-stu-id="55185-232">**High safety without automatic failover (synchronous)**</span></span>  
  
     <span data-ttu-id="55185-233">在此模式下，資料庫會繼續進行同步處理，而且可以手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-233">In this mode, the database continues to be synchronized, and manual failover remains possible.</span></span>  
  
-   <span data-ttu-id="55185-234">**高效能 (非同步)**</span><span class="sxs-lookup"><span data-stu-id="55185-234">**High performance (asynchronous)**</span></span>  
  
     <span data-ttu-id="55185-235">在此模式下，鏡像資料庫可能會稍微落後主體資料庫，而且無法進行手動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-235">In this mode, the mirror database might lag somewhat behind the principal database, and manual failover is no longer possible.</span></span>  
  
### <a name="to-disable-automatic-failover-using-transact-sql"></a><span data-ttu-id="55185-236">若要停用自動容錯移轉 (使用 Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="55185-236">To Disable Automatic Failover (Using Transact-SQL)</span></span>  
 <span data-ttu-id="55185-237">在資料庫鏡像工作階段的任何時間點上，資料庫擁有者可以透過關閉見證來停用自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="55185-237">At any point in a database mirroring session, the database owner can disable automatic failover by turning off the witness.</span></span>  
  
 <span data-ttu-id="55185-238">**若要關閉見證**</span><span class="sxs-lookup"><span data-stu-id="55185-238">**To turn off the witness**</span></span>  
  
-   [<span data-ttu-id="55185-239">從資料庫鏡像工作階段移除見證 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="55185-239">Remove the Witness from a Database Mirroring Session &#40;SQL Server&#41;</span></span>](remove-the-witness-from-a-database-mirroring-session-sql-server.md)  
  
    > [!NOTE]  
    >  <span data-ttu-id="55185-240">在保有完整交易安全性時關閉見證，會將工作階段置於不含自動容錯移轉的高安全性模式中。</span><span class="sxs-lookup"><span data-stu-id="55185-240">Turning off the witness while retaining full transaction safety puts the session into high-safety mode without automatic failover.</span></span>  
  
##  <a name="forced-service-with-possible-data-loss"></a><a name="ForcedService"></a> <span data-ttu-id="55185-241">Forced Service (with Possible Data Loss)</span><span class="sxs-lookup"><span data-stu-id="55185-241">Forced Service (with Possible Data Loss)</span></span>  
 <span data-ttu-id="55185-242">資料庫鏡像會提供強制服務 (可能遺失資料) 做為損毀復原方法，以便讓您將鏡像伺服器當做暖待命伺服器使用。</span><span class="sxs-lookup"><span data-stu-id="55185-242">Database mirroring provides forcing service (with possible data loss) as a disaster recovery method to allow you to use a mirror server as a warm standby server.</span></span> <span data-ttu-id="55185-243">只有當主體伺服器在鏡像工作階段中與鏡像伺服器中斷連接時，才能進行強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-243">Forcing service is possible only if the principal server is disconnected from the mirror server in a mirroring session.</span></span> <span data-ttu-id="55185-244">由於強制服務會面臨可能遺失資料的風險，所以應該小心並謹慎使用。</span><span class="sxs-lookup"><span data-stu-id="55185-244">Because forcing service risks possible data loss, it should be used cautiously and sparingly.</span></span>  
  
 <span data-ttu-id="55185-245">強制服務的支援會根據工作階段的作業模式和狀態而定，如下所示：</span><span class="sxs-lookup"><span data-stu-id="55185-245">Support for forced service depends on the operating mode and the state of the session, as follows:</span></span>  
  
-   <span data-ttu-id="55185-246">一般而言，每當主體伺服器中斷連接時，高效能模式就可支援強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-246">Typically, high-performance mode supports forcing service whenever the principal server is disconnected.</span></span> <span data-ttu-id="55185-247">不過，高效能模式工作階段的見證可以存在 (非必要)。</span><span class="sxs-lookup"><span data-stu-id="55185-247">However, though unnecessary, a witness can exist for a high-performance mode session.</span></span> <span data-ttu-id="55185-248">在此情況下，強制服務會要求鏡像伺服器和見證彼此連接。</span><span class="sxs-lookup"><span data-stu-id="55185-248">In this case, forcing service requires that the mirror server and witness are connected to each other.</span></span>  
  
-   <span data-ttu-id="55185-249">每當主體伺服器中斷連接時，不含自動容錯移轉的高安全性模式就可支援強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-249">High-safety mode without automatic failover supports forcing service whenever the principal server is disconnected.</span></span>  
  
-   <span data-ttu-id="55185-250">每當鏡像伺服器和見證彼此連接，而且它們都沒有連接至主體伺服器時 (只要鏡像伺服器上次連接至主體時，它並不在回復鏡像資料庫的處理序中)，具有自動容錯移轉的高安全性模式就可支援強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-250">High-safety mode with automatic failover supports forcing service whenever the mirror server and witness are connected to each other and neither is connected to the principal server (as long as the mirror server was not in the process of rolling back the mirror database when it was last connected to the principal).</span></span>  
  
 <span data-ttu-id="55185-251">只有在您必須立即還原資料庫的服務，並且願意承擔遺失資料的風險時，才建議使用強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-251">We recommend forcing service only if you must restore service to the database immediately and are willing to risk losing data.</span></span> <span data-ttu-id="55185-252">強制服務的效果類似於在可能遺失資料的風險下移除鏡像，不過在繼續進行鏡像作業時，強制服務可方便您重新同步處理資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-252">The effect of forcing service is similar to removing mirroring, except that forcing service facilitates resynchronizing the databases when mirroring is resumed, at the risk of possible data loss.</span></span> <span data-ttu-id="55185-253">強制服務會將主體角色平順地轉換至鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-253">Forcing service initiates a smooth transition of the principal role to the mirror database.</span></span> <span data-ttu-id="55185-254">鏡像伺服器將擔任主體伺服器的角色，並立即提供其資料庫副本來服務用戶端。</span><span class="sxs-lookup"><span data-stu-id="55185-254">The mirror server assumes the role of principal server and immediately serves its copy of the database to clients.</span></span> <span data-ttu-id="55185-255">新的主體資料庫會在沒有鏡像的情況下執行 (亦即，公開執行)。</span><span class="sxs-lookup"><span data-stu-id="55185-255">The new principal database runs without a mirror (that is, it runs exposed).</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="55185-256">如果主體伺服器僅與資料庫鏡像工作階段中斷連接，但它仍在執行時，某些用戶端可能會繼續存取原始的主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-256">If the principal server was merely disconnected from the database mirroring session and is still running, some clients might continue to access the original principal database.</span></span> <span data-ttu-id="55185-257">在您進行強制服務之前，請務必防止用戶端存取原始的主體伺服器。</span><span class="sxs-lookup"><span data-stu-id="55185-257">Before you force service, it is important to prevent clients from accessing the original principal server.</span></span> <span data-ttu-id="55185-258">否則，在強制服務之後，原始的主體資料庫和目前的主體資料庫可能會彼此獨立更新。</span><span class="sxs-lookup"><span data-stu-id="55185-258">Otherwise, after service is forced, the original principal database and the current principal database could be updated independently of the other.</span></span>  
  
  
  
###  <a name="typical-case-of-forced-service"></a><a name="TypicalCaseFS"></a> <span data-ttu-id="55185-259">強制服務的一般情況</span><span class="sxs-lookup"><span data-stu-id="55185-259">Typical Case of Forced Service</span></span>  
 <span data-ttu-id="55185-260">下圖將說明強制服務的一般情況 (可能遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="55185-260">The following figure illustrates a typical case of forced service (with possible data loss).</span></span>  
  
 <span data-ttu-id="55185-261">![在可能遺失資料的情況下強制服務](../media/dbm-forced-service.gif "在可能遺失資料的情況下強制服務")</span><span class="sxs-lookup"><span data-stu-id="55185-261">![Forcing service with possible data loss](../media/dbm-forced-service.gif "Forcing service with possible data loss")</span></span>  
  
 <span data-ttu-id="55185-262">在該圖中，原始的主體伺服器 **Partner_A**無法讓鏡像伺服器 **Partner_B**使用，進而導致鏡像資料庫中斷連接。</span><span class="sxs-lookup"><span data-stu-id="55185-262">In the figure, the original principal server, **Partner_A**, becomes unavailable to the mirror server, **Partner_B**, causing the mirror database to be disconnected.</span></span> <span data-ttu-id="55185-263">在確定用戶端無法使用 **Partner_A** 後，資料庫管理員便在 **Partner_B** 上進行強制服務 (可能遺失資料)。</span><span class="sxs-lookup"><span data-stu-id="55185-263">After ensuring that **Partner_A** is not available to clients, the database administrator forces service, with possible data loss, on **Partner_B**.</span></span> <span data-ttu-id="55185-264">**Partner_B** 成為主體伺服器，並「公開」資料庫執行 (亦即未鏡像)。</span><span class="sxs-lookup"><span data-stu-id="55185-264">**Partner_B** becomes the principal server and runs with the database *exposed* (that is, unmirrored).</span></span> <span data-ttu-id="55185-265">此時，用戶端可以重新連接至 **Partner_B**。</span><span class="sxs-lookup"><span data-stu-id="55185-265">At this point, clients can reconnect to **Partner_B**.</span></span>  
  
 <span data-ttu-id="55185-266">當 **Partner_A** 可以使用後，它就會重新連接至新的主體伺服器，並重新加入工作階段和擔任鏡像角色。</span><span class="sxs-lookup"><span data-stu-id="55185-266">When **Partner_A** becomes available, it reconnects to the new principal server, rejoining the session and assuming the mirror role.</span></span> <span data-ttu-id="55185-267">鏡像工作階段會立即暫停，而不會與新的鏡像資料庫進行同步處理。</span><span class="sxs-lookup"><span data-stu-id="55185-267">The mirroring session is suspended immediately, without having synchronized the new mirror database.</span></span> <span data-ttu-id="55185-268">暫停工作階段可讓資料庫管理員決定要繼續進行工作階段 (在極端情況下)，還是移除鏡像並嘗試搶救之前主體資料庫中的資料。</span><span class="sxs-lookup"><span data-stu-id="55185-268">Suspending the session allows the database administrator to decide whether to resume the session or, in extreme cases, remove mirroring and attempt to salvage data from the former principal database.</span></span> <span data-ttu-id="55185-269">在這個情況中，資料庫管理員選擇繼續進行鏡像。</span><span class="sxs-lookup"><span data-stu-id="55185-269">In this case, the database administrator chooses to resume mirroring.</span></span> <span data-ttu-id="55185-270">此時， **Partner_A** 會接管鏡像伺服器的角色並將之前的主體資料庫回復至上次成功同步處理交易的時間點。如果進行強制服務之前，任何已認可的交易未寫入鏡像伺服器的磁碟，這些交易就會遺失。</span><span class="sxs-lookup"><span data-stu-id="55185-270">At that point, **Partner_A** takes over the role of mirror server and rolls back the former principal database to the point in time of the last successfully synchronized transaction; if any committed transactions were not written to disk on the mirror server before service was forced, they are lost.</span></span> <span data-ttu-id="55185-271">然後，**Partner_A** 會藉由套用自從之前鏡像伺服器成為新主體伺服器以來在新主體資料庫上進行的所有變更，向前復原新的鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-271">**Partner_A** then rolls forward the new mirror database by applying any changes made on the new principal database since the former mirror server became the new principal server.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="55185-272">雖然高效能模式不需要見證，但是如果設定了見證，則只有在見證目前已連接到鏡像伺服器時，才能進行強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-272">Although high-performance mode does not require a witness, if one is configured, forcing service is possible only if the witness is currently connected to the mirror server.</span></span>  
  
###  <a name="risks-of-forcing-service"></a><a name="FSrisks"></a> <span data-ttu-id="55185-273">強制服務的風險</span><span class="sxs-lookup"><span data-stu-id="55185-273">Risks of Forcing Service</span></span>  
 <span data-ttu-id="55185-274">您必須了解，強制服務可能會導致資料遺失。</span><span class="sxs-lookup"><span data-stu-id="55185-274">It is essential to understand that forcing service can cause data loss.</span></span> <span data-ttu-id="55185-275">由於鏡像伺服器無法與主體伺服器進行通訊，而且無法保證兩個資料庫會同步處理，所以可能會遺失資料。</span><span class="sxs-lookup"><span data-stu-id="55185-275">Data loss is possible because the mirror server cannot communicate with the principal server and, therefore, cannot guarantee that the two databases are synchronized.</span></span> <span data-ttu-id="55185-276">此外，強制服務會啟動新的復原分岔。</span><span class="sxs-lookup"><span data-stu-id="55185-276">Forcing service starts a new recovery fork.</span></span> <span data-ttu-id="55185-277">由於原始的主體資料庫和鏡像資料庫位於不同的復原分岔，所以每個資料庫現在可能會包含其他資料庫沒有的資料：原始的主體資料庫會包含尚未從傳送佇列傳送至之前鏡像資料庫的所有變更 (未傳送記錄)，而之前的鏡像資料庫會包含強制服務之後進行的所有變更。</span><span class="sxs-lookup"><span data-stu-id="55185-277">Because the original principal database and mirror database are on different recovery forks, each database now contains data that the other database does not: the original principal database contains whatever changes were not yet sent from its send queue to the former mirror database (the unsent log); the former mirror database contains whatever changes occur after service was forced.</span></span>  
  
 <span data-ttu-id="55185-278">如果因為主體伺服器故障而進行強制服務，潛在資料遺失就會根據故障之前是否有任何交易記錄未傳送至鏡像伺服器而定。</span><span class="sxs-lookup"><span data-stu-id="55185-278">If service is forced because the principal server has failed, potential data loss is depends on whether any transaction logs were not sent to the mirror server before the failure.</span></span> <span data-ttu-id="55185-279">在高安全性模式下，只有在鏡像資料庫同步處理後才會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="55185-279">Under high-safety mode, this is possible only until the mirror database becomes synchronized.</span></span> <span data-ttu-id="55185-280">在高效能模式下，累積未傳送的記錄永遠是可能的。</span><span class="sxs-lookup"><span data-stu-id="55185-280">Under the high-performance mode, accumulated unsent log is always a possibility.</span></span>  
  
 <span data-ttu-id="55185-281">強制服務的含意會部分根據工作階段是否具有見證而定：</span><span class="sxs-lookup"><span data-stu-id="55185-281">The implications of forcing service depend partly on whether the session has a witness:</span></span>  
  
-   <span data-ttu-id="55185-282">如果見證不存在，只要夥伴中斷連接 (例如，由於網路連接中斷)，就可以進行強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-282">In the absence of a witness, service can be forced if the partners become disconnected, for example, because their network connection is broken.</span></span> <span data-ttu-id="55185-283">如果原始的主體伺服器仍在執行，這兩個夥伴就會同時擁有主體角色。</span><span class="sxs-lookup"><span data-stu-id="55185-283">If the original principal server is still running, both partners own the principal role.</span></span> <span data-ttu-id="55185-284">連接至新主體伺服器的用戶端將會存取目前的資料庫版本，而連接至原始主體伺服器的用戶端則會存取原始的主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-284">Clients connecting to the new principal server will access the current version of the database, while clients connecting to the original principal server will access the original principal database.</span></span> <span data-ttu-id="55185-285">這種情況就會增加資料遺失的可能性。</span><span class="sxs-lookup"><span data-stu-id="55185-285">This situation increases the potential for data loss.</span></span> <span data-ttu-id="55185-286">如果允許夥伴重新連接，原始的主體伺服器就會擔任鏡像角色並將它的資料庫狀態變更為「正在復原」，然後再暫停鏡像。</span><span class="sxs-lookup"><span data-stu-id="55185-286">If the partners are allowed to reconnect, the original principal server assumes the mirror role and changes the status of its database to "recovering," before mirroring is suspended.</span></span> <span data-ttu-id="55185-287">如果繼續進行工作階段，就會遺失自最近中斷連接以來位於原始主體資料庫上而記錄位於傳送佇列中的交易。</span><span class="sxs-lookup"><span data-stu-id="55185-287">If the session is resumed, transactions on the original principal database whose log was in the send queue as of the most recent disconnection are lost.</span></span> <span data-ttu-id="55185-288">此外，在強制服務後發生的所有交易也會遺失。</span><span class="sxs-lookup"><span data-stu-id="55185-288">In addition, any the transactions that occurred after service was forced are also lost.</span></span>  
  
-   <span data-ttu-id="55185-289">如果見證存在，當鏡像伺服器同時與主體伺服器和見證中斷連接後，只要後面兩者保持相互連接的狀態，主體就會公開執行。</span><span class="sxs-lookup"><span data-stu-id="55185-289">In the presence of a witness, if the mirror server is disconnected from both the principal server and the witness, as long as the latter two remain connected to each other, the principal runs exposed.</span></span> <span data-ttu-id="55185-290">如果主體伺服器之後與見證中斷連接，它就會停止服務資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-290">If the principal server then becomes disconnected from the witness, it stops serving the database.</span></span> <span data-ttu-id="55185-291">之後，當鏡像伺服器重新連接至見證時，就可以進行強制服務。</span><span class="sxs-lookup"><span data-stu-id="55185-291">Thereafter, if the mirror server reconnects to the witness, forcing service becomes possible.</span></span> <span data-ttu-id="55185-292">如果進行強制服務，當原始的主體伺服器重新連接時，在原始主體伺服器公開執行時進行的所有變更都會遺失。</span><span class="sxs-lookup"><span data-stu-id="55185-292">If service is forced, all the changes made while the original principal server was running exposed will be lost if the original principal server reconnects.</span></span>  
  
 <span data-ttu-id="55185-293">如需詳細資訊，請參閱本主題稍後的 [管理潛在資料遺失](#ManageDataLoss)。</span><span class="sxs-lookup"><span data-stu-id="55185-293">For more information, see [Managing the Potential Data Loss](#ManageDataLoss), later in this topic.</span></span>  
  
###  <a name="managing-the-potential-data-loss"></a><a name="ManageDataLoss"></a> <span data-ttu-id="55185-294">管理潛在資料遺失</span><span class="sxs-lookup"><span data-stu-id="55185-294">Managing the Potential Data Loss</span></span>  
 <span data-ttu-id="55185-295">在強制服務之後，一旦之前的主體伺服器可以使用，假設其資料庫未損毀，您就可以嘗試管理潛在資料遺失。</span><span class="sxs-lookup"><span data-stu-id="55185-295">After service is forced, once the former principal server is available, assuming that its database is undamaged, you can attempt to manage the potential data loss.</span></span> <span data-ttu-id="55185-296">管理潛在資料遺失的可用方法會根據原始的主體伺服器是否已重新連接至夥伴並重新加入鏡像工作階段而定。</span><span class="sxs-lookup"><span data-stu-id="55185-296">The available approach for managing potential data loss depends on whether the original principal server has reconnected to its partner and rejoined the mirroring session.</span></span> <span data-ttu-id="55185-297">假設原始的主體伺服器可以存取新的主體執行個體，就會自動且透明地進行重新連接。</span><span class="sxs-lookup"><span data-stu-id="55185-297">Assuming that the original principal server can access the new principal instance, reconnecting occurs automatically and transparently.</span></span>  
  
#### <a name="the-original-principal-server-has-reconnected"></a><span data-ttu-id="55185-298">原始的主體伺服器已重新連接</span><span class="sxs-lookup"><span data-stu-id="55185-298">The Original Principal Server Has Reconnected</span></span>  
 <span data-ttu-id="55185-299">一般而言，在發生故障後，當原始的主體伺服器重新啟動時，它就會迅速重新連接至夥伴。</span><span class="sxs-lookup"><span data-stu-id="55185-299">Typically, after a failure, when the original principal server restarts it quickly reconnects to its partner.</span></span> <span data-ttu-id="55185-300">重新連接後，原始的主體伺服器就會成為鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="55185-300">On reconnecting, the original principal server becomes the mirror server.</span></span> <span data-ttu-id="55185-301">它的資料庫會成為鏡像資料庫並進入正在復原的狀態，然後再暫停工作階段。</span><span class="sxs-lookup"><span data-stu-id="55185-301">Its database becomes the mirror database and enters the recovering state before the session is suspended.</span></span> <span data-ttu-id="55185-302">除非您繼續進行鏡像，否則鏡像資料庫不會回復。</span><span class="sxs-lookup"><span data-stu-id="55185-302">The mirror database will not be not rolled back unless you resume mirroring.</span></span>  
  
 <span data-ttu-id="55185-303">不過，正在復原的資料庫無法存取。因此，您無法檢查資料庫，以便評估繼續進行鏡像時哪些資料會遺失。</span><span class="sxs-lookup"><span data-stu-id="55185-303">However, the recovering database is inaccessible; therefore, you cannot inspect it to evaluate what data would be lost if you were to resume mirroring.</span></span> <span data-ttu-id="55185-304">因此，要繼續進行或移除鏡像的決定會根據您是否願意完全接受任何資料遺失而定。</span><span class="sxs-lookup"><span data-stu-id="55185-304">Therefore, the decision on whether to resume or remove mirroring depends on whether you are willing to accept any data loss at all.</span></span>  
  
-   <span data-ttu-id="55185-305">如果您無法接受遺失任何資料，就應該移除鏡像以便搶救資料。</span><span class="sxs-lookup"><span data-stu-id="55185-305">If losing any data would be unacceptable, you should remove mirroring to salvage them.</span></span>  
  
     <span data-ttu-id="55185-306">移除鏡像可讓資料庫管理員復原原始的主體資料庫並嘗試復原已經遺失的資料。</span><span class="sxs-lookup"><span data-stu-id="55185-306">Removing mirroring would allow the database administrator to recover the original principal database and attempt to recover the data that would have been lost.</span></span> <span data-ttu-id="55185-307">不過，當之前的鏡像資料庫成為線上狀態時，之前的夥伴將會服務相同名稱但內容不同的資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-307">However, when the former mirror database comes online, the former partners will be serving divergent databases with the same name.</span></span> <span data-ttu-id="55185-308">資料庫管理員必須讓其中一個資料庫無法供用戶端存取，藉以避免資料庫分歧擴大並防止用戶端容錯移轉問題發生。</span><span class="sxs-lookup"><span data-stu-id="55185-308">The database administrator needs to make one of the databases inaccessible to clients to avoid further divergence of the database and to prevent client-failover issues.</span></span>  
  
-   <span data-ttu-id="55185-309">如果您可以接受遺失任何資料，就可以繼續進行鏡像。</span><span class="sxs-lookup"><span data-stu-id="55185-309">If losing any data would be acceptable, you can resume mirroring.</span></span>  
  
     <span data-ttu-id="55185-310">繼續進行鏡像會導致新的鏡像資料庫回復至同步處理資料庫的第一個步驟。</span><span class="sxs-lookup"><span data-stu-id="55185-310">Resuming mirroring causes the new mirror database to be rolled back as the first step in synchronizing the database.</span></span> <span data-ttu-id="55185-311">如果發生故障時，有任何記錄檔記錄正在傳送佇列中等候，就會遺失對應的交易，即使這些交易已認可也一樣。</span><span class="sxs-lookup"><span data-stu-id="55185-311">If any log records were waiting in the send queue at the time of failure, the corresponding transactions are lost, even if they were committed.</span></span>  
  
#### <a name="the-original-principal-server-has-not-reconnected"></a><span data-ttu-id="55185-312">原始的主體伺服器尚未重新連接</span><span class="sxs-lookup"><span data-stu-id="55185-312">The Original Principal Server Has Not Reconnected</span></span>  
 <span data-ttu-id="55185-313">如果您可以暫時防止原始主體伺服器透過網路重新連接至新的主體伺服器，就可以檢查原始的主體資料庫，以便評估繼續進行鏡像時哪些資料會遺失。</span><span class="sxs-lookup"><span data-stu-id="55185-313">If you can temporarily prevent the original principal server from reconnecting over the network to the new principal server, you can inspect the original principal database to evaluate what data would be lost if mirroring were resumed.</span></span>  
  
-   <span data-ttu-id="55185-314">如果可以接受潛在資料遺失</span><span class="sxs-lookup"><span data-stu-id="55185-314">If the potential data loss is acceptable</span></span>  
  
     <span data-ttu-id="55185-315">請允許原始的主體伺服器重新連接至夥伴。</span><span class="sxs-lookup"><span data-stu-id="55185-315">Allow the original principal server to reconnect to its partner.</span></span> <span data-ttu-id="55185-316">重新連接會導致鏡像暫停。</span><span class="sxs-lookup"><span data-stu-id="55185-316">Reconnecting causes mirroring to be suspended.</span></span> <span data-ttu-id="55185-317">若要繼續進行鏡像，只要繼續進行工作階段即可。</span><span class="sxs-lookup"><span data-stu-id="55185-317">To proceed with mirroring, simply resume the session.</span></span> <span data-ttu-id="55185-318">之前的主體伺服器會擔任鏡像角色。</span><span class="sxs-lookup"><span data-stu-id="55185-318">The former principal server assumes the mirror role.</span></span> <span data-ttu-id="55185-319">新的鏡像伺服器會卸除原始的復原分岔，並遺失從未傳送至之前鏡像伺服器或由它接收的任何交易。</span><span class="sxs-lookup"><span data-stu-id="55185-319">The new mirror server drops the original recovery fork, losing any transactions that were never sent to or received by the former mirror server.</span></span>  
  
-   <span data-ttu-id="55185-320">如果無法接受資料遺失</span><span class="sxs-lookup"><span data-stu-id="55185-320">If the data loss is unacceptable</span></span>  
  
     <span data-ttu-id="55185-321">如果原始主體資料庫包含繼續工作階段後便會遺失的重要資料，您可以移除鏡像，以便將這些資料保存在原始主體伺服器上。</span><span class="sxs-lookup"><span data-stu-id="55185-321">If the original principal database contains critical data that would be lost if you resumed the session, you can preserve the data on the original principal server by removing mirroring.</span></span> <span data-ttu-id="55185-322">建議您在這個時候嘗試備份主體記錄的結尾。</span><span class="sxs-lookup"><span data-stu-id="55185-322">We recommend that you attempt to back up the tail of the principal's log at this point.</span></span> <span data-ttu-id="55185-323">接著，您可以從原始主體資料庫匯出要搶救的資料，再將它匯入目前的主體資料庫中，以便更新目前的主體 (先前的鏡像資料庫)。</span><span class="sxs-lookup"><span data-stu-id="55185-323">Then, you can update the current principal (the former mirror database) by exporting the data you want to salvage from the original principal database and importing it into the current principal database.</span></span> <span data-ttu-id="55185-324">我們建議您儘快建立更新資料庫的完整資料庫備份。</span><span class="sxs-lookup"><span data-stu-id="55185-324">We recommend taking a full database backup of the updated database as quickly as possible.</span></span>  
  
     <span data-ttu-id="55185-325">若要使用更新資料庫做為初始主體資料庫來重新建立鏡像，請使用此備份 (以及至少一個後續記錄備份) 來建立新的鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="55185-325">To re-establish mirroring with the updated database as the initial principal database, use this backup (and least one subsequent log backup) to create a new mirror database.</span></span> <span data-ttu-id="55185-326">移除鏡像之後建立的每個記錄備份都必須套用。</span><span class="sxs-lookup"><span data-stu-id="55185-326">Every log backup taken after mirroring was removed must be applied.</span></span> <span data-ttu-id="55185-327">因此，我們建議延遲主體資料庫的其他記錄備份，直到新的鏡像工作階段啟動為止。</span><span class="sxs-lookup"><span data-stu-id="55185-327">Therefore, we recommend delaying additional log backups of the principal database until the new mirroring session starts.</span></span>  
  
###  <a name="related-tasks-for-managing-a-forced-failover"></a><a name="RelatedTasksForFS"></a> <span data-ttu-id="55185-328">管理強制容錯移轉的相關工作</span><span class="sxs-lookup"><span data-stu-id="55185-328">Related Tasks For Managing a Forced Failover</span></span>  
 <span data-ttu-id="55185-329">**若要強制執行服務**</span><span class="sxs-lookup"><span data-stu-id="55185-329">**To force service**</span></span>  
  
-   <span data-ttu-id="55185-330">[在資料庫鏡像工作階段中強制服務 &#40;Transact-SQL&#41;](force-service-in-a-database-mirroring-session-transact-sql.md)。</span><span class="sxs-lookup"><span data-stu-id="55185-330">[Force Service in a Database Mirroring Session &#40;Transact-SQL&#41;](force-service-in-a-database-mirroring-session-transact-sql.md).</span></span>  
  
 <span data-ttu-id="55185-331">**若要繼續資料庫鏡像**</span><span class="sxs-lookup"><span data-stu-id="55185-331">**To resume database mirroring**</span></span>  
  
-   [<span data-ttu-id="55185-332">暫停或繼續資料庫鏡像工作階段 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="55185-332">Pause or Resume a Database Mirroring Session &#40;SQL Server&#41;</span></span>](pause-or-resume-a-database-mirroring-session-sql-server.md)  
  
 <span data-ttu-id="55185-333">**若要建立新的鏡像資料庫**</span><span class="sxs-lookup"><span data-stu-id="55185-333">**To create a new mirror database**</span></span>  
  
 [<span data-ttu-id="55185-334">準備鏡像資料庫以進行鏡像 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="55185-334">Prepare a Mirror Database for Mirroring &#40;SQL Server&#41;</span></span>](prepare-a-mirror-database-for-mirroring-sql-server.md)  
  
 <span data-ttu-id="55185-335">**若要啟動資料庫鏡像**</span><span class="sxs-lookup"><span data-stu-id="55185-335">**To start up database mirroring**</span></span>  
  
-   [<span data-ttu-id="55185-336">設定資料庫鏡像 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="55185-336">Setting Up Database Mirroring &#40;SQL Server&#41;</span></span>](setting-up-database-mirroring-sql-server.md)  
  
-   [<span data-ttu-id="55185-337">使用 Windows 驗證建立資料庫鏡像工作階段 &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="55185-337">Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;</span></span>](establish-database-mirroring-session-windows-authentication.md)  
  
## <a name="see-also"></a><span data-ttu-id="55185-338">另請參閱</span><span class="sxs-lookup"><span data-stu-id="55185-338">See Also</span></span>  
 <span data-ttu-id="55185-339">[預估角色切換期間的服務中斷時間 &#40;資料庫鏡像&#41;](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md) </span><span class="sxs-lookup"><span data-stu-id="55185-339">[Estimate the Interruption of Service During Role Switching &#40;Database Mirroring&#41;](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md) </span></span>  
 <span data-ttu-id="55185-340">[資料庫鏡像期間可能發生的失敗](possible-failures-during-database-mirroring.md) </span><span class="sxs-lookup"><span data-stu-id="55185-340">[Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md) </span></span>  
 <span data-ttu-id="55185-341">[將用戶端連接至資料庫鏡像工作階段 &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="55185-341">[Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md) </span></span>  
 <span data-ttu-id="55185-342">[資料庫鏡像見證](database-mirroring-witness.md) </span><span class="sxs-lookup"><span data-stu-id="55185-342">[Database Mirroring Witness](database-mirroring-witness.md) </span></span>  
 <span data-ttu-id="55185-343">[完整資料庫還原 &#40;完整復原模式&#41;](../../relational-databases/backup-restore/complete-database-restores-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="55185-343">[Complete Database Restores &#40;Full Recovery Model&#41;](../../relational-databases/backup-restore/complete-database-restores-full-recovery-model.md) </span></span>  
 <span data-ttu-id="55185-344">[資料庫鏡像作業模式](database-mirroring-operating-modes.md) </span><span class="sxs-lookup"><span data-stu-id="55185-344">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) </span></span>  
 [<span data-ttu-id="55185-345">鏡像狀態 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="55185-345">Mirroring States &#40;SQL Server&#41;</span></span>](mirroring-states-sql-server.md)  
  
  
