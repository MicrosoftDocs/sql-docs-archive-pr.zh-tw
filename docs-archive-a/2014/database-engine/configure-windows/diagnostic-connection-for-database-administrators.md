---
title: 資料庫管理員的診斷連接 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- server management [SQL Server], connections
- administrator connections [SQL Server]
- ports [SQL Server], DAC
- DAC
- network connections [SQL Server], dedicated administrator
- diagnostic connections [SQL Server]
- connections [SQL Server], dedicated administrator
- ports [SQL Server]
- dedicated administrator connections [SQL Server]
ms.assetid: 993e0820-17f2-4c43-880c-d38290bf7abc
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0d452ca155a5187136c910e81e8bd073e34cad56
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87596903"
---
# <a name="diagnostic-connection-for-database-administrators"></a><span data-ttu-id="8d3cb-102">資料庫管理員的診斷連接</span><span class="sxs-lookup"><span data-stu-id="8d3cb-102">Diagnostic Connection for Database Administrators</span></span>
  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="8d3cb-103">為系統管理員提供了特殊的診斷連接，可在伺服器的標準連接失效時使用。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-103">provides a special diagnostic connection for administrators when standard connections to the server are not possible.</span></span> <span data-ttu-id="8d3cb-104">這個診斷連接可讓系統管理員存取 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 以執行診斷查詢和排解疑難問題，即使 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 未回應標準連接要求。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-104">This diagnostic connection allows an administrator to access [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] to execute diagnostic queries and troubleshoot problems even when [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is not responding to standard connection requests.</span></span>  
  
 <span data-ttu-id="8d3cb-105">此專用管理員連接 (DAC) 支援加密以及 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的其他安全性功能。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-105">This dedicated administrator connection (DAC) supports encryption and other security features of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="8d3cb-106">DAC 只允許將使用者內容變更為其他管理使用者。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-106">The DAC only allows changing the user context to another admin user.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="8d3cb-107">將不斷嘗試以便讓 DAC 順利連接，但是在極端的情況下可能無法成功。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-107">makes every attempt to make DAC connect successfully, but under extreme situations it may not be successful.</span></span>  
  
||  
|-|  
|<span data-ttu-id="8d3cb-108">**適用**于： [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] 透過[目前版本](https://go.microsoft.com/fwlink/p/?LinkId=299658)) 的 ([!INCLUDE[sqldbesa](../../includes/sqldbesa-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-108">**Applies to**: [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ([!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] through [current version](https://go.microsoft.com/fwlink/p/?LinkId=299658)), [!INCLUDE[sqldbesa](../../includes/sqldbesa-md.md)].</span></span>|  
  
## <a name="connecting-with-dac"></a><span data-ttu-id="8d3cb-109">連接 DAC</span><span class="sxs-lookup"><span data-stu-id="8d3cb-109">Connecting with DAC</span></span>  
 <span data-ttu-id="8d3cb-110">依預設，只能從執行於伺服器上的用戶端進行連接。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-110">By default, the connection is only allowed from a client running on the server.</span></span> <span data-ttu-id="8d3cb-111">除非使用 sp_configure 預存程序搭配 [remote admin connections 選項](remote-admin-connections-server-configuration-option.md)來設定網路連接，否則不允許進行網路連接。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-111">Network connections are not permitted unless they are configured by using the sp_configure stored procedure with the [remote admin connections option](remote-admin-connections-server-configuration-option.md).</span></span>  
  
 <span data-ttu-id="8d3cb-112">只有 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 系統管理員 (sysadmin) 角色的成員可以使用 DAC 進行連接。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-112">Only members of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] sysadmin role can connect using the DAC.</span></span>  
  
 <span data-ttu-id="8d3cb-113">DAC 的存取與支援是使用特殊的系統管理員參數 ( **-A** )，透過**sqlcmd**命令提示字元公用程式來執行。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-113">The DAC is available and supported through the **sqlcmd** command-prompt utility using a special administrator switch (**-A**).</span></span> <span data-ttu-id="8d3cb-114">如需使用 **sqlcmd** 的詳細資訊，請參閱[以指令碼變數使用 sqlcmd](../../relational-databases/scripting/sqlcmd-use-with-scripting-variables.md)。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-114">For more information about using **sqlcmd**, see [Use sqlcmd with Scripting Variables](../../relational-databases/scripting/sqlcmd-use-with-scripting-variables.md).</span></span> <span data-ttu-id="8d3cb-115">您也可以 `admin:` 用**Sadmin：** _<instance_name>_ 的格式，在實例名稱前面加上前置。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-115">You can also connect prefixing `admin:`to the instance name in the format **sqlcmd -Sadmin:**_<instance_name>._</span></span> <span data-ttu-id="8d3cb-116">您也可以藉 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] 由連接到，從查詢編輯器起始 DAC `admin:` \<*instance_name*> 。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-116">You can also initiate a DAC from a [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] Query Editor by connecting to `admin:`\<*instance_name*>.</span></span>  
  
## <a name="restrictions"></a><span data-ttu-id="8d3cb-117">限制</span><span class="sxs-lookup"><span data-stu-id="8d3cb-117">Restrictions</span></span>  
 <span data-ttu-id="8d3cb-118">由於 DAC 僅在少數的情況下才會為了診斷伺服器問題而建立，因此這項連接有某些限制：</span><span class="sxs-lookup"><span data-stu-id="8d3cb-118">Because the DAC exists solely for diagnosing server problems in rare circumstances, there are some restrictions on the connection:</span></span>  
  
-   <span data-ttu-id="8d3cb-119">若要保證有足夠的資源可供連接使用，每個 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]執行個體只能有一個 DAC。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-119">To guarantee that there are resources available for the connection, only one DAC is allowed per instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="8d3cb-120">若已有作用中的 DAC 連接存在，則所有透過 DAC 建立連接的新要求都會遭到拒絕，並產生錯誤 17810。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-120">If a DAC connection is already active, any new request to connect through the DAC is denied with error 17810.</span></span>  
  
-   <span data-ttu-id="8d3cb-121">為了節省資源，除非以追蹤旗標 7806 啟動，否則 [!INCLUDE[ssExpress](../../includes/ssexpress-md.md)] 不會接聽 DAC 通訊埠。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-121">To conserve resources, [!INCLUDE[ssExpress](../../includes/ssexpress-md.md)] does not listen on the DAC port unless started with a trace flag 7806.</span></span>  
  
-   <span data-ttu-id="8d3cb-122">DAC 最初會嘗試連接到與登入相關聯的預設資料庫。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-122">The DAC initially attempts to connect to the default database associated with the login.</span></span> <span data-ttu-id="8d3cb-123">連接成功後，您就可以連接到 master 資料庫。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-123">After it is successfully connected, you can connect to the master database.</span></span> <span data-ttu-id="8d3cb-124">如果預設資料庫離線或是無法使用，連接將會傳回錯誤 4060。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-124">If the default database is offline or otherwise not available, the connection will return error 4060.</span></span> <span data-ttu-id="8d3cb-125">但是，若您使用下列命令來覆寫預設資料庫以連接到 master 資料庫，連接就會成功：</span><span class="sxs-lookup"><span data-stu-id="8d3cb-125">However, it will succeed if you override the default database to connect to the master database instead using the following command:</span></span>  
  
     <span data-ttu-id="8d3cb-126">**sqlcmd-A-d 主機**</span><span class="sxs-lookup"><span data-stu-id="8d3cb-126">**sqlcmd -A -d master**</span></span>  
  
     <span data-ttu-id="8d3cb-127">建議您使用 DAC 連接到 master 資料庫，因為只要啟動 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 執行個體，就一定可以使用 master。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-127">We recommend that you connect to the master database with the DAC because master is guaranteed to be available if the instance of the [!INCLUDE[ssDE](../../includes/ssde-md.md)] is started.</span></span>  
  
-   [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="8d3cb-128">禁止以 DAC 執行平行查詢或命令。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-128">prohibits running parallel queries or commands with the DAC.</span></span> <span data-ttu-id="8d3cb-129">例如，若您以 DAC 執行下列其中一項陳述式，就會產生錯誤 3637：</span><span class="sxs-lookup"><span data-stu-id="8d3cb-129">For example, error 3637 is generated if you execute either of the following statements with the DAC:</span></span>  
  
    -   <span data-ttu-id="8d3cb-130">RESTORE</span><span class="sxs-lookup"><span data-stu-id="8d3cb-130">RESTORE</span></span>  
  
    -   <span data-ttu-id="8d3cb-131">備份</span><span class="sxs-lookup"><span data-stu-id="8d3cb-131">BACKUP</span></span>  
  
-   <span data-ttu-id="8d3cb-132">只有某些限定的資源必定可透過 DAC 來使用。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-132">Only limited resources are guaranteed to be available with the DAC.</span></span> <span data-ttu-id="8d3cb-133">請勿使用 DAC 來執行需耗用大量資源的查詢 (例如，</span><span class="sxs-lookup"><span data-stu-id="8d3cb-133">Do not use the DAC to run resource-intensive queries (for example.</span></span> <span data-ttu-id="8d3cb-134">大型資料表上的複雜聯結) 或可能會封鎖的查詢。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-134">a complex join on large table) or queries that may block.</span></span> <span data-ttu-id="8d3cb-135">如此可防止 DAC 在現有的伺服器問題外衍生出其他問題。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-135">This helps prevent the DAC from compounding any existing server problems.</span></span> <span data-ttu-id="8d3cb-136">為了避免潛在的封鎖情況，若您必須執行可能會封鎖的查詢，請盡可能在快照隔離等級下執行查詢；否則，請將交易隔離等級設為 READ UNCOMMITTED，並將 LOCK_TIMEOUT 值設為 2000 毫秒之類的短數值。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-136">To avoid potential blocking scenarios, if you have to run queries that may block, run the query under snapshot-based isolation levels if possible; otherwise, set the transaction isolation level to READ UNCOMMITTED and set the LOCK_TIMEOUT value to a short value such as 2000 milliseconds, or both.</span></span> <span data-ttu-id="8d3cb-137">如此可防止 DAC 工作階段產生封鎖的情形。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-137">This will prevent the DAC session from getting blocked.</span></span> <span data-ttu-id="8d3cb-138">但依照 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 所處的狀態，DAC 工作階段也可能會遭到閂鎖封鎖。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-138">However, depending on the state that the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is in, the DAC session might get blocked on a latch.</span></span> <span data-ttu-id="8d3cb-139">您可以使用 CNTRL-C 來結束 DAC 工作階段，但不一定能成功。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-139">You might be able to terminate the DAC session using CNTRL-C but it is not guaranteed.</span></span> <span data-ttu-id="8d3cb-140">在這種情況下，重新啟動 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]可能是唯一的選擇。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-140">In that case, your only option may be to restart [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="8d3cb-141">為了保證 DAC 連接與疑難排解能順利進行， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 會保留有限的資源來處理 DAC 所執行的命令。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-141">To guarantee connectivity and troubleshooting with the DAC, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] reserves limited resources to process commands run on the DAC.</span></span> <span data-ttu-id="8d3cb-142">通常，這些資源僅足夠用來執行簡單的診斷與疑難排解功能，如下表所示。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-142">These resources are typically only enough for simple diagnostic and troubleshooting functions, such as those listed below.</span></span>  
  
 <span data-ttu-id="8d3cb-143">雖然，理論上您可以在 DAC 上執行任何不需要以平行方式執行的 [!INCLUDE[tsql](../../includes/tsql-md.md)] 陳述式，但我們還是強烈建議您將使用方式限定在下列診斷與疑難排解命令：</span><span class="sxs-lookup"><span data-stu-id="8d3cb-143">Although you can theoretically run any [!INCLUDE[tsql](../../includes/tsql-md.md)] statement that does not have to execute in parallel on the DAC, we strongly recommend that you restrict usage to the following diagnostic and troubleshooting commands:</span></span>  
  
-   <span data-ttu-id="8d3cb-144">查詢動態管理檢視以進行基本診斷，例如 sys.dm_tran_locks 可了解封鎖狀態、sys.dm_os_memory_cache_counters 可檢查快取的健全狀態，而 sys.dm_exec_requests 和 sys.dm_exec_sessions 可了解作用中的工作階段與要求。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-144">Querying dynamic management views for basic diagnostics such as sys.dm_tran_locks for the locking status, sys.dm_os_memory_cache_counters to check the health of caches, and sys.dm_exec_requests and sys.dm_exec_sessions for active sessions and requests.</span></span> <span data-ttu-id="8d3cb-145">請避免使用會耗用大量資源 (例如 sys.dm_tran_version_store 會掃描完整版本存放區而產生大量 I/O) 或使用複雜聯結的動態管理檢視。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-145">Avoid dynamic management views that are resource intensive (for example, sys.dm_tran_version_store scans the full version store and can cause extensive I/O) or that use complex joins.</span></span> <span data-ttu-id="8d3cb-146">如需效能含意的資訊，請參閱特定 [動態管理檢視](../../relational-databases/views/views.md)的文件集。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-146">For information about performance implications, see the documentation for the specific [dynamic management view](../../relational-databases/views/views.md).</span></span>  
  
-   <span data-ttu-id="8d3cb-147">查詢目錄檢視。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-147">Querying catalog views.</span></span>  
  
-   <span data-ttu-id="8d3cb-148">基本 DBCC 命令，例如 DBCC FREEPROCCACHE、DBCC FREESYSTEMCACHE、DBCC DROPCLEANBUFFERS`,` 及 DBCC SQLPERF。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-148">Basic DBCC commands such as DBCC FREEPROCCACHE, DBCC FREESYSTEMCACHE, DBCC DROPCLEANBUFFERS`,` and DBCC SQLPERF.</span></span> <span data-ttu-id="8d3cb-149">請勿執行需要大量資源的命令，例如**dbcc** CHECKDB、dbcc DBREINDEX 或 dbcc SHRINKDATABASE。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-149">Do not run resource-intensive commands such as **DBCC** CHECKDB, DBCC DBREINDEX, or DBCC SHRINKDATABASE.</span></span>  
  
-   [!INCLUDE[tsql](../../includes/tsql-md.md)] <span data-ttu-id="8d3cb-150">KILL *\<spid>* 命令。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-150">KILL*\<spid>* command.</span></span> <span data-ttu-id="8d3cb-151">根據 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的狀態而定，KILL 命令可能不會每次都成功，這時只能選擇重新啟動 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-151">Depending on the state of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the KILL command might not always succeed; then the only option may be to restart [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="8d3cb-152">下面是部分一般方針：</span><span class="sxs-lookup"><span data-stu-id="8d3cb-152">The following are some general guidelines:</span></span>  
  
    -   <span data-ttu-id="8d3cb-153">藉由查詢 `SELECT * FROM sys.dm_exec_sessions WHERE session_id = <spid>`，來確認是否已確實清除 SPID。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-153">Verify that the SPID was actually killed by querying `SELECT * FROM sys.dm_exec_sessions WHERE session_id = <spid>`.</span></span> <span data-ttu-id="8d3cb-154">若未傳回資料列，表示已清除工作階段。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-154">If it returns no rows, it means the session was killed.</span></span>  
  
    -   <span data-ttu-id="8d3cb-155">若工作階段仍然存在，請執行 `SELECT * FROM sys.dm_os_tasks WHERE session_id = <spid>`查詢，以確認此工作階段上是否有指定的工作。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-155">If the session is still there, verify whether there are tasks assigned to this session by running the query `SELECT * FROM sys.dm_os_tasks WHERE session_id = <spid>`.</span></span> <span data-ttu-id="8d3cb-156">若您在工作階段上看到工作，很可能表示工作階段正在清除中。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-156">If you see the task there, most likely your session is currently being killed.</span></span> <span data-ttu-id="8d3cb-157">請注意，此作業可能會耗費大量時間，而且可能完全無法成功。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-157">Note that this may take considerable amount of time and may not succeed at all.</span></span>  
  
    -   <span data-ttu-id="8d3cb-158">若在與此工作階段相關聯的 sys.dm_os_tasks 中沒有工作存在，但工作階段在執行 KILL 命令後仍處於 sys.dm_exec_sessions 中，則表示您沒有可用的工作者。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-158">If there are no tasks in the sys.dm_os_tasks associated with this session, but the session remains in sys.dm_exec_sessions after executing the KILL command, it means that you do not have a worker available.</span></span> <span data-ttu-id="8d3cb-159">請選取目前正在執行的其中一個工作 (列示於 sys.dm_os_tasks 檢視表中而含有 `sessions_id <> NULL`的工作)，然後清除與此工作相關聯的工作階段以釋放工作者。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-159">Select one of the currently running tasks (a task listed in the sys.dm_os_tasks view with a `sessions_id <> NULL`), and kill the session associated with it to free up the worker.</span></span> <span data-ttu-id="8d3cb-160">請注意，終止單一工作階段可能不夠：您可能必須清除多個工作階段。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-160">Note that it may not be enough to kill a single session: you may have to kill multiple ones.</span></span>  
  
## <a name="dac-port"></a><span data-ttu-id="8d3cb-161">DAC 通訊埠</span><span class="sxs-lookup"><span data-stu-id="8d3cb-161">DAC Port</span></span>  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="8d3cb-162">如果在啟動 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 之後有可用或動態指派的 TCP 通訊埠，會在 TCP 通訊埠 1434 上接聽 DAC。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-162">listens for the DAC on TCP port 1434 if available or a TCP port dynamically assigned upon [!INCLUDE[ssDE](../../includes/ssde-md.md)] startup.</span></span> <span data-ttu-id="8d3cb-163">錯誤記錄檔包含 DAC 接聽時所使用的通訊埠編號。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-163">The error log contains the port number the DAC is listening on.</span></span> <span data-ttu-id="8d3cb-164">依預設，DAC 接聽程式只接受本機通訊埠上的連接。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-164">By default the DAC listener accepts connection on only the local port.</span></span> <span data-ttu-id="8d3cb-165">如需可啟動遠端管理連接的程式碼範例，請參閱 [remote admin connections 伺服器組態選項](remote-admin-connections-server-configuration-option.md)。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-165">For a code sample that activates remote administration connections, see [remote admin connections Server Configuration Option](remote-admin-connections-server-configuration-option.md).</span></span>  
  
 <span data-ttu-id="8d3cb-166">一旦設定遠端管理連接之後，即會啟用 DAC 接聽程式而不需重新啟動 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ，而且用戶端可以從遠端連接到 DAC。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-166">After the remote administration connection is configured, the DAC listener is enabled without requiring a restart of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] and a client can now connect to the DAC remotely.</span></span> <span data-ttu-id="8d3cb-167">您可以先在本機使用 DAC 連接到 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ，然後執行 sp_configure 預存程序以接受遠端的連接，藉以啟用 DAC 接聽程式使其可接受遠端連接，即使 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 未回應仍可執行。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-167">You can enable the DAC listener to accept connections remotely even if [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is unresponsive by first connecting to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] using the DAC locally, and then executing the sp_configure stored procedure to accept connection from remote connections.</span></span>  
  
 <span data-ttu-id="8d3cb-168">在叢集組態中，DAC 預設為關閉。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-168">On cluster configurations, the DAC will be off by default.</span></span> <span data-ttu-id="8d3cb-169">使用者可執行 sp_configure 的 remote admin connection 選項，啟用 DAC 接聽程式以存取遠端連接。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-169">Users can execute the remote admin connection option of sp_configure to enable the DAC listener to access a remote connection.</span></span> <span data-ttu-id="8d3cb-170">若 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 未回應且 DAC 接聽程式未啟用，您可能必須重新啟動 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 以連接 DAC。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-170">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is unresponsive and the DAC listener is not enabled, you might have to restart [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] to connect with the DAC.</span></span> <span data-ttu-id="8d3cb-171">因此，建議您在叢集系統上啟用 remote admin connections 組態選項。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-171">Therefore, we recommend that you enable the remote admin connections configuration option on clustered systems.</span></span>  
  
 <span data-ttu-id="8d3cb-172">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 會在啟動期間動態指定 DAC 通訊埠。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-172">The DAC port is assigned dynamically by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] during startup.</span></span> <span data-ttu-id="8d3cb-173">連接到預設執行個體時，DAC 會在連接時避免對 SQL Server Browser 服務使用 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 解析通訊協定 (SSRP) 要求。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-173">When connecting to the default instance, the DAC avoids using a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Resolution Protocol (SSRP) request to the SQL Server Browser Service when connecting.</span></span> <span data-ttu-id="8d3cb-174">它會先透過 TCP 通訊埠 1434 連接。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-174">It first connects over TCP port 1434.</span></span> <span data-ttu-id="8d3cb-175">若失敗，則會發出 SSRP 呼叫以取得通訊埠。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-175">If that fails, it makes an SSRP call to get the port.</span></span> <span data-ttu-id="8d3cb-176">若 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Browser 並未接聽 SSRP 要求，則連接要求會傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-176">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Browser is not listening for SSRP requests, the connection request returns an error.</span></span> <span data-ttu-id="8d3cb-177">請參閱錯誤記錄檔，以了解 DAC 接聽時所使用的通訊埠編號。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-177">Refer to the error log to find the port number DAC is listening on.</span></span> <span data-ttu-id="8d3cb-178">若 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的組態可接受遠端管理連接，DAC 就必須以明確的通訊埠編號起始：</span><span class="sxs-lookup"><span data-stu-id="8d3cb-178">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is configured to accept remote administration connections, the DAC must be initiated with an explicit port number:</span></span>  
  
 <span data-ttu-id="8d3cb-179">**sqlcmd-Stcp：** _ \<server> 、 \<port> _</span><span class="sxs-lookup"><span data-stu-id="8d3cb-179">**sqlcmd-Stcp:** _\<server>,\<port>_</span></span>  
  
 <span data-ttu-id="8d3cb-180">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 錯誤記錄檔會列出 DAC 的通訊埠編號，依預設為 1434。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-180">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log lists the port number for the DAC, which is 1434 by default.</span></span> <span data-ttu-id="8d3cb-181">若將 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 設定為只接受本機 DAC 連接，請利用下列命令使用回送配接器進行連接：</span><span class="sxs-lookup"><span data-stu-id="8d3cb-181">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is configured to accept local DAC connections only, connect using the loopback adapter using the following command:</span></span>  
  
 <span data-ttu-id="8d3cb-182">**sqlcmd-s 127.0.0.1**、`1434`</span><span class="sxs-lookup"><span data-stu-id="8d3cb-182">**sqlcmd-S127.0.0.1**,`1434`</span></span>  
  
## <a name="example"></a><span data-ttu-id="8d3cb-183">範例</span><span class="sxs-lookup"><span data-stu-id="8d3cb-183">Example</span></span>  
 <span data-ttu-id="8d3cb-184">在此範例中，系統管理員注意到伺服器 `URAN123` 並未回應，而要診斷問題。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-184">In this example, an administrator notices that server `URAN123` is not responding and wants to diagnose the problem.</span></span> <span data-ttu-id="8d3cb-185">為了進行這項作業，使用者啟動 `sqlcmd` 命令提示字元公用程式，並使用 `URAN123` 來表示 DAC，連接到伺服器 `-A` 。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-185">To do this, the user activates the `sqlcmd` command prompt utility and connects to server `URAN123` using `-A` to indicate the DAC.</span></span>  
  
 `sqlcmd -S URAN123 -U sa -P <xxx> -A`  
  
 <span data-ttu-id="8d3cb-186">此時，系統管理員可執行查詢以診斷問題，並盡可能結束未回應的工作階段。</span><span class="sxs-lookup"><span data-stu-id="8d3cb-186">The administrator can now execute queries to diagnose the problem and possibly terminate the unresponsive sessions.</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="8d3cb-187">相關工作</span><span class="sxs-lookup"><span data-stu-id="8d3cb-187">Related Tasks</span></span>  
  
## <a name="related-content"></a><span data-ttu-id="8d3cb-188">相關內容</span><span class="sxs-lookup"><span data-stu-id="8d3cb-188">Related Content</span></span>  
 [<span data-ttu-id="8d3cb-189">以指令碼變數使用 sqlcmd</span><span class="sxs-lookup"><span data-stu-id="8d3cb-189">Use sqlcmd with Scripting Variables</span></span>](../../relational-databases/scripting/sqlcmd-use-with-scripting-variables.md)  
  
 [<span data-ttu-id="8d3cb-190">sqlcmd 公用程式</span><span class="sxs-lookup"><span data-stu-id="8d3cb-190">sqlcmd Utility</span></span>](../../tools/sqlcmd-utility.md)  
  
 [<span data-ttu-id="8d3cb-191">SELECT &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-191">SELECT &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/queries/select-transact-sql)  
  
 [<span data-ttu-id="8d3cb-192">sp_who &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-192">sp_who &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-who-transact-sql)  
  
 [<span data-ttu-id="8d3cb-193">sp_lock &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-193">sp_lock &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-lock-transact-sql)  
  
 [<span data-ttu-id="8d3cb-194">KILL &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-194">KILL &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/language-elements/kill-transact-sql)  
  
 [<span data-ttu-id="8d3cb-195">DBCC CHECKALLOC &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-195">DBCC CHECKALLOC &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql)  
  
 [<span data-ttu-id="8d3cb-196">DBCC CHECKDB &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-196">DBCC CHECKDB &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql)  
  
 [<span data-ttu-id="8d3cb-197">DBCC OPENTRAN &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-197">DBCC OPENTRAN &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql)  
  
 [<span data-ttu-id="8d3cb-198">DBCC INPUTBUFFER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-198">DBCC INPUTBUFFER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-inputbuffer-transact-sql)  
  
 [<span data-ttu-id="8d3cb-199">伺服器組態選項 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-199">Server Configuration Options &#40;SQL Server&#41;</span></span>](server-configuration-options-sql-server.md)  
  
 [<span data-ttu-id="8d3cb-200">交易相關的動態管理檢視和函數 &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-200">Transaction Related Dynamic Management Views and Functions &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-dynamic-management-views/transaction-related-dynamic-management-views-and-functions-transact-sql)  
  
 [<span data-ttu-id="8d3cb-201">追蹤旗標 &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="8d3cb-201">Trace Flags &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql)  
  
  
