---
title: affinity mask 伺服器組態選項 | Microsoft Docs
ms.custom: ''
ms.date: 10/20/2016
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- default affinity mask option
- reloading processor cache
- processor cache [SQL Server]
- CPU [SQL Server], licensing
- deferred process call
- affinity mask option
- processor affinity [SQL Server]
- SMP
- DPC
ms.assetid: 5823ba29-a75d-4b3e-ba7b-421c07ab3ac1
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: dfebde8a9431026e8faedb2a1e76eb2f2d82e207
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87597354"
---
# <a name="affinity-mask-server-configuration-option"></a><span data-ttu-id="7c79c-102">affinity mask 伺服器組態選項</span><span class="sxs-lookup"><span data-stu-id="7c79c-102">affinity mask Server Configuration Option</span></span>
    
> [!NOTE]  
>  [!INCLUDE[ssNoteDepFutureDontUse](../../includes/ssnotedepfuturedontuse-md.md)] <span data-ttu-id="7c79c-103">請改用 [ALTER SERVER CONFIGURATION &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-server-configuration-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="7c79c-103">Use [ALTER SERVER CONFIGURATION &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-server-configuration-transact-sql) instead.</span></span>  
  
 <span data-ttu-id="7c79c-104">為了執行多工作業， [!INCLUDE[msCoName](../../includes/msconame-md.md)] Windows 有時會在不同的處理器之間移動處理序執行緒。</span><span class="sxs-lookup"><span data-stu-id="7c79c-104">To carry out multitasking, [!INCLUDE[msCoName](../../includes/msconame-md.md)] Windows sometimes move process threads among different processors.</span></span> <span data-ttu-id="7c79c-105">雖然從作業系統的觀點來看很有效率，但是在繁重的系統負載下，這項活動可能會降低 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的效能，因為每個處理器快取會重複地重新載入資料。</span><span class="sxs-lookup"><span data-stu-id="7c79c-105">Although efficient from an operating system point of view, this activity can reduce [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] performance under heavy system loads, as each processor cache is repeatedly reloaded with data.</span></span> <span data-ttu-id="7c79c-106">在這些情況中，將特定執行緒指定給處理器，可降低處理器重新載入的情形並減少跨處理器移轉執行緒的問題 (藉此減少內容切換)，進而提升效能，而執行緒與處理器之間的關聯則稱為處理器相似性。</span><span class="sxs-lookup"><span data-stu-id="7c79c-106">Assigning processors to specific threads can improve performance under these conditions by eliminating processor reloads and reducing thread migration across processors (thereby reducing context switching); such an association between a thread and a processor is called processor affinity.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]<span data-ttu-id="7c79c-107">透過兩個相似性遮罩選項支援處理器親和性：親和性遮罩 (也稱為**CPU 相似性遮罩**) 和相似性 i/o mask。</span><span class="sxs-lookup"><span data-stu-id="7c79c-107">supports processor affinity by means of two affinity mask options: affinity mask (also known as **CPU affinity mask**) and affinity I/O mask.</span></span> <span data-ttu-id="7c79c-108">如需 affinity I/O mask 選項的詳細資訊，請參閱 [affinity Input-Output mask 伺服器組態選項](affinity-input-output-mask-server-configuration-option.md)。</span><span class="sxs-lookup"><span data-stu-id="7c79c-108">For more information on the affinity I/O maskoption, see [affinity Input-Output mask Server Configuration Option](affinity-input-output-mask-server-configuration-option.md).</span></span> <span data-ttu-id="7c79c-109">擁有 33 到 64 個處理器的 CPU 與 I/O 相似性支援需要分別另外使用 [affinity64 mask 伺服器組態選項](affinity64-mask-server-configuration-option.md) 與 [affinity64 Input-Output mask 伺服器組態選項](affinity64-input-output-mask-server-configuration-option.md)。</span><span class="sxs-lookup"><span data-stu-id="7c79c-109">CPU and I/O affinity support for servers with 33 to 64 processors requires the additional use of the [affinity64 mask Server Configuration Option](affinity64-mask-server-configuration-option.md) and [affinity64 Input-Output mask Server Configuration Option](affinity64-input-output-mask-server-configuration-option.md), respectively.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7c79c-110">擁有 33 到 64 個處理器之伺服器的相似性支援只能在 64 位元的作業系統上使用。</span><span class="sxs-lookup"><span data-stu-id="7c79c-110">Affinity support for servers with 33 to 64 processors is only available on 64-bit operating systems.</span></span>  
  
 <span data-ttu-id="7c79c-111">affinity mask 選項存在於較早的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]版本中，可動態控制 CPU 相似性。</span><span class="sxs-lookup"><span data-stu-id="7c79c-111">The affinity mask option, which existed in earlier releases of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], dynamically controls CPU affinity.</span></span>  
  
 <span data-ttu-id="7c79c-112">在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]中，不需要重新啟動 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]執行個體，即可設定 affinity mask 選項。</span><span class="sxs-lookup"><span data-stu-id="7c79c-112">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the affinity mask option can be configured without requiring a restart of the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7c79c-113">使用 sp_configure 時，您必須在設定組態選項之後，執行 RECONFIGURE 或 RECONFIGURE WITH OVERRIDE。</span><span class="sxs-lookup"><span data-stu-id="7c79c-113">When you are using sp_configure, you must run either RECONFIGURE or RECONFIGURE WITH OVERRIDE after setting a configuration option.</span></span> <span data-ttu-id="7c79c-114">當您使用 [!INCLUDE[ssExpress](../../includes/ssexpress-md.md)]時，變更 affinity mask 選項後需要重新啟動。</span><span class="sxs-lookup"><span data-stu-id="7c79c-114">When you are using [!INCLUDE[ssExpress](../../includes/ssexpress-md.md)], changing the affinity mask option does require a restart.</span></span>  
  
 <span data-ttu-id="7c79c-115">對 affinity mask 的變更會動態發生，允許視需要啟動或關閉 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]中繫結處理序執行緒的 CPU 排程器。</span><span class="sxs-lookup"><span data-stu-id="7c79c-115">Changes to the affinity masks occur dynamically, allowing for on-demand startup and shutdown of the CPU schedulers that bind process threads within [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7c79c-116">這會因伺服器上的條件變更而發生。</span><span class="sxs-lookup"><span data-stu-id="7c79c-116">This can occur as conditions change on the server.</span></span> <span data-ttu-id="7c79c-117">例如，若將 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的新執行個體加入伺服器，則可能必須對 affinity mask 選項進行調整，以便分散處理器負載。</span><span class="sxs-lookup"><span data-stu-id="7c79c-117">For example, if a new instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is added to the server, it may be necessary to make adjustments to the affinity mask option to redistribute processor load.</span></span>  
  
 <span data-ttu-id="7c79c-118">對相似性位元遮罩的修改需要 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 啟用新的 CPU 排程器並停用現有的 CPU 排程器。</span><span class="sxs-lookup"><span data-stu-id="7c79c-118">Modifications to the affinity bitmasks require [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] to enable a new CPU scheduler and disable the existing CPU scheduler.</span></span> <span data-ttu-id="7c79c-119">然後，新批次可在新的或剩餘的排程器上加以處理。</span><span class="sxs-lookup"><span data-stu-id="7c79c-119">New batches can then be processed on the new or remaining schedulers.</span></span>  
  
 <span data-ttu-id="7c79c-120">為了啟動新的 CPU 排程器， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 會建立新的排程器，並將它加入其標準排程器的清單中。</span><span class="sxs-lookup"><span data-stu-id="7c79c-120">To start a new CPU scheduler, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates a new scheduler and adds it to the list of its standard schedulers.</span></span> <span data-ttu-id="7c79c-121">新的排程器只能用於新內送的批次。</span><span class="sxs-lookup"><span data-stu-id="7c79c-121">The new scheduler is considered only for the new incoming batches.</span></span> <span data-ttu-id="7c79c-122">目前批次會繼續在相同的排程器上執行。</span><span class="sxs-lookup"><span data-stu-id="7c79c-122">Current batches continue to run on the same scheduler.</span></span> <span data-ttu-id="7c79c-123">工作者會在釋出時或建立新工作者時，合併到新的排程器。</span><span class="sxs-lookup"><span data-stu-id="7c79c-123">The workers migrate to the new scheduler as they free up, or as new workers are created.</span></span>  
  
 <span data-ttu-id="7c79c-124">排程器上所有的批次都完成活動並結束，才能關閉排程器。</span><span class="sxs-lookup"><span data-stu-id="7c79c-124">Shutting down a scheduler requires all batches on the scheduler to complete their activities and exit.</span></span> <span data-ttu-id="7c79c-125">必須關閉的排程器會標示為離線，如此就不會在此排程器上排定新批次。</span><span class="sxs-lookup"><span data-stu-id="7c79c-125">A scheduler that has been shut down is marked as offline so that no new batch is scheduled on it.</span></span>  
  
 <span data-ttu-id="7c79c-126">不論新增或移除新的排程器，只要伺服器保持運作，永久性系統工作就會繼續在排程器上執行，例如，鎖定監視、檢查點、系統工作執行緒 (處理 DTC) 及訊號處理序。</span><span class="sxs-lookup"><span data-stu-id="7c79c-126">Whether a new scheduler is added or removed, the permanent system tasks such as lockmonitor, checkpoint, system task thread (processing DTC), and signal process continue to run on the scheduler while the server is operational.</span></span> <span data-ttu-id="7c79c-127">這些永久性系統工作不會動態地移轉。</span><span class="sxs-lookup"><span data-stu-id="7c79c-127">These permanent system tasks do not dynamically migrate.</span></span> <span data-ttu-id="7c79c-128">若要將這些系統工作的處理器負載分散到不同排程器上，必須重新啟動 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 執行個體。</span><span class="sxs-lookup"><span data-stu-id="7c79c-128">To redistribute processor load for these system tasks across schedulers, it is necessary to restart the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span> <span data-ttu-id="7c79c-129">如果 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 嘗試關閉與永久性系統工作關聯的排程器，工作會繼續在離線的排程器上執行 (沒有移轉)。</span><span class="sxs-lookup"><span data-stu-id="7c79c-129">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] attempts to shut down a scheduler associated with a permanent system task, the task continues to run on the offline scheduler (no migration).</span></span> <span data-ttu-id="7c79c-130">此排程器已繫結到修改的相似性遮罩中的處理器，且不應在變更之前放置任何負載於此處理器上。</span><span class="sxs-lookup"><span data-stu-id="7c79c-130">This scheduler is bound to the processors in the modified affinity mask and should not put any load on the processor it was affinitized with before the change.</span></span> <span data-ttu-id="7c79c-131">具有多餘的離線排程器並不會明顯影響到系統的負載。</span><span class="sxs-lookup"><span data-stu-id="7c79c-131">Having extra offline schedulers, should not significantly affect the load of the system.</span></span> <span data-ttu-id="7c79c-132">如果不是這樣的狀況，重新設定這些工作需要重新啟動資料庫伺服器。</span><span class="sxs-lookup"><span data-stu-id="7c79c-132">If this is not the case, a database server reboot is required to reconfigure these tasks.</span></span>  
  
 <span data-ttu-id="7c79c-133">I/O affinity mask 會直接影響到 I/O 相似性工作 (例如 lazywriter 與 logwriter)。</span><span class="sxs-lookup"><span data-stu-id="7c79c-133">The I/O affinity tasks (such as lazywriter and logwriter) are directly affected by the I/O affinity mask.</span></span> <span data-ttu-id="7c79c-134">如果 lazywriter 與 logwriter 工作並未相似化，則會遵循針對其他永久性工作所定義的相同規則，例如鎖定監視或檢查點。</span><span class="sxs-lookup"><span data-stu-id="7c79c-134">If the lazywriter and logwriter tasks are not affinitized, they follow the same rules defined for the other permanent tasks such as lockmonitor or checkpoint.</span></span>  
  
 <span data-ttu-id="7c79c-135">為了確定新的相似性遮罩有效，RECONFIGURE 命令會驗證一般的 CPU 和 I/O 相似性是否互斥。</span><span class="sxs-lookup"><span data-stu-id="7c79c-135">To ensure that the new affinity mask is valid, the RECONFIGURE command verifies that the normal CPU and I/O affinities are mutually exclusive.</span></span> <span data-ttu-id="7c79c-136">如果不是這樣的狀況，會將錯誤訊息回報至用戶端工作階段和 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 錯誤記錄檔，表示不建議這樣的設定。</span><span class="sxs-lookup"><span data-stu-id="7c79c-136">If this is not the case, an error message is reported to the client session and to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log, indicating that such a setting is not recommended.</span></span> <span data-ttu-id="7c79c-137">執行 RECONFIGURE WITH OVERRIDE 選項可允許未互斥的 CPU 和 I/O 相似性。</span><span class="sxs-lookup"><span data-stu-id="7c79c-137">Running RECONFIGURE WITH OVERRIDE options allows CPU and I/O affinities that are not mutually exclusive.</span></span>  
  
 <span data-ttu-id="7c79c-138">如果您指定嘗試對應到不存在之 CPU 的相似性遮罩，RECONFIGURE 命令會將錯誤訊息回報至用戶端工作階段和 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 錯誤記錄檔。</span><span class="sxs-lookup"><span data-stu-id="7c79c-138">If you specify an affinity mask that attempts to map to a nonexistent CPU, the RECONFIGURE command reports an error message to both the client session and the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="7c79c-139">在此情況下，使用 RECONFIGURE WITH OVERRIDE 選項沒有作用，而且會再次回報相同的組態錯誤。</span><span class="sxs-lookup"><span data-stu-id="7c79c-139">Using the RECONFIGURE WITH OVERRIDE option has no effect in this case, and the same configuration error is reported again.</span></span>  
  
 <span data-ttu-id="7c79c-140">您也可以從處理器中排除 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 活動，此為 Windows 2000 或 Windows Server 2003 作業系統所指定的特定工作負載。</span><span class="sxs-lookup"><span data-stu-id="7c79c-140">You can also exclude [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] activity from processors assigned specific workload assignments by the Windows 2000 or Windows Server 2003 operating system.</span></span> <span data-ttu-id="7c79c-141">如果將某處理器的代表位元設成 1，則表示 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Database Engine 已選取該處理器準備進行執行緒指派。</span><span class="sxs-lookup"><span data-stu-id="7c79c-141">If you set a bit representing a processor to 1, that processor is selected by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Database Engine for thread assignment.</span></span> <span data-ttu-id="7c79c-142">當您將設定 `affinity mask` 為0時 (預設) ，Microsoft Windows 2000 或 Windows Server 2003 排程演算法會設定執行緒的親和性。</span><span class="sxs-lookup"><span data-stu-id="7c79c-142">When you set `affinity mask` to 0 (the default), the Microsoft Windows 2000 or Windows Server 2003 scheduling algorithms set the thread's affinity.</span></span> <span data-ttu-id="7c79c-143">將 `affinity mask` 設成任何非零的值時，[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 相似性會將該值解譯為指定適合選取之處理器的位元遮罩。</span><span class="sxs-lookup"><span data-stu-id="7c79c-143">When you set `affinity mask` to any nonzero value, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] affinity interprets the value as a bitmask that specifies those processors eligible for selection.</span></span>  
  
 <span data-ttu-id="7c79c-144">藉由將 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 執行緒從特定處理器中分離，Microsoft Windows 2000 或 Windows Server 2003 可以更有效地評估 Windows 特定處理序的系統處理。</span><span class="sxs-lookup"><span data-stu-id="7c79c-144">By segregating [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] threads from running on particular processors, Microsoft Windows 2000 or Windows Server 2003 can better evaluate the system's handling of processes specific to Windows.</span></span> <span data-ttu-id="7c79c-145">例如，系統管理員可以在執行兩個 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 執行個體 (執行個體 A 與 B) 的 8-CPU 伺服器上，使用 affinity mask 選項將第一組 4 個 CPU 指派到執行個體 A，並將第二組 4 個 CPU 指派到執行個體 B。若要設定 32 個以上的處理器，請同時設定 affinity mask 與 affinity64 mask。</span><span class="sxs-lookup"><span data-stu-id="7c79c-145">For example, on an 8-CPU server running two instances of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (instance A and B), the system administrator could use the affinity mask option to assign the first set of 4 CPUs to instance A and the second set of 4 to instance B. To configure more than 32 processors, set both the affinity mask and the affinity64 mask.</span></span> <span data-ttu-id="7c79c-146">`affinity mask` 的值如下：</span><span class="sxs-lookup"><span data-stu-id="7c79c-146">The values for `affinity mask` are as follows:</span></span>  
  
-   <span data-ttu-id="7c79c-147">一個位元組的 `affinity mask` 可在多處理器的電腦中處理最多 8 個 CPU。</span><span class="sxs-lookup"><span data-stu-id="7c79c-147">A one-byte `affinity mask` covers up to 8 CPUs in a multiprocessor computer.</span></span>  
  
-   <span data-ttu-id="7c79c-148">兩個位元組的 `affinity mask` 可在多處理器的電腦中處理最多 16 個 CPU。</span><span class="sxs-lookup"><span data-stu-id="7c79c-148">A two-byte `affinity mask` covers up to 16 CPUs in a multiprocessor computer.</span></span>  
  
-   <span data-ttu-id="7c79c-149">三個位元組的 `affinity mask` 可在多處理器的電腦中處理最多 24 個 CPU。</span><span class="sxs-lookup"><span data-stu-id="7c79c-149">A three-byte `affinity mask` covers up to 24 CPUs in a multiprocessor computer.</span></span>  
  
-   <span data-ttu-id="7c79c-150">四個位元組的 `affinity mask` 可在多處理器的電腦中處理最多 32 個 CPU。</span><span class="sxs-lookup"><span data-stu-id="7c79c-150">A four-byte `affinity mask` covers up to 32 CPUs in a multiprocessor computer.</span></span>  
  
-   <span data-ttu-id="7c79c-151">若要處理 32 個以上的 CPU，請針對前 32 個 CPU 設定四個位元組的相似性遮罩，並針對剩餘的 CPU 設定最多四個位元組的 affinity64 遮罩。</span><span class="sxs-lookup"><span data-stu-id="7c79c-151">To cover more than 32 CPUs, configure a four-byte affinity mask for the first 32 CPUs and up to a four-byte affinity64 mask for the remaining CPUs.</span></span>  
  
 <span data-ttu-id="7c79c-152">因為設定 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 處理器相似性是專門的作業，建議您只在必要時才使用。</span><span class="sxs-lookup"><span data-stu-id="7c79c-152">Because setting [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] processor affinity is a specialized operation, it is recommended that it be used only when necessary.</span></span> <span data-ttu-id="7c79c-153">在大部分情況下，Microsoft Windows 2000 或 Windows Server 2003 的預設相似性可提供最佳效能。</span><span class="sxs-lookup"><span data-stu-id="7c79c-153">In most cases, the Microsoft Windows 2000 or Windows Server 2003 default affinity provides the best performance.</span></span> <span data-ttu-id="7c79c-154">您也應該在設定相似性遮罩時，考量其他應用程式的 CPU 需求。</span><span class="sxs-lookup"><span data-stu-id="7c79c-154">You should also consider the CPU requirements for other applications when setting the affinity masks.</span></span> <span data-ttu-id="7c79c-155">如需詳細資訊，請參閱您的 Windows 作業系統文件集。</span><span class="sxs-lookup"><span data-stu-id="7c79c-155">For more information, see your Windows operating system documentation.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7c79c-156">您可使用「Windows 系統監視器」來檢視和分析個別處理器的使用方式。</span><span class="sxs-lookup"><span data-stu-id="7c79c-156">You can use the Windows System Monitor to view and analyze individual processor usage.</span></span>  
  
 <span data-ttu-id="7c79c-157">在指定 affinity I/O mask 選項時，您必須與 affinity mask 組態選項連接使用。</span><span class="sxs-lookup"><span data-stu-id="7c79c-157">When specifying the affinity I/O mask option, you must use it in connection with the affinity mask configuration option.</span></span> <span data-ttu-id="7c79c-158">請勿同時在 `affinity mask` 參數與 affinity I/O mask 選項中啟用相同的 CPU。</span><span class="sxs-lookup"><span data-stu-id="7c79c-158">Do not enable the same CPU in both the `affinity mask` switch and the affinity I/O mask option.</span></span> <span data-ttu-id="7c79c-159">對應到每個 CPU 的位元組狀態應為下列三個的其中一個：</span><span class="sxs-lookup"><span data-stu-id="7c79c-159">The bits corresponding to each CPU should be in one of these three states:</span></span>  
  
-   <span data-ttu-id="7c79c-160">在 affinity mask 選項與 affinity I/O mask 選項中皆為 0。</span><span class="sxs-lookup"><span data-stu-id="7c79c-160">0 in both the affinity mask option and the affinity I/O mask option.</span></span>  
  
-   <span data-ttu-id="7c79c-161">在 affinity mask 選項中為 1，而在 affinity I/O mask 選項中為 0。</span><span class="sxs-lookup"><span data-stu-id="7c79c-161">1 in the affinity mask option and 0 in the affinity I/O mask option.</span></span>  
  
-   <span data-ttu-id="7c79c-162">在 affinity mask 選項中為 0，在 affinity I/O mask 選項中為 1。</span><span class="sxs-lookup"><span data-stu-id="7c79c-162">0 in the affinity mask option and 1 in the affinity I/O mask option.</span></span>  
  
> [!CAUTION]  
>  <span data-ttu-id="7c79c-163">不要在 Windows 作業系統中設定 CPU 相似性，然後又在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]中設定相似性遮罩。</span><span class="sxs-lookup"><span data-stu-id="7c79c-163">Do not configure CPU affinity in the Windows operating system and also configure the affinity mask in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7c79c-164">這些設定嘗試達到相同的結果，如果組態不一致，可能會有無法預期的結果。</span><span class="sxs-lookup"><span data-stu-id="7c79c-164">These settings are attempting to achieve the same result, and if the configurations are inconsistent, you may have unpredictable results.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="7c79c-165">設定 CPU 相似性時，最好使用 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]中的 sp_configure 選項。</span><span class="sxs-lookup"><span data-stu-id="7c79c-165">CPU affinity is best configured using the sp_configure option in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
## <a name="example"></a><span data-ttu-id="7c79c-166">範例</span><span class="sxs-lookup"><span data-stu-id="7c79c-166">Example</span></span>  
 <span data-ttu-id="7c79c-167">以設定 affinity mask 選項為例，如果選取處理器 1、2 與 5 為可用，並將位元 1、2、5 設成 1，位元 0、3、4、6 與 7 設成 0，就會指定十六進位值 0x26 (或相當的十進位值 `38` )。</span><span class="sxs-lookup"><span data-stu-id="7c79c-167">As an example of setting the affinity mask option, if processors 1, 2, and 5 are selected as available with bits 1, 2, and 5 set to 1 and bits 0, 3, 4, 6, and 7 set to 0, a hexadecimal value of 0x26 or the decimal equivalent of `38` is specified.</span></span> <span data-ttu-id="7c79c-168">位元的編號從右算起。</span><span class="sxs-lookup"><span data-stu-id="7c79c-168">Number the bits from right to left.</span></span> <span data-ttu-id="7c79c-169">affinity mask 選項會從 0 到 31 開始計算處理器，所以在下列範例中，計數器 `1` 代表伺服器上的第二個處理器。</span><span class="sxs-lookup"><span data-stu-id="7c79c-169">The affinity mask option starts counting processors from 0 to 31, so that in the following example the counter `1` represents the second processor on the server.</span></span>  
  
```  
sp_configure 'show advanced options', 1;  
RECONFIGURE;  
GO  
sp_configure 'affinity mask', 38;  
RECONFIGURE;  
GO  
```  
  
 <span data-ttu-id="7c79c-170">以下為 8-CPU 系統的 `affinity mask` 值。</span><span class="sxs-lookup"><span data-stu-id="7c79c-170">These are `affinity mask` values for an 8-CPU system.</span></span>  
  
|<span data-ttu-id="7c79c-171">十進位值</span><span class="sxs-lookup"><span data-stu-id="7c79c-171">Decimal value</span></span>|<span data-ttu-id="7c79c-172">二進位位元遮罩</span><span class="sxs-lookup"><span data-stu-id="7c79c-172">Binary bit mask</span></span>|<span data-ttu-id="7c79c-173">允許 SQL Server 執行緒的處理器數目</span><span class="sxs-lookup"><span data-stu-id="7c79c-173">Allow SQL Server threads on processors</span></span>|  
|-------------------|---------------------|--------------------------------------------|  
|<span data-ttu-id="7c79c-174">1</span><span class="sxs-lookup"><span data-stu-id="7c79c-174">1</span></span>|<span data-ttu-id="7c79c-175">00000001</span><span class="sxs-lookup"><span data-stu-id="7c79c-175">00000001</span></span>|<span data-ttu-id="7c79c-176">0</span><span class="sxs-lookup"><span data-stu-id="7c79c-176">0</span></span>|  
|<span data-ttu-id="7c79c-177">3</span><span class="sxs-lookup"><span data-stu-id="7c79c-177">3</span></span>|<span data-ttu-id="7c79c-178">00000011</span><span class="sxs-lookup"><span data-stu-id="7c79c-178">00000011</span></span>|<span data-ttu-id="7c79c-179">0 與 1</span><span class="sxs-lookup"><span data-stu-id="7c79c-179">0 and 1</span></span>|  
|<span data-ttu-id="7c79c-180">7</span><span class="sxs-lookup"><span data-stu-id="7c79c-180">7</span></span>|<span data-ttu-id="7c79c-181">00000111</span><span class="sxs-lookup"><span data-stu-id="7c79c-181">00000111</span></span>|<span data-ttu-id="7c79c-182">0、1 與 2</span><span class="sxs-lookup"><span data-stu-id="7c79c-182">0, 1, and 2</span></span>|  
|<span data-ttu-id="7c79c-183">15</span><span class="sxs-lookup"><span data-stu-id="7c79c-183">15</span></span>|<span data-ttu-id="7c79c-184">00001111</span><span class="sxs-lookup"><span data-stu-id="7c79c-184">00001111</span></span>|<span data-ttu-id="7c79c-185">0、1、2 與 3</span><span class="sxs-lookup"><span data-stu-id="7c79c-185">0, 1, 2, and 3</span></span>|  
|<span data-ttu-id="7c79c-186">31</span><span class="sxs-lookup"><span data-stu-id="7c79c-186">31</span></span>|<span data-ttu-id="7c79c-187">00011111</span><span class="sxs-lookup"><span data-stu-id="7c79c-187">00011111</span></span>|<span data-ttu-id="7c79c-188">0、1、2、3 與 4</span><span class="sxs-lookup"><span data-stu-id="7c79c-188">0, 1, 2, 3, and 4</span></span>|  
|<span data-ttu-id="7c79c-189">63</span><span class="sxs-lookup"><span data-stu-id="7c79c-189">63</span></span>|<span data-ttu-id="7c79c-190">00111111</span><span class="sxs-lookup"><span data-stu-id="7c79c-190">00111111</span></span>|<span data-ttu-id="7c79c-191">0、1、2、3、4 與 5</span><span class="sxs-lookup"><span data-stu-id="7c79c-191">0, 1, 2, 3, 4, and 5</span></span>|  
|<span data-ttu-id="7c79c-192">127</span><span class="sxs-lookup"><span data-stu-id="7c79c-192">127</span></span>|<span data-ttu-id="7c79c-193">01111111</span><span class="sxs-lookup"><span data-stu-id="7c79c-193">01111111</span></span>|<span data-ttu-id="7c79c-194">0、1、2、3、4、5 與 6</span><span class="sxs-lookup"><span data-stu-id="7c79c-194">0, 1, 2, 3, 4, 5, and 6</span></span>|  
|<span data-ttu-id="7c79c-195">255</span><span class="sxs-lookup"><span data-stu-id="7c79c-195">255</span></span>|<span data-ttu-id="7c79c-196">11111111</span><span class="sxs-lookup"><span data-stu-id="7c79c-196">11111111</span></span>|<span data-ttu-id="7c79c-197">0、1、2、3、4、5、6 與 7</span><span class="sxs-lookup"><span data-stu-id="7c79c-197">0, 1, 2, 3, 4, 5, 6, and 7</span></span>|  
  
 <span data-ttu-id="7c79c-198">affinity mask 屬於進階選項。</span><span class="sxs-lookup"><span data-stu-id="7c79c-198">The affinity mask option is an advanced option.</span></span> <span data-ttu-id="7c79c-199">如果您使用 sp_configure 系統預存程式來變更此設定， `affinity mask` 只有當**show advanced options**設為1時，才能變更。</span><span class="sxs-lookup"><span data-stu-id="7c79c-199">If you are using the sp_configure system stored procedure to change the setting, you can change `affinity mask` only when **show advanced options** is set to 1.</span></span> <span data-ttu-id="7c79c-200">在執行 [!INCLUDE[tsql](../../includes/tsql-md.md)] RECONFIGURE 命令之後，新的設定會立即生效，而不需要重新啟動 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 執行個體。</span><span class="sxs-lookup"><span data-stu-id="7c79c-200">After executing the [!INCLUDE[tsql](../../includes/tsql-md.md)] RECONFIGURE command, the new setting takes effect immediately without requiring a restart of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span>  
  
## <a name="non-uniform-memory-access-numa"></a><span data-ttu-id="7c79c-201">非統一記憶體存取 (NUMA)</span><span class="sxs-lookup"><span data-stu-id="7c79c-201">Non-uniform Memory Access (NUMA)</span></span>  
 <span data-ttu-id="7c79c-202">當使用以非統一記憶體存取 (NUMA) 為基礎的硬體且設定相似性遮罩時，節點中的每一個排程器將相似於它自己的 CPU。</span><span class="sxs-lookup"><span data-stu-id="7c79c-202">When using hardware based non-uniform memory access (NUMA) and the affinity mask is set, every scheduler in a node will be affinitized to its own CPU.</span></span> <span data-ttu-id="7c79c-203">若未設定相似性遮罩，則每一個排程器會相似於 NUMA 節點內的 CPU 群組，且對應到 NUMA 節點 N1 的排程器可在該節點的任何 CPU 上設定工作排程，但不能在與另一個節點相關聯的 CPU 上設定。</span><span class="sxs-lookup"><span data-stu-id="7c79c-203">When the affinity mask is not set, each scheduler is affinitized to the group of CPUs within the NUMA node and a scheduler mapped to NUMA node N1 can schedule work on any CPU in the node, but not on CPUs associated with another node.</span></span>  
  
 <span data-ttu-id="7c79c-204">在單一 NUMA 節點上執行的任何作業只能使用該節點的緩衝區頁面。</span><span class="sxs-lookup"><span data-stu-id="7c79c-204">Any operation running on a single NUMA node can only use buffer pages from that node.</span></span> <span data-ttu-id="7c79c-205">若作業平行執行於多個節點的 CPU 上，則可使用任何相關節點的記憶體。</span><span class="sxs-lookup"><span data-stu-id="7c79c-205">When an operation is run in parallel on CPUs from multiple nodes, memory can be used from any node involved.</span></span>  
  
## <a name="licensing-issues"></a><span data-ttu-id="7c79c-206">授權問題</span><span class="sxs-lookup"><span data-stu-id="7c79c-206">Licensing Issues</span></span>  
 <span data-ttu-id="7c79c-207">動態相似性受到 CPU 授權的嚴格控制，</span><span class="sxs-lookup"><span data-stu-id="7c79c-207">Dynamic affinity is tightly constrained by CPU licensing.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="7c79c-208">並不允許違反授權原則的任何相似性遮罩選項組態。</span><span class="sxs-lookup"><span data-stu-id="7c79c-208">does not allow any configuration of affinity mask options that violates the licensing policy.</span></span>  
  
### <a name="startup"></a><span data-ttu-id="7c79c-209">啟動</span><span class="sxs-lookup"><span data-stu-id="7c79c-209">Startup</span></span>  
 <span data-ttu-id="7c79c-210">如果指定的相似性遮罩在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 啟動期間或資料庫附加期間違反授權原則，則引擎層會完成啟動程序或資料庫附加/還原作業，然後將相似性遮罩的 sp_configure 執行值重設為零，發出錯誤訊息至 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 錯誤記錄檔。</span><span class="sxs-lookup"><span data-stu-id="7c79c-210">If a specified affinity mask violates the licensing policy during [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] startup or during database attach, the engine layer will complete the startup process or database attach/restore operation, and then it will reset the sp_configure run value for the affinity mask to zero, issuing an error message to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span>  
  
### <a name="reconfigure"></a><span data-ttu-id="7c79c-211">重新設定</span><span class="sxs-lookup"><span data-stu-id="7c79c-211">Reconfigure</span></span>  
 <span data-ttu-id="7c79c-212">如果指定的相似性遮罩在執行 [!INCLUDE[tsql](../../includes/tsql-md.md)] RECONFIGURE 命令期間違反授權原則，就會將錯誤訊息回報至用戶端工作階段和 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 錯誤記錄檔，並要求資料庫管理員重新設定相似性遮罩。</span><span class="sxs-lookup"><span data-stu-id="7c79c-212">If a specified affinity mask violates the licensing policy when running [!INCLUDE[tsql](../../includes/tsql-md.md)] RECONFIGURE command, an error message is reported to the client session and to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log, requiring the database administrator to reconfigure the affinity mask.</span></span> <span data-ttu-id="7c79c-213">在此情況下，不會接受任何 RECONFIGURE WITH OVERRIDE 命令。</span><span class="sxs-lookup"><span data-stu-id="7c79c-213">No RECONFIGURE WITH OVERRIDE command is accepted in this case.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7c79c-214">另請參閱</span><span class="sxs-lookup"><span data-stu-id="7c79c-214">See Also</span></span>  
 <span data-ttu-id="7c79c-215">[監視資源使用量 &#40;系統監視器&#41;](../../relational-databases/performance-monitor/monitor-resource-usage-system-monitor.md) </span><span class="sxs-lookup"><span data-stu-id="7c79c-215">[Monitor Resource Usage &#40;System Monitor&#41;](../../relational-databases/performance-monitor/monitor-resource-usage-system-monitor.md) </span></span>  
 <span data-ttu-id="7c79c-216">[RECONFIGURE &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/reconfigure-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="7c79c-216">[RECONFIGURE &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/reconfigure-transact-sql) </span></span>  
 <span data-ttu-id="7c79c-217">[伺服器組態選項 &#40;SQL Server&#41;](server-configuration-options-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="7c79c-217">[Server Configuration Options &#40;SQL Server&#41;](server-configuration-options-sql-server.md) </span></span>  
 <span data-ttu-id="7c79c-218">[sp_configure &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="7c79c-218">[sp_configure &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql) </span></span>  
 [<span data-ttu-id="7c79c-219">ALTER SERVER CONFIGURATION &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="7c79c-219">ALTER SERVER CONFIGURATION &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-server-configuration-transact-sql)  
  
  
