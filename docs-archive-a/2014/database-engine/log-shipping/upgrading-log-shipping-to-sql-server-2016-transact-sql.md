---
title: 將記錄傳送升級至 SQL Server 2014 (Transact-sql) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], upgrading
ms.assetid: b1289cc3-f5be-40bb-8801-0e3eed40336e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 80330d03853c984cfd26100b02918eb218705085
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87607030"
---
# <a name="upgrade-log-shipping-to-sql-server-2014-transact-sql"></a><span data-ttu-id="a1af7-102">將記錄傳送升級至 SQL Server 2014 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="a1af7-102">Upgrade Log Shipping to SQL Server 2014 (Transact-SQL)</span></span>
  <span data-ttu-id="a1af7-103">當您從 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]、 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]、 [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)]或 [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] 升級到 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]時，可保留記錄傳送組態。</span><span class="sxs-lookup"><span data-stu-id="a1af7-103">It is possible to preserve log shipping configurations when upgrading from [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)], or [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="a1af7-104">本主題描述升級記錄傳送組態的替代案例和最佳做法。</span><span class="sxs-lookup"><span data-stu-id="a1af7-104">This topic describes alternative scenarios and best practices for upgrading a log shipping configuration.</span></span>

> [!NOTE]
>  <span data-ttu-id="a1af7-105">[中所導入的＜](../../relational-databases/backup-restore/backup-compression-sql-server.md) 備份壓縮 [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)]＞。</span><span class="sxs-lookup"><span data-stu-id="a1af7-105">[Backup compression](../../relational-databases/backup-restore/backup-compression-sql-server.md) was introduced in [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span></span> <span data-ttu-id="a1af7-106">升級的記錄傳送組態會使用 **備份壓縮預設** 伺服器層級組態選項，來控制備份壓縮是否會用於交易記錄備份檔案。</span><span class="sxs-lookup"><span data-stu-id="a1af7-106">An upgraded log shipping configuration uses the **backup compression default** server-level configuration option to control whether backup compression is used for the transaction log backup files.</span></span> <span data-ttu-id="a1af7-107">可以針對每一個記錄傳送組態來指定記錄備份的備份壓縮行為。</span><span class="sxs-lookup"><span data-stu-id="a1af7-107">The backup compression behavior of log backups can be specified for each log shipping configuration.</span></span> <span data-ttu-id="a1af7-108">如需詳細資訊，請參閱[設定記錄傳送 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-108">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>


##  <a name="protect-your-data-before-the-upgrade"></a><a name="ProtectData"></a> <span data-ttu-id="a1af7-109">在升級之前保護資料</span><span class="sxs-lookup"><span data-stu-id="a1af7-109">Protect Your Data Before the Upgrade</span></span>
 <span data-ttu-id="a1af7-110">我們建議的最佳做法是在升級記錄傳送之前先保護資料。</span><span class="sxs-lookup"><span data-stu-id="a1af7-110">As a best practice, we recommend that you protect your data before a log shipping upgrade.</span></span>

 <span data-ttu-id="a1af7-111">**保護資料**</span><span class="sxs-lookup"><span data-stu-id="a1af7-111">**To protect your data**</span></span>

1.  <span data-ttu-id="a1af7-112">在每一個主要資料庫上執行完整資料庫備份。</span><span class="sxs-lookup"><span data-stu-id="a1af7-112">Perform a full database backup on every primary database.</span></span>

     <span data-ttu-id="a1af7-113">如需詳細資訊，請參閱 [建立完整資料庫備份 &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md)中建立差異資料庫備份。</span><span class="sxs-lookup"><span data-stu-id="a1af7-113">For more information, see [Create a Full Database Backup &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span></span>

2.  <span data-ttu-id="a1af7-114">在每一個主要資料庫上執行 [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) 命令。</span><span class="sxs-lookup"><span data-stu-id="a1af7-114">Run the [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) command on every primary database.</span></span>

##  <a name="upgrading-the-monitor-server-instance"></a><a name="UpgradeMonitor"></a><span data-ttu-id="a1af7-115">升級監視伺服器實例</span><span class="sxs-lookup"><span data-stu-id="a1af7-115">Upgrading the Monitor Server Instance</span></span>
 <span data-ttu-id="a1af7-116">可以隨時升級監視伺服器執行個體 (如果有的話)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-116">The monitor server instance, if any, can be upgraded at any time.</span></span>

 <span data-ttu-id="a1af7-117">在升級監視伺服器時，記錄傳送組態會持續有效，但是監視器上的資料表中不會記錄它的狀態。</span><span class="sxs-lookup"><span data-stu-id="a1af7-117">While the monitor server is being upgraded, the log shipping configuration continues to work, but its status is not recorded in the tables on the monitor.</span></span> <span data-ttu-id="a1af7-118">當升級監視伺服器時，將不會觸發任何已經設定的警示。</span><span class="sxs-lookup"><span data-stu-id="a1af7-118">Any alerts that have been configured will not be triggered while the monitor server is being upgraded.</span></span> <span data-ttu-id="a1af7-119">在升級之後，您可以執行 [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) 系統預存程序來更新監視資料表內的資訊。</span><span class="sxs-lookup"><span data-stu-id="a1af7-119">After the upgrade, you can update the information in the monitor tables by executing the [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) system stored procedure.</span></span>

##  <a name="upgrading-log-shipping-configurations-with-a-single-secondary-server"></a><a name="UpgradeSingleSecondary"></a><span data-ttu-id="a1af7-120">升級具有單一次要伺服器的記錄傳送設定</span><span class="sxs-lookup"><span data-stu-id="a1af7-120">Upgrading Log Shipping Configurations with a Single Secondary Server</span></span>
 <span data-ttu-id="a1af7-121">本章節所述的升級程序假設組態是由主要伺服器以及只有一部次要伺服器所組成。</span><span class="sxs-lookup"><span data-stu-id="a1af7-121">The upgrade process described in this section assumes a configuration consisting of the primary server and only one secondary server.</span></span> <span data-ttu-id="a1af7-122">這個組態會在下圖中表示，其中顯示主要伺服器執行個體 A 及單一次要伺服器執行個體 B。</span><span class="sxs-lookup"><span data-stu-id="a1af7-122">This configuration is represented in the following illustration, which shows a primary server instance, A, and a single secondary server instance, B.</span></span>

 <span data-ttu-id="a1af7-123">![一台次要伺服器，但是沒有監視伺服器](../media/ls-2-wayconfig-nomonitor.gif "一台次要伺服器，但是沒有監視伺服器")</span><span class="sxs-lookup"><span data-stu-id="a1af7-123">![One secondary server and no monitor server](../media/ls-2-wayconfig-nomonitor.gif "One secondary server and no monitor server")</span></span>

 <span data-ttu-id="a1af7-124">如需有關升級多部次要伺服器的詳細資訊，請參閱本主題稍後的＜ [升級多個次要伺服器執行個體](#MultipleSecondaries)＞。</span><span class="sxs-lookup"><span data-stu-id="a1af7-124">For information about upgrading multiple secondary servers, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>
 

###  <a name="upgrading-the-secondary-server-instance"></a><a name="UpgradeSecondary"></a><span data-ttu-id="a1af7-125">升級次要伺服器實例</span><span class="sxs-lookup"><span data-stu-id="a1af7-125">Upgrading the Secondary Server Instance</span></span>
 <span data-ttu-id="a1af7-126">升級程序牽涉到先將 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 或更新版記錄傳送組態的次要伺服器執行個體升級到 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] ，然後再升級主要伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="a1af7-126">The upgrade process involves upgrading the secondary server instances of a [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher log shipping configuration to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] before upgrading the primary server instance.</span></span> <span data-ttu-id="a1af7-127">一定要先升級次要伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="a1af7-127">Always upgrade the secondary server instance first.</span></span> <span data-ttu-id="a1af7-128">如果在升級次要伺服器之前先升級主要伺服器，則記錄傳送將會失敗，因為在更新版的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 上所建立的備份將無法在舊版 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]上還原。</span><span class="sxs-lookup"><span data-stu-id="a1af7-128">If the primary server were upgraded before a secondary server, log shipping would fail because a backup created on a newer version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] cannot be restored on an older version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>

 <span data-ttu-id="a1af7-129">記錄傳送會在整個升級過程中繼續，因為升級的次要伺服器會繼續從 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 或更新版主要伺服器還原記錄備份。</span><span class="sxs-lookup"><span data-stu-id="a1af7-129">Log shipping continues throughout the upgrade process because the upgraded secondary servers continue to restore the log backups from the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server.</span></span> <span data-ttu-id="a1af7-130">升級次要伺服器執行個體的程序部分取決於記錄傳送組態是否會處理多部次要伺服器。</span><span class="sxs-lookup"><span data-stu-id="a1af7-130">The process for upgrading the secondary server instances depends partly on whether the log shipping configuration possesses multiple secondary servers.</span></span> <span data-ttu-id="a1af7-131">如需詳細資訊，請參閱本主題稍後的＜ [升級多個次要伺服器執行個體](#MultipleSecondaries)＞。</span><span class="sxs-lookup"><span data-stu-id="a1af7-131">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

 <span data-ttu-id="a1af7-132">當升級次要伺服器執行個體時，記錄傳送複製和還原作業不會執行，所以未還原的交易記錄備份將會累積。</span><span class="sxs-lookup"><span data-stu-id="a1af7-132">While the secondary server instance is being upgraded, the log shipping copy and restore jobs do not run, so unrestored transaction log backups will accumulate.</span></span> <span data-ttu-id="a1af7-133">累積的數量取決於在主要伺服器上排程備份的頻率。</span><span class="sxs-lookup"><span data-stu-id="a1af7-133">The amount of accumulation depends on the frequency of scheduled backup on the primary server.</span></span> <span data-ttu-id="a1af7-134">此外，如果已經設定了個別的監視伺服器，則可能會引發警示，指出還原執行的時間長度尚未超過設定的間隔。</span><span class="sxs-lookup"><span data-stu-id="a1af7-134">Also, if a separate monitor server has been configured, alerts might be raised indicating restores have not been performed for longer than the configured interval.</span></span>

 <span data-ttu-id="a1af7-135">一旦升級了次要伺服器之後，記錄傳送代理程式作業就會繼續，並繼續從主要伺服器執行個體 (伺服器 A) 複製及還原記錄備份。次要伺服器讓次要資料庫變成最新狀態所需的時間會有所差異，取決於升級次要伺服器所花的時間以及主要伺服器上的備份頻率而定。</span><span class="sxs-lookup"><span data-stu-id="a1af7-135">Once the secondary server has been upgraded, the log shipping agents jobs resume and continue to copy and restore log backups from the primary server instance, server A. The amount of time required for the secondary server to bring the secondary database up to date varies, depending on the time taken to upgrade the secondary server and the frequency of the backups on the primary server.</span></span>

> [!NOTE]
>  <span data-ttu-id="a1af7-136">在伺服器升級期間，次要資料庫不會升級到 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-136">During the server upgrade, the secondary database is not upgraded to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database.</span></span> <span data-ttu-id="a1af7-137">只有當該資料庫處於線上時，才會進行升級。</span><span class="sxs-lookup"><span data-stu-id="a1af7-137">It will get upgraded only if it is brought online.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a1af7-138">需要升級的資料庫不支援 RESTORE WITH STANDBY 選項。</span><span class="sxs-lookup"><span data-stu-id="a1af7-138">The RESTORE WITH STANDBY option is not supported for a database that requires upgrading.</span></span> <span data-ttu-id="a1af7-139">如果已升級的次要資料庫已經使用 RESTORE WITH STANDBY 加以設定，升級之後無法再還原交易記錄。</span><span class="sxs-lookup"><span data-stu-id="a1af7-139">If an upgraded secondary database has been configured by using RESTORE WITH STANDBY, transaction logs can no longer be restored after upgrade.</span></span> <span data-ttu-id="a1af7-140">若要繼續進行該次要資料庫上的記錄傳送，您需要在該部待命伺服器上再次設定記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="a1af7-140">To resume log shipping on that secondary database, you will need to set up log shipping again on that standby server.</span></span> <span data-ttu-id="a1af7-141">如需待命選項的詳細資訊，請參閱[&#40;transact-sql&#41;還原引數](/sql/t-sql/statements/restore-statements-arguments-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-141">For more information about the STANDBY option, see [RESTORE Arguments &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span></span>

###  <a name="upgrading-the-primary-server-instance"></a><a name="UpgradePrimary"></a> <span data-ttu-id="a1af7-142">升級主要伺服器執行個體</span><span class="sxs-lookup"><span data-stu-id="a1af7-142">Upgrading the Primary Server Instance</span></span>
 <span data-ttu-id="a1af7-143">在規劃升級時，有一個極重要的考量就是無法使用資料庫的時間量。</span><span class="sxs-lookup"><span data-stu-id="a1af7-143">When planning an upgrade, a significant consideration is the amount of time that your database will be unavailable.</span></span> <span data-ttu-id="a1af7-144">最簡單的升級案例牽涉到當您升級主要伺服器時所無法使用的資料庫 (底下的案例 1)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-144">The simplest upgrade scenario involves the database being unavailable while you upgrade the primary server (scenario 1, below).</span></span>

 <span data-ttu-id="a1af7-145">您可以將 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 或更新版主要伺服器容錯移轉到 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 次要伺服器，然後再升級原始主要伺服器，藉此讓資料庫的可用性提升到最高，但這是一個需要耗費較多成本的複雜升級程序 (底下的案例 2)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-145">At the cost of a more complicated upgrade process, you can maximize your database availability by failing over the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] secondary server before upgrading the original primary server (scenario 2, below).</span></span> <span data-ttu-id="a1af7-146">容錯移轉案例有兩種變化。</span><span class="sxs-lookup"><span data-stu-id="a1af7-146">There are two variants of the failover scenario.</span></span> <span data-ttu-id="a1af7-147">您可以切換回原始主要伺服器，並保留原始記錄傳送組態。</span><span class="sxs-lookup"><span data-stu-id="a1af7-147">You can switch back to the original primary server and keep the original log shipping configuration.</span></span> <span data-ttu-id="a1af7-148">另外，您也可以在升級原始主要伺服器之前先移除原始記錄傳送組態，之後再使用新的主要伺服器建立新的組態。</span><span class="sxs-lookup"><span data-stu-id="a1af7-148">Alternatively, you can remove the original log shipping configuration before upgrading the original primary server and later create a new configuration using the new primary server.</span></span> <span data-ttu-id="a1af7-149">本章節描述這兩種案例。</span><span class="sxs-lookup"><span data-stu-id="a1af7-149">This section describes both these scenarios.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a1af7-150">在升級主要伺服器執行個體之前，請務必先升級次要伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="a1af7-150">Be sure to upgrade the secondary server instance before upgrading the primary server instance.</span></span> <span data-ttu-id="a1af7-151">如需詳細資訊，請參閱本主題前面的＜ [升級次要伺服器執行個體](#UpgradeSecondary)＞。</span><span class="sxs-lookup"><span data-stu-id="a1af7-151">For more information, see [Upgrading the Secondary Server Instance](#UpgradeSecondary), earlier in this topic.</span></span>


####  <a name="scenario-1-upgrade-primary-server-instance-without-failover"></a><a name="Scenario1"></a><span data-ttu-id="a1af7-152">案例1：升級不具容錯移轉的主伺服器實例</span><span class="sxs-lookup"><span data-stu-id="a1af7-152">Scenario 1: Upgrade Primary Server Instance Without Failover</span></span>
 <span data-ttu-id="a1af7-153">這是比較簡單的案例，因為它的停機時間比使用容錯移轉來得長。</span><span class="sxs-lookup"><span data-stu-id="a1af7-153">This is the simpler scenario, but it causes more downtime than using failover.</span></span> <span data-ttu-id="a1af7-154">只會升級主要伺服器執行個體，而在這個升級作業期間將無法使用資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-154">The primary server instance is simply upgraded and the database is unavailable during this upgrade.</span></span>

 <span data-ttu-id="a1af7-155">升級伺服器之後，資料庫就會自動回到線上，以便進行升級。</span><span class="sxs-lookup"><span data-stu-id="a1af7-155">Once the server is upgraded, the database is automatically brought back online, which causes it to be upgraded.</span></span> <span data-ttu-id="a1af7-156">在升級資料庫之後，記錄傳送作業就會繼續。</span><span class="sxs-lookup"><span data-stu-id="a1af7-156">After the database is upgraded, the log shipping jobs resume.</span></span>

#### <a name="scenario-2-upgrade-primary-server-instance-with-failover"></a><span data-ttu-id="a1af7-157">案例 2：使用容錯移轉升級主要伺服器執行個體</span><span class="sxs-lookup"><span data-stu-id="a1af7-157">Scenario 2: Upgrade Primary Server Instance with Failover</span></span>
 <span data-ttu-id="a1af7-158">此案例會讓可用性提升到最高，並讓停機時間減至最少。</span><span class="sxs-lookup"><span data-stu-id="a1af7-158">This scenario maximizes availability and minimizes downtime.</span></span> <span data-ttu-id="a1af7-159">此案例使用一種受到控制的方式來容錯移轉至次要伺服器執行個體，在升級原始主要伺服器執行個體期間維持資料庫的可用性。</span><span class="sxs-lookup"><span data-stu-id="a1af7-159">It utilizes a controlled failover to the secondary server instance, which keeps the database available while the original primary server instance is upgraded.</span></span> <span data-ttu-id="a1af7-160">停機時間限制為容錯移轉所需的相對簡短時間，而非升級主要伺服器執行個體所需的時間。</span><span class="sxs-lookup"><span data-stu-id="a1af7-160">Downtime is limited to the relatively short time required to fail over, rather than the time required to upgrade the primary server instance.</span></span>

 <span data-ttu-id="a1af7-161">在使用容錯移轉來升級主要伺服器執行個體時，會牽涉到三個一般程序：執行受到控制的方式來容錯移轉到次要伺服器、將原始主要伺服器執行個體升級到 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]，並在 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 主要伺服器執行個體上設定記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="a1af7-161">Upgrading the primary server instance with failover involves three general procedures: performing a controlled failover to the secondary server, upgrading the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], and setting up log shipping on a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] primary server instance.</span></span> <span data-ttu-id="a1af7-162">本章節會描述這些程序。</span><span class="sxs-lookup"><span data-stu-id="a1af7-162">These procedures are described in this section.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a1af7-163">如果您打算讓次要伺服器執行個體當做新的主要伺服器執行個體，您需要移除記錄傳送組態。</span><span class="sxs-lookup"><span data-stu-id="a1af7-163">If you plan to have the secondary server instance as the new primary server instance, you need to remove the log shipping configuration.</span></span> <span data-ttu-id="a1af7-164">當原始主要伺服器執行個體升級之後，需要重新設定從新的主要伺服器到新的次要伺服器的記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="a1af7-164">Log shipping will need to be reconfigured from the new primary to the new secondary, after the original primary server instance has been upgraded.</span></span> <span data-ttu-id="a1af7-165">如需詳細資訊，請參閱[SQL Server&#41;移除記錄傳送 &#40;](remove-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-165">For more information, see [Remove Log Shipping &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span></span>


#####  <a name="procedure-1-perform-a-controlled-failover-to-the-secondary-server"></a><a name="Procedure1"></a><span data-ttu-id="a1af7-166">程式1：執行受控制的容錯移轉至次要伺服器</span><span class="sxs-lookup"><span data-stu-id="a1af7-166">Procedure 1: Perform a Controlled Failover to the Secondary Server</span></span>
 <span data-ttu-id="a1af7-167">以受到控制的方式容錯移轉到次要伺服器：</span><span class="sxs-lookup"><span data-stu-id="a1af7-167">Controlled failover to the secondary server:</span></span>

1.  <span data-ttu-id="a1af7-168">在使用 NORECOVERY 指定的主資料庫上，手動執行交易記錄檔的[尾記錄備份](../../relational-databases/backup-restore/tail-log-backups-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-168">Manually perform a [tail-log backup](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) of the transaction log on the primary database specifying WITH NORECOVERY.</span></span> <span data-ttu-id="a1af7-169">這個記錄備份會擷取任何尚未備份的記錄檔記錄，並讓資料庫離線。</span><span class="sxs-lookup"><span data-stu-id="a1af7-169">This log backup captures any log records that have not been backed up yet and takes the database offline.</span></span> <span data-ttu-id="a1af7-170">請注意，當資料庫離線時，記錄傳送備份作業將會失敗。</span><span class="sxs-lookup"><span data-stu-id="a1af7-170">Note that while the database is offline, the log shipping backup job will fail.</span></span>

     <span data-ttu-id="a1af7-171">下列範例會在主要伺服器上建立 `AdventureWorks` 資料庫的結尾記錄備份。</span><span class="sxs-lookup"><span data-stu-id="a1af7-171">The following example creates a tail log backup of the `AdventureWorks` database on the primary server.</span></span> <span data-ttu-id="a1af7-172">備份檔案命名為 `Failover_AW_20080315.trn`：</span><span class="sxs-lookup"><span data-stu-id="a1af7-172">The backup file is named `Failover_AW_20080315.trn`:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Failover_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

     <span data-ttu-id="a1af7-173">我們建議您最好使用不同的檔案命名規範來區分手動建立的備份檔案以及記錄傳送備份作業所建立的備份檔案。</span><span class="sxs-lookup"><span data-stu-id="a1af7-173">We recommend that you use a distinct file naming convention to differentiate the manually-created backup file from the backup files created by the log shipping backup job.</span></span>

2.  <span data-ttu-id="a1af7-174">在次要伺服器上：</span><span class="sxs-lookup"><span data-stu-id="a1af7-174">On the secondary server:</span></span>

    1.  <span data-ttu-id="a1af7-175">確定記錄傳送備份作業所自動進行的所有備份都已經套用。</span><span class="sxs-lookup"><span data-stu-id="a1af7-175">Ensure that all backups taken automatically by the log shipping backup jobs have been applied.</span></span> <span data-ttu-id="a1af7-176">若要檢查已套用的備份作業，請在監視伺服器上或主要和次要伺服器上使用[sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql)系統預存程式。</span><span class="sxs-lookup"><span data-stu-id="a1af7-176">To check which backup jobs have been applied, use the [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) system stored procedure on the monitor server or on the primary and secondary servers.</span></span> <span data-ttu-id="a1af7-177">相同的檔案應該會列在 [ **last_backup_file**]、[ **last_copied_file**] 和 [ **last_restored_file** ] 資料行中。</span><span class="sxs-lookup"><span data-stu-id="a1af7-177">The same file should be listed in the **last_backup_file**, **last_copied_file**, and **last_restored_file** columns.</span></span> <span data-ttu-id="a1af7-178">如果有任何備份檔案尚未複製和還原，請針對記錄傳送組態手動叫用代理程式複製和還原作業。</span><span class="sxs-lookup"><span data-stu-id="a1af7-178">If any of the backup files have not been copied and restored, manually invoke the agent copy and restore jobs for the log shipping configuration.</span></span>

         <span data-ttu-id="a1af7-179">如需有關啟動作業的詳細資訊，請參閱＜ [Start a Job](../../ssms/agent/start-a-job.md)＞。</span><span class="sxs-lookup"><span data-stu-id="a1af7-179">For information about starting a job, see [Start a Job](../../ssms/agent/start-a-job.md).</span></span>

    2.  <span data-ttu-id="a1af7-180">將您在步驟 1 建立的最後記錄備份檔案從檔案共用位置複製到次要伺服器上的記錄傳送所使用的本機位置。</span><span class="sxs-lookup"><span data-stu-id="a1af7-180">Copy your the final log backup file that you created in step 1 from the file share to the local location that is used by log shipping on the secondary server.</span></span>

    3.  <span data-ttu-id="a1af7-181">指定 WITH RECOVERY 來還原最後記錄備份，讓資料庫回到線上。</span><span class="sxs-lookup"><span data-stu-id="a1af7-181">Restore the final log backup specifying WITH RECOVERY to bring the database online.</span></span> <span data-ttu-id="a1af7-182">讓資料庫回到線上的過程中，資料庫將會升級到 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="a1af7-182">As part of being brought online, the database will upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

         <span data-ttu-id="a1af7-183">下列範例會在次要資料庫上還原 `AdventureWorks` 資料庫的結尾記錄備份。</span><span class="sxs-lookup"><span data-stu-id="a1af7-183">The following example restores the tail log backup of the `AdventureWorks` database on the secondary database.</span></span> <span data-ttu-id="a1af7-184">此範例使用 WITH RECOVERY 選項，讓資料庫回到線上：</span><span class="sxs-lookup"><span data-stu-id="a1af7-184">The example uses the WITH RECOVERY option, which brings the database online:</span></span>

        ```
        RESTORE LOG AdventureWorks 
          FROM DISK = N'c:\logshipping\Failover_AW_20080315.trn' 
           WITH RECOVERY;
        GO
        ```

        > [!NOTE]
        >  <span data-ttu-id="a1af7-185">如果是包含多部次要伺服器的組態，則有額外的考量。</span><span class="sxs-lookup"><span data-stu-id="a1af7-185">For a configuration that contains more than one secondary server, there are additional considerations.</span></span> <span data-ttu-id="a1af7-186">如需詳細資訊，請參閱本主題稍後的＜ [升級多個次要伺服器執行個體](#MultipleSecondaries)＞。</span><span class="sxs-lookup"><span data-stu-id="a1af7-186">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

    4.  <span data-ttu-id="a1af7-187">將用戶端從原始主要伺服器 (伺服器 A) 重新導向線上次要伺服器 (伺服器 B) 來容錯移轉資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-187">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    5.  <span data-ttu-id="a1af7-188">請注意，當資料庫在線上時，次要資料庫的交易記錄並不會填滿。</span><span class="sxs-lookup"><span data-stu-id="a1af7-188">Take care that the transaction log of the secondary database does not fill while the database is online.</span></span> <span data-ttu-id="a1af7-189">若要避免交易記錄被填滿，您可能需要加以備份。</span><span class="sxs-lookup"><span data-stu-id="a1af7-189">To prevent the transaction log from filling, you might need to back it up.</span></span> <span data-ttu-id="a1af7-190">如果是這種情況，我們建議您將它備份到共用位置 ( *「備份共用」*(Backup Share))，讓備份可在其他伺服器執行個體上用來還原。</span><span class="sxs-lookup"><span data-stu-id="a1af7-190">If so, we recommend that you back it up to a shared location, a *backup share*, to make the backups available for restoring on the other server instance.</span></span>

#####  <a name="procedure-2-upgrade-the-original-primary-server-instance-to-sscurrent"></a><a name="Procedure2"></a><span data-ttu-id="a1af7-191">程式2：將原始的主伺服器實例升級為[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="a1af7-191">Procedure 2: Upgrade the Original Primary Server Instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="a1af7-192">在您將原始主要伺服器執行個體升級到 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]之後，資料庫仍然會在離線狀態而且採用格式。</span><span class="sxs-lookup"><span data-stu-id="a1af7-192">After you upgrade the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], the database will still be offline and in the format.</span></span>

#####  <a name="procedure-3-set-up-log-shipping-on-sscurrent"></a><a name="Procedure3"></a><span data-ttu-id="a1af7-193">程式3：在上設定記錄傳送[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="a1af7-193">Procedure 3: Set Up Log Shipping on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="a1af7-194">升級程序的其餘步驟取決於是否仍設定記錄傳送而定，如下所示：</span><span class="sxs-lookup"><span data-stu-id="a1af7-194">The rest of the upgrade process depends on whether log shipping is still configured, as follows:</span></span>

-   <span data-ttu-id="a1af7-195">如果您已保留 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]或更新版記錄傳送組態，請切換回原始的主要伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="a1af7-195">If you have kept the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]or higher log shipping configuration, switch back to the original primary server instance.</span></span> <span data-ttu-id="a1af7-196">如需詳細資訊，請參閱本主題稍後的＜ [切換回原始的主要伺服器執行個體](#SwitchToOrigPrimary)＞。</span><span class="sxs-lookup"><span data-stu-id="a1af7-196">For more information, see [To Switch Back to the Original Primary Server Instance](#SwitchToOrigPrimary), later in this section.</span></span>

-   <span data-ttu-id="a1af7-197">如果您在容錯移轉之前移除此記錄傳送組態，請建立新的記錄傳送組態，其中原始的次要伺服器執行個體為新的主要伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="a1af7-197">If you removed the log shipping configuration before failing over, create a new log shipping configuration in which the original secondary server instance is the new primary server instance.</span></span> <span data-ttu-id="a1af7-198">如需詳細資訊，請參閱本主題稍後的＜ [將舊的次要伺服器執行個體保留為新的主要伺服器執行個體](#KeepOldSecondaryAsNewPrimary)＞。</span><span class="sxs-lookup"><span data-stu-id="a1af7-198">For more information, see [To Keep the Old Secondary Server Instance As the New Primary Server Instance](#KeepOldSecondaryAsNewPrimary), later in this section.</span></span>

######  <a name="to-switch-back-to-the-original-primary-server-instance"></a><a name="SwitchToOrigPrimary"></a><span data-ttu-id="a1af7-199">切換回原始的主伺服器實例</span><span class="sxs-lookup"><span data-stu-id="a1af7-199">To Switch Back to the Original Primary Server Instance</span></span>

1.  <span data-ttu-id="a1af7-200">在暫時的主要伺服器 (伺服器 B) 上，使用 WITH NORECOVERY 來備份記錄的結尾，以便建立結尾記錄備份並讓資料庫離線。</span><span class="sxs-lookup"><span data-stu-id="a1af7-200">On the interim primary server (server B), back up the tail of the log using WITH NORECOVERY to create a tail-log backup and take the database offline.</span></span> <span data-ttu-id="a1af7-201">結尾記錄備份命名為 `Switchback_AW_20080315.trn`。例如：</span><span class="sxs-lookup"><span data-stu-id="a1af7-201">The tail log backup is named `Switchback_AW_20080315.trn`.For example:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Switchback_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

2.  <span data-ttu-id="a1af7-202">如果在暫時的主要資料庫上進行任何交易記錄備份，而不是您在步驟 1 建立的結尾備份，請使用 WITH NORECOVERY 將這些記錄備份還原到原始主要伺服器 (伺服器 A) 上的離線資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-202">If any transaction log backups were taken on the interim primary database, other than the tail backup that you created in step 1, restore those log backups using WITH NORECOVERY to the offline database on the original primary server (server A).</span></span> <span data-ttu-id="a1af7-203">當還原第一個記錄備份時，資料庫會升級成 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 格式。</span><span class="sxs-lookup"><span data-stu-id="a1af7-203">The database is upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] format when the first log backup is restored.</span></span>

3.  <span data-ttu-id="a1af7-204">使用 WITH RECOVERY 在原始的主要資料庫上還原結尾記錄備份 `Switchback_AW_20080315.trn`，讓資料庫回到線上。</span><span class="sxs-lookup"><span data-stu-id="a1af7-204">Restore the tail-log backup, `Switchback_AW_20080315.trn`, on the original primary database (on server A) using WITH RECOVERY to bring the database online.</span></span>

4.  <span data-ttu-id="a1af7-205">將用戶端從原始主要伺服器重新導向線上次要伺服器，容錯移轉回到原始的主要資料庫 (在伺服器 A 上)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-205">Fail over back to the original primary database (on server A) by redirecting clients to the online secondary server from the original primary server.</span></span>

 <span data-ttu-id="a1af7-206">當資料庫變成線上狀態之後，原始的記錄傳送組態將會繼續。</span><span class="sxs-lookup"><span data-stu-id="a1af7-206">After the database comes online, the original log shipping configuration will resume.</span></span>

######  <a name="to-keep-the-old-secondary-server-instance-as-the-new-primary-server-instance"></a><a name="KeepOldSecondaryAsNewPrimary"></a><span data-ttu-id="a1af7-207">將舊的次要伺服器實例保留為新的主伺服器實例</span><span class="sxs-lookup"><span data-stu-id="a1af7-207">To Keep the Old Secondary Server Instance As the New Primary Server Instance</span></span>
 <span data-ttu-id="a1af7-208">將舊的次要伺服器執行個體 B 當做主要伺服器使用，並將舊的主要伺服器執行個體 A 當做新的次要伺服器使用，以建立新的記錄傳送組態，如下所示：</span><span class="sxs-lookup"><span data-stu-id="a1af7-208">Establish a new log shipping configuration using the old secondary server instance, B, as the primary server and the old primary server instance, A, as the new secondary server, as follows:</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a1af7-209">在進行手動交易記錄備份來讓資料庫離線之前，舊的記錄傳送組態應該在程序開始時就已經從原始的主要伺服器中移除。</span><span class="sxs-lookup"><span data-stu-id="a1af7-209">The old log shipping configuration should have been removed from the original primary server at the start of the process before taking the manual transaction log backup that took the database offline.</span></span>

1.  <span data-ttu-id="a1af7-210">若要避免在新的次要伺服器 (伺服器 A) 上執行資料庫的完整備份及還原，請將記錄備份從新的主要資料庫套用到新的次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-210">To avoid performing a complete backup and restore of the database on the new secondary server (server A), apply the log backups from the new primary database to the new secondary database.</span></span> <span data-ttu-id="a1af7-211">在範例組態中，這牽涉到將伺服器 B 上所做的記錄備份還原到伺服器 A 上的資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-211">In the example configuration, this involves restoring the log backups taken on server B to the database on server A.</span></span>

2.  <span data-ttu-id="a1af7-212">從新的主要資料庫備份記錄 (在伺服器 B 上)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-212">Back up the log from the new primary database (on server B).</span></span>

3.  <span data-ttu-id="a1af7-213">使用 WITH NORECOVERY 將記錄備份還原到新的次要伺服器執行個體 (伺服器 A)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-213">Restore the log backups to the new secondary server instance (server A) using WITH NORECOVERY.</span></span> <span data-ttu-id="a1af7-214">第一個還原作業會將資料庫更新為 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="a1af7-214">The first restore operation updates the database to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

4.  <span data-ttu-id="a1af7-215">使用之前的次要伺服器 (伺服器 B) 將記錄傳送組態為主要伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="a1af7-215">Configure log shipping with the former secondary server (server B) as the primary server instance.</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="a1af7-216">如果您使用 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]，請指定次要資料庫已經初始化。</span><span class="sxs-lookup"><span data-stu-id="a1af7-216">If you use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], specify that the secondary database is already initialized.</span></span>

     <span data-ttu-id="a1af7-217">如需詳細資訊，請參閱[設定記錄傳送 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-217">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

5.  <span data-ttu-id="a1af7-218">將用戶端從原始主要伺服器 (伺服器 A) 重新導向線上次要伺服器 (伺服器 B) 來容錯移轉資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-218">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="a1af7-219">當您容錯移轉到新的主要資料庫時，應該確保其中繼資料與原始主要資料庫的中繼資料一致。</span><span class="sxs-lookup"><span data-stu-id="a1af7-219">When you failover to a new primary database, you should ensure that its metadata is consistent with the metadata of the original primary database.</span></span> <span data-ttu-id="a1af7-220">如需詳細資訊，請參閱 [在另一個伺服器執行個體上提供可用的資料庫時，管理中繼資料 &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-220">For more information, see [Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span></span>

##  <a name="upgrading-multiple-secondary-server-instances"></a><a name="MultipleSecondaries"></a><span data-ttu-id="a1af7-221">升級多個次要伺服器實例</span><span class="sxs-lookup"><span data-stu-id="a1af7-221">Upgrading Multiple Secondary Server Instances</span></span>
 <span data-ttu-id="a1af7-222">這個組態會在下圖中表示，其中顯示主要伺服器執行個體 A 及兩個次要伺服器執行個體 B 和 C。</span><span class="sxs-lookup"><span data-stu-id="a1af7-222">This configuration is represented in the following illustration, which shows a primary server instance, A, and two secondary server instances, B and C.</span></span>

 <span data-ttu-id="a1af7-223">![兩台次要伺服器，但是沒有監視伺服器](../media/ls-3-wayconfig-nomonitor.gif "兩台次要伺服器，但是沒有監視伺服器")</span><span class="sxs-lookup"><span data-stu-id="a1af7-223">![Two secondary servers and no monitor server](../media/ls-3-wayconfig-nomonitor.gif "Two secondary servers and no monitor server")</span></span>

 <span data-ttu-id="a1af7-224">本節討論如何使用容錯移轉進行升級，然後再切換回原始的主要伺服器。</span><span class="sxs-lookup"><span data-stu-id="a1af7-224">This section discusses how to upgrade using a failover and then switching back to the original primary server.</span></span> <span data-ttu-id="a1af7-225">當您使用容錯移轉升級主要執行個體時，程序要比多個次要伺服器執行個體來得複雜。</span><span class="sxs-lookup"><span data-stu-id="a1af7-225">When upgrading the primary instance with failover the process is more complex when there are multiple secondary server instances.</span></span> <span data-ttu-id="a1af7-226">在下列程序中，當升級所有次要伺服器之後，主要伺服器會容錯移轉成其中一個升級的次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-226">In the following procedure, after all the secondary servers are upgraded, the primary server is failed over to one of the upgraded secondary databases.</span></span> <span data-ttu-id="a1af7-227">原始主要伺服器會升級，而記錄傳送則會容錯移轉回該伺服器。</span><span class="sxs-lookup"><span data-stu-id="a1af7-227">The original primary server is upgraded, and log shipping is failed over back to it.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a1af7-228">在升級主要伺服器之前，請務必先升級所有次要伺服器執行個體。</span><span class="sxs-lookup"><span data-stu-id="a1af7-228">Always upgrade all the secondary server instances before you upgrade the primary server.</span></span>

 <span data-ttu-id="a1af7-229">**若要使用容錯移轉升級然後切換回原始的主要伺服器**</span><span class="sxs-lookup"><span data-stu-id="a1af7-229">**To upgrade using a failover and then switching back to original primary server**</span></span>

1.  <span data-ttu-id="a1af7-230">升級所有必要的伺服器執行個體 (伺服器 B 和 C)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-230">Upgrade all the secondary server instances (server B and server C).</span></span>

2.  <span data-ttu-id="a1af7-231">使用 WITH NORECOVERY 來備份交易記錄，以取得主要資料庫的交易記錄結尾 (在伺服器 A 上)，並讓資料庫離線。</span><span class="sxs-lookup"><span data-stu-id="a1af7-231">Obtain the tail of the transaction log of the primary database (on server A), and take the database offline, by backing up the transaction log using WITH NORECOVERY.</span></span>

3.  <span data-ttu-id="a1af7-232">在您打算容錯移轉到其上的次要伺服器 (伺服器 B) 上，使用 WITH RECOVERY 還原記錄備份來讓次要資料庫回到線上。</span><span class="sxs-lookup"><span data-stu-id="a1af7-232">On the secondary server to which you plan to fail over (server B), bring the secondary database online, by restoring the log backup using WITH RECOVERY.</span></span>

4.  <span data-ttu-id="a1af7-233">在其他每一部次要伺服器 (伺服器 C) 上，使用 WITH NORECOVERY 還原記錄備份來讓次要資料庫離線。</span><span class="sxs-lookup"><span data-stu-id="a1af7-233">On every other secondary server (server C), leave the secondary database offline by restoring the log backup using WITH NORECOVERY.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="a1af7-234">記錄傳送複製和還原作業將會在次要伺服器上執行，但是這些作業不會做任何事，因為新的記錄備份檔案將不會置於備份共用位置。</span><span class="sxs-lookup"><span data-stu-id="a1af7-234">The log shipping copy and restore jobs will run on the secondary servers, but the jobs will do nothing because new log-backup files will not be placed on the backup share.</span></span>

5.  <span data-ttu-id="a1af7-235">將用戶端從原始主要伺服器 (伺服器 A) 重新導向線上次要伺服器 (伺服器 B) 來容錯移轉資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-235">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span> <span data-ttu-id="a1af7-236">線上資料庫會變成暫時的主要伺服器，以便在原始的主要伺服器 (伺服器 A) 離線時可保持資料庫的可用性。</span><span class="sxs-lookup"><span data-stu-id="a1af7-236">The online database becomes an interim primary server, keeping the database available while the original primary server is offline (server A).</span></span>

6.  <span data-ttu-id="a1af7-237">升級原始的主要伺服器 (伺服器 A)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-237">Upgrade the original primary server (server A).</span></span>

7.  <span data-ttu-id="a1af7-238">在您已容錯回復的資料庫上-暫時主資料庫 (在伺服器 B) 上，使用 WITH NORECOVERY 手動備份交易記錄。</span><span class="sxs-lookup"><span data-stu-id="a1af7-238">On the database to which you failed over-the interim primary database (on server B), manually back up the transaction log using WITH NORECOVERY.</span></span> <span data-ttu-id="a1af7-239">這樣會讓資料庫離線。</span><span class="sxs-lookup"><span data-stu-id="a1af7-239">This takes the database offline.</span></span>

8.  <span data-ttu-id="a1af7-240">使用 WITH NORECOVERY 將您在暫時主要資料庫 (在伺服器 B) 上建立的所有交易記錄備份還原到其他每一個次要資料庫 (在伺服器 C 上)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-240">Restore all transaction log backups that you created on the interim primary database (on server B) to every other secondary database (on server C) using WITH NORECOVERY.</span></span> <span data-ttu-id="a1af7-241">如此可在升級之後從原始的主要資料庫繼續進行記錄傳送，而不需要在每一個次要資料庫上還原完整的資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-241">This allows log shipping to continue from the original primary database after its upgrade, without requiring a full database restore on each secondary database.</span></span>

9. <span data-ttu-id="a1af7-242">使用 WITH RECOVERY 將交易記錄從暫時的主要伺服器 (伺服器 B) 還原到原始的主要資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-242">Restore the transaction log from the interim primary server (server B) to the original primary database (on server A) using WITH RECOVERY.</span></span>

##  <a name="redeploying-log-shipping"></a><a name="Redeploying"></a><span data-ttu-id="a1af7-243">重新部署記錄傳送</span><span class="sxs-lookup"><span data-stu-id="a1af7-243">Redeploying Log Shipping</span></span>
 <span data-ttu-id="a1af7-244">如果不想使用上述任一個程序來移轉您的記錄傳送組態，則也可以重新部署記錄傳送，方法是利用主要資料庫的完整備份與還原來重新初始化次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="a1af7-244">If you do not want to migrate your log shipping configuration using one of the procedures shown above, you can redeploy log shipping from scratch by reinitializing your secondary database with a full backup and restore of the primary database.</span></span> <span data-ttu-id="a1af7-245">如果您的資料庫較小，或是升級程序期間不需要高可用性，這個方法可能會比較適用。</span><span class="sxs-lookup"><span data-stu-id="a1af7-245">This may be a desirable option if you have a small database or if high availability is not crucial during the upgrade procedure.</span></span>

 <span data-ttu-id="a1af7-246">如需啟用記錄傳送的詳細資訊，請參閱[設定記錄傳送 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="a1af7-246">For information about enabling log shipping, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="a1af7-247">另請參閱</span><span class="sxs-lookup"><span data-stu-id="a1af7-247">See Also</span></span>
 <span data-ttu-id="a1af7-248">[交易記錄備份 &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md)套用[交易記錄備份 &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [記錄傳送資料表和預存程式](log-shipping-tables-and-stored-procedures.md)</span><span class="sxs-lookup"><span data-stu-id="a1af7-248">[Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [Apply Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [Log Shipping Tables and Stored Procedures](log-shipping-tables-and-stored-procedures.md)</span></span>
