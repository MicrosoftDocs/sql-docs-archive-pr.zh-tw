---
title: 記錄傳送和複寫 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- replication [SQL Server], log shipping and
- log shipping [SQL Server], replication and
ms.assetid: 132bebfd-0206-4d23-829a-b38e5ed17bc9
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e3b1a0e08c5850b9e31202965909dfcfe1273e47
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87597333"
---
# <a name="log-shipping-and-replication-sql-server"></a><span data-ttu-id="adc3d-102">記錄傳送和複寫 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="adc3d-102">Log Shipping and Replication (SQL Server)</span></span>
  <span data-ttu-id="adc3d-103">記錄傳送牽涉的對象，通常和不同電腦上各自儲存的單一資料庫複本有關。</span><span class="sxs-lookup"><span data-stu-id="adc3d-103">Log shipping involves two copies of a single database that typically reside on different computers.</span></span> <span data-ttu-id="adc3d-104">在任何時間內，目前的用戶端都只能使用其中一份資料庫副本，</span><span class="sxs-lookup"><span data-stu-id="adc3d-104">At any given time, only one copy of the database is currently available to clients.</span></span> <span data-ttu-id="adc3d-105">此份資料庫稱為主要資料庫。</span><span class="sxs-lookup"><span data-stu-id="adc3d-105">This copy is known as the primary database.</span></span> <span data-ttu-id="adc3d-106">用戶端對主要資料庫所做的更新，會透過記錄傳送方式傳播到其他資料庫複本 (亦稱為次要資料庫)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-106">Updates made by clients to the primary database are propagated by means of log shipping to the other copy of the database, known as the secondary database.</span></span> <span data-ttu-id="adc3d-107">記錄傳送會將交易記錄中對主要資料庫所做的每一項插入、更新或刪除，套用到次要資料庫上。</span><span class="sxs-lookup"><span data-stu-id="adc3d-107">Log shipping involves applying the transaction log from every insertion, update, or deletion made on the primary database onto the secondary database.</span></span>  
  
 <span data-ttu-id="adc3d-108">記錄傳送可與複寫一起使用，且具有下列行為：</span><span class="sxs-lookup"><span data-stu-id="adc3d-108">Log shipping can be used in conjunction with replication, with the following behavior:</span></span>  
  
-   <span data-ttu-id="adc3d-109">在記錄傳送容錯移轉之後，複寫將不會繼續。</span><span class="sxs-lookup"><span data-stu-id="adc3d-109">Replication does not continue after a log shipping failover.</span></span> <span data-ttu-id="adc3d-110">如果發生容錯移轉，複寫代理程式不會連接到次要伺服器，因此交易不會複寫至「訂閱者」。</span><span class="sxs-lookup"><span data-stu-id="adc3d-110">If a failover occurs, replication agents do not connect to the secondary, so transactions are not replicated to Subscribers.</span></span> <span data-ttu-id="adc3d-111">如果發生錯誤後回復至主要伺服器，則複寫便會繼續。</span><span class="sxs-lookup"><span data-stu-id="adc3d-111">If a failback to the primary occurs, replication resumes.</span></span> <span data-ttu-id="adc3d-112">由記錄傳送從次要伺服器複製回主要伺服器的所有交易，都會複寫至「訂閱者」。</span><span class="sxs-lookup"><span data-stu-id="adc3d-112">All transactions that log shipping copies from the secondary back to the primary are replicated to Subscribers.</span></span>  
  
-   <span data-ttu-id="adc3d-113">如果主要伺服器永久遺失，則可以重新命名次要伺服器，以讓複寫能夠繼續。</span><span class="sxs-lookup"><span data-stu-id="adc3d-113">If the primary is permanently lost, the secondary can be renamed so that replication can continue.</span></span> <span data-ttu-id="adc3d-114">此主題的其餘部分描述的是處理此情況的需求和程序。</span><span class="sxs-lookup"><span data-stu-id="adc3d-114">The remainder of this topic describes the requirements and procedures for handling this case.</span></span> <span data-ttu-id="adc3d-115">此處提供的範例為發行集資料庫，這是最常進行記錄傳送的資料庫，不過類似的程序也可以套用至訂閱資料庫和散發資料庫。</span><span class="sxs-lookup"><span data-stu-id="adc3d-115">The example given is the publication database, which is the most common database to log ship, but a similar process can also be applied to subscription and distribution databases.</span></span>  
  
 <span data-ttu-id="adc3d-116">如需復原與複寫相關的資料庫，而不需要重新設定複寫的資訊，請參閱 [備份及還原複寫的資料庫](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-116">For information about recovering databases involved in replication without any need to reconfigure replication, see [Back Up and Restore Replicated Databases](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="adc3d-117">我們建議使用資料庫鏡像，而不要使用記錄傳送，以便於使用發行集資料庫。</span><span class="sxs-lookup"><span data-stu-id="adc3d-117">We recommend using database mirroring, rather than log shipping, to provide availability for the publication database.</span></span> <span data-ttu-id="adc3d-118">如需詳細資訊，請參閱 [資料庫鏡像和複寫 &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-118">For more information, see [Database Mirroring and Replication &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span></span>  
  
## <a name="requirements-and-procedures-for-replicating-from-the-secondary-if-the-primary-is-lost"></a><span data-ttu-id="adc3d-119">主要伺服器遺失時，從次要伺服器複寫的需求和程序</span><span class="sxs-lookup"><span data-stu-id="adc3d-119">Requirements and Procedures for Replicating from the Secondary If the Primary Is Lost</span></span>  
 <span data-ttu-id="adc3d-120">請注意下列需求和考量：</span><span class="sxs-lookup"><span data-stu-id="adc3d-120">Be aware of the following requirements and considerations:</span></span>  
  
-   <span data-ttu-id="adc3d-121">如果主要伺服器包含一個以上的發行集資料庫，請將所有發行集資料庫記錄傳送至相同的次要伺服器。</span><span class="sxs-lookup"><span data-stu-id="adc3d-121">If a primary contains more than one publication database, log ship all of the publication databases to the same secondary.</span></span>  
  
-   <span data-ttu-id="adc3d-122">次要伺服器執行個體的安裝路徑必須與主要伺服器的安裝路徑相同，</span><span class="sxs-lookup"><span data-stu-id="adc3d-122">The installation path for the secondary server instance must be the same as the primary.</span></span> <span data-ttu-id="adc3d-123">且次要伺服器上的使用者資料庫位置也必須與主要伺服器上的位置相同。</span><span class="sxs-lookup"><span data-stu-id="adc3d-123">User database locations on the secondary server must be the same as on the primary.</span></span>  
  
-   <span data-ttu-id="adc3d-124">在主要伺服器端備份服務主要金鑰，</span><span class="sxs-lookup"><span data-stu-id="adc3d-124">Back up the service master key at the primary.</span></span> <span data-ttu-id="adc3d-125">此金鑰將在次要伺服器端還原。</span><span class="sxs-lookup"><span data-stu-id="adc3d-125">This key will be restored at the secondary.</span></span> <span data-ttu-id="adc3d-126">如需詳細資訊，請參閱 [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-126">For more information, see [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span></span>  
  
-   <span data-ttu-id="adc3d-127">記錄傳送不保證資料不會遺失。</span><span class="sxs-lookup"><span data-stu-id="adc3d-127">Log shipping does not guarantee against data loss.</span></span> <span data-ttu-id="adc3d-128">主要資料庫上若是失敗，可能導致尚未備份的資料遺失，或是在失敗期間遺失備份。</span><span class="sxs-lookup"><span data-stu-id="adc3d-128">A failure on the primary database can result in the loss of data that has not yet been backed up or for backups that are lost during the failure.</span></span>  
  
### <a name="log-shipping-with-transactional-replication"></a><span data-ttu-id="adc3d-129">記錄傳送與異動複寫</span><span class="sxs-lookup"><span data-stu-id="adc3d-129">Log Shipping with Transactional Replication</span></span>  
 <span data-ttu-id="adc3d-130">對於異動複寫，記錄傳送的行為取決於 **sync with backup** 選項。</span><span class="sxs-lookup"><span data-stu-id="adc3d-130">For transactional replication, the behavior of log shipping depends on the **sync with backup** option.</span></span> <span data-ttu-id="adc3d-131">此選項可以在發行集資料庫和散發資料庫上設定；不過在「發行者」的記錄傳送中，只與發行集資料庫上的設定相關。</span><span class="sxs-lookup"><span data-stu-id="adc3d-131">This option can be set on the publication database and distribution database; in log shipping for the Publisher, only the setting on the publication database is relevant.</span></span>  
  
 <span data-ttu-id="adc3d-132">在發行集資料庫上設定此選項，可確保交易在發行集資料庫中備份之前，不會傳遞到散發資料庫。</span><span class="sxs-lookup"><span data-stu-id="adc3d-132">Setting this option on the publication database ensures that transactions are not delivered to the distribution database until they are backed up at the publication database.</span></span> <span data-ttu-id="adc3d-133">如此一來，最近一次的發行集資料庫備份便可以在次要伺服器端還原，而不會發生散發資料庫中，存有發行集資料庫中所沒有的交易這種情況。</span><span class="sxs-lookup"><span data-stu-id="adc3d-133">The last publication database backup can then be restored at the secondary server without any possibility of the distribution database having transactions that the restored publication database does not have.</span></span> <span data-ttu-id="adc3d-134">這個選項可保證當「發行者」容錯移轉至次要伺服器時，仍可維持「發行者」、「散發者」和「訂閱者」之間的一致性。</span><span class="sxs-lookup"><span data-stu-id="adc3d-134">This option guarantees that if the Publisher fails over to a secondary server, consistency is maintained between the Publisher, Distributor, and Subscribers.</span></span> <span data-ttu-id="adc3d-135">延遲和輸送量會受到影響，因為交易在發行者端備份之前，不能傳遞到散發資料庫。如果您的應用程式允許此延遲，則建議您在發行集資料庫上設定此選項。</span><span class="sxs-lookup"><span data-stu-id="adc3d-135">Latency and throughput are affected because transactions cannot be delivered to the distribution database until they have been backed up at the Publisher; if your application can tolerate this latency, we recommend that you set this option on the publication database.</span></span> <span data-ttu-id="adc3d-136">如果沒有設定 **sync with backup** 選項，則「訂閱者」可能會收到不再包含於次要伺服器端已復原資料庫中的變更。</span><span class="sxs-lookup"><span data-stu-id="adc3d-136">If the **sync with backup** option is not set, Subscribers might receive changes that are no longer included in the recovered database at the secondary server.</span></span> <span data-ttu-id="adc3d-137">如需詳細資訊，請參閱 [備份與還原快照式和異動複寫的策略](../../relational-databases/replication/transactional/transactional-replication.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-137">For more information, see [Strategies for Backing Up and Restoring Snapshot and Transactional Replication](../../relational-databases/replication/transactional/transactional-replication.md).</span></span>  
  
 <span data-ttu-id="adc3d-138">**若要設定使用 sync with backup 選項的異動複寫和記錄傳送**</span><span class="sxs-lookup"><span data-stu-id="adc3d-138">**To configure transactional replication and log shipping with the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="adc3d-139">如果未在發行集資料庫上設定 sync with backup 選項，請執行 `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`。</span><span class="sxs-lookup"><span data-stu-id="adc3d-139">If the sync with backup option is not set on the publication database, execute `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span></span> <span data-ttu-id="adc3d-140">如需詳細資訊，請參閱 [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-140">For more information, see [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span></span>  
  
2.  <span data-ttu-id="adc3d-141">設定發行集資料庫的記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="adc3d-141">Configure log shipping for the publication database.</span></span> <span data-ttu-id="adc3d-142">如需詳細資訊，請參閱[設定記錄傳送 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-142">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="adc3d-143">如果「發行者」失敗，請使用 RESTORE LOG 的 KEEP_REPLICATION 選項，將資料庫的最後記錄還原至次要伺服器，</span><span class="sxs-lookup"><span data-stu-id="adc3d-143">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="adc3d-144">這會保留資料庫的所有複寫設定。</span><span class="sxs-lookup"><span data-stu-id="adc3d-144">This retains all replication settings for the database.</span></span> <span data-ttu-id="adc3d-145">如需詳細資訊，請參閱[容錯移轉至記錄傳送次要 &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) 和 [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-145">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="adc3d-146">將 **msdb** 資料庫和 **master** 資料庫從主要伺服器還原至次要伺服器。</span><span class="sxs-lookup"><span data-stu-id="adc3d-146">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="adc3d-147">如需詳細資訊，請參閱[系統資料庫的備份與還原 &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-147">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="adc3d-148">如果主要伺服器也是「散發者」，請將散發資料庫從主要伺服器還原至次要伺服器。</span><span class="sxs-lookup"><span data-stu-id="adc3d-148">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="adc3d-149">這些資料庫在複寫組態和設定方面，必須與主要伺服器端的發行集資料庫一致。</span><span class="sxs-lookup"><span data-stu-id="adc3d-149">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="adc3d-150">在次要伺服器上，重新命名電腦，然後重新命名 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 執行個體，以符合主要伺服器名稱。</span><span class="sxs-lookup"><span data-stu-id="adc3d-150">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="adc3d-151">如需有關重新命名電腦的詳細資訊，請參閱 Windows 文件集。</span><span class="sxs-lookup"><span data-stu-id="adc3d-151">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="adc3d-152">如需重新命名伺服器的資訊，請參閱 [重新命名主控 SQL Server 獨立執行個體的電腦](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) 和 [重新命名 SQL Server 容錯移轉叢集執行個體](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-152">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
6.  <span data-ttu-id="adc3d-153">在次要伺服器上，還原從主要伺服器所備份的服務主要金鑰。</span><span class="sxs-lookup"><span data-stu-id="adc3d-153">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="adc3d-154">如需詳細資訊，請參閱 [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-154">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
 <span data-ttu-id="adc3d-155">**若要設定異動複寫和記錄傳送，而不使用 sync with backup 選項**</span><span class="sxs-lookup"><span data-stu-id="adc3d-155">**To configure transactional replication and log shipping without the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="adc3d-156">設定發行集資料庫的記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="adc3d-156">Configure log shipping for the publication database.</span></span> <span data-ttu-id="adc3d-157">如需詳細資訊，請參閱[設定記錄傳送 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-157">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="adc3d-158">如果「發行者」失敗，請使用 RESTORE LOG 的 KEEP_REPLICATION 選項，將資料庫的最後記錄還原至次要伺服器，</span><span class="sxs-lookup"><span data-stu-id="adc3d-158">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="adc3d-159">這會保留資料庫的所有複寫設定。</span><span class="sxs-lookup"><span data-stu-id="adc3d-159">This retains all replication settings for the database.</span></span> <span data-ttu-id="adc3d-160">如需詳細資訊，請參閱[容錯移轉至記錄傳送次要 &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) 和 [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-160">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
3.  <span data-ttu-id="adc3d-161">將 **msdb** 資料庫和 **master** 資料庫從主要伺服器還原至次要伺服器。</span><span class="sxs-lookup"><span data-stu-id="adc3d-161">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="adc3d-162">如需詳細資訊，請參閱[系統資料庫的備份與還原 &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-162">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="adc3d-163">如果主要伺服器也是「散發者」，請將散發資料庫從主要伺服器還原至次要伺服器。</span><span class="sxs-lookup"><span data-stu-id="adc3d-163">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="adc3d-164">這些資料庫在複寫組態和設定方面，必須與主要伺服器端的發行集資料庫一致。</span><span class="sxs-lookup"><span data-stu-id="adc3d-164">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
4.  <span data-ttu-id="adc3d-165">在次要伺服器上，重新命名電腦，然後重新命名 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 執行個體，以符合主要伺服器名稱。</span><span class="sxs-lookup"><span data-stu-id="adc3d-165">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="adc3d-166">如需有關重新命名電腦的詳細資訊，請參閱 Windows 文件集。</span><span class="sxs-lookup"><span data-stu-id="adc3d-166">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="adc3d-167">如需重新命名伺服器的資訊，請參閱 [重新命名主控 SQL Server 獨立執行個體的電腦](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) 和 [重新命名 SQL Server 容錯移轉叢集執行個體](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-167">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
     <span data-ttu-id="adc3d-168">您可能會收到來自「記錄讀取器代理程式」的錯誤訊息，指出發行集資料庫和散發資料庫並未同步處理。</span><span class="sxs-lookup"><span data-stu-id="adc3d-168">You might receive an error message from the Log Reader Agent that the publication database and the distribution database are not synchronized.</span></span>  
  
5.  <span data-ttu-id="adc3d-169">在次要伺服器上，還原從主要伺服器所備份的服務主要金鑰。</span><span class="sxs-lookup"><span data-stu-id="adc3d-169">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="adc3d-170">如需詳細資訊，請參閱 [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-170">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="adc3d-171">執行 **sp_replrestart**。</span><span class="sxs-lookup"><span data-stu-id="adc3d-171">Execute **sp_replrestart**.</span></span> <span data-ttu-id="adc3d-172">使用這個預存程序，可以強制「記錄讀取器代理程式」忽略發行集資料庫記錄中所有先前複寫的交易。</span><span class="sxs-lookup"><span data-stu-id="adc3d-172">This stored procedure can be used to force the Log Reader Agent to ignore all the previous replicated transactions in the publication database log.</span></span> <span data-ttu-id="adc3d-173">在預存程序完成之後所套用的交易，會由「記錄讀取器代理程式」來處理。</span><span class="sxs-lookup"><span data-stu-id="adc3d-173">Transactions applied after the completion of the stored procedure are processed by the Log Reader Agent.</span></span> <span data-ttu-id="adc3d-174">如需詳細資訊，請參閱 [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-174">For more information, see [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span></span>  
  
7.  <span data-ttu-id="adc3d-175">在預存程序成功執行之後重新啟動「記錄讀取器代理程式」。</span><span class="sxs-lookup"><span data-stu-id="adc3d-175">Restart the Log Reader Agent after the stored procedure executes successfully.</span></span> <span data-ttu-id="adc3d-176">如需詳細資訊，請參閱[啟動和停止複寫代理程式 &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-176">For more information, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span></span>  
  
8.  <span data-ttu-id="adc3d-177">已經散發至訂閱者的交易可能會在發行者端套用。</span><span class="sxs-lookup"><span data-stu-id="adc3d-177">Transactions that have already been distributed to Subscriber might be applied at the Publisher.</span></span> <span data-ttu-id="adc3d-178">為了確保「散發代理程式」嘗試在訂閱者端重新套用這些交易時，不會因錯誤而導致失敗，請指定標題為 **資料一致性錯誤時仍然繼續**的代理程式設定檔。</span><span class="sxs-lookup"><span data-stu-id="adc3d-178">To ensure that the Distribution Agent does not fail with an error when attempting to reapply these transactions at a Subscriber, specify the agent profile titled **Continue On Data Consistency Errors**.</span></span>  
  
### <a name="log-shipping-with-merge-replication"></a><span data-ttu-id="adc3d-179">記錄傳送與合併式複寫</span><span class="sxs-lookup"><span data-stu-id="adc3d-179">Log Shipping with Merge Replication</span></span>  
 <span data-ttu-id="adc3d-180">請遵循下列程序中的步驟，設定合併式複寫和記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="adc3d-180">Follow the steps in the procedure below to configure merge replication and log shipping.</span></span>  
  
 <span data-ttu-id="adc3d-181">**若要設定合併式複寫和記錄傳送**</span><span class="sxs-lookup"><span data-stu-id="adc3d-181">**To configure merge replication and log shipping**</span></span>  
  
1.  <span data-ttu-id="adc3d-182">設定發行集資料庫的記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="adc3d-182">Configure log shipping for the publication database.</span></span> <span data-ttu-id="adc3d-183">如需詳細資訊，請參閱[設定記錄傳送 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-183">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="adc3d-184">如果發行者失敗，請在次要伺服器上重新命名電腦，然後重新命名 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 執行個體，以符合主要伺服器名稱。</span><span class="sxs-lookup"><span data-stu-id="adc3d-184">If the Publisher fails, at the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="adc3d-185">如需有關重新命名電腦的詳細資訊，請參閱 Windows 文件集。</span><span class="sxs-lookup"><span data-stu-id="adc3d-185">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="adc3d-186">如需重新命名伺服器的資訊，請參閱 [重新命名主控 SQL Server 獨立執行個體的電腦](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) 和 [重新命名 SQL Server 容錯移轉叢集執行個體](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-186">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
3.  <span data-ttu-id="adc3d-187">請使用 RESTORE LOG 的 KEEP_REPLICATION 選項，將資料庫的最後記錄還原至次要伺服器，</span><span class="sxs-lookup"><span data-stu-id="adc3d-187">Restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="adc3d-188">這會保留資料庫的所有複寫設定。</span><span class="sxs-lookup"><span data-stu-id="adc3d-188">This retains all replication settings for the database.</span></span> <span data-ttu-id="adc3d-189">如需詳細資訊，請參閱[容錯移轉至記錄傳送次要 &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) 和 [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-189">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="adc3d-190">將 **msdb** 資料庫和 **master** 資料庫從主要伺服器還原至次要伺服器。</span><span class="sxs-lookup"><span data-stu-id="adc3d-190">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="adc3d-191">如需詳細資訊，請參閱[系統資料庫的備份與還原 &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-191">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="adc3d-192">如果主要伺服器也是「散發者」，請將散發資料庫從主要伺服器還原至次要伺服器。</span><span class="sxs-lookup"><span data-stu-id="adc3d-192">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="adc3d-193">這些資料庫在複寫組態和設定方面，必須與主要伺服器端的發行集資料庫一致。</span><span class="sxs-lookup"><span data-stu-id="adc3d-193">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="adc3d-194">在次要伺服器上，還原從主要伺服器所備份的服務主要金鑰。</span><span class="sxs-lookup"><span data-stu-id="adc3d-194">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="adc3d-195">如需詳細資訊，請參閱 [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-195">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="adc3d-196">同步處理發行集資料庫與一或多個訂閱資料庫。</span><span class="sxs-lookup"><span data-stu-id="adc3d-196">Synchronize the publication database with one or more subscription databases.</span></span> <span data-ttu-id="adc3d-197">這可讓您上傳先前於發行集資料庫中所執行、但是未在還原的備份中呈現的變更。</span><span class="sxs-lookup"><span data-stu-id="adc3d-197">This allows you to upload those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="adc3d-198">可以上傳的資料視發行集的篩選方式而定：</span><span class="sxs-lookup"><span data-stu-id="adc3d-198">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
    -   <span data-ttu-id="adc3d-199">如果發行集未篩選，您可以透過與最新的「訂閱者」進行同步處理，使發行集資料庫處於最新狀態。</span><span class="sxs-lookup"><span data-stu-id="adc3d-199">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
    -   <span data-ttu-id="adc3d-200">如果發行集已篩選，則可能無法使發行集資料庫處於最新狀態。</span><span class="sxs-lookup"><span data-stu-id="adc3d-200">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="adc3d-201">請思考一下一個已進行資料分割的資料表，其中資料分割方式使得每個訂閱只會收到下列單一地區的客戶資料：北區、東區、南區及西區。</span><span class="sxs-lookup"><span data-stu-id="adc3d-201">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="adc3d-202">如果每個資料分割至少有一個「訂閱者」，則與每個資料分割的「訂閱者」進行同步處理就可使發行集資料庫處於最新狀態。</span><span class="sxs-lookup"><span data-stu-id="adc3d-202">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="adc3d-203">不過，如果在「西區」資料分割中的資料未複寫到任何「訂閱者」(舉例來說)，則「發行者」端的此資料將無法處於最新狀態。</span><span class="sxs-lookup"><span data-stu-id="adc3d-203">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span> <span data-ttu-id="adc3d-204">在此情況下，建議您重新初始化所有訂閱，以讓發行者端和訂閱者端的資料聚合。</span><span class="sxs-lookup"><span data-stu-id="adc3d-204">In this case, we recommend reinitializing all subscriptions so that the data at the Publisher and Subscribers converges.</span></span> <span data-ttu-id="adc3d-205">如需詳細資訊，請參閱 [重新初始化訂閱](../../relational-databases/replication/reinitialize-subscriptions.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-205">For more information, see [Reinitialize Subscriptions](../../relational-databases/replication/reinitialize-subscriptions.md).</span></span>  
  
     <span data-ttu-id="adc3d-206">如果同步處理的「訂閱者」所執行的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 版本早於 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]，則訂閱不可是匿名的，而必須是客訂閱或主訂閱 (在之前的版本中稱為本機訂閱與全域訂閱)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-206">If you synchronize with a Subscriber that is running a version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] prior to [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span> <span data-ttu-id="adc3d-207">如需詳細資訊，請參閱 [同步處理資料](../../relational-databases/replication/synchronize-data.md)。</span><span class="sxs-lookup"><span data-stu-id="adc3d-207">For more information, see [Synchronize Data](../../relational-databases/replication/synchronize-data.md).</span></span>   
  
## <a name="see-also"></a><span data-ttu-id="adc3d-208">另請參閱</span><span class="sxs-lookup"><span data-stu-id="adc3d-208">See Also</span></span>  
 <span data-ttu-id="adc3d-209">[SQL Server 複寫](../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="adc3d-209">[SQL Server Replication](../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="adc3d-210">[關於記錄傳送 &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="adc3d-210">[About Log Shipping &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span></span>  
 [<span data-ttu-id="adc3d-211">資料庫鏡像和複寫 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="adc3d-211">Database Mirroring and Replication &#40;SQL Server&#41;</span></span>](../database-mirroring/database-mirroring-and-replication-sql-server.md)  
  
  
