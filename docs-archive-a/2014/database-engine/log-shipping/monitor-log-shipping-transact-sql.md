---
title: 監視記錄傳送 (Transact-SQL) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], status
- history tables [SQL Server]
- historical information [SQL Server], log shipping
- log shipping [SQL Server], monitoring
- alerts [SQL Server], log shipping
- status information [SQL Server], log shipping
- monitoring log shipping [SQL Server]
ms.assetid: acf3cd99-55f7-4287-8414-0892f830f423
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0ab87d5d8aa08b7b2860fe52fd097f33af327a94
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87593536"
---
# <a name="monitor-log-shipping-transact-sql"></a><span data-ttu-id="dbb8a-102">監視記錄傳送 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="dbb8a-102">Monitor Log Shipping (Transact-SQL)</span></span>
  <span data-ttu-id="dbb8a-103">在您設定了記錄傳送之後，即可監視所有記錄傳送伺服器的狀態相關資訊。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-103">After you have configured log shipping, you can monitor information about the status of all the log shipping servers.</span></span> <span data-ttu-id="dbb8a-104">記錄傳送作業的記錄和狀態一律是由記錄傳送作業儲存在本端。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-104">The history and status of log shipping operations are always saved locally by the log shipping jobs.</span></span> <span data-ttu-id="dbb8a-105">備份作業的記錄和狀態會儲存在主要伺服器，而複製和還原作業的記錄和狀態會儲存在次要伺服器上。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-105">The history and status of the backup operation are stored at the primary server, and the history and status of the copy and restore operations are stored at the secondary server.</span></span> <span data-ttu-id="dbb8a-106">若您已實作遠端監視伺服器，此資訊也會儲存在監視伺服器中。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-106">If you have implemented a remote monitor server, this information is also stored on the monitor server.</span></span>  
  
 <span data-ttu-id="dbb8a-107">您可以設定若記錄傳送作業無法依排程執行時將要引發的警示。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-107">You can configure alerts that will fire if log shipping operations fail to occur as scheduled.</span></span> <span data-ttu-id="dbb8a-108">負責監視備份及還原作業狀態的警示作業會引發錯誤。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-108">Errors are raised by an alert job that watches the status of the backup and restore operations.</span></span> <span data-ttu-id="dbb8a-109">您可以定義當這些錯誤產生時，要用來通知操作員的警示。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-109">You can define alerts that notify an operator when these errors are raised.</span></span> <span data-ttu-id="dbb8a-110">若已設定監視伺服器，就會在監視伺服器上執行一項警示作業，針對記錄傳送組態中的所有作業來引發錯誤。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-110">If a monitor server is configured, one alert job runs on the monitor server that raises errors for all operations in the log shipping configuration.</span></span> <span data-ttu-id="dbb8a-111">若未指定監視伺服器，就會在負責監視備份作業的主要伺服器執行個體上執行警示作業。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-111">If a monitor server is not specified, an alert job runs on the primary server instance, which monitors the backup operation.</span></span> <span data-ttu-id="dbb8a-112">若未指定監視伺服器，警示作業也會在每個次要伺服器執行個體上執行，以監視本端的複製和還原作業。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-112">If a monitor server is not specified, an alert job also runs on each secondary server instance to monitor the local copy and restore operations.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="dbb8a-113">若要監視記錄傳送組態，您必須在啟用記錄傳送時，加入監視伺服器。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-113">To monitor a log shipping configuration, you must add the monitor server when you enable log shipping.</span></span> <span data-ttu-id="dbb8a-114">如果您日後要加入監視伺服器，就必須移除記錄傳送組態，然後將它取代成包含監視伺服器的新組態。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-114">If you add a monitor server later, you must remove the log shipping configuration and then replace it with a new configuration that includes a monitor server.</span></span> <span data-ttu-id="dbb8a-115">如需詳細資訊，請參閱[設定記錄傳送 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-115">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span> <span data-ttu-id="dbb8a-116">此外，在設定監視伺服器之後，如果未先移除記錄傳送，就無法進行變更。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-116">Furthermore, after the monitor server has been configured, it cannot be changed without removing log shipping first.</span></span>  
  
## <a name="history-tables-containing-monitoring-information"></a><span data-ttu-id="dbb8a-117">包含監視資訊的記錄資料表</span><span class="sxs-lookup"><span data-stu-id="dbb8a-117">History Tables Containing Monitoring Information</span></span>  
 <span data-ttu-id="dbb8a-118">監視記錄資料表包含儲存在監視伺服器上的中繼資料。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-118">The monitoring history tables contain metadata that is stored on the monitor server.</span></span> <span data-ttu-id="dbb8a-119">給定之主要或次要伺服器的特定資訊副本也會儲存在本端。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-119">A copy of information specific to a given primary or secondary server is also stored locally.</span></span>  
  
 <span data-ttu-id="dbb8a-120">您可以查詢這些資料表來監視記錄傳送工作階段的狀態。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-120">You can query these tables to monitor the status of a log shipping session.</span></span> <span data-ttu-id="dbb8a-121">例如，若要知道記錄傳送的狀態，請檢查備份作業、複製作業及還原作業的狀態和記錄。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-121">For example, to learn status of log shipping, check the status and history of the backup job, copy job, and restore job.</span></span> <span data-ttu-id="dbb8a-122">您可以查詢下列監視資料表，以檢視特定的記錄傳送記錄和錯誤詳細資料。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-122">You can view specific log shipping history and error details by querying the following monitoring tables.</span></span>  
  
|<span data-ttu-id="dbb8a-123">Table</span><span class="sxs-lookup"><span data-stu-id="dbb8a-123">Table</span></span>|<span data-ttu-id="dbb8a-124">描述</span><span class="sxs-lookup"><span data-stu-id="dbb8a-124">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="dbb8a-125">log_shipping_monitor_alert</span><span class="sxs-lookup"><span data-stu-id="dbb8a-125">log_shipping_monitor_alert</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-alert-transact-sql)|<span data-ttu-id="dbb8a-126">儲存警示作業識別碼。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-126">Stores alert job ID.</span></span>|  
|[<span data-ttu-id="dbb8a-127">log_shipping_monitor_error_detail</span><span class="sxs-lookup"><span data-stu-id="dbb8a-127">log_shipping_monitor_error_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-error-detail-transact-sql)|<span data-ttu-id="dbb8a-128">儲存記錄傳送作業的錯誤明細。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-128">Stores error details for log shipping jobs.</span></span> <span data-ttu-id="dbb8a-129">您可以查詢此資料表來查看代理程式工作階段的錯誤。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-129">You can query this table see the errors for an agent session.</span></span> <span data-ttu-id="dbb8a-130">您可以選擇依每個錯誤的記錄日期和時間來排序。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-130">Optionally, you can sort the errors by the date and time at which each was logged.</span></span> <span data-ttu-id="dbb8a-131">每個錯誤都會被記錄成一個例外狀況序列，而多重錯誤 (序列) 會依每項代理程式工作階段來記錄。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-131">Each error is logged as a sequence of exceptions, and multiple errors (sequences) can per agent session.</span></span>|  
|[<span data-ttu-id="dbb8a-132">log_shipping_monitor_history_detail</span><span class="sxs-lookup"><span data-stu-id="dbb8a-132">log_shipping_monitor_history_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-history-detail-transact-sql)|<span data-ttu-id="dbb8a-133">包含記錄傳送代理程式的記錄詳細資料。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-133">Contains history details for log shipping agents.</span></span> <span data-ttu-id="dbb8a-134">您可以查詢此資料表來查看代理程式工作階段的記錄詳細資料。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-134">You can query this table to see the history detail for an agent session.</span></span>|  
|[<span data-ttu-id="dbb8a-135">log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="dbb8a-135">log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="dbb8a-136">在每個記錄傳送組態中儲存一筆主要資料庫的監視記錄，包括有助於監視作業的最後備份檔及最後還原檔的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-136">Stores one monitor record for the primary database in each log shipping configuration, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
|[<span data-ttu-id="dbb8a-137">log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="dbb8a-137">log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="dbb8a-138">為每個次要資料庫儲存一筆監視記錄，包括有助於監視作業的最後備份檔及最後還原檔的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-138">Stores one monitor record for each secondary database, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
  
## <a name="stored-procedures-for-monitoring-log-shipping"></a><span data-ttu-id="dbb8a-139">用來監視記錄傳送的預存程序</span><span class="sxs-lookup"><span data-stu-id="dbb8a-139">Stored Procedures for Monitoring Log Shipping</span></span>  
 <span data-ttu-id="dbb8a-140">監視和記錄資訊會儲存在 **msdb**的資料表中，可使用記錄傳送預存程序來存取。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-140">Monitoring and history information is stored in tables in **msdb**, which can be accessed using log shipping stored procedures.</span></span> <span data-ttu-id="dbb8a-141">在下表所指定的伺服器上執行這些預存程序。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-141">Run these stored procedures on the servers indicated in the following table.</span></span>  
  
|<span data-ttu-id="dbb8a-142">預存程序</span><span class="sxs-lookup"><span data-stu-id="dbb8a-142">Stored procedure</span></span>|<span data-ttu-id="dbb8a-143">描述</span><span class="sxs-lookup"><span data-stu-id="dbb8a-143">Description</span></span>|<span data-ttu-id="dbb8a-144">執行此程序的伺服器</span><span class="sxs-lookup"><span data-stu-id="dbb8a-144">Run this procedure on</span></span>|  
|----------------------|-----------------|---------------------------|  
|[<span data-ttu-id="dbb8a-145">sp_help_log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="dbb8a-145">sp_help_log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="dbb8a-146">從 **log_shipping_monitor_primary** 資料表傳回指定的主要資料庫的監視記錄。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-146">Returns monitor records for the specified primary database from the **log_shipping_monitor_primary** table.</span></span>|<span data-ttu-id="dbb8a-147">監視伺服器或主要伺服器</span><span class="sxs-lookup"><span data-stu-id="dbb8a-147">Monitor server or primary server</span></span>|  
|[<span data-ttu-id="dbb8a-148">sp_help_log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="dbb8a-148">sp_help_log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="dbb8a-149">從 **log_shipping_monitor_secondary** 資料表傳回指定的次要資料庫的監視記錄。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-149">Returns monitor records for the specified secondary database from the **log_shipping_monitor_secondary** table.</span></span>|<span data-ttu-id="dbb8a-150">監視伺服器或次要伺服器</span><span class="sxs-lookup"><span data-stu-id="dbb8a-150">Monitor server or secondary server</span></span>|  
|[<span data-ttu-id="dbb8a-151">sp_help_log_shipping_alert_job</span><span class="sxs-lookup"><span data-stu-id="dbb8a-151">sp_help_log_shipping_alert_job</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-alert-job-transact-sql)|<span data-ttu-id="dbb8a-152">傳回警示作業的作業識別碼。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-152">Returns the job ID of the alert job.</span></span>|<span data-ttu-id="dbb8a-153">監視伺服器，或主要或次要伺服器 (若未定義監視伺服器的話)</span><span class="sxs-lookup"><span data-stu-id="dbb8a-153">Monitor server, or primary or secondary server if no monitor is defined</span></span>|  
|[<span data-ttu-id="dbb8a-154">sp_help_log_shipping_primary_database</span><span class="sxs-lookup"><span data-stu-id="dbb8a-154">sp_help_log_shipping_primary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-database-transact-sql)|<span data-ttu-id="dbb8a-155">從 **log_shipping_primary_databases** 和 **log_shipping_monitor_primary** 資料表擷取主要資料庫設定然後顯示值。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-155">Retrieves primary database settings and displays the values from the **log_shipping_primary_databases** and **log_shipping_monitor_primary** tables.</span></span>|<span data-ttu-id="dbb8a-156">主要伺服器</span><span class="sxs-lookup"><span data-stu-id="dbb8a-156">Primary server</span></span>|  
|[<span data-ttu-id="dbb8a-157">sp_help_log_shipping_primary_secondary</span><span class="sxs-lookup"><span data-stu-id="dbb8a-157">sp_help_log_shipping_primary_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-secondary-transact-sql)|<span data-ttu-id="dbb8a-158">擷取主要資料庫的次要資料庫名稱。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-158">Retrieves secondary database names for a primary database.</span></span>|<span data-ttu-id="dbb8a-159">主要伺服器</span><span class="sxs-lookup"><span data-stu-id="dbb8a-159">Primary server</span></span>|  
|[<span data-ttu-id="dbb8a-160">sp_help_log_shipping_secondary_database</span><span class="sxs-lookup"><span data-stu-id="dbb8a-160">sp_help_log_shipping_secondary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-database-transact-sql)|<span data-ttu-id="dbb8a-161">從 **log_shipping_secondary**、 **log_shipping_secondary_databases** 和 **log_shipping_monitor_secondary** 資料表擷取次要資料庫的設定。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-161">Retrieves secondary-database settings from the **log_shipping_secondary**, **log_shipping_secondary_databases** and **log_shipping_monitor_secondary** tables.</span></span>|<span data-ttu-id="dbb8a-162">次要伺服器</span><span class="sxs-lookup"><span data-stu-id="dbb8a-162">Secondary server</span></span>|  
|[<span data-ttu-id="dbb8a-163">sp_help_log_shipping_secondary_primary &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="dbb8a-163">sp_help_log_shipping_secondary_primary &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-primary-transact-sql)|<span data-ttu-id="dbb8a-164">這個預存程序會擷取次要伺服器上所指定主要資料庫的設定。</span><span class="sxs-lookup"><span data-stu-id="dbb8a-164">This stored procedure retrieves the settings for a given primary database on the secondary server.</span></span>|<span data-ttu-id="dbb8a-165">次要伺服器</span><span class="sxs-lookup"><span data-stu-id="dbb8a-165">Secondary server</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="dbb8a-166">另請參閱</span><span class="sxs-lookup"><span data-stu-id="dbb8a-166">See Also</span></span>  
 <span data-ttu-id="dbb8a-167">[檢視記錄傳送報表 &#40;SQL Server Management Studio&#41;](view-the-log-shipping-report-sql-server-management-studio.md) </span><span class="sxs-lookup"><span data-stu-id="dbb8a-167">[View the Log Shipping Report &#40;SQL Server Management Studio&#41;](view-the-log-shipping-report-sql-server-management-studio.md) </span></span>  
 [<span data-ttu-id="dbb8a-168">記錄傳送預存程序與資料表</span><span class="sxs-lookup"><span data-stu-id="dbb8a-168">Log Shipping Stored Procedures and Tables</span></span>](log-shipping-tables-and-stored-procedures.md)  
  
  
