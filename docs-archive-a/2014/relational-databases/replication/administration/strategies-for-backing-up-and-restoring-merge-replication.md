---
title: 備份與還原合併式複寫的策略 | Microsoft Docs
ms.custom: ''
ms.date: 03/09/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- recovery [SQL Server replication], merge replication
- backups [SQL Server replication], merge replication
- restoring [SQL Server replication], merge replication
- merge replication [SQL Server replication], backup and restore
ms.assetid: b8ae31c6-d76f-4dd7-8f46-17d023ca3eca
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 45e3259d93af4735569fcb6b6a9c7b9eddd52730
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87705085"
---
# <a name="strategies-for-backing-up-and-restoring-merge-replication"></a><span data-ttu-id="f0734-102">備份與還原合併式複寫的策略</span><span class="sxs-lookup"><span data-stu-id="f0734-102">Strategies for Backing Up and Restoring Merge Replication</span></span>
  <span data-ttu-id="f0734-103">對於合併式複寫，請定期備份下列資料庫：</span><span class="sxs-lookup"><span data-stu-id="f0734-103">For merge replication, back up the following databases regularly:</span></span>  
  
-   <span data-ttu-id="f0734-104">發行者端的發行集資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-104">The publication database at the Publisher</span></span>   
-   <span data-ttu-id="f0734-105">散發者端的散發資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-105">The distribution database at the Distributor</span></span>    
-   <span data-ttu-id="f0734-106">每個訂閱者端的訂閱資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-106">The subscription database at each Subscriber</span></span>    
-   <span data-ttu-id="f0734-107">發行者、散發者及所有訂閱者端的 **master** 與 **msdb** 系統資料庫。</span><span class="sxs-lookup"><span data-stu-id="f0734-107">The **master** and **msdb** system databases at the Publisher, Distributor and all Subscribers.</span></span> <span data-ttu-id="f0734-108">這些資料庫應與其他每個及相關的複寫資料庫同時備份。</span><span class="sxs-lookup"><span data-stu-id="f0734-108">These databases should be backed up at the same time as each other and the relevant replication database.</span></span> <span data-ttu-id="f0734-109">例如，在您備份發行集資料庫的同時，在發行者端備份 **master** 與 **msdb** 資料庫。</span><span class="sxs-lookup"><span data-stu-id="f0734-109">For example, back up the **master** and **msdb** databases at the Publisher at the same time you back up the publication database.</span></span> <span data-ttu-id="f0734-110">還原發行集資料庫時，請確定 **master** 與 **msdb** 資料庫的複寫組態與設定和發行集資料庫一致。</span><span class="sxs-lookup"><span data-stu-id="f0734-110">If the publication database is restored, ensure that the **master** and **msdb** database are consistent with the publication database in terms of replication configuration and settings.</span></span>  
  
 <span data-ttu-id="f0734-111">如果您執行一般記錄備份，就必須在記錄備份中擷取任何複寫相關的變更。</span><span class="sxs-lookup"><span data-stu-id="f0734-111">If you perform regular log backups, any replication-related changes should be captured in the log backups.</span></span> <span data-ttu-id="f0734-112">如果您沒有執行記錄備份，每當與複寫相關的設定有所變更，就應該執行備份。</span><span class="sxs-lookup"><span data-stu-id="f0734-112">If you don't perform log backups, a backup should be performed whenever a setting relevant to replication is changed.</span></span> <span data-ttu-id="f0734-113">如需相關資訊，請參閱 [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md)。</span><span class="sxs-lookup"><span data-stu-id="f0734-113">For more information, see [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md).</span></span>  
  
 <span data-ttu-id="f0734-114">選擇下面詳述的方法之一，以備份與還原發行集資料庫，然後遵循為散發資料庫與訂閱資料庫列出的建議。</span><span class="sxs-lookup"><span data-stu-id="f0734-114">Choose one of the approaches detailed below for backing up and restoring the publication database, and then follow the recommendations listed for the distribution database and subscription databases.</span></span>  
  
## <a name="backing-up-and-restoring-the-publication-database"></a><span data-ttu-id="f0734-115">備份與還原發行集資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-115">Backing Up and Restoring the Publication Database</span></span>  
 <span data-ttu-id="f0734-116">還原合併式發行集資料庫有兩種方法。</span><span class="sxs-lookup"><span data-stu-id="f0734-116">There are two approaches to restoring a merge publication database.</span></span> <span data-ttu-id="f0734-117">從備份還原發行集資料庫之後，應執行下列之一：</span><span class="sxs-lookup"><span data-stu-id="f0734-117">After restoring the publication database from a backup, you should either:</span></span>  
  
-   <span data-ttu-id="f0734-118">同步處理發行集資料庫與訂閱資料庫。</span><span class="sxs-lookup"><span data-stu-id="f0734-118">Synchronize the publication database with a subscription database.</span></span>  
  
-   <span data-ttu-id="f0734-119">將所有的訂閱重新初始化至發行集資料庫的發行集。</span><span class="sxs-lookup"><span data-stu-id="f0734-119">Reinitialize all subscriptions to the publications in the publication database.</span></span>  
  
 <span data-ttu-id="f0734-120">使用以上方法之一確定在執行還原之後，「發行者」與所有「訂閱者」均保持同步。</span><span class="sxs-lookup"><span data-stu-id="f0734-120">Using either of these methods ensures that after a restore is performed, the Publisher and all Subscribers are synchronized.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f0734-121">如果任何資料表都包含識別欄位，則必須確定在還原後指派的識別範圍正確。</span><span class="sxs-lookup"><span data-stu-id="f0734-121">If any tables contain identity columns, you must ensure the correct identity ranges are assigned after a restore.</span></span> <span data-ttu-id="f0734-122">如需詳細資訊，請參閱[複寫識別資料欄](../publish/replicate-identity-columns.md)。</span><span class="sxs-lookup"><span data-stu-id="f0734-122">For more information, see [Replicate Identity Columns](../publish/replicate-identity-columns.md).</span></span>  
  
### <a name="synchronizing-the-publication-database"></a><span data-ttu-id="f0734-123">同步處理發行集資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-123">Synchronizing the Publication Database</span></span>  
 <span data-ttu-id="f0734-124">將訂閱資料庫與發行集資料庫同步處理，可讓您從一或多個訂閱資料庫中上傳之前在發行集資料庫中所作、但在還原的備份中未顯示的變更。</span><span class="sxs-lookup"><span data-stu-id="f0734-124">Synchronizing a publication database with a subscription database allows you to upload from one or more subscription databases those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="f0734-125">可以上傳的資料視發行集的篩選方式而定：</span><span class="sxs-lookup"><span data-stu-id="f0734-125">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
-   <span data-ttu-id="f0734-126">如果發行集未篩選，您可以透過與最新的「訂閱者」進行同步處理，使發行集資料庫處於最新狀態。</span><span class="sxs-lookup"><span data-stu-id="f0734-126">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
-   <span data-ttu-id="f0734-127">如果發行集已篩選，則可能無法使發行集資料庫處於最新狀態。</span><span class="sxs-lookup"><span data-stu-id="f0734-127">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="f0734-128">請思考一下一個已進行資料分割的資料表，其中資料分割方式使得每個訂閱只會收到下列單一地區的客戶資料：北區、東區、南區及西區。</span><span class="sxs-lookup"><span data-stu-id="f0734-128">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="f0734-129">如果每個資料分割至少有一個「訂閱者」，則與每個資料分割的「訂閱者」進行同步處理就可使發行集資料庫處於最新狀態。</span><span class="sxs-lookup"><span data-stu-id="f0734-129">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="f0734-130">不過，如果在「西區」資料分割中的資料未複寫到任何「訂閱者」(舉例來說)，則「發行者」端的此資料將無法處於最新狀態。</span><span class="sxs-lookup"><span data-stu-id="f0734-130">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="f0734-131">同步處理發行集資料庫與訂閱資料庫，可能會導致發行的資料表還原到的時間點比從備份處還原的其他未發行的資料表的時間點要新。</span><span class="sxs-lookup"><span data-stu-id="f0734-131">Synchronizing a publication database with a subscription database can result in published tables being restored to a point in time that is more recent than the point in time of other non-published tables restored from the backup.</span></span>  
  
 <span data-ttu-id="f0734-132">如果同步處理的「訂閱者」所執行的 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 版本早於 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]，則訂閱不可是匿名的，而必須是客訂閱或主訂閱 (在之前的版本中稱為本機訂閱與全域訂閱)。</span><span class="sxs-lookup"><span data-stu-id="f0734-132">If you synchronize with a Subscriber that is running a version of [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] prior to [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span>  
  
 <span data-ttu-id="f0734-133">若要同步處理訂閱，請參閱＜ [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) ＞和＜ [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md)＞。</span><span class="sxs-lookup"><span data-stu-id="f0734-133">To synchronize a subscription, see [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) and [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span></span>  
  
### <a name="reinitializing-all-subscriptions"></a><span data-ttu-id="f0734-134">重新初始化所有訂閱</span><span class="sxs-lookup"><span data-stu-id="f0734-134">Reinitializing all Subscriptions</span></span>  
 <span data-ttu-id="f0734-135">重新初始化所有訂閱可確保所有「訂閱者」的狀態均與還原的發行集資料庫保持一致。</span><span class="sxs-lookup"><span data-stu-id="f0734-135">Reinitializing all subscriptions ensures all Subscribers are in a state consistent with the restored publication database.</span></span> <span data-ttu-id="f0734-136">若要將整個拓撲返回到給定發行集資料庫備份表示的之前狀態，則應使用此方法。</span><span class="sxs-lookup"><span data-stu-id="f0734-136">This approach should be used if you want to return an entire topology to the previous state represented by a given publication database backup.</span></span> <span data-ttu-id="f0734-137">例如，如果您要將發行集資料庫還原到更早的時間點，即作為一種從錯誤執行的批次作業復原的機制，則您可能要重新初始化所有訂閱。</span><span class="sxs-lookup"><span data-stu-id="f0734-137">For example, you might want to reinitialize all subscriptions if you are restoring a publication database to an earlier point in time as a mechanism to recover from an erroneously performed batch operation.</span></span>  
  
 <span data-ttu-id="f0734-138">如果選擇此選項，應在復原發行集資料庫之後，立即產生新的快照集以傳遞給重新初始化的「訂閱者」。</span><span class="sxs-lookup"><span data-stu-id="f0734-138">If you choose this option, generate a new snapshot for delivery to reinitialized Subscribers immediately after restoring your publication database.</span></span>  
  
 <span data-ttu-id="f0734-139">若要重新初始化訂閱，請參閱＜ [重新初始化訂閱](../reinitialize-a-subscription.md)＞。</span><span class="sxs-lookup"><span data-stu-id="f0734-139">To reinitialize a subscription, see [Reinitialize a Subscription](../reinitialize-a-subscription.md).</span></span>  
  
 <span data-ttu-id="f0734-140">若要建立並套用快照集，請參閱＜ [建立和套用初始快照集](../create-and-apply-the-initial-snapshot.md) ＞和＜ [使用參數化篩選建立合併式發行集的快照集](../create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md)＞。</span><span class="sxs-lookup"><span data-stu-id="f0734-140">To create and apply a snapshot, see [Create and Apply the Initial Snapshot](../create-and-apply-the-initial-snapshot.md) and [Create a Snapshot for a Merge Publication with Parameterized Filters](../create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md).</span></span>  
  
## <a name="backing-up-and-restoring-the-distribution-database"></a><span data-ttu-id="f0734-141">備份與還原散發資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-141">Backing Up and Restoring the Distribution Database</span></span>  
 <span data-ttu-id="f0734-142">對於合併式複寫，散發資料庫應定期備份，並且只要使用的備份不晚於使用「散發者」之所有發行集的最短保留期限，無需任何特殊考量即可還原。</span><span class="sxs-lookup"><span data-stu-id="f0734-142">With merge replication, the distribution database should be backed up regularly, and can be restored without any special considerations as long as the backup used is no older than the shortest retention period of all publications that use the Distributor.</span></span> <span data-ttu-id="f0734-143">例如，如果有三個保留期間分別為 10、20 及 30 天的發行集，則用來還原資料庫的備份不應晚於 10 天。</span><span class="sxs-lookup"><span data-stu-id="f0734-143">For example, if there are three publications with retention periods of 10, 20, and 30 days, respectively, the backup used to restore the database should not be more than 10 days old.</span></span> <span data-ttu-id="f0734-144">散發資料庫在合併式複寫中擁有有限的角色：它不儲存變更追蹤中使用的任何資料，也不提供要轉送到訂閱資料庫之合併式複寫變更的暫時儲存 (與它在異動複寫中一樣)。</span><span class="sxs-lookup"><span data-stu-id="f0734-144">The distribution database has a limited role in merge replication: it does not store any data used in change tracking and it does not provide temporary storage of merge replication changes to be forwarded to subscription databases (as it does in transactional replication).</span></span>  
  
## <a name="backing-up-and-restoring-a-subscription-database"></a><span data-ttu-id="f0734-145">備份與還原訂閱資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-145">Backing Up and Restoring a Subscription Database</span></span>  
 <span data-ttu-id="f0734-146">為確保成功復原訂閱資料庫，在備份訂閱資料庫之前應將「訂閱者」應與「發行者」同步；它們在訂閱資料庫還原之後還應再同步一次：</span><span class="sxs-lookup"><span data-stu-id="f0734-146">To ensure successful recovery of a subscription database, Subscribers should synchronize with the Publisher before the subscription database is backed up; they should also synchronize after the subscription database is restored:</span></span>  
  
-   <span data-ttu-id="f0734-147">在訂閱資料庫備份之前與「發行者」進行同步處理，有助於確保在「訂閱者」從備份中還原時，訂閱仍處於發行集保留期限內。</span><span class="sxs-lookup"><span data-stu-id="f0734-147">Synchronizing with the Publisher before a subscription database backup helps ensure that if a Subscriber is restored from backup, the subscription is still within the publication retention period.</span></span> <span data-ttu-id="f0734-148">例如，假設發行集保留期限為 10 天。</span><span class="sxs-lookup"><span data-stu-id="f0734-148">For example, assume a publication with a retention period of 10 days.</span></span> <span data-ttu-id="f0734-149">上次同步是在 8 天前，且現在已執行備份。</span><span class="sxs-lookup"><span data-stu-id="f0734-149">The last synchronization was 8 days ago, and now the backup is performed.</span></span> <span data-ttu-id="f0734-150">如果在 4 天後還原備份，則上次同步處理發生在 12 天前，已超出保留期限。</span><span class="sxs-lookup"><span data-stu-id="f0734-150">If the backup is restored 4 days later, the last synchronization will have occurred 12 days ago, which is past the retention period.</span></span> <span data-ttu-id="f0734-151">在此情況下，您必須重新初始化「訂閱者」。</span><span class="sxs-lookup"><span data-stu-id="f0734-151">In this case, you would have to reinitialize the Subscriber.</span></span> <span data-ttu-id="f0734-152">如果「訂閱者」在備份前已同步處理，則訂閱資料庫應處於保留期限內。</span><span class="sxs-lookup"><span data-stu-id="f0734-152">If the Subscriber had synchronized before the backup, the subscription database would be within the retention period.</span></span>  
  
     <span data-ttu-id="f0734-153">備份不得晚於「訂閱者」訂閱的所有發行集中的最短保留期限。</span><span class="sxs-lookup"><span data-stu-id="f0734-153">The backup should be no older than the shortest retention period of all publications to which the Subscriber subscribes.</span></span> <span data-ttu-id="f0734-154">例如，如果「訂閱者」分別訂閱了三個保留期限為 10、20 及 30 天的發行集，則用來還原資料庫的備份不應該晚於 10 天。</span><span class="sxs-lookup"><span data-stu-id="f0734-154">For example, if a Subscriber subscribes to three publications with retention periods of 10, 20, and 30 days, respectively, the backup used to restore the database should not be more than 10 days old.</span></span>  
  
-   <span data-ttu-id="f0734-155">在還原之後將訂閱資料庫與每個發行集同步處理，可確保「訂閱者」處於最新狀態 (具有「發行者」端的所有變更)。</span><span class="sxs-lookup"><span data-stu-id="f0734-155">Synchronizing the subscription database with each of its publications following a restore ensures that the Subscriber is up to date with all changes at the Publisher.</span></span>  
  
 <span data-ttu-id="f0734-156">若要設定發行集保留期限，請參閱[設定訂閱的逾期期限](../publish/set-the-expiration-period-for-subscriptions.md)。</span><span class="sxs-lookup"><span data-stu-id="f0734-156">To set the publication retention period, see [Set the Expiration Period for Subscriptions](../publish/set-the-expiration-period-for-subscriptions.md).</span></span>  
  
 <span data-ttu-id="f0734-157">若要同步處理訂閱，請參閱＜ [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) ＞和＜ [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md)＞。</span><span class="sxs-lookup"><span data-stu-id="f0734-157">To synchronize a subscription, see [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) and [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span></span>  
  
## <a name="backing-up-and-restoring-a-republishing-database"></a><span data-ttu-id="f0734-158">備份與還原重新發行資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-158">Backing Up and Restoring a Republishing Database</span></span>  
 <span data-ttu-id="f0734-159">當資料庫從「發行者」來訂閱資料並轉而將相同的資料發行至其他訂閱資料庫時，該資料庫便是一個重新發行集資料庫。</span><span class="sxs-lookup"><span data-stu-id="f0734-159">When a database subscribes to data from a Publisher and in turn publishes that same data to other subscription databases, it is referred to as a republishing database.</span></span> <span data-ttu-id="f0734-160">還原重新發行的資料庫時，請遵循本主題中＜備份與還原發行集資料庫＞以及＜備份與還原訂閱資料庫＞兩節所描述的指導方針。</span><span class="sxs-lookup"><span data-stu-id="f0734-160">When restoring a republishing database, follow the guidelines described in "Backing Up and Restoring a Publication Database" and "Backing Up and Restoring a Subscription Database" in this topic.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="f0734-161">另請參閱</span><span class="sxs-lookup"><span data-stu-id="f0734-161">See Also</span></span>  
 <span data-ttu-id="f0734-162">[SQL Server 資料庫的備份與還原](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span><span class="sxs-lookup"><span data-stu-id="f0734-162">[Back Up and Restore of SQL Server Databases](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span></span>  
 [<span data-ttu-id="f0734-163">備份及還原複寫的資料庫</span><span class="sxs-lookup"><span data-stu-id="f0734-163">Back Up and Restore Replicated Databases</span></span>](back-up-and-restore-replicated-databases.md)  
  
  
