---
title: 使用預先計算的資料分割最佳化參數化篩選效能 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- precomputed partitions [SQL Server replication]
- merge replication precomputed partitions [SQL Server replication]
- merge replication precomputed partitions [SQL Server replication], about precomputed partitions
ms.assetid: 85654bf4-e25f-4f04-8e34-bbbd738d60fa
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 4ad0a33f0a5951256ff94bc78e7f09a88c05f227
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87708198"
---
# <a name="optimize-parameterized-filter-performance-with-precomputed-partitions"></a><span data-ttu-id="c0638-102">使用預先計算的資料分割最佳化參數化篩選效能</span><span class="sxs-lookup"><span data-stu-id="c0638-102">Optimize Parameterized Filter Performance with Precomputed Partitions</span></span>
  <span data-ttu-id="c0638-103">預先計算的資料分割是可用於篩選合併式發行集的效能最佳化。</span><span class="sxs-lookup"><span data-stu-id="c0638-103">Precomputed partitions is a performance optimization that can be used with filtered merge publications.</span></span> <span data-ttu-id="c0638-104">預先計算的資料分割也是在篩選發行集上使用邏輯記錄的需求。</span><span class="sxs-lookup"><span data-stu-id="c0638-104">Precomputed partitions is also a requirement for using logical records on filtered publications.</span></span> <span data-ttu-id="c0638-105">如需邏輯記錄的詳細資訊，請參閱[使用邏輯記錄分組相關資料列的變更](group-changes-to-related-rows-with-logical-records.md)。</span><span class="sxs-lookup"><span data-stu-id="c0638-105">For more information about logical records, see [Group Changes to Related Rows with Logical Records](group-changes-to-related-rows-with-logical-records.md).</span></span>  
  
 <span data-ttu-id="c0638-106">當「訂閱者」與「發行者」同步時，「發行者」必須評估「訂閱者」的篩選以決定哪些資料列屬於該「訂閱者」的資料分割或資料集。</span><span class="sxs-lookup"><span data-stu-id="c0638-106">When a Subscriber synchronizes with a Publisher, the Publisher must evaluate the Subscriber's filters to determine which rows belong to that Subscriber's partition, or data set.</span></span> <span data-ttu-id="c0638-107">在發行者端針對每一個接收到已篩選資料集來判斷變更的資料分割成員資格之處理，稱為 *資料分割評估*。</span><span class="sxs-lookup"><span data-stu-id="c0638-107">This process of determining partition membership of changes at the Publisher for each Subscriber receiving a filtered dataset is referred to as *partition evaluation*.</span></span> <span data-ttu-id="c0638-108">若沒有預先計算的資料分割，則自從上次為特定的「訂閱者」執行「合併代理程式」之後，必須對「發行者」端的篩選資料行所作之變更執行資料分割評估，而且每個與「發行者」同步的「訂閱者」都必須重複這個過程。</span><span class="sxs-lookup"><span data-stu-id="c0638-108">Without precomputed partitions, partition evaluation must be performed for each change made to a filtered column at the Publisher since the last time the Merge Agent ran for a specific Subscriber, and this process has to be repeated for every Subscriber that synchronizes with the Publisher.</span></span>  
  
 <span data-ttu-id="c0638-109">不過，如果「發行者」和「訂閱者」在 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 或更新版本上執行，而且您使用預先計算的資料分割，則在進行變更時，會預先計算並保存「發行者」端所有變更的資料分割成員資格。</span><span class="sxs-lookup"><span data-stu-id="c0638-109">However, if the Publisher and Subscriber are running on [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version and you use precomputed partitions, partition membership for all changes at the Publisher is precomputed and persisted at the time that the changes are made.</span></span> <span data-ttu-id="c0638-110">如此一來，訂閱者與發行者同步處理時，它可以立即啟動來下載與其資料分割相關的變更，不必再經過資料分割評估處理。</span><span class="sxs-lookup"><span data-stu-id="c0638-110">As a result, when a Subscriber synchronizes with the Publisher, it can immediately start to download changes relevant to its partition without having to go through the partition evaluation process.</span></span> <span data-ttu-id="c0638-111">當發行集內有大量的變更、訂閱者或發行項時，如此就可以大幅提高效能。</span><span class="sxs-lookup"><span data-stu-id="c0638-111">This can lead to significant performance gains when a publication has a large number of changes, Subscribers, or articles in the publication.</span></span>  
  
 <span data-ttu-id="c0638-112">除了使用預先計算的資料分割之外，請預先產生快照集並/或允許「訂閱者」在第一次進行同步處理時要求產生並套用快照集。</span><span class="sxs-lookup"><span data-stu-id="c0638-112">In addition to using precomputed partitions, pre-generate snapshots and/or allow Subscribers to request snapshot generation and application the first time they synchronize.</span></span> <span data-ttu-id="c0638-113">使用上述一或兩個選項為使用參數化篩選的發行集提供快照集。</span><span class="sxs-lookup"><span data-stu-id="c0638-113">Use one or both of these options to provide snapshots for publications that use parameterized filters.</span></span> <span data-ttu-id="c0638-114">如果不指定任何選項，訂閱會使用一系列 SELECT 與 INSERT 陳述式進行初始化，而非使用 **bcp** 公用程式；此處理要慢很多。</span><span class="sxs-lookup"><span data-stu-id="c0638-114">If you do not specify one of these options, subscriptions are initialized using a series of SELECT and INSERT statements, rather than using the **bcp** utility; this process is much slower.</span></span> <span data-ttu-id="c0638-115">如需詳細資訊，請參閱 [Snapshots for Merge Publications with Parameterized Filters](../snapshots-for-merge-publications-with-parameterized-filters.md)。</span><span class="sxs-lookup"><span data-stu-id="c0638-115">For more information, see [Snapshots for Merge Publications with Parameterized Filters](../snapshots-for-merge-publications-with-parameterized-filters.md).</span></span>  
  
 <span data-ttu-id="c0638-116">**使用預先計算的資料分割**</span><span class="sxs-lookup"><span data-stu-id="c0638-116">**To use precomputed partitions**</span></span>  
  
 <span data-ttu-id="c0638-117">依預設，在所有遵守上述指導方針之新的及現有的發行集上，都會啟用預先計算的資料分割。</span><span class="sxs-lookup"><span data-stu-id="c0638-117">Precomputed partitions are enabled by default on all new and existing publications that adhere to the guidelines described above.</span></span> <span data-ttu-id="c0638-118">此設定可透過 [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] 或以程式設計的方式來變更。</span><span class="sxs-lookup"><span data-stu-id="c0638-118">The setting can be changed through [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] or programmatically.</span></span> <span data-ttu-id="c0638-119">如需詳細資訊，請參閱＜ [Optimize Parameterized Row Filters](../publish/optimize-parameterized-row-filters.md)＞。</span><span class="sxs-lookup"><span data-stu-id="c0638-119">For more information, see [Optimize Parameterized Row Filters](../publish/optimize-parameterized-row-filters.md).</span></span>  
  
## <a name="requirements-for-using-precomputed-partitions"></a><span data-ttu-id="c0638-120">使用預先計算的資料分割之需求</span><span class="sxs-lookup"><span data-stu-id="c0638-120">Requirements for Using Precomputed Partitions</span></span>  
 <span data-ttu-id="c0638-121">如果滿足下列需求，依預設，會使用啟用的預先計算之資料分割來建立新的合併式發行集，並且會自動升級現有發行集以使用此功能。</span><span class="sxs-lookup"><span data-stu-id="c0638-121">If the following requirements are met, new merge publications are, by default, created with precomputed partitions enabled, and existing publications are automatically upgraded to use the feature.</span></span> <span data-ttu-id="c0638-122">如果發行集不滿足這些需求，則可以對其進行變更，然後便可啟用預先計算的資料分割。</span><span class="sxs-lookup"><span data-stu-id="c0638-122">If a publication does not meet the requirements, it can be changed, and then precomputed partitions can be enabled.</span></span> <span data-ttu-id="c0638-123">如果只有其中一部份發行項滿足這些需求，則考慮建立兩個發行集，其中一個啟用預先計算的資料分割。</span><span class="sxs-lookup"><span data-stu-id="c0638-123">If some articles meet these requirements and some do not, consider creating two publications, with one enabled for precomputed partitions.</span></span>  
  
### <a name="requirements-for-filter-clauses"></a><span data-ttu-id="c0638-124">篩選子句的需求</span><span class="sxs-lookup"><span data-stu-id="c0638-124">Requirements for Filter Clauses</span></span>  
  
-   <span data-ttu-id="c0638-125">任何用於參數化資料列篩選器的函數，例如 HOST_NAME() 和 SUSER_SNAME()，應直接出現在參數化篩選子句中，不可巢狀包含在檢視或動態函數中。</span><span class="sxs-lookup"><span data-stu-id="c0638-125">Any functions used in parameterized row filters, such as HOST_NAME() and SUSER_SNAME(), should appear directly in the parameterized filter clause and not be nested inside of a view or dynamic function.</span></span> <span data-ttu-id="c0638-126">如需這些函式的詳細資訊，請參閱 [HOST_NAME &#40;Transact-SQL&#41;](/sql/t-sql/functions/host-name-transact-sql)、[SUSER_SNAME &#40;Transact-SQL&#41;](/sql/t-sql/functions/suser-sname-transact-sql) 和[參數化資料列篩選](parameterized-filters-parameterized-row-filters.md)。</span><span class="sxs-lookup"><span data-stu-id="c0638-126">For more information about these functions, see [HOST_NAME &#40;Transact-SQL&#41;](/sql/t-sql/functions/host-name-transact-sql), [SUSER_SNAME &#40;Transact-SQL&#41;](/sql/t-sql/functions/suser-sname-transact-sql), and [Parameterized Row Filters](parameterized-filters-parameterized-row-filters.md).</span></span>  
  
-   <span data-ttu-id="c0638-127">在建立資料分割後不應變更每個「訂閱者」傳回的值。</span><span class="sxs-lookup"><span data-stu-id="c0638-127">The values returned for each Subscriber should not change after the partition is created.</span></span> <span data-ttu-id="c0638-128">例如，如果您在篩選中使用 HOST_NAME() (沒有覆寫 HOST_NAME() 值)，則不要變更「訂閱者」端的電腦名稱。</span><span class="sxs-lookup"><span data-stu-id="c0638-128">For example, if you use HOST_NAME() in a filter (and do not override the HOST_NAME() value) do not change the computer name at the Subscriber.</span></span>  
  
-   <span data-ttu-id="c0638-129">聯結篩選不應包含動態函數 (例如依據正進行同步處理的「訂閱者」，評估為不同值的 HOST_NAME() 與 SUSER_SNAME() 函數)。</span><span class="sxs-lookup"><span data-stu-id="c0638-129">Join filters should not contain dynamic functions (functions such as HOST_NAME() and SUSER_SNAME() that evaluate to a different value depending upon the Subscriber that is synchronizing).</span></span> <span data-ttu-id="c0638-130">僅參數化資料列篩選器應包含動態函數。</span><span class="sxs-lookup"><span data-stu-id="c0638-130">Only parameterized row filters should contain dynamic functions.</span></span>  
  
-   <span data-ttu-id="c0638-131">非決定性函數不能用於篩選子句。</span><span class="sxs-lookup"><span data-stu-id="c0638-131">Nondeterministic functions cannot be used in a filter clause.</span></span> <span data-ttu-id="c0638-132">如需有關不具決定性函數的詳細資訊，請參閱＜ [Deterministic and Nondeterministic Functions](../../user-defined-functions/deterministic-and-nondeterministic-functions.md)＞。</span><span class="sxs-lookup"><span data-stu-id="c0638-132">For more information about nondeterministic functions, see [Deterministic and Nondeterministic Functions](../../user-defined-functions/deterministic-and-nondeterministic-functions.md).</span></span>  
  
-   <span data-ttu-id="c0638-133">聯結篩選子句或參數化篩選子句中所參考的檢視不應包含動態函數。</span><span class="sxs-lookup"><span data-stu-id="c0638-133">Views referenced in join filter clauses or parameterized filter clauses should not contain dynamic functions.</span></span>  
  
-   <span data-ttu-id="c0638-134">發行集中不應有循環聯結篩選關聯性。</span><span class="sxs-lookup"><span data-stu-id="c0638-134">There should be no circular join filter relationships in the publication.</span></span>  
  
### <a name="database-collation"></a><span data-ttu-id="c0638-135">資料庫定序</span><span class="sxs-lookup"><span data-stu-id="c0638-135">Database Collation</span></span>  
  
-   <span data-ttu-id="c0638-136">如果使用預先計算的資料分割，則在進行比較時總是使用資料庫的定序，而不是資料表或資料行的定序。</span><span class="sxs-lookup"><span data-stu-id="c0638-136">When precomputed partitions are used, the collation of the database is always used when making comparisons, rather than the collation of the table or column.</span></span> <span data-ttu-id="c0638-137">請考慮下列案例：</span><span class="sxs-lookup"><span data-stu-id="c0638-137">Consider the following scenario:</span></span>  
  
    -   <span data-ttu-id="c0638-138">區分大小寫定序的資料庫包含不區分大小寫定序的資料表。</span><span class="sxs-lookup"><span data-stu-id="c0638-138">A database with a case-sensitive collation contains a table with a case-insensitive collation.</span></span>  
  
    -   <span data-ttu-id="c0638-139">資料表包含 **ComputerName**資料列，用來與參數化篩選中「訂閱者」的主機名稱作比較。</span><span class="sxs-lookup"><span data-stu-id="c0638-139">The table contains a column **ComputerName**, which is compared against the host name of the Subscriber in a parameterized filter.</span></span>  
  
    -   <span data-ttu-id="c0638-140">資料表在此資料行中包含一個值為 MYCOMPUTER 的資料列，及一個值為 mycomputer 的資料列。</span><span class="sxs-lookup"><span data-stu-id="c0638-140">The table contains one row with the value "MYCOMPUTER" and one row with the value "mycomputer" in this column.</span></span>  
  
     <span data-ttu-id="c0638-141">如果「訂閱者」用主機名稱 mycomputer 來進行同步處理，則「訂閱者」僅會接收一個資料列，因為比較會區分大小寫 (資料庫的定序)。</span><span class="sxs-lookup"><span data-stu-id="c0638-141">If the Subscriber synchronizes with a host name of "mycomputer", the Subscriber receives only one row because the comparison is case-sensitive (the collation of the database).</span></span> <span data-ttu-id="c0638-142">如果未使用預先計算的資料分割，則「訂閱者」會接收兩個資料列，因為資料表具有不區分大小寫的定序。</span><span class="sxs-lookup"><span data-stu-id="c0638-142">If precomputed partitions are not used, the Subscriber receives both rows, because the table has a case-insensitive collation.</span></span>  
  
## <a name="performance-of-precomputed-partitions"></a><span data-ttu-id="c0638-143">預先計算的資料分割之效能</span><span class="sxs-lookup"><span data-stu-id="c0638-143">Performance of Precomputed Partitions</span></span>  
 <span data-ttu-id="c0638-144">當變更從「訂閱者」上傳到「發行者」時，預先計算的資料分割會有小的效能消耗，但是在評估資料分割及將變更從「發行者」下載到「訂閱者」會花費大量合併處理時間，因此網路優勢仍十分重要。</span><span class="sxs-lookup"><span data-stu-id="c0638-144">There is a small performance cost with precomputed partitions when changes are uploaded from the Subscriber to the Publisher, but the bulk of merge processing time is spent evaluating partitions and downloading changes from the Publisher to the Subscriber, so the net gain can still be significant.</span></span> <span data-ttu-id="c0638-145">效能利益視同時進行同步處理的「訂閱者」數量，與每個將資料列從一個資料分割移到其他資料分割的同步處理之更新數量的不同而有所不同。</span><span class="sxs-lookup"><span data-stu-id="c0638-145">The performance benefit will vary, depending on the number of Subscribers synchronizing concurrently and the number of updates per synchronization that move rows from one partition to another.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c0638-146">另請參閱</span><span class="sxs-lookup"><span data-stu-id="c0638-146">See Also</span></span>  
 [<span data-ttu-id="c0638-147">參數化資料列篩選器</span><span class="sxs-lookup"><span data-stu-id="c0638-147">Parameterized Row Filters</span></span>](parameterized-filters-parameterized-row-filters.md)  
  
  
