---
title: 以程式設計方式變更密碼 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- data access [SQL Server Native Client], password expiration
- SQL Server Native Client ODBC driver, passwords
- SQL Server Native Client OLE DB provider, passwords
- passwords [SQL Server], expiration
- SQLNCLI, password expiration
- expiration [SQL Server Native Client]
- passwords [SQL Server], modifying
- expired passwords [SQL Server Native Client]
- SQL Server Native Client, password expiration
- modifying passwords
ms.assetid: 624ad949-5fed-4ce5-b319-878549f9487b
author: rothja
ms.author: jroth
ms.openlocfilehash: 86085f8ba7c54cfcab1a3c7f6e8ade30ecf9d0da
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87698104"
---
# <a name="changing-passwords-programmatically"></a><span data-ttu-id="c674b-102">以程式設計方式變更密碼</span><span class="sxs-lookup"><span data-stu-id="c674b-102">Changing Passwords Programmatically</span></span>
  <span data-ttu-id="c674b-103">在 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 之前，當使用者密碼到期時，只有系統管理員可以重設密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-103">Before [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], when a user's password expired, only an administrator could reset it.</span></span> <span data-ttu-id="c674b-104">從開始 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] ， [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] native client 支援透過 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] native client OLE DB 提供者和 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] native client ODBC 驅動程式，以及透過變更**SQL Server 登**入對話方塊，以程式設計方式處理密碼到期。</span><span class="sxs-lookup"><span data-stu-id="c674b-104">Beginning with [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client supports handling password expiration programmatically through both the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider and the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver, and through changes to the **SQL Server Login** dialog boxes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c674b-105">如果可能的話，請在執行階段提示使用者輸入其認證，並避免以保存的格式儲存其認證。</span><span class="sxs-lookup"><span data-stu-id="c674b-105">When possible, prompt users to enter their credentials at run time and avoid storing their credentials in a persisted format.</span></span> <span data-ttu-id="c674b-106">如果您必須保存其認證，則應該用 [Win32 crypto API](https://go.microsoft.com/fwlink/?LinkId=64532) 加密這些認證。</span><span class="sxs-lookup"><span data-stu-id="c674b-106">If you must persist their credentials, you should encrypt them using the [Win32 crypto API](https://go.microsoft.com/fwlink/?LinkId=64532).</span></span> <span data-ttu-id="c674b-107">如需使用密碼的詳細資訊，請參閱[強式密碼](../../security/strong-passwords.md)。</span><span class="sxs-lookup"><span data-stu-id="c674b-107">For more information about the use of passwords, see [Strong Passwords](../../security/strong-passwords.md).</span></span>  
  
## <a name="sql-server-login-error-codes"></a><span data-ttu-id="c674b-108">SQL Server 登入錯誤碼</span><span class="sxs-lookup"><span data-stu-id="c674b-108">SQL Server Login Error Codes</span></span>  
 <span data-ttu-id="c674b-109">當連接因為驗證問題而無法建立時，將會提供下列其中一個 SQL Server 錯誤碼給應用程式來協助診斷和復原。</span><span class="sxs-lookup"><span data-stu-id="c674b-109">When a connection cannot be made because of authentication problems, one of the following SQL Server error codes will be available to the application to assist diagnosis and recovery.</span></span>  
  
|<span data-ttu-id="c674b-110">SQL Server 錯誤碼</span><span class="sxs-lookup"><span data-stu-id="c674b-110">SQL Server Error Code</span></span>|<span data-ttu-id="c674b-111">錯誤訊息</span><span class="sxs-lookup"><span data-stu-id="c674b-111">Error Message</span></span>|  
|---------------------------|-------------------|  
|<span data-ttu-id="c674b-112">15113</span><span class="sxs-lookup"><span data-stu-id="c674b-112">15113</span></span>|<span data-ttu-id="c674b-113">使用者 '%.\*ls' 登入失敗。原因: 密碼驗證失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-113">Login failed for user '%.\*ls' Reason: Password validation failed.</span></span> <span data-ttu-id="c674b-114">帳戶已經鎖定。</span><span class="sxs-lookup"><span data-stu-id="c674b-114">The account is locked out.</span></span>|  
|<span data-ttu-id="c674b-115">18463</span><span class="sxs-lookup"><span data-stu-id="c674b-115">18463</span></span>|<span data-ttu-id="c674b-116">使用者 '%.\*ls' 的登入失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-116">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="c674b-117">原因: 密碼變更失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-117">Reason: Password change failed.</span></span> <span data-ttu-id="c674b-118">密碼此時不適用。</span><span class="sxs-lookup"><span data-stu-id="c674b-118">The password cannot be used at this time.</span></span>|  
|<span data-ttu-id="c674b-119">18464</span><span class="sxs-lookup"><span data-stu-id="c674b-119">18464</span></span>|<span data-ttu-id="c674b-120">使用者 '%.\*ls' 的登入失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-120">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="c674b-121">原因: 密碼變更失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-121">Reason: Password change failed.</span></span> <span data-ttu-id="c674b-122">因為密碼太短而不符合原則需求。</span><span class="sxs-lookup"><span data-stu-id="c674b-122">The password does not meet policy requirements because it is too short.</span></span>|  
|<span data-ttu-id="c674b-123">18465</span><span class="sxs-lookup"><span data-stu-id="c674b-123">18465</span></span>|<span data-ttu-id="c674b-124">使用者 '%.\*ls' 的登入失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-124">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="c674b-125">原因: 密碼變更失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-125">Reason: Password change failed.</span></span> <span data-ttu-id="c674b-126">因為密碼太長而不符合原則需求。</span><span class="sxs-lookup"><span data-stu-id="c674b-126">The password does not meet policy requirements because it is too long.</span></span>|  
|<span data-ttu-id="c674b-127">18466</span><span class="sxs-lookup"><span data-stu-id="c674b-127">18466</span></span>|<span data-ttu-id="c674b-128">使用者 '%.\*ls' 的登入失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-128">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="c674b-129">原因: 密碼變更失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-129">Reason: Password change failed.</span></span> <span data-ttu-id="c674b-130">因為密碼不夠複雜而不符合原則需求。</span><span class="sxs-lookup"><span data-stu-id="c674b-130">The password does not meet policy requirements because it is not complex enough.</span></span>|  
|<span data-ttu-id="c674b-131">18467</span><span class="sxs-lookup"><span data-stu-id="c674b-131">18467</span></span>|<span data-ttu-id="c674b-132">使用者 '%.\*ls' 的登入失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-132">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="c674b-133">原因: 密碼變更失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-133">Reason: Password change failed.</span></span> <span data-ttu-id="c674b-134">密碼不符合密碼篩選 DLL 的需求。</span><span class="sxs-lookup"><span data-stu-id="c674b-134">The password does not meet the requirements of the password filter DLL.</span></span>|  
|<span data-ttu-id="c674b-135">18468</span><span class="sxs-lookup"><span data-stu-id="c674b-135">18468</span></span>|<span data-ttu-id="c674b-136">使用者 '%.\*ls' 的登入失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-136">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="c674b-137">原因: 密碼變更失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-137">Reason: Password change failed.</span></span> <span data-ttu-id="c674b-138">密碼驗證期間發生意外的錯誤。</span><span class="sxs-lookup"><span data-stu-id="c674b-138">An unexpected error occurred during password validation.</span></span>|  
|<span data-ttu-id="c674b-139">18487</span><span class="sxs-lookup"><span data-stu-id="c674b-139">18487</span></span>|<span data-ttu-id="c674b-140">使用者 '%.\*ls' 的登入失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-140">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="c674b-141">原因: 帳戶的密碼已過期。</span><span class="sxs-lookup"><span data-stu-id="c674b-141">Reason: The password of the account has expired.</span></span>|  
|<span data-ttu-id="c674b-142">18488</span><span class="sxs-lookup"><span data-stu-id="c674b-142">18488</span></span>|<span data-ttu-id="c674b-143">使用者 '%.\*ls' 的登入失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-143">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="c674b-144">原因: 必須變更帳戶的密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-144">Reason: The password of the account must be changed.</span></span>|  
  
## <a name="sql-server-native-client-ole-db-provider"></a><span data-ttu-id="c674b-145">SQL Server Native Client OLE DB 提供者</span><span class="sxs-lookup"><span data-stu-id="c674b-145">SQL Server Native Client OLE DB Provider</span></span>  
 <span data-ttu-id="c674b-146">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供者透過使用者介面和以程式設計方式支援密碼到期。</span><span class="sxs-lookup"><span data-stu-id="c674b-146">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports password expiration though a user interface and programmatically.</span></span>  
  
### <a name="ole-db-user-interface-password-expiration"></a><span data-ttu-id="c674b-147">OLE DB 使用者介面密碼逾期</span><span class="sxs-lookup"><span data-stu-id="c674b-147">OLE DB User Interface Password Expiration</span></span>  
 <span data-ttu-id="c674b-148">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供者透過對**SQL Server 登**入對話方塊所做的變更，支援密碼到期。</span><span class="sxs-lookup"><span data-stu-id="c674b-148">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports password expiration through changes made to the **SQL Server Login** dialog boxes.</span></span> <span data-ttu-id="c674b-149">如果 DBPROP_INIT_PROMPT 的值設定為 DBPROMPT_NOPROMPT，則密碼到期時，初始連接嘗試將會失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-149">If the value of DBPROP_INIT_PROMPT is set to DBPROMPT_NOPROMPT, the initial connection attempt will fail if the password has expired.</span></span>  
  
 <span data-ttu-id="c674b-150">如果 DBPROP_INIT_PROMPT 已設定為其他任何值，不管密碼是否到期，使用者都會看到 [SQL Server 登入]\*\*\*\* 對話方塊。</span><span class="sxs-lookup"><span data-stu-id="c674b-150">If DBPROP_INIT_PROMPT has been set to any other value, the user sees the **SQL Server Login** dialog, regardless of whether or not the password has expired.</span></span> <span data-ttu-id="c674b-151">使用者可以按一下 [選項]\*\*\*\* 按鈕，然後核取 [變更密碼]\*\*\*\* 來變更密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-151">The user can click on the **Options** button and check **Change Password** to change the password.</span></span>  
  
 <span data-ttu-id="c674b-152">如果使用者按一下 [確定]，而且密碼已到期，[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 就會使用 [變更 SQL Server 密碼]\*\*\*\* 對話方塊提示使用者輸入並確認新密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-152">If the user clicks OK and the password has expired, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] prompts the user to enter and confirm a new password using the **Change SQL Server Password** dialog.</span></span>  
  
#### <a name="ole-db-prompt-behavior-and-locked-accounts"></a><span data-ttu-id="c674b-153">OLE DB 提示行為與鎖定帳戶</span><span class="sxs-lookup"><span data-stu-id="c674b-153">OLE DB Prompt Behavior and Locked Accounts</span></span>  
 <span data-ttu-id="c674b-154">連接嘗試可能會因為帳戶遭到鎖定而失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-154">Connection attempts may fail due to the account being locked.</span></span> <span data-ttu-id="c674b-155">如果在顯示 [SQL Server 登入]\*\*\*\* 對話方塊後發生這個狀況，就會向使用者顯示伺服器錯誤訊息，並中止連接嘗試。</span><span class="sxs-lookup"><span data-stu-id="c674b-155">If this occurs following the display of the **SQL Server Login** dialog, the server error message is displayed to the user and the connection attempt is aborted.</span></span> <span data-ttu-id="c674b-156">如果使用者輸入錯誤的舊密碼值，也可能在顯示 [變更 SQL Server 密碼]\*\*\*\* 對話方塊後發生這個狀況。</span><span class="sxs-lookup"><span data-stu-id="c674b-156">It may also occur following the display of the **Change SQL Server Password** dialog if the user enters a bad value for the old password.</span></span> <span data-ttu-id="c674b-157">在此情況下，會顯示相同的錯誤訊息，並中止連接嘗試。</span><span class="sxs-lookup"><span data-stu-id="c674b-157">In this case the same error message is displayed, and the connection attempt is aborted.</span></span>  
  
#### <a name="ole-db-connection-pooling-password-expiration-and-locked-accounts"></a><span data-ttu-id="c674b-158">OLE DB 連接共用、密碼逾期與鎖定帳戶</span><span class="sxs-lookup"><span data-stu-id="c674b-158">OLE DB Connection Pooling, Password Expiration, and Locked Accounts</span></span>  
 <span data-ttu-id="c674b-159">當連接在連接共用中仍處於作用中狀態時，帳戶可能會遭到鎖定，或者其密碼可能會過期。</span><span class="sxs-lookup"><span data-stu-id="c674b-159">An account may be locked or its password may expire while the connection is still active in a connection pool.</span></span> <span data-ttu-id="c674b-160">伺服器會在兩種時機下檢查過期的密碼與鎖定的帳戶。</span><span class="sxs-lookup"><span data-stu-id="c674b-160">The server checks for expired passwords and locked accounts on two occasions.</span></span> <span data-ttu-id="c674b-161">第一個時機是首次建立連接時。</span><span class="sxs-lookup"><span data-stu-id="c674b-161">The first is when a connection is first created.</span></span> <span data-ttu-id="c674b-162">第二個時機則是在連接取自集區而重設連接時。</span><span class="sxs-lookup"><span data-stu-id="c674b-162">The second occasion is upon connection reset, when the connection is taken from the pool.</span></span>  
  
 <span data-ttu-id="c674b-163">當重設嘗試失敗後，連接便會從集區移除並傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="c674b-163">When the reset attempt fails, the connection is removed from the pool and an error is returned.</span></span>  
  
### <a name="ole-db-programmatic-password-expiration"></a><span data-ttu-id="c674b-164">OLE DB 程式設計密碼逾期</span><span class="sxs-lookup"><span data-stu-id="c674b-164">OLE DB Programmatic Password Expiration</span></span>  
 <span data-ttu-id="c674b-165">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供者透過新增 SSPROP_AUTH_OLD_PASSWORD (類型 VT_BSTR) 屬性（已加入 DBPROPSET_SQLSERVERDBINIT 屬性集）來支援密碼到期。</span><span class="sxs-lookup"><span data-stu-id="c674b-165">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports password expiration through the addition of the SSPROP_AUTH_OLD_PASSWORD (type VT_BSTR) property that has been added to the DBPROPSET_SQLSERVERDBINIT property set.</span></span>  
  
 <span data-ttu-id="c674b-166">現有的 "Password" 屬性會參考 DBPROP_AUTH_PASSWORD，並用於儲存新的密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-166">The existing "Password" property refers to DBPROP_AUTH_PASSWORD and is used to store the new password.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c674b-167">在此連接字串中，"Old Password" 屬性會設定 SSPROP_AUTH_OLD_PASSWORD，這是無法透過提供者字串屬性取得的目前密碼 (可能已過期)。</span><span class="sxs-lookup"><span data-stu-id="c674b-167">In the connection string, the "Old Password" property sets SSPROP_AUTH_OLD_PASSWORD, which is the current (possibly expired) password that is not available via a provider string property.</span></span>  
  
 <span data-ttu-id="c674b-168">提供者不會保存此屬性的值。</span><span class="sxs-lookup"><span data-stu-id="c674b-168">The provider does not persist the value of this property.</span></span> <span data-ttu-id="c674b-169">設定此屬性時，提供者不會將連接共用用於第一個連接，因為將會產生新的連接。</span><span class="sxs-lookup"><span data-stu-id="c674b-169">When this property is set, the provider does not use the connection pool for the first connection because a new connection will occur.</span></span> <span data-ttu-id="c674b-170">如果密碼變更成功，則無法重複使用目前的連接，因為該連接仍然包含舊密碼，而這個密碼將在密碼變更後變成無效。</span><span class="sxs-lookup"><span data-stu-id="c674b-170">If the password change is successful, the current connection cannot be reused since it still contains the old password, which will be invalid after the password change.</span></span> <span data-ttu-id="c674b-171">同時，如果登入成功，提供者會清除這個屬性。</span><span class="sxs-lookup"><span data-stu-id="c674b-171">Also, if the login succeeds, the provider clears this property.</span></span> <span data-ttu-id="c674b-172">後續嘗試擷取舊密碼時，便會傳回 VT_EMPTY。</span><span class="sxs-lookup"><span data-stu-id="c674b-172">Subsequent attempts to retrieve the old password return VT_EMPTY.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c674b-173">系統絕不會保存 SSPROP_AUTH_OLD_PASSWORD，因為只有在密碼到期時才會使用它。</span><span class="sxs-lookup"><span data-stu-id="c674b-173">SSPROP_AUTH_OLD_PASSWORD should never be persisted since it is only used when a password has expired.</span></span>  
  
 <span data-ttu-id="c674b-174">請注意，每當設定 "Old Password" 屬性時，除非同時指定優先順序永遠最高的 Windows 驗證，否則提供者會假設有嘗試變更密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-174">Note that whenever the "Old Password" property is set, the provider assumes that an attempt to change the password is being made, unless Windows Authentication is also specified, in which case it always takes precedence.</span></span>  
  
 <span data-ttu-id="c674b-175">如果使用 Windows 驗證，指定舊密碼會導致 DB_E_ERRORSOCCURRED 或 DB_S_ERRORSOCCURRED，這取決於舊密碼是否分別指定為 REQUIRED 或 OPTIONAL，以及 *dwStatus* 中是否傳回 DBPROPSTATUS_CONFLICTINGBADVALUE 的狀態值而定。</span><span class="sxs-lookup"><span data-stu-id="c674b-175">If Windows Authentication is used, specifying the old password results in either DB_E_ERRORSOCCURRED or DB_S_ERRORSOCCURRED depending on whether the old password was specified as REQUIRED or OPTIONAL respectively, and the status value of DBPROPSTATUS_CONFLICTINGBADVALUE is returned in *dwStatus*.</span></span> <span data-ttu-id="c674b-176">在呼叫 **IDBInitialize::Initialize** 時，會偵測到這個狀況。</span><span class="sxs-lookup"><span data-stu-id="c674b-176">This is detected when **IDBInitialize::Initialize** is called.</span></span>  
  
 <span data-ttu-id="c674b-177">如果嘗試變更密碼時意外失敗，伺服器會傳回錯誤碼 18468。</span><span class="sxs-lookup"><span data-stu-id="c674b-177">If an attempt to change the password fails unexpectedly, the server returns error code 18468.</span></span> <span data-ttu-id="c674b-178">標準 OLEDB 錯誤會從連線嘗試傳回。</span><span class="sxs-lookup"><span data-stu-id="c674b-178">A standard OLEDB error is returned from the connection attempt.</span></span>  
  
 <span data-ttu-id="c674b-179">如需 DBPROPSET_SQLSERVERDBINIT 屬性集的詳細資訊，請參閱[初始化和授權屬性](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md)。</span><span class="sxs-lookup"><span data-stu-id="c674b-179">For more information about the DBPROPSET_SQLSERVERDBINIT property set, see [Initialization and Authorization Properties](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md).</span></span>  
  
## <a name="sql-server-native-client-odbc-driver"></a><span data-ttu-id="c674b-180">SQL Server Native Client ODBC 驅動程式</span><span class="sxs-lookup"><span data-stu-id="c674b-180">SQL Server Native Client ODBC Driver</span></span>  
 <span data-ttu-id="c674b-181">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供者透過使用者介面和以程式設計方式支援密碼到期。</span><span class="sxs-lookup"><span data-stu-id="c674b-181">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports password expiration though a user interface and programmatically.</span></span>  
  
### <a name="odbc-user-interface-password-expiration"></a><span data-ttu-id="c674b-182">ODBC 使用者介面密碼逾期</span><span class="sxs-lookup"><span data-stu-id="c674b-182">ODBC User Interface Password Expiration</span></span>  
 <span data-ttu-id="c674b-183">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC 驅動程式可透過對**SQL Server 登**入對話方塊所做的變更，來支援密碼到期。</span><span class="sxs-lookup"><span data-stu-id="c674b-183">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver supports password expiration through changes made to the **SQL Server Login** dialog boxes.</span></span>  
  
 <span data-ttu-id="c674b-184">如果呼叫[SQLDriverConnect](../../native-client-odbc-api/sqldriverconnect.md) ，且**DriverCompletion**的值設定為 SQL_DRIVER_NOPROMPT，則如果密碼已過期，則初始連接嘗試會失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-184">If [SQLDriverConnect](../../native-client-odbc-api/sqldriverconnect.md) is called and the value of **DriverCompletion** is set to SQL_DRIVER_NOPROMPT, the initial connection attempt fails if the password has expired.</span></span> <span data-ttu-id="c674b-185">後續呼叫**SQLError**或**SQLGetDiagRec**時，會傳回 SQLSTATE 值28000和原生錯誤碼值18487。</span><span class="sxs-lookup"><span data-stu-id="c674b-185">The SQLSTATE value 28000 and the native error code value 18487 are returned by subsequent calls to **SQLError** or **SQLGetDiagRec**.</span></span>  
  
 <span data-ttu-id="c674b-186">如果**DriverCompletion**已設定為任何其他值，不論密碼是否已過期，使用者都會看到 [ **SQL Server 登**入] 對話方塊。</span><span class="sxs-lookup"><span data-stu-id="c674b-186">If **DriverCompletion** has been set to any other value, the user sees the **SQL Server Login** dialog, regardless of whether or not the password has expired.</span></span> <span data-ttu-id="c674b-187">使用者可以按一下 [選項]\*\*\*\* 按鈕，然後核取 [變更密碼]\*\*\*\* 來變更密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-187">The user can click on the **Options** button and check **Change Password** to change the password.</span></span>  
  
 <span data-ttu-id="c674b-188">如果使用者按一下 [確定]，而且密碼已過期，則 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 會使用 [**變更 SQL Server 密碼**] 對話方塊提示輸入並確認新密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-188">If the user clicks OK and the password has expired, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] prompts to enter and confirm a new password using the **Change SQL Server Password** dialog.</span></span>  
  
#### <a name="odbc-prompt-behavior-and-locked-accounts"></a><span data-ttu-id="c674b-189">ODBC 提示行為與鎖定帳戶</span><span class="sxs-lookup"><span data-stu-id="c674b-189">ODBC Prompt Behavior and Locked Accounts</span></span>  
 <span data-ttu-id="c674b-190">連接嘗試可能會因為帳戶遭到鎖定而失敗。</span><span class="sxs-lookup"><span data-stu-id="c674b-190">Connection attempts may fail due to the account being locked.</span></span> <span data-ttu-id="c674b-191">如果在顯示 [SQL Server 登入]\*\*\*\* 對話方塊後發生這個狀況，就會向使用者顯示伺服器錯誤訊息，並中止連接嘗試。</span><span class="sxs-lookup"><span data-stu-id="c674b-191">If this occurs following the display of the **SQL Server Login** dialog, the server error message is displayed to the user and the connection attempt is aborted.</span></span> <span data-ttu-id="c674b-192">如果使用者輸入錯誤的舊密碼值，也可能在顯示 [變更 SQL Server 密碼]\*\*\*\* 對話方塊後發生這個狀況。</span><span class="sxs-lookup"><span data-stu-id="c674b-192">It may also occur following the display of the **Change SQL Server Password** dialog if the user enters a bad value for the old password.</span></span> <span data-ttu-id="c674b-193">在此情況下，會顯示相同的錯誤訊息，並中止連接嘗試。</span><span class="sxs-lookup"><span data-stu-id="c674b-193">In this case the same error message is displayed, and the connection attempt is aborted.</span></span>  
  
#### <a name="odbc-connection-pooling-password-expiry-and-locked-accounts"></a><span data-ttu-id="c674b-194">ODBC 連接共用、密碼逾期與鎖定帳戶</span><span class="sxs-lookup"><span data-stu-id="c674b-194">ODBC Connection Pooling, Password Expiry, and Locked Accounts</span></span>  
 <span data-ttu-id="c674b-195">當連接在連接共用中仍處於作用中狀態時，帳戶可能會遭到鎖定，或者其密碼可能會過期。</span><span class="sxs-lookup"><span data-stu-id="c674b-195">An account may be locked or its password may expire while the connection is still active in a connection pool.</span></span> <span data-ttu-id="c674b-196">伺服器會在兩種時機下檢查過期的密碼與鎖定的帳戶。</span><span class="sxs-lookup"><span data-stu-id="c674b-196">The server checks for expired passwords and locked accounts on two occasions.</span></span> <span data-ttu-id="c674b-197">第一個時機是首次建立連接時。</span><span class="sxs-lookup"><span data-stu-id="c674b-197">The first is when a connection is first created.</span></span> <span data-ttu-id="c674b-198">第二個時機則是在連接取自集區而重設連接時。</span><span class="sxs-lookup"><span data-stu-id="c674b-198">The second occasion is upon connection reset, when the connection is taken from the pool.</span></span>  
  
 <span data-ttu-id="c674b-199">當重設嘗試失敗後，連接便會從集區移除並傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="c674b-199">When the reset attempt fails, the connection is removed from the pool and an error is returned.</span></span>  
  
### <a name="odbc-programmatic-password-expiration"></a><span data-ttu-id="c674b-200">ODBC 程式設計密碼逾期</span><span class="sxs-lookup"><span data-stu-id="c674b-200">ODBC Programmatic Password Expiration</span></span>  
 <span data-ttu-id="c674b-201">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC 驅動程式透過加入 SQL_COPT_SS_OLDPWD 屬性（在使用[SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md)函數連接到伺服器之前設定）來支援密碼到期。</span><span class="sxs-lookup"><span data-stu-id="c674b-201">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver supports password expiration through the addition of the SQL_COPT_SS_OLDPWD attribute which is set before connecting to the server using the [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md) function.</span></span>  
  
 <span data-ttu-id="c674b-202">連接控制代碼的 SQL_COPT_SS_OLDPWD 屬性指的是過期的密碼。</span><span class="sxs-lookup"><span data-stu-id="c674b-202">The SQL_COPT_SS_OLDPWD attribute of the connection handle refers to the expired password.</span></span> <span data-ttu-id="c674b-203">此屬性沒有任何連接字串屬性，因為這會干擾連接共用。</span><span class="sxs-lookup"><span data-stu-id="c674b-203">There is no connection string attribute for this attribute, as this would interfere with connection pooling.</span></span> <span data-ttu-id="c674b-204">如果登入成功，驅動程式會清除這個屬性。</span><span class="sxs-lookup"><span data-stu-id="c674b-204">If the login succeeds, the driver clears this attribute.</span></span>  
  
 <span data-ttu-id="c674b-205">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC 驅動程式會在這項功能的四個案例中傳回 SQL_ERROR：密碼到期、密碼原則衝突、帳戶鎖定，以及使用 Windows 驗證時設定舊密碼屬性的時間。</span><span class="sxs-lookup"><span data-stu-id="c674b-205">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver returns SQL_ERROR in four cases for this feature: password expiration, password policy conflict, account lockout, and when the old password property is set while using Windows Authentication.</span></span> <span data-ttu-id="c674b-206">叫用[SQLGetDiagField](../../native-client-odbc-api/sqlgetdiagfield.md)時，驅動程式會將適當的錯誤訊息傳回給使用者。</span><span class="sxs-lookup"><span data-stu-id="c674b-206">The driver returns the appropriate error messages to the user when [SQLGetDiagField](../../native-client-odbc-api/sqlgetdiagfield.md) is invoked.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c674b-207">另請參閱</span><span class="sxs-lookup"><span data-stu-id="c674b-207">See Also</span></span>  
 [<span data-ttu-id="c674b-208">SQL Server Native Client 功能</span><span class="sxs-lookup"><span data-stu-id="c674b-208">SQL Server Native Client Features</span></span>](sql-server-native-client-features.md)  
  
  
