---
title: 使用資料庫鏡像 | Microsoft Docs
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- database mirroring [SQL Server], interoperability
- SQL Server Native Client, database mirroring
- data access [SQL Server Native Client], database mirroring
- database mirroring [SQL Server], connecting clients to
- SQLNCLI, database mirroring
- SQL Server Native Client ODBC driver, database mirroring
- SQL Server Native Client OLE DB provider, database mirroring
ms.assetid: 71b15712-7972-4465-9274-e0ddc271eedc
author: rothja
ms.author: jroth
ms.openlocfilehash: 389036322137abcc9a40e36c697e8d45e39a7de5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87592658"
---
# <a name="using-database-mirroring"></a><span data-ttu-id="bd2d4-102">使用資料庫鏡像</span><span class="sxs-lookup"><span data-stu-id="bd2d4-102">Using Database Mirroring</span></span>
    
> [!NOTE]  
>  [!INCLUDE[ssNoteDepFutureAvoid](../../../includes/ssnotedepfutureavoid-md.md)] <span data-ttu-id="bd2d4-103">請改用 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-103">Use [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] instead.</span></span>  
  
 <span data-ttu-id="bd2d4-104">在 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 中導入的資料庫鏡像是一套增加資料庫可用性與資料冗餘的方案。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-104">Database mirroring, introduced in [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], is a solution for increasing database availability and data redundancy.</span></span> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="bd2d4-105">Native Client 會提供對資料庫鏡像的隱含支援，因此，開發人員在針對資料庫設定之後，不需要撰寫任何程式碼或採取任何其他動作。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-105">Native Client provides implicit support for database mirroring, so the developer does not need to write any code or take any other action once it has been configured for the database.</span></span>  
  
 <span data-ttu-id="bd2d4-106">資料庫鏡像是根據每一個資料庫來實作，它會在待命伺服器上保留 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 生產資料庫的複本。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-106">Database mirroring, which is implemented on a per-database basis, keeps a copy of a [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] production database on a standby server.</span></span> <span data-ttu-id="bd2d4-107">此伺服器為熱或暖待命伺服器，端視資料庫鏡像工作階段的組態和狀態而定。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-107">This server is either a hot or warm standby server, depending on the configuration and state of the database mirroring session.</span></span> <span data-ttu-id="bd2d4-108">熱待命伺服器支援不會遺失任何已認可交易的快速容錯移轉，而暖待命伺服器支援強制服務 (資料可能會遺失)。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-108">A hot standby server supports rapid failover with no loss of committed transactions, and a warm standby server supports forcing service (with possible data loss).</span></span>  
  
 <span data-ttu-id="bd2d4-109">生產資料庫稱為「*主體資料庫*」，而待命副本則稱為「*鏡像資料庫*」。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-109">The production database is called the *principal database*, and the standby copy is called the *mirror database*.</span></span> <span data-ttu-id="bd2d4-110">主體資料庫和鏡像資料庫必須位於個別的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 執行個體 (伺服器執行個體) 上，如有可能，也應該位於個別的電腦上。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-110">The principal database and mirror database must reside on separate instances of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (server instances), and they should reside on separate computers if possible.</span></span>  
  
 <span data-ttu-id="bd2d4-111">稱為「主體伺服器」\*\* 的實際執行伺服器執行個體會與稱為「鏡像伺服器」\*\* 的待命伺服器執行個體進行通訊。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-111">The production server instance, called the *principal server*, communicates with the standby server instance, called the *mirror server*.</span></span> <span data-ttu-id="bd2d4-112">主體和鏡像伺服器會在資料庫鏡像*會話*中作為夥伴。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-112">The principal and mirror servers act as partners within a database mirroring *session*.</span></span> <span data-ttu-id="bd2d4-113">如果主體伺服器失敗，則鏡像伺服器可以透過稱為「容錯移轉」\*\* 的處理序，使鏡像伺服器的資料庫成為主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-113">If the principal server fails, the mirror server can make its database into the principal database through a process called *failover*.</span></span> <span data-ttu-id="bd2d4-114">例如，Partner_A 與 Partner_B 是兩個夥伴伺服器，其中主體資料庫一開始位於 Partner_A 上做為主體伺服器，而鏡像資料庫位於 Partner_B 上做為鏡像伺服器。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-114">For example, Partner_A and Partner_B are two partner servers, with the principal database initially on Partner_A as principal server, and the mirror database residing on Partner_B as the mirror server.</span></span> <span data-ttu-id="bd2d4-115">如果 Partner_A 離線，Partner_B 上的資料庫可以容錯移轉，變成目前的主體資料庫。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-115">If Partner_A goes offline, the database on Partner_B can fail over to become the current principal database.</span></span> <span data-ttu-id="bd2d4-116">當 Partner_A 重新加入鏡像工作階段時，它會變成鏡像伺服器而其資料庫會變成鏡像資料庫。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-116">When Partner_A rejoins the mirroring session, it becomes the mirror server and its database becomes the mirror database.</span></span>  
  
 <span data-ttu-id="bd2d4-117">替代的資料庫鏡像組態提供不同層次的效能及資料安全，並支援不同形式的容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-117">Alternative database mirroring configurations offer different levels of performance and data safety, and support different forms of failover.</span></span> <span data-ttu-id="bd2d4-118">如需詳細資訊，請參閱[資料庫鏡像 &#40;SQL Server&#41;](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-118">For more information, see [Database Mirroring &#40;SQL Server&#41;](../../../database-engine/database-mirroring/database-mirroring-sql-server.md).</span></span>  
  
 <span data-ttu-id="bd2d4-119">指定鏡像資料庫名稱時，可以使用別名。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-119">It is possible to use an alias when specifying the mirror database name.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="bd2d4-120">如需有關鏡像資料庫之初始連線嘗試與重新連線嘗試的詳細資訊，請參閱[將用戶端連接至資料庫鏡像工作階段 &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-120">For information about initial connection attempts and reconnection attempts to a mirrored database, see [Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md).</span></span>  
  
## <a name="programming-considerations"></a><span data-ttu-id="bd2d4-121">程式設計考量</span><span class="sxs-lookup"><span data-stu-id="bd2d4-121">Programming Considerations</span></span>  
 <span data-ttu-id="bd2d4-122">當主體資料庫伺服器失敗時，用戶端應用程式會在回應 API 呼叫時收到錯誤，這表示與資料庫的連接已經中斷。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-122">When the principal database server fails, the client application receives errors in response to API calls, which indicate that the connection to the database has been lost.</span></span> <span data-ttu-id="bd2d4-123">發生這個情況時，對於資料庫的任何未認可變更都會遺失，而且目前的交易會回復。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-123">When this happens, any uncommitted changes to the database are lost and the current transaction is rolled back.</span></span> <span data-ttu-id="bd2d4-124">如果發生這個情況，應用程式應該關閉連接 (或釋出資料來源物件) 然後再重新開啟它。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-124">If this occurs, the application should close the connection (or release the data source object) and re-open it.</span></span> <span data-ttu-id="bd2d4-125">此連接會以透明的方式重新導向鏡像資料庫，現在當做主體伺服器使用。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-125">The connection is transparently re-directed to the mirror database, which now acts as the principal server.</span></span>  
  
 <span data-ttu-id="bd2d4-126">建立連接時，主體伺服器會將其容錯移轉夥伴的識別傳送到容錯移轉發生時所使用的用戶端。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-126">When a connection is established, the principal server sends the identity of its failover partner to the client to be used when failover occurs.</span></span> <span data-ttu-id="bd2d4-127">在應用程式嘗試在主體伺服器失敗後建立連接的情況下，用戶端不會知道容錯移轉夥伴的識別。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-127">Where an application tried to establish a connection after the principal server failed, the client does not know the identity of the failover partner.</span></span> <span data-ttu-id="bd2d4-128">為了讓用戶端有機會處理此狀況，初始化屬性和相關聯的連接字串關鍵字可讓用戶端自行指定容錯移轉夥伴的識別。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-128">To allow clients the opportunity to cope with this scenario, an initialization property and an associated connection string keyword allow the client to specify the identity of the failover partner on its own.</span></span> <span data-ttu-id="bd2d4-129">只有在有可用的主體伺服器，但未使用時，才會在此狀況中使用用戶端屬性。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-129">The client attribute is used only in this scenario; if the principal server is available, it is not used.</span></span> <span data-ttu-id="bd2d4-130">如果用戶端提供的容錯移轉夥伴伺服器指的不是當做容錯移轉夥伴的伺服器，伺服器就會拒絕連接。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-130">If the failover partner server supplied by the client does not refer to a server acting as a failover partner, the connection is refused by the server.</span></span> <span data-ttu-id="bd2d4-131">若要讓應用程式符合組態變更，實際容錯移轉夥伴的識別可以透過檢查建立連接後的屬性來判斷。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-131">To allow applications to adapt to configuration changes, the identity of the actual failover partner can be determined by inspecting the attribute after the connection has been established.</span></span> <span data-ttu-id="bd2d4-132">如果第一次建立連接的嘗試失敗，您應該考慮快取處理夥伴資訊來更新連接字串或想出重試策略。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-132">You should consider caching the partner information to update the connection string or devise a retry strategy in the event that the first attempt at making a connection fails.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="bd2d4-133">如果您要在 DSN、連接字串或連接屬性 (Property)/屬性 (Attribute) 中使用此功能，您必須明確指定連接所使用的資料庫。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-133">You must explicitly specify the database to be used by a connection if you want to use this feature in a DSN, connection string, or connection property/attribute.</span></span> <span data-ttu-id="bd2d4-134">如果未完成此動作，[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client 將不會嘗試容錯移轉到夥伴資料庫。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-134">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client will not attempt to failover to the partner database if this is not done.</span></span>  
>   
>  <span data-ttu-id="bd2d4-135">鏡像是資料庫的一個功能。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-135">Mirroring is a feature of the database.</span></span> <span data-ttu-id="bd2d4-136">使用多個資料庫的應用程式可能無法使用此功能。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-136">Applications that use multiple databases might not be able to exploit this feature.</span></span>  
>   
>  <span data-ttu-id="bd2d4-137">此外，伺服器名稱不區分大小寫，但是資料庫名稱會區分大小寫。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-137">In addition, server names are case insensitive, but database names are case sensitive.</span></span> <span data-ttu-id="bd2d4-138">因此，您應該確認您在 DSN 和連接字串中使用相同的大小寫。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-138">You should therefore make sure that you use the same casing in DSNs and connection strings.</span></span>  
  
## <a name="sql-server-native-client-ole-db-provider"></a><span data-ttu-id="bd2d4-139">SQL Server Native Client OLE DB 提供者</span><span class="sxs-lookup"><span data-stu-id="bd2d4-139">SQL Server Native Client OLE DB Provider</span></span>  
 <span data-ttu-id="bd2d4-140">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供者透過連接和連接字串屬性支援資料庫鏡像。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-140">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports database mirroring through connection and connection string attributes.</span></span> <span data-ttu-id="bd2d4-141">SSPROP_INIT_FAILOVERPARTNER 屬性已加入到 DBPROPSET_SQLSERVERDBINIT 屬性集，而 `FailoverPartner` 關鍵字是 DBPROP_INIT_PROVIDERSTRING 的新連接字串屬性。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-141">The SSPROP_INIT_FAILOVERPARTNER property has been added to the DBPROPSET_SQLSERVERDBINIT property set, and the `FailoverPartner` keyword is a new connection string attribute for DBPROP_INIT_PROVIDERSTRING.</span></span> <span data-ttu-id="bd2d4-142">如需詳細資訊，請參閱搭配[使用連接字串關鍵字與 SQL Server Native Client](../applications/using-connection-string-keywords-with-sql-server-native-client.md)。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-142">For more information, see [Using Connection String Keywords with SQL Server Native Client](../applications/using-connection-string-keywords-with-sql-server-native-client.md).</span></span>  
  
 <span data-ttu-id="bd2d4-143">只要載入提供者，就會維持容錯移轉快取，直到呼叫**CoUninitialize** ，或只要應用程式擁有 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB 提供者（例如資料來源物件）所管理之某些物件的參考即可。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-143">The failover cache is maintained as long as the provider is loaded, which is until **CoUninitialize** is called or as long as the application has a reference to some object managed by the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider such as a data source object.</span></span>  
  
 <span data-ttu-id="bd2d4-144">如需 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 原生用戶端 OLE DB 提供者資料庫鏡像支援的詳細資訊，請參閱[初始化和授權屬性](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md)。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-144">For details about [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider support for database mirroring, see [Initialization and Authorization Properties](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md).</span></span>  
  
## <a name="sql-server-native-client-odbc-driver"></a><span data-ttu-id="bd2d4-145">SQL Server Native Client ODBC 驅動程式</span><span class="sxs-lookup"><span data-stu-id="bd2d4-145">SQL Server Native Client ODBC Driver</span></span>  
 <span data-ttu-id="bd2d4-146">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC 驅動程式透過連接和連接字串屬性支援資料庫鏡像。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-146">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver supports database mirroring through connection and connection string attributes.</span></span> <span data-ttu-id="bd2d4-147">具體而言，已加入 SQL_COPT_SS_FAILOVER_PARTNER 屬性以搭配[SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md)和[SQLGetConnectAttr](../../native-client-odbc-api/sqlgetconnectattr.md)函數使用;和 `Failover_Partner` 關鍵字已加入為新的連接字串屬性。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-147">Specifically, the SQL_COPT_SS_FAILOVER_PARTNER attribute has been added for use with the [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md) and [SQLGetConnectAttr](../../native-client-odbc-api/sqlgetconnectattr.md) functions; and the `Failover_Partner` keyword has been added as a new connection string attribute.</span></span>  
  
 <span data-ttu-id="bd2d4-148">只要應用程式至少有配置一個環境控制代碼，就可以維持容錯移轉快取。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-148">The failover cache is maintained as long as the application has at least one environment handle allocated.</span></span> <span data-ttu-id="bd2d4-149">相反地，取消配置最後一個環境控制代碼時，容錯移轉快取就會遺失。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-149">Conversely, it is lost when the last environment handle is deallocated.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="bd2d4-150">ODBC 驅動程式管理員已經增強，可以支援容錯移轉伺服器名稱的規格。</span><span class="sxs-lookup"><span data-stu-id="bd2d4-150">The ODBC Driver Manager has been enhanced to support the specification of the failover server name.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bd2d4-151">另請參閱</span><span class="sxs-lookup"><span data-stu-id="bd2d4-151">See Also</span></span>  
 <span data-ttu-id="bd2d4-152">[SQL Server Native Client 功能](sql-server-native-client-features.md) </span><span class="sxs-lookup"><span data-stu-id="bd2d4-152">[SQL Server Native Client Features](sql-server-native-client-features.md) </span></span>  
 <span data-ttu-id="bd2d4-153">[將用戶端連接至資料庫鏡像工作階段 &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="bd2d4-153">[Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md) </span></span>  
 [<span data-ttu-id="bd2d4-154">資料庫鏡像 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="bd2d4-154">Database Mirroring &#40;SQL Server&#41;</span></span>](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)  
  
  
