---
title: CLR 使用者定義匯總的需求 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- aggregate functions [CLR integration]
- user-defined types [CLR integration], user-defined aggregates
- CREATE AGGREGATE statement
- SqlUserDefinedAggregate attribute
- aggregate methods [CLR integration]
- assemblies [CLR integration], user-defined aggregate functions
- custom aggregates [CLR integration]
- user-defined functions [CLR integration]
- UDTs [CLR integration], user-defined aggregates
ms.assetid: dbf9eb5a-bd99-42f7-b275-556d0def045d
author: rothja
ms.author: jroth
ms.openlocfilehash: 8123f8324d43212007857dbb596a4fc61872bd2e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87596732"
---
# <a name="requirements-for-clr-user-defined-aggregates"></a><span data-ttu-id="a10c8-102">CLR 使用者定義彙總的需求</span><span class="sxs-lookup"><span data-stu-id="a10c8-102">Requirements for CLR User-Defined Aggregates</span></span>
  <span data-ttu-id="a10c8-103">在 Common Language Runtime (CLR) 組件中的類型只要實作需要的彙總合約，就可以註冊為使用者定義彙總函式。</span><span class="sxs-lookup"><span data-stu-id="a10c8-103">A type in a common language runtime (CLR) assembly can be registered as a user-defined aggregate function, as long as it implements the required aggregation contract.</span></span> <span data-ttu-id="a10c8-104">此合約由 `SqlUserDefinedAggregate` 屬性及彙總合約方法組成。</span><span class="sxs-lookup"><span data-stu-id="a10c8-104">This contract consists of the `SqlUserDefinedAggregate` attribute and the aggregation contract methods.</span></span> <span data-ttu-id="a10c8-105">彙總合約包括儲存彙總中繼狀態的機制，以及累積新值的機制，它是由四種方法組成：`Init`、`Accumulate`、`Merge` 和 `Terminate`。</span><span class="sxs-lookup"><span data-stu-id="a10c8-105">The aggregation contract includes the mechanism to save the intermediate state of the aggregation, and the mechanism to accumulate new values, which consists of four methods: `Init`, `Accumulate`, `Merge`, and `Terminate`.</span></span> <span data-ttu-id="a10c8-106">當您符合這些需求時，您將能夠充分利用中的使用者定義匯總 [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="a10c8-106">When you have met these requirements, you will be able to take full advantage of user-defined aggregates in [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a10c8-107">本主題的下列章節提供關於如何建立和使用使用者定義彙總的其他相關資訊。</span><span class="sxs-lookup"><span data-stu-id="a10c8-107">The following sections of this topic provide additional details about how to create and work with user-defined aggregates.</span></span> <span data-ttu-id="a10c8-108">如需範例，請參閱叫用[CLR 使用者定義彙總函式](clr-user-defined-aggregate-invoking-functions.md)。</span><span class="sxs-lookup"><span data-stu-id="a10c8-108">For an example, see [Invoking CLR User-Defined Aggregate Functions](clr-user-defined-aggregate-invoking-functions.md).</span></span>  
  
## <a name="sqluserdefinedaggregate"></a><span data-ttu-id="a10c8-109">SqlUserDefinedAggregate</span><span class="sxs-lookup"><span data-stu-id="a10c8-109">SqlUserDefinedAggregate</span></span>  
 <span data-ttu-id="a10c8-110">如需詳細資訊，請參閱[SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626)。</span><span class="sxs-lookup"><span data-stu-id="a10c8-110">For more information, see [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span></span>  
  
## <a name="aggregation-methods"></a><span data-ttu-id="a10c8-111">彙總方法</span><span class="sxs-lookup"><span data-stu-id="a10c8-111">Aggregation Methods</span></span>  
 <span data-ttu-id="a10c8-112">註冊為使用者定義彙總的類別應該會支援下列執行個體方法。</span><span class="sxs-lookup"><span data-stu-id="a10c8-112">The class registered as a user-defined aggregate should support the following instance methods.</span></span> <span data-ttu-id="a10c8-113">查詢處理器用以計算彙總的方法：</span><span class="sxs-lookup"><span data-stu-id="a10c8-113">These are the methods that the query processor uses to compute the aggregation:</span></span>  
  
|<span data-ttu-id="a10c8-114">方法</span><span class="sxs-lookup"><span data-stu-id="a10c8-114">Method</span></span>|<span data-ttu-id="a10c8-115">語法</span><span class="sxs-lookup"><span data-stu-id="a10c8-115">Syntax</span></span>|<span data-ttu-id="a10c8-116">描述</span><span class="sxs-lookup"><span data-stu-id="a10c8-116">Description</span></span>|  
|------------|------------|-----------------|  
|`Init`|<span data-ttu-id="a10c8-117">public void Init ( # A1;</span><span class="sxs-lookup"><span data-stu-id="a10c8-117">public void Init();</span></span>|<span data-ttu-id="a10c8-118">查詢處理器使用這個方法將彙總計算初始化。</span><span class="sxs-lookup"><span data-stu-id="a10c8-118">The query processor uses this method to initialize the computation of the aggregation.</span></span> <span data-ttu-id="a10c8-119">這個方法針對查詢處理器正在彙總的每個群組叫用一次。</span><span class="sxs-lookup"><span data-stu-id="a10c8-119">This method is invoked once for each group that the query processor is aggregating.</span></span> <span data-ttu-id="a10c8-120">查詢處理器為了計算多個群組彙總，可能選擇重複使用彙總類別之相同執行個體。</span><span class="sxs-lookup"><span data-stu-id="a10c8-120">The query processor may choose to reuse the same instance of the aggregate class for computing aggregates of multiple groups.</span></span> <span data-ttu-id="a10c8-121">`Init` 方法應該會視需要針對上次使用的此執行個體執行清除作業，並讓它重新啟動新的彙總計算。</span><span class="sxs-lookup"><span data-stu-id="a10c8-121">The `Init` method should perform any clean-up as necessary from previous uses of this instance, and enable it to re-start a new aggregate computation.</span></span>|  
|`Accumulate`|<span data-ttu-id="a10c8-122">public void 會累積 ( 輸入類型值 [，輸入類型值 ...]) ;</span><span class="sxs-lookup"><span data-stu-id="a10c8-122">public void Accumulate ( input-type value[, input-type value, ...]);</span></span>|<span data-ttu-id="a10c8-123">代表函數參數的一個或多個參數。</span><span class="sxs-lookup"><span data-stu-id="a10c8-123">One or more parameters representing the parameters of the function.</span></span> <span data-ttu-id="a10c8-124">*input_type*應該是 managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 資料類型，相當於 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 語句中*input_sqltype*所指定的原生資料類型 `CREATE AGGREGATE` 。</span><span class="sxs-lookup"><span data-stu-id="a10c8-124">*input_type* should be the managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type equivalent to the native [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type specified by *input_sqltype* in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="a10c8-125">如需詳細資訊，請參閱[對應 CLR 參數資料](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md)。</span><span class="sxs-lookup"><span data-stu-id="a10c8-125">For more information, see [Mapping CLR Parameter Data](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span></span><br /><br /> <span data-ttu-id="a10c8-126">如果是使用者定義型別 (UDT)，輸入類型則是 UDT 類型。</span><span class="sxs-lookup"><span data-stu-id="a10c8-126">For user-defined types (UDTs), the input-type is the same as the UDT type.</span></span> <span data-ttu-id="a10c8-127">查詢處理器使用這個方法來累積彙總值。</span><span class="sxs-lookup"><span data-stu-id="a10c8-127">The query processor uses this method to accumulate the aggregate values.</span></span> <span data-ttu-id="a10c8-128">在群組中正在彙總的每一個值都會叫用一次。</span><span class="sxs-lookup"><span data-stu-id="a10c8-128">This is invoked once for each value in the group that is being aggregated.</span></span> <span data-ttu-id="a10c8-129">查詢處理器一定只會在給定的彙總類別執行個體上呼叫 `Init` 方法後才會呼叫這些值。</span><span class="sxs-lookup"><span data-stu-id="a10c8-129">The query processor always calls this only after calling the `Init` method on the given instance of the aggregate-class.</span></span> <span data-ttu-id="a10c8-130">這個方法的實作應該會更新執行個體的狀態，以反映傳入的引數值之累積狀況。</span><span class="sxs-lookup"><span data-stu-id="a10c8-130">The implementation of this method should update the state of the instance to reflect the accumulation of the argument value being passed in.</span></span>|  
|`Merge`|<span data-ttu-id="a10c8-131">public void Merge ( udagg_class 值) ;</span><span class="sxs-lookup"><span data-stu-id="a10c8-131">public void Merge( udagg_class value);</span></span>|<span data-ttu-id="a10c8-132">這個方法可用於將此彙總類別的其他執行個體與目前的執行個體合併。</span><span class="sxs-lookup"><span data-stu-id="a10c8-132">This method can be used to merge another instance of this aggregate class with the current instance.</span></span> <span data-ttu-id="a10c8-133">查詢處理器使用這個方法合併多個不完全的彙總計算。</span><span class="sxs-lookup"><span data-stu-id="a10c8-133">The query processor uses this method to merge multiple partial computations of an aggregation.</span></span>|  
|`Terminate`|<span data-ttu-id="a10c8-134">公用 return_type 終止 ( # A1;</span><span class="sxs-lookup"><span data-stu-id="a10c8-134">public return_type Terminate();</span></span>|<span data-ttu-id="a10c8-135">這個方法會完成彙總計算，並傳回彙總的結果。</span><span class="sxs-lookup"><span data-stu-id="a10c8-135">This method completes the aggregate computation and returns the result of the aggregation.</span></span> <span data-ttu-id="a10c8-136">*Return_type*應該是 managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 資料類型，這是語句中所指定*return_sqltype*的 managed 對應項 `CREATE AGGREGATE` 。</span><span class="sxs-lookup"><span data-stu-id="a10c8-136">The *return_type* should be a managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type that is the managed equivalent of *return_sqltype* specified in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="a10c8-137">*Return_type*也可以是使用者定義型別。</span><span class="sxs-lookup"><span data-stu-id="a10c8-137">The *return_type* can also be a user-defined type.</span></span>|  
  
### <a name="table-valued-parameters"></a><span data-ttu-id="a10c8-138">資料表值參數</span><span class="sxs-lookup"><span data-stu-id="a10c8-138">Table-Valued Parameters</span></span>  
 <span data-ttu-id="a10c8-139">資料表值參數 (TVP) 是使用者定義資料表類型，會傳入到程序或函數中，提供有效的方式將資料的多個資料列傳遞到伺服器。</span><span class="sxs-lookup"><span data-stu-id="a10c8-139">Table-valued parameters (TVPs), user-defined table types that are passed into a procedure or function, provide an efficient way to pass multiple rows of data to the server.</span></span> <span data-ttu-id="a10c8-140">雖然 TVP 提供相似的功能給參數陣列，但是也提供更大的彈性和與 [!INCLUDE[tsql](../../includes/tsql-md.md)] 更緊密的整合。</span><span class="sxs-lookup"><span data-stu-id="a10c8-140">TVPs provide similar functionality to parameter arrays, but offer greater flexibility and closer integration with [!INCLUDE[tsql](../../includes/tsql-md.md)].</span></span> <span data-ttu-id="a10c8-141">它們也能夠協助您獲得更佳的效能。</span><span class="sxs-lookup"><span data-stu-id="a10c8-141">They also provide the potential for better performance.</span></span> <span data-ttu-id="a10c8-142">TVP 也減少與伺服器之間的往返次數。</span><span class="sxs-lookup"><span data-stu-id="a10c8-142">TVPs also help reduce the number of round trips to the server.</span></span> <span data-ttu-id="a10c8-143">除了傳送多個要求到伺服器 (例如夾帶純量參數的清單)，資料能以 TVP 的形式傳送到伺服器。</span><span class="sxs-lookup"><span data-stu-id="a10c8-143">Instead of sending multiple requests to the server, such as with a list of scalar parameters, data can be sent to the server as a TVP.</span></span> <span data-ttu-id="a10c8-144">使用者定義資料表類型無法以資料表值參數的形式傳遞到 Managed 預存程序或在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 處理序中執行的函數，也無法從該預存程序或函數傳回。</span><span class="sxs-lookup"><span data-stu-id="a10c8-144">A user-defined table type cannot be passed as a table-valued parameter to, or be returned from, a managed stored procedure or function executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process.</span></span> <span data-ttu-id="a10c8-145">此外，TVP 也無法在內容連接範圍內使用。</span><span class="sxs-lookup"><span data-stu-id="a10c8-145">Also, TVPs cannot be used within the scope of a context connection.</span></span> <span data-ttu-id="a10c8-146">但是，如果 TVP 用於非內容連接中，就可以在 Managed 預存程序或在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 處理序中所執行的函數裡與 SqlClient 使用。</span><span class="sxs-lookup"><span data-stu-id="a10c8-146">However, a TVP can be used with SqlClient in managed stored procedures or functions executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process, if it is used in a connection that is not a context connection.</span></span> <span data-ttu-id="a10c8-147">該連接可連接至執行 Managed 程序或函數的相同伺服器。</span><span class="sxs-lookup"><span data-stu-id="a10c8-147">The connection can be to the same server that is executing the managed procedure or function.</span></span> <span data-ttu-id="a10c8-148">如需 Tvp 的詳細資訊，請參閱[使用資料表值參數 &#40;資料庫引擎&#41;](../tables/use-table-valued-parameters-database-engine.md)。</span><span class="sxs-lookup"><span data-stu-id="a10c8-148">For more information about TVPs, see [Use Table-Valued Parameters &#40;Database Engine&#41;](../tables/use-table-valued-parameters-database-engine.md).</span></span>  
  
## <a name="change-history"></a><span data-ttu-id="a10c8-149">變更記錄</span><span class="sxs-lookup"><span data-stu-id="a10c8-149">Change History</span></span>  
  
|<span data-ttu-id="a10c8-150">更新的內容</span><span class="sxs-lookup"><span data-stu-id="a10c8-150">Updated content</span></span>|  
|---------------------|  
|<span data-ttu-id="a10c8-151">已更新 `Accumulate` 方法的說明；該方法現在接受一個以上的參數。</span><span class="sxs-lookup"><span data-stu-id="a10c8-151">Updated the description of the `Accumulate` method; it now accepts more than one parameter.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="a10c8-152">另請參閱</span><span class="sxs-lookup"><span data-stu-id="a10c8-152">See Also</span></span>  
 <span data-ttu-id="a10c8-153">[CLR 使用者定義類型](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span><span class="sxs-lookup"><span data-stu-id="a10c8-153">[CLR User-Defined Types](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span></span>  
 [<span data-ttu-id="a10c8-154">叫用 CLR 使用者定義彙總函式</span><span class="sxs-lookup"><span data-stu-id="a10c8-154">Invoking CLR User-Defined Aggregate Functions</span></span>](clr-user-defined-aggregate-invoking-functions.md)  
  
  
