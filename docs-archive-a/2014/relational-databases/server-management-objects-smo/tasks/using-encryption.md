---
title: 使用加密 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: reference
helpviewer_keywords:
- database master key [SMO]
- cryptography [SMO]
- cryptography [SQL Server], SMO
- encryption keys [SMO]
- encryption [SQL Server], SMO
- encryption [SMO]
- certificates [SMO]
- service master key [SMO]
ms.assetid: 405e0ed7-50a9-430e-a343-471f54b4af76
author: stevestein
ms.author: sstein
ms.openlocfilehash: 1f1f7d6a8714deb1317562dce669fa0e7adbd45c
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87599441"
---
# <a name="using-encryption"></a><span data-ttu-id="ebf86-102">使用加密</span><span class="sxs-lookup"><span data-stu-id="ebf86-102">Using Encryption</span></span>
  <span data-ttu-id="ebf86-103">在 SMO 中，服務主要金鑰是由 <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey> 物件表示，</span><span class="sxs-lookup"><span data-stu-id="ebf86-103">In SMO, the service master key is represented by the <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey> object.</span></span> <span data-ttu-id="ebf86-104">這可藉由 <xref:Microsoft.SqlServer.Management.Smo.Server.ServiceMasterKey%2A> 物件的 <xref:Microsoft.SqlServer.Management.Smo.Server> 屬性加以參考，</span><span class="sxs-lookup"><span data-stu-id="ebf86-104">This is referenced by the <xref:Microsoft.SqlServer.Management.Smo.Server.ServiceMasterKey%2A> property of the <xref:Microsoft.SqlServer.Management.Smo.Server> object.</span></span> <span data-ttu-id="ebf86-105">並使用 <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey.Regenerate%2A> 方法來重新產生。</span><span class="sxs-lookup"><span data-stu-id="ebf86-105">It can be regenerated by using the <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey.Regenerate%2A> method.</span></span>  
  
 <span data-ttu-id="ebf86-106">資料庫主要金鑰是由 <xref:Microsoft.SqlServer.Management.Smo.MasterKey> 物件表示。</span><span class="sxs-lookup"><span data-stu-id="ebf86-106">The database master key is represented by the <xref:Microsoft.SqlServer.Management.Smo.MasterKey> object.</span></span> <span data-ttu-id="ebf86-107"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.IsEncryptedByServer%2A> 屬性會指出是否利用服務主要金鑰來加密資料庫主要金鑰。</span><span class="sxs-lookup"><span data-stu-id="ebf86-107">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.IsEncryptedByServer%2A> property indicates whether or not the database master key is encrypted by the service master key.</span></span> <span data-ttu-id="ebf86-108">每當資料庫主要金鑰變更時，master 資料庫中的加密副本就會自動更新。</span><span class="sxs-lookup"><span data-stu-id="ebf86-108">The encrypted copy in the master database is automatically updated whenever the database master key is changed.</span></span>  
  
 <span data-ttu-id="ebf86-109">您可以使用 <xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> 方法來卸除服務金鑰加密，然後使用密碼對資料庫主要金鑰進行加密。</span><span class="sxs-lookup"><span data-stu-id="ebf86-109">It is possible to drop service key encryption using the <xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> method and encrypt the database master key with a password.</span></span> <span data-ttu-id="ebf86-110">在該種情況下，您必須明確地開啟資料庫主要金鑰，才能存取該金鑰所保護的私密金鑰。</span><span class="sxs-lookup"><span data-stu-id="ebf86-110">In that situation, you will have to explicitly open the database master key before accessing private keys that it has secured.</span></span>  
  
 <span data-ttu-id="ebf86-111">將資料庫附加到 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 的執行個體時，您必須為資料庫主要金鑰提供密碼，或執行 <xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> 方法，讓資料庫主要金鑰的未加密副本可以使用服務主要金鑰進行加密。</span><span class="sxs-lookup"><span data-stu-id="ebf86-111">When a database is being attached to an instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], you must either supply the password for the database master key or execute the <xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> method to make an unencrypted copy of the database master key available for encryption with the service master key.</span></span> <span data-ttu-id="ebf86-112">建議使用此步驟，如此即不必明確地開啟資料庫主要金鑰。</span><span class="sxs-lookup"><span data-stu-id="ebf86-112">This step is recommended to avoid the need to explicitly open the database master key.</span></span>  
  
 <span data-ttu-id="ebf86-113"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.Regenerate%2A> 方法會重新產生資料庫主要金鑰。</span><span class="sxs-lookup"><span data-stu-id="ebf86-113">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.Regenerate%2A> method regenerates the database master key.</span></span> <span data-ttu-id="ebf86-114">當重新產生資料庫主要金鑰時，所有利用資料庫主要金鑰加密的金鑰都會解密，然後再利用新的資料庫主要金鑰來加密。</span><span class="sxs-lookup"><span data-stu-id="ebf86-114">When the database master key is regenerated, all the keys that have been encrypted with the database master key are decrypted, and then encrypts them with the new database master key.</span></span> <span data-ttu-id="ebf86-115"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> 方法會利用服務主要金鑰移除資料庫主要金鑰的加密。</span><span class="sxs-lookup"><span data-stu-id="ebf86-115">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> method removes the encryption of the database master key by the service master key.</span></span> <span data-ttu-id="ebf86-116"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> 會導致主要金鑰的副本使用服務主要金鑰加密，然後同時儲存在目前的資料庫和 master 資料庫中。</span><span class="sxs-lookup"><span data-stu-id="ebf86-116"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> causes a copy of the master key to be encrypted using the service master key and stored in both the current database and in the master database.</span></span>  
  
 <span data-ttu-id="ebf86-117">在 SMO 中，憑證是由 <xref:Microsoft.SqlServer.Management.Smo.Certificate> 物件所表示。</span><span class="sxs-lookup"><span data-stu-id="ebf86-117">In SMO, certificates are represented by the <xref:Microsoft.SqlServer.Management.Smo.Certificate> object.</span></span> <span data-ttu-id="ebf86-118"><xref:Microsoft.SqlServer.Management.Smo.Certificate> 物件的屬性可指定公開金鑰、主旨的名稱、有效期間和簽發者的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="ebf86-118">The <xref:Microsoft.SqlServer.Management.Smo.Certificate> object has properties that specify the public key, the name of the subject, period of validity, and information about the issuer.</span></span> <span data-ttu-id="ebf86-119">存取此憑證的權限是藉由使用 `Grant`、`Revoke` 和 `Deny` 方法來控制。</span><span class="sxs-lookup"><span data-stu-id="ebf86-119">Permission to access the certificate is controlled by using the `Grant`, `Revoke` and `Deny` methods.</span></span>  
  
## <a name="example"></a><span data-ttu-id="ebf86-120">範例</span><span class="sxs-lookup"><span data-stu-id="ebf86-120">Example</span></span>  
 <span data-ttu-id="ebf86-121">在下列的程式碼範例中，您必須選取用於建立應用程式的程式設計環境、程式設計範本和程式設計語言。</span><span class="sxs-lookup"><span data-stu-id="ebf86-121">For the following code example, you will have to select the programming environment, programming template and the programming language to create your application.</span></span> <span data-ttu-id="ebf86-122">如需詳細資訊，請參閱[在 Visual Studio .net 中建立 VISUAL BASIC SMO 專案](../../../database-engine/dev-guide/create-a-visual-basic-smo-project-in-visual-studio-net.md)和[在 Visual Studio .Net 中建立 VISUAL C&#35; SMO 專案](../how-to-create-a-visual-csharp-smo-project-in-visual-studio-net.md)。</span><span class="sxs-lookup"><span data-stu-id="ebf86-122">For more information, see [Create a Visual Basic SMO Project in Visual Studio .NET](../../../database-engine/dev-guide/create-a-visual-basic-smo-project-in-visual-studio-net.md) and [Create a Visual C&#35; SMO Project in Visual Studio .NET](../how-to-create-a-visual-csharp-smo-project-in-visual-studio-net.md).</span></span>  
  
## <a name="adding-a-certificate-in-visual-basic"></a><span data-ttu-id="ebf86-123">在 Visual Basic 中加入憑證</span><span class="sxs-lookup"><span data-stu-id="ebf86-123">Adding a Certificate in Visual Basic</span></span>  
 <span data-ttu-id="ebf86-124">此程式碼範例會使用加密密碼來建立簡單的憑證。</span><span class="sxs-lookup"><span data-stu-id="ebf86-124">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="ebf86-125">不同於其他物件，<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> 方法有數個多載。</span><span class="sxs-lookup"><span data-stu-id="ebf86-125">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="ebf86-126">範例中使用的多載會利用加密密碼來建立新的憑證。</span><span class="sxs-lookup"><span data-stu-id="ebf86-126">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
<!-- TODO: review snippet reference  [!CODE [SMO How to#SMO_VBCertificate1](SMO How to#SMO_VBCertificate1)]  -->  
  
## <a name="adding-a-certificate-in-visual-c"></a><span data-ttu-id="ebf86-127">在 Visual C# 中加入憑證</span><span class="sxs-lookup"><span data-stu-id="ebf86-127">Adding a Certificate in Visual C#</span></span>  
 <span data-ttu-id="ebf86-128">此程式碼範例會使用加密密碼來建立簡單的憑證。</span><span class="sxs-lookup"><span data-stu-id="ebf86-128">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="ebf86-129">不同於其他物件，<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> 方法有數個多載。</span><span class="sxs-lookup"><span data-stu-id="ebf86-129">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="ebf86-130">範例中使用的多載會利用加密密碼來建立新的憑證。</span><span class="sxs-lookup"><span data-stu-id="ebf86-130">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
```csharp
{  
            //Connect to the local, default instance of SQL Server.   
            {  
                Server srv = new Server();  
  
                //Reference the AdventureWorks2012 database.   
                Database db = srv.Databases["AdventureWorks2012"];  
  
                //Define a Certificate object variable by supplying the parent database and name in the constructor.   
                Certificate c = new Certificate(db, "Test_Certificate");  
  
                //Set the start date, expiry date, and description.   
                System.DateTime dt;  
                DateTime.TryParse("January 01, 2010", out dt);  
                c.StartDate = dt;  
                DateTime.TryParse("January 01, 2015", out dt);  
                c.ExpirationDate = dt;  
                c.Subject = "This is a test certificate.";  
                //Create the certificate on the instance of SQL Server by supplying the certificate password argument.   
                c.Create("pGFD4bb925DGvbd2439587y");  
            }  
        }   
```  
  
## <a name="adding-a-certificate-in-powershell"></a><span data-ttu-id="ebf86-131">在 PowerShell 中加入憑證</span><span class="sxs-lookup"><span data-stu-id="ebf86-131">Adding a Certificate in PowerShell</span></span>  
 <span data-ttu-id="ebf86-132">此程式碼範例會使用加密密碼來建立簡單的憑證。</span><span class="sxs-lookup"><span data-stu-id="ebf86-132">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="ebf86-133">不同於其他物件，<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> 方法有數個多載。</span><span class="sxs-lookup"><span data-stu-id="ebf86-133">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="ebf86-134">範例中使用的多載會利用加密密碼來建立新的憑證。</span><span class="sxs-lookup"><span data-stu-id="ebf86-134">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
```powershell
# Set the path context to the local, default instance of SQL Server and get a reference to AdventureWorks2012  
CD \sql\localhost\default\databases  
$db = get-item AdventureWorks2012  
  
#Create a certificate
$c = New-Object -TypeName Microsoft.SqlServer.Management.Smo.Certificate -ArgumentList $db, "Test_Certificate"  
$c.StartDate = "January 01, 2010"  
$c.Subject = "This is a test certificate."  
$c.ExpirationDate = "January 01, 2015"  
  
#Create the certificate on the instance of SQL Server by supplying the certificate password argument.  
$c.Create("pGFD4bb925DGvbd2439587y")
```  
  
## <a name="see-also"></a><span data-ttu-id="ebf86-135">另請參閱</span><span class="sxs-lookup"><span data-stu-id="ebf86-135">See Also</span></span>  
 [<span data-ttu-id="ebf86-136">使用加密金鑰</span><span class="sxs-lookup"><span data-stu-id="ebf86-136">Using Encryption Keys</span></span>](using-encryption.md)  
