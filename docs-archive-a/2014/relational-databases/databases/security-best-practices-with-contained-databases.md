---
title: 自主資料庫的安全性最佳做法 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: security
ms.topic: conceptual
helpviewer_keywords:
- contained database, threats
ms.assetid: 026ca5fc-95da-46b6-b882-fa20f765b51d
author: stevestein
ms.author: sstein
ms.openlocfilehash: 8a4a933b99090d29f38156c56c9efa56b73af5a1
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87686975"
---
# <a name="security-best-practices-with-contained-databases"></a><span data-ttu-id="dad7a-102">自主資料庫的安全性最佳做法</span><span class="sxs-lookup"><span data-stu-id="dad7a-102">Security Best Practices with Contained Databases</span></span>
  <span data-ttu-id="dad7a-103">自主資料庫具有一些 [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] 系統管理員應該了解並降低的獨特威脅。</span><span class="sxs-lookup"><span data-stu-id="dad7a-103">Contained databases have some unique threats that should be understood and mitigated by [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] administrators.</span></span> <span data-ttu-id="dad7a-104">其中大部分威脅都與 `USER WITH PASSWORD` 驗證處理序相關，而這個處理序會將驗證界限從 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 層級移至資料庫層級。</span><span class="sxs-lookup"><span data-stu-id="dad7a-104">Most of the threats are related to the `USER WITH PASSWORD` authentication process, which moves the authentication boundary from the [!INCLUDE[ssDE](../../includes/ssde-md.md)] level to the database level.</span></span>  
  
## <a name="threats-related-to-users"></a><span data-ttu-id="dad7a-105">與使用者相關的威脅</span><span class="sxs-lookup"><span data-stu-id="dad7a-105">Threats Related to Users</span></span>  
 <span data-ttu-id="dad7a-106">自主資料庫中具有許可權的使用者（ `ALTER ANY USER` 例如**db_owner**和**db_securityadmin**固定資料庫角色的成員）可以授與資料庫的存取權，而不需具備系統管理員的知識或許可權 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="dad7a-106">Users in a contained database that have the `ALTER ANY USER` permission, such as members of the **db_owner** and **db_securityadmin** fixed database roles, can grant access to the database without the knowledge or permission if the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrator.</span></span> <span data-ttu-id="dad7a-107">將自主資料庫的存取權授與使用者會針對整個 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 執行個體增加潛在的攻擊面區域。</span><span class="sxs-lookup"><span data-stu-id="dad7a-107">Granting users access to a contained database increases the potential attack surface area against the whole [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span> <span data-ttu-id="dad7a-108">系統管理員應該了解此存取控制的委派，並且非常謹慎地將 `ALTER ANY USER` 權限授與自主資料庫中的使用者。</span><span class="sxs-lookup"><span data-stu-id="dad7a-108">Administrators should understand this delegation of access control, and be very careful about granting users in the contained database the `ALTER ANY USER` permission.</span></span> <span data-ttu-id="dad7a-109">所有資料庫擁有者都擁有 `ALTER ANY USER` 權限。</span><span class="sxs-lookup"><span data-stu-id="dad7a-109">All database owners have the `ALTER ANY USER` permission.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="dad7a-110">系統管理員應定期稽核自主資料庫中的使用者。</span><span class="sxs-lookup"><span data-stu-id="dad7a-110">administrators should periodically audit the users in a contained database.</span></span>  
  
### <a name="accessing-other-databases-using-the-guest-account"></a><span data-ttu-id="dad7a-111">使用 Guest 帳戶來存取其他資料庫</span><span class="sxs-lookup"><span data-stu-id="dad7a-111">Accessing Other Databases Using the guest Account</span></span>  
 <span data-ttu-id="dad7a-112">擁有 `ALTER ANY USER` 權限的資料庫擁有者與資料庫使用者可以建立自主資料庫使用者。</span><span class="sxs-lookup"><span data-stu-id="dad7a-112">Database owners and database users with the `ALTER ANY USER` permission can create contained database users.</span></span> <span data-ttu-id="dad7a-113">連接至 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]執行個體上之自主資料庫之後，如果 [!INCLUDE[ssDE](../../includes/ssde-md.md)]上的其他資料庫已啟用 **Guest** 帳戶，自主資料庫使用者就可以存取其他資料庫。</span><span class="sxs-lookup"><span data-stu-id="dad7a-113">After connecting to a contained database on an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], a contained database user can access other databases on the [!INCLUDE[ssDE](../../includes/ssde-md.md)], if the other databases have enabled the **guest** account.</span></span>  
  
### <a name="creating-a-duplicate-user-in-another-database"></a><span data-ttu-id="dad7a-114">在另一個資料庫中建立重複的使用者</span><span class="sxs-lookup"><span data-stu-id="dad7a-114">Creating a Duplicate User in Another Database</span></span>  
 <span data-ttu-id="dad7a-115">某些應用程式可能會要求使用者擁有多個資料庫的存取權。</span><span class="sxs-lookup"><span data-stu-id="dad7a-115">Some applications might require that a user to have access to more than one database.</span></span> <span data-ttu-id="dad7a-116">只要在每個資料庫中建立相同的自主資料庫使用者，即可完成此作業。</span><span class="sxs-lookup"><span data-stu-id="dad7a-116">This can be done by creating identical contained database users in each database.</span></span> <span data-ttu-id="dad7a-117">建立第二位使用者與密碼時，請使用 SID 選項。</span><span class="sxs-lookup"><span data-stu-id="dad7a-117">Use the SID option when creating the second user with password.</span></span> <span data-ttu-id="dad7a-118">下列範例會在兩個資料庫中建立兩位相同的使用者。</span><span class="sxs-lookup"><span data-stu-id="dad7a-118">The following example creates two identical users in two databases.</span></span>  
  
```  
USE DB1;  
GO  
CREATE USER Carlo WITH PASSWORD = '<strong password>';   
-- Return the SID of the user  
SELECT SID FROM sys.database_principals WHERE name = 'Carlo';  
  
-- Change to the second database  
USE DB2;  
GO  
CREATE USER Carlo WITH PASSWORD = '<same password>', SID = <SID from DB1>;  
GO  
```  
  
 <span data-ttu-id="dad7a-119">若要執行跨資料庫查詢，您必須針對呼叫的資料庫設定 `TRUSTWORTHY` 選項。</span><span class="sxs-lookup"><span data-stu-id="dad7a-119">To execute a cross-database query, you must set the `TRUSTWORTHY` option on the calling database.</span></span> <span data-ttu-id="dad7a-120">例如，如果上述定義的使用者 (Carlo) 位於 DB1 中，為了執行 `SELECT * FROM db2.dbo.Table1;`，則必須開啟資料庫 DB1 的 `TRUSTWORTHY` 設定。</span><span class="sxs-lookup"><span data-stu-id="dad7a-120">For example if the user (Carlo) defined above is in DB1, to execute `SELECT * FROM db2.dbo.Table1;` then the `TRUSTWORTHY` setting must be on for database DB1.</span></span> <span data-ttu-id="dad7a-121">請執行下列程式碼，將 `TRUSTWORHTY` 設定設為開啟。</span><span class="sxs-lookup"><span data-stu-id="dad7a-121">Execute the following code to set the `TRUSTWORHTY` setting on.</span></span>  
  
```  
ALTER DATABASE DB1 SET TRUSTWORTHY ON;  
```  
  
### <a name="creating-a-user-that-duplicates-a-login"></a><span data-ttu-id="dad7a-122">建立重複登入的使用者</span><span class="sxs-lookup"><span data-stu-id="dad7a-122">Creating a User that Duplicates a Login</span></span>  
 <span data-ttu-id="dad7a-123">如果您使用與 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登入相同的名稱來建立具有密碼之自主資料庫使用者，而且 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登入連接時指定自主資料庫做為初始目錄，則 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登入將無法連接。</span><span class="sxs-lookup"><span data-stu-id="dad7a-123">If a contained database user with password is created, using the same name as a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login, and if the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login connects specifying the contained database as the initial catalog, then the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login will be unable to connect.</span></span> <span data-ttu-id="dad7a-124">系統會將此連接評估為自主資料庫上具有密碼主體之自主資料庫使用者，而不是以 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登入為基礎的使用者。</span><span class="sxs-lookup"><span data-stu-id="dad7a-124">The connection will be evaluated as the contained database user with password principal on the contained database instead of as a user based on the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login.</span></span> <span data-ttu-id="dad7a-125">這可能會導致系統蓄意或意外阻斷 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登入的服務。</span><span class="sxs-lookup"><span data-stu-id="dad7a-125">This could cause an intentional or accidental denial of service for the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login.</span></span>  
  
-   <span data-ttu-id="dad7a-126">最佳作法是系統管理員 ( **sysadmin** ) 固定伺服器角色的成員應該考慮永遠不使用初始目錄選項來連接。</span><span class="sxs-lookup"><span data-stu-id="dad7a-126">As a best practice, members of the **sysadmin** fixed server role should consider always connecting without using the initial catalog option.</span></span> <span data-ttu-id="dad7a-127">這樣會將登入連接至 master 資料庫，並且避免資料庫擁有者濫用登入嘗試的任何嘗試行為。</span><span class="sxs-lookup"><span data-stu-id="dad7a-127">This connects the login to the master database and avoids any attempts by a database owner to misuse the login attempt.</span></span> <span data-ttu-id="dad7a-128">然後，系統管理員可以使用語句來變更為自主資料庫 `USE` *\<database>* 。</span><span class="sxs-lookup"><span data-stu-id="dad7a-128">Then the administrator can change to the contained database by using the `USE`*\<database>* statement.</span></span> <span data-ttu-id="dad7a-129">此外，您也可以將登入的預設資料庫設定為自主資料庫，以便完成登入 **master**的作業，然後將登入傳送至自主資料庫。</span><span class="sxs-lookup"><span data-stu-id="dad7a-129">You can also set the default database of the login to the contained database, which completes the login to **master**, and then transfers the login to the contained database.</span></span>  
  
-   <span data-ttu-id="dad7a-130">最佳作法是不要使用具有密碼且與 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登入具有相同名稱之自主資料庫使用者。</span><span class="sxs-lookup"><span data-stu-id="dad7a-130">As a best practice, do not create contained database users with passwords who have the same name as [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] logins.</span></span>  
  
-   <span data-ttu-id="dad7a-131">如果存在重複的登入，請連接至**master**資料庫而不指定初始目錄，然後執行 `USE` 命令來變更為自主資料庫。</span><span class="sxs-lookup"><span data-stu-id="dad7a-131">If the duplicate login exists, connect to the **master** database without specifying an initial catalog, and then execute the `USE` command to change to the contained database.</span></span>  
  
-   <span data-ttu-id="dad7a-132">當自主資料庫存在時，非自主資料庫的資料庫使用者應該連接至 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 而不使用初始目錄，或指定非自主資料庫的資料庫名稱做為初始目錄。</span><span class="sxs-lookup"><span data-stu-id="dad7a-132">When contained databases are present, users of databases that are not contained databases should connect to the [!INCLUDE[ssDE](../../includes/ssde-md.md)] without using an initial catalog or by specifying the database name of a non-contained database as the initial catalog.</span></span> <span data-ttu-id="dad7a-133">這樣可避免連接至 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 系統管理員直接控制權較低之自主資料庫。</span><span class="sxs-lookup"><span data-stu-id="dad7a-133">This avoids connecting to the contained database which is under less direct control by the [!INCLUDE[ssDE](../../includes/ssde-md.md)] administrators.</span></span>  
  
### <a name="increasing-access-by-changing-the-containment-status-of-a-database"></a><span data-ttu-id="dad7a-134">變更資料庫的內含項目狀態來提高存取權</span><span class="sxs-lookup"><span data-stu-id="dad7a-134">Increasing Access by Changing the Containment Status of a Database</span></span>  
 <span data-ttu-id="dad7a-135">具有許可權的登入（ `ALTER ANY DATABASE` 例如**dbcreator**固定伺服器角色的成員），以及具有許可權之非自主資料庫中的使用者（ `CONTROL DATABASE` 例如**db_owner**固定資料庫角色的成員），可以變更資料庫的內含專案設定。</span><span class="sxs-lookup"><span data-stu-id="dad7a-135">Logins that have the `ALTER ANY DATABASE` permission, such as members of the **dbcreator** fixed server role, and users in a non-contained database that have the `CONTROL DATABASE` permission, such as members of the **db_owner** fixed database role, can change the containment setting of a database.</span></span> <span data-ttu-id="dad7a-136">如果資料庫的內含項目設定從 `NONE` 變更為 `PARTIAL` 或 `FULL`，您就可以透過建立具有密碼之自主資料庫使用者，授與使用者存取權。</span><span class="sxs-lookup"><span data-stu-id="dad7a-136">If the containment setting of a database is changed from `NONE` to either `PARTIAL` or `FULL`, then user access can be granted by creating contained database users with passwords.</span></span> <span data-ttu-id="dad7a-137">這樣可能會在未經 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 系統管理員認可或同意的情況下提供存取權。</span><span class="sxs-lookup"><span data-stu-id="dad7a-137">This could provide access without the knowledge or consent of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrators.</span></span> <span data-ttu-id="dad7a-138">若要防止包含任何資料庫，請將 [!INCLUDE[ssDE](../../includes/ssde-md.md)] `contained database authentication` 選項設定為0。</span><span class="sxs-lookup"><span data-stu-id="dad7a-138">To prevent any databases from being contained, set the [!INCLUDE[ssDE](../../includes/ssde-md.md)]`contained database authentication` option to 0.</span></span> <span data-ttu-id="dad7a-139">若要針對選取之自主資料庫防止具有密碼之自主資料庫使用者連接，請使用登入觸發程序來取消具有密碼之自主資料庫使用者所進行的登入嘗試。</span><span class="sxs-lookup"><span data-stu-id="dad7a-139">To prevent connections by contained database users with passwords on selected contained databases, use login triggers to cancel login attempts by contained database users with passwords.</span></span>  
  
### <a name="attaching-a-contained-database"></a><span data-ttu-id="dad7a-140">附加自主資料庫</span><span class="sxs-lookup"><span data-stu-id="dad7a-140">Attaching a Contained Database</span></span>  
 <span data-ttu-id="dad7a-141">透過附加自主資料庫，系統管理員可能會將 [!INCLUDE[ssDE](../../includes/ssde-md.md)]執行個體的存取權提供給不想要的使用者。</span><span class="sxs-lookup"><span data-stu-id="dad7a-141">By attaching a contained database, an administrator could give unwanted users access to the instance of the [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span> <span data-ttu-id="dad7a-142">擔心這項風險的系統管理員可以在 `RESTRICTED_USER` 模式下讓資料庫上線，以便防止系統驗證具有密碼之自主資料庫使用者。</span><span class="sxs-lookup"><span data-stu-id="dad7a-142">An administrator concerned about this risk can bring the database online in `RESTRICTED_USER` mode, which prevents authentication for contained database users with passwords.</span></span> <span data-ttu-id="dad7a-143">此時，只有透過登入授權的主體才能存取 [!INCLUDE[ssDE](../../includes/ssde-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="dad7a-143">Only principals authorized through logins will be able to access the [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span>  
  
 <span data-ttu-id="dad7a-144">建立使用者時所使用的密碼需求會在建立時生效，而且系統不會在附加資料庫時重新檢查密碼。</span><span class="sxs-lookup"><span data-stu-id="dad7a-144">Users are created using the password requirements in effect at the time that they are created and passwords are not rechecked when a database is attached.</span></span> <span data-ttu-id="dad7a-145">透過將允許弱式密碼之自主資料庫附加至密碼原則更嚴格的系統，系統管理員可能會允許不符合附加 [!INCLUDE[ssDE](../../includes/ssde-md.md)]之目前密碼原則的密碼。</span><span class="sxs-lookup"><span data-stu-id="dad7a-145">By attaching a contained database which allowed weak passwords to a system with a stricter password policy, an administrator could permit passwords that do not meet the current password policy on the attaching [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span> <span data-ttu-id="dad7a-146">系統管理員可以要求針對附加的資料庫重設所有密碼，藉以避免保留弱式密碼。</span><span class="sxs-lookup"><span data-stu-id="dad7a-146">Administrators can avoid retaining the weak passwords by requiring that all passwords be reset for the attached database.</span></span>  
  
### <a name="password-policies"></a><span data-ttu-id="dad7a-147">密碼原則</span><span class="sxs-lookup"><span data-stu-id="dad7a-147">Password Policies</span></span>  
 <span data-ttu-id="dad7a-148">資料庫中的密碼可能必須是強式密碼，但不受強固的密碼原則所保護。</span><span class="sxs-lookup"><span data-stu-id="dad7a-148">Passwords in a database can be required to be strong passwords, but cannot be protected by robust password policies.</span></span> <span data-ttu-id="dad7a-149">若要運用 Windows 所提供的更廣泛密碼原則，請盡可能使用 Windows 驗證。</span><span class="sxs-lookup"><span data-stu-id="dad7a-149">Use Windows Authentication whenever possible to take advantage of the more extensive password policies available from Windows.</span></span>  
  
### <a name="kerberos-authentication"></a><span data-ttu-id="dad7a-150">Kerberos 驗證</span><span class="sxs-lookup"><span data-stu-id="dad7a-150">Kerberos Authentication</span></span>  
 <span data-ttu-id="dad7a-151">具有密碼之自主資料庫使用者無法使用 Kerberos 驗證。</span><span class="sxs-lookup"><span data-stu-id="dad7a-151">Contained database users with passwords cannot use Kerberos Authentication.</span></span> <span data-ttu-id="dad7a-152">請盡可能使用 Windows 驗證來運用 Kerberos 等 Windows 功能。</span><span class="sxs-lookup"><span data-stu-id="dad7a-152">When possible, use Windows Authentication to take advantage of Windows features such as Kerberos.</span></span>  
  
### <a name="offline-dictionary-attack"></a><span data-ttu-id="dad7a-153">離線字典攻擊</span><span class="sxs-lookup"><span data-stu-id="dad7a-153">Offline Dictionary Attack</span></span>  
 <span data-ttu-id="dad7a-154">具有密碼之自主資料庫使用者的密碼雜湊會儲存在自主資料庫中。</span><span class="sxs-lookup"><span data-stu-id="dad7a-154">The password hashes for contained database users with passwords are stored in the contained database.</span></span> <span data-ttu-id="dad7a-155">擁有資料庫檔案之存取權的任何人都可以針對未稽核系統上具有密碼之自主資料庫使用者執行字典攻擊。</span><span class="sxs-lookup"><span data-stu-id="dad7a-155">Anyone with access to the database files could perform a dictionary attack against the contained database users with passwords on an unaudited system.</span></span> <span data-ttu-id="dad7a-156">若要降低這項威脅，請限制資料庫檔案的存取權，或是只允許使用 Windows 驗證來連接至自主資料庫。</span><span class="sxs-lookup"><span data-stu-id="dad7a-156">To mitigate this threat, restrict access to the database files, or only permit connections to contained databases by using Windows Authentication.</span></span>  
  
## <a name="escaping-a-contained-database"></a><span data-ttu-id="dad7a-157">逸出自主資料庫</span><span class="sxs-lookup"><span data-stu-id="dad7a-157">Escaping a Contained Database</span></span>  
 <span data-ttu-id="dad7a-158">如果資料庫處於部分自主狀態， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 系統管理員就應該定期稽核自主資料庫中使用者和模組的功能。</span><span class="sxs-lookup"><span data-stu-id="dad7a-158">If a database is partially contained, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrators should periodically audit the capabilities of the users and modules in contained databases.</span></span>  
  
## <a name="denial-of-service-through-auto_close"></a><span data-ttu-id="dad7a-159">透過 AUTO_CLOSE 阻斷服務</span><span class="sxs-lookup"><span data-stu-id="dad7a-159">Denial of Service Through AUTO_CLOSE</span></span>  
 <span data-ttu-id="dad7a-160">請勿將自主資料庫設定為自動關閉。</span><span class="sxs-lookup"><span data-stu-id="dad7a-160">Do not configure contained databases to auto close.</span></span> <span data-ttu-id="dad7a-161">如果已關閉，開啟資料庫來驗證使用者會耗用額外的資源，而且可能會導致阻斷服務攻擊。</span><span class="sxs-lookup"><span data-stu-id="dad7a-161">If closed, opening the database to authenticate a user consumes additional resources and could contribute to a denial of service attack.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="dad7a-162">另請參閱</span><span class="sxs-lookup"><span data-stu-id="dad7a-162">See Also</span></span>  
 <span data-ttu-id="dad7a-163">[自主資料庫](contained-databases.md) </span><span class="sxs-lookup"><span data-stu-id="dad7a-163">[Contained Databases](contained-databases.md) </span></span>  
 [<span data-ttu-id="dad7a-164">移轉至部分自主資料庫</span><span class="sxs-lookup"><span data-stu-id="dad7a-164">Migrate to a Partially Contained Database</span></span>](migrate-to-a-partially-contained-database.md)  
  
  
