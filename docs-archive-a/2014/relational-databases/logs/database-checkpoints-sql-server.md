---
title: 資料庫檢查點 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 10/13/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- automatic checkpoints
- transaction logs [SQL Server], checkpoints
- logs [SQL Server], active
- pages [SQL Server], dirty
- MinLSN
- checkpoints [SQL Server]
- pages [SQL Server], flushing
- dirty pages
- transaction logs [SQL Server], active logs
- recovery interval option [SQL Server]
- buffer cache [SQL Server]
- logs [SQL Server], checkpoints
- Minimum Recovery LSN
- flushing pages
- active logs
ms.assetid: 98a80238-7409-4708-8a7d-5defd9957185
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 5776d4a23223637c50ac40098fa44342d5cd94a9
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87594544"
---
# <a name="database-checkpoints-sql-server"></a><span data-ttu-id="4cea7-102">資料庫檢查點 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="4cea7-102">Database Checkpoints (SQL Server)</span></span>
  <span data-ttu-id="4cea7-103">本主題提供 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 資料庫檢查點的概觀。</span><span class="sxs-lookup"><span data-stu-id="4cea7-103">This topic provides an overview of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database checkpoints.</span></span> <span data-ttu-id="4cea7-104">*「檢查點」* (Checkpoint) 會建立一個已知的恰當起點， [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] 可以從這個點開始套用發生非預期的關機或損毀之後，於復原期間包含在記錄檔中的變更。</span><span class="sxs-lookup"><span data-stu-id="4cea7-104">A *checkpoint* creates a known good point from which the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] can start applying changes contained in the log during recovery after an unexpected shutdown or crash.</span></span>  
  
  
##  <a name="overview-of-checkpoints"></a><a name="Overview"></a><span data-ttu-id="4cea7-105">檢查點的總覽</span><span class="sxs-lookup"><span data-stu-id="4cea7-105">Overview of Checkpoints</span></span>  
 <span data-ttu-id="4cea7-106">基於效能的考量，[!INCLUDE[ssDE](../../includes/ssde-md.md)]會在緩衝區快取的記憶體內修改資料庫頁面，但並不會在每次變更之後都將這些頁面寫入磁碟中。</span><span class="sxs-lookup"><span data-stu-id="4cea7-106">For performance reasons, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] performs modifications to database pages in memory-in the buffer cache-and does not write these pages to disk after every change.</span></span> <span data-ttu-id="4cea7-107">而是由 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 定期在每一個資料庫上發出檢查點。</span><span class="sxs-lookup"><span data-stu-id="4cea7-107">Rather, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] periodically issues a checkpoint on each database.</span></span> <span data-ttu-id="4cea7-108">*「檢查點」* (Checkpoint) 會將目前記憶體中已修改的頁面 (稱為 *「中途分頁」*(Dirty Page)) 和交易記錄資訊從記憶體寫入磁碟上，也會記錄有關交易記錄的資訊。</span><span class="sxs-lookup"><span data-stu-id="4cea7-108">A *checkpoint* writes the current in-memory modified pages (known as *dirty pages*) and transaction log information from memory to disk and, also, records information about the transaction log.</span></span>  
  
 <span data-ttu-id="4cea7-109">[!INCLUDE[ssDE](../../includes/ssde-md.md)] 支援幾種類型的檢查點：自動、間接、手動和內部。</span><span class="sxs-lookup"><span data-stu-id="4cea7-109">The [!INCLUDE[ssDE](../../includes/ssde-md.md)] supports several types of checkpoints: automatic, indirect, manual, and internal.</span></span> <span data-ttu-id="4cea7-110">下表彙總檢查點的類型。</span><span class="sxs-lookup"><span data-stu-id="4cea7-110">The following table summarizes the types of checkpoints.</span></span>  
  
|<span data-ttu-id="4cea7-111">名稱</span><span class="sxs-lookup"><span data-stu-id="4cea7-111">Name</span></span>|[!INCLUDE[tsql](../../includes/tsql-md.md)] <span data-ttu-id="4cea7-112">介面</span><span class="sxs-lookup"><span data-stu-id="4cea7-112">Interface</span></span>|<span data-ttu-id="4cea7-113">描述</span><span class="sxs-lookup"><span data-stu-id="4cea7-113">Description</span></span>|  
|----------|----------------------------------|-----------------|  
|<span data-ttu-id="4cea7-114">自動</span><span class="sxs-lookup"><span data-stu-id="4cea7-114">Automatic</span></span>|<span data-ttu-id="4cea7-115">EXEC sp_configure **' `recovery interval` '，' *`seconds`* '**</span><span class="sxs-lookup"><span data-stu-id="4cea7-115">EXEC sp_configure **'`recovery interval`','*`seconds`*'**</span></span>|<span data-ttu-id="4cea7-116">在背景自動發出，以符合伺服器設定選項所建議的時間上限 `recovery interval` 。</span><span class="sxs-lookup"><span data-stu-id="4cea7-116">Issued automatically in the background to meet the upper time limit suggested by the `recovery interval` server configuration option.</span></span> <span data-ttu-id="4cea7-117">自動檢查點會執行到完成為止。</span><span class="sxs-lookup"><span data-stu-id="4cea7-117">Automatic checkpoints run to completion.</span></span>  <span data-ttu-id="4cea7-118">自動檢查點的調節是根據未完成的寫入數目以及 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 是否偵測到超過 20 毫秒的寫入延遲有增加。</span><span class="sxs-lookup"><span data-stu-id="4cea7-118">Automatic checkpoints are throttled based on the number of outstanding writes and whether the [!INCLUDE[ssDE](../../includes/ssde-md.md)] detects an increase in write latency above 20 milliseconds.</span></span><br /><br /> <span data-ttu-id="4cea7-119">如需詳細資訊，請參閱 [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)。</span><span class="sxs-lookup"><span data-stu-id="4cea7-119">For more information, see [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).</span></span>|  
|<span data-ttu-id="4cea7-120">間接</span><span class="sxs-lookup"><span data-stu-id="4cea7-120">Indirect</span></span>|<span data-ttu-id="4cea7-121">ALTER DATABASE .。。設定 TARGET_RECOVERY_TIME **=** _target_recovery_time_ {秒數 &#124; 分鐘}</span><span class="sxs-lookup"><span data-stu-id="4cea7-121">ALTER DATABASE ... SET TARGET_RECOVERY_TIME **=**_target_recovery_time_ { SECONDS &#124; MINUTES }</span></span>|<span data-ttu-id="4cea7-122">在背景發出，以符合使用者對給定資料庫所指定的目標復原時間。</span><span class="sxs-lookup"><span data-stu-id="4cea7-122">Issued in the background to meet a user-specified target recovery time for a given database.</span></span> <span data-ttu-id="4cea7-123">預設目標復原時間為 0，這會導致自動檢查點啟發學習法在資料庫上使用。</span><span class="sxs-lookup"><span data-stu-id="4cea7-123">The default target recovery time is 0, which causes automatic checkpoint heuristics to be used on the database.</span></span> <span data-ttu-id="4cea7-124">如果您已使用 ALTER DATABASE 將 TARGET_RECOVERY_TIME 設定為 >0，則會使用這個值，而不是針對伺服器執行個體指定的復原間隔。</span><span class="sxs-lookup"><span data-stu-id="4cea7-124">If you have used ALTER DATABASE to set TARGET_RECOVERY_TIME to >0, this value is used, rather than the recovery interval specified for the server instance.</span></span><br /><br /> <span data-ttu-id="4cea7-125">如需詳細資訊，請參閱 [變更資料庫的目標復原時間 &#40;SQL Server&#41;](change-the-target-recovery-time-of-a-database-sql-server.md)伺服器組態選項。</span><span class="sxs-lookup"><span data-stu-id="4cea7-125">For more information, see [Change the Target Recovery Time of a Database &#40;SQL Server&#41;](change-the-target-recovery-time-of-a-database-sql-server.md).</span></span>|  
|<span data-ttu-id="4cea7-126">手動</span><span class="sxs-lookup"><span data-stu-id="4cea7-126">Manual</span></span>|<span data-ttu-id="4cea7-127">CHECKPOINT [ *checkpoint_duration* ]</span><span class="sxs-lookup"><span data-stu-id="4cea7-127">CHECKPOINT [ *checkpoint_duration* ]</span></span>|<span data-ttu-id="4cea7-128">當您執行 [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT 命令時發出。</span><span class="sxs-lookup"><span data-stu-id="4cea7-128">Issued when you execute a [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT command.</span></span> <span data-ttu-id="4cea7-129">手動檢查點會發生在連接的目前資料庫中。</span><span class="sxs-lookup"><span data-stu-id="4cea7-129">The manual checkpoint occurs in the current database for your connection.</span></span> <span data-ttu-id="4cea7-130">根據預設，手動檢查點會執行到完成為止。</span><span class="sxs-lookup"><span data-stu-id="4cea7-130">By default, manual checkpoints run to completion.</span></span> <span data-ttu-id="4cea7-131">調節的運作方式與自動檢查點相同。</span><span class="sxs-lookup"><span data-stu-id="4cea7-131">Throttling works the same way as for automatic checkpoints.</span></span>  <span data-ttu-id="4cea7-132">*checkpoint_duration* 參數可選擇性地指定要求的時間量 (以秒為單位)，好讓檢查點得以完成。</span><span class="sxs-lookup"><span data-stu-id="4cea7-132">Optionally, the *checkpoint_duration* parameter specifies a requested amount of time, in seconds, for the checkpoint to complete.</span></span><br /><br /> <span data-ttu-id="4cea7-133">如需詳細資訊，請參閱 [CHECKPOINT &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/checkpoint-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="4cea7-133">For more information, see [CHECKPOINT &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/checkpoint-transact-sql).</span></span>|  
|<span data-ttu-id="4cea7-134">內部</span><span class="sxs-lookup"><span data-stu-id="4cea7-134">Internal</span></span>|<span data-ttu-id="4cea7-135">無。</span><span class="sxs-lookup"><span data-stu-id="4cea7-135">None.</span></span>|<span data-ttu-id="4cea7-136">由各種伺服器作業 (例如備份和資料庫快照集建立) 發出，以保證磁碟映像符合目前的記錄檔狀態。</span><span class="sxs-lookup"><span data-stu-id="4cea7-136">Issued by various server operations such as backup and database-snapshot creation to guarantee that disk images match the current state of the log.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="4cea7-137">資料庫管理員可利用 `-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 進階設定選項，根據某些類型的檢查點之 I/O 子系統輸送量，來調節檢查點 I/O 行為。</span><span class="sxs-lookup"><span data-stu-id="4cea7-137">The `-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] advanced setup option enables a database administrator to throttle checkpoint I/O behavior based on the throughput of the I/O subsystem for some types of checkpoints.</span></span> <span data-ttu-id="4cea7-138">`-k`安裝程式選項適用于自動檢查點，以及任何其他調節的手動和內部檢查點。</span><span class="sxs-lookup"><span data-stu-id="4cea7-138">The `-k` setup option applies to automatic checkpoints and any otherwise unthrottled manual and internal checkpoints.</span></span>  
  
 <span data-ttu-id="4cea7-139">如果是自動、手動和內部檢查點，只有在最新檢查點之後所做的修改才需要在資料庫復原期間向前復原。</span><span class="sxs-lookup"><span data-stu-id="4cea7-139">For automatic, manual, and internal checkpoints, only modifications made after the latest checkpoint need to be rolled forward during database recovery.</span></span> <span data-ttu-id="4cea7-140">這會減少復原資料庫所需的時間。</span><span class="sxs-lookup"><span data-stu-id="4cea7-140">This reduces the time required to recover a database.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="4cea7-141">長時間執行且未認可的交易會讓所有檢查點類型的復原時間增加。</span><span class="sxs-lookup"><span data-stu-id="4cea7-141">Long-running uncommitted transactions increase recovery time for all types of checkpoints.</span></span>  
  
  
  
###  <a name="interaction-of-the-target_recovery_time-and-recovery-interval-options"></a><a name="InteractionBwnSettings"></a> <span data-ttu-id="4cea7-142">TARGET_RECOVERY_TIME 和 'recovery interval' 選項的互動</span><span class="sxs-lookup"><span data-stu-id="4cea7-142">Interaction of the TARGET_RECOVERY_TIME and 'recovery interval' Options</span></span>  
 <span data-ttu-id="4cea7-143">下表摘要說明伺服器範圍**sp_configure ' `recovery interval` '** 設定與資料庫特有的 ALTER database 之間的互動 .。。TARGET_RECOVERY_TIME 設定。</span><span class="sxs-lookup"><span data-stu-id="4cea7-143">The following table summarizes the interaction between the server-wide **sp_configure'`recovery interval`'** setting and the database-specific ALTER DATABASE ... TARGET_RECOVERY_TIME setting.</span></span>  
  
|<span data-ttu-id="4cea7-144">target_recovery_time</span><span class="sxs-lookup"><span data-stu-id="4cea7-144">TARGET_RECOVERY_TIME</span></span>|<span data-ttu-id="4cea7-145">'recovery interval'</span><span class="sxs-lookup"><span data-stu-id="4cea7-145">'recovery interval'</span></span>|<span data-ttu-id="4cea7-146">使用的檢查點類型</span><span class="sxs-lookup"><span data-stu-id="4cea7-146">Type of Checkpoint Used</span></span>|  
|----------------------------|-------------------------|-----------------------------|  
|<span data-ttu-id="4cea7-147">0</span><span class="sxs-lookup"><span data-stu-id="4cea7-147">0</span></span>|<span data-ttu-id="4cea7-148">0</span><span class="sxs-lookup"><span data-stu-id="4cea7-148">0</span></span>|<span data-ttu-id="4cea7-149">目標復原間隔為 1 分鐘的自動檢查點。</span><span class="sxs-lookup"><span data-stu-id="4cea7-149">automatic checkpoints whose target recovery interval is 1 minute.</span></span>|  
|<span data-ttu-id="4cea7-150">0</span><span class="sxs-lookup"><span data-stu-id="4cea7-150">0</span></span>|<span data-ttu-id="4cea7-151">>0</span><span class="sxs-lookup"><span data-stu-id="4cea7-151">>0</span></span>|<span data-ttu-id="4cea7-152">由使用者定義的 **sp_configurerecovery interval** 選項設定，所指定的目標復原間隔之自動檢查點。</span><span class="sxs-lookup"><span data-stu-id="4cea7-152">Automatic checkpoints whose target recovery interval is specified by the user defined setting of the **sp_configurerecovery interval** option.</span></span>|  
|<span data-ttu-id="4cea7-153">>0</span><span class="sxs-lookup"><span data-stu-id="4cea7-153">>0</span></span>|<span data-ttu-id="4cea7-154">不適用。</span><span class="sxs-lookup"><span data-stu-id="4cea7-154">Not applicable.</span></span>|<span data-ttu-id="4cea7-155">由 TARGET_RECOVERY_TIME 設定決定目標復原時間 (以秒鐘表示) 的間接檢查點。</span><span class="sxs-lookup"><span data-stu-id="4cea7-155">Indirect checkpoints whose target recovery time is determined by the TARGET_RECOVERY_TIME setting, expressed in seconds.</span></span>|  
  
###  <a name="automatic-checkpoints"></a><a name="AutomaticChkpt"></a><span data-ttu-id="4cea7-156">自動檢查點</span><span class="sxs-lookup"><span data-stu-id="4cea7-156">Automatic Checkpoints</span></span>  
 <span data-ttu-id="4cea7-157">每次記錄檔記錄數目到達 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 預估它在伺服器設定選項中指定的時間內可以處理的數目時，就會發生自動檢查點 `recovery interval` 。</span><span class="sxs-lookup"><span data-stu-id="4cea7-157">An automatic checkpoint occurs each time that  the number of log records reaches the number the [!INCLUDE[ssDE](../../includes/ssde-md.md)] estimates it can process during the time specified in the `recovery interval` server configuration option.</span></span> <span data-ttu-id="4cea7-158">在沒有使用者定義之目標復原時間的每個資料庫中， [!INCLUDE[ssDE](../../includes/ssde-md.md)] 都會產生自動檢查點。</span><span class="sxs-lookup"><span data-stu-id="4cea7-158">In every database without a user-defined target recovery time, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] generates automatic checkpoints.</span></span> <span data-ttu-id="4cea7-159">自動檢查點的頻率取決於 `recovery interval` advanced server configuration 選項，它會指定給定伺服器實例在系統重新開機期間應該用來復原資料庫的最長時間。</span><span class="sxs-lookup"><span data-stu-id="4cea7-159">The frequency of automatic checkpoints depends on the `recovery interval` advanced server configuration option, which specifies the maximum time that a given server instance should use to recover a database during a system restart.</span></span> <span data-ttu-id="4cea7-160">[!INCLUDE[ssDE](../../includes/ssde-md.md)] 會預估它在復原間隔內可以處理的記錄檔記錄數目上限。</span><span class="sxs-lookup"><span data-stu-id="4cea7-160">The [!INCLUDE[ssDE](../../includes/ssde-md.md)] estimates the maximum number of log records it can process within the recovery interval.</span></span> <span data-ttu-id="4cea7-161">當使用自動檢查點的資料庫到達這個記錄檔數目上限時， [!INCLUDE[ssDE](../../includes/ssde-md.md)] 會發出資料庫的檢查點。</span><span class="sxs-lookup"><span data-stu-id="4cea7-161">When a database that is using automatic checkpoints reaches this maximum number of log records, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] issues an checkpoint on the database.</span></span> <span data-ttu-id="4cea7-162">自動檢查點之間的時間間隔可能會有很大的變化。</span><span class="sxs-lookup"><span data-stu-id="4cea7-162">The time interval between automatic checkpoints can be highly variable.</span></span> <span data-ttu-id="4cea7-163">具有大量交易工作負載的資料庫所擁有的檢查點會比主要用於唯讀作業的資料庫更頻繁。</span><span class="sxs-lookup"><span data-stu-id="4cea7-163">A database with a substantial transaction workload will have more frequent checkpoints than a database that is used primarily for read-only operations.</span></span>  
  
 <span data-ttu-id="4cea7-164">此外，在簡單復原模式下，如果記錄檔已填滿百分之 70，則自動檢查點也會排入佇列。</span><span class="sxs-lookup"><span data-stu-id="4cea7-164">Also, under the simple recovery model, an automatic checkpoint is also queued if the log becomes 70 percent full.</span></span>  
  
 <span data-ttu-id="4cea7-165">在簡單復原模式下，除非某些因素延遲了記錄截斷，否則自動檢查點會截斷交易記錄的未使用區段。</span><span class="sxs-lookup"><span data-stu-id="4cea7-165">Under the simple recovery model, unless some factor is delaying log truncation, an automatic checkpoint truncates the unused section of the transaction log.</span></span> <span data-ttu-id="4cea7-166">相反地，在完整復原模式和大量記錄復原模式下，一旦建立了記錄備份鏈，自動檢查點就不會導致記錄截斷。</span><span class="sxs-lookup"><span data-stu-id="4cea7-166">In contrast, under the full and bulk-logged recovery models, once a log backup chain has been established, automatic checkpoints do not cause log truncation.</span></span> <span data-ttu-id="4cea7-167">如需詳細資訊，請參閱 [交易記錄 &#40;SQL Server&#41;](the-transaction-log-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="4cea7-167">For more information, see [The Transaction Log &#40;SQL Server&#41;](the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="4cea7-168">當系統損壞時，復原給定資料庫所需的時間長度大部分取決於重做損壞時已變更之頁面所需的隨機 I/O 數量。</span><span class="sxs-lookup"><span data-stu-id="4cea7-168">After a system crash, the length of time required to recover a given database is largely dependent on the amount of random I/O needed to redo pages that were dirty at the time of the crash.</span></span> <span data-ttu-id="4cea7-169">這表示 `recovery interval` 設定不可靠。</span><span class="sxs-lookup"><span data-stu-id="4cea7-169">This means that the `recovery interval` setting is unreliable.</span></span> <span data-ttu-id="4cea7-170">它無法判斷精確的復原持續時間。</span><span class="sxs-lookup"><span data-stu-id="4cea7-170">It cannot determine an accurate recovery duration.</span></span> <span data-ttu-id="4cea7-171">此外，當自動檢查點正在進行時，資料的一般 I/O 活動會大幅增加而且無法預測。</span><span class="sxs-lookup"><span data-stu-id="4cea7-171">Furthermore, when an automatic checkpoint is in progress, the general I/O activity for data increases significantly and quite unpredictably.</span></span>  
  
  
####  <a name="impact-of-recovery-interval-on-recovery-performance"></a><a name="PerformanceImpact"></a><span data-ttu-id="4cea7-172">復原間隔對復原效能的影響</span><span class="sxs-lookup"><span data-stu-id="4cea7-172">Impact of Recovery Interval on Recovery Performance</span></span>  
 <span data-ttu-id="4cea7-173">針對使用簡短交易 (OLTP) 系統的線上交易處理， `recovery interval` 是決定復原時間的主要因素。</span><span class="sxs-lookup"><span data-stu-id="4cea7-173">For an online transaction processing (OLTP) system using short transactions, `recovery interval` is the primary factor determining recovery time.</span></span> <span data-ttu-id="4cea7-174">不過，此 `recovery interval` 選項不會影響復原長時間執行之交易所需的時間。</span><span class="sxs-lookup"><span data-stu-id="4cea7-174">However, the `recovery interval` option does not affect the time required to undo a long-running transaction.</span></span> <span data-ttu-id="4cea7-175">復原具有長時間執行之交易的資料庫，所花費的時間可能比選項中指定的還要多 `recovery interval` 。</span><span class="sxs-lookup"><span data-stu-id="4cea7-175">Recovery of a database with a long-running transaction can take much longer than the specified in the `recovery interval` option.</span></span> <span data-ttu-id="4cea7-176">例如，如果長時間執行的交易在伺服器實例停用之前，花了兩個小時來執行更新，則實際的復原所花的時間會比 `recovery interval` 復原長交易的值長得多。</span><span class="sxs-lookup"><span data-stu-id="4cea7-176">For example, if a long-running transaction took two hours to perform updates before the server instance became disabled, the actual recovery takes considerably longer than the `recovery interval` value to recover the long transaction.</span></span> <span data-ttu-id="4cea7-177">如需長時間執行的交易對復原時間之影響的詳細資訊，請參閱 [交易記錄 &#40;SQL Server&#41;](the-transaction-log-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="4cea7-177">For more information about the impact of a long running transaction on recovery time, see [The Transaction Log &#40;SQL Server&#41;](the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="4cea7-178">一般來說，預設值會提供最佳復原效能。</span><span class="sxs-lookup"><span data-stu-id="4cea7-178">Typically, the default values provides optimal recovery performance.</span></span> <span data-ttu-id="4cea7-179">但是在以下情況下，變更復原間隔可能會提升效能：</span><span class="sxs-lookup"><span data-stu-id="4cea7-179">However, changing the recovery interval might improve performance in the following circumstances:</span></span>  
  
-   <span data-ttu-id="4cea7-180">如果未回復長時間執行的交易，復原通常花的時間大幅多於 1 分鐘時。</span><span class="sxs-lookup"><span data-stu-id="4cea7-180">If recovery routinely takes significantly longer than 1 minute when long-running transactions are not being rolled back.</span></span>  
  
-   <span data-ttu-id="4cea7-181">如果您注意到頻繁的檢查點損害了資料庫的效能。</span><span class="sxs-lookup"><span data-stu-id="4cea7-181">If you notice that frequent checkpoints are impairing performance on a database.</span></span>  
  
 <span data-ttu-id="4cea7-182">如果您決定增加 `recovery interval` 設定，我們建議您逐漸少量增加此設定，並評估每次累加對於復原效能的影響。</span><span class="sxs-lookup"><span data-stu-id="4cea7-182">If you decide to increase the `recovery interval` setting, we recommend increasing it gradually by small increments and evaluating the effect of each incremental increase on recovery performance.</span></span> <span data-ttu-id="4cea7-183">這種方法很重要，因為當 `recovery interval` 設定增加時，資料庫復原所花的時間會比完成許多倍。</span><span class="sxs-lookup"><span data-stu-id="4cea7-183">This approach is important because as the `recovery interval` setting increases, database recovery takes that many times longer to complete.</span></span> <span data-ttu-id="4cea7-184">例如，如果您變更 `recovery interval` 10，則完成復原所花的時間會比設定為零時要長大約10倍 `recovery interval` 。</span><span class="sxs-lookup"><span data-stu-id="4cea7-184">For example, if you change `recovery interval` 10, recovery takes approximately 10 times longer to complete than when `recovery interval` is set to zero.</span></span>  
  
  
###  <a name="indirect-checkpoints"></a><a name="IndirectChkpt"></a><span data-ttu-id="4cea7-185">間接檢查點</span><span class="sxs-lookup"><span data-stu-id="4cea7-185">Indirect Checkpoints</span></span>  
 <span data-ttu-id="4cea7-186">間接檢查點是 [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]中的新功能，它會提供替代自動檢查點的可設定資料庫層級。</span><span class="sxs-lookup"><span data-stu-id="4cea7-186">Indirect checkpoints, new in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], provide a configurable database-level alternative to automatic checkpoints.</span></span> <span data-ttu-id="4cea7-187">萬一系統損壞，間接檢查點可能會提供比自動檢查點更快而且更可以預測的復原時間。</span><span class="sxs-lookup"><span data-stu-id="4cea7-187">In the event of a system crash, indirect checkpoints provide potentially faster, more predictable recovery time than automatic checkpoints.</span></span> <span data-ttu-id="4cea7-188">間接檢查點會提供以下優點：</span><span class="sxs-lookup"><span data-stu-id="4cea7-188">Indirect checkpoints offer the following advantages:</span></span>  
  
-   <span data-ttu-id="4cea7-189">設定間接檢查點的資料庫線上交易式工作負載可能會導致效能降低。</span><span class="sxs-lookup"><span data-stu-id="4cea7-189">An online transactional workload on a database that is configured for indirect checkpoints could experience performance degradation.</span></span> <span data-ttu-id="4cea7-190">間接檢查點可確定中途分頁的數目，低於特定臨界值，如此即可在目標復原時間內完成資料庫的復原。</span><span class="sxs-lookup"><span data-stu-id="4cea7-190">Indirect checkpoints make sure that the number of dirty pages are below a certain threshold so that the database recovery completes within the target recovery time.</span></span> <span data-ttu-id="4cea7-191">復原間隔組態選項會使用異動數目來判斷復原時間，而間接檢查點則是會利用中途分頁數目來判斷復原時間。</span><span class="sxs-lookup"><span data-stu-id="4cea7-191">The recovery interval configuration option uses the number of transactions to determine the recovery time as opposed to indirect checkpoints which makes use of number of dirty pages.</span></span> <span data-ttu-id="4cea7-192">在收到大量 DML 作業的資料庫上啟用間接檢查點時，背景寫入器可開始積極排清磁碟的中途緩衝區，以確保執行復原所需的時間，落在資料庫所設的目標復原時間內。</span><span class="sxs-lookup"><span data-stu-id="4cea7-192">When indirect checkpoints are enabled on a database receiving a large number of DML operations, the background writer can start aggressively flushing dirty buffers to disk to ensure that the time required to perform recovery is within the target recovery time set of the database.</span></span> <span data-ttu-id="4cea7-193">如此會在某些系統上造成額外的 I/O 活動，而若磁碟子系統的運作超過或接近 I/O 臨界值，就會形成效能瓶頸。</span><span class="sxs-lookup"><span data-stu-id="4cea7-193">This can cause additional I/O activity on certain systems which can contribute to a performance bottleneck if the disk subsystem is operating above or nearing the I/O threshold.</span></span>  
  
-   <span data-ttu-id="4cea7-194">間接檢查點可讓您考量 REDO 期間的隨機 I/O 成本來可靠控制資料庫復原時間。</span><span class="sxs-lookup"><span data-stu-id="4cea7-194">Indirect checkpoints enable you to reliably control database recovery time by factoring in the cost of random I/O during REDO.</span></span> <span data-ttu-id="4cea7-195">如此可讓伺服器執行個體維持在給定資料庫的復原時間上限內 (除非長時間執行的交易造成過多的復原次數)。</span><span class="sxs-lookup"><span data-stu-id="4cea7-195">This enables a server instance to stay within an upper-bound on recovery times for a given database (except when a long-running transaction causes excessive UNDO times).</span></span>  
  
-   <span data-ttu-id="4cea7-196">間接檢查點會持續在背景中將中途分頁寫入磁碟，以減少與檢查點相關的 I/O 峰值。</span><span class="sxs-lookup"><span data-stu-id="4cea7-196">Indirect checkpoints reduce checkpoint-related I/O spiking by continually writing dirty pages to disk in the background.</span></span>  
  
 <span data-ttu-id="4cea7-197">但是，設定間接檢查點的資料庫線上交易式工作負載可能會導致效能降低。</span><span class="sxs-lookup"><span data-stu-id="4cea7-197">However, an online transactional workload on a database that is configured for indirect checkpoints could experience performance degradation.</span></span> <span data-ttu-id="4cea7-198">這是因為，間接檢查點使用的背景寫入器有時會讓伺服器執行個體的寫入負載總量增加。</span><span class="sxs-lookup"><span data-stu-id="4cea7-198">This is because the background writer used by indirect checkpoint sometimes increases the total write load for a server instance.</span></span>  
  
  
###  <a name="internal-checkpoints"></a><a name="EventsCausingChkpt"></a><span data-ttu-id="4cea7-199">內部檢查點</span><span class="sxs-lookup"><span data-stu-id="4cea7-199">Internal Checkpoints</span></span>  
 <span data-ttu-id="4cea7-200">內部檢查點是由各種伺服器元件產生，可保證磁碟映像符合目前的記錄檔狀態。</span><span class="sxs-lookup"><span data-stu-id="4cea7-200">Internal Checkpoints are generated by various server components to guarantee that disk images match the current state of the log.</span></span> <span data-ttu-id="4cea7-201">產生內部檢查點是為了回應以下事件：</span><span class="sxs-lookup"><span data-stu-id="4cea7-201">Internal checkpoint are generated in response to the following events:</span></span>  
  
-   <span data-ttu-id="4cea7-202">使用 ALTER DATABASE 加入或移除資料庫檔案。</span><span class="sxs-lookup"><span data-stu-id="4cea7-202">Database files have been added or removed by using ALTER DATABASE.</span></span>  
  
-   <span data-ttu-id="4cea7-203">取得資料庫備份。</span><span class="sxs-lookup"><span data-stu-id="4cea7-203">A database backup is taken.</span></span>  
  
-   <span data-ttu-id="4cea7-204">針對 DBCC CHECK 建立資料庫快照集，不論是明確或內部方式。</span><span class="sxs-lookup"><span data-stu-id="4cea7-204">A database snapshot is created, whether explicitly or internally for DBCC CHECK.</span></span>  
  
-   <span data-ttu-id="4cea7-205">執行需要關閉資料庫的活動。</span><span class="sxs-lookup"><span data-stu-id="4cea7-205">An activity requiring a database shutdown is performed.</span></span> <span data-ttu-id="4cea7-206">例如，AUTO_CLOSE 為 ON，且上次使用者與資料庫的連接已經關閉，或是已變更資料庫選項，因此需要重新啟動資料庫。</span><span class="sxs-lookup"><span data-stu-id="4cea7-206">For example, AUTO_CLOSE is ON and the last user connection to the database is closed, or a database option change is made that requires a restart of the database.</span></span>  
  
-   <span data-ttu-id="4cea7-207">經由停止 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER) 服務，來停止 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的執行個體。</span><span class="sxs-lookup"><span data-stu-id="4cea7-207">An instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is stopped by stopping the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER) service .</span></span> <span data-ttu-id="4cea7-208">任何一項動作都會導致在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]執行個體的每個資料庫中產生檢查點。</span><span class="sxs-lookup"><span data-stu-id="4cea7-208">Either action  causes a checkpoint in each database in the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="4cea7-209">讓 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 容錯移轉叢集執行個體 (FCI) 離線。</span><span class="sxs-lookup"><span data-stu-id="4cea7-209">Bringing a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] failover cluster instance (FCI) offline.</span></span>  
  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="4cea7-210">相關工作</span><span class="sxs-lookup"><span data-stu-id="4cea7-210">Related Tasks</span></span>  
 <span data-ttu-id="4cea7-211">**若要變更伺服器執行個體的復原間隔**</span><span class="sxs-lookup"><span data-stu-id="4cea7-211">**To change the recovery interval on a server instance**</span></span>  
  
-   [<span data-ttu-id="4cea7-212">Configure the recovery interval Server Configuration Option</span><span class="sxs-lookup"><span data-stu-id="4cea7-212">Configure the recovery interval Server Configuration Option</span></span>](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)  
  
 <span data-ttu-id="4cea7-213">**若要設定資料庫的間接檢查點**</span><span class="sxs-lookup"><span data-stu-id="4cea7-213">**To configure indirect checkpoints on a database**</span></span>  
  
-   [<span data-ttu-id="4cea7-214">變更資料庫的目標復原時間 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="4cea7-214">Change the Target Recovery Time of a Database &#40;SQL Server&#41;</span></span>](change-the-target-recovery-time-of-a-database-sql-server.md)  
  
 <span data-ttu-id="4cea7-215">**若要發出資料庫的手動檢查點**</span><span class="sxs-lookup"><span data-stu-id="4cea7-215">**To issue a manual checkpoint on a database**</span></span>  
  
-   [<span data-ttu-id="4cea7-216">CHECKPOINT &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="4cea7-216">CHECKPOINT &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/language-elements/checkpoint-transact-sql)  
  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="4cea7-217">相關內容</span><span class="sxs-lookup"><span data-stu-id="4cea7-217">Related Content</span></span>  
  
-   <span data-ttu-id="4cea7-218">[交易記錄檔實體架構](https://technet.microsoft.com/library/ms179355.aspx) (在《 [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] 線上叢書》中)</span><span class="sxs-lookup"><span data-stu-id="4cea7-218">[Transaction Log Physical Architecture](https://technet.microsoft.com/library/ms179355.aspx) (in [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] Books Oline)</span></span>  
  
  
## <a name="see-also"></a><span data-ttu-id="4cea7-219">另請參閱</span><span class="sxs-lookup"><span data-stu-id="4cea7-219">See Also</span></span>  
 [<span data-ttu-id="4cea7-220">交易記錄 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="4cea7-220">The Transaction Log &#40;SQL Server&#41;</span></span>](the-transaction-log-sql-server.md)  
  
  
