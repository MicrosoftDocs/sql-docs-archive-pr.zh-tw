---
title: 空間索引概觀 | Microsoft Docs
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- spatial indexes [SQL Server]
ms.assetid: b1ae7b78-182a-459e-ab28-f743e43f8293
author: MladjoA
ms.author: mlandzic
ms.openlocfilehash: 36406bd60b4204469aca3d20862020870a8832fe
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87597062"
---
# <a name="spatial-indexes-overview"></a><span data-ttu-id="618e1-102">空間索引概觀</span><span class="sxs-lookup"><span data-stu-id="618e1-102">Spatial Indexes Overview</span></span>
  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="618e1-103">支援空間資料和空間索引。</span><span class="sxs-lookup"><span data-stu-id="618e1-103">supports spatial data and spatial indexes.</span></span> <span data-ttu-id="618e1-104">*「空間索引」* (Spatial Index) 是一種類型的擴充索引，可讓您建立空間資料行的索引。</span><span class="sxs-lookup"><span data-stu-id="618e1-104">A *spatial index* is a type of extended index that allows you to index a spatial column.</span></span> <span data-ttu-id="618e1-105">空間資料行是包含空間資料類型資料的資料表資料行，例如 `geometry` 或 `geography`。</span><span class="sxs-lookup"><span data-stu-id="618e1-105">A spatial column is a table column that contains data of a spatial data type, such as `geometry` or `geography`.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="618e1-106">如需 [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]中導入的空間功能 (包括影響空間索引的功能) 的詳細描述和範例，請下載技術白皮書： [SQL Server 2012 中的新空間功能](https://go.microsoft.com/fwlink/?LinkId=226407)。</span><span class="sxs-lookup"><span data-stu-id="618e1-106">For a detailed description and examples of spatial features introduced in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], including features that affect spatial indexes, download the white paper, [New Spatial Features in SQL Server 2012](https://go.microsoft.com/fwlink/?LinkId=226407).</span></span>

##  <a name="about-spatial-indexes"></a><a name="about"></a> <span data-ttu-id="618e1-107">關於空間索引</span><span class="sxs-lookup"><span data-stu-id="618e1-107">About Spatial Indexes</span></span>

###  <a name="decomposing-indexed-space-into-a-grid-hierarchy"></a><a name="decompose"></a> <span data-ttu-id="618e1-108">將索引空間分解為方格階層</span><span class="sxs-lookup"><span data-stu-id="618e1-108">Decomposing Indexed Space into a Grid Hierarchy</span></span>
 <span data-ttu-id="618e1-109">在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中，空間索引是使用 B 型樹狀結構所建立，這表示這些索引必須代表 B 型樹狀結構線性順序中的 2 維度空間資料。</span><span class="sxs-lookup"><span data-stu-id="618e1-109">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], spatial indexes are built using B-trees, which means that the indexes must represent the 2-dimensional spatial data in the linear order of B-trees.</span></span> <span data-ttu-id="618e1-110">因此，將資料讀入空間索引之前， [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 會實作空間的階層式統一分解。</span><span class="sxs-lookup"><span data-stu-id="618e1-110">Therefore, before reading data into a spatial index, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] implements a hierarchical uniform decomposition of space.</span></span> <span data-ttu-id="618e1-111">索引建立程序會將空間 *「分解」* (Decompose) 成四層的 *「方格階層」* (Grid Hierarchy)。</span><span class="sxs-lookup"><span data-stu-id="618e1-111">The index-creation process *decomposes* the space into a four-level *grid hierarchy*.</span></span> <span data-ttu-id="618e1-112">這些層級稱為 *「層級 1」* (Level 1) (最上層)、 *「層級 2」* (Level 2)、 *「層級 3」* (Level 3) 和 *「層級 4」* (Level 4)。</span><span class="sxs-lookup"><span data-stu-id="618e1-112">These levels are referred to as *level 1* (the top level), *level 2*, *level 3*, and *level 4*.</span></span>

 <span data-ttu-id="618e1-113">每一個後續的層級都會進一步分解其上的層級，因此，每一個上層資料格都包含了下一層上的完整方格。</span><span class="sxs-lookup"><span data-stu-id="618e1-113">Each successive level further decomposes the level above it, so each upper-level cell contains a complete grid at the next level.</span></span> <span data-ttu-id="618e1-114">在給定的層級上，所有的方格沿著兩個座標軸會有相同的資料格數目 (例如 4x4 或 8x8)，而資料格都是同一大小。</span><span class="sxs-lookup"><span data-stu-id="618e1-114">On a given level, all the grids have the same number of cells along both axes (for example, 4x4 or 8x8), and the cells are all one size.</span></span>

 <span data-ttu-id="618e1-115">下圖說明如何將方格階層之每一層上的右上方資料格分解成 4x4 方格。</span><span class="sxs-lookup"><span data-stu-id="618e1-115">The following illustration shows the decomposition for the upper-right cell at each level of the grid hierarchy into a 4x4 grid.</span></span> <span data-ttu-id="618e1-116">事實上，所有的資料格都會以這個方式分解。</span><span class="sxs-lookup"><span data-stu-id="618e1-116">In reality, all the cells are decomposed in this way.</span></span> <span data-ttu-id="618e1-117">例如，將空間分解成四層的 4x4 方格實際上一共會產生 65,536 個層級四方格。</span><span class="sxs-lookup"><span data-stu-id="618e1-117">Thus, for example, decomposing a space into four levels of 4x4 grids actually produces a total of 65,536 level-four cells.</span></span>

 <span data-ttu-id="618e1-118">![四個層級的遞迴鑲嵌](../../database-engine/media/spndx-recursive-levels-telescoped.gif "四個層級的遞迴鑲嵌")</span><span class="sxs-lookup"><span data-stu-id="618e1-118">![Four-levels of recursive tessellation](../../database-engine/media/spndx-recursive-levels-telescoped.gif "Four-levels of recursive tessellation")</span></span>

> [!NOTE]
>  <span data-ttu-id="618e1-119">空間索引的空間分解與應用程式資料使用的度量單位無關。</span><span class="sxs-lookup"><span data-stu-id="618e1-119">The decomposition of space for a spatial index is independent of the unit of measurement that the application data uses.</span></span>

 <span data-ttu-id="618e1-120">方格階層資料格會以線性方式編號 (使用希伯特空間填滿曲線的變化)。</span><span class="sxs-lookup"><span data-stu-id="618e1-120">Grid hierarchy cells are numbered in a linear fashion by using a variation of the Hilbert space-filling curve.</span></span> <span data-ttu-id="618e1-121">但是，為了說明起見，本討論內容會使用簡單的資料列取向編號，而不是希伯特曲線實際產生的編號。</span><span class="sxs-lookup"><span data-stu-id="618e1-121">For the purpose of illustration, however, this discussion uses a simple row-wise numbering, instead of the numbering that is actually produced by the Hilbert curve.</span></span> <span data-ttu-id="618e1-122">在下圖中，代表建築物的幾個多邊形及代表街道的線條已經放到 4x4、層級 1 方格內。</span><span class="sxs-lookup"><span data-stu-id="618e1-122">In the following illustration, several polygons that represent buildings, and lines that represent streets, have already been placed into a 4x4, level-1 grid.</span></span> <span data-ttu-id="618e1-123">層級 1 方格的編號是從 1 到 16 (從左上資料格開始)。</span><span class="sxs-lookup"><span data-stu-id="618e1-123">The level-1 cells are numbered from 1 through 16, starting with the upper-left cell.</span></span>

 <span data-ttu-id="618e1-124">![將多邊形和線條放入 4x4 層級 1 方格內](../../database-engine/media/spndx-level-1-objects.gif "將多邊形和線條放入 4x4 層級 1 方格內")</span><span class="sxs-lookup"><span data-stu-id="618e1-124">![Polygons and lines placed into a 4x4 level-1 grid](../../database-engine/media/spndx-level-1-objects.gif "Polygons and lines placed into a 4x4 level-1 grid")</span></span>

#### <a name="grid-density"></a><span data-ttu-id="618e1-125">方格密度</span><span class="sxs-lookup"><span data-stu-id="618e1-125">Grid Density</span></span>
 <span data-ttu-id="618e1-126">沿著方格座標軸的資料格數目會決定它的 *「密度」* (Density)：數目越大，方格的密度就越高。</span><span class="sxs-lookup"><span data-stu-id="618e1-126">The number of cells along the axes of a grid determines its *density*: the larger the number, the denser the grid.</span></span> <span data-ttu-id="618e1-127">例如，8x8 方格 (會產生 64 個資料格) 的密度大於 4x4 方格 (會產生 16 個資料格)。</span><span class="sxs-lookup"><span data-stu-id="618e1-127">For example, an 8x8 grid (which produces 64 cells), is denser than a 4x4 grid (which produces 16 cells).</span></span> <span data-ttu-id="618e1-128">方格密度是依照每個層級而定義。</span><span class="sxs-lookup"><span data-stu-id="618e1-128">Grid density is defined on a per-level basis.</span></span>

 <span data-ttu-id="618e1-129">[CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] 陳述式支援 GRIDS 子句，該子句可讓您在不同的層級上指定不同的方格密度。</span><span class="sxs-lookup"><span data-stu-id="618e1-129">The [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement supports a GRIDS clause that enables you to specify different grid densities at different levels.</span></span> <span data-ttu-id="618e1-130">給定層級的方格密度是使用下列其中一個關鍵字所指定。</span><span class="sxs-lookup"><span data-stu-id="618e1-130">The grid density for a given level is specified by using one of the following keywords.</span></span>

|<span data-ttu-id="618e1-131">關鍵字</span><span class="sxs-lookup"><span data-stu-id="618e1-131">Keyword</span></span>|<span data-ttu-id="618e1-132">方格組態</span><span class="sxs-lookup"><span data-stu-id="618e1-132">Grid configuration</span></span>|<span data-ttu-id="618e1-133">資料格數目</span><span class="sxs-lookup"><span data-stu-id="618e1-133">Number of cells</span></span>|
|-------------|------------------------|---------------------|
|<span data-ttu-id="618e1-134">LOW</span><span class="sxs-lookup"><span data-stu-id="618e1-134">LOW</span></span>|<span data-ttu-id="618e1-135">4X4</span><span class="sxs-lookup"><span data-stu-id="618e1-135">4X4</span></span>|<span data-ttu-id="618e1-136">16</span><span class="sxs-lookup"><span data-stu-id="618e1-136">16</span></span>|
|<span data-ttu-id="618e1-137">MEDIUM</span><span class="sxs-lookup"><span data-stu-id="618e1-137">MEDIUM</span></span>|<span data-ttu-id="618e1-138">8X8</span><span class="sxs-lookup"><span data-stu-id="618e1-138">8X8</span></span>|<span data-ttu-id="618e1-139">64</span><span class="sxs-lookup"><span data-stu-id="618e1-139">64</span></span>|
|<span data-ttu-id="618e1-140">HIGH</span><span class="sxs-lookup"><span data-stu-id="618e1-140">HIGH</span></span>|<span data-ttu-id="618e1-141">16X16</span><span class="sxs-lookup"><span data-stu-id="618e1-141">16X16</span></span>|<span data-ttu-id="618e1-142">256</span><span class="sxs-lookup"><span data-stu-id="618e1-142">256</span></span>|

 <span data-ttu-id="618e1-143">在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中，當資料庫相容性層級設定為 100 以下時，所有層級的預設值都是 MEDIUM。</span><span class="sxs-lookup"><span data-stu-id="618e1-143">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], when the database compatibility level is set to 100 or lower, then the default is MEDIUM on all levels.</span></span> <span data-ttu-id="618e1-144">當資料庫相容性層級設定為 110 以上時，預設值則為自動方格配置。</span><span class="sxs-lookup"><span data-stu-id="618e1-144">When the database compatibility level is set to 110 or higher, then the default is an auto grid scheme.</span></span>

 <span data-ttu-id="618e1-145">您可以藉由指定非預設的方格密度來控制分解程序。</span><span class="sxs-lookup"><span data-stu-id="618e1-145">You can control the decomposition process by specifying non-default grid densities.</span></span> <span data-ttu-id="618e1-146">例如，不同層級上的不同方格密度，對於微調以索引空間大小為根據的索引及空間資料行中的物件，可能會非常實用。</span><span class="sxs-lookup"><span data-stu-id="618e1-146">For example, different grid densities on different levels might be useful for fine tuning an index based on the size of the indexed space and the objects in the spatial column.</span></span>

> [!NOTE]
>  <span data-ttu-id="618e1-147">當資料庫相容性層級設定為 100 以下時，空間索引的方格密度會顯示在 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) 目錄檢視的 level_1_grid、level_2_grid、level_3_grid 和 level_4_grid 資料行中。</span><span class="sxs-lookup"><span data-stu-id="618e1-147">The grid densities of a spatial index are visible in the level_1_grid, level_2_grid, level_3_grid, and level_4_grid columns of the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view when the database compatibility level is set to 100 or lower.</span></span> <span data-ttu-id="618e1-148">`GEOMETRY_AUTO_GRID` / `GEOGRAPHY_AUTO_GRID` 鑲嵌式配置選項不會填入這些資料行。</span><span class="sxs-lookup"><span data-stu-id="618e1-148">The `GEOMETRY_AUTO_GRID`/`GEOGRAPHY_AUTO_GRID` tessellation scheme options do not populate these columns.</span></span> <span data-ttu-id="618e1-149">`NULL`當使用自動方格選項時，spatial_index_tessellations 目錄檢視具有這些資料行的值。</span><span class="sxs-lookup"><span data-stu-id="618e1-149">sys.spatial_index_tessellations catalog view has `NULL` values for these columns when the auto grid options are used.</span></span>

###  <a name="tessellation"></a><a name="tessellation"></a><span data-ttu-id="618e1-150">鑲嵌式</span><span class="sxs-lookup"><span data-stu-id="618e1-150">Tessellation</span></span>
 <span data-ttu-id="618e1-151">將索引空間分解成方格階層之後，空間索引會從空間資料行讀取資料 (逐列讀取)。</span><span class="sxs-lookup"><span data-stu-id="618e1-151">After decomposition of an indexed space into a grid hierarchy, the spatial index reads the data from the spatial column, row by row.</span></span> <span data-ttu-id="618e1-152">在讀取空間物件 (或執行個體) 的資料之後，空間索引會針對該物件執行 *「鑲嵌程序」* (Tessellation Process)。</span><span class="sxs-lookup"><span data-stu-id="618e1-152">After reading the data for a spatial object (or instance), the spatial index performs a *tessellation process* for that object.</span></span> <span data-ttu-id="618e1-153">鑲嵌程序會將此物件納入方格階層中，方式是將此物件與它所接觸的一組方格資料格 (*「接觸的資料格」*(touched cell)) 產生關聯。</span><span class="sxs-lookup"><span data-stu-id="618e1-153">The tessellation processfits the object into the grid hierarchy by associating the object with a set of grid cells that it touches (*touched cells*).</span></span> <span data-ttu-id="618e1-154">從方格階層的層級 1 開始，鑲嵌程序就會跨越此層級繼續進行 *「廣度優先」* (Breadth First)。</span><span class="sxs-lookup"><span data-stu-id="618e1-154">Starting at level 1 of the grid hierarchy, the tessellation process proceeds *breadth first* across the level.</span></span> <span data-ttu-id="618e1-155">此程序可能繼續到所有的四個層級 (一次一個層級)。</span><span class="sxs-lookup"><span data-stu-id="618e1-155">Potentially, the process can continue through all four levels, one level at a time.</span></span>

 <span data-ttu-id="618e1-156">鑲嵌程序的輸出是一組接觸的資料格，這些資料格會記錄在物件的空間索引內。</span><span class="sxs-lookup"><span data-stu-id="618e1-156">The output of the tessellation process is a set of touched cells that are recorded in the spatial index for the object.</span></span> <span data-ttu-id="618e1-157">藉由參考這些記錄的資料格，空間索引就可以在同時儲存於索引內的空間資料行中，在相對於其他物件的空間內找出此物件。</span><span class="sxs-lookup"><span data-stu-id="618e1-157">By referring to these recorded cells, the spatial index can locate the object in space relative to other objects in the spatial column that are also stored in the index.</span></span>

#### <a name="tessellation-rules"></a><span data-ttu-id="618e1-158">鑲嵌規則</span><span class="sxs-lookup"><span data-stu-id="618e1-158">Tessellation Rules</span></span>
 <span data-ttu-id="618e1-159">為了限制針對物件記錄之接觸的資料格數目，鑲嵌程序會套用數個鑲嵌規則。</span><span class="sxs-lookup"><span data-stu-id="618e1-159">To limit the number of touched cells that are recorded for an object, the tessellation process applies several tessellation rules.</span></span> <span data-ttu-id="618e1-160">這些規則會決定鑲嵌程序的深度，以及哪些接觸的資料格會記錄在索引內。</span><span class="sxs-lookup"><span data-stu-id="618e1-160">These rules determine the depth of the tessellation process and which of the touched cells are recorded in the index.</span></span>

 <span data-ttu-id="618e1-161">這些規則如下：</span><span class="sxs-lookup"><span data-stu-id="618e1-161">These rules are as follows:</span></span>

-   <span data-ttu-id="618e1-162">涵蓋規則</span><span class="sxs-lookup"><span data-stu-id="618e1-162">The covering rule</span></span>

     <span data-ttu-id="618e1-163">如果此物件完全覆蓋資料格，則表示該資料格由該物件所 *「涵蓋」* (Cover)。</span><span class="sxs-lookup"><span data-stu-id="618e1-163">If the object completely covers a cell, that cell is said to be *covered* by the object.</span></span> <span data-ttu-id="618e1-164">涵蓋的資料格會計算在內，而且不會加以鑲嵌。</span><span class="sxs-lookup"><span data-stu-id="618e1-164">A covered cell is counted and is not tessellated.</span></span> <span data-ttu-id="618e1-165">這項規則會套用到方格階層的所有層級。</span><span class="sxs-lookup"><span data-stu-id="618e1-165">This rule applies at all levels of the grid hierarchy.</span></span> <span data-ttu-id="618e1-166">涵蓋規則簡化了鑲嵌程序，也減少了空間索引記錄的資料數量。</span><span class="sxs-lookup"><span data-stu-id="618e1-166">The covering rule simplifies the tessellation process and reduces the amount of data that a spatial index records.</span></span>

-   <span data-ttu-id="618e1-167">每一物件的資料格規則</span><span class="sxs-lookup"><span data-stu-id="618e1-167">The cells-per-object rule</span></span>

     <span data-ttu-id="618e1-168">此規則會強制實施 *「每個物件的資料格限制」*(Cells-Per-Object Limit)，此限制可決定為每一個物件所計算的資料格數目 (除了層級 1 以外)。</span><span class="sxs-lookup"><span data-stu-id="618e1-168">This rule enforces the *cells-per-object limit*, which determines the maximum number of cells that can be counted for each object, except on level 1.</span></span> <span data-ttu-id="618e1-169">在較低的層級上，每個物件的資料格規則會控制可記錄之物件相關的資訊數量。</span><span class="sxs-lookup"><span data-stu-id="618e1-169">At lower levels, the cells-per-object rule controls the amount of information that can be recorded about the object.</span></span>

-   <span data-ttu-id="618e1-170">最深的資料格規則</span><span class="sxs-lookup"><span data-stu-id="618e1-170">The deepest-cell rule</span></span>

     <span data-ttu-id="618e1-171">最深的資料格規則會產生最近似的物件，其方式是只記錄已為該物件鑲嵌之最底層的資料格。</span><span class="sxs-lookup"><span data-stu-id="618e1-171">The deepest-cell rule generates the best approximation of an object by recording only the bottom-most cells that have been tessellated for the object.</span></span> <span data-ttu-id="618e1-172">父資料格不算在每個物件的資料格計數內，所以不會記錄在索引內。</span><span class="sxs-lookup"><span data-stu-id="618e1-172">Parent cells do not contribute to the cells-per-object count, and they are not recorded in the index.</span></span>

 <span data-ttu-id="618e1-173">這些鑲嵌規則會遞迴地套用在每一個方格層級上。</span><span class="sxs-lookup"><span data-stu-id="618e1-173">These tessellation rules are applied recursively on each grid level.</span></span> <span data-ttu-id="618e1-174">本章節的其餘部分將更詳細地說明鑲嵌規則。</span><span class="sxs-lookup"><span data-stu-id="618e1-174">The rest of this section describes the tessellation rules in more detail.</span></span>

#### <a name="covering-rule"></a><span data-ttu-id="618e1-175">涵蓋規則</span><span class="sxs-lookup"><span data-stu-id="618e1-175">Covering Rule</span></span>
 <span data-ttu-id="618e1-176">如果物件完全覆蓋資料格，則表示該資料格由該物件所 *「涵蓋」* (Cover)。</span><span class="sxs-lookup"><span data-stu-id="618e1-176">If an object completely covers a cell, that cell is said to be *covered* by the object.</span></span> <span data-ttu-id="618e1-177">例如在下圖中，其中一個第二層資料格 15.11 完全被八邊形的中間部分所覆蓋。</span><span class="sxs-lookup"><span data-stu-id="618e1-177">For example, in the following illustration, one of the second-level cells, 15.11, is completely covered by the middle portion of an octagon.</span></span>

 <span data-ttu-id="618e1-178">![涵蓋最佳化](../../database-engine/media/spndx-opt-covering.gif "涵蓋最佳化")</span><span class="sxs-lookup"><span data-stu-id="618e1-178">![Covering optimization](../../database-engine/media/spndx-opt-covering.gif "Covering optimization")</span></span>

 <span data-ttu-id="618e1-179">被覆蓋的資料格會計算及記錄在索引中，而且此資料格不會進一步加以鑲嵌。</span><span class="sxs-lookup"><span data-stu-id="618e1-179">A covered cell is counted and recorded in the index, and the cell is not tessellated any further.</span></span>

#### <a name="cells-per-object-rule"></a><span data-ttu-id="618e1-180">每個物件的資料格規則</span><span class="sxs-lookup"><span data-stu-id="618e1-180">Cells-Per-Object Rule</span></span>
 <span data-ttu-id="618e1-181">每個物件的鑲嵌範圍主要取決於空間索引的 *「每個物件的資料格限制」* (Cells-Per-Object Limit)。</span><span class="sxs-lookup"><span data-stu-id="618e1-181">The extent of tessellation of each object depends primarily on the *cells-per-object limit* of the spatial index.</span></span> <span data-ttu-id="618e1-182">這項限制定義了每個物件可以計算之鑲嵌的資料格最大數目。</span><span class="sxs-lookup"><span data-stu-id="618e1-182">This limit defines the maximum number of cells that tessellation can count per object.</span></span> <span data-ttu-id="618e1-183">但是請注意，每個物件的資料格規則不會強制對層級 1 實施，所以超出這個限制是有可能的。</span><span class="sxs-lookup"><span data-stu-id="618e1-183">Note, however, that the cells-per-object rule is not enforced for level 1, so it is possible to exceed this limit.</span></span> <span data-ttu-id="618e1-184">如果到達層級 1 計數或是超出每個物件的資料格限制，則較低層級上不會發生進一步的鑲嵌。</span><span class="sxs-lookup"><span data-stu-id="618e1-184">If the level-1 count reaches, or exceeds, the cells-per-object limit, no further tessellation occurs at the lower levels.</span></span>

 <span data-ttu-id="618e1-185">只要此計數小於每個物件的資料格限制，鑲嵌程序就會繼續。</span><span class="sxs-lookup"><span data-stu-id="618e1-185">As long as the count is less than the cells-per-object limit, the tessellation process continues.</span></span> <span data-ttu-id="618e1-186">從數字最小的接觸資料格 (例如，上圖中的資料格 15.6) 開始，此程序會測試每一個資料格，以評估是否要計算它或是將它鑲嵌。</span><span class="sxs-lookup"><span data-stu-id="618e1-186">Starting with the lowest-number touched cell (for example, cell 15.6 in the preceding illustration), the process tests each cell to evaluate whether to count it or tessellate it.</span></span> <span data-ttu-id="618e1-187">如果鑲嵌資料格將超出每個物件的資料格限制，此資料格就會計算在內且不會鑲嵌。</span><span class="sxs-lookup"><span data-stu-id="618e1-187">If tessellating a cell would exceed the cells-per-object limit, the cell is counted and not tessellated.</span></span> <span data-ttu-id="618e1-188">否則會鑲嵌此資料格，而且物件所接觸到的較低層資料格也會計算在內。</span><span class="sxs-lookup"><span data-stu-id="618e1-188">Otherwise, the cell is tessellated, and the lower-level cells that are touched by the object are counted.</span></span> <span data-ttu-id="618e1-189">鑲嵌程序會繼續以這個方式橫跨層級來進行 (廣度取向)。</span><span class="sxs-lookup"><span data-stu-id="618e1-189">The tessellation process continues in this way, breadth-wise, across the level.</span></span> <span data-ttu-id="618e1-190">鑲嵌資料格之較低層的方格會遞迴重複這個程序，直到到達此限制或是不再計算其他資料格為止。</span><span class="sxs-lookup"><span data-stu-id="618e1-190">This process is repeated recursively for the lower-level grids of the tessellated cells until the limit is reached or there are no more cells to count.</span></span>

 <span data-ttu-id="618e1-191">例如，以上圖為例，圖中顯示一個八邊形完全納入層級 1 方格的資料格 15。</span><span class="sxs-lookup"><span data-stu-id="618e1-191">For example, consider the preceding illustration, which shows an octagon that fits completely into cell 15 of the level-1 grid.</span></span> <span data-ttu-id="618e1-192">在此圖中，已經鑲嵌資料格 15，將此八邊形分解成九個層級 2 的資料格。</span><span class="sxs-lookup"><span data-stu-id="618e1-192">In the figure, cell 15 has been tessellated, dissecting the octagon into nine level-2 cells.</span></span> <span data-ttu-id="618e1-193">這個圖假設每個物件的資料格限制為 9 以上 (含)。</span><span class="sxs-lookup"><span data-stu-id="618e1-193">This illustration assumes that the cells-per-object limit is 9 or more.</span></span> <span data-ttu-id="618e1-194">但是，如果每個物件的資料格限制為 8 以下 (含)，將不會鑲嵌資料格 15，而且此物件只會計算該資料格 15。</span><span class="sxs-lookup"><span data-stu-id="618e1-194">If the cells-per-object limit were 8 or less, however, cell 15 would not be tessellated, and only that cell 15 would be counted for the object.</span></span>

 <span data-ttu-id="618e1-195">根據預設，每一物件的資料格限制為 16 個資料格，這會在大多數空間索引的空間和精確度之間提供令人滿意的取捨。</span><span class="sxs-lookup"><span data-stu-id="618e1-195">By default, the cells-per-object limit is 16 cells per object, which provides a satisfactory trade-off between space and precision for most spatial indexes.</span></span> <span data-ttu-id="618e1-196">不過， [CREATE 空間索引](/sql/t-sql/statements/create-spatial-index-transact-sql) [!INCLUDE[tsql](../../../includes/tsql-md.md)] 語句支援 CELLS_PER_OBJECT `=` *n*子句，可讓您指定1到8192（含）之間的每個物件的資料格限制。</span><span class="sxs-lookup"><span data-stu-id="618e1-196">However, the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement supports a CELLS_PER_OBJECT`=`*n* clause that enables you to specify a cells-per-object limit between 1 and 8192, inclusive.</span></span>

> [!NOTE]
>  <span data-ttu-id="618e1-197">空間索引的 **cells_per_object** 設定可以在 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) 目錄檢視中看到。</span><span class="sxs-lookup"><span data-stu-id="618e1-197">The **cells_per_object** setting of a spatial index is visible in the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="deepest-cell-rule"></a><span data-ttu-id="618e1-198">最深的資料格規則</span><span class="sxs-lookup"><span data-stu-id="618e1-198">Deepest-Cell Rule</span></span>
 <span data-ttu-id="618e1-199">最深的資料格規則利用了每一個較低層資料格都屬於其上方之資料格的事實：層級 4 資料格屬於層級 3 資料格、層級 3 資料格屬於層級 2 資料格，而層級 2 資料格則屬於層級 1 資料格。</span><span class="sxs-lookup"><span data-stu-id="618e1-199">The deepest-cell rule exploits the fact that every lower-level cell belongs to the cell above it: a level-4 cell belongs to a level-3 cell, a level-3 cell belongs to a level-2 cell, and a level-2 cell belongs to a level-1 cell.</span></span> <span data-ttu-id="618e1-200">例如，屬於資料格 1.1.1.1 的物件也屬於資料格 1.1.1、資料格 1.1 和資料格 1。</span><span class="sxs-lookup"><span data-stu-id="618e1-200">For example, an object that belongs to cell 1.1.1.1 also belongs to cell 1.1.1, cell 1.1, and cell 1.</span></span> <span data-ttu-id="618e1-201">這類資料格階層關聯性的知識會內建在查詢處理器中。</span><span class="sxs-lookup"><span data-stu-id="618e1-201">Knowledge of such cell-hierarchy relationships is built into the query processor.</span></span> <span data-ttu-id="618e1-202">因此，只有最深層的資料格才需要記錄在索引中，讓索引需要儲存的資訊減至最少。</span><span class="sxs-lookup"><span data-stu-id="618e1-202">Therefore, only the deepest-level cells need to be recorded in the index, minimizing the information that the index needs to store.</span></span>

 <span data-ttu-id="618e1-203">下圖中會鑲嵌相對較小的鑽石形多邊形。</span><span class="sxs-lookup"><span data-stu-id="618e1-203">In the following illustration, a relatively small diamond-shaped polygon is tessellated.</span></span> <span data-ttu-id="618e1-204">此索引會使用每個物件的資料格預設限制 16，這個小型物件未達到這個限制。</span><span class="sxs-lookup"><span data-stu-id="618e1-204">The index uses the default cells-per-object limit of 16, which is not reached for this small object.</span></span> <span data-ttu-id="618e1-205">因此，鑲嵌會繼續往下到層級 4。</span><span class="sxs-lookup"><span data-stu-id="618e1-205">Therefore, tessellation continues down to level 4.</span></span> <span data-ttu-id="618e1-206">此多邊形位於下列層級 1 到層級 3 的資料格內：4、4.4 及 4.4.10 和 4.4.14。</span><span class="sxs-lookup"><span data-stu-id="618e1-206">The polygon resides in the following level-1 through level-3 cells: 4, 4.4, and 4.4.10 and 4.4.14.</span></span> <span data-ttu-id="618e1-207">但是使用了最深的資料格規則時，鑲嵌只會計算十二個層級 4 資料格：4.4.10.13-15 及 4.4.14.1-3、4.4.14.5-7 和 4.4.14.9-11。</span><span class="sxs-lookup"><span data-stu-id="618e1-207">However, using the deepest-cell rule, the tessellation counts only the twelve level-4 cells: 4.4.10.13-15 and 4.4.14.1-3, 4.4.14.5-7, and 4.4.14.9-11.</span></span>

 <span data-ttu-id="618e1-208">![最深的資料格最佳化](../../database-engine/media/spndx-opt-deepest-cell.gif "最深的資料格最佳化")</span><span class="sxs-lookup"><span data-stu-id="618e1-208">![Deepest-cell optimization](../../database-engine/media/spndx-opt-deepest-cell.gif "Deepest-cell optimization")</span></span>

###  <a name="tessellation-schemes"></a><a name="schemes"></a><span data-ttu-id="618e1-209">鑲嵌式配置</span><span class="sxs-lookup"><span data-stu-id="618e1-209">Tessellation Schemes</span></span>
 <span data-ttu-id="618e1-210">空間索引的行為部分取決於它的 *「鑲嵌式配置」*(Tessellation Scheme)。</span><span class="sxs-lookup"><span data-stu-id="618e1-210">The behavior of a spatial index depends partly on its *tessellation scheme*.</span></span> <span data-ttu-id="618e1-211">鑲嵌式配置是資料類型所特有。</span><span class="sxs-lookup"><span data-stu-id="618e1-211">The tessellation scheme is data-type specific.</span></span> <span data-ttu-id="618e1-212">在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中，空間索引支援兩個鑲嵌式配置：</span><span class="sxs-lookup"><span data-stu-id="618e1-212">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], spatial indexes support two tessellation schemes:</span></span>

-   <span data-ttu-id="618e1-213">*幾何方格鑲嵌*式，這是 `geometry` 資料類型的配置。</span><span class="sxs-lookup"><span data-stu-id="618e1-213">*Geometry grid tessellation*, which is the scheme for the `geometry` data type.</span></span>

-   <span data-ttu-id="618e1-214">*地理方格鑲嵌*，適用于 `geography` 資料類型的資料行。</span><span class="sxs-lookup"><span data-stu-id="618e1-214">*Geography grid tessellation*, which applies to columns of the `geography` data type.</span></span>

> [!NOTE]
>  <span data-ttu-id="618e1-215">空間索引的 **tessellation_scheme** 設定可以在 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) 目錄檢視中看到。</span><span class="sxs-lookup"><span data-stu-id="618e1-215">The **tessellation_scheme** setting of a spatial index is visible in the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="geometry-grid-tessellation-scheme"></a><span data-ttu-id="618e1-216">幾何方格鑲嵌式配置</span><span class="sxs-lookup"><span data-stu-id="618e1-216">Geometry Grid Tessellation Scheme</span></span>
 <span data-ttu-id="618e1-217">GEOMETRY_AUTO_GRID 鑲嵌是 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 和更新版本之 `geometry` 資料類型的預設鑲嵌式配置。</span><span class="sxs-lookup"><span data-stu-id="618e1-217">GEOMETRY_AUTO_GRID tessellation is the default tessellation scheme for the `geometry` data type for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and later.</span></span>  <span data-ttu-id="618e1-218">GEOMETRY_GRID 鑲嵌是唯一適用於 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中 geometry 資料類型的鑲嵌式配置。</span><span class="sxs-lookup"><span data-stu-id="618e1-218">GEOMETRY_GRID tessellation is the only tessellation scheme available for geometry data types in [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="618e1-219">本章節討論與處理空間索引相關之幾何方格鑲嵌的層面：支援的方法及週框方塊。</span><span class="sxs-lookup"><span data-stu-id="618e1-219">This section discusses aspects of geometry grid tessellation that are relevant to working with spatial indexes: supported methods and bounding boxes.</span></span>

> [!NOTE]
>  <span data-ttu-id="618e1-220">您可以使用[CREATE 空間索引](/sql/t-sql/statements/create-spatial-index-transact-sql)語句的 using (GEOMETRY_AUTO_GRID/GEOMETRY_GRID) 子句來明確指定這個鑲嵌式配置 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="618e1-220">You can explicitly specify this tessellation scheme by using the USING (GEOMETRY_AUTO_GRID/GEOMETRY_GRID) clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

##### <a name="the-bounding-box"></a><span data-ttu-id="618e1-221">週框方塊</span><span class="sxs-lookup"><span data-stu-id="618e1-221">The Bounding Box</span></span>
 <span data-ttu-id="618e1-222">幾何資料會佔據可以是無限的平面。</span><span class="sxs-lookup"><span data-stu-id="618e1-222">Geometric data occupies a plane that can be infinite.</span></span> <span data-ttu-id="618e1-223">但是在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中，空間索引需要有限的空間。</span><span class="sxs-lookup"><span data-stu-id="618e1-223">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], however, a spatial index requires a finite space.</span></span> <span data-ttu-id="618e1-224">若要建立要分解的有限空間，幾何方格鑲嵌式配置需要矩形 *「週框方塊」*(Bounding Box)。</span><span class="sxs-lookup"><span data-stu-id="618e1-224">To establish a finite space for decomposition, the geometry grid tessellation scheme requires a rectangular *bounding box*.</span></span> <span data-ttu-id="618e1-225">周框方塊是由四個座標（ `(` _x-min_**、**_y-min_ `)` 和 `(` _x max_**、**_y-max_ `)` ）所定義，它們會儲存為空間索引的屬性。</span><span class="sxs-lookup"><span data-stu-id="618e1-225">The bounding box is defined by four coordinates, `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)`, which are stored as properties of the spatial index.</span></span> <span data-ttu-id="618e1-226">這些座標表示以下項目：</span><span class="sxs-lookup"><span data-stu-id="618e1-226">These coordinates represent the following:</span></span>

-   <span data-ttu-id="618e1-227">*x-min* 是週框方塊左下角的 X 座標。</span><span class="sxs-lookup"><span data-stu-id="618e1-227">*x-min* is the x-coordinate of the lower-left corner of the bounding box.</span></span>

-   <span data-ttu-id="618e1-228">*y-min* 是左下角的 Y 座標。</span><span class="sxs-lookup"><span data-stu-id="618e1-228">*y-min* is the y-coordinate of the lower-left corner.</span></span>

-   <span data-ttu-id="618e1-229">*x-max* 是右上角的 X 座標。</span><span class="sxs-lookup"><span data-stu-id="618e1-229">*x-max* is the x-coordinate of the upper-right corner.</span></span>

-   <span data-ttu-id="618e1-230">*y-max* 是右上角的 Y 座標。</span><span class="sxs-lookup"><span data-stu-id="618e1-230">*y-max* is the y-coordinate of upper-right corner.</span></span>

> [!NOTE]
>  <span data-ttu-id="618e1-231">這些座標是由[CREATE 空間索引](/sql/t-sql/statements/create-spatial-index-transact-sql)語句的 BOUNDING_BOX 子句所指定 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="618e1-231">These coordinates are specified by the BOUNDING_BOX clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

 <span data-ttu-id="618e1-232">`(` _X-min_**、**_y-min_ `)` 和 `(` _x max_**、**_y-max_ `)` 座標會決定周框方塊的位置和維度。</span><span class="sxs-lookup"><span data-stu-id="618e1-232">The `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)` coordinates determine the placement and dimensions of the bounding box.</span></span> <span data-ttu-id="618e1-233">週框方塊外面的空間會視為編號 0 的單一資料格。</span><span class="sxs-lookup"><span data-stu-id="618e1-233">The space outside of the bounding box is treated as a single cell that is numbered 0.</span></span>

 <span data-ttu-id="618e1-234">空間索引會分解週框方塊內的空間。</span><span class="sxs-lookup"><span data-stu-id="618e1-234">The spatial index decomposes the space inside the bounding box.</span></span> <span data-ttu-id="618e1-235">方格階層的層級 1 方格會填滿此週框方塊。</span><span class="sxs-lookup"><span data-stu-id="618e1-235">The level-1 grid of the grid hierarchy fills the bounding box.</span></span> <span data-ttu-id="618e1-236">若要將幾何物件放在方格階層中，空間索引會將此物件的座標與週框方塊座標相比較。</span><span class="sxs-lookup"><span data-stu-id="618e1-236">To place a geometric object in the grid hierarchy, the spatial index compares the coordinates of the object to the bounding-box coordinates.</span></span>

 <span data-ttu-id="618e1-237">下圖顯示由周框方塊的 `(` _x-min_**、**_y-min_ `)` 和 `(` _x max_**、**_y-max_ `)` 座標所定義的點。</span><span class="sxs-lookup"><span data-stu-id="618e1-237">The following illustration shows the points defined by the `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)` coordinates of the bounding box.</span></span> <span data-ttu-id="618e1-238">方格階層的最上層會顯示為 4x4 方格。</span><span class="sxs-lookup"><span data-stu-id="618e1-238">The top-level of the grid hierarchy is shown as a 4x4 grid.</span></span> <span data-ttu-id="618e1-239">為了說明起見，較低的層級會予以忽略。</span><span class="sxs-lookup"><span data-stu-id="618e1-239">For the purpose of illustration, the lower levels are omitted.</span></span> <span data-ttu-id="618e1-240">週框方塊外面的空間是由零 (0) 所指示。</span><span class="sxs-lookup"><span data-stu-id="618e1-240">The space outside of the bounding box is indicated by a zero (0).</span></span> <span data-ttu-id="618e1-241">請注意，物件 'A' 有一部分延伸到方塊外面，而物件 'B' 則完全位於資料格 0 的方塊內。</span><span class="sxs-lookup"><span data-stu-id="618e1-241">Note that object 'A' extends partly beyond the box, and object 'B' lies completely outside the box in cell 0.</span></span>

 <span data-ttu-id="618e1-242">![顯示座標和資料格 0 的週框方塊。](../../database-engine/media/spndx-bb-4x4-objects.gif "顯示座標和資料格 0 的週框方塊。")</span><span class="sxs-lookup"><span data-stu-id="618e1-242">![Bounding box showing coordinates and cell 0.](../../database-engine/media/spndx-bb-4x4-objects.gif "Bounding box showing coordinates and cell 0.")</span></span>

 <span data-ttu-id="618e1-243">週框方塊會對應到應用程式空間資料的某個部分。</span><span class="sxs-lookup"><span data-stu-id="618e1-243">A bounding box corresponds to some portion of an application's spatial data.</span></span> <span data-ttu-id="618e1-244">不論索引的週框方塊是否完整包含空間資料行內所儲存的資料，或是只包含一部分，這都取決於應用程式。</span><span class="sxs-lookup"><span data-stu-id="618e1-244">Whether the bounding-box of the index completely contains the data stored in the spatial column, or only contains a portion, is up to the application.</span></span> <span data-ttu-id="618e1-245">只有在完全位於週框方塊內之物件上的運算才會從空間索引獲益。</span><span class="sxs-lookup"><span data-stu-id="618e1-245">Only operations computed on objects that are entirely inside of the bounding box benefit from the spatial index.</span></span> <span data-ttu-id="618e1-246">因此，若要從 `geometry` 資料行上的空間索引獲得最大的好處，您便需要指定包含所有或大多數物件的週框方塊。</span><span class="sxs-lookup"><span data-stu-id="618e1-246">Therefore, to gain the greatest advantage from a spatial index on a `geometry` column, you need to specify a bounding-box that contains all or most of the objects.</span></span>

> [!NOTE]
>  <span data-ttu-id="618e1-247">空間索引的方格密度可以在 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) 目錄檢視的 bounding_box_xmin、bounding_box_ymin、bounding_box_xmax 和 bounding_box_ymax 資料行中看到。</span><span class="sxs-lookup"><span data-stu-id="618e1-247">The grid densities of a spatial index are visible in the bounding_box_xmin, bounding_box_ymin, bounding_box_xmax, and bounding_box_ymax columns of the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="the-geography-grid-tessellation-scheme"></a><span data-ttu-id="618e1-248">地理位置方格鑲嵌式配置</span><span class="sxs-lookup"><span data-stu-id="618e1-248">The Geography Grid Tessellation Scheme</span></span>
 <span data-ttu-id="618e1-249">此鑲嵌式配置只會套用到 `geography` 資料行。</span><span class="sxs-lookup"><span data-stu-id="618e1-249">This tessellation scheme applies only to a `geography` column.</span></span> <span data-ttu-id="618e1-250">本章節摘要說明地理位置方格鑲嵌式配置所支援的方法，並討論測量的空間如何投射到平面上，然後將其分解成方格階層。</span><span class="sxs-lookup"><span data-stu-id="618e1-250">This section summarizes the methods that are supported by geography grid tessellation and discusses how geodetic space is projected onto a plane, which is then decomposed into a grid hierarchy.</span></span>

> [!NOTE]
>  <span data-ttu-id="618e1-251">您可以使用[CREATE 空間索引](/sql/t-sql/statements/create-spatial-index-transact-sql)語句的 using (GEOGRAPHY_AUTO_GRID/GEOGRAPHY_GRID) 子句來明確指定這個鑲嵌式配置 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="618e1-251">You can explicitly specify this tessellation scheme by using the USING (GEOGRAPHY_AUTO_GRID/GEOGRAPHY_GRID) clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

##### <a name="projection-of-the-geodetic-space-onto-a-plane"></a><span data-ttu-id="618e1-252">將測量空間投射到平面上</span><span class="sxs-lookup"><span data-stu-id="618e1-252">Projection of the Geodetic Space onto a Plane</span></span>
 <span data-ttu-id="618e1-253">`geography` 執行個體 (物件) 上的計算會將包含物件的空間視為測量的橢圓體。</span><span class="sxs-lookup"><span data-stu-id="618e1-253">Computations on `geography` instances (objects) treat the space containing the objects as a geodetic ellipsoid.</span></span> <span data-ttu-id="618e1-254">若要分解此空間，地理位置方格鑲嵌式配置會將橢圓體的表面分成上半球和下半球，然後執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="618e1-254">To decompose this space, the geography grid tessellation scheme divides the surface of the ellipsoid into its upper and lower hemispheres and then performs the following steps:</span></span>

1.  <span data-ttu-id="618e1-255">將每一個半球投射到四邊形金字塔的 Facet。</span><span class="sxs-lookup"><span data-stu-id="618e1-255">Projects each hemisphere onto the facets of a quadrilateral pyramid.</span></span>

2.  <span data-ttu-id="618e1-256">將兩個金字塔扁平化。</span><span class="sxs-lookup"><span data-stu-id="618e1-256">Flattens the two pyramids.</span></span>

3.  <span data-ttu-id="618e1-257">聯結扁平化的金字塔，以形成非 Euclidean 平面。</span><span class="sxs-lookup"><span data-stu-id="618e1-257">Joins the flattened pyramids to form a non-Euclidean plane.</span></span>

 <span data-ttu-id="618e1-258">下圖顯示三個步驟之分解程序的圖解檢視。</span><span class="sxs-lookup"><span data-stu-id="618e1-258">The following illustration shows a schematic view of the three-step decomposition process.</span></span> <span data-ttu-id="618e1-259">在金字塔中，點狀的線條代表每一個金字塔之四個 Facet 的界限。</span><span class="sxs-lookup"><span data-stu-id="618e1-259">In the pyramids, the dotted lines represent the boundaries of the four facets of each pyramid.</span></span> <span data-ttu-id="618e1-260">步驟 1 和 2 說明此測量的橢圓體，使用綠色水平線來表示赤道經線，並使用一系列的綠色垂直線來表示幾條緯線。</span><span class="sxs-lookup"><span data-stu-id="618e1-260">Steps 1 and 2 illustrate the geodetic ellipsoid, using a green horizontal line to represent the equatorial longitude line and a series of green vertical lines to represent several latitude lines.</span></span> <span data-ttu-id="618e1-261">步驟 1 顯示投射到兩個半球上的金字塔。</span><span class="sxs-lookup"><span data-stu-id="618e1-261">Step 1 shows the pyramids being projected over the two hemispheres.</span></span> <span data-ttu-id="618e1-262">步驟 2 顯示扁平化的金字塔。</span><span class="sxs-lookup"><span data-stu-id="618e1-262">Step 2 shows the pyramids being flattened.</span></span> <span data-ttu-id="618e1-263">步驟 3 說明扁平化的金字塔在經過組合之後會形成一個平面，顯示投射的經線數目。</span><span class="sxs-lookup"><span data-stu-id="618e1-263">Step 3 illustrates the flattened pyramids, after they have been combined to form a plane, showing a number of projected longitude lines.</span></span> <span data-ttu-id="618e1-264">請注意，這些投射的線條會變直，而且長度會視其落於金字塔上的位置而有所不同。</span><span class="sxs-lookup"><span data-stu-id="618e1-264">Notice that these projected lines are straightened and vary in length, depending on where they fall on the pyramids.</span></span>

 <span data-ttu-id="618e1-265">![將橢圓體投射到平面上](../../database-engine/media/spndx-geodetic-projection.gif "將橢圓體投射到平面上")</span><span class="sxs-lookup"><span data-stu-id="618e1-265">![Projection of the ellipsoid onto a plane](../../database-engine/media/spndx-geodetic-projection.gif "Projection of the ellipsoid onto a plane")</span></span>

 <span data-ttu-id="618e1-266">一旦空間投射到平面上，此平面就會分解成四層級的方格階層。</span><span class="sxs-lookup"><span data-stu-id="618e1-266">Once the space has been projected onto the plane, the plane is decomposed into the four-level grid hierarchy.</span></span> <span data-ttu-id="618e1-267">不同層級可使用不同的方格密度。</span><span class="sxs-lookup"><span data-stu-id="618e1-267">Different levels can use different grid densities.</span></span> <span data-ttu-id="618e1-268">下圖顯示分解成 4x4 層級 1 方格之後的平面。</span><span class="sxs-lookup"><span data-stu-id="618e1-268">The following illustration shows the plane after it has been decomposed into a 4x4 level-1 grid.</span></span> <span data-ttu-id="618e1-269">為了說明起見，方格階層的較低層級會予以忽略。</span><span class="sxs-lookup"><span data-stu-id="618e1-269">For the purposes of illustration, the lower-levels of the grid hierarchy are omitted.</span></span> <span data-ttu-id="618e1-270">事實上，此平面會完整分解成四層的方格階層。</span><span class="sxs-lookup"><span data-stu-id="618e1-270">In actuality, the plane is fully decomposed into a four-level grid hierarchy.</span></span> <span data-ttu-id="618e1-271">在分解程序完成之後，系統會從地理位置資料行逐列讀取地理位置資料，接著會針對每一個物件執行鑲嵌程序。</span><span class="sxs-lookup"><span data-stu-id="618e1-271">After the decomposition process finishes, the geographic data is read, row by row, from the geography column, and the tessellation process is performed for each object in turn.</span></span>

 <span data-ttu-id="618e1-272">![層級 1 地理方格](../../database-engine/media/spndx-geodetic-level1grid.gif "層級 1 地理方格")</span><span class="sxs-lookup"><span data-stu-id="618e1-272">![Level-1 geography grid](../../database-engine/media/spndx-geodetic-level1grid.gif "Level-1 geography grid")</span></span>

##  <a name="methods-supported-by-spatial-indexes"></a><a name="methods"></a><span data-ttu-id="618e1-273">空間索引支援的方法</span><span class="sxs-lookup"><span data-stu-id="618e1-273">Methods Supported by Spatial Indexes</span></span>

###  <a name="geometry-methods-supported-by-spatial-indexes"></a><a name="geometry"></a><span data-ttu-id="618e1-274">空間索引支援的 Geometry 方法</span><span class="sxs-lookup"><span data-stu-id="618e1-274">Geometry Methods Supported by Spatial Indexes</span></span>
 <span data-ttu-id="618e1-275">在某些條件下，空間索引可支援下列集合導向的幾何方法：STContains()、STDistance()、STEquals()、STIntersects()、STOverlaps()、STTouches() 和 STWithin()。</span><span class="sxs-lookup"><span data-stu-id="618e1-275">Spatial indexes support the following set-oriented geometry methods under certain conditions: STContains(), STDistance(), STEquals(), STIntersects(), STOverlaps(), STTouches(), and STWithin().</span></span> <span data-ttu-id="618e1-276">為了獲得空間索引的支援，這些方法必須在查詢的 WHERE 或 JOIN ON 子句中使用，而且必須在下列一般形式的述詞內發生：</span><span class="sxs-lookup"><span data-stu-id="618e1-276">To be supported by a spatial index, these methods must be used within the WHERE or JOIN ON clause of a query, and they must occur within a predicate of the following general form:</span></span>

 <span data-ttu-id="618e1-277">*geometry1*.*method_name*(*geometry2*)*comparison_operator\*\*valid_number*</span><span class="sxs-lookup"><span data-stu-id="618e1-277">*geometry1*.*method_name*(*geometry2*)*comparison_operator\*\*valid_number*</span></span>

 <span data-ttu-id="618e1-278">若要傳回非 null 結果， *geometry1* 和 *geometry2* 必須有相同的 [空間參考識別碼 (SRID)](../spatial/spatial-reference-identifiers-srids.md)。</span><span class="sxs-lookup"><span data-stu-id="618e1-278">To return a non-null result, *geometry1* and *geometry2* must have the same [spatial reference identifier (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span></span> <span data-ttu-id="618e1-279">否則，此方法會傳回 NULL。</span><span class="sxs-lookup"><span data-stu-id="618e1-279">Otherwise, the method returns NULL.</span></span>

 <span data-ttu-id="618e1-280">空間索引支援下列述詞形式：</span><span class="sxs-lookup"><span data-stu-id="618e1-280">Spatial indexes support the following predicate forms:</span></span>

-   <span data-ttu-id="618e1-281">*geometry1*.[STContains](/sql/t-sql/spatial-geometry/stcontains-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="618e1-281">*geometry1*.[STContains](/sql/t-sql/spatial-geometry/stcontains-geometry-data-type)(*geometry2*) = 1</span></span>

-   <span data-ttu-id="618e1-282">*geometry1*。[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type) (*geometry2*) <*號碼*</span><span class="sxs-lookup"><span data-stu-id="618e1-282">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) < *number*</span></span>

-   <span data-ttu-id="618e1-283">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <= *number*</span><span class="sxs-lookup"><span data-stu-id="618e1-283">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <= *number*</span></span>

-   <span data-ttu-id="618e1-284">*geometry1*.[STEquals](/sql/t-sql/spatial-geometry/stequals-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="618e1-284">*geometry1*.[STEquals](/sql/t-sql/spatial-geometry/stequals-geometry-data-type)(*geometry2*)= 1</span></span>

-   <span data-ttu-id="618e1-285">*geometry1*.[STIntersects](/sql/t-sql/spatial-geometry/stintersects-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="618e1-285">*geometry1*.[STIntersects](/sql/t-sql/spatial-geometry/stintersects-geometry-data-type)(*geometry2*)= 1</span></span>

-   <span data-ttu-id="618e1-286">*geometry1.*</span><span class="sxs-lookup"><span data-stu-id="618e1-286">*geometry1.*</span></span> <span data-ttu-id="618e1-287">[STOverlaps](/sql/t-sql/spatial-geometry/stoverlaps-geometry-data-type) *(geometry2) = 1*</span><span class="sxs-lookup"><span data-stu-id="618e1-287">[STOverlaps](/sql/t-sql/spatial-geometry/stoverlaps-geometry-data-type) *(geometry2) = 1*</span></span>

-   <span data-ttu-id="618e1-288">*geometry1*.[STTouches](/sql/t-sql/spatial-geometry/sttouches-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="618e1-288">*geometry1*.[STTouches](/sql/t-sql/spatial-geometry/sttouches-geometry-data-type)(*geometry2*) = 1</span></span>

-   <span data-ttu-id="618e1-289">*geometry1*.[STWithin](/sql/t-sql/spatial-geometry/stwithin-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="618e1-289">*geometry1*.[STWithin](/sql/t-sql/spatial-geometry/stwithin-geometry-data-type)(*geometry2*)= 1</span></span>

###  <a name="geography-methods-supported-by-spatial-indexes"></a><a name="geography"></a><span data-ttu-id="618e1-290">空間索引支援的地理方法</span><span class="sxs-lookup"><span data-stu-id="618e1-290">Geography Methods Supported by Spatial Indexes</span></span>
 <span data-ttu-id="618e1-291">在某些條件下，空間索引可支援下列集合導向的地理位置方法：STIntersects()、STEquals() 和 STDistance()。</span><span class="sxs-lookup"><span data-stu-id="618e1-291">Under certain conditions, spatial indexes support the following set-oriented geography methods: STIntersects(),STEquals(), and STDistance().</span></span> <span data-ttu-id="618e1-292">為了獲得空間索引的支援，這些方法必須在查詢的 WHERE 子句中使用，而且必須在下列一般形式的述詞內發生：</span><span class="sxs-lookup"><span data-stu-id="618e1-292">To be supported by a spatial index, these methods must be used within the WHERE clause of a query, and they must occur within a predicate of the following general form:</span></span>

 <span data-ttu-id="618e1-293">*geography1*.*method_name*(*geography2*)*comparison_operator\*\*valid_number*</span><span class="sxs-lookup"><span data-stu-id="618e1-293">*geography1*.*method_name*(*geography2*)*comparison_operator\*\*valid_number*</span></span>

 <span data-ttu-id="618e1-294">若要傳回非 null 結果， *geography1* 和 *geography2* 必須有相同的 [空間參考識別碼 (SRID)](../spatial/spatial-reference-identifiers-srids.md)。</span><span class="sxs-lookup"><span data-stu-id="618e1-294">To return a non-null result, *geography1* and *geography2* must have the same [Spatial Reference Identifier (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span></span> <span data-ttu-id="618e1-295">否則，此方法會傳回 NULL。</span><span class="sxs-lookup"><span data-stu-id="618e1-295">Otherwise, the method returns NULL.</span></span>

 <span data-ttu-id="618e1-296">空間索引支援下列述詞形式：</span><span class="sxs-lookup"><span data-stu-id="618e1-296">Spatial indexes support the following predicate forms:</span></span>

-   <span data-ttu-id="618e1-297">*geography1*.[STIntersects](/sql/t-sql/spatial-geography/stintersects-geography-data-type)(*geography2*)= 1</span><span class="sxs-lookup"><span data-stu-id="618e1-297">*geography1*.[STIntersects](/sql/t-sql/spatial-geography/stintersects-geography-data-type)(*geography2*)= 1</span></span>

-   <span data-ttu-id="618e1-298">*geography1*.[STEquals](/sql/t-sql/spatial-geography/stequals-geography-data-type)(*geography2*)= 1</span><span class="sxs-lookup"><span data-stu-id="618e1-298">*geography1*.[STEquals](/sql/t-sql/spatial-geography/stequals-geography-data-type)(*geography2*)= 1</span></span>

-   <span data-ttu-id="618e1-299">*geography1*。[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type) (*geography2*) <*號碼*</span><span class="sxs-lookup"><span data-stu-id="618e1-299">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) < *number*</span></span>

-   <span data-ttu-id="618e1-300">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <= *number*</span><span class="sxs-lookup"><span data-stu-id="618e1-300">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <= *number*</span></span>

### <a name="queries-that-use-spatial-indexes"></a><span data-ttu-id="618e1-301">使用空間索引的查詢</span><span class="sxs-lookup"><span data-stu-id="618e1-301">Queries that use Spatial Indexes</span></span>
 <span data-ttu-id="618e1-302">空間索引只有在 `WHERE` 子句中包含索引空間運算子的查詢中才受到支援。</span><span class="sxs-lookup"><span data-stu-id="618e1-302">Spatial indexes are only supported in queries that include an indexed spatial operator in the `WHERE` clause.</span></span> <span data-ttu-id="618e1-303">例如，類似以下的語法：</span><span class="sxs-lookup"><span data-stu-id="618e1-303">For example syntax such as:</span></span>

```
[spatial object].SpatialMethod([reference spatial object]) [ = | < ] [const literal or variable]
```

 <span data-ttu-id="618e1-304">查詢最佳化工具了解空間運算的交換性 ( `@a.STIntersects(@b) = @b.STInterestcs(@a)` )。</span><span class="sxs-lookup"><span data-stu-id="618e1-304">The query optimizer understands the commutativity of spatial operations (that `@a.STIntersects(@b) = @b.STInterestcs(@a)` ).</span></span> <span data-ttu-id="618e1-305">但是，如果比較開頭未包含空間運算子，將不會使用空間索引 (例如 `WHERE 1 = spatial op` 將不會使用空間索引)。</span><span class="sxs-lookup"><span data-stu-id="618e1-305">However, the spatial index will not be used if the beginning of a comparison does not contain the spatial operator (for example `WHERE 1 = spatial op` will not use the spatial index).</span></span> <span data-ttu-id="618e1-306">若要使用空間索引，請重寫比較 (例如 `WHERE spatial op = 1`)。</span><span class="sxs-lookup"><span data-stu-id="618e1-306">To use the spatial index, rewrite the comparison (for example `WHERE spatial op = 1`).</span></span>

 <span data-ttu-id="618e1-307">就如同其他任何索引，當空間索引受支援時，將會根據成本選擇使用空間索引，這樣一來，查詢最佳化工具可能不會選擇使用空間索引，即便符合使用它的所有要求也是一樣。</span><span class="sxs-lookup"><span data-stu-id="618e1-307">As with any other index, when a spatial index is supported, the use of the spatial index is chosen based on cost, so the query optimizer might not choose to use the spatial index even though all requirements for using it are met.</span></span> <span data-ttu-id="618e1-308">使用執行程序表來了解是否使用了空間索引，並視需要提供強制使用所需之查詢計劃的查詢提示。</span><span class="sxs-lookup"><span data-stu-id="618e1-308">Use showplan to see if the spatial index was used and if necessary provide query hints to force a desired query plan.</span></span>

 <span data-ttu-id="618e1-309">但是，只有在撰寫特定查詢語法時，最接近的查詢類型也才會支援空間索引。</span><span class="sxs-lookup"><span data-stu-id="618e1-309">The nearest neighbor type of query also supports spatial indexes however only if a specific query syntax is written.</span></span> <span data-ttu-id="618e1-310">適當的語法為：</span><span class="sxs-lookup"><span data-stu-id="618e1-310">The appropriate syntax is:</span></span>

```
SELECT TOP(K) [WITH TIES] * 
FROM <Table> AS T [WITH(INDEX(<SpatialIndex>))]
WHERE <SpatialColumn>.STDistance(@reference_object) IS NOT NULL
ORDER BY <SpatialColumn>.STDistance(@reference_object) [;]
```

## <a name="see-also"></a><span data-ttu-id="618e1-311">另請參閱</span><span class="sxs-lookup"><span data-stu-id="618e1-311">See Also</span></span>
 [<span data-ttu-id="618e1-312">空間資料 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="618e1-312">Spatial Data &#40;SQL Server&#41;</span></span>](../spatial/spatial-data-sql-server.md)


