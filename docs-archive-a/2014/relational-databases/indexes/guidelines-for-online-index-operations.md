---
title: 線上索引作業的指導方針 | Microsoft Docs
ms.custom: ''
ms.date: 11/11/2016
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: table-view-index
ms.topic: conceptual
helpviewer_keywords:
- clustered indexes, online operations
- online index operations
- indexes [SQL Server], online operations
- disk space [SQL Server], indexes
- nonclustered indexes [SQL Server], online operations
- transaction logs [SQL Server], indexes
ms.assetid: d82942e0-4a86-4b34-a65f-9f143ebe85ce
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 907fe6a826607fe1cb403ad9b8debe6faf6771fc
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87606307"
---
# <a name="guidelines-for-online-index-operations"></a><span data-ttu-id="c1928-102">線上索引作業的指導方針</span><span class="sxs-lookup"><span data-stu-id="c1928-102">Guidelines for Online Index Operations</span></span>
  <span data-ttu-id="c1928-103">當您執行線上索引作業時，下列指導方針將適用：</span><span class="sxs-lookup"><span data-stu-id="c1928-103">When you perform online index operations, the following guidelines apply:</span></span>  
  
-   <span data-ttu-id="c1928-104">當基礎資料表包含下列大型物件 (LOB) 資料類型： `image` 、 **Ntext**和時，必須離線建立、重建或卸載叢集索引 `text` 。</span><span class="sxs-lookup"><span data-stu-id="c1928-104">Clustered indexes must be created, rebuilt, or dropped offline when the underlying table contains the following large object (LOB) data types: `image`, **ntext**, and `text`.</span></span>  
  
-   <span data-ttu-id="c1928-105">您無法在線上建立、重建或卸除本機暫存資料表的索引。</span><span class="sxs-lookup"><span data-stu-id="c1928-105">Indexes on local temp tables cannot be created, rebuilt, or dropped online.</span></span> <span data-ttu-id="c1928-106">此限制不適用於全域暫存資料表上的索引。</span><span class="sxs-lookup"><span data-stu-id="c1928-106">This restriction does not apply to indexes on global temp tables.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c1928-107">[!INCLUDE[msCoName](../../includes/msconame-md.md)][!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的所有版本都無法使用線上索引作業。</span><span class="sxs-lookup"><span data-stu-id="c1928-107">Online index operations are not available in every edition of [!INCLUDE[msCoName](../../includes/msconame-md.md)][!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="c1928-108">如需版本支援的功能清單 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ，請參閱[SQL Server 2014 版本支援的功能](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md)。</span><span class="sxs-lookup"><span data-stu-id="c1928-108">For a list of features that are supported by the editions of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], see [Features Supported by the Editions of SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md).</span></span>  
  
 <span data-ttu-id="c1928-109">下表顯示可以線上執行的索引作業以及從這些線上作業排除的索引。</span><span class="sxs-lookup"><span data-stu-id="c1928-109">The following table shows the index operations that can be performed online and the indexes that are excluded from these online operations.</span></span> <span data-ttu-id="c1928-110">也包含其他限制。</span><span class="sxs-lookup"><span data-stu-id="c1928-110">Additional restrictions are also included.</span></span>  
  
|<span data-ttu-id="c1928-111">線上索引作業</span><span class="sxs-lookup"><span data-stu-id="c1928-111">Online index operation</span></span>|<span data-ttu-id="c1928-112">排除索引</span><span class="sxs-lookup"><span data-stu-id="c1928-112">Excluded indexes</span></span>|<span data-ttu-id="c1928-113">其他限制</span><span class="sxs-lookup"><span data-stu-id="c1928-113">Other restrictions</span></span>|  
|----------------------------|----------------------|------------------------|  
|<span data-ttu-id="c1928-114">ALTER INDEX REBUILD</span><span class="sxs-lookup"><span data-stu-id="c1928-114">ALTER INDEX REBUILD</span></span>|<span data-ttu-id="c1928-115">已停用叢集索引或已停用索引檢視</span><span class="sxs-lookup"><span data-stu-id="c1928-115">Disabled clustered index or disabled indexed view</span></span><br /><br /> <span data-ttu-id="c1928-116">XML 索引</span><span class="sxs-lookup"><span data-stu-id="c1928-116">XML index</span></span> <br /><br /><span data-ttu-id="c1928-117">資料行存放區索引</span><span class="sxs-lookup"><span data-stu-id="c1928-117">Columnstore index</span></span><br /><br /> <span data-ttu-id="c1928-118">本機暫存資料表上的索引</span><span class="sxs-lookup"><span data-stu-id="c1928-118">Index on a local temp table</span></span>|<span data-ttu-id="c1928-119">當資料表包含排除索引時，指定關鍵字 ALL 可能導致作業失敗。</span><span class="sxs-lookup"><span data-stu-id="c1928-119">Specifying the keyword ALL may cause the operation to fail when the table contains an excluded index.</span></span><br /><br /> <span data-ttu-id="c1928-120">重建已停用索引的其他限制也適用。</span><span class="sxs-lookup"><span data-stu-id="c1928-120">Additional restrictions on rebuilding disabled indexes apply.</span></span> <span data-ttu-id="c1928-121">如需詳細資訊，請參閱 [停用索引和條件約束](disable-indexes-and-constraints.md)。</span><span class="sxs-lookup"><span data-stu-id="c1928-121">For more information, see [Disable Indexes and Constraints](disable-indexes-and-constraints.md).</span></span>|  
|<span data-ttu-id="c1928-122">CREATE INDEX</span><span class="sxs-lookup"><span data-stu-id="c1928-122">CREATE INDEX</span></span>|<span data-ttu-id="c1928-123">XML 索引</span><span class="sxs-lookup"><span data-stu-id="c1928-123">XML index</span></span><br /><br /> <span data-ttu-id="c1928-124">在檢視上的初始唯一叢集索引</span><span class="sxs-lookup"><span data-stu-id="c1928-124">Initial unique clustered index on a view</span></span><br /><br /> <span data-ttu-id="c1928-125">本機暫存資料表上的索引</span><span class="sxs-lookup"><span data-stu-id="c1928-125">Index on a local temp table</span></span>||  
|<span data-ttu-id="c1928-126">CREATE INDEX WITH DROP_EXISTING</span><span class="sxs-lookup"><span data-stu-id="c1928-126">CREATE INDEX WITH DROP_EXISTING</span></span>|<span data-ttu-id="c1928-127">已停用叢集索引或已停用索引檢視</span><span class="sxs-lookup"><span data-stu-id="c1928-127">Disabled clustered index or disabled indexed view</span></span><br /><br /> <span data-ttu-id="c1928-128">本機暫存資料表上的索引</span><span class="sxs-lookup"><span data-stu-id="c1928-128">Index on a local temp table</span></span><br /><br /> <span data-ttu-id="c1928-129">XML 索引</span><span class="sxs-lookup"><span data-stu-id="c1928-129">XML index</span></span>||  
|<span data-ttu-id="c1928-130">DROP INDEX</span><span class="sxs-lookup"><span data-stu-id="c1928-130">DROP INDEX</span></span>|<span data-ttu-id="c1928-131">停用的索引</span><span class="sxs-lookup"><span data-stu-id="c1928-131">Disabled index</span></span><br /><br /> <span data-ttu-id="c1928-132">XML 索引</span><span class="sxs-lookup"><span data-stu-id="c1928-132">XML index</span></span><br /><br /> <span data-ttu-id="c1928-133">非叢集索引</span><span class="sxs-lookup"><span data-stu-id="c1928-133">Nonclustered index</span></span><br /><br /> <span data-ttu-id="c1928-134">本機暫存資料表上的索引</span><span class="sxs-lookup"><span data-stu-id="c1928-134">Index on a local temp table</span></span>|<span data-ttu-id="c1928-135">不能在單一陳述式中指定多個索引。</span><span class="sxs-lookup"><span data-stu-id="c1928-135">Multiple indexes cannot be specified within a single statement.</span></span>|  
|<span data-ttu-id="c1928-136">ALTER TABLE ADD CONSTRAINT (PRIMARY KEY 或 UNIQUE)</span><span class="sxs-lookup"><span data-stu-id="c1928-136">ALTER TABLE ADD CONSTRAINT (PRIMARY KEY or UNIQUE)</span></span>|<span data-ttu-id="c1928-137">本機暫存資料表上的索引</span><span class="sxs-lookup"><span data-stu-id="c1928-137">Index on a local temp table</span></span><br /><br /> <span data-ttu-id="c1928-138">叢集索引</span><span class="sxs-lookup"><span data-stu-id="c1928-138">Clustered index</span></span>|<span data-ttu-id="c1928-139">一次僅允許一個子子句 (Subclause)。</span><span class="sxs-lookup"><span data-stu-id="c1928-139">Only one subclause is allowed at a time.</span></span> <span data-ttu-id="c1928-140">例如，您無法在同一個 ALTER TABLE 陳述式中加入和卸除 PRIMARY KEY 或 UNIQUE 條件約束。</span><span class="sxs-lookup"><span data-stu-id="c1928-140">For example, you cannot add and drop PRIMARY KEY or UNIQUE constraints in the same ALTER TABLE statement.</span></span>|  
||||  
  
 <span data-ttu-id="c1928-141">處理線上索引作業時，不能修改、截斷或卸除基礎資料表。</span><span class="sxs-lookup"><span data-stu-id="c1928-141">The underlying table cannot be modified, truncated, or dropped while an online index operation is in process.</span></span>  
  
 <span data-ttu-id="c1928-142">當您建立或卸除叢集時，指定的線上選項設定 (ON 或 OFF) 會套用到必須重建的任何非叢集索引。</span><span class="sxs-lookup"><span data-stu-id="c1928-142">The online option setting (ON or OFF) specified when you create or drop a clustered index is applied to any nonclustered indexes that must be rebuilt.</span></span> <span data-ttu-id="c1928-143">例如，若是使用 CREATE INDEX WITH DROP_EXISTING, ONLINE=ON 線上建立叢集索引，那麼也會線上重建所有相關聯的非叢集索引。</span><span class="sxs-lookup"><span data-stu-id="c1928-143">For example, if the clustered index is built online by using CREATE INDEX WITH DROP_EXISTING, ONLINE=ON, all associated nonclustered indexes are re-created online also.</span></span>  
  
 <span data-ttu-id="c1928-144">線上建立或重建 UNIQUE 索引時，此索引產生器與並行使用者交易可能嘗試要插入同一個索引鍵，因此而違反了唯一性。</span><span class="sxs-lookup"><span data-stu-id="c1928-144">When you create or rebuild a UNIQUE index online, the index builder and a concurrent user transaction may try to insert the same key, therefore violating uniqueness.</span></span> <span data-ttu-id="c1928-145">若在原始資料列從來源資料表移動到新索引之前，將使用者輸入的資料列插入至新索引(目標)，線上索引作業將失敗。</span><span class="sxs-lookup"><span data-stu-id="c1928-145">If a row entered by a user is inserted into the new index (target) before the original row from the source table is moved to the new index, the online index operation will fail.</span></span>  
  
 <span data-ttu-id="c1928-146">雖然這種情形並不常見，但是由於使用者或應用程序活動的原因，線上索引作業與資料庫更新互動時，即會導致死結。</span><span class="sxs-lookup"><span data-stu-id="c1928-146">Although not common, the online index operation can cause a deadlock when it interacts with database updates because of user or application activities.</span></span> <span data-ttu-id="c1928-147">在這些極少數情況下， [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] 將選擇使用者或應用程序活動作為死結的犧牲者。</span><span class="sxs-lookup"><span data-stu-id="c1928-147">In these rare cases, the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] will select the user or application activity as a deadlock victim.</span></span>  
  
 <span data-ttu-id="c1928-148">只有在建立多個新的非叢集索引或重新組織非叢集索引時，才能在同一個資料表或檢視上執行並行線上索引 DDL 作業。</span><span class="sxs-lookup"><span data-stu-id="c1928-148">You can perform concurrent online index DDL operations on the same table or view only when you are creating multiple new nonclustered indexes, or reorganizing nonclustered indexes.</span></span> <span data-ttu-id="c1928-149">同時執行的所有其他線上索引作業都會失敗。</span><span class="sxs-lookup"><span data-stu-id="c1928-149">All other online index operations performed at the same time fail.</span></span> <span data-ttu-id="c1928-150">例如，在同一個資料表中線上重建現有索引時，是無法線上建立新的索引。</span><span class="sxs-lookup"><span data-stu-id="c1928-150">For example, you cannot create a new index online while rebuilding an existing index online on the same table.</span></span>  
  
 <span data-ttu-id="c1928-151">如果索引包含大型物件類型的資料行，且在同一交易中另有更新作業早於線上作業，便無法執行該線上作業。</span><span class="sxs-lookup"><span data-stu-id="c1928-151">An online operation cannot be performed when an index contains a column of the large object type, and in the same transaction there are update operations before this online operation.</span></span> <span data-ttu-id="c1928-152">若要解決此問題，請將線上作業移出交易之外，或使其比交易中的任何更新都更早執行。</span><span class="sxs-lookup"><span data-stu-id="c1928-152">To work around this issue, place the online operation outside the transaction or place it before any updates in the transaction.</span></span>  
  
## <a name="disk-space-considerations"></a><span data-ttu-id="c1928-153">磁碟空間考量因素</span><span class="sxs-lookup"><span data-stu-id="c1928-153">Disk Space Considerations</span></span>  
 <span data-ttu-id="c1928-154">通常，磁碟空間需求對於線上與離線作業是一樣的。</span><span class="sxs-lookup"><span data-stu-id="c1928-154">Generally, disk space requirements are the same for online and offline index operations.</span></span> <span data-ttu-id="c1928-155">例外的情形是暫存對應索引需要額外的磁碟空間。</span><span class="sxs-lookup"><span data-stu-id="c1928-155">An exception is additional disk space required by the temporary mapping index.</span></span> <span data-ttu-id="c1928-156">此暫存索引用於建立、重建或卸除叢集索引的線上索引作業。</span><span class="sxs-lookup"><span data-stu-id="c1928-156">This temporary index is used in online index operations that create, rebuild, or drop a clustered index.</span></span> <span data-ttu-id="c1928-157">線上卸除叢集索引與線上建立叢集索引需要一樣多的磁碟空間。</span><span class="sxs-lookup"><span data-stu-id="c1928-157">Dropping a clustered index online requires as much space as creating a clustered index online.</span></span> <span data-ttu-id="c1928-158">如需詳細資訊，請參閱 [Disk Space Requirements for Index DDL Operations](disk-space-requirements-for-index-ddl-operations.md)。</span><span class="sxs-lookup"><span data-stu-id="c1928-158">For more information, see [Disk Space Requirements for Index DDL Operations](disk-space-requirements-for-index-ddl-operations.md).</span></span>  
  
## <a name="performance-considerations"></a><span data-ttu-id="c1928-159">效能考量</span><span class="sxs-lookup"><span data-stu-id="c1928-159">Performance Considerations</span></span>  
 <span data-ttu-id="c1928-160">雖然線上索引作業允許並行使用者更新活動，但是若更新活動負載繁重，此索引作業將需要更長時間。</span><span class="sxs-lookup"><span data-stu-id="c1928-160">Although online index operations permit concurrent user update activity, the index operations will take longer if the update activity is very heavy.</span></span> <span data-ttu-id="c1928-161">一般而言，無論並行更新活動的程度，線上索引作業都將低於同等的離線索引作業。</span><span class="sxs-lookup"><span data-stu-id="c1928-161">Typically, online index operations will be slower than equivalent offline index operations regardless of the concurrent update activity level.</span></span>  
  
 <span data-ttu-id="c1928-162">由於線上索引作業期間都會維護來源與目標結構，因此會增加插入、更新與刪除交易時所耗用的資源，甚至可能加倍。</span><span class="sxs-lookup"><span data-stu-id="c1928-162">Because both the source and target structures are maintained during the online index operation, the resource usage for insert, update, and delete transactions is increased, potentially up to double.</span></span> <span data-ttu-id="c1928-163">這在索引作業期間可能導致效能降低與資源過度耗用，尤其是 CPU 時間。</span><span class="sxs-lookup"><span data-stu-id="c1928-163">This could cause a decrease in performance and greater resource usage, especially CPU time, during the index operation.</span></span> <span data-ttu-id="c1928-164">線上索引作業會完整記錄下來。</span><span class="sxs-lookup"><span data-stu-id="c1928-164">Online index operations are fully logged.</span></span>  
  
 <span data-ttu-id="c1928-165">儘管我們推薦線上作業，但您應該評估您的環境與特定要求。</span><span class="sxs-lookup"><span data-stu-id="c1928-165">Although we recommend online operations, you should evaluate your environment and specific requirements.</span></span> <span data-ttu-id="c1928-166">離線執行索引作業可能會是最佳方式。</span><span class="sxs-lookup"><span data-stu-id="c1928-166">It may be optimal to run index operations offline.</span></span> <span data-ttu-id="c1928-167">若要達到這種方式，在作業期間，使用者僅能有限地存取資料，但是將更快完成作業且使用較少的資源。</span><span class="sxs-lookup"><span data-stu-id="c1928-167">In doing this, users have restricted access to the data during the operation, but the operation finishes faster and uses fewer resources.</span></span>  
  
 <span data-ttu-id="c1928-168">在執行 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]的多處理器電腦上，索引陳述式可能會如同其他查詢般，使用更多處理器來執行與索引陳述式相關聯的掃描和排序作業。</span><span class="sxs-lookup"><span data-stu-id="c1928-168">On multiprocessor computers that are running [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], index statements may use more processors to perform the scan and sort operations associated with the index statement just like other queries do.</span></span> <span data-ttu-id="c1928-169">您可以使用 MAXDOP 索引選項控制線上索引作業專用的處理器數目。</span><span class="sxs-lookup"><span data-stu-id="c1928-169">You can use the MAXDOP index option to control the number of processors dedicated to the online index operation.</span></span> <span data-ttu-id="c1928-170">以此方式，您就可以平衡索引作業所使用的資源以及使用者並行所使用的資源。</span><span class="sxs-lookup"><span data-stu-id="c1928-170">In this way, you can balance the resources that are used by index operation with those of the concurrent users.</span></span> <span data-ttu-id="c1928-171">如需詳細資訊，請參閱 [設定平行索引作業](configure-parallel-index-operations.md)。</span><span class="sxs-lookup"><span data-stu-id="c1928-171">For more information, see [Configure Parallel Index Operations](configure-parallel-index-operations.md).</span></span> <span data-ttu-id="c1928-172">如需有關支援平行索引作業之 SQL Server 版本的詳細資訊，請參閱[SQL Server 2014 版本支援的功能](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md)。</span><span class="sxs-lookup"><span data-stu-id="c1928-172">For more information about the editions of SQL Server that support Parallel indexed operations, see [Features Supported by the Editions of SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md).</span></span>  
  
 <span data-ttu-id="c1928-173">因為索引作業的最終階段會保留 S-lock 或 Sch-M 鎖定，所以在明確的使用者交易 (例如 BEGIN TRANSACTION...COMMIT 區塊) 內執行線上索引作業時要特別小心。</span><span class="sxs-lookup"><span data-stu-id="c1928-173">Because an S-lock or Sch-M lock is held in the final phase of the index operation, be careful when you run an online index operation inside an explicit user transaction, such as BEGIN TRANSACTION...COMMIT block.</span></span> <span data-ttu-id="c1928-174">這樣做導致交易完後才執行鎖定，而妨礙使用者進行並行作業。</span><span class="sxs-lookup"><span data-stu-id="c1928-174">Doing this causes the lock to be held until the end of the transaction, therefore impeding user concurrency.</span></span>  
  
 <span data-ttu-id="c1928-175">當線上索引重建可搭配 `MAX DOP > 1` 和 `ALLOW_PAGE_LOCKS = OFF` 選項執行時，可能會增加片段。</span><span class="sxs-lookup"><span data-stu-id="c1928-175">Online index rebuilding may increase fragmentation when it is allowed to run with `MAX DOP > 1` and `ALLOW_PAGE_LOCKS = OFF` options.</span></span> <span data-ttu-id="c1928-176">如需詳細資訊，請參閱 [運作方式：線上索引重建 - 可能會導致片段增加](https://blogs.msdn.com/b/psssql/archive/2012/09/05/how-it-works-online-index-rebuild-can-cause-increased-fragmentation.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c1928-176">For more information, see [How It Works: Online Index Rebuild - Can Cause Increased Fragmentation](https://blogs.msdn.com/b/psssql/archive/2012/09/05/how-it-works-online-index-rebuild-can-cause-increased-fragmentation.aspx).</span></span>  
  
## <a name="transaction-log-considerations"></a><span data-ttu-id="c1928-177">交易記錄考量因素</span><span class="sxs-lookup"><span data-stu-id="c1928-177">Transaction Log Considerations</span></span>  
 <span data-ttu-id="c1928-178">大規模的索引作業，無論是離線或線上執行，都會產生大量資料負載，而很快就填滿了交易記錄。</span><span class="sxs-lookup"><span data-stu-id="c1928-178">Large-scale index operations, performed offline or online, can generate large data loads that can cause the transaction log to quickly fill.</span></span> <span data-ttu-id="c1928-179">若要確定可以回復索引作業，在索引作業完成以前，不能截斷交易記錄；不過，在索引作業期間可以備份此記錄。</span><span class="sxs-lookup"><span data-stu-id="c1928-179">To make sure that the index operation can be rolled back, the transaction log cannot be truncated until the index operation has been completed; however, the log can be backed up during the index operation.</span></span> <span data-ttu-id="c1928-180">因此，在索引作業期間，交易記錄必須有足夠的空間，才能儲存索引作業交易與任何並行使用者交易。</span><span class="sxs-lookup"><span data-stu-id="c1928-180">Therefore, the transaction log must have sufficient space to store both the index operation transactions and any concurrent user transactions for the duration of the index operation.</span></span> <span data-ttu-id="c1928-181">如需詳細資訊，請參閱 [索引作業的交易記錄磁碟空間](transaction-log-disk-space-for-index-operations.md)。</span><span class="sxs-lookup"><span data-stu-id="c1928-181">For more information, see [Transaction Log Disk Space for Index Operations](transaction-log-disk-space-for-index-operations.md).</span></span>  
  
## <a name="related-content"></a><span data-ttu-id="c1928-182">相關內容</span><span class="sxs-lookup"><span data-stu-id="c1928-182">Related Content</span></span>  
 [<span data-ttu-id="c1928-183">線上索引作業如何運作</span><span class="sxs-lookup"><span data-stu-id="c1928-183">How Online Index Operations Work</span></span>](how-online-index-operations-work.md)  
  
 [<span data-ttu-id="c1928-184">線上執行索引作業</span><span class="sxs-lookup"><span data-stu-id="c1928-184">Perform Index Operations Online</span></span>](perform-index-operations-online.md)  
  
 [<span data-ttu-id="c1928-185">ALTER INDEX &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="c1928-185">ALTER INDEX &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-index-transact-sql)  
  
 [<span data-ttu-id="c1928-186">CREATE INDEX &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="c1928-186">CREATE INDEX &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/create-index-transact-sql)  
  
  
