---
title: 將資料插入至資料表值參數 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters, inserting data into
ms.assetid: 9c1a3234-4675-40d3-b473-8df06208f880
author: rothja
ms.author: jroth
ms.openlocfilehash: 38e33c6e58bc2633591fa80e095ceafe46f67045
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87594037"
---
# <a name="inserting-data-into-table-valued-parameters"></a><span data-ttu-id="afa87-102">將資料插入至資料表值參數</span><span class="sxs-lookup"><span data-stu-id="afa87-102">Inserting Data into Table-Valued Parameters</span></span>
  <span data-ttu-id="afa87-103">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]Native Client OLE DB 提供者支援兩種模型，供取用者指定資料表值參數資料列的資料：推送模型和提取模型。</span><span class="sxs-lookup"><span data-stu-id="afa87-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider supports two models for the consumer to specify data for table valued parameter rows: a push model and a pull model.</span></span> <span data-ttu-id="afa87-104">您可使用示範提取模型的範例，請參閱 [SQL Server 資料程式設計範例](https://msftdpprodsamples.codeplex.com/)。</span><span class="sxs-lookup"><span data-stu-id="afa87-104">A sample that demonstrates the pull model is available; see [SQL Server Data Programming Samples](https://msftdpprodsamples.codeplex.com/).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="afa87-105">資料表值參數資料行在所有資料列中都必須有非預設值，或在所有資料列中都必須有預設值。</span><span class="sxs-lookup"><span data-stu-id="afa87-105">A table-valued parameter column must have either non-default values in all rows or default values in all rows.</span></span> <span data-ttu-id="afa87-106">在某些資料列中有預設值，而在其他資料列中則沒有預設值是不可能的。</span><span class="sxs-lookup"><span data-stu-id="afa87-106">It is not possible to have default values in some rows but not others.</span></span> <span data-ttu-id="afa87-107">因此，在資料表值參數繫結中，資料表值參數資料列集資料行資料所允許的唯一狀態值為 DBSTATUS_S_ISNULL 和 DBSTATUS_S_OK。</span><span class="sxs-lookup"><span data-stu-id="afa87-107">Therefore, in table-valued parameter bindings, the only status values allowed for table-valued parameter rowset column data are DBSTATUS_S_ISNULL and DBSTATUS_S_OK.</span></span> <span data-ttu-id="afa87-108">DBSTATUS_S_DEFAULT 將會導致失敗，而繫結的狀態值將會設定為 DBSTATUS_E_BADSTATUS。</span><span class="sxs-lookup"><span data-stu-id="afa87-108">DBSTATUS_S_DEFAULT will result in a failure and the bound status value will be set to DBSTATUS_E_BADSTATUS.</span></span>  
  
## <a name="push-model-loads-all-table-valued-paremeter-data-in-memory"></a><span data-ttu-id="afa87-109">發送模型 (將所有資料表值參數資料載入到記憶體中)</span><span class="sxs-lookup"><span data-stu-id="afa87-109">Push Model (Loads All Table-Valued Paremeter Data in Memory)</span></span>  
 <span data-ttu-id="afa87-110">發送模型類似於使用參數集 (也就是 ICommand::Execute 中的 DBPARAMS 參數)。</span><span class="sxs-lookup"><span data-stu-id="afa87-110">The push model is similar to the use of parameter sets (that is, the DBPARAMS parameter in ICommand::Execute).</span></span> <span data-ttu-id="afa87-111">只有在沒有 IRowset 介面之自訂實作的情況下使用資料表值參數資料列集物件時，才會使用發送模型。</span><span class="sxs-lookup"><span data-stu-id="afa87-111">The push model is only used if table-valued parameter rowset objects are used without a customized implementation of IRowset interfaces.</span></span> <span data-ttu-id="afa87-112">當資料表值參數資料列集中的資料列數目很小，而且不打算在將過量的記憶體壓力放在應用程式上時，建議使用發送模型。</span><span class="sxs-lookup"><span data-stu-id="afa87-112">The push model is recommended when the number of rows in the table-valued parameter rowset is small and is not expected to put excessive memory pressure on the application.</span></span> <span data-ttu-id="afa87-113">這比提取模型簡單，因為比起目前在一般 OLE DB 應用程式中常用的功能，發送模型不需要使用來自取用者應用程式的其他任何功能。</span><span class="sxs-lookup"><span data-stu-id="afa87-113">This is simpler than the pull model, because it does not require any more functionality from the consumer application than what is currently common in typical OLE DB applications.</span></span>  
  
 <span data-ttu-id="afa87-114">取用者應該在執行命令前，提供所有資料表值參數資料給提供者。</span><span class="sxs-lookup"><span data-stu-id="afa87-114">The consumer is expected to provide all the table-valued parameter data to the provider before executing a command.</span></span> <span data-ttu-id="afa87-115">若要提供資料，取用者要針對每個資料表值參數擴展資料表值參數資料列集物件。</span><span class="sxs-lookup"><span data-stu-id="afa87-115">To provide the data, the consumer populates a table-valued parameter rowset object for each table-valued parameter.</span></span> <span data-ttu-id="afa87-116">資料表值參數資料列集物件會公開資料列集的 Insert、Set 和 Delete 作業，取用者會使用這些作業來操作資料表值參數資料。</span><span class="sxs-lookup"><span data-stu-id="afa87-116">The table-valued parameter rowset object exposes rowset Insert, Set, and Delete operations, which the consumer will use to manipulate the table-valued parameter data.</span></span> <span data-ttu-id="afa87-117">提供者將會在執行時間，從此資料表值參數資料列集物件提取資料。</span><span class="sxs-lookup"><span data-stu-id="afa87-117">The provider will fetch the data from this table-valued parameter rowset object at execution time.</span></span>  
  
 <span data-ttu-id="afa87-118">將資料表值參數資料列集物件提供給取用者時，取用者可以將其當做資料列集物件處理。</span><span class="sxs-lookup"><span data-stu-id="afa87-118">When a table-valued parameter rowset object is provided to the consumer, the consumer can process it as a rowset object.</span></span> <span data-ttu-id="afa87-119">取用者可以使用 IColumnsInfo::GetColumnInfo 或 IColumnsRowset::GetColumnsRowset 介面方法，取得每個資料行的類型資訊 (類型、最大長度、精確度與小數位數)。</span><span class="sxs-lookup"><span data-stu-id="afa87-119">The consumer can obtain the type information of each column (type, maximum length, precision, and scale) by using the IColumnsInfo::GetColumnInfo or IColumnsRowset::GetColumnsRowset interface method.</span></span> <span data-ttu-id="afa87-120">接著，取用者會建立存取子來指定資料的繫結。</span><span class="sxs-lookup"><span data-stu-id="afa87-120">The consumer then creates an accessor to specify the bindings for the data.</span></span> <span data-ttu-id="afa87-121">下一步是將資料的資料列插入到資料表值參數資料列集。</span><span class="sxs-lookup"><span data-stu-id="afa87-121">The next step is to insert rows of data into the table-valued parameter rowset.</span></span> <span data-ttu-id="afa87-122">您可以使用 IRowsetChange::InsertRow 來完成此作業。</span><span class="sxs-lookup"><span data-stu-id="afa87-122">This can be done by using IRowsetChange::InsertRow.</span></span> <span data-ttu-id="afa87-123">如果您必須操作資料，也可以在資料表值參數資料列集物件上使用 IRowsetChange::SetData 或 IRowsetChange::DeleteRows。</span><span class="sxs-lookup"><span data-stu-id="afa87-123">IRowsetChange::SetData or IRowsetChange::DeleteRows can also be used on the table-valued parameter rowset object if you have to manipulate the data.</span></span> <span data-ttu-id="afa87-124">資料表值參數資料列集物件是計數的參考，類似於資料流物件。</span><span class="sxs-lookup"><span data-stu-id="afa87-124">Table-valued parameter rowset objects are reference counted, similar to stream objects.</span></span>  
  
 <span data-ttu-id="afa87-125">如果使用 IColumnsRowset::GetColumnsRowset，則會在產生之資料行的資料列集物件上，進行 IRowset::GetNextRows、IRowset::GetData 和 IRowset::ReleaseRows 方法的後續呼叫。</span><span class="sxs-lookup"><span data-stu-id="afa87-125">If IColumnsRowset::GetColumnsRowset is used, there will be subsequent calls to IRowset::GetNextRows, IRowset::GetData, and IRowset::ReleaseRows methods on the rowset object of the resulting column.</span></span>  
  
 <span data-ttu-id="afa87-126">在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 提供者開始執行命令之後，就會從這個資料表值參數資料列集物件提取資料表值參數值，並將其傳送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="afa87-126">After the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider begins executing the command, the table-valued parameter values will be fetched from this table-valued parameter rowset object and sent to the server.</span></span>  
  
 <span data-ttu-id="afa87-127">發送模型需要取用者的最少工作，但是使用的記憶體比提取模型更多，因為所有資料表值參數資料在執行時間都必須位於記憶體中。</span><span class="sxs-lookup"><span data-stu-id="afa87-127">The push model requires minimal work by the consumer, but uses more memory than the pull model, because all the table-valued parameter data has to be in memory at execution time.</span></span>  
  
## <a name="pull-model-obtaining-table-valued-parameter-data-on-demand-from-the-consumer"></a><span data-ttu-id="afa87-128">提取模型 (視需要從取用者取得資料表值參數資料)</span><span class="sxs-lookup"><span data-stu-id="afa87-128">Pull Model (Obtaining Table-Valued Parameter Data on Demand from the Consumer)</span></span>  
 <span data-ttu-id="afa87-129">提取模型對於下列兩種案例很實用：</span><span class="sxs-lookup"><span data-stu-id="afa87-129">The pull model is useful for two scenarios:</span></span>  
  
-   <span data-ttu-id="afa87-130">以資料流方式處理資料列。</span><span class="sxs-lookup"><span data-stu-id="afa87-130">To stream rows.</span></span>  
  
-   <span data-ttu-id="afa87-131">如果其他提供者的資料列集當做資料表值參數值使用。</span><span class="sxs-lookup"><span data-stu-id="afa87-131">If a rowset from another provider is being used as the table-valued parameter value.</span></span>  
  
 <span data-ttu-id="afa87-132">在提取模型中，取用者會視需要提供資料給提供者。</span><span class="sxs-lookup"><span data-stu-id="afa87-132">In the pull model, the consumer provides data on demand to the provider.</span></span> <span data-ttu-id="afa87-133">如果您的應用程式有許多資料插入，而且記憶體中的資料表值參數資料列集資料會導致過量的記憶體存取，請使用此方法。</span><span class="sxs-lookup"><span data-stu-id="afa87-133">Use this approach if your application has many data insertions, and table-valued parameter rowset data in memory would result in excessive memory access.</span></span> <span data-ttu-id="afa87-134">如果使用多個 OLE DB 提供者，取用者提取模型會讓取用者提供任何資料列集物件，當做資料表值參數值。</span><span class="sxs-lookup"><span data-stu-id="afa87-134">If multiple OLE DB providers are used, the consumer pull model enables the consumer to provide any rowset object as the table-valued parameter value.</span></span>  
  
 <span data-ttu-id="afa87-135">若要使用提取模型，取用者必須提供資料列集物件自己的實作。</span><span class="sxs-lookup"><span data-stu-id="afa87-135">To use the pull model, consumers have to provide their own implementation of a rowset object.</span></span> <span data-ttu-id="afa87-136">搭配資料表值參數資料列集 (CLSID_ROWSET_TVP) 使用提取模型時，需要取用者彙總提供者透過 ITableDefinitionWithConstraints::CreateTableWithConstraints 方法或 IOpenRowset::OpenRowset 方法公開的資料表值參數資料列集物件。</span><span class="sxs-lookup"><span data-stu-id="afa87-136">When using the pull model with table-valued parameter rowsets (CLSID_ROWSET_TVP), the consumer is required to aggregate the table-valued parameter rowset object that the provider exposes through the ITableDefinitionWithConstraints::CreateTableWithConstraints method or the IOpenRowset::OpenRowset method.</span></span> <span data-ttu-id="afa87-137">只有取用者物件會覆寫 IRowset 介面實作。</span><span class="sxs-lookup"><span data-stu-id="afa87-137">The consumer object is only expected to override the IRowset interface implementation.</span></span> <span data-ttu-id="afa87-138">您必須覆寫下列函數：</span><span class="sxs-lookup"><span data-stu-id="afa87-138">You must override the following functions:</span></span>  
  
-   <span data-ttu-id="afa87-139">IRowset::GetNextRows</span><span class="sxs-lookup"><span data-stu-id="afa87-139">IRowset::GetNextRows</span></span>  
  
-   <span data-ttu-id="afa87-140">IRowset::AddRefRows</span><span class="sxs-lookup"><span data-stu-id="afa87-140">IRowset::AddRefRows</span></span>  
  
-   <span data-ttu-id="afa87-141">IRowset::GetData</span><span class="sxs-lookup"><span data-stu-id="afa87-141">IRowset::GetData</span></span>  
  
-   <span data-ttu-id="afa87-142">IRowset::ReleaseRows</span><span class="sxs-lookup"><span data-stu-id="afa87-142">IRowset::ReleaseRows</span></span>  
  
-   <span data-ttu-id="afa87-143">IRowset::RestartPosition</span><span class="sxs-lookup"><span data-stu-id="afa87-143">IRowset::RestartPosition</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="afa87-144">Native Client OLE DB 提供者會從取用者資料列集物件一次讀取一或多個資料列，以支援資料表值參數中的資料流行為。</span><span class="sxs-lookup"><span data-stu-id="afa87-144">Native Client OLE DB Provider will read one or more rows at a time from the consumer rowset object to support streaming behavior in table-valued parameters.</span></span> <span data-ttu-id="afa87-145">例如，使用者在磁碟 (不在記憶體) 上可能有資料表值參數資料列集資料，而且可能會在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 提供者需要時，從磁碟實作功能來讀取資料。</span><span class="sxs-lookup"><span data-stu-id="afa87-145">For example, the user might have the table-valued parameter rowset data on disk (not in memory) and might implement the functionality to read data from the disk when required by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider.</span></span>  
  
 <span data-ttu-id="afa87-146">取用者會 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 在資料表值參數資料列集物件上使用 IAccessor：： CreateAccessor，將其資料格式傳達給 Native Client OLE DB 提供者。</span><span class="sxs-lookup"><span data-stu-id="afa87-146">The consumer will communicate its data format to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider by using IAccessor::CreateAccessor on the table-valued parameter rowset object.</span></span> <span data-ttu-id="afa87-147">從取用者緩衝區讀取資料時，提供者會確認透過至少一個存取子控制代碼可以取得所有可寫入，而且非預設的資料行，並使用對應的控制代碼來讀取資料行資料。</span><span class="sxs-lookup"><span data-stu-id="afa87-147">When reading data from the consumer buffer, the provider verifies that all the writable and non-default columns are available through at least one accessor handle, and uses the corresponding handles to read columns data.</span></span> <span data-ttu-id="afa87-148">為避免模稜兩可的情況，在資料表值參數資料列集資料行和繫結之間應該有一對一的對應。</span><span class="sxs-lookup"><span data-stu-id="afa87-148">To avoid ambiguity, there should be a one-to-one correspondence between a table-valued parameter rowset column and a binding.</span></span> <span data-ttu-id="afa87-149">相同資料行的重複繫結將會導致錯誤。</span><span class="sxs-lookup"><span data-stu-id="afa87-149">Duplicate bindings to the same column will result in an error.</span></span> <span data-ttu-id="afa87-150">同時，每個存取子依序都應該有 DBBindings 的 *iOrdinal* 成員。</span><span class="sxs-lookup"><span data-stu-id="afa87-150">Also, each accessor is expected to have the *iOrdinal* member of DBBindings in sequence.</span></span> <span data-ttu-id="afa87-151">IRowset::GetData 的呼叫將會與每個資料列的存取子數目一樣多，而且呼叫的順序將會以 *iOrdinal* 值的順序為基礎 (從低到高)。</span><span class="sxs-lookup"><span data-stu-id="afa87-151">There will be as many calls to IRowset::GetData as the number of accessors per row, and the order of calls will be based on the order of *iOrdinal* value from lower to higher values.</span></span>  
  
 <span data-ttu-id="afa87-152">提供者應該實作透過資料表值參數資料列集物件所公開的大部分介面。</span><span class="sxs-lookup"><span data-stu-id="afa87-152">The provider is expected to implement most of the interfaces exposed by the table-valued parameter rowset object.</span></span> <span data-ttu-id="afa87-153">取用者將會以最少的介面 (IRowset) 實作資料列集物件。</span><span class="sxs-lookup"><span data-stu-id="afa87-153">The consumer will implement a rowset object with minimal interfaces (IRowset).</span></span> <span data-ttu-id="afa87-154">由於未公開彙總的緣故，剩餘的強制資料列集物件介面將會透過資料表值參數資料列集物件實作。</span><span class="sxs-lookup"><span data-stu-id="afa87-154">Because of blind aggregation, the remaining mandatory rowset object interfaces will be implemented by the table-valued parameter rowset object.</span></span>  
  
 <span data-ttu-id="afa87-155">對於其他任何資料列集物件 (例如，針對任何 OLE DB 提供者取得的資料列集物件)，取用者提供的資料列集必須依照 OLE DB 規格所指定的方式，實作所有強制資料列集物件介面。</span><span class="sxs-lookup"><span data-stu-id="afa87-155">For any other rowset object, such as rowset objects obtained for any OLE DB provider, the consumer-provided rowset must implement all the mandatory rowset object interfaces as specified in the OLE DB specification.</span></span>  
  
 <span data-ttu-id="afa87-156">執行時，[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 提供者將會回呼到資料列集物件來提取資料列並讀取資料行資料。</span><span class="sxs-lookup"><span data-stu-id="afa87-156">At the time of execution, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider will call back to the rowset object to fetch rows and read column data.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="afa87-157">另請參閱</span><span class="sxs-lookup"><span data-stu-id="afa87-157">See Also</span></span>  
 <span data-ttu-id="afa87-158">[資料表值參數 &#40;OLE DB&#41;](table-valued-parameters-ole-db.md) </span><span class="sxs-lookup"><span data-stu-id="afa87-158">[Table-Valued Parameters &#40;OLE DB&#41;](table-valued-parameters-ole-db.md) </span></span>  
 [<span data-ttu-id="afa87-159">使用資料表值參數 &#40;OLE DB&#41;</span><span class="sxs-lookup"><span data-stu-id="afa87-159">Use Table-Valued Parameters &#40;OLE DB&#41;</span></span>](../native-client-ole-db-how-to/use-table-valued-parameters-ole-db.md)  
  
