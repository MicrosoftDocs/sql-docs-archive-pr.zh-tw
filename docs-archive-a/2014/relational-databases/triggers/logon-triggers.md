---
title: 登入觸發程序 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
f1_keywords:
- logon triggers
- login triggers
helpviewer_keywords:
- triggers [SQL Server], logon
ms.assetid: 2f0ebb2f-de10-482d-9806-1a5de5b312b8
author: rothja
ms.author: jroth
ms.openlocfilehash: cda0be25f07ed2ee283b9707884041e7c6e4692f
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87606121"
---
# <a name="logon-triggers"></a><span data-ttu-id="b617d-102">登入觸發程序</span><span class="sxs-lookup"><span data-stu-id="b617d-102">Logon Triggers</span></span>
  <span data-ttu-id="b617d-103">登入觸發程序會引發預存程序來回應 LOGON 事件。</span><span class="sxs-lookup"><span data-stu-id="b617d-103">Logon triggers fire stored procedures in response to a LOGON event.</span></span> <span data-ttu-id="b617d-104">當 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]執行個體建立使用者工作階段時，就會引發這個事件。</span><span class="sxs-lookup"><span data-stu-id="b617d-104">This event is raised when a user session is established with an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="b617d-105">登入觸發程序會在登入驗證階段結束之後，但在使用者工作階段實際建立之前引發。</span><span class="sxs-lookup"><span data-stu-id="b617d-105">Logon triggers fire after the authentication phase of logging in finishes, but before the user session is actually established.</span></span> <span data-ttu-id="b617d-106">因此，從觸發程序內產生且一般會顯示給使用者的所有訊息，例如錯誤訊息和來自 PRINT 陳述式的訊息，都會轉至 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 錯誤記錄檔。</span><span class="sxs-lookup"><span data-stu-id="b617d-106">Therefore, all messages originating inside the trigger that would typically reach the user, such as error messages and messages from the PRINT statement, are diverted to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="b617d-107">如果驗證失敗，登入觸發程序就不會引發。</span><span class="sxs-lookup"><span data-stu-id="b617d-107">Logon triggers do not fire if authentication fails.</span></span>  
  
 <span data-ttu-id="b617d-108">您可以使用登入觸發程序稽核和控制伺服器工作階段，例如追蹤登入活動、限制登入 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]，或限制特定登入的工作階段數。</span><span class="sxs-lookup"><span data-stu-id="b617d-108">You can use logon triggers to audit and control server sessions, such as by tracking login activity, restricting logins to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], or limiting the number of sessions for a specific login.</span></span> <span data-ttu-id="b617d-109">例如，在下列程式碼中，如果登入 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login_test *已經建立三個使用者工作階段，登入觸發程序就會拒絕該登入對* 所起始的登入嘗試。</span><span class="sxs-lookup"><span data-stu-id="b617d-109">For example, in the following code, the logon trigger denies log in attempts to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] initiated by login *login_test* if there are already three user sessions created by that login.</span></span>  
  
 [!code-sql[TriggerDDL#LogonTrigger1](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#logontrigger1)]  
  
 <span data-ttu-id="b617d-110">請注意，LOGON 事件對應於 AUDIT_LOGIN SQL 追蹤事件，該事件可用於 [事件通知](../service-broker/event-notifications.md)。</span><span class="sxs-lookup"><span data-stu-id="b617d-110">Note that the LOGON event corresponds to the AUDIT_LOGIN SQL Trace event, which can be used in [Event Notifications](../service-broker/event-notifications.md).</span></span> <span data-ttu-id="b617d-111">觸發程序與事件通知的主要差別在於，觸發程序會與事件同步引發，而事件通知則是非同步的。</span><span class="sxs-lookup"><span data-stu-id="b617d-111">The primary difference between triggers and event notifications is that triggers are raised synchronously with events, whereas event notifications are asynchronous.</span></span> <span data-ttu-id="b617d-112">這表示如果不要建立工作階段，就必須使用登入觸發程序。</span><span class="sxs-lookup"><span data-stu-id="b617d-112">This means, for example, that if you want to stop a session from being established, you must use a logon trigger.</span></span> <span data-ttu-id="b617d-113">AUDIT_LOGIN 事件的事件通知則無法這麼做。</span><span class="sxs-lookup"><span data-stu-id="b617d-113">An event notification on an AUDIT_LOGIN event cannot be used for this purpose.</span></span>  
  
## <a name="specifying-first-and-last-trigger"></a><span data-ttu-id="b617d-114">指定第一個和最後一個觸發程序</span><span class="sxs-lookup"><span data-stu-id="b617d-114">Specifying First and Last Trigger</span></span>  
 <span data-ttu-id="b617d-115">LOGON 事件可以定義多個觸發程序。</span><span class="sxs-lookup"><span data-stu-id="b617d-115">Multiple triggers can be defined on the LOGON event.</span></span> <span data-ttu-id="b617d-116">您可以使用 [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) 系統預存程序，將這些觸發程序的其中任一個指定為對事件第一個或最後一個引發的觸發程序。</span><span class="sxs-lookup"><span data-stu-id="b617d-116">Any one of these triggers can be designated the first or last trigger to be fired on an event by using the [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) system stored procedure.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="b617d-117">不保證其餘觸發程序的執行順序。</span><span class="sxs-lookup"><span data-stu-id="b617d-117">does not guarantee the execution order of the remaining triggers.</span></span>  
  
## <a name="managing-transactions"></a><span data-ttu-id="b617d-118">管理交易</span><span class="sxs-lookup"><span data-stu-id="b617d-118">Managing Transactions</span></span>  
 <span data-ttu-id="b617d-119">在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 引發登入觸發程序之前， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 會建立獨立於任何使用者交易以外的隱含交易。</span><span class="sxs-lookup"><span data-stu-id="b617d-119">Before [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fires a logon trigger, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an implicit transaction that is independent from any user transaction.</span></span> <span data-ttu-id="b617d-120">因此，當第一個登入觸發程序開始引發時，交易計數為 1。</span><span class="sxs-lookup"><span data-stu-id="b617d-120">Therefore, when the first logon trigger starts firing, the transaction count is 1.</span></span> <span data-ttu-id="b617d-121">等到所有登入觸發程序完成執行之後，交易便認可。</span><span class="sxs-lookup"><span data-stu-id="b617d-121">After all the logon triggers finish executing, the transaction commits.</span></span> <span data-ttu-id="b617d-122">就如同其他類型的觸發程序一樣，如果登入觸發程序完成執行時的交易計數為 0， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 會傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="b617d-122">As with other types of triggers, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] returns an error if a logon trigger finishes execution with a transaction count of 0.</span></span> <span data-ttu-id="b617d-123">ROLLBACK TRANSACTION 陳述式會將交易計數重設為 0 (即使該陳述式是從巢狀交易內發出)。</span><span class="sxs-lookup"><span data-stu-id="b617d-123">The ROLLBACK TRANSACTION statement resets the transaction count to 0, even if the statement is issued inside a nested transaction.</span></span> <span data-ttu-id="b617d-124">COMMIT TRANSACTION 可能會將交易計數遞減為 0。</span><span class="sxs-lookup"><span data-stu-id="b617d-124">COMMIT TRANSACTION might decrement the transaction count to 0.</span></span> <span data-ttu-id="b617d-125">因此建議不要從登入觸發程序內發出 COMMIT TRANSACTION 陳述式。</span><span class="sxs-lookup"><span data-stu-id="b617d-125">Therefore, we advise against issuing COMMIT TRANSACTION statements inside logon triggers.</span></span>  
  
 <span data-ttu-id="b617d-126">在登入觸發程序內使用 ROLLBACK TRANSACTION 陳述式時，請考慮下列事項：</span><span class="sxs-lookup"><span data-stu-id="b617d-126">Consider the following when you are using a ROLLBACK TRANSACTION statement inside logon triggers:</span></span>  
  
-   <span data-ttu-id="b617d-127">一直到 ROLLBACK TRANSACTION 的時間點所做的任何資料修改都會回復。</span><span class="sxs-lookup"><span data-stu-id="b617d-127">Any data modifications made up to the point of ROLLBACK TRANSACTION are rolled back.</span></span> <span data-ttu-id="b617d-128">這些修改包括目前觸發程序所做的修改，以及先前觸發程序對相同事件執行時所做的修改。</span><span class="sxs-lookup"><span data-stu-id="b617d-128">These modifications include those made by the current trigger and those made by previous triggers that executed on the same event.</span></span> <span data-ttu-id="b617d-129">該特定事件的任何其他觸發程序則不會執行。</span><span class="sxs-lookup"><span data-stu-id="b617d-129">Any remaining triggers for the specific event are not executed.</span></span>  
  
-   <span data-ttu-id="b617d-130">目前觸發程序會繼續執行 ROLLBACK 陳述式以後出現的任何其他陳述式。</span><span class="sxs-lookup"><span data-stu-id="b617d-130">The current trigger continues to execute any remaining statements that appear after the ROLLBACK statement.</span></span> <span data-ttu-id="b617d-131">如果有任何這些陳述式修改資料，不會回復這些修改。</span><span class="sxs-lookup"><span data-stu-id="b617d-131">If any of these statements modify data, the modifications are not rolled back.</span></span>  
  
 <span data-ttu-id="b617d-132">如果在對 LOGON 事件執行觸發程序時發生下列任一情況，不會建立使用者工作階段：</span><span class="sxs-lookup"><span data-stu-id="b617d-132">A user session is not established if any one of the following conditions occur during execution of a trigger on a LOGON event:</span></span>  
  
-   <span data-ttu-id="b617d-133">原始隱含交易回復或失敗。</span><span class="sxs-lookup"><span data-stu-id="b617d-133">The original implicit transaction is rolled back or fails.</span></span>  
  
-   <span data-ttu-id="b617d-134">觸發程序主體內引發嚴重性超過 20 的錯誤。</span><span class="sxs-lookup"><span data-stu-id="b617d-134">An error that has severity greater than 20 is raised inside the trigger body.</span></span>  
  
## <a name="disabling-a-logon-trigger"></a><span data-ttu-id="b617d-135">停用登入觸發程序</span><span class="sxs-lookup"><span data-stu-id="b617d-135">Disabling a Logon Trigger</span></span>  
 <span data-ttu-id="b617d-136">登入觸發程序可以有效地防止所有使用者成功連接到 [!INCLUDE[ssDE](../../../includes/ssde-md.md)]，包括 `sysadmin` 固定伺服器角色的成員。</span><span class="sxs-lookup"><span data-stu-id="b617d-136">A logon trigger can effectively prevent successful connections to the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] for all users, including members of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="b617d-137">當登入觸發程序防止連接時，`sysadmin` 固定伺服器角色的成員可以使用專用管理員連接或以最低組態模式 (-f) 啟動 [!INCLUDE[ssDE](../../../includes/ssde-md.md)]，藉以進行連接。</span><span class="sxs-lookup"><span data-stu-id="b617d-137">When a logon trigger is preventing connections, members of the `sysadmin` fixed server role can connect by using the dedicated administrator connection, or by starting the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] in minimal configuration mode (-f).</span></span> <span data-ttu-id="b617d-138">如需詳細資訊，請參閱 [Database Engine Service Startup Options](../../database-engine/configure-windows/database-engine-service-startup-options.md)。</span><span class="sxs-lookup"><span data-stu-id="b617d-138">For more information, see [Database Engine Service Startup Options](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="b617d-139">相關工作</span><span class="sxs-lookup"><span data-stu-id="b617d-139">Related Tasks</span></span>  
  
|<span data-ttu-id="b617d-140">Task</span><span class="sxs-lookup"><span data-stu-id="b617d-140">Task</span></span>|<span data-ttu-id="b617d-141">主題</span><span class="sxs-lookup"><span data-stu-id="b617d-141">Topic</span></span>|  
|----------|-----------|  
|<span data-ttu-id="b617d-142">描述如何建立登入觸發程序。</span><span class="sxs-lookup"><span data-stu-id="b617d-142">Describes how to create logon triggers.</span></span> <span data-ttu-id="b617d-143">登入觸發程序可以從任何資料庫建立，但會在伺服器層級註冊並儲存在 **master** 資料庫中。</span><span class="sxs-lookup"><span data-stu-id="b617d-143">Logon triggers can be created from any database, but are registered at the server level and reside in the **master** database.</span></span>|[<span data-ttu-id="b617d-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="b617d-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/create-trigger-transact-sql)|  
|<span data-ttu-id="b617d-145">描述如何修改登入觸發程序。</span><span class="sxs-lookup"><span data-stu-id="b617d-145">Describes how to modify logon triggers.</span></span>|[<span data-ttu-id="b617d-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="b617d-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-trigger-transact-sql)|  
|<span data-ttu-id="b617d-147">描述如何刪除登入觸發程序。</span><span class="sxs-lookup"><span data-stu-id="b617d-147">Describes how to delete logon triggers.</span></span>|[<span data-ttu-id="b617d-148">DROP TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="b617d-148">DROP TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/drop-trigger-transact-sql)|  
|<span data-ttu-id="b617d-149">描述如何傳回有關登入觸發程序的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="b617d-149">Describes how to return information about logon triggers.</span></span>|[<span data-ttu-id="b617d-150">sys.server_triggers &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="b617d-150">sys.server_triggers &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-triggers-transact-sql)<br /><br /> [<span data-ttu-id="b617d-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="b617d-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-trigger-events-transact-sql)|  
|<span data-ttu-id="b617d-152">描述如何擷取登入觸發程序事件資料。</span><span class="sxs-lookup"><span data-stu-id="b617d-152">Describes how to capture logon trigger event data.</span></span>||  
  
## <a name="see-also"></a><span data-ttu-id="b617d-153">另請參閱</span><span class="sxs-lookup"><span data-stu-id="b617d-153">See Also</span></span>  
 [<span data-ttu-id="b617d-154">DDL 觸發程序</span><span class="sxs-lookup"><span data-stu-id="b617d-154">DDL Triggers</span></span>](../triggers/ddl-triggers.md)  
  
  
