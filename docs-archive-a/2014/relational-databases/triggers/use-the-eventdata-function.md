---
title: 使用 EVENTDATA 函式 | Microsoft 文件
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- EVENTDATA function
- DDL triggers, EVENTDATA function
ms.assetid: 675b8320-9c73-4526-bd2f-91ba42c1b604
author: rothja
ms.author: jroth
ms.openlocfilehash: 57fb59a3954fb00ab943944c58cccd352c7270d2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87606118"
---
# <a name="use-the-eventdata-function"></a><span data-ttu-id="75b40-102">使用 EVENTDATA 函數</span><span class="sxs-lookup"><span data-stu-id="75b40-102">Use the EVENTDATA Function</span></span>
  <span data-ttu-id="75b40-103">使用 EVENTDATA 函數擷取引發 DDL 觸發程序之事件的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="75b40-103">Information about an event that fires a DDL trigger is captured by using the EVENTDATA function.</span></span> <span data-ttu-id="75b40-104">此函數會傳回 `xml` 值。</span><span class="sxs-lookup"><span data-stu-id="75b40-104">This function returns an `xml` value.</span></span> <span data-ttu-id="75b40-105">XML 結構描述包括有關下列項目的資訊：</span><span class="sxs-lookup"><span data-stu-id="75b40-105">The XML schema includes information about the following:</span></span>  
  
-   <span data-ttu-id="75b40-106">事件的時間。</span><span class="sxs-lookup"><span data-stu-id="75b40-106">The time of the event.</span></span>  
  
-   <span data-ttu-id="75b40-107">執行觸發程序時連接的系統處理序識別碼 (SPID)。</span><span class="sxs-lookup"><span data-stu-id="75b40-107">The System Process ID (SPID) of the connection when the trigger executed.</span></span>  
  
-   <span data-ttu-id="75b40-108">引發觸發程序的事件類型。</span><span class="sxs-lookup"><span data-stu-id="75b40-108">The type of event that fired the trigger.</span></span>  
  
 <span data-ttu-id="75b40-109">視事件類型而定，結構描述會包括其他資訊，例如發生事件的資料庫、發生事件的物件以及事件的 [!INCLUDE[tsql](../../includes/tsql-md.md)] 陳述式。</span><span class="sxs-lookup"><span data-stu-id="75b40-109">Depending on the event type, the schema then includes additional information such as the database in which the event occurred, the object against which the event occurred, and the [!INCLUDE[tsql](../../includes/tsql-md.md)] statement of the event.</span></span> <span data-ttu-id="75b40-110">如需詳細資訊，請參閱 [DDL 觸發程序](ddl-triggers.md)。</span><span class="sxs-lookup"><span data-stu-id="75b40-110">For more information, see [DDL Triggers](ddl-triggers.md).</span></span>  
  
 <span data-ttu-id="75b40-111">例如，下列 DDL 觸發程序是在 [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] 範例資料庫中建立：</span><span class="sxs-lookup"><span data-stu-id="75b40-111">For example, the following DDL trigger is created in the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database:</span></span>  
  
```  
CREATE TRIGGER safety   
ON DATABASE   
FOR CREATE_TABLE   
AS   
    PRINT 'CREATE TABLE Issued.'  
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','nvarchar(max)')  
   RAISERROR ('New tables cannot be created in this database.', 16, 1)   
   ROLLBACK  
;  
```  
  
 <span data-ttu-id="75b40-112">接著會執行下列 `CREATE TABLE` 陳述式：</span><span class="sxs-lookup"><span data-stu-id="75b40-112">The following `CREATE TABLE` statement is then run:</span></span>  
  
 `CREATE TABLE NewTable (Column1 int);`  
  
 <span data-ttu-id="75b40-113">DDL 觸發程序中的 `EVENTDATA()` 陳述式，會擷取到不容許的 `CREATE TABLE` 陳述式文字。</span><span class="sxs-lookup"><span data-stu-id="75b40-113">The `EVENTDATA()` statement in the DDL trigger captures the text of the `CREATE TABLE` statement that is not allowed.</span></span> <span data-ttu-id="75b40-114">針對 EVENTDATA 所產生的資料使用 XQuery 語句，並抓取專案，即可達成此目的 `xml` \<CommandText> 。</span><span class="sxs-lookup"><span data-stu-id="75b40-114">This is achieved by using an XQuery statement against the `xml` data that is generated by EVENTDATA and retrieving the \<CommandText> element.</span></span> <span data-ttu-id="75b40-115">如需詳細資訊，請參閱 [XQuery 語言參考 &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server)。</span><span class="sxs-lookup"><span data-stu-id="75b40-115">For more information, see [XQuery Language Reference &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span></span>  
  
> [!CAUTION]  
>  <span data-ttu-id="75b40-116">EVENTDATA 會擷取 CREATE_SCHEMA 事件的資料，以及對應之 CREATE SCHEMA 定義的 <schema_element> (如果有的話)。</span><span class="sxs-lookup"><span data-stu-id="75b40-116">EVENTDATA captures the data of CREATE_SCHEMA events as well as the <schema_element> of the corresponding CREATE SCHEMA definition, if any exists.</span></span> <span data-ttu-id="75b40-117">此外，EVENTDATA 還會將 <schema_element> 定義識別為個別事件。</span><span class="sxs-lookup"><span data-stu-id="75b40-117">Additionally, EVENTDATA recognizes the <schema_element> definition as a separate event.</span></span> <span data-ttu-id="75b40-118">因此，在 CREATE_SCHEMA 事件和 CREATE SCHEMA 定義之 <schema_element> 代表的事件上建立的 DDL 觸發程序，可能會傳回相同的事件資料兩次，例如 `TSQLCommand` 資料。</span><span class="sxs-lookup"><span data-stu-id="75b40-118">Therefore, a DDL trigger created on both a CREATE_SCHEMA event, and an event represented by the <schema_element> of the CREATE SCHEMA definition, may return the same event data twice, such as the `TSQLCommand` data.</span></span> <span data-ttu-id="75b40-119">例如，假設在 CREATE_SCHEMA 和 CREATE_TABLE 兩個事件上建立 DDL 觸發程序，並執行下列批次：</span><span class="sxs-lookup"><span data-stu-id="75b40-119">For example, consider a DDL trigger that is created on both the CREATE_SCHEMA and CREATE_TABLE events and the following batch is run:</span></span>  
>   
>  `CREATE SCHEMA s`  
>   
>  `CREATE TABLE t1 (col1 int)`  
>   
>  <span data-ttu-id="75b40-120">如果應用程式擷取 CREATE_TABLE 事件的 `TSQLCommand` 資料，請注意這項資料可能會出現兩次：一次是在發生 CREATE_SCHEMA 事件時，另一次則是在發生 CREATE_TABLE 事件時。</span><span class="sxs-lookup"><span data-stu-id="75b40-120">If the application retrieves the `TSQLCommand` data of the CREATE_TABLE event, be aware that this data may appear two times: once when the CREATE_SCHEMA event occurs, and again when the CREATE_TABLE event occurs.</span></span> <span data-ttu-id="75b40-121">請避免同時在 CREATE_SCHEMA 事件和任何對應之 CREATE SCHEMA 定義的 <schema_element> 文字上建立 DDL 觸發程序，或在應用程式中建立邏輯，使應用程式不會重複處理相同的事件。</span><span class="sxs-lookup"><span data-stu-id="75b40-121">Avoid creating DDL triggers on both the CREATE_SCHEMA events and the <schema_element> texts of any corresponding CREATE SCHEMA definitions, or build logic into your application so that the same event is not processed twice.</span></span>  
  
## <a name="alter-table-and-alter-database-events"></a><span data-ttu-id="75b40-122">ALTER TABLE 和 ALTER DATABASE 事件</span><span class="sxs-lookup"><span data-stu-id="75b40-122">ALTER TABLE and ALTER DATABASE Events</span></span>  
 <span data-ttu-id="75b40-123">ALTER_TABLE 和 ALTER_DATABASE 事件的事件資料也包含受到 DDL 陳述式所影響之其他物件的名稱和類型，以及在這些物件上執行的動作。</span><span class="sxs-lookup"><span data-stu-id="75b40-123">The event data for the ALTER_TABLE and ALTER_DATABASE events also includes the names and types of other objects affected by the DDL statement and the action performed on these objects.</span></span> <span data-ttu-id="75b40-124">ALTER_TABLE 事件資料包含受到 ALTER TABLE 陳述式所影響之資料行、條件約束或觸發程序的名稱，以及在這些受影響物件上執行的動作 (建立、更改、卸除、啟用或停用)。</span><span class="sxs-lookup"><span data-stu-id="75b40-124">The ALTER_TABLE event data includes the names of the columns, constraints, or triggers affected by the ALTER TABLE statement and the action (create, alter, drop, enable, or disable) performed on the affected objects.</span></span> <span data-ttu-id="75b40-125">ALTER_DATABASE 事件資料包含受到 ALTER DATABASE 陳述式所影響之任何檔案或檔案群組的名稱，以及在這些受影響物件上執行的動作 (建立、更改或卸除)。</span><span class="sxs-lookup"><span data-stu-id="75b40-125">The ALTER_DATABASE event data includes the names of any files or filegroups affected by the ALTER DATABASE statement and the action (create, alter, or drop) performed on the affected objects.</span></span>  
  
 <span data-ttu-id="75b40-126">例如，您可以在 AdventureWorks 範例資料庫中建立下列 DDL 觸發程序：</span><span class="sxs-lookup"><span data-stu-id="75b40-126">For example, create the following DDL trigger in the AdventureWorks sample database:</span></span>  
  
```  
CREATE TRIGGER ColumnChanges  
ON DATABASE   
FOR ALTER_TABLE  
AS  
-- Detect whether a column was created/altered/dropped.  
SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]', 'nvarchar(max)')  
RAISERROR ('Table schema cannot be modified in this database.', 16, 1);  
ROLLBACK;  
```  
  
 <span data-ttu-id="75b40-127">然後，執行下列違反條件約束的 ALTER TABLE 陳述式：</span><span class="sxs-lookup"><span data-stu-id="75b40-127">Then execute the following ALTER TABLE statement that violates a constraint:</span></span>  
  
```  
ALTER TABLE Person.Address ALTER COLUMN ModifiedDate date;   
```  
  
 <span data-ttu-id="75b40-128">DDL 觸發程序中的 EVENTDATA() 陳述式會擷取不允許的 `ALTER TABLE` 陳述式文字。</span><span class="sxs-lookup"><span data-stu-id="75b40-128">The EVENTDATA() statement in the DDL trigger captures the text of the `ALTER TABLE` statement that is not permitted.</span></span>  
  
## <a name="example"></a><span data-ttu-id="75b40-129">範例</span><span class="sxs-lookup"><span data-stu-id="75b40-129">Example</span></span>  
 <span data-ttu-id="75b40-130">您可以使用 EVENTDATA 函數來建立事件的記錄。</span><span class="sxs-lookup"><span data-stu-id="75b40-130">You can use the EVENTDATA function to create a log of events.</span></span> <span data-ttu-id="75b40-131">在下列範例中，會建立儲存事件資訊的資料表。</span><span class="sxs-lookup"><span data-stu-id="75b40-131">In the following example, a table is created to store event information.</span></span> <span data-ttu-id="75b40-132">每次發生資料庫層級 DDL 事件時，便會在使用下列資訊擴展資料表的目前資料庫上建立 DDL 觸發程序：</span><span class="sxs-lookup"><span data-stu-id="75b40-132">A DDL trigger is then created on the current database that populates the table with the following information whenever any database-level DDL event occurs:</span></span>  
  
-   <span data-ttu-id="75b40-133">事件時間 (使用 GETDATE 函數)。</span><span class="sxs-lookup"><span data-stu-id="75b40-133">The time of the event (using the GETDATE function).</span></span>  
  
-   <span data-ttu-id="75b40-134">其工作階段上發生事件的資料庫使用者 (使用 CURRENT_USER 函數)。</span><span class="sxs-lookup"><span data-stu-id="75b40-134">The database user against whose session the event occurred (using the CURRENT_USER function).</span></span>  
  
-   <span data-ttu-id="75b40-135">事件的類型。</span><span class="sxs-lookup"><span data-stu-id="75b40-135">The type of the event.</span></span>  
  
-   <span data-ttu-id="75b40-136">組成事件的 [!INCLUDE[tsql](../../includes/tsql-md.md)] 陳述式。</span><span class="sxs-lookup"><span data-stu-id="75b40-136">The [!INCLUDE[tsql](../../includes/tsql-md.md)] statement that comprised the event.</span></span>  
  
 <span data-ttu-id="75b40-137">再次對 EVENTDATA 產生的 `xml` 資料使用 XQuery，即可擷取後兩個項目。</span><span class="sxs-lookup"><span data-stu-id="75b40-137">Again, the last two items are captured by using XQuery against the `xml` data that is generated by EVENTDATA.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE TABLE ddl_log (PostTime datetime, DB_User nvarchar(100), Event nvarchar(100), TSQL nvarchar(2000));  
GO  
CREATE TRIGGER log   
ON DATABASE   
FOR DDL_DATABASE_LEVEL_EVENTS   
AS  
DECLARE @data XML  
SET @data = EVENTDATA()  
INSERT ddl_log   
   (PostTime, DB_User, Event, TSQL)   
   VALUES   
   (GETDATE(),   
   CONVERT(nvarchar(100), CURRENT_USER),   
   @data.value('(/EVENT_INSTANCE/EventType)[1]', 'nvarchar(100)'),   
   @data.value('(/EVENT_INSTANCE/TSQLCommand)[1]', 'nvarchar(2000)') ) ;  
GO  
--Test the trigger  
CREATE TABLE TestTable (a int)  
DROP TABLE TestTable ;  
GO  
SELECT * FROM ddl_log ;  
GO  
```  
  
> [!NOTE]  
>  <span data-ttu-id="75b40-138">若要傳回事件資料，我們建議您使用 XQuery `value()` 方法，而不要使用 `query()` 方法。</span><span class="sxs-lookup"><span data-stu-id="75b40-138">To return event data, we recommend that you use the XQuery `value()` method instead of the `query()` method.</span></span> <span data-ttu-id="75b40-139">`query()` 方法會在輸出中傳回 XML 和逸出連字號的歸位字元和換行字元 (CRLF) 執行個體，而 `value()` 方法則會轉譯在輸出中看不到的 CRLF 執行個體。</span><span class="sxs-lookup"><span data-stu-id="75b40-139">The `query()` method returns XML and ampersand-escaped carriage return and line-feed (CRLF) instances in the output, while the `value()` method renders CRLF instances invisible in the output.</span></span>  
  
 <span data-ttu-id="75b40-140">[!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] 範例資料庫中則提供了相似的 DDL 觸發程序範例。</span><span class="sxs-lookup"><span data-stu-id="75b40-140">A similar DDL trigger example is provided with the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database.</span></span> <span data-ttu-id="75b40-141">若要取得此範例，請使用 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]來尋找 [Database Triggers] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="75b40-141">To obtain the example, locate the Database Triggers folder by using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="75b40-142">這個資料夾位在 [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] 資料庫的 [可程式性] 資料夾下。</span><span class="sxs-lookup"><span data-stu-id="75b40-142">This folder is located under the **Programmability** folder of the [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] database.</span></span> <span data-ttu-id="75b40-143">以滑鼠右鍵按一下 [ddlDatabaseTriggerLog]，然後選取 [編寫資料庫觸發程序的指令碼為]。</span><span class="sxs-lookup"><span data-stu-id="75b40-143">Right-click **ddlDatabaseTriggerLog** and select **Script Database Trigger as**.</span></span> <span data-ttu-id="75b40-144">依預設，會停用 DDL 觸發程序 **ddlDatabaseTriggerLog**。</span><span class="sxs-lookup"><span data-stu-id="75b40-144">By default, DDL trigger **ddlDatabaseTriggerLog** is disabled.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="75b40-145">另請參閱</span><span class="sxs-lookup"><span data-stu-id="75b40-145">See Also</span></span>  
 <span data-ttu-id="75b40-146">[DDL 事件](../triggers/ddl-events.md) </span><span class="sxs-lookup"><span data-stu-id="75b40-146">[DDL Events](../triggers/ddl-events.md) </span></span>  
 [<span data-ttu-id="75b40-147">DDL 事件群組</span><span class="sxs-lookup"><span data-stu-id="75b40-147">DDL Event Groups</span></span>](../triggers/ddl-event-groups.md)  
  
  
