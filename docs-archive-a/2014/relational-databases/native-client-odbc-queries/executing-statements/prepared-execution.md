---
title: 備妥的執行 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- deferred statement preparation
- prepared execution [ODBC]
- SQLPrepare function
- ODBC applications, statements
- SQLExecute function
- statements [ODBC], prepared execution
ms.assetid: f3a9d32b-6cd7-4f0c-b38d-c8ccc4ee40c3
author: rothja
ms.author: jroth
ms.openlocfilehash: 33ab9f35cd9d3eaf04e688a89390b5eb3f00ae58
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/04/2020
ms.locfileid: "87585352"
---
# <a name="prepared-execution"></a><span data-ttu-id="d1b46-102">備妥的執行</span><span class="sxs-lookup"><span data-stu-id="d1b46-102">Prepared Execution</span></span>
  <span data-ttu-id="d1b46-103">ODBC API 會定義備妥的執行，將它當做減少與重複執行 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 陳述式有關之剖析和編譯負擔的一個方式。</span><span class="sxs-lookup"><span data-stu-id="d1b46-103">The ODBC API defines prepared execution as a way to reduce the parsing and compiling overhead associated with repeatedly executing a [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span> <span data-ttu-id="d1b46-104">應用程式會建立一個包含 SQL 陳述式的字元字串，然後在兩個階段執行此字串。</span><span class="sxs-lookup"><span data-stu-id="d1b46-104">The application builds a character string containing an SQL statement and then executes it in two stages.</span></span> <span data-ttu-id="d1b46-105">它會呼叫[SQLPrepare](https://go.microsoft.com/fwlink/?LinkId=59360)函式一次，讓語句剖析並編譯成執行計畫 [!INCLUDE[ssDE](../../../includes/ssde-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="d1b46-105">It calls [SQLPrepare Function](https://go.microsoft.com/fwlink/?LinkId=59360) once to have the statement parsed and compiled into an execution plan by the [!INCLUDE[ssDE](../../../includes/ssde-md.md)].</span></span> <span data-ttu-id="d1b46-106">然後，它會在每次執行備妥的執行計畫時，呼叫**SQLExecute** 。</span><span class="sxs-lookup"><span data-stu-id="d1b46-106">It then calls **SQLExecute** for each execution of the prepared execution plan.</span></span> <span data-ttu-id="d1b46-107">這樣會省下每次執行時的剖析和編譯負擔。</span><span class="sxs-lookup"><span data-stu-id="d1b46-107">This saves the parsing and compiling overhead on each execution.</span></span> <span data-ttu-id="d1b46-108">應用程式通常會使用備妥的執行來重複執行相同且參數化的 SQL 陳述式。</span><span class="sxs-lookup"><span data-stu-id="d1b46-108">Prepared execution is commonly used by applications to repeatedly execute the same, parameterized SQL statement.</span></span>  
  
 <span data-ttu-id="d1b46-109">對於大多數的資料庫而言，備妥的執行要比直接執行已執行三次或四次的陳述式更為快速，主要是因為該陳述式只會編譯一次，而直接執行的陳述式則會在每次執行時進行編譯。</span><span class="sxs-lookup"><span data-stu-id="d1b46-109">For most databases, prepared execution is faster than direct execution for statements executed more than three or four times primarily because the statement is compiled only once, while statements executed directly are compiled each time they are executed.</span></span> <span data-ttu-id="d1b46-110">備妥的執行也可以讓網路流量減少，因為每次執行該陳述式時，此驅動程式都可以將執行計畫識別碼和參數值 (而非整個 SQL 陳述式) 傳送給資料來源。</span><span class="sxs-lookup"><span data-stu-id="d1b46-110">Prepared execution can also provide a reduction in network traffic because the driver can send an execution plan identifier and the parameter values, rather than an entire SQL statement, to the data source each time the statement is executed.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="d1b46-111">透過改善的演算法來偵測及重複使用**SQLExecDirect**中的執行計畫，藉此降低直接和備妥執行之間的效能差異。</span><span class="sxs-lookup"><span data-stu-id="d1b46-111">reduces the performance difference between direct and prepared execution through improved algorithms for detecting and reusing execution plans from **SQLExecDirect**.</span></span> <span data-ttu-id="d1b46-112">如此可讓備妥的執行得到的某些效能優點可供直接執行的陳述式使用。</span><span class="sxs-lookup"><span data-stu-id="d1b46-112">This makes some of the performance benefits of prepared execution available to statements executed directly.</span></span> <span data-ttu-id="d1b46-113">如需詳細資訊，請參閱[直接執行](direct-execution.md)。</span><span class="sxs-lookup"><span data-stu-id="d1b46-113">For more information, see [Direct Execution](direct-execution.md).</span></span>  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="d1b46-114">還會針對備妥的執行提供原生支援。</span><span class="sxs-lookup"><span data-stu-id="d1b46-114">also provides native support for prepared execution.</span></span> <span data-ttu-id="d1b46-115">執行計畫是以**SQLPrepare**為基礎，並在稍後呼叫**SQLExecute**時執行。</span><span class="sxs-lookup"><span data-stu-id="d1b46-115">An execution plan is built on **SQLPrepare** and later executed when **SQLExecute** is called.</span></span> <span data-ttu-id="d1b46-116">因為 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 不需要在**SQLPrepare**上建立暫存預存程序，所以**tempdb**中的系統資料表不會有額外的負荷。</span><span class="sxs-lookup"><span data-stu-id="d1b46-116">Because [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is not required to build temporary stored procedures on **SQLPrepare**, there is no extra overhead on the system tables in **tempdb**.</span></span>  
  
 <span data-ttu-id="d1b46-117">基於效能考慮，語句準備會延遲到呼叫**SQLExecute** ，或在 ODBC) 中 (例如[SQLDescribeCol](../../native-client-odbc-api/sqldescribecol.md)或[SQLDescribeParam](../../native-client-odbc-api/sqldescribeparam.md)之類的中繼屬性作業。</span><span class="sxs-lookup"><span data-stu-id="d1b46-117">For performance reasons, the statement preparation is deferred until **SQLExecute** is called or a metaproperty operation (such as [SQLDescribeCol](../../native-client-odbc-api/sqldescribecol.md) or [SQLDescribeParam](../../native-client-odbc-api/sqldescribeparam.md) in ODBC) is performed.</span></span> <span data-ttu-id="d1b46-118">此為預設行為。</span><span class="sxs-lookup"><span data-stu-id="d1b46-118">This is the default behavior.</span></span> <span data-ttu-id="d1b46-119">要等到執行此陳述式或執行中繼屬性作業之後，才可得知正在準備之陳述式中的任何錯誤。</span><span class="sxs-lookup"><span data-stu-id="d1b46-119">Any errors in the statement being prepared are not known until the statement is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="d1b46-120">將 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC 驅動程式特有的陳述式屬性 SQL_SOPT_SS_DEFER_PREPARE 設定為 SQL_DP_OFF 可以關閉這項預設行為。</span><span class="sxs-lookup"><span data-stu-id="d1b46-120">Setting the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver-specific statement attribute SQL_SOPT_SS_DEFER_PREPARE to SQL_DP_OFF can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="d1b46-121">如果是延遲的準備，呼叫**SQLDescribeCol**或**SQLDescribeParam** ，然後再呼叫**SQLExecute**會產生額外的伺服器往返。</span><span class="sxs-lookup"><span data-stu-id="d1b46-121">In case of deferred prepare, calling either **SQLDescribeCol** or **SQLDescribeParam** before calling **SQLExecute** generates an extra roundtrip to the server.</span></span> <span data-ttu-id="d1b46-122">在**SQLDescribeCol**上，驅動程式會從查詢中移除 WHERE 子句，並使用 SET set fmtonly ON 將它傳送至伺服器，以取得查詢所傳回的第一個結果集內的資料行描述。</span><span class="sxs-lookup"><span data-stu-id="d1b46-122">On **SQLDescribeCol**, the driver removes the WHERE clause from the query and sends it to the server with SET FMTONLY ON to get the description of the columns in the first result set returned by the query.</span></span> <span data-ttu-id="d1b46-123">在**SQLDescribeParam**上，驅動程式會呼叫伺服器，以取得查詢中任何參數標記所參考之運算式或資料行的描述。</span><span class="sxs-lookup"><span data-stu-id="d1b46-123">On **SQLDescribeParam**, the driver calls the server to get a description of the expressions or columns referenced by any parameter markers in the query.</span></span> <span data-ttu-id="d1b46-124">這個方法也有一些限制，例如無法解析子查詢中的參數。</span><span class="sxs-lookup"><span data-stu-id="d1b46-124">This method also has some restrictions, such as not being able to resolve parameters in subqueries.</span></span>  
  
 <span data-ttu-id="d1b46-125">與**SQLPrepare** [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC 驅動程式過度使用 SQLPrepare 會降低效能，尤其是連接到舊版的 SQL Server 時。</span><span class="sxs-lookup"><span data-stu-id="d1b46-125">Excess use of **SQLPrepare** with the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver degrades performance, especially when connected to earlier versions of SQL Server.</span></span> <span data-ttu-id="d1b46-126">備妥的執行不應該用於單次執行的陳述式。</span><span class="sxs-lookup"><span data-stu-id="d1b46-126">Prepared execution should not be used for statements executed a single time.</span></span> <span data-ttu-id="d1b46-127">備妥的執行要比直接執行單次執行的陳述式更緩慢，因為它需要從用戶端到伺服器的額外網路往返。</span><span class="sxs-lookup"><span data-stu-id="d1b46-127">Prepared execution is slower than direct execution for a single execution of a statement because it requires an extra network roundtrip from the client to the server.</span></span> <span data-ttu-id="d1b46-128">在舊版的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 上，它也會產生暫存預存程序。</span><span class="sxs-lookup"><span data-stu-id="d1b46-128">On earlier versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] it also generates a temporary stored procedure.</span></span>  
  
 <span data-ttu-id="d1b46-129">準備陳述式無法用來在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 上建立暫存物件。</span><span class="sxs-lookup"><span data-stu-id="d1b46-129">Prepared statements cannot be used to create temporary objects on [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="d1b46-130">使用的一些早期 ODBC 應用程式會**SQLPrepare**任何時間使用[SQLBindParameter](../../native-client-odbc-api/sqlbindparameter.md) 。</span><span class="sxs-lookup"><span data-stu-id="d1b46-130">Some early ODBC applications used **SQLPrepare** any time [SQLBindParameter](../../native-client-odbc-api/sqlbindparameter.md) was used.</span></span> <span data-ttu-id="d1b46-131">**SQLBindParameter**不需要使用**SQLPrepare**，它可以搭配**SQLExecDirect**使用。</span><span class="sxs-lookup"><span data-stu-id="d1b46-131">**SQLBindParameter** does not require the use of **SQLPrepare**, it can be used with **SQLExecDirect**.</span></span> <span data-ttu-id="d1b46-132">例如，使用**SQLExecDirect**搭配**SQLBindParameter** ，從只執行一次的預存程式抓取傳回碼或輸出參數。</span><span class="sxs-lookup"><span data-stu-id="d1b46-132">For example, use **SQLExecDirect** with **SQLBindParameter** to retrieve the return code or output parameters from a stored procedure that is only executed one time.</span></span> <span data-ttu-id="d1b46-133">除非相同的語句會多次執行，否則請勿使用**SQLPrepare**與**SQLBindParameter** 。</span><span class="sxs-lookup"><span data-stu-id="d1b46-133">Do not use **SQLPrepare** with **SQLBindParameter** unless the same statement will be executed multiple times.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d1b46-134">另請參閱</span><span class="sxs-lookup"><span data-stu-id="d1b46-134">See Also</span></span>  
 [<span data-ttu-id="d1b46-135">&#40;ODBC&#41;執行語句</span><span class="sxs-lookup"><span data-stu-id="d1b46-135">Executing Statements &#40;ODBC&#41;</span></span>](executing-statements-odbc.md)  
  
  
